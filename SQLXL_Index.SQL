-- VERSION 2024.07.15
/******************************************************************************************************************************************\
All SQLXL tables objects are created in [tempdb] (must be lower case to support case sensitive collation on installation)
Procedures are created in the connected-to database and then copied to [tempdb]. After copy they are deleted from the conencted-to database
Functions are created in tempdb by using the EXEC('USE tempdb;EXEC(''create function code'')') construct
\******************************************************************************************************************************************/

/*########################################################################################################################################*\
INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTA
\*########################################################################################################################################*/

/*** LOCAL TESTING ***
DROP TABLE IF EXISTS [tempdb].[dbo].[SQLXL_Instance_info]
EXEC tempdb.dbo.SQLXL_INSTANCE

EXEC [tempdb].[dbo].[SQLXL_Index]                                        -- runs for all USER databases
EXEC [tempdb].[dbo].[SQLXL_Index] @database_name = N'*'                  -- runs for ALL databases
EXEC [tempdb].[dbo].[SQLXL_Index] @database_name = N'WideWorldImporters' -- runs for a SINGLE database
--*/

/******************************************************************************************************************************************\
Copyright (C) 2024 Practice Computing Management Inc.
All rights reserved.

MIT License, http://www.opensource.org/licenses/mit-license.php
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files
(the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge,
publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
SQL Server Versions
2022 = 16
2019 = 15
2017 = 14
2016 = 13
2014 = 12
2012 = 11
2008 = 10

SQL Server EngineEditions including Azure
-------------------------------------------------------------------------------------
 1 = Personal or Desktop Engine (Not available in SQL Server 2005 (9.x) and later versions.)
 2 = Standard (For Standard, Web, and Business Intelligence.)
 3 = Enterprise (For Evaluation, Developer, and Enterprise editions.)
 4 = Express (For Express, Express with Tools, and Express with Advanced Services)

 5 = SQL Database
 6 = Azure Synapse Analytics
 8 = Azure SQL Managed Instance
 9 = Azure SQL Edge (For all editions of Azure SQL Edge)
11 = Azure Synapse serverless SQL pools
\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
-- Drop previous SQLXL_Instance tempdb source data stores (SQLXL_Instance_%)
-- TRUNCATE/REBUILD is used to clear out any missing index recommendations that were created from the last execution(s)
\******************************************************************************************************************************************/
DECLARE @sql        NVARCHAR(MAX)
       ,@run_value  NVARCHAR(4000);

/*** LOCAL TESTING ***
DECLARE @sql        NVARCHAR(MAX)
       ,@run_value  NVARCHAR(4000)
       ,@ssms_ads   TINYINT       = 1
       ,@msg        NVARCHAR(1000)
       ,@exec_dttm  DATETIME      = GETDATE();
--*/

WHILE 1 = 1
BEGIN
   SELECT TOP (1)
          @run_value = QUOTENAME(s.name) + N'.' + QUOTENAME(t.name)
         ,@sql = N'TRUNCATE TABLE [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N';'
               + NCHAR(13) + NCHAR(10)
               -- Drops MISSING index recommendations
               + N'ALTER index ALL ON [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N' REBUILD;'
               + NCHAR(13) + NCHAR(10)
               + N'DROP TABLE [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N';'
     FROM [tempdb].[sys].[tables]  AS t WITH (READUNCOMMITTED)
     JOIN [tempdb].[sys].[objects] AS o WITH (READUNCOMMITTED)
       ON t.object_id  = o.object_id
     JOIN [tempdb].[sys].[schemas] AS s WITH (READUNCOMMITTED)
       ON o.schema_id  = s.schema_id
    WHERE t.name LIKE N'SQLXL_Instance%'
      AND s.name    = N'dbo'
    ORDER BY t.name;

   IF @@ROWCOUNT = 0 BREAK

   BEGIN TRY
      EXECUTE [msdb].[sys].[sp_executesql] @sql;
   END TRY
   BEGIN CATCH
      SET @run_value = N'TRUNCATE/ALTER/DROP FAIL on ' + @run_value
      RAISERROR (@run_value,0,0) WITH NOWAIT;
   END CATCH
END

/******************************************************************************************************************************************\
-- Create the procedure [dbo].[SQLXL_Instance] - captures instance properties and configurations
\******************************************************************************************************************************************/
IF OBJECT_ID('[dbo].[SQLXL_Instance]') IS NULL EXEC ('CREATE PROCEDURE [dbo].[SQLXL_Instance] AS RETURN 0;');
GO

 ALTER PROCEDURE [dbo].[SQLXL_Instance] AS

/******************************************************************************************************************************************\
-- Procedure Environment settings
\******************************************************************************************************************************************/
SET ANSI_NULLS               ON;
SET ANSI_NULL_DFLT_ON        ON;
SET ANSI_PADDING             ON;
SET ANSI_WARNINGS            ON;
SET ARITHABORT               ON;
SET CONCAT_NULL_YIELDS_NULL  ON;
SET CURSOR_CLOSE_ON_COMMIT   ON;
SET NOCOUNT                  ON; --
SET QUOTED_IDENTIFIER        ON;
SET XACT_ABORT               ON; --

SET ARITHIGNORE             OFF;
SET FMTONLY                 OFF;
SET FORCEPLAN               OFF;
SET IMPLICIT_TRANSACTIONS   OFF;
SET NOEXEC                  OFF;
SET NUMERIC_ROUNDABORT      OFF;
SET STATISTICS IO,PROFILE,TIME,XML OFF;

SET DATEFORMAT              YMD;
SET DEADLOCK_PRIORITY       -10; -- Lowest priority
SET LOCK_TIMEOUT          10000; -- in milliseconds
SET QUERY_GOVERNOR_COST_LIMIT 0; -- 0 (the default) turns off the query governor, queries of any cost are allowed to execute.
SET ROWCOUNT                  0;
SET TEXTSIZE         2147483647;  -- Use 32767 on export to Excel - cell maximum

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

/******************************************************************************************************************************************\
-- Local Procedure variables
\******************************************************************************************************************************************/
DECLARE @sql                  NVARCHAR(MAX)
       ,@exec_dttm            DATETIME = GETDATE()
       ,@run_value            NVARCHAR(4000)
       ,@ssms_ads             TINYINT  = (SELECT (1)
                                            FROM [msdb].[sys].[dm_exec_sessions]
                                           WHERE session_id = @@SPID
                                             AND (   program_name LIKE N'Microsoft SQL Server Management Studio%'
                                                  OR program_name LIKE N'azdata%' --azure data studio
                                                  OR program_name    = N'SQLCMD'
                                                 )
                                         )
       ,@msg                  NVARCHAR(1000);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'          Start [tempdb].[dbo].[SQLXL_Instance] data collection & diagnostics',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Create table to hold Instance/Server configuration info from [msdb].[sys].[sp_configure], SERVERPROPERTY, etc.
-- if this procedure has been run within last day don't execute again
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
TRUNCATE TABLE dbo.SQLXL_Instance_Diagnostics
TRUNCATE TABLE dbo.SQLXL_Instance_info
--*/
IF OBJECT_ID('[tempdb].[dbo].[SQLXL_Instance_info]') IS NULL
BEGIN
   SELECT source           = CAST(N'SQLXL'           AS SYSNAME)   COLLATE DATABASE_DEFAULT
         ,configuration_id = CAST(NULL AS INT)
         ,name             = CAST(N'Collection_DTTM' AS SYSNAME)   COLLATE DATABASE_DEFAULT
         ,minimum_value    = CAST(NULL AS BIGINT)
         ,maximum_value    = CAST(NULL AS BIGINT)
         ,config_value     = CAST(NULL AS BIGINT)
         ,run_value        = CAST(NULL AS BIGINT)
         ,text_value       = CAST(CONVERT(NVARCHAR(30),GETDATE(),120) AS NVARCHAR(255)) COLLATE DATABASE_DEFAULT
         ,description      = CAST(NULL AS NVARCHAR(255)) COLLATE DATABASE_DEFAULT
         ,is_dynamic       = CAST(NULL AS BIT)
         ,is_advanced      = CAST(NULL AS BIT)
         ,default_value    = CAST(NULL AS BIGINT)
     INTO [tempdb].[dbo].[SQLXL_Instance_info];
END
ELSE
BEGIN
   SELECT @msg = text_value
     FROM [tempdb].[dbo].[SQLXL_Instance_info]
    WHERE source = N'SQLXL'
      AND name   = N'Collection_DTTM'
END

IF @msg IS NOT NULL AND DATEDIFF(DAY,CONVERT(DATETIME,@msg,120),GETDATE()) < 1
BEGIN
   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,GETDATE(),GETDATE()),0))
               + N' Exit - Instance info less than 24 hours old'
      RAISERROR(@msg,0,0) WITH NOWAIT;
   END
   RETURN;
END
ELSE
BEGIN
   TRUNCATE TABLE [tempdb].[dbo].[SQLXL_Instance_info];

   INSERT
     INTO [tempdb].[dbo].[SQLXL_Instance_info]
         (source
         ,name
         ,text_value
         )
   SELECT source     = N'SQLXL'
         ,name       = N'Collection_DTTM'
         ,text_value = CONVERT(NVARCHAR(30),GETDATE(),120);
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Get Instance FULL-TEXT default language
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT source     = N'configurations'
      ,name       = N'fulltext_default_language_name'
      ,text_value = COALESCE(sl.name + N' - ',N'') + COALESCE(sl.alias,fl.name)
  FROM [tempdb].[dbo].[SQLXL_Instance_info] AS si
  JOIN sys.fulltext_languages               AS fl
    ON CAST(si.run_value AS INT) = fl.lcid
  LEFT OUTER
  JOIN sys.syslanguages                     AS sl
    ON CAST(si.run_value AS INT) = sl.lcid
 WHERE si.source = N'configurations'
   AND si.name   = N'default full-text language';

/******************************************************************************************************************************************\
-- Collect Server-level trace flag settings
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (name
      ,run_value
      ,maximum_value
      ,minimum_value
      )
  EXEC ('DBCC TRACESTATUS(-1) WITH NO_INFOMSGS');

-- save off data source of above records
UPDATE [tempdb].[dbo].[SQLXL_Instance_info]
   SET source = N'TRACESTATUS'
 WHERE source IS NULL;

/******************************************************************************************************************************************\
 Collect sys.configurations settings
 https://learn.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-configurations-transact-sql?view=sql-server-ver16
 *NOTE* same elements as sp_configure
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
SELECT N'configurations'
      ,c.configuration_id
      ,c.name
      ,minimum      = CONVERT(BIGINT,c.minimum     )
      ,maximum      = CONVERT(BIGINT,c.maximum     )
      ,value        = CONVERT(BIGINT,c.value       )
      ,value_in_use = CONVERT(BIGINT,c.value_in_use)
      ,text_value   = NULL
      ,c.description
      ,c.is_dynamic
      ,c.is_advanced
      ,default_value = COALESCE(v.default_value,0)
  FROM sys.configurations AS c
  LEFT OUTER
  JOIN (VALUES (N'cursor threshold',-1)
              ,(N'query wait (s)',-1)
              ,(N'ADR Cleaner Thread Count',1)
              ,(N'default trace enabled',1)
              ,(N'nested triggers',1)
              ,(N'polybase network encryption',1)
              ,(N'remote access',1)
              ,(N'server trigger recursion',1)
              ,(N'SMO and DMO XPs',1)
              ,(N'ADR Preallocation Factor',4)
              ,(N'max full-text crawl range',4)
              ,(N'cost threshold for parallelism',5)
              ,(N'remote login timeout (s)',10)
              ,(N'PH timeout (s)',60)
              ,(N'ft crawl bandwidth (max)',100)
              ,(N'ft notify bandwidth (max)',100)
              ,(N'ADR cleaner retry timeout (min)',120)
              ,(N'remote query timeout (s)',600)
              ,(N'min memory per query (KB)',1024)
              ,(N'default full-text language',1033)
              ,(N'max worker threads',2048)
              ,(N'two digit year cutoff',2049)
              ,(N'network packet size (B)',4096)
              ,(N'max text repl size (B)',65536)
              ,(N'Data processed daily limit in TB',2147483647)
              ,(N'Data processed monthly limit in TB',2147483647)
              ,(N'Data processed weekly limit in TB',2147483647)
              ,(N'max server memory (MB)',2147483647)
              ) AS v(name,default_value)
    ON c.name = v.name
;

--------------------------------------------------------------------------------------------------------------------------------------------
-- Get Instance FULL-TEXT default language
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT source          = N'configurations'
      ,name            = N'fulltext_default_language_name'
      ,text_value      = COALESCE(sl.name + N' - ',N'') + COALESCE(sl.alias,fl.name)
  FROM [tempdb].[dbo].[SQLXL_Instance_info] AS si
  JOIN sys.fulltext_languages               AS fl
    ON CAST(si.run_value AS INT) = fl.lcid
  LEFT OUTER
  JOIN sys.syslanguages                     AS sl
    ON CAST(si.run_value AS INT) = sl.lcid
 WHERE si.source = N'configurations'
   AND si.name   = N'default full-text language';

/******************************************************************************************************************************************\
 Collect [sys].[configurations] settings
 https://learn.microsoft.com/en-us/sql/t-sql/functions/serverproperty-transact-sql
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT e.source
      ,e.name
      ,text_value = CAST(e.text_value  AS NVARCHAR(4000))
  FROM (
SELECT N'SERVERPROPERTY',N'BuildClrVersion'                   ,SERVERPROPERTY(N'BuildClrVersion')                   UNION ALL
SELECT N'SERVERPROPERTY',N'Collation'                         ,SERVERPROPERTY(N'Collation')                         UNION ALL
SELECT N'SERVERPROPERTY',N'ComputerNamePhysicalNetBIOS'       ,SERVERPROPERTY(N'ComputerNamePhysicalNetBIOS')       UNION ALL
SELECT N'SERVERPROPERTY',N'Edition'                           ,SERVERPROPERTY(N'Edition')                           UNION ALL
SELECT N'SERVERPROPERTY',N'FilestreamShareName'               ,SERVERPROPERTY(N'FilestreamShareName')               UNION ALL
SELECT N'SERVERPROPERTY',N'InstanceDefaultBackupPath'         ,SERVERPROPERTY(N'InstanceDefaultBackupPath')         UNION ALL
SELECT N'SERVERPROPERTY',N'InstanceDefaultDataPath'           ,SERVERPROPERTY(N'InstanceDefaultDataPath')           UNION ALL
SELECT N'SERVERPROPERTY',N'InstanceDefaultLogPath'            ,SERVERPROPERTY(N'InstanceDefaultLogPath')            UNION ALL
SELECT N'SERVERPROPERTY',N'InstanceName'                      ,SERVERPROPERTY(N'InstanceName')                      UNION ALL
SELECT N'SERVERPROPERTY',N'LicenseType'                       ,SERVERPROPERTY(N'LicenseType')                       UNION ALL
SELECT N'SERVERPROPERTY',N'MachineName'                       ,SERVERPROPERTY(N'MachineName')                       UNION ALL
SELECT N'SERVERPROPERTY',N'PathSeparator'                     ,SERVERPROPERTY(N'PathSeparator')                     UNION ALL
SELECT N'SERVERPROPERTY',N'ProductBuildType'                  ,SERVERPROPERTY(N'ProductBuildType')                  UNION ALL
SELECT N'SERVERPROPERTY',N'ProductLevel'                      ,SERVERPROPERTY(N'ProductLevel')                      UNION ALL
SELECT N'SERVERPROPERTY',N'ProductUpdateLevel'                ,SERVERPROPERTY(N'ProductUpdateLevel')                UNION ALL
SELECT N'SERVERPROPERTY',N'ProductUpdateReference'            ,SERVERPROPERTY(N'ProductUpdateReference')            UNION ALL
SELECT N'SERVERPROPERTY',N'ProductUpdateType'                 ,SERVERPROPERTY(N'ProductUpdateType')                 UNION ALL
SELECT N'SERVERPROPERTY',N'ProductVersion'                    ,SERVERPROPERTY(N'ProductVersion')                    UNION ALL
SELECT N'SERVERPROPERTY',N'ResourceLastUpdateDateTime'        ,SERVERPROPERTY(N'ResourceLastUpdateDateTime')        UNION ALL
SELECT N'SERVERPROPERTY',N'ResourceVersion'                   ,SERVERPROPERTY(N'ResourceVersion')                   UNION ALL
SELECT N'SERVERPROPERTY',N'ServerName'                        ,SERVERPROPERTY(N'ServerName')                        UNION ALL
SELECT N'SERVERPROPERTY',N'SqlCharSetName'                    ,SERVERPROPERTY(N'SqlCharSetName')                    UNION ALL
SELECT N'SERVERPROPERTY',N'SqlSortOrderName'                  ,SERVERPROPERTY(N'SqlSortOrderName')
) e (source,name,text_value);

INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,run_value
      )
SELECT e.source
      ,e.name
      ,CAST(e.run_value  AS BIGINT)
  FROM (
SELECT N'SERVERPROPERTY',N'CollationID'                       ,SERVERPROPERTY(N'CollationID')                       UNION ALL
SELECT N'SERVERPROPERTY',N'ComparisonStyle'                   ,SERVERPROPERTY(N'ComparisonStyle')                   UNION ALL
SELECT N'SERVERPROPERTY',N'EditionID'                         ,SERVERPROPERTY(N'EditionID')                         UNION ALL
SELECT N'SERVERPROPERTY',N'EngineEdition'                     ,SERVERPROPERTY(N'EngineEdition')                     UNION ALL
SELECT N'SERVERPROPERTY',N'FilestreamConfiguredLevel'         ,SERVERPROPERTY(N'FilestreamConfiguredLevel')         UNION ALL
SELECT N'SERVERPROPERTY',N'FilestreamEffectiveLevel'          ,SERVERPROPERTY(N'FilestreamEffectiveLevel')          UNION ALL
SELECT N'SERVERPROPERTY',N'HadrManagerStatus'                 ,SERVERPROPERTY(N'HadrManagerStatus')                 UNION ALL
SELECT N'SERVERPROPERTY',N'IsAdvancedAnalyticsInstalled'      ,SERVERPROPERTY(N'IsAdvancedAnalyticsInstalled')      UNION ALL
SELECT N'SERVERPROPERTY',N'IsBigDataCluster'                  ,SERVERPROPERTY(N'IsBigDataCluster')                  UNION ALL
SELECT N'SERVERPROPERTY',N'IsClustered'                       ,SERVERPROPERTY(N'IsClustered')                       UNION ALL
SELECT N'SERVERPROPERTY',N'IsExternalAuthenticationOnly'      ,SERVERPROPERTY(N'IsExternalAuthenticationOnly')      UNION ALL
SELECT N'SERVERPROPERTY',N'IsExternalGovernanceEnabled'       ,SERVERPROPERTY('IsExternalGovernanceEnabled')        UNION ALL
SELECT N'SERVERPROPERTY',N'IsFullTextInstalled'               ,SERVERPROPERTY(N'IsFullTextInstalled')               UNION ALL
SELECT N'SERVERPROPERTY',N'IsHadrEnabled'                     ,SERVERPROPERTY(N'IsHadrEnabled')                     UNION ALL
SELECT N'SERVERPROPERTY',N'IsIntegratedSecurityOnly'          ,SERVERPROPERTY(N'IsIntegratedSecurityOnly')          UNION ALL
SELECT N'SERVERPROPERTY',N'IsLocalDB'                         ,SERVERPROPERTY(N'IsLocalDB')                         UNION ALL
SELECT N'SERVERPROPERTY',N'IsPolyBaseInstalled'               ,SERVERPROPERTY(N'IsPolyBaseInstalled')               UNION ALL
SELECT N'SERVERPROPERTY',N'IsServerSuspendedForSnapshotBackup',SERVERPROPERTY('IsServerSuspendedForSnapshotBackup') UNION ALL
SELECT N'SERVERPROPERTY',N'IsSingleUser'                      ,SERVERPROPERTY(N'IsSingleUser')                      UNION ALL
SELECT N'SERVERPROPERTY',N'IstempdbMetadataMemoryOptimized'   ,SERVERPROPERTY(N'IstempdbMetadataMemoryOptimized')   UNION ALL
SELECT N'SERVERPROPERTY',N'IsXTPSupported'                    ,SERVERPROPERTY(N'IsXTPSupported')                    UNION ALL
SELECT N'SERVERPROPERTY',N'LCID'                              ,SERVERPROPERTY(N'LCID')                              UNION ALL
SELECT N'SERVERPROPERTY',N'NumLicenses'                       ,SERVERPROPERTY(N'NumLicenses')                       UNION ALL
SELECT N'SERVERPROPERTY',N'ProcessID'                         ,SERVERPROPERTY(N'ProcessID')                         UNION ALL
SELECT N'SERVERPROPERTY',N'ProductBuild'                      ,SERVERPROPERTY(N'ProductBuild')                      UNION ALL
SELECT N'SERVERPROPERTY',N'ProductMajorVersion'               ,SERVERPROPERTY(N'ProductMajorVersion')               UNION ALL
SELECT N'SERVERPROPERTY',N'ProductMinorVersion'               ,SERVERPROPERTY(N'ProductMinorVersion')               UNION ALL
SELECT N'SERVERPROPERTY',N'SqlCharSet'                        ,SERVERPROPERTY(N'SqlCharSet')                        UNION ALL
SELECT N'SERVERPROPERTY',N'SqlSortOrder'                      ,SERVERPROPERTY(N'SqlSortOrder')                      UNION ALL
SELECT N'SERVERPROPERTY',N'SuspendedDatabaseCount'            ,SERVERPROPERTY('SuspendedDatabaseCount')
) e (source,name,run_value);

/******************************************************************************************************************************************\
-- Collect @@Functions settings
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT N'Configuration' ,N'@@LANGUAGE'                     ,CONVERT(NVARCHAR(255),@@Language            ) UNION ALL
SELECT N'Configuration' ,N'@@REMSERVER'                    ,CONVERT(NVARCHAR(255),@@RemServer           ) UNION ALL
SELECT N'Configuration' ,N'@@SERVERNAME'                   ,CONVERT(NVARCHAR(255),@@ServerName          ) UNION ALL
SELECT N'Configuration' ,N'@@SERVICENAME'                  ,CONVERT(NVARCHAR(255),@@ServiceName         ) UNION ALL
SELECT N'Configuration' ,N'@@VERSION'                      ,CONVERT(NVARCHAR(255),@@Version             );

INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,run_value
      )
SELECT N'Configuration' ,N'@@DATEFIRST'                    ,CONVERT(BIGINT,@@DateFirst           ) UNION ALL
SELECT N'Configuration' ,N'@@DBTS'                         ,CONVERT(BIGINT,@@Dbts                ) UNION ALL
SELECT N'Configuration' ,N'@@LANGID'                       ,CONVERT(BIGINT,@@LangId              ) UNION ALL
SELECT N'Configuration' ,N'@@LOCK_TIMEOUT'                 ,CONVERT(BIGINT,@@Lock_Timeout        ) UNION ALL
SELECT N'Configuration' ,N'@@MAX_CONNECTIONS'              ,CONVERT(BIGINT,@@Max_Connections     ) UNION ALL
SELECT N'Configuration' ,N'@@MAX_PRECISION'                ,CONVERT(BIGINT,@@Max_Precision       ) UNION ALL
SELECT N'Configuration' ,N'@@NESTLEVEL'                    ,CONVERT(BIGINT,@@NestLevel           ) UNION ALL
SELECT N'Configuration' ,N'@@OPTIONS'                      ,CONVERT(BIGINT,@@Options             ) UNION ALL
SELECT N'Configuration' ,N'@@SPID'                         ,CONVERT(BIGINT,@@Spid                ) UNION ALL
SELECT N'Configuration' ,N'@@TEXTSIZE'                     ,CONVERT(BIGINT,@@TextSize            );

/******************************************************************************************************************************************\
-- Collect System Functions
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT N'System'        ,N'HOST_ID'                        ,CONVERT(NVARCHAR(4000),HOST_ID()             ) UNION ALL
SELECT N'System'        ,N'HOST_NAME'                      ,CONVERT(NVARCHAR(4000),HOST_NAME()           ) UNION ALL
SELECT N'System'        ,N'PUBLISHINGSERVERNAME'           ,CONVERT(NVARCHAR(4000),PUBLISHINGSERVERNAME());

IF CONVERT(INT,SERVERPROPERTY('ProductMajorVersion')) >= 16 -- 2022+
BEGIN
   SET @sql = N'INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT N''System''        ,N''CURRENT_TIMEZONE''               ,CONVERT(NVARCHAR(4000),CURRENT_TIMEZONE()    )'

   EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@ERROR > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END;

/******************************************************************************************************************************************\
-- Collect Instance/Server configuration from [msdb].[sys].[dm_os_sys_info]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2008 & 2008R2 ONLY --------------------------------
       physical_memory_in_bytes    = CONVERT(BIGINT        ,NULL)
      ,virtual_memory_in_bytes     = CONVERT(BIGINT        ,NULL)
      ,bpool_visible               = CONVERT(BIGINT        ,NULL)
      ,bpool_committed             = CONVERT(BIGINT        ,NULL)
      ,bpool_commit_target         = CONVERT(BIGINT        ,NULL)
       -- SQL 2012+ ---------------------------------------------
      ,committed_kb                = CONVERT(BIGINT        ,NULL)
      ,virtual_memory_kb           = CONVERT(BIGINT        ,NULL)
      ,committed_target_kb         = CONVERT(BIGINT        ,NULL)
      ,physical_memory_kb          = CONVERT(BIGINT        ,NULL)
      ,visible_target_kb           = CONVERT(BIGINT        ,NULL)
      ,sql_memory_model            = CONVERT(BIGINT        ,NULL)
       -- SQL 2014+ ---------------------------------------------
      ,socket_count                = CONVERT(BIGINT        ,NULL)
      ,cores_per_socket            = CONVERT(BIGINT        ,NULL)
      ,numa_node_count             = CONVERT(BIGINT        ,NULL)
       -- SQL 2016+ ---------------------------------------------
      ,softnuma_configuration      = CONVERT(BIGINT        ,NULL)
       -- SQL 2017+ ---------------------------------------------
      ,container_type              = CONVERT(BIGINT        ,NULL)
      ,pdw_node_id                 = CONVERT(BIGINT        ,NULL)
)
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,run_value
      )
SELECT qry.source
      ,qry.name
      ,run_value  = CAST(run_value AS BIGINT)
  FROM newcol
 CROSS
 APPLY (-- All [msdb].[sys].[dm_os_sys_info] values
----------------------------------------------------------
SELECT TOP (0) -- make sure each column has the correct data type
       source    = CAST(NULL AS SYSNAME)
      ,name      = CAST(NULL AS SYSNAME)
      ,run_value = CAST(NULL AS BIGINT)
UNION ALL
SELECT N'dm_os_sys_info',N'cpu_ticks'                     ,(SELECT cpu_ticks                      FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'ms_ticks'                      ,(SELECT ms_ticks                       FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'cpu_count'                     ,(SELECT cpu_count                      FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'hyperthread_ratio'             ,(SELECT hyperthread_ratio              FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'stack_size_in_bytes'           ,(SELECT stack_size_in_bytes            FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'os_quantum'                    ,(SELECT os_quantum                     FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'os_error_mode'                 ,(SELECT os_error_mode                  FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'os_priority_class'             ,(SELECT os_priority_class              FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'max_workers_count'             ,(SELECT max_workers_count              FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'scheduler_count'               ,(SELECT scheduler_count                FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'scheduler_total_count'         ,(SELECT scheduler_total_count          FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'deadlock_monitor_serial_number',(SELECT deadlock_monitor_serial_number FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'sqlserver_start_time_ms_ticks' ,(SELECT sqlserver_start_time_ms_ticks  FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'affinity_type'                 ,(SELECT affinity_type                  FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'process_kernel_time_ms'        ,(SELECT process_kernel_time_ms         FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'process_user_time_ms'          ,(SELECT process_user_time_ms           FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'time_source'                   ,(SELECT time_source                    FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'virtual_machine_type'          ,(SELECT virtual_machine_type           FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
-- columns added in later versions --------------------------------------------------------
SELECT N'dm_os_sys_info',N'physical_memory_in_bytes'      ,(SELECT physical_memory_in_bytes       FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'virtual_memory_in_bytes'       ,(SELECT virtual_memory_in_bytes        FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'bpool_visible'                 ,(SELECT bpool_visible                  FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'bpool_committed'               ,(SELECT bpool_committed                FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'bpool_commit_target'           ,(SELECT bpool_commit_target            FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'committed_kb'                  ,(SELECT committed_kb                   FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'virtual_memory_kb'             ,(SELECT virtual_memory_kb              FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'committed_target_kb'           ,(SELECT committed_target_kb            FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'physical_memory_kb'            ,(SELECT physical_memory_kb             FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'visible_target_kb'             ,(SELECT visible_target_kb              FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'sql_memory_model'              ,(SELECT sql_memory_model               FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'socket_count'                  ,(SELECT socket_count                   FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'cores_per_socket'              ,(SELECT cores_per_socket               FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'numa_node_count'               ,(SELECT numa_node_count                FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'softnuma_configuration'        ,(SELECT softnuma_configuration         FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'container_type'                ,(SELECT container_type                 FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'pdw_node_id'                   ,(SELECT pdw_node_id                    FROM [msdb].[sys].[dm_os_sys_info])
-----------------------------------------------------------
) AS qry (source,name,run_value);

;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2008 & 2008R2 ONLY --------------------------------
       -- SQL 2012+ ---------------------------------------------
       sql_memory_model_desc       = CONVERT(SYSNAME       ,NULL)
       -- SQL 2014+ ---------------------------------------------
       -- SQL 2016+ ---------------------------------------------
      ,softnuma_configuration_desc = CONVERT(SYSNAME       ,NULL)
       -- SQL 2017+ ---------------------------------------------
      ,process_physical_affinity   = CONVERT(NVARCHAR(3072),NULL)
      ,container_type              = CONVERT(BIGINT        ,NULL)
      ,container_type_desc         = CONVERT(SYSNAME       ,NULL)
)
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT qry.source
      ,qry.name
      ,text_value = CAST(qry.text_value AS NVARCHAR(255))
  FROM newcol
 CROSS
 APPLY (-- All [msdb].[sys].[dm_os_sys_info] values
----------------------------------------------------------
SELECT TOP (0) -- make sure each column has the correct data type
       source     = CAST(NULL AS SYSNAME)
      ,name       = CAST(NULL AS SYSNAME)
      ,text_value = CAST(NULL AS NVARCHAR(255))
UNION ALL
SELECT N'dm_os_sys_info',N'affinity_type_desc'            ,(SELECT affinity_type_desc             FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'time_source_desc'              ,(SELECT time_source_desc               FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'virtual_machine_type_desc'     ,(SELECT virtual_machine_type_desc      FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
-- columns added in later versions --------------------------------------------------------
SELECT N'dm_os_sys_info',N'sql_memory_model_desc'         ,(SELECT sql_memory_model_desc          FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'softnuma_configuration_desc'   ,(SELECT softnuma_configuration_desc    FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'container_type_desc'           ,(SELECT container_type_desc            FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
SELECT N'dm_os_sys_info',N'process_physical_affinity'     ,(SELECT process_physical_affinity      FROM [msdb].[sys].[dm_os_sys_info]) UNION ALL
-----------------------------------------------------------
SELECT N'dm_os_sys_info',N'sqlserver_start_time'   ,REPLACE((SELECT CONVERT(NVARCHAR(4000),sqlserver_start_time,120)
                                                               FROM [msdb].[sys].[dm_os_sys_info]
                                                            )
                                                           ,N'-',N'.')
) AS qry (source,name,text_value);

/******************************************************************************************************************************************\
-- Collect Instance/Server configuration from [msdb].[sys].[servers]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2016+ -----------------------
       is_rda_server    = CONVERT(BIT,NULL)
)
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,run_value
      )
SELECT qry.source
      ,qry.name
      ,run_value = CAST(qry.run_value AS BIGINT)
  FROM newcol
 CROSS
 APPLY (-- all [msdb].[sys].[servers] values
SELECT TOP (0)
       source    = CAST(NULL AS SYSNAME)
      ,name      = CAST(NULL AS SYSNAME)
      ,run_value = CAST(NULL AS BIGINT)
UNION ALL
SELECT N'servers',N'server_id'              ,(SELECT server_id                FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'connect_timeout'        ,(SELECT connect_timeout          FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'query_timeout'          ,(SELECT query_timeout            FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_linked'              ,(SELECT is_linked                FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_remote_login_enabled',(SELECT is_remote_login_enabled  FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_rpc_out_enabled'     ,(SELECT is_rpc_out_enabled       FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_data_access_enabled' ,(SELECT is_data_access_enabled   FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_collation_compatible',(SELECT is_collation_compatible  FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'uses_remote_collation'  ,(SELECT uses_remote_collation    FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'lazy_schema_validation' ,(SELECT lazy_schema_validation   FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_system'              ,(SELECT is_system                FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_publisher'           ,(SELECT is_publisher             FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_subscriber'          ,(SELECT is_subscriber            FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_distributor'         ,(SELECT is_distributor           FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_nonsql_subscriber'   ,(SELECT is_nonsql_subscriber     FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_rda_server'          ,(SELECT is_rda_server            FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'is_remote_proc_transaction_promotion_enabled'
                                            ,(SELECT is_remote_proc_transaction_promotion_enabled
                                                FROM [msdb].[sys].[servers]
                                               WHERE server_id = 0
                                             )
) AS qry (source,name,run_value);

INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      ,text_value
      )
SELECT qry.source
      ,qry.name
      ,text_value = CAST(qry.text_value AS NVARCHAR(4000))
  FROM (
SELECT N'servers',N'name'                   ,(SELECT name                     FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'product'                ,(SELECT product                  FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'provider'               ,(SELECT provider                 FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'data_source'            ,(SELECT data_source              FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'location'               ,(SELECT location                 FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'provider_string'        ,(SELECT provider_string          FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'catalog'                ,(SELECT catalog                  FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'collation_name'         ,(SELECT collation_name           FROM [msdb].[sys].[servers] WHERE server_id = 0) UNION ALL
SELECT N'servers',N'modify_date'            ,(SELECT CONVERT(NVARCHAR(30),modify_date,120) FROM [msdb].[sys].[servers] WHERE server_id = 0)
) AS qry (source,name,text_value);

-------------------------------------------------------------------------------------------------------------------------------------------
-- Create index on [SQLXL_Instance_info]
-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Instance_info'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Instance_info
    ON [tempdb].[dbo].[SQLXL_Instance_info]
      (source
      ,name
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1)

/******************************************************************************************************************************************\
 Create - [SQLXL_Instance_Diagnostics] - Diagnostics Table
\******************************************************************************************************************************************/
IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Instance_Diagnostics]') IS NULL
BEGIN
   CREATE TABLE [tempdb].[dbo].[SQLXL_Instance_Diagnostics]
   (diagnostic_ID    INT                                     IDENTITY(1,1)
   -----------------------------
   ,rec_type         CHAR(1)        DEFAULT N'A' COLLATE DATABASE_DEFAULT NOT NULL   -- D-Database,P-Parent,I-index
   ,database_id      SMALLINT       DEFAULT 0                             NOT NULL
   ,parent_object_id INT            DEFAULT 0                             NOT NULL
   ,object_id        INT            DEFAULT 0                             NOT NULL
   ,index_id         INT            DEFAULT 0                             NOT NULL
   ,type             CHAR(2)        DEFAULT N'A' COLLATE DATABASE_DEFAULT NOT NULL
   -----------------------------
   ,diagnostic       NVARCHAR(4000)              COLLATE DATABASE_DEFAULT NULL
   );
END
ELSE
BEGIN
   TRUNCATE TABLE [tempdb].[dbo].[SQLXL_Instance_Diagnostics];
END

/******************************************************************************************************************************************\
 Create - [SQLXL_Instance_Diagnostics] - Diagnostics Table
TRUNCATE TABLE [tempdb].[dbo].[SQLXL_Instance_info];EXEC [dbo].[SQLXL_Instance]
\******************************************************************************************************************************************/
-- Diagnostic - Instance - Good to know - SQL version Instance and server key hardware & OS cofiguration information
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_Diagnostics] (diagnostic)
SELECT string = CASE t.rownbr
                     WHEN 2
                     THEN  N'Startup ' + s.text_value
                         + N' (' + CAST(DATEDIFF(DAY,s.text_value,GETDATE()) AS NVARCHAR(20))
                         + N' days ago)'
                     ELSE LTRIM(REPLACE(t.string,NCHAR(09),N''))
                END
 FROM dbo.SQLXL_Parse_Strings((SELECT text_value
                                 FROM [tempdb].[dbo].[SQLXL_Instance_info]
                                WHERE source = N'Configuration'
                                  AND name = N'@@VERSION'
                              ),NCHAR(10)) AS t
 CROSS
  JOIN (-- Get SQL Server startup time
        SELECT text_value
          FROM [tempdb].[dbo].[SQLXL_Instance_info]
         WHERE source = N'dm_os_sys_info'
           AND name   = N'sqlserver_start_time'
       ) AS s
 WHERE t.RowNbr IN (1,2,4)

-- Diagnostic - Server - memory
-- Diagnostic - Instance - SQL memory, percent used
UNION ALL
SELECT  N'RAM'
      + CASE WHEN memsrv > 0
             THEN  N' OS '
                 + [tempdb].[dbo].[SQLXL_3SD](MemSrv,N'KB')
             ELSE N''
        END
      + CASE WHEN SQLmax > 0
             THEN  N' SQL Max '
                 + [tempdb].[dbo].[SQLXL_3SD](SQLmax,N'MB')
                 + CASE WHEN MemSrv > 0
                        THEN N' (' + [tempdb].[dbo].[SQLXL_3SD](1.0 * SQLmax*1024.0 / MemSrv,N'%') + N')'
                        ELSE N''
                   END
             ELSE N''
        END
      + CASE WHEN SQLusd > 0
             THEN  N' SQL Used '
                 + [tempdb].[dbo].[SQLXL_3SD](SQLusd,N'KB')
                 + CASE WHEN SQLmax > 0
                        THEN N' (' + [tempdb].[dbo].[SQLXL_3SD](1.0 * SQLusd / (SQLmax*1024.0),N'%') + N')'
                        ELSE N'N/A'
                   END
             ELSE N''
        END
  FROM (-- queried here since each is used multiple times above
        SELECT MemSrv = (SELECT CAST(run_value AS BIGINT)
                           FROM [tempdb].[dbo].[SQLXL_Instance_info]
                          WHERE source = N'dm_os_sys_info'
                            AND name   = N'physical_memory_kb'
                        )
              ,SQLmax = (SELECT CAST(run_value AS BIGINT)
                           FROM [tempdb].[dbo].[SQLXL_Instance_info]
                          WHERE source = N'configurations'
                            AND name   = N'max server memory (MB)'
                        )
              ,SQLusd = (SELECT CAST(run_value AS BIGINT)
                           FROM [tempdb].[dbo].[SQLXL_Instance_info]
                          WHERE source = N'dm_os_sys_info'
                            AND name   = N'committed_kb'
                        )
       ) AS e

-- Diagnostic - Server - CPU count, Max Degree of Parallelism
-- Diagnostic - Server - CPU sockets, cores, hyperthread_ratio, SoftNUMA
UNION ALL
SELECT LTRIM( COALESCE((SELECT N' CPU ' + QUOTENAME(run_value)
                          FROM [tempdb].[dbo].[SQLXL_Instance_info]
                         WHERE source = N'dm_os_sys_info'
                           AND name   = N'cpu_count'
                       ),N'')
            + COALESCE((SELECT N' MAXDOP ' + QUOTENAME(run_value)
                              + CASE WHEN run_value <> N'0'
                                     THEN N' default [0] (all processors)'
                                     ELSE N''
                                END
                          FROM [tempdb].[dbo].[SQLXL_Instance_info]
                         WHERE source = N'configurations'
                           AND name   = N'max degree of parallelism'
                       ),N'')
            + COALESCE((SELECT N' Sockets ' + QUOTENAME(run_value)
                          FROM [tempdb].[dbo].[SQLXL_Instance_info]
                         WHERE source = N'dm_os_sys_info'
                           AND name   = N'socket_count'
                       ),N'')
            + COALESCE((SELECT N' Cores/Socket ' + QUOTENAME(run_value)
                          FROM [tempdb].[dbo].[SQLXL_Instance_info]
                         WHERE source = N'dm_os_sys_info'
                           AND name   = N'cores_per_socket'
                       ),N'')
            + COALESCE((SELECT N' Hyperthread Ratio ' + QUOTENAME(run_value)
                          FROM [tempdb].[dbo].[SQLXL_Instance_info]
                         WHERE source = N'dm_os_sys_info'
                           AND name   = N'hyperthread_ratio'
                       ),N'')
-- GLENN BERRY: automatic soft-NUMA disabled (should be 0 in most cases)
            + COALESCE((SELECT N' SoftNUMA ' + QUOTENAME(text_value)
                          FROM [tempdb].[dbo].[SQLXL_Instance_info]
                         WHERE source = N'dm_os_sys_info'
                           AND name   = N'softnuma_configuration_desc'
                       ),N'')
            );

--------------------------------------------------------------------------------------------------------------------------------------------
-- SQL Instance settings
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_Diagnostics] (diagnostic)
-- Diagnostic - Instance - non-default - Default Fill Factor NOT 0 or 100
SELECT diagnostic = N'Instance Fill Factor '
                  + CASE WHEN run_value IN (0,100) THEN N'100% (default)'
                         ELSE CAST(run_value AS NVARCHAR(20)) + N'%, default 100%'
                    END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'fill factor (%)'

-- Diagnostic - Instance - Minimum memory per query <> 1024
UNION ALL
SELECT  N'Minimum memory per query (KB) = ' + CAST(run_value AS NVARCHAR(20))
      + CASE WHEN run_value = 1024 THEN N' (default)' ELSE N', default 1024' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'min memory per query (KB)'

-- Diagnostic - Instance - non-default - remote data archive enabled (stretch-enabled)
UNION ALL
SELECT N'Remote data archive ENABLED, default DISABLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'servers'
   AND name      = N'is_rda_server'
   AND run_value = 1

-- Always Included --------------------------------------------------------------------------------------
-- Diagnostic - Instance - cost threshold for parallelism (default 5)
UNION ALL
SELECT  name + N' = ' + CAST(run_value AS NVARCHAR(20))
      + CASE WHEN run_value = 5 THEN N' (default)' ELSE N', default 5' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'Cost threshold for parallelism'

-- Diagnostic - Instance - Optimize for ad hoc workloads ENABLED
UNION ALL
SELECT  name + N' '
      + CASE WHEN run_value = 0 THEN N'OFF'        ELSE N'ON'            END
      + CASE WHEN run_value = 0 THEN N' (default)' ELSE N', default OFF' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'Optimize for ad hoc workloads'

-- Diagnostic - Instance - Product Update Type
UNION ALL
SELECT  N'Product Update Type = ' + CAST(run_value AS NVARCHAR(20))
      + CASE WHEN run_value IS NULL THEN N' (default)' ELSE N', default N/A' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source     = N'configurations'
   AND name       = N'ProductUpdateType'
   AND run_value IS NOT NULL

-- Diagnostic - Instance - SQL 2019+ - tempdb Is Metadata Memory Optimized
UNION ALL
SELECT  N'tempdb Metadata Memory Optimized = '
      + CASE WHEN run_value = 0
             THEN N'DISABLED (default) - consider enabling'
             ELSE N'ENABLED, default DISABLED'
        END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'tempdb metadata memory-optimized'
   AND CONVERT(INT,SERVERPROPERTY('ProductMajorVersion')) >= 15 -- 2019+

-- Diagnostic - Instance - non-default - Network packet size <> 4096
UNION ALL
SELECT  N'Network packet size ' + CAST(run_value AS NVARCHAR(20)) + N'B'
      + CASE WHEN run_value = 4096
             THEN N' (default)'
             ELSE  CASE WHEN run_value <> 8000 THEN N', consider 8000B' ELSE N'' END
                 + N', default 4096B'
        END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'network packet size (B)'

-- Only included if NOT DEFAULT value -------------------------------------------------------------------
-- Diagnostic - Instance - blocked process threshold <> 5
UNION ALL
SELECT  N'Blocked process threshold = ' + CAST(run_value AS NVARCHAR(20)) + N' seconds'
      + CASE WHEN run_value = 5 THEN N' (default)' ELSE N', default 5 seconds' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'blocked process threshold (s)'
   AND run_value NOT IN (0,5)

-- Diagnostic - Instance - non-default - index create memory (KB) <> 0
UNION ALL
SELECT  N'Index create memory = '
      + CASE WHEN run_value = 0 THEN N'dynamic (default)' ELSE CAST(run_value AS NVARCHAR(20)) + N'KB, default dynamic (0)' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'Index create memory (KB)'
   AND run_value NOT IN (0)

-- Diagnostic - Instance - non-default - max text repl size (B) <> 65536
UNION ALL
SELECT  N'Text Replication Size MAX = ' + CAST(run_value AS NVARCHAR(20)) + N'B'
      + CASE WHEN run_value = 65536 THEN N' (default)' ELSE N', default 65536B' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'configurations'
   AND name   = N'max text repl size (B)'
   AND run_value NOT IN (65536)

-- Diagnostic - Instance - non-default - query governor cost limit > 0
UNION ALL
SELECT  N'Query governor cost limit = ' + CAST(run_value AS NVARCHAR(20))
      + CASE WHEN run_value = 0 THEN N' - All (default)' ELSE N' default 0 (All)' END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'configurations'
   AND name      = N'query governor cost limit'
   AND run_value > 0

-- Diagnostic - Instance - non-default - Query waits for resources before it times out <> -1
UNION ALL
SELECT  N'Query waits for resources = ('+ CAST(run_value AS NVARCHAR(20)) +N')'
      + CASE WHEN run_value = -1
             THEN N' - 25X query cost (default)'
             ELSE N' sec, default (-1) - 25X estimated query cost'
        END
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'configurations'
   AND name      = N'query wait (s)'
   AND run_value <> -1

--------------------------------------------------------------------------------------------------------------------------------------------
-- Other Services installed
--------------------------------------------------------------------------------------------------------------------------------------------
UNION ALL
-- Diagnostic - Instance - non-default - Full-Text indexing is Installed
-- Diagnostic - Instance - full-text language
SELECT  N'Fulltext INSTALLED, Locale Identifier '
      + COALESCE((SELECT CAST(run_value AS NVARCHAR(20))
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'default full-text language'
                 ),N'')
      + COALESCE((SELECT N' - ' + text_value
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'fulltext_default_language_name'
                 ),N'')
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsFullTextInstalled'
   AND run_value = 1

UNION ALL
-- Diagnostic - Instance - full-text Crawl Bandwidth MAX & MIN
SELECT COALESCE((SELECT  N'> Crawl Bandwidth MAX = ' + CAST(run_value AS NVARCHAR(20))
                        + CASE WHEN run_value = 100 THEN N' (default)' ELSE N', default 100' END
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'FT crawl bandwidth (max)'
                 ),N'')
      + COALESCE((SELECT  N' MIN = ' + CAST(run_value AS NVARCHAR(20))
                        + CASE WHEN run_value = 0 THEN N' (default)' ELSE N', default 0' END
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'FT crawl bandwidth (min)'
                 ),N'')
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsFullTextInstalled'
   AND run_value = 1

UNION ALL
-- Diagnostic - Instance - full-text notify bandwidth MAX & MIN
SELECT COALESCE((SELECT  N'> Notify Bandwidth MAX = ' + CAST(run_value AS NVARCHAR(20))
                        + CASE WHEN run_value = 100 THEN N' (default)' ELSE N', default 100' END
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'FT notify bandwidth (max)'
                ),N'')
      + COALESCE((SELECT  N' MIN = ' + CAST(run_value AS NVARCHAR(20))
                        + CASE WHEN run_value = 0 THEN N' (default)' ELSE N', default 0' END
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'FT notify bandwidth (min)'
                 ),N'')
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsFullTextInstalled'
   AND run_value = 1

UNION ALL
-- Diagnostic - Instance - full-text crawl range MAX CPUs
SELECT COALESCE((SELECT  N'> Fulltext Crawl Range MAX = '
                        + CASE WHEN run_value = 4 THEN N' CPU (default)' ELSE N', default 4' END
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source = N'configurations'
                     AND name   = N'max full-text crawl range'
                 ),N'')
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsFullTextInstalled'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Advanced Analytics is Installed
UNION ALL
SELECT N'Advanced Analytics INSTALLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsAdvancedAnalyticsInstalled'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Big Data Cluster is Installed
UNION ALL
SELECT N'Big Data Cluster INSTALLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsBigDataCluster'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Always On (HADR) Enabled
UNION ALL
SELECT N'Always On (HADR) ENABLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source    = N'SERVERPROPERTY'
   AND name      = N'IsHadrEnabled'
   AND run_value = 1

-- Diagnostic - Instance - non-default - PolyBase is Installed
UNION ALL
SELECT N'PolyBase feature INSTALLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsPolyBaseInstalled'
   AND run_value = 1

-- Diagnostic - Instance - non-default - XTP (In-Memory Tables) is Supported
UNION ALL
SELECT N'XTP In-memory tables [SUPPORTED]'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsXTPSupported'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Microsoft Purview access policies are ENABLED
UNION ALL
SELECT N' Microsoft Purview access policies are ENABLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsExternalGovernanceEnabled'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Uses External Authentication Only
UNION ALL
SELECT N'Microsoft Entra-only authentication is ENABLED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsExternalAuthenticationOnly'
   AND run_value = 1

--------------------------------------------------------------------------------------------------------------------------------------------
-- Instance non-default settings
--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Instance - non-default - Server Is Clustered
UNION ALL
SELECT N'Server is CLUSTERED'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsClustered'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Uses Integrated Security Only
UNION ALL
SELECT N'Integrated Security ONLY'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsIntegratedSecurityOnly'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Is SQL Server Local DB
UNION ALL
SELECT N'Instance is SQL Server Express LocalDB'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsLocalDB'
   AND run_value = 1

-- Diagnostic - Instance - non-default - Is in Single User Mode
UNION ALL
SELECT N'Instance in SINGLE USER mode'
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source = N'SERVERPROPERTY'
   AND name   = N'IsSingleUser'
   AND run_value = 1
-- NOTE: no index performance related items from SERVERPROPERTY as of yet

-------------------------------------------------------------------------------------------------------------------------------------------
-- End of procedure
-------------------------------------------------------------------------------------------------------------------------------------------
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,GETDATE(),GETDATE()),0))
            + N' End   [tempdb].[dbo].[SQLXL_Instance]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END
GO -- end of procedure

/*########################################################################################################################################*\
Copy procedure SQLXL_Instance to tempdb
\*########################################################################################################################################*/
IF @@TRANCOUNT > 0 ROLLBACK;
RAISERROR ('Created procedure [dbo].[SQLXL_Instance] ...',0,0) WITH NOWAIT;

IF DB_NAME() <> N'tempdb'
BEGIN
   DECLARE @sql        NVARCHAR(MAX)
   SELECT @sql = REPLACE(definition,'''','''''')
     FROM sys.sql_modules 
    WHERE OBJECT_ID IN (SELECT object_id FROM sys.objects WHERE name = N'SQLXL_Instance')
   SET @sql = N'USE [tempdb];
   EXEC(''IF OBJECT_ID(''''[dbo].[SQLXL_Instance]'''') IS NOT NULL DROP PROCEDURE [dbo].[SQLXL_Instance]'');
   EXEC(''' + @sql +''')'
   EXEC(@sql)
   ---------------------------------------------------------------
   -- drop procedure SQLXL_Instance in this database after copy
   ---------------------------------------------------------------
   IF object_id('[dbo].[SQLXL_Instance]') IS NOT NULL DROP PROCEDURE [dbo].[SQLXL_Instance];
END;

-- VERSION 2024.07.15
/******************************************************************************************************************************************\
All SQLXL tables objects are created in [tempdb] (must be lower case to support case sensitive collation on installation)
Procedures are created in the connected-to database and then copied to [tempdb]. After copy they are deleted from the conencted-to database
Functions are created in tempdb by using the EXEC('USE tempdb;EXEC(''create function code'')') construct
\******************************************************************************************************************************************/

/*** LOCAL TESTING ***
EXEC [tempdb].[dbo].[SQLXL_Index]                                        -- runs for all USER databases
EXEC [tempdb].[dbo].[SQLXL_Index] @database_name = N'*'                  -- runs for ALL databases
EXEC [tempdb].[dbo].[SQLXL_Index] @database_name = N'WideWorldImporters' -- runs for a SINGLE database
--*/

/******************************************************************************************************************************************\
Copyright (C) 2024 Practice Computing Management Inc.
All rights reserved.

MIT License, http://www.opensource.org/licenses/mit-license.php
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files
(the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge,
publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

Credit to Brent Ozar Unlimited for the BI### Check IDs included in the Diagnostics. Source for these is found at
https://github.com/BrentOzarULTD/SQL-Server-First-Responder-Kit/blob/dev/Documentation/sp_BlitzIndex_Checks_by_Priority.md

\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
-- Creation Session settings
\******************************************************************************************************************************************/
SET ANSI_NULLS               ON;
SET ANSI_NULL_DFLT_ON        ON;
SET ANSI_PADDING             ON;
SET ANSI_WARNINGS            ON;
SET ARITHABORT               ON;
SET CONCAT_NULL_YIELDS_NULL  ON;
SET CURSOR_CLOSE_ON_COMMIT   ON;
SET NOCOUNT                  ON;
SET QUOTED_IDENTIFIER        ON;
SET XACT_ABORT               ON;

SET ARITHIGNORE             OFF;
SET FMTONLY                 OFF;
SET FORCEPLAN               OFF;
SET IMPLICIT_TRANSACTIONS   OFF;
SET NOEXEC                  OFF;
SET NUMERIC_ROUNDABORT      OFF;
SET STATISTICS IO,PROFILE,TIME,XML OFF;

SET DATEFORMAT              YMD;
SET DEADLOCK_PRIORITY       -10; -- Lowest priority
SET LOCK_TIMEOUT          10000; -- in milliseconds
SET QUERY_GOVERNOR_COST_LIMIT 0; -- 0 (the default) turns off the query governor, queries of any cost are allowed to execute.
SET ROWCOUNT                  0;
SET TEXTSIZE         2147483647;  -- Use 32767 on export to Excel - cell maximum

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

/******************************************************************************************************************************************\
SQL Server Versions
2022 = 16
2019 = 15
2017 = 14
2016 = 13
2014 = 12
2012 = 11
2008 = 10

SQL Server EngineEditions including Azure
-------------------------------------------------------------------------------------
 1 = Personal or Desktop Engine (Not available in SQL Server 2005 (9.x) and later versions.)
 2 = Standard (For Standard, Web, and Business Intelligence.)
 3 = Enterprise (For Evaluation, Developer, and Enterprise editions.)
 4 = Express (For Express, Express with Tools, and Express with Advanced Services)

 5 = SQL Database
 6 = Azure Synapse Analytics
 8 = Azure SQL Managed Instance
 9 = Azure SQL Edge (For all editions of Azure SQL Edge)
11 = Azure Synapse serverless SQL pools

Let the user know if this won't run on their version of SQL Server
*NOTE* TRY_CONVERT & TRY_CAST introduced in SQL 2012. If a database has COMPATIBILITY LEVEL < SQL 2012 they will not work
\******************************************************************************************************************************************/
DECLARE @EngineEdition       INT = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'EngineEdition'))) = 1
                                        THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'EngineEdition')))
                                        ELSE NULL
                                   END
       ,@ProductMajorVersion INT = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductMajorVersion'))) = 1
                                        THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductMajorVersion')))
                                        ELSE NULL
                                   END
       ,@ProductBuild        INT = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductBuild'))) = 1
                                        THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductBuild')))
                                        ELSE NULL
                                   END;

IF  @EngineEdition       <= 4 -- On premise engine editions
AND @ProductMajorVersion < 11 -- SQL2012
BEGIN
   RAISERROR ('*************************************************************************',0,0) WITH NOWAIT;
   RAISERROR ('* Oops! SQLXL_INDEX requires on-prem SQL Server Version 2012 or higher  *',0,0) WITH NOWAIT;
   RAISERROR ('* This uses the SQL "IIF" & "TRY_CAST" functions introduced in SQL 2012 *',0,0) WITH NOWAIT;
   RAISERROR ('*************************************************************************',0,0) WITH NOWAIT;
   RAISERROR ('',0,0) WITH NOWAIT;
   RAISERROR ('',0,0) WITH NOWAIT;
   RAISERROR ('',0,0) WITH NOWAIT;
END

IF @EngineEdition IN ( 6 -- Azure Synapse Analytics
                     , 9 -- Azure SQL Edge (For all editions of Azure SQL Edge)
                     ,11 -- Azure Synapse serverless SQL pools
                     )
BEGIN
   RAISERROR ('********************************************************************'   ,0,0) WITH NOWAIT;
   IF @EngineEdition =  6
      RAISERROR ('*   Oops! SQLXL_INDEX does not run on Azure Synapse Analytics      *',0,0) WITH NOWAIT;
   IF @EngineEdition =  9
      RAISERROR ('*   Oops! SQLXL_INDEX does not run on Azure SQL Edge               *',0,0) WITH NOWAIT;
   IF @EngineEdition = 11
      RAISERROR ('*  SQLXL_INDEX does not run on Azure Synapse Serverless SQL Pools  *',0,0) WITH NOWAIT;
   RAISERROR ('********************************************************************'   ,0,0) WITH NOWAIT;
   RAISERROR ('',0,0) WITH NOWAIT;
   RAISERROR ('',0,0) WITH NOWAIT;
   RAISERROR ('',0,0) WITH NOWAIT;
END

GO

/******************************************************************************************************************************************\
-- Drop all previous SQLXL index tempdb source data store (SQLXL_Index_%) objects in case of data structure change with latest version.
-- TRUNCATE/REBUILD is used to clear out any missing index recommendations that were created for those objects
\******************************************************************************************************************************************/
DECLARE @sql        NVARCHAR(MAX)
       ,@run_value  NVARCHAR(4000)
       ,@ssms_ads   TINYINT       = 1
       ,@msg        NVARCHAR(1000)

WHILE 1 = 1
BEGIN
   SELECT TOP (1)
          @run_value = QUOTENAME(s.name) + N'.' + QUOTENAME(t.name)
         ,@sql = N'TRUNCATE TABLE [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N';'
               + NCHAR(13) + NCHAR(10)
               -- Drops MISSING index recommendations
               + N'ALTER index ALL ON [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N' REBUILD;'
               + NCHAR(13) + NCHAR(10)
               + N'DROP TABLE [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N';'
     FROM [tempdb].[sys].[tables]  AS t WITH (READUNCOMMITTED)
     JOIN [tempdb].[sys].[objects] AS o WITH (READUNCOMMITTED)
       ON t.object_id  = o.object_id
     JOIN [tempdb].[sys].[schemas] AS s WITH (READUNCOMMITTED)
       ON o.schema_id  = s.schema_id
    WHERE t.name LIKE N'SQLXL_Index_%'
      AND s.name    = N'dbo'
    ORDER BY
          t.name;

   IF @@ROWCOUNT = 0 BREAK

   BEGIN TRY
      EXECUTE [sys].[sp_executesql] @sql;
   END TRY
   BEGIN CATCH
      SET @run_value = N'TRUNCATE/ALTER/DROP FAIL on ' + @run_value
      RAISERROR (@run_value,0,0) WITH NOWAIT;
   END CATCH
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'Dropping existing tempdb SQLXL_Index data collection tables if found'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Let 'em know what is happening
\******************************************************************************************************************************************/
RAISERROR ('Creating procedure [dbo].[SQLXL_Index]',0,0) WITH NOWAIT;

/******************************************************************************************************************************************\
-- Create the procedure [dbo].[SQLXL_Index] - captures source index data, organizes, and investigates for improvement opportunities
\******************************************************************************************************************************************/
IF OBJECT_ID('[dbo].[SQLXL_Index]') IS NULL
   EXEC ('CREATE PROCEDURE [dbo].[SQLXL_Index] AS RETURN 0;');
GO -- required since 'CREATE/ALTER PROCEDURE' must be the first statement in a query batch.

 ALTER PROCEDURE [dbo].[SQLXL_Index]
      (@database_name                    SYSNAME = NULL
       -- Asterisk ("*") for all databases including system
       -- NULL for all user (non-system) databases
       -- "database name" for a single database
      ,@cover_foreign_keys               TINYINT = 2
       --  0 = no need to continue to cover Foreign Key Constraints, do not create new indexes based on MISSING index recommendations
       --  1 = continue to cover keys that are TRUSTED, ENABLED, and REPLICATED & are DELETE or UPDATE referential action enabled
       --      Includes creating new indexes based on MISSING index recommendations
       --  2 = continue to cover all Foreign Key Constraints that are TRUSTED, ENABLED, and REPLICATED
       --      Includes creating new indexes based on MISSING index recommendations
       --  3 = continue to cover all Foreign Key Constraints regardless of status
       --      Includes creating new indexes based on MISSING index recommendations
      ,@create_Nonclustered_columnstores TINYINT = 1
       -- 0 = NO
       -- 1 = YES
      -----------------------------------
      -- priority computation weightings. relative values to apply to each of the corresponding metrics.
      -- larger value means higher weighting assigned to that metric
      -----------------------------------
      ,@Prio_wait_time                   SMALLINT = 100
      ,@Prio_wait_count                  SMALLINT =  50
      ,@Prio_locks                       SMALLINT =  20
      ,@Prio_lock_promotions             SMALLINT =  60
      ,@Prio_lock_promotion_fails        SMALLINT = 100
      ,@Prio_page_splits                 SMALLINT =  60
      ,@Prio_page_merges                 SMALLINT =  60
      ,@Prio_OPS_forwarded_fetches       SMALLINT =  30
      ,@Prio_missing_indexes             SMALLINT =  60
      ,@Prio_OPS_writes                  SMALLINT =  30
      ,@Prio_buffer_cache_used           SMALLINT =  80
      ,@Prio_OPS_read_write_ratio        SMALLINT =  15 -- Note: starts with 4X as the "zero" value and works backwards from there
      ,@Prio_reads                       SMALLINT =  10
      ,@Prio_scans                       SMALLINT =  40
      ,@Prio_lookups                     SMALLINT =  60
      ,@Prio_LOB                         SMALLINT =  80
      ,@xtp_Priority_deflator            SMALLINT =  10
      )
  WITH RECOMPILE

AS

/******************************************************************************************************************************************\
-- Procedure Environment settings
\******************************************************************************************************************************************/
SET ANSI_NULLS               ON;
SET ANSI_NULL_DFLT_ON        ON;
SET ANSI_PADDING             ON;
SET ANSI_WARNINGS            ON;
SET ARITHABORT               ON;
SET CONCAT_NULL_YIELDS_NULL  ON;
SET CURSOR_CLOSE_ON_COMMIT   ON;
SET NOCOUNT                  ON;
SET QUOTED_IDENTIFIER        ON;
SET XACT_ABORT               ON;

SET ARITHIGNORE             OFF;
SET FMTONLY                 OFF;
SET FORCEPLAN               OFF;
SET IMPLICIT_TRANSACTIONS   OFF;
SET NOEXEC                  OFF;
SET NUMERIC_ROUNDABORT      OFF;
SET STATISTICS IO,PROFILE,TIME,XML OFF;

SET DATEFORMAT              YMD;
SET DEADLOCK_PRIORITY       -10; -- Lowest priority
SET LOCK_TIMEOUT          10000; -- in milliseconds
SET QUERY_GOVERNOR_COST_LIMIT 0; -- 0 (the default) turns off the query governor, queries of any cost are allowed to execute.
SET ROWCOUNT                  0;
SET TEXTSIZE         2147483647;  -- Use 32767 on export to Excel - cell maximum

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

/******************************************************************************************************************************************\
-- Local Procedure variables
\******************************************************************************************************************************************/
DECLARE @collation            SYSNAME  = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@collection_DTTM      DATETIME = GETDATE()
       ----------------------------
       ,@database_id          INT      = 0
       ,@database_name_quoted NVARCHAR(MAX)
       ,@sql                  NVARCHAR(MAX)
       ,@exec_dttm            DATETIME = GETDATE()
       ,@i                    INT      = 1            -- database cursor loop counter, starts at 1
       ,@run_value            NVARCHAR(4000)
       ,@rowcount             BIGINT
       -----------------------------
       ,@ssms_ads             TINYINT  = (SELECT (1)
                                            FROM [sys].[dm_exec_sessions]
                                           WHERE session_id = @@SPID
                                             AND (   program_name LIKE N'Microsoft SQL Server Management Studio%'
                                                  OR program_name LIKE N'azdata%' --azure data studio
                                                  OR program_name    = N'SQLCMD'
                                                 )
                                         )
       ,@msg                  NVARCHAR(1000)
       -----------------------------
       ,@EngineEdition       INT = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'EngineEdition'))) = 1
                                        THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'EngineEdition')))
                                        ELSE NULL
                                   END
       ,@ProductMajorVersion INT = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductMajorVersion'))) = 1
                                        THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductMajorVersion')))
                                        ELSE NULL
                                   END
       ,@ProductBuild        INT = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductBuild'))) = 1
                                        THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductBuild')))
                                        ELSE NULL
                                   END;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'MM:SS:hhh SQLXL Index Job Step',0,0) WITH NOWAIT;
   RAISERROR(N'--------- -------------------------------------------------------------------------------------',0,0) WITH NOWAIT;
   RAISERROR(N' Starting SQLXL_Index data collection',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Drop previous SQLXL index tempdb source data stores (SQLXL_Index_%)
-- TRUNCATE/REBUILD is used to clear out any missing index recommendations that were created from the last execution(s)
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql        NVARCHAR(MAX)
       ,@run_value  NVARCHAR(4000)
       ,@ssms_ads   TINYINT       = 1
       ,@msg        NVARCHAR(1000)
       ,@exec_dttm  DATETIME      = GETDATE();
--*/

WHILE 1 = 1
BEGIN
   SELECT TOP (1)
          @run_value = QUOTENAME(s.name) + N'.' + QUOTENAME(t.name)
         ,@sql = N'TRUNCATE TABLE [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N';'
               + NCHAR(13) + NCHAR(10)
               -- Drops MISSING index recommendations
               + N'ALTER index ALL ON [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N' REBUILD;'
               + NCHAR(13) + NCHAR(10)
               + N'DROP TABLE [tempdb].' + QUOTENAME(s.name) + N'.' + QUOTENAME(t.name) + N';'
     FROM [tempdb].[sys].[tables]  AS t WITH (READUNCOMMITTED)
     JOIN [tempdb].[sys].[objects] AS o WITH (READUNCOMMITTED)
       ON t.object_id  = o.object_id
     JOIN [tempdb].[sys].[schemas] AS s WITH (READUNCOMMITTED)
       ON o.schema_id  = s.schema_id
    WHERE t.name LIKE N'SQLXL_Index_%'
      AND s.name    = N'dbo'
      AND t.name NOT IN (N'SQLXL_Instance_info'
                        ,N'SQLXL_Instance_Diagnostics'
                        )
    ORDER BY t.name;

   IF @@ROWCOUNT = 0 BREAK

   BEGIN TRY
      EXECUTE [sys].[sp_executesql] @sql;
   END TRY
   BEGIN CATCH
      SET @run_value = N'TRUNCATE/ALTER/DROP FAIL on ' + @run_value
      RAISERROR (@run_value,0,0) WITH NOWAIT;
   END CATCH
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Dropped existing tempdb SQLXL_Index data collection tables if found'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Create persisted tables to capture platform information. TRY_CONVERT ok here since we're running in TEMPDB on SQL 2012 or higher
\******************************************************************************************************************************************/
-- Instance Startup Parameters
SELECT collation        = @collation
      ,collection_DTTM  = @collection_DTTM
      ,version_major    = @ProductMajorVersion
      ,version_minor    = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductMinorVersion'))) = 1
                               THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductMinorVersion')))
                               ELSE 0
                          END
      ,version_build    = @ProductBuild
      ,version_revision = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductVersion'))) = 1
                               THEN CONVERT(INT,CONVERT(NVARCHAR(20),SERVERPROPERTY(N'ProductVersion')))
                               ELSE 0
                          END
  INTO [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters];

/******************************************************************************************************************************************\
 Get instance information
\******************************************************************************************************************************************/
EXEC [tempdb].[dbo].[SQLXL_Instance]

/******************************************************************************************************************************************\
-- Collect [sys].[databases] info - use collation from tempdb to avoid collation issues later
-- use the database_id's from this table to filter further data collection
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql         NVARCHAR(MAX)
       ,@run_value   NVARCHAR(4000)
       ,@ssms_ads    TINYINT       = 1
       ,@msg         NVARCHAR(1000)
       ,@exec_dttm  DATETIME      = GETDATE();

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_databases]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_databases]
--*/

;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2008+ ---------------------------------------------------------------
       log_reuse_wait                              = TRY_CONVERT(TINYINT         ,NULL)
      ,log_reuse_wait_desc                         = TRY_CONVERT(NVARCHAR(120)   ,NULL) COLLATE DATABASE_DEFAULT
      ,is_cdc_enabled                              = TRY_CONVERT(BIT             ,NULL)
      ,is_memory_optimized_elevate_to_snapshot_on  = TRY_CONVERT(BIT             ,NULL)
      -- SQL 2012+ ----------------------------------------------------------------
      ,replica_id                                  = TRY_CONVERT(UNIQUEIDENTIFIER,NULL)
      ,group_database_id                           = TRY_CONVERT(UNIQUEIDENTIFIER,NULL)
      ,default_language_lcid                       = TRY_CONVERT(SMALLINT        ,NULL)
      ,default_language_name                       = TRY_CONVERT(NVARCHAR(256)   ,NULL) COLLATE DATABASE_DEFAULT
      ,default_fulltext_language_lcid              = TRY_CONVERT(INT             ,NULL)
      ,default_fulltext_language_name              = TRY_CONVERT(NVARCHAR(256)   ,NULL)
      ,is_nested_triggers_on                       = TRY_CONVERT(BIT             ,NULL)
      ,is_transform_noise_words_on                 = TRY_CONVERT(BIT             ,NULL)
      ,two_digit_year_cutoff                       = TRY_CONVERT(SMALLINT        ,NULL)
      ,containment                                 = TRY_CONVERT(TINYINT         ,NULL)
      ,containment_desc                            = TRY_CONVERT(NVARCHAR(120)   ,NULL) COLLATE DATABASE_DEFAULT
      ,target_recovery_time_in_seconds             = TRY_CONVERT(INT             ,NULL)
      -- SQL 2014+ ----------------------------------------------------------------
      ,resource_pool_id                            = TRY_CONVERT(INT             ,NULL)
      ,is_auto_create_stats_incremental_on         = TRY_CONVERT(BIT             ,NULL)
      -- SQL 2014+,Azure SQL Database ---------------------------------------------
      ,delayed_durability                          = TRY_CONVERT(INT             ,NULL)
      ,delayed_durability_desc                     = TRY_CONVERT(NVARCHAR(120)   ,NULL) COLLATE DATABASE_DEFAULT
      -- SQL 2016+ ----------------------------------------------------------------
      ,is_query_store_on                           = TRY_CONVERT(BIT             ,NULL)
      ,is_remote_data_archive_enabled              = TRY_CONVERT(BIT             ,NULL)
      ,is_mixed_page_allocation_on                 = TRY_CONVERT(BIT             ,NULL)
      -- SQL 2017+ ----------------------------------------------------------------
      ,is_temporal_history_retention_enabled       = TRY_CONVERT(BIT             ,NULL)
      -- SQL 2019+,Azure SQL Database ---------------------------------------------
      ,physical_database_name                      = TRY_CONVERT(NVARCHAR(256)   ,NULL) COLLATE DATABASE_DEFAULT
      ,is_accelerated_database_recovery_on         = TRY_CONVERT(BIT             ,NULL)
      ,is_memory_optimized_enabled                 = TRY_CONVERT(BIT             ,NULL)
      -- SQL 2022+ ----------------------------------------------------------------
      ,is_change_feed_enabled                      = TRY_CONVERT(BIT             ,NULL)
      ,is_data_retention_enabled                   = TRY_CONVERT(BIT             ,NULL)
      -- Azure Synapse Analytics Gen2 ---------------------------------------------
      ,is_result_set_caching_on                    = TRY_CONVERT(BIT             ,NULL)
      ,is_tempdb_spill_to_remote_store             = TRY_CONVERT(BIT             ,NULL)
      ,is_stale_page_detection_on                  = TRY_CONVERT(BIT             ,NULL)
      -- Azure SQL Database -------------------------------------------------------
      ,catalog_collation_type                      = TRY_CONVERT(INT             ,NULL)
      ,catalog_collation_type_desc                 = TRY_CONVERT(NVARCHAR(120)   ,NULL) COLLATE DATABASE_DEFAULT
      ,is_federation_member                        = TRY_CONVERT(BIT             ,NULL)
      ,is_ledger_on                                = TRY_CONVERT(BIT             ,NULL)
)
SELECT qry.*
  INTO [tempdb].[dbo].[SQLXL_Index_sys_databases]
  FROM newcol
 CROSS
 APPLY (-- [sys].[databases]
SELECT name                                        = db.name                                       COLLATE DATABASE_DEFAULT
                                                  -- db. required since database_id also in [sys].[change_tracking_databases]
      ,database_id                                 = db.database_id
      ,source_database_id
--    ,owner_sid -- varbinary(85) SID (Security-Identifier) of the external owner of the database
      ,create_date
      ,compatibility_level
      ,collation_name                              = collation_name                             COLLATE DATABASE_DEFAULT
      ,user_access
      ,user_access_desc                            = user_access_desc                           COLLATE DATABASE_DEFAULT
      ,is_read_only
      ,is_auto_close_on
      ,is_auto_shrink_on
      ,state
      ,state_desc                                  = state_desc                                 COLLATE DATABASE_DEFAULT
      ,is_in_standby
      ,is_cleanly_shutdown
      ,is_supplemental_logging_enabled
      ,snapshot_isolation_state
      ,snapshot_isolation_state_desc               = snapshot_isolation_state_desc              COLLATE DATABASE_DEFAULT
      ,is_read_committed_snapshot_on
      ,recovery_model
      ,recovery_model_desc                         = recovery_model_desc                        COLLATE DATABASE_DEFAULT
      ,page_verify_option
      ,page_verify_option_desc                     = page_verify_option_desc                    COLLATE DATABASE_DEFAULT
      ,is_auto_create_stats_on
      ,is_auto_create_stats_incremental_on
      ,is_auto_update_stats_on
      ,is_auto_update_stats_async_on
      ,is_ansi_null_default_on
      ,is_ansi_nulls_on
      ,is_ansi_padding_on
      ,is_ansi_warnings_on
      ,is_arithabort_on
      ,is_concat_null_yields_null_on
      ,is_numeric_roundabort_on
      ,is_quoted_identifier_on
      ,is_recursive_triggers_on
      ,is_cursor_close_on_commit_on
      ,is_local_cursor_default
      ,is_fulltext_enabled
      ,is_trustworthy_on
      ,is_db_chaining_on
      ,is_parameterization_forced
      ,is_master_key_encrypted_by_server
      ,is_query_store_on
      ,is_published
      ,is_subscribed
      ,is_merge_published
      ,is_distributor
      ,is_sync_with_backup
      ,service_broker_guid
      ,is_broker_enabled
      ,log_reuse_wait
      ,log_reuse_wait_desc                         = log_reuse_wait_desc                        COLLATE DATABASE_DEFAULT
      ,is_date_correlation_on
      ,is_cdc_enabled
      ,is_encrypted
      ,is_honor_broker_priority_on
      ,replica_id
      ,group_database_id
      ,resource_pool_id
      ,default_language_lcid
      ,default_language_name                       = default_language_name                      COLLATE DATABASE_DEFAULT
      ,default_fulltext_language_lcid
      ,default_fulltext_language_name
      ,is_nested_triggers_on
      ,is_transform_noise_words_on
      ,two_digit_year_cutoff
      ,containment
      ,containment_desc                            = containment_desc                           COLLATE DATABASE_DEFAULT
      ,target_recovery_time_in_seconds
      ,delayed_durability
      ,delayed_durability_desc                     = delayed_durability_desc                    COLLATE DATABASE_DEFAULT
      ,is_memory_optimized_elevate_to_snapshot_on
      ,is_federation_member
      ,is_remote_data_archive_enabled
      ,is_mixed_page_allocation_on
      ,is_temporal_history_retention_enabled
      ,catalog_collation_type
      ,catalog_collation_type_desc                 = catalog_collation_type_desc                COLLATE DATABASE_DEFAULT
      ,physical_database_name                      = physical_database_name                     COLLATE DATABASE_DEFAULT
      ,is_result_set_caching_on
      ,is_accelerated_database_recovery_on
      ,is_tempdb_spill_to_remote_store
      ,is_stale_page_detection_on
      ,is_memory_optimized_enabled
      ,is_data_retention_enabled
      ,is_ledger_on
      ,is_change_feed_enabled
       -- [sys].[change_tracking_databases] -------------------------------------------------------------------------
      ,is_auto_cleanup_on
      ,retention_period
      ,retention_period_units_desc
      ,retention_period_units
  FROM [sys].[databases] AS db
  LEFT OUTER
  JOIN [sys].[change_tracking_databases] AS c
    ON db.database_id = c.database_id
)
AS qry -- from CROSS APPLY
 WHERE qry.user_access_desc = N'MULTI_USER'
   AND qry.state_desc       = N'ONLINE'
   AND qry.is_distributor   = 0
   AND (   (    @database_name IS NULL -- NULL selection made, all non-system databases
            AND (   LOWER(qry.name)
                     NOT IN (N'dbatools'
                            ,N'dbadmin'
                            ,N'dbmaintenance'
                            ,N'dwconfiguration'
                            ,N'dwdiagnostics'
                            ,N'dwqueue'
                            ,N'master'
                            ,N'managementdatawarehouse'
                            ,N'model'
                            ,N'msdb'
                            ,N'ssisdb'
                            ,N'tempdb'
                            )
                AND qry.name NOT LIKE N'ReportServer%'
                AND qry.name NOT LIKE N'rdsadmin%'
               )
           )
        OR @database_name = qry.name -- 1 database requested
        OR @database_name = N'*'     -- all databases including system
       );

SET @rowcount = @@ROWCOUNT;

--------------------------------------------------------------------------------------------------------------------------------------------
-- Check if at least 1 database to be collected
--------------------------------------------------------------------------------------------------------------------------------------------
IF @rowcount = 0 -- no database found to collect
BEGIN
   RAISERROR(N'',0,0) WITH NOWAIT;
   RAISERROR(N'*** No database(s) to process. Exiting ***',0,0) WITH NOWAIT;
   RETURN
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' [sys].[databases],[change_tracking_databases] -'
            + TRY_CAST(@rowcount AS NVARCHAR(11)) + N'database(s) found'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
--  create index on if not found on SQLXL_Index_sys_databases to speed up subsequent queries
--------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_databases'
              )
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_databases__database_id
       ON [tempdb].[dbo].[SQLXL_Index_sys_databases]
         (database_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
               + N' [msdb] Index [ixuc_SQLXL_Index_sys_databases__database_id]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
-- Collect [sys].[availability_replicas]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads  TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_availability_replicas]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_availability_replicas];
--*/

IF @EngineEdition < 5 -- Not Azure
WITH newcol AS (-- columns added after SQL Server 2005. Semicolon not needed since CTE is inside IF statement
SELECT -- SQL 2019+ ---------------------------------
       read_write_routing_url = TRY_CONVERT(SYSNAME,NULL)
      ,seeding_mode           = TRY_CONVERT(TINYINT,NULL)
      ,seeding_mode_desc      = TRY_CONVERT(SYSNAME,NULL)
)
SELECT qry.*
  INTO [tempdb].[dbo].[SQLXL_Index_sys_availability_replicas]
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[availability_replicas]
SELECT replica_id
      ,group_id
      ,replica_metadata_id
      ,replica_server_name                   = replica_server_name                   COLLATE DATABASE_DEFAULT
--    ,owner_sid -- varbinary(85) Security identifier (SID) registered to this server instance
      ,endpoint_url                          = endpoint_url                          COLLATE DATABASE_DEFAULT
      ,availability_mode
      ,availability_mode_desc                = availability_mode_desc                COLLATE DATABASE_DEFAULT
      ,failover_mode
      ,failover_mode_desc                    = failover_mode_desc                    COLLATE DATABASE_DEFAULT
      ,session_timeout
      ,primary_role_allow_connections
      ,primary_role_allow_connections_desc   = primary_role_allow_connections_desc   COLLATE DATABASE_DEFAULT
      ,secondary_role_allow_connections
      ,secondary_role_allow_connections_desc = secondary_role_allow_connections_desc COLLATE DATABASE_DEFAULT
      ,create_date
      ,modify_date
      ,backup_priority
      ,read_only_routing_url                 = read_only_routing_url                 COLLATE DATABASE_DEFAULT
      ,seeding_mode
      ,seeding_mode_desc                     = seeding_mode_desc                     COLLATE DATABASE_DEFAULT
      ,read_write_routing_url                = read_write_routing_url                COLLATE DATABASE_DEFAULT
  FROM [sys].[availability_replicas]
) AS qry -- from CROSS APPLY

ELSE -- for Azure since no [sys].[availability_replicas]
SELECT TOP (0)
       replica_id                            = TRY_CONVERT(UNIQUEIDENTIFIER,NULL)
      ,group_id                              = TRY_CONVERT(UNIQUEIDENTIFIER,NULL)
      ,replica_metadata_id                   = TRY_CONVERT(INT,NULL)
      ,replica_server_name                   = TRY_CONVERT(NVARCHAR(256),NULL) COLLATE DATABASE_DEFAULT
--    ,owner_sid -- varbinary(85) Security identifier (SID) registered to this server instance
      ,endpoint_url                          = TRY_CONVERT(NVARCHAR(128),NULL) COLLATE DATABASE_DEFAULT
      ,availability_mode                     = TRY_CONVERT(TINYINT,NULL)
      ,availability_mode_desc                = TRY_CONVERT(NVARCHAR(60),NULL)  COLLATE DATABASE_DEFAULT
      ,failover_mode                         = TRY_CONVERT(TINYINT,NULL)
      ,failover_mode_desc                    = TRY_CONVERT(NVARCHAR(60),NULL)  COLLATE DATABASE_DEFAULT
      ,session_timeout                       = TRY_CONVERT(INT,NULL)
      ,primary_role_allow_connections        = TRY_CONVERT(TINYINT,NULL)
      ,primary_role_allow_connections_desc   = TRY_CONVERT(NVARCHAR(60),NULL)  COLLATE DATABASE_DEFAULT
      ,secondary_role_allow_connections      = TRY_CONVERT(TINYINT,NULL)
      ,secondary_role_allow_connections_desc = TRY_CONVERT(NVARCHAR(60),NULL)  COLLATE DATABASE_DEFAULT
      ,create_date                           = TRY_CONVERT(DATETIME,NULL)
      ,modify_date                           = TRY_CONVERT(DATETIME,NULL)
      ,backup_priority                       = TRY_CONVERT(INT,NULL)
      ,read_only_routing_url                 = TRY_CONVERT(NVARCHAR(256),NULL) COLLATE DATABASE_DEFAULT
      ,read_write_routing_url                = TRY_CONVERT(NVARCHAR(256),NULL) COLLATE DATABASE_DEFAULT
      ,seeding_mode                          = TRY_CONVERT(TINYINT,NULL)
      ,seeding_mode_desc                     = TRY_CONVERT(NVARCHAR(60),NULL)  COLLATE DATABASE_DEFAULT
  INTO [tempdb].[dbo].[SQLXL_Index_sys_availability_replicas];

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' Instance [sys].[availability_replicas]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_hadr_availability_replica_states]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads  TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states]
--*/

IF @EngineEdition < 5 -- Not Azure
WITH newcol AS (-- columns added after SQL Server 2005. Semicolon not needed since CTE is inside IF statement
SELECT -- SQL 2017+ -------------------------------------------------------
       write_lease_remaining_ticks                 = TRY_CONVERT(BIGINT  ,NULL)
      ,current_configuration_commit_start_time_utc = TRY_CONVERT(DATETIMEOFFSET ,NULL)
)
SELECT qry.*
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states]
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[dm_hadr_availability_replica_states]
SELECT replica_id
      ,group_id
      ,is_local
      ,role
      ,role_desc                                   = role_desc                                 COLLATE DATABASE_DEFAULT
      ,operational_state
      ,operational_state_desc                      = operational_state_desc                    COLLATE DATABASE_DEFAULT
      ,connected_state
      ,connected_state_desc                        = connected_state_desc                      COLLATE DATABASE_DEFAULT
      ,recovery_health
      ,recovery_health_desc                        = recovery_health_desc                      COLLATE DATABASE_DEFAULT
      ,synchronization_health
      ,synchronization_health_desc                 = synchronization_health_desc               COLLATE DATABASE_DEFAULT
      ,last_connect_error_number
      ,last_connect_error_description              = last_connect_error_description            COLLATE DATABASE_DEFAULT
      ,last_connect_error_timestamp                -- stored as a DATETIME type
      ,write_lease_remaining_ticks
      ,current_configuration_commit_start_time_utc = current_configuration_commit_start_time_utc
  FROM [sys].[dm_hadr_availability_replica_states]
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1)

ELSE -- for Azure since no [sys].[dm_hadr_availability_replica_states]
SELECT replica_id                                  = TRY_CONVERT(UNIQUEIDENTIFIER,NULL)
      ,group_id                                    = TRY_CONVERT(UNIQUEIDENTIFIER,NULL)
      ,is_local                                    = TRY_CONVERT(BIT,NULL)
      ,role                                        = TRY_CONVERT(TINYINT,NULL)
      ,role_desc                                   = TRY_CONVERT(NVARCHAR(60),NULL)   COLLATE DATABASE_DEFAULT
      ,operational_state                           = TRY_CONVERT(TINYINT,NULL)
      ,operational_state_desc                      = TRY_CONVERT(NVARCHAR(60),NULL)   COLLATE DATABASE_DEFAULT
      ,connected_state                             = TRY_CONVERT(TINYINT,NULL)
      ,connected_state_desc                        = TRY_CONVERT(NVARCHAR(60),NULL)   COLLATE DATABASE_DEFAULT
      ,recovery_health                             = TRY_CONVERT(TINYINT,NULL)
      ,recovery_health_desc                        = TRY_CONVERT(NVARCHAR(60),NULL)   COLLATE DATABASE_DEFAULT
      ,synchronization_health                      = TRY_CONVERT(TINYINT,NULL)
      ,synchronization_health_desc                 = TRY_CONVERT(NVARCHAR(60),NULL)   COLLATE DATABASE_DEFAULT
--    ,last_connect_error_number                   = TRY_CONVERT(TINYINT,NULL)                                 -- Omitted since unused
--    ,last_connect_error_description              = TRY_CONVERT(NVARCHAR(1024),NULL) COLLATE DATABASE_DEFAULT -- Omitted since unused
--    ,last_connect_error_timestamp                = TRY_CONVERT(DATETIME,NULL)                                -- Omitted since unused
--    ,write_lease_remaining_ticks                 = TRY_CONVERT(BIGINT,NULL)                                  -- Omitted since unused
--    ,current_configuration_commit_start_time_utc = TRY_CONVERT(DATETIMEOFFSET,NULL)                          -- Omitted since unused
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states];

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' Instance [sys].[dm_hadr_availability_replica_states]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Missing index details - includes [sys].[dm_db_missing_index_details], [sys].[dm_db_missing_index_groups],
--                                  [sys].[dm_db_missing_index_group_stats]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads  TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details]
--*/

SELECT --------------------------------------------------------------
       -- [sys].[dm_db_missing_index_details]
       --------------------------------------------------------------
       mid.index_handle
      ,mid.database_id
      ,mid.object_id
      ,statement               = mid.statement          COLLATE DATABASE_DEFAULT
      ,equality_columns        = mid.equality_columns   COLLATE DATABASE_DEFAULT
      ,inequality_columns      = mid.inequality_columns COLLATE DATABASE_DEFAULT
      ,included_columns        = mid.included_columns   COLLATE DATABASE_DEFAULT
      ,mig.index_group_handle
       --------------------------------------------------------------
       -- [sys].[dm_db_missing_index_group_stats]
       --------------------------------------------------------------
      ,migs.group_handle
      ,migs.unique_compiles
      ,migs.user_seeks
      ,migs.user_scans
      ,migs.last_user_seek
      ,migs.last_user_scan
      ,migs.avg_total_user_cost
      ,migs.avg_user_impact
      ,migs.system_seeks
      ,migs.system_scans
      ,migs.last_system_seek
      ,migs.last_system_scan
      ,migs.avg_total_system_cost
      ,migs.avg_system_impact
       --------------------------------------------------------------
       -- Added columns
       --------------------------------------------------------------
      ,mix_Advantage_AMT = 1.0 * ( (migs.user_seeks + (migs.user_scans * 4))      -- scans weighted heavier
                                  * migs.avg_total_user_cost
                                  * migs.avg_user_impact
                                 )                                                -- if values NULL retain NULL vale
                         + 1.0 * ( (migs.system_seeks + (migs.system_scans * 4))  -- scans weighted heavier
                                  * migs.avg_total_system_cost
                                  * migs.avg_system_impact
                                 )                                                -- if values NULL retain NULL vale
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details]
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases]     AS d                        -- filters out databases we're not interested in
  JOIN [sys].[dm_db_missing_index_details]     AS mid
    ON d.database_id          = mid.database_id
  LEFT OUTER
  JOIN [sys].[dm_db_missing_index_groups]      AS mig
    ON mid.index_handle       = mig.index_handle
  LEFT OUTER
  JOIN [sys].[dm_db_missing_index_group_stats] AS migs
    ON mig.index_group_handle = migs.group_handle
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' Instance [sys].[dm_db_missing_index_details] - includes index groups, group_stats'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
-- create index on SQLXL_Index_sys_dm_db_missing_index_details
-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_missing_index_details'
              )
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_dm_db_missing_index_details
       ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details]
         (database_id
         ,object_id
         ,index_handle
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
               + N' Index [ixuc_SQLXL_Index_sys_dm_db_missing_index_details]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
-- Missing index columns - [sys].[dm_db_missing_index_columns]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_columns]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_columns]
--*/

SELECT --------------------------------------------------------------
       -- [sys].[dm_db_missing_index_details]
       --------------------------------------------------------------
       database_id      = mid.database_id
      ,object_id        = mid.object_id
      ,index_handle     = mid.index_handle
       --------------------------------------------------------------
       -- [sys].[dm_db_missing_index_columns]
       --------------------------------------------------------------
      ,column_id        = mic.column_id
      ,column_name      = mic.column_name  COLLATE DATABASE_DEFAULT
      ,column_usage     = mic.column_usage COLLATE DATABASE_DEFAULT
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_columns]
  FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details] AS mid WITH (READUNCOMMITTED)
 CROSS
 APPLY [sys].[dm_db_missing_index_columns] (mid.index_handle) mic
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' Instance [sys].[dm_db_missing_index_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
-- Add index on SQLXL_Index_sys_dm_db_missing_index_columns to speed up subsequent queries ---------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_missing_index_columns')
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_dm_db_missing_index_columns
       ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_columns]
         (database_id
         ,object_id
         ,index_handle
         ,column_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N' Index [ixuc_SQLXL_Index_sys_dm_db_missing_index_columns]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
   END
END

/******************************************************************************************************************************************\
-- Missing index Group Stats Query & query text - SQL 2019+, Azure SQL Database, Azure SQL Managed Instance
-- Only get 1 query for each missing index, based on the query with highest benefit from the missing index
--      and get the details for the plan with the most total reads in [sys].[dm_exec_query_stats] (if more than 1 found)
-- Note from Brent Ozar:
-- "The DMV is only supposed to have 600 rows in it
--  If it's got more, they could see performance slowdowns from flushing out buffer and query cache due to over large memory grant"
--  https://github.com/BrentOzarULTD/SQL-Server-First-Responder-Kit/issues/3085
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start [sys].[dm_db_missing_index_group_stats] - Most read query & query_text - Azure,SQL 2019',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads  TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_group_stats_query]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_group_stats_query]
--*/

IF @ProductMajorVersion >= 15           -- SQL 2019+
OR UPPER(TRY_CONVERT(SYSNAME,SERVERPROPERTY(N'EDITION')))  = N'SQL AZURE' -- Azure SQL Database
SELECT migs.group_handle
      ,plan_handle               = TRY_CONVERT(VARCHAR(100),qs.plan_handle                ,1) COLLATE DATABASE_DEFAULT -- varbinary(64) datatype
      ,query_plan                = TRY_CONVERT(VARCHAR(MAX),qp.query_plan                   ) COLLATE DATABASE_DEFAULT
      ,last_sql_handle           = TRY_CONVERT(VARCHAR(100),migs.last_sql_handle          ,1) COLLATE DATABASE_DEFAULT
      ,query_text = TRY_CONVERT(VARCHAR(MAX),
                    SUBSTRING(st.text
                             ,(migs.last_statement_start_offset / 2) + 1
                             ,((IIF(migs.last_statement_end_offset = -1
                                   ,DATALENGTH(st.text)
                                   ,migs.last_statement_end_offset)
                                - migs.last_statement_start_offset
                               )/2) + 1)) COLLATE DATABASE_DEFAULT
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_group_stats_query]

/*** LOCAL TESTING ***
DECLARE @sql         NVARCHAR(MAX)
       ,@run_value   NVARCHAR(4000)
       ,@ssms_ads    TINYINT       = 1
       ,@msg         NVARCHAR(1000)
       ,@exec_dttm  DATETIME      = GETDATE();
SELECT *
--*/

  FROM (-- get query with greatest benefit from each missing index group handle
        SELECT *
          FROM (-- if more than one query for a missing index group handle get highest order by benefit descending
                SELECT mgq.group_handle
                      ,mgq.query_hash
                      ,mgq.last_sql_handle
                      ,mgq.last_statement_start_offset
                      ,mgq.last_statement_end_offset
                      ,rn = ROW_NUMBER() OVER (PARTITION BY mgq.group_handle
                                                   ORDER BY ( mgq.avg_total_user_cost
                                                            * mgq.avg_user_impact)
                                                            * (   mgq.user_seeks
                                                               + (mgq.user_scans * 4.0)
                                                              ) DESC  -- scans count 4X seeks
                                              )
                      --------------------------------------------------------------------------------------------------
                      -- Columns currently OMITTED from [sys].[dm_db_missing_index_group_stats_query]
                      -- May be included in a separate table in future version
                      --------------------------------------------------------------------------------------------------
                      -- user_seeks
                      -- user_scans
                      -- last_user_seek
                      -- last_user_scan
                      -- avg_total_user_cost
                      -- avg_user_impact
                      -----------------------------------------------------------------------
                      -- system_seeks
                      -- system_scans
                      -- last_system_seek
                      -- last_system_scan
                      -- avg_total_system_cost
                      -- avg_system_impact
                      -----------------------------------------------------------------------
                      -- query_hash
                      -- query_plan_hash
                      -- last_sql_handle
                      -- last_statement_start_offset
                      -- last_statement_end_offset
                      -- last_statement_sql_handle -- Used by Query Store, references the statement_sql_handle
                  FROM [sys].[dm_db_missing_index_group_stats_query] AS mgq WITH (READUNCOMMITTED)
               ) AS migs
         WHERE migs.rn = 1
       ) AS migs
 OUTER
 APPLY (-- get top query plan from [sys].[dm_exec_query_stats] for query_hash with the most reads
        -- and worker time if in-memory (XTP)
        SELECT TOP (1)
               qs.plan_handle
          FROM [sys].[dm_exec_query_stats] AS qs WITH (READUNCOMMITTED)
         WHERE migs.query_hash = qs.query_hash
         ORDER BY
               (qs.total_physical_reads + qs.total_logical_reads) DESC -- total reads. Will always be 0 querying a memory-optimized table.
              ,qs.total_worker_time                               DESC
       ) qs
 OUTER
 APPLY [sys].[dm_exec_query_plan] (qs.plan_handle)     AS qp
 OUTER
 APPLY [sys].[dm_exec_sql_text] (migs.last_sql_handle) AS st
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1)

ELSE -- version < SQL 2019 or Azure SQL database
   SELECT TOP (0)
          group_handle    = CAST(NULL AS INT)
         ,plan_handle     = CAST(NULL AS NVARCHAR(100)) COLLATE DATABASE_DEFAULT
         ,query_plan      = CAST(NULL AS NVARCHAR(MAX)) COLLATE DATABASE_DEFAULT
         ,last_sql_handle = CAST(NULL AS NVARCHAR(100)) COLLATE DATABASE_DEFAULT
         ,query_text      = CAST(NULL AS NVARCHAR(MAX)) COLLATE DATABASE_DEFAULT
     INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_group_stats_query];

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' [sys].[dm_db_missing_index_group_stats] - Most read query & query_text - Azure,SQL 2019'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_missing_index_group_stats_query'
              )
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_dm_db_missing_index_group_stats_query
       ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_group_stats_query]
         (group_handle)
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N' Index [ixuc_SQLXL_Index_sys_dm_db_missing_index_group_stats_query]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_db_index_usage_stats] for one or all user databases
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_usage_stats]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_usage_stats]
--*/

SELECT qry.*
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_usage_stats]
  FROM (-- columns from [sys].[dm_db_index_usage_stats]
SELECT ius.database_id
      ,ius.object_id
      ,ius.index_id
      ,User_total_CNT    = ius.user_seeks + ius.user_scans + ius.user_lookups + ius.user_updates
      ,user_read_CNT     = ius.user_seeks + ius.user_scans + ius.user_lookups
      ,ius.user_seeks
      ,ius.user_scans
      ,ius.user_lookups
      ,ius.user_updates
      ,ius.system_seeks
      ,ius.system_scans
      ,ius.system_lookups
      ,ius.system_updates
      ,ius.last_user_seek
      ,ius.last_user_scan
      ,ius.last_user_lookup
      ,ius.last_user_update
      ,ius.last_system_seek
      ,ius.last_system_scan
      ,ius.last_system_lookup
      ,ius.last_system_update
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
 INNER LOOP
  JOIN [sys].[dm_db_index_usage_stats]     AS ius
    ON d.database_id = ius.database_id
) AS qry
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' [sys].[dm_db_index_usage_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_sys_dm_db_index_usage_stats'
              )
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_sys_dm_db_index_usage_stats
       ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_usage_stats]
         (database_id
         ,object_id
         ,index_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N' Index [ixuc_sys_dm_db_index_usage_stats]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
   END
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_db_index_operational_stats]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start [sys].[dm_db_index_operational_stats]',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_operational_stats]
DECLARE @ssms_ads  TINYINT  = 1
       ,@msg       NVARCHAR(1000)
       ,@exec_dttm DATETIME = GETDATE();
--*/

;WITH newcol AS (-- columns added after SQL Server 2005
SELECT version_generated_off_row         = TRY_CONVERT(BIGINT,NULL) -- SQL 2016+
      ,ghost_version_inrow               = TRY_CONVERT(BIGINT,NULL) -- SQL 2016+
      ,ghost_version_off_row             = TRY_CONVERT(BIGINT,NULL) -- SQL 2016+
      ,insert_over_ghost_version_inrow   = TRY_CONVERT(BIGINT,NULL) -- SQL 2016+
      ,insert_over_ghost_version_off_row = TRY_CONVERT(BIGINT,NULL) -- SQL 2016+
)
SELECT qry.*
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_operational_stats]
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[dm_db_index_operational_stats]
        -- multiple CROSS APPLYs required to avoid error "Aggregates on the right side of an APPLY
        -- cannot reference columns from the left side" referencing  columns from the "newcol" CTE
SELECT ios.database_id
      ,ios.object_id
      ,ios.index_id
      ---------------------------------------------------------------------------------------
      ,partition_CNT                         = COUNT(DISTINCT(ios.partition_number      ))
      ---------------------------------------------------------------------------------------
      ,leaf_insert_CNT                       = SUM(ios.leaf_insert_count                 )
      ,leaf_update_CNT                       = SUM(ios.leaf_update_count                 )
      ,leaf_delete_CNT                       = SUM(ios.leaf_delete_count                 )
      ,leaf_ghost_CNT                        = SUM(ios.leaf_ghost_count                  )
      ----------------------------------
      ,nonleaf_insert_CNT                    = SUM(ios.nonleaf_insert_count              )
      ,nonleaf_delete_CNT                    = SUM(ios.nonleaf_delete_count              )
      ,nonleaf_update_CNT                    = SUM(ios.nonleaf_update_count              )
      ----------------------------------
      ,leaf_allocation_CNT                   = SUM(ios.leaf_allocation_count             ) -- For an index, an allocation is a page split
      ,nonleaf_allocation_CNT                = SUM(ios.nonleaf_allocation_count          ) -- 0 = Heap or columnstore
      ----------------------------------
      ,leaf_page_merge_CNT                   = SUM(ios.leaf_page_merge_count             ) -- 0 = Heap or columnstore
      ,nonleaf_page_merge_CNT                = SUM(ios.nonleaf_page_merge_count          ) -- 0 = Heap or columnstore
      ----------------------------------
      ,range_scan_CNT                        = SUM(ios.range_scan_count                  )
      ,singleton_lookup_CNT                  = SUM(ios.singleton_lookup_count            )
      ,forwarded_fetch_CNT                   = SUM(ios.forwarded_fetch_count             )
      ,lob_fetch_in_pages                    = SUM(ios.lob_fetch_in_pages                )
      ,lob_fetch_in_bytes                    = SUM(ios.lob_fetch_in_bytes                )
      ,lob_orphan_create_CNT                 = SUM(ios.lob_orphan_create_count           )
      ,lob_orphan_insert_CNT                 = SUM(ios.lob_orphan_insert_count           )
      ,row_overflow_fetch_in_pages           = SUM(ios.row_overflow_fetch_in_pages       )
      ,row_overflow_fetch_in_bytes           = SUM(ios.row_overflow_fetch_in_bytes       )
      ,column_value_push_off_row_CNT         = SUM(ios.column_value_push_off_row_count   )
      ,column_value_pull_in_row_CNT          = SUM(ios.column_value_pull_in_row_count    )
      ----------------------------------
      ,row_lock_CNT                          = SUM(ios.row_lock_count                    )
      ,row_lock_wait_CNT                     = SUM(ios.row_lock_wait_count               )
      ,row_lock_wait_MS                      = SUM(ios.row_lock_wait_in_ms               )
      ----------------------------------
      ,page_lock_CNT                         = SUM(ios.page_lock_count                   )
      ,page_lock_wait_CNT                    = SUM(ios.page_lock_wait_count              )
      ,page_lock_wait_MS                     = SUM(ios.page_lock_wait_in_ms              )
      ----------------------------------
      ,lock_promotion_attempt_CNT            = SUM(ios.index_lock_promotion_attempt_count)
      ,lock_promotion_CNT                    = SUM(ios.index_lock_promotion_count        )
      ----------------------------------
      ,page_latch_wait_CNT                   = SUM(ios.page_latch_wait_count             )
      ,tree_page_latch_wait_CNT              = SUM(ios.tree_page_latch_wait_count        )
      ,page_latch_wait_MS                    = SUM(ios.page_latch_wait_in_ms             )
      ,tree_page_latch_wait_MS               = SUM(ios.tree_page_latch_wait_in_ms        ) -- This is always 0 for a heap.
      ,page_io_latch_wait_CNT                = SUM(ios.page_io_latch_wait_count          )
      ,tree_page_io_latch_wait_CNT           = SUM(ios.tree_page_io_latch_wait_count     ) -- This is always 0 for a heap
      ,page_io_latch_wait_MS                 = SUM(ios.page_io_latch_wait_in_ms          )
      ,tree_page_io_latch_wait_MS            = SUM(ios.tree_page_io_latch_wait_in_ms     ) -- This is always 0 for a heap.
      ----------------------------------
      ,page_compression_attempt_CNT          = SUM(ios.page_compression_attempt_count    )
      ,page_compression_success_CNT          = SUM(ios.page_compression_success_count    )
      ----------------------------------
      ,version_generated_off_row_CNT         = SUM(COALESCE(version_generated_off_row          ,0))
      ,ghost_version_inrow_CNT               = SUM(COALESCE(ios.ghost_version_inrow            ,0))
      ,ghost_version_off_row_CNT             = SUM(COALESCE(ghost_version_off_row              ,0))
      ,insert_over_ghost_version_inrow_CNT   = SUM(COALESCE(ios.insert_over_ghost_version_inrow,0))
      ,insert_over_ghost_version_off_row_CNT = SUM(COALESCE(insert_over_ghost_version_off_row  ,0))
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS db
 CROSS
 APPLY (-- required to avoid error "Aggregates on the right side of an APPLY cannot reference columns from the left side" referencing
        -- columns from the "newcol" CTE
        SELECT database_id
              ,object_id
              ,index_id
              ,partition_number
              ,leaf_insert_count
              ,leaf_delete_count
              ,leaf_update_count
              ,leaf_ghost_count
              ,nonleaf_insert_count
              ,nonleaf_delete_count
              ,nonleaf_update_count
              ,leaf_allocation_count
              ,nonleaf_allocation_count
              ,leaf_page_merge_count
              ,nonleaf_page_merge_count
              ,range_scan_count
              ,singleton_lookup_count
              ,forwarded_fetch_count
              ,lob_fetch_in_pages
              ,lob_fetch_in_bytes
              ,lob_orphan_create_count
              ,lob_orphan_insert_count
              ,row_overflow_fetch_in_pages
              ,row_overflow_fetch_in_bytes
              ,column_value_push_off_row_count
              ,column_value_pull_in_row_count
              ,row_lock_count
              ,row_lock_wait_count
              ,row_lock_wait_in_ms
              ,page_lock_count
              ,page_lock_wait_count
              ,page_lock_wait_in_ms
              ,index_lock_promotion_attempt_count
              ,index_lock_promotion_count
              ,page_latch_wait_count
              ,page_latch_wait_in_ms
              ,page_io_latch_wait_count
              ,page_io_latch_wait_in_ms
              ,tree_page_latch_wait_count
              ,tree_page_latch_wait_in_ms
              ,tree_page_io_latch_wait_count
              ,tree_page_io_latch_wait_in_ms
              ,page_compression_attempt_count
              ,page_compression_success_count
              ,version_generated_off_row           -- SQL 2016+
              ,ghost_version_inrow                 -- SQL 2016+
              ,ghost_version_off_row               -- SQL 2016+
              ,insert_over_ghost_version_inrow     -- SQL 2016+
              ,insert_over_ghost_version_off_row   -- SQL 2016+
          FROM [sys].[dm_db_index_operational_stats] (db.database_id,NULL,NULL,NULL)
       ) AS ios
 GROUP BY
       ios.database_id
      ,ios.object_id
      ,ios.index_id
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' [sys].[dm_db_index_operational_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
-- Create index on [SQLXL_Index_sys_dm_db_index_operational_stats]
-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_sys_dm_db_index_operational_stats'
              )
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_sys_dm_db_index_operational_stats
       ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_operational_stats]
         (database_id
         ,object_id
         ,index_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N' Index [ixuc_sys_dm_db_index_operational_stats]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
   END
END

/******************************************************************************************************************************************\
-- Aggregate [sys].[dm_os_buffer_descriptors]
-- NOTE: columns [op_history],[buffer_address],[latch_address] not found in BOL
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start [sys].[dm_os_buffer_descriptors]',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors]
--*/

SELECT bd.database_id
      ,bd.allocation_unit_id
      ,bd.row_CNT
      ,bd.buffer_total_KB
      ,bd.buffer_free_KB
      ,bd.read_microsec_AVG
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors]
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d WITH (READUNCOMMITTED)
  JOIN (-- aggregate columns from [sys].[dm_os_buffer_descriptors]
        SELECT bd.database_id
              ,bd.allocation_unit_id
              ,row_CNT            = SUM(TRY_CAST(COALESCE(bd.row_count,0) AS BIGINT))
              ,buffer_total_KB    = SUM(TRY_CAST(8.0 AS BIGINT))                                         -- each page is 8KB
              ,buffer_free_KB     = SUM(TRY_CAST(COALESCE(bd.free_space_in_bytes,0) AS BIGINT)) / 8192.0 -- 1KB = 8192 bytes
              ,read_microsec_AVG  = AVG(COALESCE(bd.read_microsec,0))
          FROM [sys].[dm_os_buffer_descriptors] AS bd WITH (READUNCOMMITTED)
         GROUP BY
               bd.database_id
              ,bd.allocation_unit_id
       ) AS bd
    ON d.database_id = bd.database_id
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' [sys].[dm_os_buffer_descriptors]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
-- create index on [SQLXL_Index_sys_dm_os_buffer_descriptors]
-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_os_buffer_descriptors')
BEGIN
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_dm_os_buffer_descriptors
       ON [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors]
         (database_id
         ,allocation_unit_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N' Instance Index [ixuc_SQLXL_Index_sys_dm_os_buffer_descriptors]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/*##########################################################################################################################################
############################################################################################################################################
## Loop through requested databases - Collect database-specific information                                                               ##
## Parameter @database_entered above:                                                                                                     ##
##   -- Asterisk ("*") for all databases including system                                                                                 ##
##   -- NULL for all user (non-system) databases                                                                                          ##
##   -- "database name" for a single database                                                                                             ##
##                                                                                                                                        ##
## ***NOTE *** if the DATABASE COMPATIBILITY level is less than 11 (SQL 2012) TRY_CONVERT & TRY_CAST DO NOT WORK!                         ##
##                                                                                                   ------------                         ##
## Omitted Sources & reasons:                                                                                                             ##
## sys dm_exec_function_stats       BOL "does not return information about table valued functions,                                        ##
##                                       and about scalar functions that are inlined with Scalar UDF Inlining"                            ##
## sys dm_db_xtp_hash_index_stats   BOL "useful for understanding and tuning the bucket counts. It can also be used to detect cases       ##
##                                       where the index key has many duplicates. Note - SCANS THE ENTIRE TABLE!"                         ##
############################################################################################################################################
##########################################################################################################################################*/

/******************************************************************************************************************************************\
-- Create local variables & Cursor
-- List of databases to run through was previously filtered when creating [tempdb].[dbo].[SQLXL_Index_sys_databases]
\******************************************************************************************************************************************/
DECLARE db_crsr CURSOR LOCAL FAST_FORWARD FOR
SELECT d.database_id
      ,name          = QUOTENAME(d.name)
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
 WHERE NOT EXISTS (-- do not interrogate replica databases that can't be connected to
                   SELECT 1/0
                     FROM [tempdb].[dbo].[SQLXL_Index_sys_availability_replicas] AS ar
                    WHERE d.replica_id = ar.replica_id
                      AND ar.secondary_role_allow_connections_desc = 'NO'
                  )
   AND NOT EXISTS (-- don't execute on secondary or resolving replicas
                   SELECT 1/0
                     FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states] AS rs
                    WHERE d.replica_id = rs.replica_id
                      AND rs.role_desc IN (N'SECONDARY'
                                          ,N'RESOLVING')
                  )
 ORDER BY
       d.name;

OPEN db_crsr;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' Opened Database cursor'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

WHILE @i > 0 -- On the first database displays the dynamic sql and recreates target tables

/******************************************************************************************************************************************\
 Start of database cursor loop. Collect database-specific information for the one database selected by execution parameter @database_name
   or if no database selected, all user databases.
 List of databases to loop through built above into [tempdb].[dbo].[SQLXL_Index_sys_databases].
 See list of excluded system databases in that script element.
\******************************************************************************************************************************************/
BEGIN
   FETCH NEXT
    FROM db_crsr
    INTO @database_id
        ,@database_name_quoted;

   IF @@Fetch_Status < 0 BREAK;

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N' -- Database: ' + @database_name_quoted
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END

/******************************************************************************************************************************************\
-- Collect [sys].[database_scoped_configurations] - Introduced in SQL 2016
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ProductMajorVersion >= 13  -- SQL 2016+
BEGIN -- SQL 2016+, AZURE
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads  TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations]
--*/

--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT is_value_default = CONVERT(BIT,NULL) -- added SQL 2017
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[database_scoped_configurations]
SELECT database_id         = db_id()
      ,configuration_id
      ,name                = name                                        COLLATE ' + @collation + N' -- nvarchar(60)
      ,value               = CONVERT(NVARCHAR(1000),value              ) COLLATE ' + @collation + N' -- sqlvariant
      ,value_for_secondary = CONVERT(NVARCHAR(1000),value_for_secondary) COLLATE ' + @collation + N' -- sqlvariant
      ,is_value_default                                                                                  -- bit
  FROM [sys].[database_scoped_configurations] -- SQL Server 2016 (13.x) and later
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   BEGIN
      SELECT '[tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations]'
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();
   END

   EXECUTE [sys].[sp_executesql] @sql; IF @@ERROR > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

ELSE  -- version < SQL 2016
BEGIN
   IF @i = 1
   SELECT TOP (0)
          database_id         = @database_id
         ,configuration_id    = CONVERT(INT           ,NULL)
         ,name                = CONVERT(SYSNAME       ,NULL) -- COLLATE not needed, script is running in tempdb
         ,value               = CONVERT(NVARCHAR(1000),NULL) -- COLLATE not needed, script is running in tempdb
         ,value_for_secondary = CONVERT(NVARCHAR(1000),NULL) -- COLLATE not needed, script is running in tempdb
         ,is_value_default    = CONVERT(BIT           ,NULL)
     INTO [tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations];
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[database_scoped_configurations] - SQL 2016+ N'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[database_automatic_tuning_options] - Introduced in SQL 2017
\******************************************************************************************************************************************/
IF @ProductMajorVersion >= 14 -- SQL 2017+
OR @EngineEdition       >   4 -- Azure. Editions restricted above
BEGIN -- SQL 2017+, AZURE
/*** LOCAL TESTING ***
DECLARE @sql       NVARCHAR(MAX)
       ,@i         INT           = 1
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm DATETIME      = GETDATE()
       ,@collation SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]')
    + N'
  FROM (-- columns from [sys].[database_automatic_tuning_options]
        SELECT database_id        = DB_ID()
              ,name               = name               COLLATE ' + @collation + N'
              ,desired_state
              ,desired_state_desc = desired_state_desc COLLATE ' + @collation + N'
              ,actual_state
              ,actual_state_desc  = actual_state_desc  COLLATE ' + @collation + N'
              ,reason
              ,reason_desc        = reason_desc        COLLATE ' + @collation + N'
          FROM [sys].[database_automatic_tuning_options]
       ) AS qry
OPTION (MAXDOP 1);'

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   BEGIN
      SELECT '[tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]'
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();
   END

   EXECUTE [sys].[sp_executesql] @sql; IF @@ERROR > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

ELSE  -- version < SQL 2017
BEGIN
   IF @i = 1
   SELECT TOP (0)
          database_id        = @database_id
         ,name               = CAST(NULL AS NVARCHAR(128)) COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,desired_state      = CAST(NULL AS SMALLINT)
         ,desired_state_desc = CAST(NULL AS NVARCHAR(60))  COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,actual_state       = CAST(NULL AS SMALLINT)
         ,actual_state_desc  = CAST(NULL AS NVARCHAR(60))  COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,reason             = CAST(NULL AS SMALLINT)
         ,reason_desc        = CAST(NULL AS NVARCHAR(60))  COLLATE DATABASE_DEFAULT -- script is running in tempdb
     INTO [tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options];
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[database_automatic_tuning_options] - SQL 2017+ N'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[database_query_store_options] - - Introduced in SQL 2016
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2017+ ----------------------------------------------------------------------------------------
       wait_stats_capture_mode                    = CONVERT(INT           ,NULL)
      ,wait_stats_capture_mode_desc               = CONVERT(NVARCHAR(120) ,NULL) COLLATE ' + @collation + N'
      ,actual_state_additional_info               = CONVERT(NVARCHAR(4000),NULL) COLLATE ' + @collation + N'
       -- SQL 2019+ ----------------------------------------------------------------------------------------
      ,capture_policy_execution_count             = CONVERT(INT           ,NULL)
      ,capture_policy_total_compile_cpu_time_ms   = CONVERT(BIGINT        ,NULL)
      ,capture_policy_total_execution_cpu_time_ms = CONVERT(BIGINT        ,NULL)
      ,capture_policy_stale_threshold_hours       = CONVERT(INT           ,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]')
    + N'
  FROM newcol
 CROSS
 APPLY ('
+IIF(   @ProductMajorVersion >= 13 -- SQL 2016+
     OR SERVERPROPERTY(N'EngineEdition')                       >   4 -- Azure
,N'
SELECT database_id                                = DB_ID()
      ,desired_state                              = desired_state
      ,desired_state_desc                         = desired_state_desc                         COLLATE ' + @collation + N'
      ,actual_state                               = actual_state
      ,actual_state_desc                          = actual_state_desc                          COLLATE ' + @collation + N'
      ,actual_state_additional_info               = actual_state_additional_info               COLLATE ' + @collation + N'
      ,readonly_reason                            = readonly_reason
      ,current_storage_size_mb                    = current_storage_size_mb
      ,flush_interval_seconds                     = flush_interval_seconds
      ,interval_length_minutes                    = interval_length_minutes
      ,max_storage_size_mb                        = max_storage_size_mb
      ,stale_query_threshold_days                 = stale_query_threshold_days
      ,max_plans_per_query                        = max_plans_per_query
      ,query_capture_mode                         = query_capture_mode
      ,query_capture_mode_desc                    = query_capture_mode_desc                    COLLATE ' + @collation + N'
      ,size_based_cleanup_mode                    = size_based_cleanup_mode
      ,size_based_cleanup_mode_desc               = size_based_cleanup_mode_desc               COLLATE ' + @collation + N'
      ,wait_stats_capture_mode                    = wait_stats_capture_mode
      ,wait_stats_capture_mode_desc               = wait_stats_capture_mode_desc               COLLATE ' + @collation + N'
      ,capture_policy_execution_count             = capture_policy_execution_count
      ,capture_policy_total_compile_cpu_time_ms   = capture_policy_total_compile_cpu_time_ms
      ,capture_policy_total_execution_cpu_time_ms = capture_policy_total_execution_cpu_time_ms
      ,capture_policy_stale_threshold_hours       = capture_policy_stale_threshold_hours
  FROM [sys].[database_query_store_options]'
,N'SELECT TOP (0)
       database_id                                = DB_ID()
      ,desired_state                              = CAST(NULL AS SMALLINT)
      ,desired_state_desc                         = CAST(NULL AS NVARCHAR(120))  COLLATE ' + @collation + N'
      ,actual_state                               = CAST(NULL AS SMALLINT)
      ,actual_state_desc                          = CAST(NULL AS NVARCHAR(120))  COLLATE ' + @collation + N'
      ,actual_state_additional_info               = CAST(NULL AS NVARCHAR(4000)) COLLATE ' + @collation + N'
      ,readonly_reason                            = CAST(NULL AS INT)
      ,current_storage_size_mb                    = CAST(NULL AS BIGINT)
      ,flush_interval_seconds                     = CAST(NULL AS BIGINT)
      ,interval_length_minutes                    = CAST(NULL AS BIGINT)
      ,max_storage_size_mb                        = CAST(NULL AS BIGINT)
      ,stale_query_threshold_days                 = CAST(NULL AS BIGINT)
      ,max_plans_per_query                        = CAST(NULL AS BIGINT)
      ,query_capture_mode                         = CAST(NULL AS SMALLINT)
      ,query_capture_mode_desc                    = CAST(NULL AS NVARCHAR(120))  COLLATE ' + @collation + N'
      ,size_based_cleanup_mode                    = CAST(NULL AS SMALLINT)
      ,size_based_cleanup_mode_desc               = CAST(NULL AS NVARCHAR)       COLLATE ' + @collation + N'
      ,wait_stats_capture_mode                    = CAST(NULL AS INT)
      ,wait_stats_capture_mode_desc               = CAST(NULL AS NVARCHAR(120))  COLLATE ' + @collation + N'
      ,capture_policy_execution_count             = CAST(NULL AS INT)
      ,capture_policy_total_compile_cpu_time_ms   = CAST(NULL AS BIGINT)
      ,capture_policy_total_execution_cpu_time_ms = CAST(NULL AS BIGINT)
      ,capture_policy_stale_threshold_hours       = CAST(NULL AS INT)
      ')
+ N') AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
BEGIN
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();
END

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[database_query_store_options] - SQL 2016+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- [cdc].[change_tables] - if Change Data Capture (CDC) enabled for this database
-- FUTURE:
-- BOL: We recommend that you don't query the system tables directly.
--      Instead, execute the [sys] [sp_cdc_help_change_data_capture] stored procedure
--      NOTE: Up to two rows can be returned for each source table, one row for each capture instance.
\******************************************************************************************************************************************/
IF (-- check if Change Data Capture enabled for database. If not DMV [cdc].[change_tables] does not exist
    SELECT is_cdc_enabled
      FROM [tempdb].[dbo].[SQLXL_Index_sys_databases]
     WHERE @database_id = database_id
   ) = 1
BEGIN
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_cdc_change_tables]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_cdc_change_tables]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_cdc_change_tables]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_cdc_change_tables]')
    + N'
  FROM (-- columns from [cdc].[change_tables] if Change Data Capture is enabled on this database
        SELECT database_id          = DB_ID()
              ,object_id
              ,version
              ,source_object_id
              ,capture_instance     = capture_instance COLLATE ' + @collation + N'
              ,supports_net_changes
              ,has_drop_pending
              ,role_name            = role_name        COLLATE ' + @collation + N'
              ,index_name           = index_name       COLLATE ' + @collation + N'
              ,filegroup_name       = filegroup_name   COLLATE ' + @collation + N'
              ,create_date
              ,partition_switch
              ,capture_instance_ID  = ROWNUMBER() OVER (PARTITION BY source_object_id
                                                            ORDER BY create_date      --             1 Change table per source
                                                       )
          FROM [cdc].[change_tables]
       ) AS qry';

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   BEGIN
      SELECT '[tempdb].[dbo].[SQLXL_Index_cdc_change_tables]'
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();
   END

   EXECUTE [sys].[sp_executesql] @sql; IF @@ERROR > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END
END

ELSE  -- change data capture (CDC) NOT enabled on database
BEGIN
   IF @i = 1
   SELECT TOP (0)
          database_id          = @database_id
         ,object_id            = CAST(NULL AS INT)
         ,version              = CAST(NULL AS INT)
         ,source_object_id     = CAST(NULL AS INT)
         ,capture_instance     = CAST(NULL AS SYSNAME)   COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,supports_net_changes = CAST(NULL AS BIT)
         ,has_drop_pending     = CAST(NULL AS BIT)
         ,role_name            = CAST(NULL AS SYSNAME)   COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,index_name           = CAST(NULL AS SYSNAME)   COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,filegroup_name       = CAST(NULL AS SYSNAME)   COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,create_date          = CAST(NULL AS DATETIME)
         ,partition_switch     = CAST(NULL AS BIT)
         ,capture_instance_ID  = CAST(NULL AS INT)
     INTO [tempdb].[dbo].[SQLXL_Index_cdc_change_tables];
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[cdc].[change_tables] (if CDC enabled)'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[schemas]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'[WideWorldImporters]'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_schemas]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_schemas]
--*/
-------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_schemas]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_schemas]')
    + N'
  FROM (-- columns from [sys].[schemas]
SELECT database_id   = DB_ID()
      ,name          = name COLLATE ' + @collation + N'
      ,schema_id
      ,principal_id
  FROM [sys].[schemas] AS s
) AS qry;'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_schemas]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@ERROR > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[schemas]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- Add index to speed up subsequent queries
IF @i = 2 BEGIN -- only execute on second database if more than one
   IF NOT EXISTS (-- check if index already exists for this table. Create if not found
                  SELECT NULL
                    FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                   WHERE name = N'ixuc_SQLXL_Index_sys_schemas'
                 )
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_schemas
       ON [tempdb].[dbo].[SQLXL_Index_sys_schemas]
         (database_id
         ,schema_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N'    ... ' + @database_name_quoted + N' Index [ixuc_SQLXL_Index_sys_schemas]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
 Collect [sys].[tables]
         [cdc].[change_tables] if CDC enabled. NOTE: system table [cdc].[change_tables] captured above

 NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'[WideWorldImporters]'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_tables]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_tables]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2012+ -----------------------------------------------------------------------------
       is_filetable                       = CONVERT(BIT     ,NULL)
       -- SQL 2014+ -----------------------------------------------------------------------------
      ,is_memory_optimized                = CONVERT(BIT     ,NULL)
      ,durability                         = CONVERT(TINYINT ,NULL)
      ,durability_desc                    = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
       -- SQL 2016+ -----------------------------------------------------------------------------
      ,temporal_type                      = CONVERT(TINYINT ,NULL)
      ,temporal_type_desc                 = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,history_table_id                   = CONVERT(INT     ,NULL)
      ,is_remote_data_archive_enabled     = CONVERT(BIT     ,NULL)
      ,is_external                        = CONVERT(BIT     ,NULL)
       -- SQL 2017+ -----------------------------------------------------------------------------
      ,is_node                            = CONVERT(BIT     ,NULL)
      ,is_edge                            = CONVERT(BIT     ,NULL)
       -- SQL 2022+, Azure SQL Database ---------------------------------------------------------
      ,history_retention_period           = CONVERT(INT     ,NULL)
      ,history_retention_period_unit      = CONVERT(INT     ,NULL)
      ,history_retention_period_unit_desc = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,ledger_type                        = CONVERT(TINYINT ,NULL)
      ,ledger_type_desc                   = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,ledger_view_id                     = CONVERT(INT     ,NULL)
      ,is_dropped_ledger_table            = CONVERT(BIT     ,NULL)
       -- If change data capture (CDC) enabled on database --------------------------------------
      ,version                            = CONVERT(INT     ,NULL)
      ,capture_instance                   = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,supports_net_changes               = CONVERT(BIT     ,NULL)
      ,role_name                          = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,index_name                         = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,filegroup_name                     = CONVERT(SYSNAME ,NULL)    COLLATE ' + @collation + N'
      ,create_date                        = CONVERT(DATETIME,NULL)
      ,partition_switch                   = CONVERT(BIT     ,NULL)
      -- Computed above -------------------------------------------------------------------------
      ,capture_instance_ID                = CONVERT(INT     ,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_tables]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_tables]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[tables], [change_tracking_tables]
SELECT database_id                        = DB_ID()
      ,name                               = name                                COLLATE ' + @collation + N'
      ,object_id                          = t.object_id
      ,principal_id
      ,schema_id
      ,type                               = type                                COLLATE ' + @collation + N'
      ,type_desc                          = type_desc                           COLLATE ' + @collation + N'
      ,t.create_date
      ,modify_date
      ,is_ms_shipped
      ,is_published
      ,is_schema_published
      ,lob_data_space_id
      ,filestream_data_space_id
      ,max_column_id_used
      ,lock_on_bulk_load
      ,uses_ansi_nulls
      ,is_replicated
      ,has_replication_filter
      ,is_merge_published
      ,is_sync_tran_subscribed
      ,has_unchecked_assembly_data
      ,text_in_row_limit
      ,large_value_types_out_of_row
      ,is_tracked_by_cdc
      ,lock_escalation
      ,lock_escalation_desc               = lock_escalation_desc                COLLATE ' + @collation + N'
      ,is_filetable
      ,is_memory_optimized
      ,durability
      ,durability_desc                    = durability_desc                     COLLATE ' + @collation + N'
      ,temporal_type
      ,temporal_type_desc                 = temporal_type_desc                  COLLATE ' + @collation + N'
      ,history_table_id
      ,is_remote_data_archive_enabled
      ,is_external
       ------------------------------------------------------------------------------------------------------
      ,is_internal                        = CONVERT(BIT,0)    -- to be used for internal tables below
      ,internal_parent_id                 = CONVERT(INT,NULL) -- to be used for internal tables below
      ,internal_parent_minor_id           = CONVERT(INT,NULL) -- to be used for internal tables below
       ------------------------------------------------------------------------------------------------------
      ,history_retention_period
      ,history_retention_period_unit
      ,history_retention_period_unit_desc = history_retention_period_unit_desc  COLLATE ' + @collation + N'
      ,is_node
      ,is_edge
      ,ledger_type
      ,ledger_type_desc                   = ledger_type_desc                    COLLATE ' + @collation + N'
      ,ledger_view_id
      ,is_dropped_ledger_table
       ------------------------------------------------------------------------------------------------------
       -- [sys].[change_tracking_tables]
       ------------------------------------------------------------------------------------------------------
      ,ctt_is_track_columns_updated_on    = ctt.is_track_columns_updated_on
       ------------------------------------------------------------------------------------------------------
       -- [cdc].[change_tables] (source & target)
       ------------------------------------------------------------------------------------------------------
      ,cdc_capture_instance               = COALESCE(cs.capture_instance,ct.capture_instance) COLLATE ' + @collation + N'
      ,cdc_supports_net_changes           = ct.supports_net_changes
      ,cdc_role_name                      = COALESCE(cs.role_name,ct.role_name)               COLLATE ' + @collation + N'
      ,cdc_index_name                     = cs.index_name                                     COLLATE ' + @collation + N'
      ,cdc_filegroup_name                 = ct.filegroup_name                                 COLLATE ' + @collation + N'
      ,cdc_create_date                    = COALESCE(cs.create_date,ct.create_date)
      ,cdc_partition_switch               = COALESCE(cs.partition_switch,ct.partition_switch)
      ,cdc_is_history_table               = CAST(IIF(t.object_id = ct.object_id,1,0) AS BIT)
  FROM [sys].[tables]                                 AS t

  LEFT OUTER
  JOIN [sys].[change_tracking_tables]                 AS ctt
    ON t.object_id = ctt.object_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_cdc_change_tables] AS cs -- source [tempdb].[dbo].[SQLXL_Index_cdc_change_tables] created above
    ON DB_ID()     = cs.database_id
   AND t.object_id = cs.source_object_id
   AND 1           = cs.capture_instance_ID

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_cdc_change_tables] AS ct -- target [tempdb].[dbo].[SQLXL_Index_cdc_change_tables] created above
    ON DB_ID()     = ct.database_id
   AND t.object_id = ct.object_id
   AND 1           = ct.capture_instance_ID

 WHERE is_external = 0                                      -- <FUTURE> potential acquisition since can have statistics
) AS qry -- from CROSS APPLY
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,FAST 1
       ,MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_tables]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[tables],[cdc].[change_tracking_tables] source & target'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
Collect [sys].[objects]
        [sys].[sql_modules]
        [sys].[internal_tables]
        [sys].[triggers]
        [sys].[table_types]
        [sys].[views]
 Results placed into temp tables - provides much better performance than if all joined together

NOTE: Internal Tables are created as objects of their HISTORY TABLE, BASE TABLE, or (potentially) VIEW parents
      HISTORY tables do not have a parent in [sys].[objects], must be captured from [cdc].[change_tables] or [sys].[tables] as below
      Foreign Key parents are the table they belong to

NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
      https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

DECLARE @database_name_quoted NVARCHAR(MAX) = QUOTENAME(@database_name)

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_objects]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_objects]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
DECLARE @ssms_ads  TINYINT = 1
       ,@msg       NVARCHAR(1000)
       ,@exec_dttm DATETIME      = GETDATE()
       ,@Pattern   NVARCHAR(15)  = ''%[^'' + NChar(9) + NCHAR(10) + NCHAR(13) + NCHAR(32) + '']%'';

-- [sys].[objects] -------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N''#sys_objects'') IS NOT NULL
   DROP TABLE #sys_objects;

SELECT *
  INTO #sys_objects
  FROM [sys].[objects] WITH (READUNCOMMITTED);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N''    ... ' + @database_name_quoted + N'.[sys].[objects]''
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- [sys].[table_types] ---------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N''#sys_table_types'') IS NOT NULL
   DROP TABLE #sys_table_types;
SELECT *
  INTO #sys_table_types
  FROM [sys].[table_types] WITH (READUNCOMMITTED);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N''    ... ' + @database_name_quoted + N'.[sys].[table_types]''
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- [sys].[views] ---------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N''#sys_views'') IS NOT NULL
   DROP TABLE #sys_views;

SELECT *
  INTO #sys_views
  FROM [sys].[views] WITH (READUNCOMMITTED);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N''    ... ' + @database_name_quoted + N'.[sys].[views]''
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- code for table-valued functions and other object candidates for use on filtered indexes and computed columns ----------------------------
BEGIN TRY
   SET LOCK_TIMEOUT 100; -- 100 milliseconds

   SELECT m.object_id
         ,definition = LEFT(STUFF(m.definition,1,ISNULL(NULLIF(PATINDEX(@Pattern,m.definition),0)-1,0),''''),4000)
         ,m.uses_ansi_nulls
         ,m.uses_quoted_identifier
         ,m.is_schema_bound
         ,m.uses_database_collation
         ,m.is_recompiled
         ,m.null_on_null_input
         ,m.execute_as_principal_id
         ,m.uses_native_compilation
         ,m.inline_type
         ,m.is_inlineable
     INTO #sys_sql_modules
     FROM [sys].[sql_modules] AS m WITH (READCOMMITTED,READPAST)
     JOIN #sys_objects        AS o
       ON m.object_id = o.object_id
    WHERE o.type
       IN (--------------------------------------------------------------------------------------------------------------
           -- "Indexable" / orderable objects
           --------------------------------------------------------------------------------------------------------------
           N''F''  -- Foreign Key Constraint
          ,N''FT'' -- Assembly (CLR) table-valued function
          ,N''IF'' -- SQL inline table-valued function
          ,N''TF'' -- SQL table-valued-function            SQL 2012+
          ,N''U''  -- Table (user-defined)
          ,N''V''  -- View
          )

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N''    ... ' + @database_name_quoted + N'.[sys].[sql_modules]''
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END

END TRY
BEGIN CATCH
   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N''    ... *** [sys].[sql_modules] FAILED ***''
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END

END CATCH

--  [sys].[internal_tables] --------------------------------
IF OBJECT_ID(N''#sys_internal_tables'') IS NOT NULL
   DROP TABLE #sys_internal_tables;

SELECT *
  INTO #sys_internal_tables
  FROM [sys].[internal_tables] WITH (READUNCOMMITTED);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N''    ... ' + @database_name_quoted + N'.[sys].[internal_tables]''
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- [sys].[triggers] ----------------------------------------
IF OBJECT_ID(N''#sys_triggers'') IS NOT NULL
   DROP TABLE #sys_triggers;

SELECT *
  INTO #sys_triggers
  FROM [sys].[triggers] WITH (READUNCOMMITTED);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N''    ... ' + @database_name_quoted + N'.[sys].[triggers]''
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect <database>.[sys].[objects]
-- includes columns from [sys].[views],[sql_modules],[internal_tables],[triggers],[table_types] & [cdc].[change_tables]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand''s
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N''           Start ' + @database_name_quoted + N'.[sys].[objects],[views],[sql_modules],[internal_tables],[triggers],[table_types]''
            ,0,0) WITH NOWAIT
   SET @exec_dttm = GETDATE();
END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2014 ----------------------------------------
       is_memory_optimized     = CONVERT(BIT,NULL)
      ,uses_native_compilation = CONVERT(BIT,NULL)
      -- SQL 2019 -----------------------------------------
      ,is_inlineable           = CONVERT(BIT,NULL)
      ,inline_type             = CONVERT(BIT,NULL)
      -- SQL 2022, Azure SQL Database - [sys].[views] -----
      ,ledger_view_type        = CONVERT(TINYINT,NULL)
      ,ledger_view_type_desc   = CONVERT(SYSNAME,NULL)
      ,is_dropped_ledger_view  = CONVERT(BIT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_objects] WITH (TABLOCKX)'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_objects]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[objects],[views],[sql_modules],[internal_tables],[triggers],[table_types] & [cdc].[change_tables]
SELECT database_id      = DB_ID()
      ----------------------------------------------------------
      -- [sys].[objects]
      ----------------------------------------------------------
      ,name             = o.name                          COLLATE ' + @collation + N'
      ,o.object_id
      ,o.principal_id
      ,o.schema_id
      ,history_source_object_id = COALESCE(cct.source_object_id,tht.object_id)

      ,parent_object_id = COALESCE(IIF(o.parent_object_id > 0 -- NOTE: some IT have "SQ" sequence as parent type
                                      ,o.parent_object_id
                                      ,NULL)
                                  ,o.object_id)

      ,type             = CAST(o.type AS NVARCHAR(2))     COLLATE ' + @collation + N'
      ,type_desc        = o.type_desc                     COLLATE ' + @collation + N'
      ,o.create_date
      ,o.modify_date
      ,o.is_ms_shipped
      ,o.is_published
      ,o.is_schema_published
      ----------------------------------------------------------
      -- [sys].[sql_modules]
      ----------------------------------------------------------
      ,definition = CONVERT(NVARCHAR(4000),m.definition)  COLLATE ' + @collation + N' -- LEFT(,4000) APPLIED ABOVE
      ,uses_ansi_nulls
      ,uses_quoted_identifier
      ,is_schema_bound
      ,uses_database_collation
      ,is_recompiled
      ,null_on_null_input
      ,execute_as_principal_id
      ,uses_native_compilation
      ,is_inlineable
      ,inline_type
      ----------------------------------------------------------
      -- [sys].[internal_tables]
      ----------------------------------------------------------
      ,internal_type             = it.internal_type
      ,internal_type_desc        = it.internal_type_desc  COLLATE ' + @collation + N'
      ,parent_id                 = it.parent_id
      ,parent_minor_id           = it.parent_minor_id
      ,lob_data_space_id         = it.lob_data_space_id
      ,filestream_data_space_id  = it.filestream_data_space_id
      ----------------------------------------------------------
      -- [sys].[triggers]
      ----------------------------------------------------------
      ,tr_parent_class           = tr.parent_class
      ,tr_parent_class_desc      = tr.parent_class_desc   COLLATE ' + @collation + N'
      ,tr_parent_id              = tr.parent_id
      ,tr_type                   = tr.type                COLLATE ' + @collation + N'
      ,tr_type_desc              = tr.type_desc           COLLATE ' + @collation + N'
      ,tr_create_date            = tr.create_date
      ,tr_modify_date            = tr.modify_date
      ,tr_is_ms_shipped          = tr.is_ms_shipped
      ,tr_is_disabled            = tr.is_disabled
      ,tr_is_not_for_replication = tr.is_not_for_replication
      ,tr_is_instead_of_trigger  = tr.is_instead_of_trigger
      ----------------------------------------------------------
      -- [sys].[table_types]
      ----------------------------------------------------------
      ,tt_is_memory_optimized    = is_memory_optimized
      ----------------------------------------------------------
      -- [sys].[views]
      ----------------------------------------------------------
      ,vw_is_replicated               = is_replicated
      ,vw_has_replication_filter      = has_replication_filter
      ,vw_has_opaque_metadata         = has_opaque_metadata
      ,vw_has_unchecked_assembly_data = has_unchecked_assembly_data
      ,vw_with_check_option           = with_check_option
      ,vw_is_date_correlation_view    = is_date_correlation_view
      ,vw_ledger_view_type            = ledger_view_type
      ,vw_ledger_view_type_desc       = ledger_view_type_desc
      ,vw_is_dropped_ledger_view      = is_dropped_ledger_view
  FROM (-- filter out objects that we are not interested in
        SELECT *
          FROM #sys_objects AS o WITH (READUNCOMMITTED)
         WHERE (   o.type
                   IN        (--------------------------------------------------------------------------------------------------------------
                              -- "Indexable" / orderable objects
                              --------------------------------------------------------------------------------------------------------------
                              N''F''  -- Foreign Key Constraint
                             ,N''FT'' -- Assembly (CLR) table-valued function
                             ,N''IF'' -- SQL inline table-valued function
                             ,N''TF'' -- SQL table-valued-function            SQL 2012+
                             ,N''U''  -- Table (user-defined)
                             ,N''V''  -- View
                              --------------------------------------------------------------------------------------------------------------
                              -- Other desired data objects
                              --------------------------------------------------------------------------------------------------------------
                             ,N''C''  -- CHECK Constraint
                             ,N''D''  -- DEFAULT (constraint or stand-alone)
                             ,N''EC'' -- EDGE constraint
                             ,N''PK'' -- PRIMARY KEY constraint
                             ,N''SO'' -- SEQUENCE object
                             ,N''UQ'' -- UNIQUE constraint
                              --------------------------------------------------------------------------------------------------------------
                              -- Use to identify check constraints and computed columns using SQL procs & functions in their definitions
                              --------------------------------------------------------------------------------------------------------------
                             ,N''AF'' -- Aggregate function (CLR)
                             ,N''FN'' -- SQL scalar function
                             ,N''FS'' -- Assembly (CLR) scalar-function
                             ,N''P''  -- Procedure
                             ,N''PC'' -- Assembly (CLR) stored-procedure
                             ,N''X''  -- Extended stored procedure
                              --------------------------------------------------------------------------------------------------------------
                              -- Other desired system objects
                              --------------------------------------------------------------------------------------------------------------
                             ,N''TA'' -- Assembly (CLR) DML trigger
                             ,N''TR'' -- SQL DML trigger
                             ,N''TT'' -- Table types, can also be memory optimized
                             )

                OR o.parent_object_id
                   IN (-------------------------------------------------------------------------------------------------------------
                      -- anything connected to one of the desired object types, including Internal Tables (IT)
                      --------------------------------------------------------------------------------------------------------------
                      SELECT object_id
                        FROM #sys_objects
                       WHERE is_ms_shipped = 0
                         AND type
                          IN (--------------------------------------------------------------------------------------------------------------
                              -- "Indexable" / orderable objects
                              --------------------------------------------------------------------------------------------------------------
                              N''F''  -- Foreign Key Constraint
                             ,N''FT'' -- Assembly (CLR) table-valued function
                             ,N''IF'' -- SQL inline table-valued function
                             ,N''TF'' -- SQL table-valued-function            SQL 2012+
                             ,N''U''  -- Table (user-defined)
                             ,N''V''  -- View
                              --------------------------------------------------------------------------------------------------------------
                              -- Other desired data objects
                              --------------------------------------------------------------------------------------------------------------
                             ,N''C''  -- CHECK Constraint
                             ,N''D''  -- DEFAULT (constraint or stand-alone)
                             ,N''EC'' -- EDGE constraint
                             ,N''PK'' -- PRIMARY KEY constraint
                             ,N''SO'' -- SEQUENCE object
                             ,N''UQ'' -- UNIQUE constraint
                              --------------------------------------------------------------------------------------------------------------
                              -- Use to identify check constraints and computed columns using SQL procs & functions in their definitions
                              --------------------------------------------------------------------------------------------------------------
                             ,N''AF'' -- Aggregate function (CLR)
                             ,N''FN'' -- SQL scalar function
                             ,N''FS'' -- Assembly (CLR) scalar-function
                             ,N''P''  -- Procedure
                             ,N''PC'' -- Assembly (CLR) stored-procedure
                             ,N''X''  -- Extended stored procedure
                              --------------------------------------------------------------------------------------------------------------
                              -- Other desired system objects
                              --------------------------------------------------------------------------------------------------------------
                             ,N''TA'' -- Assembly (CLR) DML trigger
                             ,N''TR'' -- SQL DML trigger
                             ,N''TT'' -- Table types, can also be memory optimized
                             )
                      )
                OR o.object_id
                   IN (-- table type objects
                       SELECT type_table_object_id
                         FROM #sys_table_types WITH (READUNCOMMITTED)
                      )'

+ CASE WHEN (-- check for database has change data capture (CDC) enabled
             SELECT is_cdc_enabled
               FROM [tempdb].[dbo].[SQLXL_Index_sys_databases]
              WHERE @database_id = database_id
            ) = 1
       THEN N'
                OR o.object_id
                   IN (-- Change data capture (CDC) "CHANGE" tables
                       SELECT object_id
                         FROM [tempdb].[dbo].[SQLXL_Index_cdc_change_tables] WITH (READUNCOMMITTED)
                        WHERE DB_ID() = database_id
                      )'
       ELSE N''
  END + N'
               ) -- aligns with open parenthesis inmmediately after WHERE
           AND NOT (    o.type    = N''IF''               -- omitting since we cannot do anything to change them
                    AND o.name LIKE N''fn_cdc_get_%''
                   )
           AND NOT (    o.type    = N''U''
                    AND o.name    = N''sysdiagrams''
                   )
       ) AS o

  LEFT OUTER
  JOIN #sys_objects         AS op WITH (READUNCOMMITTED)
    ON o.parent_object_id    = op.object_id

  LEFT OUTER
  JOIN #sys_views           AS vw WITH (READUNCOMMITTED)
    ON o.object_id           = vw.object_id

  LEFT OUTER
  JOIN #sys_sql_modules     AS m WITH (READUNCOMMITTED)
    ON o.object_id           = m.object_id

  LEFT OUTER
  JOIN #sys_internal_tables AS it WITH (READUNCOMMITTED)
    ON o.object_id           = it.object_id

  LEFT OUTER
  JOIN #sys_triggers        AS tr WITH (READUNCOMMITTED)
    ON o.object_id           = tr.object_id

  LEFT OUTER
  JOIN #sys_table_types     AS tt WITH (READUNCOMMITTED)
    ON o.object_id           = tt.type_table_object_id

  LEFT OUTER
  JOIN (-- For Temporal History Tables, get the parent it belongs to
        SELECT database_id
              ,object_id
              ,history_table_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_tables] WITH (READUNCOMMITTED)
         WHERE history_table_id IS NOT NULL
       )                   AS tht
    ON DB_ID()     = tht.database_id
   AND o.object_id = tht.history_table_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_cdc_change_tables] AS cct WITH (READUNCOMMITTED)
    ON DB_ID()     = cct.database_id
   AND o.object_id = cct.object_id
   AND 1           = cct.capture_instance_ID

) AS qry -- from CROSS APPLY
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);';

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_objects]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[objects],[views],[sql_modules],[internal_tables],[triggers],[table_types]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- Add index to speed up subsequent queries
If @I = 1 BEGIN -- only execute on first database
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_objects__object_id
       ON [tempdb].[dbo].[SQLXL_Index_sys_objects]
         (database_id
         ,object_id
         ,parent_object_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N'    ... ' + @database_name_quoted + N' Index [ixuc_SQLXL_Index_sys_objects__object_id]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
 Collect [sys].[data_spaces]
        ,[sys].[filegroups]
        ,[sys].[database_files]
        ,[sys].[partition_schemes]
        ,[sys].[partition_functions]
 NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_data_spaces]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2012 -------------------------------------
       is_system                     = CONVERT(BIT,NULL)
      ,partition_function_is_system  = CONVERT(BIT,NULL)
      -- SQL 2016 --------------------------------------
      ,is_autogrow_all_files         = CONVERT(BIT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[data_spaces],[filegroups],[database_files],[partition_schemes],[partition_functions]
SELECT database_id                        = DB_ID()
      -- sys].[data_spaces] ------------------------------------------
      ,data_space_id                      = ds.data_space_id
      ,data_space_name                    = ds.name                   COLLATE ' + @collation + N'
      ,data_space_type                    = ds.type                   COLLATE ' + @collation + N'
      ,data_space_type_desc               = ds.type_desc              COLLATE ' + @collation + N'
      ,data_space_is_default              = ds.is_default
      ,data_space_is_system               = ds.is_system
      -- [sys].[filegroups] -----------------------------------------
      ,filegroup_guid
      ,filegroup_is_read_only             = fg.is_read_only
      ,filegroup_is_autogrow_all_files    = is_autogrow_all_files
      -- [sys].[database_files] --------------------------------------
      ,file_id                            = df.file_id
      ,file_guid                          = df.file_guid
      ,file_type                          = df.type
      ,file_type_desc                     = df.type_desc              COLLATE ' + @collation + N'
      ,file_logical_filename              = df.name                   COLLATE ' + @collation + N'
      ,file_physical_filename             = df.physical_name          COLLATE ' + @collation + N'
      ,file_state                         = df.state
      ,file_state_desc                    = df.state_desc             COLLATE ' + @collation + N'
      ,file_size_pages                    = df.size
      ,file_max_size_pages                = df.max_size
      ,file_growth                        = df.growth
      ,file_is_percent_growth             = df.is_percent_growth
      -- [sys].[partition_schemes] -----------------------------------
      ,partition_function_id              = ps.function_id
      -- [sys].[partition_functions] ---------------------------------
      ,partition_function_name            = pf.name                   COLLATE ' + @collation + N'
      ,partition_function_type            = pf.type                   COLLATE ' + @collation + N'
      ,partition_function_type_desc       = pf.type_desc              COLLATE ' + @collation + N'
      ,partition_function_fanout          = pf.fanout
      ,partition_function_boundary_value  = CASE pf.boundary_value_on_right
                                                 WHEN 1 THEN N''RIGHT''
                                                 WHEN 0 THEN N''LEFT''
                                                 ELSE NULL
                                            END                       COLLATE ' + @collation + N'
      ,partition_function_is_system       = pf.is_system
      ,partition_function_create_date     = pf.create_date
      ,partition_function_modify_date     = pf.modify_date
  FROM [sys].[data_spaces]         AS ds
  LEFT OUTER
  JOIN [sys].[filegroups]          AS fg
    ON ds.data_space_id = fg.data_space_id
  LEFT OUTER
  JOIN [sys].[database_files]      AS df
    ON ds.data_space_id = df.data_space_id
  LEFT OUTER
  JOIN [sys].[partition_schemes]   AS ps
    ON ds.data_space_id = ps.data_space_id
  LEFT OUTER
  JOIN [sys].[partition_functions] AS pf
    ON ps.function_id   = pf.function_id
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_data_spaces]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[data_spaces],[filegroups],[database_files],[partition_schemes] ,[partition_functions]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[default_constraints] - used below for SEQUENCES, so get it here & reuse below - only grab from source once
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_default_constraints]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_default_constraints]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_default_constraints]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_default_constraints]')
    + N'
  FROM (-- columns from [sys].[default_constraints]
SELECT database_id      = DB_ID()
      ,parent_object_id
      ,object_id
      ,type             = type      COLLATE ' + @collation + N'
      ,type_desc        = type_desc COLLATE ' + @collation + N'
      ,name             = name      COLLATE ' + @collation + N'
      ,parent_column_id
      ,definition       = IIF(LEFT(definition,2) = N''(('' AND RIGHT(definition,2) = N''))''
                             ,REVERSE(STUFF(REVERSE(STUFF(definition,1,1,N'''')),1,1,N''''))
                             ,definition) COLLATE ' + @collation + N'
      ,is_system_named
  FROM [sys].[default_constraints]
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_default_constraints]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[default_constraints]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[types]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_types]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_types];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_types]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_types]')
    + N'
  FROM (-- columns from [sys].[types]
        SELECT database_id       = DB_ID()
              ,name              = name           COLLATE ' + @collation + N'
              ,system_type_id
              ,user_type_id
              ,schema_id
              ,principal_id
              ,max_length
              ,precision
              ,scale
              ,collation_name    = collation_name COLLATE ' + @collation + N'
              ,is_nullable
              ,is_user_defined
              ,is_assembly_type
              ,default_object_id
              ,rule_object_id
              ,is_table_type
          FROM [sys].[types]
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_types]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[types]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
 Collect [sys].[columns]
         [sys].[identity_columns]
         [sys].[computed_columns]
         [sys].[sequences]
         [sys].[dm_sql_referencing_entities]

 NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[columns],[identity_columns],[computed_columns],[sequences],[dm_sql_referencing_entities]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_columns]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_columns];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2016+, Azure SQL Database -------------------------------------------------------
       generated_always_type               = CONVERT(TINYINT,NULL)
      ,generated_always_type_desc          = CONVERT(SYSNAME,NULL)  COLLATE ' + @collation + N'
      ,encryption_type                     = CONVERT(INT    ,NULL)
      ,encryption_type_desc                = CONVERT(SYSNAME,NULL)  COLLATE ' + @collation + N'
      ,encryption_algorithm_name           = CONVERT(SYSNAME,NULL)  COLLATE ' + @collation + N'
      ,column_encryption_key_id            = CONVERT(INT    ,NULL)
      ,column_encryption_key_database_name = CONVERT(SYSNAME,NULL)  COLLATE ' + @collation + N'
       -- SQL 2017+ ---------------------------------------------------------------------------
      ,is_hidden                           = CONVERT(BIT    ,NULL)
      ,is_masked                           = CONVERT(BIT    ,NULL)
      ,graph_type                          = CONVERT(INT    ,NULL)
      ,graph_type_desc                     = CONVERT(SYSNAME,NULL)  COLLATE ' + @collation + N'
      ,last_used_value                     = CONVERT(BIGINT ,NULL)
       -- 2022+, Azure SQL Database -----------------------------------------------------------
      ,is_data_deletion_filter_column      = CONVERT(BIT    ,NULL)
      ,ledger_view_column_type             = CONVERT(TINYINT,NULL)
      ,ledger_view_column_type_desc        = CONVERT(SYSNAME,NULL)  COLLATE ' + @collation + N'
      ,is_dropped_ledger_table_column      = CONVERT(BIT    ,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_columns]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_columns]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[columns],[identity_columns],[computed_columns],[sequences],[dm_sql_referencing_entities]
SELECT database_id             = DB_ID()
      ,object_id               = c.object_id
      ,name                    = c.name                                COLLATE ' + @collation + N'
      ,c.column_id
      ,user_type_name          = t.name
      ,c.system_type_id
      ,c.user_type_id
      ,max_length              = CASE WHEN c.user_type_id IN (231,239) AND c.max_length <> - 1 -- NVARCHAR,NCHAR
                                      THEN c.max_length / 2
                                      WHEN c.user_type_id IN (130,129)                         -- geography,geometry
                                      THEN 22
                                      ELSE c.max_length
                                 END
      ,c.precision
      ,c.scale
      ,collation_name          = c.collation_name                      COLLATE ' + @collation + N'
      ,c.is_nullable
      ,c.is_ansi_padded
      ,c.is_rowguidcol
      ,c.is_identity
      ,c.is_computed
      ,c.is_filestream
      ,c.is_replicated
      ,c.is_non_sql_subscribed
      ,c.is_merge_published
      ,c.is_dts_replicated
      ,c.is_xml_document
      ,c.xml_collection_id
      ,c.default_object_id
      ,c.rule_object_id
      ,c.is_sparse
      ,c.is_column_set
       -- SQL 2016+ ---------------------------------------------------------------
      ,generated_always_type
      ,generated_always_type_desc          = generated_always_type_desc            COLLATE ' + @collation + N'
      ,encryption_type
      ,encryption_type_desc                = encryption_type_desc                  COLLATE ' + @collation + N'
      ,encryption_algorithm_name           = encryption_algorithm_name             COLLATE ' + @collation + N'
      ,column_encryption_key_id
      ,column_encryption_key_database_name = column_encryption_key_database_name   COLLATE ' + @collation + N'
       -- SQL 2017+ --------------------------------------------------------------
      ,is_hidden
      ,is_masked
      ,graph_type
      ,graph_type_desc                     = graph_type_desc                       COLLATE ' + @collation + N'
       -- SQL 2022+, SQL Database ------------------------------------------------
      ,ledger_view_column_type
      ,ledger_view_column_type_desc        = ledger_view_column_type_desc          COLLATE ' + @collation + N'
      ,is_dropped_ledger_table_column
      ,is_data_deletion_filter_column
      ----------------------------------------------------------------
      -- [sys].[identity_columns]
      ----------------------------------------------------------------
      ,seed_value                          = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),id.seed_value)) = 1
                                                 THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),id.seed_value))
                                                 ELSE NULL
                                            END
      ,increment_value                     = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),id.increment_value)) = 1
                                                  THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),id.increment_value))
                                                  ELSE NULL
                                             END
      ,last_value                          = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),id.last_value)) = 1
                                                  THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),id.last_value))
                                                  ELSE NULL
                                             END
      ,id.is_not_for_replication
      ----------------------------------------------------------------
      -- [sys].[computed_columns]
      ----------------------------------------------------------------
      ,definition                          = cc.definition                         COLLATE ' + @collation + N'
      ,uses_database_collation             = COALESCE(cc.uses_database_collation
                                                     ,IIF(  c.collation_name       COLLATE ' + @collation + N'
                                                          = d.collation_name       COLLATE ' + @collation + N'
                                                         ,1
                                                         ,0)
                                                     )
      ,is_persisted                        = cc.is_persisted
      ,uses_sql_proc                       = CAST(COALESCE(cc.uses_sql_proc,0) AS BIT)
      ,uses_sql_ftn                        = CAST(COALESCE(cc.uses_sql_ftn ,0) AS BIT)
      ,uses_sql_mthd                       = CAST(COALESCE(cc.uses_sql_mthd,0) AS BIT)

      ----------------------------------------------------------------
      -- [sys].[sequences] + [sys].[dm_sql_referencing_entities]
      ----------------------------------------------------------------
      ,seq_object_id                       = seq.default_object_id
      ,seq_name                            = seq.name                              COLLATE ' + @collation + N'
      ,seq_start_value                     = seq.start_value
      ,seq_increment                       = seq.increment
      ,seq_system_type_id                  = seq.system_type_id
      ,seq_user_type_id                    = seq.user_type_id
      ,seq_precision                       = seq.precision
      ,seq_scale                           = seq.scale
      ,seq_minimum_value                   = seq.minimum_value
      ,seq_maximum_value                   = seq.maximum_value
      ,seq_is_cycling                      = seq.is_cycling
      ,seq_is_cached                       = seq.is_cached
      ,seq_cache_size                      = seq.cache_size
      ,seq_current_value                   = seq.current_value
      ,seq_is_exhausted                    = seq.is_exhausted
      ,seq_last_used_value                 = seq.last_used_value
  FROM [sys].[columns]                          AS c
 CROSS
  JOIN (-- Get database defined COLLATION
        SELECT collation_name
          FROM [tempdb].[dbo].[SQLXL_Index_sys_databases]
         WHERE DB_ID() = database_id
       )                                        AS d
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
    ON DB_ID()     = o.database_id
   AND c.object_id = o.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_types]   AS t
    ON DB_ID()        = t.database_id
   AND c.user_type_id = t.user_type_id
  LEFT OUTER
  JOIN (-- additional columns only from [sys].[identity_columns]
        -- Required as sub-select since all columns from [sys].[columns] are also included in this DMV
        SELECT object_id
              ,column_id
              ,seed_value
              ,increment_value
              ,last_value
              ,is_not_for_replication
          FROM [sys].[identity_columns]
       ) AS id
    ON c.object_id = id.object_id
   AND c.column_id = id.column_id
  LEFT OUTER
  JOIN (-- columns from [sys].[computed_columns], cross-referenced to code for FUNCTIONs and PROCEDUREs
        SELECT object_id
              ,column_id
              ,definition
              ,uses_database_collation
              ,is_persisted
              ,uses_sql_proc = pf.uses_sql_proc
              ,uses_sql_ftn  = pf.uses_sql_ftn
              ,uses_sql_mthd = CAST(IIF(pf.uses_sql_proc = 1 OR pf.uses_sql_ftn = 1
                                       ,0
                                       ,IIF(CHARINDEX(N''].['',cc.definition COLLATE ' + @collation + N') > 0,1,0)
                                       ) AS BIT)
          FROM [sys].[computed_columns] AS cc
         CROSS
         APPLY (-- look for computed columns using FUNCTIONS or PROCEDURES
                SELECT uses_sql_proc = SUM(IIF(o.type IN (N''FT'' -- Assembly (CLR) stored-procedure
                                                         ,N''P''  -- SQL Stored Procedure
                                                         ,N''PC'' -- Assembly (CLR) stored-procedure
                                                         ,N''X''  -- Extended stored procedure
                                                         )
                                              ,1
                                              ,0))
                      ,uses_sql_ftn  = SUM(IIF(o.type IN (N''AF'' -- Aggregate function (CLR)
                                                         ,N''FN'' -- SQL scalar function
                                                         ,N''FS'' -- Assembly (CLR) scalar-function
                                                         ,N''IF'' -- SQL inline table-valued function (TVF)
                                                         ,N''TF'' -- SQL table-valued-function (TVF)
                                                         )
                                              ,1
                                              ,0))
                      ,uses_sql_mthd = SUM(IIF(o.type IS NULL,1,0))
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS s
                    ON o.database_id = s.database_id
                   AND o.SCHEMA_ID   = s.schema_id
                 WHERE DB_ID()       = o.database_id
                   AND o.type IN (N''AF'' -- Aggregate function (CLR)
                                 ,N''FN'' -- SQL scalar function
                                 ,N''FS'' -- Assembly (CLR) scalar-function
                                 ,N''FT'' -- Assembly (CLR) stored-procedure
                                 ,N''IF'' -- SQL inline table-valued function (TVF)
                                 ,N''P''  -- SQL Stored Procedure
                                 ,N''PC'' -- Assembly (CLR) stored-procedure
                                 ,N''TF'' -- SQL table-valued-function (TVF)
                                 ,N''X''  -- Extended stored procedure
                                 )
                   AND CHARINDEX(QUOTENAME(s.name) + N''.'' + QUOTENAME(o.name) COLLATE ' + @collation + N'
                                ,cc.definition COLLATE ' + @collation + N') > 0
               ) AS pf
       ) AS cc
    ON c.object_id = cc.object_id
   AND c.column_id = cc.column_id
  LEFT OUTER
  JOIN (-- look up the SEQUENCES that columns are DEFAULTED to
        SELECT default_object_id = sre.referencing_id
              ,name              = seq.name
              ,start_value       = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),seq.start_value)) = 1
                                        THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),seq.start_value)) -- stored in source table as SQL_VARIANT
                                        ELSE NULL
                                   END
              ,increment         = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),seq.increment)) = 1
                                        THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),seq.increment)) -- stored in source table as SQL_VARIANT
                                        ELSE NULL
                                   END
              ,system_type_id    = seq.system_type_id
              ,user_type_id      = seq.user_type_id
              ,precision         = seq.precision
              ,scale             = seq.scale
              ,minimum_value     = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),seq.minimum_value)) = 1
                                        THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),seq.minimum_value)) -- stored in source table as SQL_VARIANT
                                        ELSE NULL
                                   END
              ,maximum_value     = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),seq.maximum_value)) = 1
                                        THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),seq.maximum_value)) -- stored in source table as SQL_VARIANT
                                        ELSE NULL
                                   END
              ,is_cycling        = seq.is_cycling
              ,is_cached         = seq.is_cached
              ,cache_size        = seq.cache_size
              ,current_value     = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),seq.current_value)) = 1
                                        THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),seq.current_value)) -- stored in source table as SQL_VARIANT
                                        ELSE NULL
                                   END
              ,is_exhausted      = seq.is_exhausted
              ,last_used_value   = CASE WHEN ISNUMERIC(CONVERT(NVARCHAR(20),seq.last_used_value)) = 1
                                        THEN CONVERT(BIGINT,CONVERT(NVARCHAR(20),seq.last_used_value)) -- stored in source table as SQL_VARIANT
                                        ELSE NULL
                                   END
          FROM [sys].[sequences]                    AS seq
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS s
            ON DB_ID()                           = s.database_id
           AND seq.schema_id                     = s.schema_id
         CROSS
         APPLY [sys].[dm_sql_referencing_entities] (s.name + ''.'' + seq.name,N''OBJECT'') sre
       ) AS seq
    ON c.default_object_id = seq.default_object_id
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_columns]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[columns],[identity_columns],[computed_columns],[sequences],[dm_sql_referencing_entities]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[column_type_usages]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_column_type_usages]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_column_type_usages]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_column_type_usages]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_column_type_usages]')
    + N'
  FROM (-- columns from [sys].[column_type_usages]
SELECT database_id = DB_ID()
      ,object_id
      ,column_id
      ,user_type_id
  FROM [sys].[column_type_usages]
) AS qry;'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_column_type_usages]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[column_type_usages]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Add Internal Tables to [sys].[tables] collection in SQLXL_Index_sys_tables - used for downstream data compilation
-- NOTE: Internal Tables not found in [sys].[tables]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @database_id INT = DB_ID(N'WideWorldImporters')
       ,@ssms_ads    BIT = 1
--*/

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_sys_tables]
      (database_id
      ,object_id
      ,schema_id
      ,name
      ,type
      ,type_desc
      ,create_date
      ,modify_date
      ,lob_data_space_id
      ,filestream_data_space_id
      ,is_ms_shipped
      ,is_published
      ,is_schema_published
      ,uses_ansi_nulls
       ------------------------------------------------------------------------------------------------------
      ,is_internal
      ,internal_parent_id
      ,internal_parent_minor_id
       ------------------------------------------------------------------------------------------------------
      ,is_external
      ,max_column_id_used
      ,lock_on_bulk_load
      ,has_unchecked_assembly_data
      )
/*** LOCAL TESTING ***
DECLARE @database_id INT = DB_ID(N'WideWorldImporters')
       ,@ssms_ads    BIT = 1
--*/
SELECT database_id = @database_id
      ,o.object_id
      ,o.schema_id
      ,o.name
      ,o.type
      ,o.type_desc
      ,o.create_date
      ,o.modify_date
      ,o.lob_data_space_id
      ,o.filestream_data_space_id
      ,o.is_ms_shipped
      ,o.is_published
      ,o.is_schema_published
      ,o.uses_ansi_nulls
       ------------------------------------------------------------------------------------------------------
      ,is_internal                 = 1
      ,o.parent_id
      ,o.parent_minor_id
       ------------------------------------------------------------------------------------------------------
      ,is_external                 = 0
      ,max_column_id_used          = c.max_column_id_used
      ,lock_on_bulk_load           = 0
      ,has_unchecked_assembly_data = 0
  FROM [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
  JOIN (-- Get count of columns used in object
        SELECT database_id
              ,object_id
              ,max_column_id_used = MAX(column_id)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]
         WHERE @database_id = database_id
         GROUP BY
               database_id
              ,object_id
       ) AS c
    ON o.database_id = c.database_id
   AND o.object_id   = c.object_id
 WHERE @database_id  = o.database_id
   AND N'IT'         = o.type;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N' Add System Internal Tables to [SQLXL_Index_sys_tables]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[check_constraints]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_check_constraints]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_check_constraints]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_check_constraints]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_check_constraints]')
    + N'
  FROM (-- columns from [sys].[check_constraints]
SELECT database_id             = DB_ID()
      ,parent_object_id
      ,object_id
      ,type                    = type      COLLATE ' + @collation + N'
      ,type_desc               = type_desc COLLATE ' + @collation + N'
      ,name                    = name      COLLATE ' + @collation + N'
      ,parent_column_id
      ,definition              = IIF(LEFT(definition,2) = N''(('' AND RIGHT(definition,2) = N''))''
                                    ,REVERSE(STUFF(REVERSE(STUFF(definition,1,1,N'''')),1,1,N''''))
                                    ,definition) COLLATE ' + @collation + N'
      ,is_disabled
      ,is_not_for_replication
      ,is_not_trusted
      ,uses_database_collation
      ,is_system_named
      ,uses_sql_proc           = CAST(COALESCE(pf.uses_sql_proc,0) AS BIT)
      ,uses_sql_ftn            = CAST(COALESCE(pf.uses_sql_ftn ,0) AS BIT)
      ,uses_sql_mthd           = CAST(IIF(pf.uses_sql_proc = 1 OR pf.uses_sql_ftn = 1
                                     ,0
                                     ,IIF(CHARINDEX(N''].['',cc.definition COLLATE ' + @collation + N') > 0,1,0)) AS BIT)
  FROM [sys].[check_constraints] AS cc
 OUTER
 APPLY (-- checks if any of the constraints uses a function or stored procedure
        SELECT uses_sql_proc = MAX(IIF(o.type IN (N''P'',N''PC''),1,0))
              ,uses_sql_ftn  = MAX(IIF(o.type IN (N''AF'',N''FN'',N''FS''),1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS s
            ON o.database_id = s.database_id
           AND o.schema_id   = s.schema_id
         WHERE DB_ID()       = o.database_id
           AND o.type IN (-- SQL Server objects
                          N''AF'' -- Aggregate function (CLR)
                         ,N''FN'' -- SQL scalar function
                         ,N''FS'' -- Assembly (CLR) scalar-function
                         ,N''P''  -- SQL Stored Procedure
                         ,N''PC'' -- Assembly (CLR) stored-procedure
                         -- User objects
                         ,N''FN'' -- SQL scalar function
                         ,N''FT'' -- Assembly (CLR) stored-procedure
                         ,N''IF'' -- SQL inline table-valued function (TVF)
                         ,N''TF'' -- SQL table-valued-function (TVF)

                         )
           AND CHARINDEX(QUOTENAME(s.name) + N''.'' + QUOTENAME(o.name) COLLATE ' + @collation + N'
                        ,cc.definition COLLATE ' + @collation + N') > 0
       ) AS pf
) AS qry -- from OUTER_APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_check_constraints]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[check_constraints]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[key_constraints]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_key_constraints]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_key_constraints]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT is_enforced = CONVERT(BIT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_key_constraints]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_key_constraints]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[key_constraints]
SELECT database_id      = DB_ID()
      ,parent_object_id
      ,object_id
      ,type             = type      COLLATE ' + @collation + N'
      ,type_desc        = type_desc COLLATE ' + @collation + N'
      ,name             = name      COLLATE ' + @collation + N'
      ,unique_index_id
      ,is_system_named
      ,is_enforced
  FROM [sys].[key_constraints] AS c
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_key_constraints]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[key_constraints]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[edge_constraints] - Introduced in SQL 2019
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]
--*/
IF @ProductMajorVersion >= 15 -- SQL 2019+
BEGIN
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]')
    + N'
  FROM (-- columns from [sys].[edge_constraints]
SELECT database_id      = DB_ID()
      ,parent_object_id
      ,object_id
      ,index_id         = object_id
      ,type             = type      COLLATE ' + @collation + N'
      ,type_desc        = type_desc COLLATE ' + @collation + N'
      ,name             = name      COLLATE ' + @collation + N'
      ,is_disabled
      ,is_not_trusted
      ,delete_referential_action
      ,delete_referential_action_desc = delete_referential_action_desc COLLATE ' + @collation + N'
      ,is_system_named
  FROM [sys].[edge_constraints]
) AS qry
OPTION (MAXDOP 1);'

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   BEGIN
      SELECT '[tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]'
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();
   END

   EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

ELSE  -- version < SQL 2019
BEGIN
   IF @i = 1
   SELECT TOP (0)
          database_id                    = @database_id
         ,parent_object_id               = CONVERT(INT    ,NULL)
         ,object_id                      = CONVERT(INT    ,NULL)
         ,index_id                       = CONVERT(INT    ,NULL)
         ,type                           = CONVERT(TINYINT,NULL)
         ,type_desc                      = CONVERT(SYSNAME,NULL)
         ,name                           = CONVERT(SYSNAME,NULL)
         ,is_disabled                    = CONVERT(BIT    ,NULL)
         ,is_not_trusted                 = CONVERT(BIT    ,NULL)
         ,delete_referential_action      = CONVERT(TINYINT,NULL)
         ,delete_referential_action_desc = CONVERT(SYSNAME,NULL)
         ,is_system_named                = CONVERT(BIT    ,NULL)
     INTO [tempdb].[dbo].[SQLXL_Index_sys_edge_constraints];
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[edge_constraints] - SQL 2019+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[edge_constraint_clauses] - Introduced in SQL 2019
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]
--*/
IF @ProductMajorVersion >= 15 -- SQL 2019+
BEGIN
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]')
    + N'
  FROM (-- columns from [sys].[edge_constraint_clauses]
SELECT database_id             = DB_ID()
      ,object_id
      ,from_object_id
      ,to_object_id
      ,clause_number
  FROM [sys].[edge_constraint_clauses]
) AS qry
OPTION (MAXDOP 1);'

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   BEGIN
      SELECT '[tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]'
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();
   END

   EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

ELSE  -- version < SQL 2019
BEGIN
   IF @i = 1
   SELECT TOP (0)
          database_id    = @database_id
         ,object_id      = CONVERT(INT,NULL)
         ,from_object_id = CONVERT(INT,NULL)
         ,to_object_id   = CONVERT(INT,NULL)
         ,clause_number  = CONVERT(INT,NULL)
     INTO [tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses];
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[edge_constraint_clauses] - SQL 2019+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
 Collect [sys].[indexes]
         [sys].[spatial_indexes]
         [sys].[spatial_index_tessellations]
         [sys].[xml_indexes]
         [sys].[hash_indexes] Introduced in SQL 2014. supported only on In-Memory OLTP (In-Memory Optimization).

 NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_indexes]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_indexes];
--*/
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2016+ --------------------------------------
       compression_delay               = CONVERT(INT,NULL)
       -- SQL 2017+ --------------------------------------
      ,is_ignored_in_optimization      = CONVERT(BIT,NULL)
      ,suppress_dup_key_messages       = CONVERT(BIT,NULL)
       -- SQL 2019+ --------------------------------------
      ,optimize_for_sequential_key     = CONVERT(BIT,NULL)
       -- Azure SQL Database -----------------------------
      ,auto_created                    = CONVERT(BIT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_indexes]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_indexes]')

+N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[indexes],[spatial_indexes],[spatial_index_tessellations],[xml_indexes],[hash_indexes]
SELECT database_id                     = DB_ID()
      ,object_id                       = i.object_id
      ,name                            = i.name                               COLLATE ' + @collation + N'
      ,i.index_id
      ,type                            = CAST(i.type AS NVARCHAR(2))          COLLATE ' + @collation + N'
      ,type_desc                       = i.type_desc                          COLLATE ' + @collation + N'
      ,i.is_unique
      ,i.data_space_id
      ,i.ignore_dup_key
      ,i.is_primary_key
      ,i.is_unique_constraint
      ,i.fill_factor
      ,i.is_padded
      ,i.is_disabled
      ,i.is_hypothetical
      ,i.allow_row_locks
      ,i.allow_page_locks
      ,i.has_filter
      ,filter_definition               = i.filter_definition                  COLLATE ' + @collation + N'
      ,compression_delay
      ,is_ignored_in_optimization
      ,suppress_dup_key_messages
      ,auto_created
      ,optimize_for_sequential_key
      -----------------------------------------------------------------
      ,sub_type                        = COALESCE(si.spatial_index_type     ,xi.xml_index_type            )
      ,sub_type_desc                   = COALESCE(si.spatial_index_type_desc,xi.xml_index_type_description) COLLATE ' + @collation + N'
      -----------------------------------------------------------------
      ,si_tessellation_scheme          = si.tessellation_scheme              COLLATE ' + @collation + N'
      ,si_bounding_box_xmin            = st.bounding_box_xmin
      ,si_bounding_box_ymin            = st.bounding_box_ymin
      ,si_bounding_box_xmax            = st.bounding_box_xmax
      ,si_bounding_box_ymax            = st.bounding_box_ymax
      ,si_level_1_grid_desc            = st.level_1_grid_desc                COLLATE ' + @collation + N'
      ,si_level_2_grid_desc            = st.level_2_grid_desc                COLLATE ' + @collation + N'
      ,si_level_3_grid_desc            = st.level_3_grid_desc                COLLATE ' + @collation + N'
      ,si_level_4_grid_desc            = st.level_4_grid_desc                COLLATE ' + @collation + N'
      ,si_cells_per_object             = st.cells_per_object
      -----------------------------------------------------------------
      ,xml_index_type                  = xi.xml_index_type
      ,xml_index_type_description      = xi.xml_index_type_description       COLLATE ' + @collation + N'
      ,xml_using_xml_index_id          = xi.using_xml_index_id
      ,xml_secondary_type              = xi.secondary_type                   COLLATE ' + @collation + N'
      ,xml_secondary_type_desc         = xi.secondary_type_desc              COLLATE ' + @collation + N'
      ,xml_path_id                     = xi.path_id -- NULL for all XML indexes except secondary selective XML index.
                                                    -- Else, the ID of the promoted path over which the secondary selective XML index
                                                    -- is built. This value is the same value AS path_id from
                                                    -- sys selective_xml_index_paths system view.
      -----------------------------------------------------------------
      ,hi_bucket_CNT                   = ' + IIF(@ProductMajorVersion >= 12 -- SQL 2014+
                                                ,N'bucket_count'
                                                ,N'CONVERT(INT,NULL)')

+N'
  FROM [sys].[indexes]                          AS i
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o -- filters out SYSTEM objects
    ON DB_ID()     = o.database_id
   AND i.object_id = o.object_id
  LEFT OUTER
  JOIN (-- columns from [sys].[spatial_indexes]. required since DMV includes columns from [SYS].[INDEXES]
        SELECT object_id
              ,index_id
              ,spatial_index_type
              ,spatial_index_type_desc
              ,tessellation_scheme
          FROM [sys].[spatial_indexes]
       )          AS si
    ON i.object_id = si.object_id
   AND i.index_id  = si.index_id
  LEFT OUTER
  JOIN (-- columns from [sys].[spatial_index_tessellations]
        SELECT object_id
              ,index_id
              ,tessellation_scheme
              ,bounding_box_xmin
              ,bounding_box_ymin
              ,bounding_box_xmax
              ,bounding_box_ymax
              ,level_1_grid_desc
              ,level_2_grid_desc
              ,level_3_grid_desc
              ,level_4_grid_desc
              ,cells_per_object
          FROM [sys].[spatial_index_tessellations]
       )          AS st
    ON i.object_id = st.object_id
   AND i.index_id  = st.index_id
  LEFT OUTER
  JOIN (-- columns from [sys].[xml_indexes]. subquery required since DMV includes columns from [SYS].[INDEXES]
        SELECT object_id
              ,index_id
              ,using_xml_index_id
              ,secondary_type
              ,secondary_type_desc
              ,xml_index_type
              ,xml_index_type_description
              ,path_id
          FROM [sys].[xml_indexes] WITH (READUNCOMMITTED)
       )           AS xi
    ON i.object_id  = xi.object_id
   AND i.index_id   = xi.index_id'

+IIF(@ProductMajorVersion >= 12 -- SQL 2014+
    ,N'
  LEFT OUTER
  JOIN (-- columns from [sys].[hash_indexes]. subquery required since DMV includes columns from [SYS].[INDEXES]
        SELECT object_id
              ,index_id
              ,type
              ,bucket_count
          FROM [sys].[hash_indexes]
       )          AS hi
    ON i.object_id = hi.object_id
   AND i.index_id  = hi.index_id
   AND i.type      = hi.type'
  ,N'')

+N'
) AS qry -- from CROSS APPLY
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_indexes]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[indexes],[spatial_indexes],[spatial_index_tessellations],[xml_indexes],[hash_indexes] (2014+)'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- Add index to speed up subsequent queries
IF @i = 1 BEGIN -- only execute on first database
   IF NOT EXISTS (-- check if index already exists for this table. Create if not found
                  SELECT NULL
                    FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                   WHERE name = N'ixuc_SQLXL_Index_sys_indexes'
                 )
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_indexes
       ON [tempdb].[dbo].[SQLXL_Index_sys_indexes]
         (database_id
         ,object_id
         ,index_id
         ,type
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N'    ... ' + @database_name_quoted + N' Index [ixuc_SQLXL_Index_sys_indexes]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END

END

/******************************************************************************************************************************************\
 Collect [sys].[fulltext_indexes]
         [sys].[fulltext_catalogs]

NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
      https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/

NOTE: The “incremental_timestamp” column in sys.fulltext_indexes is stored as a binary data type, which represents a rowversion
      (also known as timestamp). However, it’s important to note that this rowversion is not related to date and time; it’s merely an
      incrementing number used for version-stamping table rows. It does not preserve a date or time.
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT property_list_id = CONVERT(INT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[fulltext_indexes],[fulltext_catalogs]
SELECT database_id                = DB_ID()
      -- [sys].[fulltext_indexes] -----------------------------------------------------------
      ,object_id                  = fi.object_id
      ,unique_index_id
      ,fulltext_catalog_id        = fi.fulltext_catalog_id
      ,is_enabled
      ,change_tracking_state      = change_tracking_state      COLLATE ' + @collation + N'
      ,change_tracking_state_desc = change_tracking_state_desc COLLATE ' + @collation + N'
      ,has_crawl_completed
      ,crawl_type                 = crawl_type                 COLLATE ' + @collation + N'
      ,crawl_type_desc            = crawl_type_desc            COLLATE ' + @collation + N'
      ,crawl_start_date
      ,crawl_end_date
--    ,incremental_timestamp -- OMITTED. binary data type, which represents a rowversion
      ,stoplist_id
      ,data_space_id              = fi.data_space_ID
      ,property_list_id
      -- [sys].[fulltext_catalogs] ----------------------------------------------------------
      ,name                       = fc.name COLLATE ' + @collation + N'
      ,is_default
      ,is_accent_sensitivity_on
      ,principal_id
      ,is_importing
  FROM [sys].[fulltext_indexes]  AS fi WITH (READUNCOMMITTED)
  LEFT OUTER
  JOIN [sys].[fulltext_catalogs] AS fc WITH (READUNCOMMITTED)
    ON fi.fulltext_catalog_id     = fc.fulltext_catalog_id
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[fulltext_indexes]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[foreign_keys]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]')
    + N'
  FROM (-- columns from sys].[foreign_keys]
SELECT database_id = DB_ID()
      ,parent_object_id
      ,object_id
      ,name                           = name                           COLLATE ' + @collation + N'
      ,principal_id
      ,schema_id
      ,type                           = type                           COLLATE ' + @collation + N'
      ,type_desc                      = type_desc                      COLLATE ' + @collation + N'
      ,create_date
      ,modify_date
      ,is_ms_shipped
      ,is_published
      ,is_schema_published
      ,referenced_object_id
      ,key_index_id
      ,is_disabled
      ,is_not_for_replication
      ,is_not_trusted
      ,delete_referential_action
      ,delete_referential_action_desc = delete_referential_action_desc COLLATE ' + @collation + N'
      ,update_referential_action
      ,update_referential_action_desc = update_referential_action_desc COLLATE ' + @collation + N'
      ,is_system_named
  FROM [sys].[foreign_keys]
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[foreign_keys]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[foreign_key_columns]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]')
    + N'
  FROM (-- columns from [sys].[foreign_key_columns]
SELECT database_id = DB_ID()
      ,constraint_object_id
      ,constraint_column_id
      ,parent_object_id
      ,parent_column_id
      ,referenced_object_id
      ,referenced_column_id
  FROM [sys].[foreign_key_columns]
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[foreign_key_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[index_columns]
-- NOTE: will contain column list for "index" objects with columns - indexes, fulltext indexes, missing indexes, Foreign Key Constraints
-- NOTE: Used to drive the list of columns to get statistics details for the cursored routine below
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_index_columns]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_index_columns];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT column_store_order_ordinal = CONVERT(INT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_index_columns]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_index_columns]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- get list of all columns across all "index" objects with "columns"
SELECT database_id                = DB_ID()
      ,object_id                  = ic.object_id
      ,ic.index_id
      ,type                       = CAST(i.type AS NVARCHAR(2)) COLLATE ' + @collation + N'
      ,ic.index_column_id
      ,ic.column_id
      ,ic.key_ordinal
      ,ic.partition_ordinal
      ,ic.is_descending_key
      ,ic.is_included_column
      ,column_store_order_ordinal
      -- added control elements -----------------------------------
      ,key_column_sequence = IIF(ic.index_id = 1,ic.key_ordinal,ic.index_column_id) -- matches up key sequence with STATS column order
      -- For Missing index ----------------------------------------
      ,column_usage        = CAST(NULL AS NVARCHAR(40))  COLLATE ' + @collation + N' -- also used for Missing index column usage
      -- For FULLTEXT ---------------------------------------------
      ,type_column_id             = CAST(NULL AS INT)         -- fulltext, stores the user-supplied document file extension
      ,language_id                = CAST(NULL AS INT)         -- fulltext, LCID of language whose word breaker is used to index this column.
      ,statistical_semantics      = CAST(NULL AS BIT)         -- fulltext, statistical semantics enabled in addition to full-text indexing
      -- To flag columns from the CLUSTERED index to avoid key synergies (same sequence, overlaps, contained index key elements)
      ,in_Clustered_index         = CAST(0 AS BIT)
      -- To flag index columns included in filter definitions
      ,is_index_column_filtered   = CAST(0 AS BIT)
  FROM (-- columns from [sys].[index_columns],sys.[function_order_columns]
        SELECT object_id                 = ic.object_id
              ,ic.index_id
              ,type                      = CONVERT(NVARCHAR(2),NULL) COLLATE ' + @collation + N'
              ,column_id
              ,index_column_id
              ,key_ordinal
              ,is_descending_key
              ,partition_ordinal
              ,column_store_order_ordinal
              ,is_included_column
          FROM [sys].[index_columns]                    AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
            ON DB_ID()                           = o.database_id
           AND ic.object_id                      = o.object_id

        UNION -- Table Valued Function Columns - "FT" Assembly (CLR) table-valued function
        SELECT object_id                  = c.object_id
              ,index_id                   = c.object_id
              ,type                       = o.type
              ,c.column_id
              ,index_column_id            = foc.order_column_id
              ,key_ordinal                = foc.order_column_id
              ,is_descending_key          = foc.is_descending
              ,partition_ordinal          = 0
              ,column_store_order_ordinal = 0
              ,is_included_column         = 0
          FROM [sys].[function_order_columns]           AS foc -- Returns one row per column that is a part of an ORDER expression
                                                               -- of a common language runtime (CLR) table-valued function.
                                                               -- From source object directly, only used once
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
            ON DB_ID()       = c.database_id
           AND foc.object_id = c.object_id
           AND foc.column_id = c.column_id
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
            ON c.database_id = o.database_id
           AND c.object_id   = o.object_id
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS s
            ON o.database_id = s.database_id
           AND o.schema_id   = s.schema_id
      ) AS ic
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes] AS i
    ON DB_ID()      = i.database_id
   AND ic.object_id = i.object_id
   AND ic.index_id  = i.index_id
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_index_columns]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[index_columns],[function_order_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Add index columns for additional index objects - missing indexes, fulltext indexes
-- NOTE: Foreign Key Constraints and table functions handled separately
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT statistical_semantics = CONVERT(INT,NULL)
)
INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_index_columns]
      (database_id
      ,object_id
      ,index_id
      ,type
      ,index_column_id
      ,column_id
      ,key_ordinal
      ,partition_ordinal
      ,is_descending_key
      ,is_included_column
      ,key_column_sequence
      ,column_usage
      ,type_column_id
      ,language_id
      ,statistical_semantics
      ,column_store_order_ordinal
      )
SELECT database_id                = DB_ID()
      ,object_id
      ,index_id
      ,type
      ,index_column_id
      ,column_id
      ,key_ordinal
      ,partition_ordinal          = 0
      ,is_descending_key
      ,is_included_column         = IIF(column_usage = N''INCLUDE'',1,0)
      ,key_column_sequence        = index_column_id
      ,column_usage
      ,type_column_id
      ,language_id
      ,statistical_semantics
      ,column_store_order_ordinal = 0
  FROM (-- Missing index Columns - also used to get list of columns to get statistics for
        SELECT type                       = N''M''
              ,object_id                  = object_id
              ,index_id                   = index_handle
              ,index_column_id            = 0
              ,column_id                  = column_id
              ,key_ordinal                = 0
              ,is_descending_key          = NULL
              ,column_usage               = column_usage
              ,type_column_id             = NULL
              ,language_id                = NULL
              ,statistical_semantics      = NULL
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_columns]
         WHERE DB_ID() = database_id
        UNION ALL -- fulltext_index_columns - also used to get list of columns to get statistics for
        SELECT type                       = N''90''
              ,object_id                  = object_id
              ,index_id                   = object_id
              ,index_column_id            = 0
              ,column_id                  = column_id
              ,key_ordinal                = 0
              ,is_descending_key          = NULL
              ,column_usage               = NULL
              ,type_column_id             = type_column_id
              ,language_id                = language_id
              ,statistical_semantics
          FROM [sys].[fulltext_index_columns] -- from SYS object directly, only used once
       ) i
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_index_columns] - insert Missing & FUllText index columns'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N' Added Missing Index Columns,[fulltext_index_columns] to [SQLXL_Index_sys_index_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- Add index to speed up subsequent queries
IF @i = 1 BEGIN -- only execute on first database if more than one
   IF NOT EXISTS (-- check if index already exists for this table. Create if not found
                  SELECT NULL
                    FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                   WHERE name = N'ixuc_SQLXL_Index_sys_index_columns'
                 )
   CREATE UNIQUE CLUSTERED
    INDEX ixuc_SQLXL_Index_sys_index_columns
       ON [tempdb].[dbo].[SQLXL_Index_sys_index_columns]
         (database_id
         ,object_id
         ,index_id
         ,type
         ,column_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N'    ... ' + @database_name_quoted + N' Index [ixuc_SQLXL_Index_sys_index_columns]'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
-- Collect [sys].[extended_properties]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_extended_properties]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_extended_properties];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_extended_properties]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_extended_properties]')
    + N'
  FROM (-- columns from [sys].[extended_properties]
SELECT database_id = DB_ID()
      ,class
      ,class_desc = class_desc                    COLLATE ' + @collation + N'
      ,major_id
      ,minor_id
      ,name       = name                          COLLATE ' + @collation + N'
      ,value      = CONVERT(NVARCHAR(4000),value) COLLATE ' + @collation + N' -- NOTE: is type SQL_VARIANT
  FROM [sys].[extended_properties]
 WHERE CHARINDEX(N''MS_DiagramPane'',name) = 0
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_extended_properties]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[extended_properties]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[stats]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_stats]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_stats];
--*/

--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2012 --------------------------------------------------------------------
       is_temporary                 = CONVERT(BIT    ,NULL)
       -- SQL 2014 --------------------------------------------------------------------
      ,is_incremental               = CONVERT(BIT    ,NULL)
       -- SQL 2019 --------------------------------------------------------------------
      ,has_persisted_sample         = CONVERT(BIT    ,NULL)
      ,stats_generation_method      = CONVERT(INT    ,NULL)
      ,stats_generation_method_desc = CONVERT(SYSNAME,NULL) COLLATE ' + @collation + N'
       -- SQL 2022 --------------------------------------------------------------------
      ,auto_drop                    = CONVERT(BIT    ,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_stats]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_stats]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[stats]
SELECT database_id                  = DB_ID()
      ,object_id                    = s.object_id
      ,name                         = s.name                       COLLATE ' + @collation + N'
      ,s.stats_id
      ,s.auto_created
      ,s.user_created
      ,s.no_recompute
      ,s.has_filter
      ,filter_definition            = s.filter_definition          COLLATE ' + @collation + N'
      ,is_temporary
      ,is_incremental
      ,has_persisted_sample
      ,stats_generation_method
      ,stats_generation_method_desc = stats_generation_method_desc COLLATE ' + @collation + N'
      ,auto_drop
  FROM [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
  JOIN [sys].[stats]                            AS s
    ON DB_ID()     = o.database_id
   AND s.object_id = o.object_id
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_stats]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[stats_columns]
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[stats_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
       ,@msg           NVARCHAR(1000)
       ,@exec_dttm       DATETIME      = GETDATE();

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_stats_columns]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_stats_columns];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_stats_columns]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_stats_columns]')
    + N'
  FROM (-- columns from [sys].[stats_columns]
SELECT database_id       = DB_ID()
      ,object_id         = s.object_id
      ,s.stats_id
      ,s.stats_column_id
      ,s.column_id
  FROM [sys].[stats_columns]                AS s
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
    ON DB_ID()                           = o.database_id
   AND s.object_id                       = o.object_id
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_stats_columns]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[stats_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_db_partition_stats]
-- NOTE: memory optimized table row_counts don't show up in [sys].[dm_db_partition_stats]
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[dm_db_partition_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
USE [WideWorldImporters]
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@msg           NVARCHAR(1000)
       ,@exec_dttm     DATETIME   = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats]')
    + N'
  FROM (-- columns from [sys].[dm_db_partition_stats]
SELECT database_id                    = DB_ID()
      ,object_id                      = ps.object_id
      ,index_id                       = ps.index_id
      ,Partition_CNT                  = COUNT(ps.partition_id)
      ,used_page_CNT                  = SUM(ps.used_page_count)
      ,in_row_data_page               = SUM(ps.in_row_data_page_count)
      ,in_row_used_page               = SUM(ps.in_row_used_page_count)
      ,in_row_reserved_page           = SUM(ps.in_row_reserved_page_count)
      ,lob_used_page                  = SUM(ps.lob_used_page_count)
      ,lob_reserved_page              = SUM(ps.lob_reserved_page_count)
      ,row_overflow_used_page         = SUM(ps.row_overflow_used_page_count)
      ,row_overflow_reserved_page     = SUM(ps.row_overflow_reserved_page_count)
      ,reserved_page                  = SUM(ps.reserved_page_count) -- in_row_reserved_page_count + lob_reserved_page_count + row_overflow_reserved_page_count
      ,row_CNT                        = SUM(ps.row_count)
  FROM [sys].[dm_db_partition_stats]            AS ps WITH (READUNCOMMITTED)
 GROUP BY
       ps.object_id
      ,ps.index_id
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[dm_db_partition_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_db_stats_properties]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[dm_db_stats_properties]'
            + N' - used for modification_counter if SQL 2012+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties];
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT persisted_sample_percent = CONVERT(FLOAT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties]'
    + NCHAR(13) + NCHAR(10) + N'SELECT dsp.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT dsp.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties]')
    + N'
  FROM newcol
 CROSS
  JOIN (-- list of all indexes for database
        SELECT object_id
              ,stats_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_stats]
         WHERE database_id = DB_ID()
       ) AS i
 CROSS
 APPLY (-- get [sys].[dm_db_stats_properties] for each index
        SELECT database_id      = DB_ID()
              ,object_id
              ,stats_id
              ,partition_number = CONVERT(INT,0)
              ,last_updated
              ,rows
              ,rows_sampled
              ,steps
              ,unfiltered_rows
              ,modification_counter
              ,persisted_sample_percent
              --------------------------------------------------------
              ,updated_days_ago = DATEDIFF(DAY,last_updated,GETDATE())
         FROM [sys].[dm_db_stats_properties] (i.object_id, i.stats_id)
       ) AS dsp
 WHERE dsp.last_updated IS NOT NULL
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[dm_db_stats_properties] - used for modification_counter if SQL 2012+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_db_incremental_stats_properties]
-- This function was introduced in SQL Server 2014 (12.x) Service Pack 2 and SQL Server 2016 (13.x) Service Pack 1.
-- Function returns same basic structure as above
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[dm_db_incremental_stats_properties]'
            + N' - partition modification_counter - SQL 2012SP2+,2016SP1+,2017+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_incremental_stats_properties]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_incremental_stats_properties]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
IF @i = 1
SELECT TOP (0)
       database_id
      ,object_id
      ,stats_id
      ,partition_number
      ,last_updated
      ,rows
      ,rows_sampled
      ,steps
      ,unfiltered_rows
      ,modification_counter
      ,persisted_sample_percent
       --------------------------------------------------------
      ,updated_days_ago
  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_incremental_stats_properties]
  FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties];

--------------------------------------------------------------------------------------------------------------------------------------------
IF (-- Check SQL Server version and Cumulative Update build number
            @ProductMajorVersion >= 14   -- SQL 2017+
    ------------------------------------------------------------------------------
    OR (    @ProductMajorVersion  = 13   -- SQL 2016
        AND @ProductBuild        >= 4100 -- SP1+
       )
    ------------------------------------------------------------------------------
    OR (    @ProductMajorVersion  = 12   -- SQL 2014
        AND @ProductBuild        >= 5000 -- SP2+
       )
   )
BEGIN
   -----------------------------------------------------------------------------------------------------------------------------------------
   SET @sql = N'USE ' +@database_name_quoted + N';
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
   -----------------------------------------------------------------------------------------------------------------------------------------
   ;WITH newcol AS (-- columns added after SQL Server 2005
   SELECT persisted_sample_percent = CONVERT(FLOAT,NULL)
   )
   INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_incremental_stats_properties]
   SELECT dsp.*
     FROM newcol
    CROSS
     JOIN (-- list of all indexes for database
           SELECT object_id
                 ,index_id
             FROM [tempdb].[dbo].[SQLXL_Index_sys_indexes]
            WHERE database_id = DB_ID()
          ) AS i
    CROSS
    APPLY (-- get [sys].[dm_db_incremental_stats_properties] for indexes
           SELECT database_id = DB_ID()
                 ,object_id
                 ,stats_id
                 ,partition_number
                 ,last_updated
                 ,rows
                 ,rows_sampled
                 ,steps
                 ,unfiltered_rows
                 ,modification_counter
                 ,persisted_sample_percent
                 ----------------------------------------------------------
                 ,updated_days_ago = DATEDIFF(DAY,last_updated,GETDATE())
            FROM [sys].[dm_db_incremental_stats_properties] (i.object_id, i.index_id)
          ) AS dsp
   OPTION (MAXDOP 1);'

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
      SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_db_incremental_stats_properties] '
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();

   EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END
END;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[dm_db_incremental_stats_properties]'
             + N' - partition modification_counter - SQL 2012SP2+,2016SP1+,2017+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[partitions]
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[partitions]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_partitions]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_partitions]
--*/
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT xml_compression = CONVERT(BIT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_partitions]'
    + NCHAR(13) + NCHAR(10) + N'SELECT p.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT p.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_partitions]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- aggregate columns from [sys].[partitions]
        SELECT database_id             = DB_ID()
              ,object_id               = object_id
              ,index_id
              ,hobt_id
              ,partition_id
              ,rows                    = SUM(rows)
              ,none_comp               = SUM(IIF(data_compression = CAST(0 AS TINYINT),1,0)) -- NONE
              ,row_comp                = SUM(IIF(data_compression = CAST(1 AS TINYINT),1,0)) -- ROW
              ,page_comp               = SUM(IIF(data_compression = CAST(2 AS TINYINT),1,0)) -- PAGE
              ,colstore_comp           = SUM(IIF(data_compression = CAST(3 AS TINYINT),1,0)) -- COLUMNSTORE
              ,colstore_arch           = SUM(IIF(data_compression = CAST(4 AS TINYINT),1,0)) -- COLUMNSTORE_ARCHIVE
              ,xml_comp                = SUM(IIF(xml_compression  = CAST(1 AS BIT    ),1,0)) -- XML
          FROM [sys].[partitions] WITH (READUNCOMMITTED)
         GROUP BY
               object_id
              ,index_id
              ,hobt_id
              ,partition_id
       ) AS p
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_partitions]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[partitions]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Create index on SQLXL_Index_sys_partitions
--------------------------------------------------------------------------------------------------------------------------------------------
IF @ssms_ads > 0 AND @i = 2 BEGIN -- SSMS and second database only
   RAISERROR(N'             ... Start index ixuc_SQLXL_Index_sys_partitions',0,0) WITH NOWAIT;
END

-- Add index to speed up subsequent queries
IF @i = 2 -- only execute on second database if more than one
BEGIN
   IF NOT EXISTS (-- check if index already exists for this table. Create if not found
                  SELECT NULL
                    FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                   WHERE name = N'ixuc_SQLXL_Index_sys_partitions'
                 )
   CREATE CLUSTERED
    index ixuc_SQLXL_Index_sys_partitions
       ON [tempdb].[dbo].[SQLXL_Index_sys_partitions]
         (database_id
         ,object_id
         ,index_id
         )
     WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N'    ... Index ixuc_SQLXL_Index_sys_partitions'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END
END

/******************************************************************************************************************************************\
-- Collect [sys].[internal_partitions] - Introduced in SQL 2016
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_internal_partitions]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_internal_partitions]
--*/
IF @ProductMajorVersion >= 13                 -- SQL 2016+
OR SERVERPROPERTY(N'Edition') = N'SQL Azure'  -- Azure SQL Database
BEGIN -- SQL 2016+, AZURE SQL
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT optimize_for_sequential_key = CONVERT(BIT,NULL) -- SQL 2019+, Azure SQL Database
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_internal_partitions]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_internal_partitions]')
    + N'
  FROM newcol
 CROSS
 APPLY (-- columns from [sys].[internal_partitions]
SELECT database_id               = db_id()
      ,partition_id
      ,object_id
      ,index_id
      ,partition_number
      ,hobt_id
      ,internal_object_type
      ,internal_object_type_desc = internal_object_type_desc COLLATE ' + @collation + N'
      ,row_group_id
      ,rows
      ,data_compression
      ,data_compression_desc     = data_compression_desc     COLLATE ' + @collation + N'
      ,optimize_for_sequential_key
  FROM [sys].[internal_partitions] -- SQL 2016+
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

   IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   BEGIN
      SELECT '[tempdb].[dbo].[SQLXL_Index_sys_internal_partitions]'
            ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
            ,lsql = LEN(@sql)
            ,sql1 = SUBSTRING(@sql,    1,16383)
            ,sql2 = SUBSTRING(@sql,16384,16383)
            ,sql3 = SUBSTRING(@sql,32768,16383);
      SET @exec_dttm = GETDATE();
   END

   EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

ELSE  -- version < SQL 2016
BEGIN
   IF @i = 1
   SELECT TOP (0)
          database_id                = DB_ID()
         ,partition_id                = CONVERT(BIGINT ,NULL)
         ,object_id                   = CONVERT(INT    ,NULL)
         ,index_id                    = CONVERT(INT    ,NULL)
         ,partition_number            = CONVERT(INT    ,NULL)
         ,hobt_id                     = CONVERT(BIGINT ,NULL)
         ,internal_object_type        = CONVERT(TINYINT,NULL)
         ,internal_object_type_desc   = CONVERT(SYSNAME,NULL) COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,row_group_id                = CONVERT(INT    ,NULL)
         ,rows                        = CONVERT(BIGINT ,NULL)
         ,data_compression            = CONVERT(TINYINT,NULL)
         ,data_compression_desc       = CONVERT(SYSNAME,NULL) COLLATE DATABASE_DEFAULT -- script is running in tempdb
         ,optimize_for_sequential_key = CONVERT(BIT    ,NULL)
     INTO [tempdb].[dbo].[SQLXL_Index_sys_internal_partitions];
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[internal_partitions] -- 2016+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect In-Memory (XTP) Objects
-- NOTE: [sys].[dm_db_xtp_hash_index_stats] ARE OMITTED, since it scans the entire table
--       Used to understand and tune the HASH bucket counts. It can also be used to detect cases where the index key has many duplicates.
-- Columns marked "Internal use only" are omitted
-- Column "xtp_object_id" is the Internal ID corresponding to the current version of the object. Note: Applies to SQL Server 2016 (13.x)
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT uses_key_normalization = CONVERT(BIT   ,NULL) -- 2016+
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]')
    + N'
  FROM newcol
 CROSS
 APPLY ('
+IIF(@ProductMajorVersion >= 12 -- SQL 2014+
      ,N'SELECT database_id         = DB_ID()
               ,object_id           = t.object_id
               ,table_name          = t.name                      COLLATE ' + @collation + N'
               ,i.index_id
               ,type                = CAST(i.type AS NVARCHAR(2)) COLLATE ' + @collation + N'
               ,i.type_desc
               ,index_name          = COALESCE(i.name COLLATE ' + @collation + N',i.type_desc COLLATE ' + @collation + N')
               ,i.is_unique
               -- [sys].[dm_db_xtp_object_stats] ------------- Columns marked "Internal use only" are omitted
               ,xos.row_insert_attempts
               ,xos.row_update_attempts
               ,xos.row_delete_attempts
               ,xos.write_conflicts
               ,xos.unique_constraint_violations
               -- [sys].[dm_db_xtp_index_stats] -------------- Columns marked "Internal use only" are omitted
               ,xis.scans_started
               ,xis.scans_retries
               ,xis.rows_returned
               ,xis.rows_touched
               -- [sys].[dm_db_xtp_Nonclustered_index_stats] ---
               ,nis.delta_pages
               ,nis.leaf_pages
               ,page_update_CNT              = nis.page_update_count
               ,page_update_retry_CNT        = nis.page_update_retry_count
               ,page_consolidation_CNT       = nis.page_consolidation_count
               ,page_consolidation_retry_CNT = nis.page_consolidation_retry_count
               ,page_split_CNT               = nis.page_split_count
               ,page_split_retry_CNT         = nis.page_split_retry_count
               ,key_split_CNT                = nis.key_split_count
               ,key_split_retry_CNT          = nis.key_split_retry_count
               ,page_merge_CNT               = nis.page_merge_count
               ,page_merge_retry_CNT         = nis.page_merge_retry_count
               ,key_merge_CNT                = nis.key_merge_count
               ,key_merge_retry_CNT          = nis.key_merge_retry_count
               ,nis.uses_key_normalization
               -- [sys].[dm_db_xtp_memory_consumers] --------- Columns marked "Internal use only" are omitted
               ,mc.allocated_bytes
               ,mc.used_bytes
               ,mc.allocation_CNT
           FROM (-- List of candidate memory optimized tables in this database
                 SELECT database_id = DB_ID()
                       ,object_id   = object_id
                       ,name        = name
                   FROM [tempdb].[dbo].[SQLXL_Index_sys_tables]
                  WHERE DB_ID() = database_id
                    AND 1       = is_memory_optimized -- only returns tables that are memory optimized
                ) AS t
           LEFT OUTER
           JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes] AS i
             ON t.database_id                             = i.database_id
            AND t.object_id                               = i.object_id   -- only XTP memory optimized tables selected above
           LEFT OUTER
           JOIN [sys].[dm_db_xtp_object_stats]          AS xos
             ON i.object_id                              = xos.object_id
            AND i.index_id                               = 0
           LEFT OUTER
           JOIN [sys].[dm_db_xtp_index_stats]           AS xis
             ON i.object_id                              = xis.object_id
            AND i.index_id                               = xis.index_id
           LEFT OUTER HASH
           JOIN (-- Add up memory optimized index stats from [sys].[dm_db_xtp_Nonclustered_index_stats]
                 SELECT object_id
                       ,index_id
                       ,delta_pages                    = SUM(delta_pages                   )
                       ,leaf_pages                     = SUM(leaf_pages                    )
                       ,page_update_count              = SUM(page_update_count             )
                       ,page_update_retry_count        = SUM(page_update_retry_count       )
                       ,page_consolidation_count       = SUM(page_consolidation_count      )
                       ,page_consolidation_retry_count = SUM(page_consolidation_retry_count)
                       ,page_split_count               = SUM(page_split_count              )
                       ,page_split_retry_count         = SUM(page_split_retry_count        )
                       ,key_split_count                = SUM(key_split_count               )
                       ,key_split_retry_count          = SUM(key_split_retry_count         )
                       ,page_merge_count               = SUM(page_merge_count              )
                       ,page_merge_retry_count         = SUM(page_merge_retry_count        )
                       ,key_merge_count                = SUM(key_merge_count               )
                       ,key_merge_retry_count          = SUM(key_merge_retry_count         )
                       ,uses_key_normalization         = CAST(MAX(CAST(uses_key_normalization AS TINYINT)) AS BIT) -- tinyint needed for MAX()
                   FROM (-- required to avoid error message "Aggregates on the right side of an APPLY cannot reference columns from the left side"
                         -- referencing newcol CTE
                         SELECT object_id
                               ,index_id
                               ,delta_pages
                               ,leaf_pages
                               ,page_update_count
                               ,page_update_retry_count
                               ,page_consolidation_count
                               ,page_consolidation_retry_count
                               ,page_split_count
                               ,page_split_retry_count
                               ,key_split_count
                               ,key_split_retry_count
                               ,page_merge_count
                               ,page_merge_retry_count
                               ,key_merge_count
                               ,key_merge_retry_count
                               ,uses_key_normalization
                           FROM [sys].[dm_db_xtp_Nonclustered_index_stats]
                        ) AS xnis
                  GROUP BY
                        object_id
                       ,index_id
                ) AS nis
             ON i.object_id                             = nis.object_id
            AND i.index_id                              = nis.index_id
           LEFT OUTER HASH
           JOIN (-- [sys].[dm_db_xtp_memory_consumers] aggregated to the object & index level
                 -- NOTE: [sys].[dm_db_xtp_table_memory_stats] sums up xtp_memory_consumer to the table level
                 SELECT object_id
                       ,index_id         = IIF(index_id IS NULL,0,index_id)
                       ,allocated_bytes  = SUM(allocated_bytes )
                       ,used_bytes       = SUM(used_bytes      )
                       ,allocation_CNT   = SUM(allocation_count)
                   FROM [sys].[dm_db_xtp_memory_consumers]
                  WHERE object_id  > 0                     -- omit system objects
                  GROUP BY
                        object_id
                       ,IIF(index_id IS NULL,0,index_id)
                ) AS mc
             ON i.object_id                             = mc.object_id
            AND i.index_id                              = mc.index_id'

--------------------------------------------------------------------------------------------------
-- "False" element of "IIF(@ProductMajorVersion >= 12"
-- for In-Memory (XTP) Objects
--------------------------------------------------------------------------------------------------
,N'SELECT TOP (0)
         database_id                    = DB_ID()
        ,object_id                      = CAST(NULL AS INT    )
        ,table_name                     = CAST(NULL AS SYSNAME)     COLLATE ' + @collation + N'
        ,index_id                       = CAST(NULL AS INT    )
        ,type                           = CAST(NULL AS NVARCHAR(2)) COLLATE ' + @collation + N'
        ,type_desc                      = CAST(NULL AS SYSNAME)     COLLATE ' + @collation + N'
        ,index_name                     = CAST(NULL AS SYSNAME)     COLLATE ' + @collation + N'
        ,is_unique                      = CAST(NULL AS BIT    )
      -- [sys].[dm_db_xtp_object_stats] -----------------------
        ,row_insert_attempts            = CAST(NULL AS BIGINT )
        ,row_update_attempts            = CAST(NULL AS BIGINT )
        ,row_delete_attempts            = CAST(NULL AS BIGINT )
        ,write_conflicts                = CAST(NULL AS BIGINT )
        ,unique_constraint_violations   = CAST(NULL AS BIGINT )
      -- [sys].[dm_db_xtp_index_stats] ------------------------
        ,scans_started                  = CAST(NULL AS BIGINT )
        ,scans_retries                  = CAST(NULL AS BIGINT )
        ,rows_returned                  = CAST(NULL AS BIGINT )
        ,rows_touched                   = CAST(NULL AS BIGINT )
      -- [sys].[dm_db_xtp_Nonclustered_index_stats] -----------
        ,delta_pages                    = CAST(NULL AS BIGINT )
        ,leaf_pages                     = CAST(NULL AS BIGINT )
        ,page_update_CNT                = CAST(NULL AS BIGINT )
        ,page_update_retry_CNT          = CAST(NULL AS BIGINT )
        ,page_consolidation_CNT         = CAST(NULL AS BIGINT )
        ,page_consolidation_retry_CNT   = CAST(NULL AS BIGINT )
        ,page_split_CNT                 = CAST(NULL AS BIGINT )
        ,page_split_retry_CNT           = CAST(NULL AS BIGINT )
        ,key_split_CNT                  = CAST(NULL AS BIGINT )
        ,key_split_retry_CNT            = CAST(NULL AS BIGINT )
        ,page_merge_CNT                 = CAST(NULL AS BIGINT )
        ,page_merge_retry_CNT           = CAST(NULL AS BIGINT )
        ,key_merge_CNT                  = CAST(NULL AS BIGINT )
        ,key_merge_retry_CNT            = CAST(NULL AS BIGINT )
        ,uses_key_normalization         = CAST(NULL AS BIT    )
      -- [sys].[dm_db_xtp_memory_consumers] -------------------
        ,allocated_bytes                = CAST(NULL AS BIGINT )
        ,used_bytes                     = CAST(NULL AS BIGINT )
        ,allocation_CNT                 = CAST(NULL AS BIGINT )'
)                                                                -- end of IIF @ProductMajorVersion >= 12
+ N'
       ) AS qry -- from CROSS APPLY
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);';

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[dm_db_xtp_index_stats],[xtp_object_stats],[xtp_Nonclustered_index_stats],[xtp_memory_consumers]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect partition & object/index name info to [sys].[dm_os_buffer_descriptors]
-- to create SQLXL_Index_sys_dm_os_buffer_descriptors_EXT
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[dm_os_buffer_descriptors] (database aggregates)'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]')
    + N'
  FROM (-- convert buffer allocations to physical objects
        SELECT database_id       = DB_ID()
              ,object_id         = o.object_id
              ,obj_name          = o.name          COLLATE ' + @collation + N'
              ,index_id          = i.index_id
              ,index_name        = COALESCE(i.name COLLATE ' + @collation + N',i.type_desc COLLATE ' + @collation + N')
              ,type              = i.type
              ,type_desc         = i.type_desc     COLLATE ' + @collation + N'
              ,row_CNT           = SUM(obd.row_CNT)
              ,buffer_total_KB   = SUM(obd.buffer_total_KB)
              ,buffer_free_KB    = SUM(obd.buffer_free_KB )
              ,read_microsec_AVG = SUM(obd.buffer_total_KB * obd.read_microsec_AVG)/SUM(obd.buffer_total_KB)
          FROM (-- get all buffer allocations for database
                SELECT allocation_unit_id
                      ,row_CNT
                      ,buffer_free_KB
                      ,buffer_total_KB
                      ,read_microsec_AVG
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors]
                 WHERE DB_ID()                      = database_id
               )                                   AS obd
          LEFT OUTER
          JOIN [sys].[allocation_units]            AS au
            ON obd.allocation_unit_id               = au.allocation_unit_id
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_partitions] AS ph
            ON 1 = 1
           AND DB_ID()                              = ph.database_id
           AND au.container_id                      = ph.hobt_id
           AND au.type                             IN (1,3) -- In-row data (all data types, except LOB data types) & Row-overflow data
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_partitions] AS pp
            ON 1 = 1
           AND DB_ID()                              = pp.database_id
           AND au.container_id                      = pp.partition_id
           AND au.type                              = 2    -- Large object (LOB) data (text,ntext,image,xml,large value types,and CLR UDT)
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]    AS o  -- OUTER JOIN not used in order to filter out system objects
            ON 1 = 1
           AND DB_ID()                              = o.database_id
           AND COALESCE(ph.object_id,pp.object_id)  = o.object_id
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes]    AS i
            ON DB_ID()                              = i.database_id
           AND COALESCE(ph.object_id,pp.object_id)  = i.object_id
           AND COALESCE(ph.index_id ,pp.index_id )  = i.index_id
         GROUP BY
               o.object_id
              ,o.name      COLLATE ' + @collation + N'
              ,i.index_id
              ,COALESCE(i.name COLLATE ' + @collation + N',i.type_desc COLLATE ' + @collation + N')
              ,i.type
              ,i.type_desc COLLATE ' + @collation + N'
       ) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N' [sys].[dm_os_buffer_descriptors] (database aggregates)'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
SQL 2016+
Collect [sys].[dm_db_column_store_row_group_physical_stats]
includes all columns in [sys].[column_store_row_groups]
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]')
    + N'
  FROM ('
+IIF(@ProductMajorVersion >= 13 -- SQL 2016+
,N'SELECT
       database_id                         = DB_ID()
      ,object_id                           = object_id
      ,index_id
      ,partition_number
      ,row_group_id
      ,delta_store_hobt_id
      ,state
      ,state_desc                          = state_desc                          COLLATE ' + @collation + N'
      ,total_rows
      ,deleted_rows
      ,size_in_bytes
      ,trim_reason
      ,trim_reason_desc                    = trim_reason_desc                    COLLATE ' + @collation + N'
      ,transition_to_compressed_state
      ,transition_to_compressed_state_desc = transition_to_compressed_state_desc COLLATE ' + @collation + N'
      ,has_vertipaq_optimization
      ,generation
      ,created_time
      ,closed_time
  FROM [sys].[dm_db_column_store_row_group_physical_stats]'
--------------------------------------------------------------------------------------------------
-- "False" element of "IIF(@ProductMajorVersion >= 13"
--------------------------------------------------------------------------------------------------
,N'SELECT TOP (0)
       database_id                         = DB_ID()
      ,object_id                           = CAST(NULL AS INT     )
      ,index_id                            = CAST(NULL AS INT     )
      ,partition_number                    = CAST(NULL AS INT     )
      ,row_group_id                        = CAST(NULL AS INT     )
      ,delta_store_hobt_id                 = CAST(NULL AS BIGINT  )
      ,state                               = CAST(NULL AS TINYINT )
      ,state_desc                          = CAST(NULL AS SYSNAME ) COLLATE ' + @collation + N'
      ,total_rows                          = CAST(NULL AS BIGINT  )
      ,deleted_rows                        = CAST(NULL AS BIGINT  )
      ,size_in_bytes                       = CAST(NULL AS BIGINT  )
      ,trim_reason                         = CAST(NULL AS TINYINT )
      ,trim_reason_desc                    = CAST(NULL AS SYSNAME ) COLLATE ' + @collation + N'
      ,transition_to_compressed_state      = CAST(NULL AS TINYINT )
      ,transition_to_compressed_state_desc = CAST(NULL AS SYSNAME ) COLLATE ' + @collation + N'
      ,has_vertipaq_optimization           = CAST(NULL AS BIT     )
      ,generation                          = CAST(NULL AS BIGINT  )
      ,created_time                        = CAST(NULL AS DATETIME)
      ,closed_time                         = CAST(NULL AS DATETIME)'
)
+ N') AS qry
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[dm_db_column_store_row_group_physical_stats] - 2016+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[dm_db_column_store_row_group_operational_stats] - SQL 2016+
-- NOTE: for a writeup on the CTE method used below to handle column differences across SQL Server versions please see Aaron Bertrand's
--       https://www.mssqltips.com/sqlservertip/5898/make-sql-server-dmv-queries-backward-compatible/
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')
--------------------------------------------------------------------------------------------------------------------------------------------

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]
--*/
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH newcol AS (-- columns added after SQL Server 2005
SELECT -- SQL 2019+ -----------------------------------
       returned_row_COUNT        = CONVERT(BIGINT,NULL)
      ,returned_aggregate_COUNT  = CONVERT(BIGINT,NULL)
      ,returned_group_COUNT      = CONVERT(BIGINT,NULL)
      ,input_groupby_row_COUNT   = CONVERT(BIGINT,NULL)
)'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]')
    + N'
  FROM newcol
 CROSS
 APPLY (' -- columns from [sys].[dm_db_column_store_row_group_operational_stats]
+IIF(@ProductMajorVersion >= 13 -- SQL 2016+
,N'
SELECT database_id             = DB_ID()
      ,object_id               = object_id
      ,index_id
      ,partition_CNT           = COUNT(partition_number       )
      ,row_group_CNT           = COUNT(row_group_id           )
      ,index_scan_CNT          = SUM(index_scan_count         )
      ,scan_CNT                = SUM(scan_count               )
      ,delete_buffer_scan_CNT  = SUM(delete_buffer_scan_count )
      ,row_group_lock_CNT      = SUM(row_group_lock_count     )
      ,row_group_lock_wait_CNT = SUM(row_group_lock_wait_count)
      ,row_group_lock_wait_MS  = SUM(row_group_lock_wait_in_ms)
      ,returned_row_CNT        = SUM(returned_row_count       )
      ,returned_aggregate_CNT  = SUM(returned_aggregate_count )
      ,returned_group_CNT      = SUM(returned_group_count     )
      ,input_groupby_row_CNT   = SUM(input_groupby_row_count  )
  FROM [sys].[dm_db_column_store_row_group_operational_stats]
 GROUP BY
       object_id
      ,index_id'
--------------------------------------------------------------------------------------------------------------
-- "False" element of "IIF(@ProductMajorVersion >= 13" -- SQL 2016+
--------------------------------------------------------------------------------------------------------------
,N'
SELECT TOP (0)
       database_id             = DB_ID()
      ,object_id               = CAST(NULL AS INT   )
      ,index_id                = CAST(NULL AS INT   )
      ,partition_CNT           = CAST(NULL AS INT   )
      ,row_group_CNT           = CAST(NULL AS INT   )
      ,index_scan_CNT          = CAST(NULL AS BIGINT)
      ,scan_CNT                = CAST(NULL AS BIGINT)
      ,delete_buffer_scan_CNT  = CAST(NULL AS BIGINT)
      ,row_group_lock_CNT      = CAST(NULL AS BIGINT)
      ,row_group_lock_wait_CNT = CAST(NULL AS BIGINT)
      ,row_group_lock_wait_MS  = CAST(NULL AS BIGINT)
      ,returned_row_CNT        = CAST(NULL AS BIGINT)
      ,returned_aggregate_CNT  = CAST(NULL AS BIGINT)
      ,returned_group_CNT      = CAST(NULL AS BIGINT)
      ,input_groupby_row_CNT   = CAST(NULL AS BIGINT)'
)
+ N'
) AS qry -- from CROSS APPLY
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[dm_db_column_store_row_group_operational_stats] - 2016+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Collect [sys].[index_resumable_operations] - SQL 2017+
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations]')
    + N'
  FROM ('
+IIF(@ProductMajorVersion >= 14 -- SQL 2017+
,N'
SELECT database_id          = DB_ID()
      ,object_id            = object_id
      ,index_id
      ,state_desc           = state_desc                COLLATE ' + @collation + N'
      ,partition_CNT        = COUNT(partition_number)
      ,start_time           = MIN(start_time)
      ,last_pause_time      = MAX(last_pause_time)
      ,total_execution_time = MAX(total_execution_time)
      ,page_CNT             = SUM(page_count)
      ,percent_complete_MIN = MIN(percent_complete)
      ,percent_complete_MAX = MAX(percent_complete)
      ,sql_text             = MAX(sql_text)             COLLATE ' + @collation + N'
  FROM [sys].[index_resumable_operations]
 GROUP BY
       object_id
      ,index_id
      ,state_desc'
--------------------------------------------------------------------------------------------------
-- "False" element of "IIF(@ProductMajorVersion >= 14"
--------------------------------------------------------------------------------------------------
,N'
SELECT TOP (0)
       database_id          = DB_ID()
      ,object_id            = CAST(NULL AS INT          )
      ,index_id             = CAST(NULL AS INT          )
      ,state_desc           = CAST(NULL AS SYSNAME      ) COLLATE ' + @collation + N'
      ,partition_CNT        = CAST(NULL AS BIGINT       )
      ,start_time           = CAST(NULL AS DATETIME     )
      ,last_pause_time      = CAST(NULL AS DATETIME     )
      ,total_execution_time = CAST(NULL AS INT          )
      ,page_CNT             = CAST(NULL AS BIGINT       )
      ,percent_complete_MIN = CAST(NULL AS FLOAT        )
      ,percent_complete_MAX = CAST(NULL AS FLOAT        )
      ,sql_text             = CAST(NULL AS NVARCHAR(MAX)) COLLATE ' + @collation
)
+ N'
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[index_resumable_operations] - SQL 2017+'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
-- Collect [sys].[sql_expression_dependencies]
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N'.[sys].[sql_expression_dependencies]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
-------------------------------------------------------------------------------------------------------------------------------------------'
+IIF(@i > 1
    , NCHAR(13) + NCHAR(10) + N'INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies]'
    + NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    , NCHAR(13) + NCHAR(10) + N'SELECT qry.*'
    + NCHAR(13) + NCHAR(10) + N'  INTO [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies]')
    + N'
  FROM (-- columns from [sys].[sql_expression_dependencies]
SELECT database_id               = DB_ID()
      ,referencing_id            = referencing_id
      ,referencing_minor_id      = referencing_minor_id
      ,referencing_class         = referencing_class
      ,referencing_class_desc    = referencing_class_desc    COLLATE ' + @collation + N'
      ,is_schema_bound_reference = is_schema_bound_reference
      ,referenced_class          = referenced_class
      ,referenced_class_desc     = referenced_class_desc     COLLATE ' + @collation + N'
      ,referenced_server_name    = referenced_server_name    COLLATE ' + @collation + N'
      ,referenced_database_name  = referenced_database_name  COLLATE ' + @collation + N'
      ,referenced_schema_name    = referenced_schema_name    COLLATE ' + @collation + N'
      ,referenced_entity_name    = referenced_entity_name    COLLATE ' + @collation + N'
      ,referenced_id             = referenced_id
      ,referenced_minor_id       = referenced_minor_id
      ,is_caller_dependent       = is_caller_dependent
      ,is_ambiguous              = is_ambiguous
  FROM [sys].[sql_expression_dependencies]
) AS qry
OPTION (MAXDOP 1);'

IF @ssms_ads > 1 AND @i = 1 -- SSMS and first database only
   SELECT '[tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies]'
         ,CONVERT(VARCHAR(12),GETDATE() - @exec_dttm,14)
         ,lsql = LEN(@sql)
         ,sql1 = SUBSTRING(@sql,    1,16383)
         ,sql2 = SUBSTRING(@sql,16384,16383)
         ,sql3 = SUBSTRING(@sql,32768,16383);
   SET @exec_dttm = GETDATE();

EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N'    ... ' + @database_name_quoted + N'.[sys].[sql_expression_dependencies]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

IF @@TRANCOUNT > 0 COMMIT; -- for Justin - Just In Case

/******************************************************************************************************************************************\
-- Cursor through all statistics procedures for all indexes, Foreign Key Constraints & Columns used across indexable objects
-- Statistics are not returned on all objects - Nonclustered Column Stores, empty tables, etc.
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = N'           Start ' + @database_name_quoted + N' DBCC SHOW_STATISTICS - DensityVector,StatHeader,Histogram'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql           NVARCHAR(MAX)
       ,@i             INT           = 1
       ,@database_name_quoted NVARCHAR(MAX) = N'WideWorldImporters'
       ,@ssms_ads      TINYINT       = 2
       ,@exec_dttm     DATETIME      = GETDATE()
       ,@collation     SYSNAME       = (SELECT collation_name FROM [sys].[databases] WHERE name = N'tempdb')

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary]
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
SET @sql = N'USE ' +@database_name_quoted + N';
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;SET ANSI_DEFAULTS ON;SET NOCOUNT ON;
SET XACT_ABORT ON;             -- automatically roll back the current transaction when a statement raises a run-time error
SET IMPLICIT_TRANSACTIONS OFF; -- occasionally implicit transactions are created by the DBCC SHOW_STATISTICS function
--------------------------------------------------------------------------------------------------------------------------------------------
-- [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]
--------------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N''[tempdb]..#XL_IDX_sys_ShowStatistics_StatHeader'') IS NOT NULL
   DROP TABLE #XL_IDX_sys_ShowStatistics_StatHeader;

CREATE
 TABLE #XL_IDX_sys_ShowStatistics_StatHeader
      (Name                     NVARCHAR(128)  COLLATE ' + @collation + N' NULL
      ,Updated                  DATETIME       NULL
      ,Rows                     BIGINT         NULL
      ,Rows_sampled             BIGINT         NULL
      ,Steps                    INT            NULL
      ,Density                  FLOAT          NULL
      ,Average_Key_Length       INT            NULL
      ,String_index             NVARCHAR(3)    COLLATE ' + @collation + N' NULL
      ,Filter_Expression        NVARCHAR(4000) COLLATE ' + @collation + N' NULL
      ,Unfiltered_Rows          BIGINT         NULL
      ,Persisted_Sample_Percent TINYINT        NULL
      );'

+IIF(@i = 1
    ,N'
CREATE
 TABLE [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]
      (database_id              INT            NOT NULL
      ,object_id                INT            NOT NULL
      ,object_name              SYSNAME            COLLATE ' + @collation + N' NULL
      ,stats_target_name        SYSNAME            COLLATE ' + @collation + N' NULL
      ,index_ID                 INT                NULL
      ,column_id                INT                NULL
      ,Statistics_age_days      INT                NULL
      ,Updated                  DATETIME           NULL
      ,Rows                     BIGINT             NULL
      ,Rows_sampled             BIGINT             NULL
      ,Steps                    INT                NULL
      ,Density                  FLOAT              NULL
      ,Average_Key_Length       INT                NULL
      ,String_index             NVARCHAR(3)        COLLATE ' + @collation + N' NULL
      ,Filter_Expression        NVARCHAR(4000)     COLLATE ' + @collation + N' NULL
      ,Unfiltered_Rows          BIGINT             NULL
      ,Persisted_Sample_Percent TINYINT            NULL
      ) WITH (DATA_COMPRESSION = PAGE);'
    ,N'')

+ N'
--------------------------------------------------------------------------------------------------------------------------------------------
-- [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
--------------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N''[tempdb]..#XL_IDX_sys_ShowStatistics_DensityVector'') IS NOT NULL
   DROP TABLE #XL_IDX_sys_ShowStatistics_DensityVector;

CREATE
 TABLE #XL_IDX_sys_ShowStatistics_DensityVector
      (Row_ID                   INT    IDENTITY(1,1)
      ,All_Density              FLOAT                NOT NULL
      ,Average_Length           FLOAT                NOT NULL
      ,[Columns]                NVARCHAR(MAX)        COLLATE ' + @collation + N' NOT NULL
      );'

+IIF(@i = 1
    ,N'
CREATE
 TABLE [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
      (database_id              INT           NOT NULL
      ,object_id                INT           NOT NULL
      ,object_name              SYSNAME           COLLATE ' + @collation + N' NULL
      ,stats_target_name        SYSNAME           COLLATE ' + @collation + N' NULL
      ,index_ID                 INT               NULL
      ,column_id                INT               NULL
      ,Row_ID                   SMALLINT      NOT NULL
      ,All_Density              FLOAT         NOT NULL
      ,Average_Length           FLOAT         NOT NULL
      ,[Columns]                NVARCHAR(MAX) COLLATE ' + @collation + N' NOT NULL
      ) WITH (DATA_COMPRESSION = PAGE);'
    ,N'')

+ N'
--------------------------------------------------------------------------------------------------------------------------------------------
-- [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram
--------------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N''[tempdb]..#XL_IDX_sys_ShowStatistics_Histogram'') IS NOT NULL
   DROP TABLE #XL_IDX_sys_ShowStatistics_Histogram;

CREATE
 TABLE #XL_IDX_sys_ShowStatistics_Histogram
      (Range_Hi_Key             SQL_VARIANT   NULL
      ,Range_Rows               FLOAT         NULL
      ,EQ_Rows                  FLOAT         NULL
      ,Distinct_Range_Rows      BIGINT        NULL
      ,Avg_Range_Rows           FLOAT         NULL
      );'

+IIF(@i = 1
    ,N'
CREATE
 TABLE [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary]
      (database_id              INT           NOT NULL
      ,object_id                INT           NOT NULL
      ,object_name              SYSNAME       COLLATE ' + @collation + N' NULL
      ,stats_target_name        SYSNAME       COLLATE ' + @collation + N' NULL
      ,index_ID                 INT           NULL
      ,column_id                INT           NULL
      ,min_rows_per_value       FLOAT         NULL
      ,max_rows_per_value       FLOAT         NULL
      ,null_rows                FLOAT         NULL
      ,param_sniff              FLOAT         NULL
      ) WITH (DATA_COMPRESSION = PAGE);'
    ,N'')

+ N'
--------------------------------------------------------------------------------------------------------------------------------------------
-- Local Variables
--------------------------------------------------------------------------------------------------------------------------------------------
DECLARE @database_id       INT
       ,@database_name     SYSNAME       = N'''' COLLATE ' + @collation + N'
       ,@object_id         INT
       ,@index_ID          NVARCHAR(11)  = N'''' COLLATE ' + @collation + N'
       ,@column_id         INT
       ,@object_name       NVARCHAR(257) = N'''' COLLATE ' + @collation + N'
       ,@stats_target_name NVARCHAR(MAX) = N'''' COLLATE ' + @collation + N'
       ,@ssms_ads          TINYINT = (SELECT (1)
                                        FROM [sys].[dm_exec_sessions]
                                       WHERE session_id = @@spid
                                         AND (   program_name LIKE N''Microsoft SQL Server Management Studio%''
                                              OR program_name like N''azdata%'' -- azure data studio
                                              OR program_name    = N''SQLCMD''  -- SQL command
                                             )
                                     );

DECLARE stats_crsr CURSOR LOCAL FAST_FORWARD FOR
SELECT database_id   = DB_ID()
      ,database_name = QUOTENAME(DB_NAME())
      ,c.object_id
      ,c.index_ID
      ,c.column_id
      ,c.object_name
      ,c.stats_target_name
  FROM (-- All relational indexes
        SELECT i.object_id
              ,i.index_ID
              ,column_id             = CAST(NULL AS INT)
              ,object_name           = QUOTENAME(s.name) + N''.'' + QUOTENAME(o.name)  COLLATE ' + @collation + N'
              ,stats_target_name     = QUOTENAME(i.name)                               COLLATE ' + @collation + N'
          FROM (-- Get statistics for all index types, including FullText
                SELECT object_id
                      ,index_id
                      ,name
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_indexes]
                 WHERE DB_ID() = database_id
                   AND name   IS NOT NULL
                UNION -- get Full text indexes
                SELECT object_id
                      ,unique_index_id
                      ,name          = N''FULLTEXT''
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]
                 WHERE DB_ID()       = database_id
               ) AS i
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
            ON DB_ID()     = o.database_id
           AND i.object_id = o.object_id
           AND o.type NOT IN (N''TT'',N''FT'',N''IF'',N''TF'') -- exclude TYPE_TABLE, FUnctions ...
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS s
            ON DB_ID()     = s.database_id
           AND o.schema_id = s.schema_id
        -------------------------------------------------------------------------------------------------------------------------------------
        -- Columns that have stats computed for them
        -------------------------------------------------------------------------------------------------------------------------------------
        UNION
        SELECT ic.object_id
              ,index_id              = CAST(NULL AS INT)
              ,ic.column_id
              ,object_name           = QUOTENAME(s.name) + N''.'' + QUOTENAME(o.name) COLLATE ' + @collation + N'
              ,stats_target_name     = QUOTENAME(c.name)                              COLLATE ' + @collation + N'
          FROM (-- All Columns that have had stats computed, including by Statistics Auto Create
                -- find candidate unique columns for HEAPS, columns that can takes advantage of new/existing NCS if added
                SELECT object_id
                      ,column_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_stats_columns] -- all columns that have statistics created on them
                 WHERE DB_ID() = database_id
                 GROUP BY
                       object_id
                      ,column_id
               ) AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
            ON DB_ID()      = o.database_id
           AND ic.object_id = o.object_id                    -- want parent objects only
           AND o.type  NOT IN (-- Statistics not available for types
                               N''TT'' -- Table Type
                              ,N''FT'' -- Assembly (CLR) table-valued function
                              ,N''IF'' -- SQL inline table-valued function (TVF)
                              ,N''TF'' -- SQL table-valued-function (TVF)
                              )
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS s
            ON o.database_id  = s.database_id
           AND o.schema_id    = s.schema_id
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
            ON o.database_id   = c.database_id
           AND ic.object_id    = c.object_id
           AND ic.column_id    = c.column_id
           AND N''timestamp'' <> c.user_type_name -- no statistics returned for TIMESTAMP
      ) AS c
 ORDER BY
       object_id
      ,index_ID
      ,column_id
OPTION (FORCE ORDER -- Force order eliminates "Warning: join order enforced because a local join hint is used."
       ,MAXDOP 1);

OPEN stats_crsr;
WHILE 1 = 1
BEGIN

   FETCH NEXT
    FROM stats_crsr
    INTO @database_id
        ,@database_name
        ,@object_id
        ,@index_ID
        ,@column_id
        ,@object_name
        ,@stats_target_name;

   IF @@Fetch_Status <> 0
      BREAK

   BEGIN TRY
      -----------------------------------------------------------------------------------------------------------------------------------
      -- [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]
      -----------------------------------------------------------------------------------------------------------------------------------
      INSERT
        INTO #XL_IDX_sys_ShowStatistics_StatHeader
            (Name
            ,Updated
            ,Rows
            ,Rows_sampled
            ,Steps
            ,Density
            ,Average_Key_Length
            ,String_index
            ,Filter_Expression
            ,Unfiltered_Rows'
            + CASE WHEN (    @ProductMajorVersion     >= 14     -- SQL 2017+
                         ------------------------------------------------------------------------------
                         OR (    @ProductMajorVersion  = 13     -- SQL 2016 SP1
                             AND @ProductBuild        >= 4446   -- SQL 2016 SP1 CU4+
                            )
                        )
                   THEN N',Persisted_Sample_Percent'
                   ELSE N''
              END + N'
            )
        EXEC(N''USE ' + @database_name_quoted + N';
DBCC SHOW_STATISTICS ('''''' + @object_name        + N'''''','' + @stats_target_name + N'')
     WITH STAT_HEADER, NO_INFOMSGS'')

      -- insert into persisted table [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]
      INSERT
        INTO [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]
            (database_id
            ,object_id
            ,object_name
            ,stats_target_name
            ,index_ID
            ,column_id
            ,Statistics_age_days
            ,Updated
            ,Rows
            ,Rows_sampled
            ,Steps
            ,Density
            ,Average_Key_Length
            ,String_index
            ,Filter_Expression
            ,Unfiltered_Rows'
      + CASE WHEN (        @ProductMajorVersion >= 14   -- SQL 2017+
                   ------------------------------------------------------------------------------
                   OR (    @ProductMajorVersion  = 13   -- SQL 2016
                       AND @ProductBuild        >= 4446 -- SQL 2016 SP1 CU4+
                      )
                  )
             THEN N',Persisted_Sample_Percent'
             ELSE N''
        END + N'
            )
      SELECT DB_ID()
            ,@object_id
            ,@object_name
            ,@stats_target_name
            ,@index_ID
            ,@column_id
            ,Statistics_age_days = DATEDIFF(DAY,Updated,GETDATE())
            ,Updated
            ,Rows
            ,Rows_sampled
            ,Steps
            ,Density
            ,Average_Key_Length
            ,String_index
            ,Filter_Expression
            ,Unfiltered_Rows'
      + CASE WHEN (        @ProductMajorVersion >= 14   -- SQL 2017+
                   ------------------------------------------------------------------------------
                   OR (    @ProductMajorVersion  = 13   -- SQL 2016
                       AND @ProductBuild        >= 4446 -- SQL 2016 SP1 CU4+
                      )
                  )
             THEN N',Persisted_Sample_Percent = CASE WHEN Persisted_Sample_Percent = 0 THEN 100 ELSE Persisted_Sample_Percent END'
             ELSE N''
        END + N'
        FROM #XL_IDX_sys_ShowStatistics_StatHeader;

   END TRY
   BEGIN CATCH
      IF @ssms_ads > 0
      AND CHARINDEX(N''.[#'',@object_name) = 0
      AND CHARINDEX(N''.[ifts'',@object_name) = 0 -- full text indexes before processing
         SELECT WARNING         = N''DBCC SHOW_STATISTICS STAT_HEADER NOT FOUND''
               ,OBJECT          = @database_name + N''.'' + @object_name
               ,INDEX_ID        = @index_ID
               ,COLUMN_ID       = @column_id
               ,STATISTICS_NAME = @stats_target_name;
      IF @@TRANCOUNT > 0 ROLLBACK
   END CATCH

   BEGIN TRY
      -----------------------------------------------------------------------------------------------------------------------------------
      -- [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
      -----------------------------------------------------------------------------------------------------------------------------------
      INSERT
        INTO #XL_IDX_sys_ShowStatistics_DensityVector
        EXEC(N''USE ' + @database_name_quoted + N';
DBCC SHOW_STATISTICS ('''''' + @object_name + N'''''','' + @stats_target_name + N'')
     WITH DENSITY_VECTOR, NO_INFOMSGS'')

      -- insert into persisted table [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
      INSERT
        INTO [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
      SELECT DB_ID()
            ,@object_id
            ,@object_name
            ,@stats_target_name
            ,@index_ID
            ,@column_id
            ,Row_ID = ROW_NUMBER() OVER (ORDER BY LEN([Columns]))
            ,All_Density
            ,Average_Length
            ,LTRIM(RTRIM([Columns]))
        FROM #XL_IDX_sys_ShowStatistics_DensityVector;

   END TRY
   BEGIN CATCH
      IF @ssms_ads > 0
      AND CHARINDEX(N''.[#'',@object_name) = 0
      AND CHARINDEX(N''.[ifts'',@object_name) = 0 -- full text indexes before processing
         SELECT WARNING         = N''DBCC SHOW_STATISTICS DENSITY_VECTOR NOT FOUND''
               ,OBJECT          = @database_name + N''.'' + @object_name
               ,INDEX_ID        = @index_ID
               ,COLUMN_ID       = @column_id
               ,STATISTICS_NAME = @stats_target_name;
      IF @@TRANCOUNT > 0 ROLLBACK
   END CATCH

   BEGIN TRY
      -----------------------------------------------------------------------------------------------------------------------------------
      -- [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram
      -----------------------------------------------------------------------------------------------------------------------------------
      INSERT
        INTO #XL_IDX_sys_ShowStatistics_Histogram
        EXEC(N''USE ' + @database_name_quoted + N';
DBCC SHOW_STATISTICS ('''''' + @object_name + N'''''','' + @stats_target_name + N'')
     WITH HISTOGRAM, NO_INFOMSGS'')

      -----------------------------------------------------------------------------------------------------------------------------------
      -- Insert into [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram
      -- BOL says:
      -- "AVG_RANGE_ROWS = Average number of rows with duplicate column values within a histogram step, excluding the upper bound.
      --  When DISTINCT_RANGE_ROWS is greater than 0, AVG_RANGE_ROWS is calculated by dividing RANGE_ROWS by DISTINCT_RANGE_ROWS.
      --  When DISTINCT_RANGE_ROWS is 0, AVG_RANGE_ROWS returns 1 for the histogram step."

      -- Since the histogram "upper bound" is not included in the AVG_RANGE_ROWS, compute parameter sniffing range by adding
      --    the EQ_ROWS to the RANGE_ROWS to get all records in a histogram step,
      --    then divide by the DISTINCT_RANGE_ROWS plus 1 to account for the upper bound.
      -----------------------------------------------------------------------------------------------------------------------------------
      -- insert into persisted table [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary]
      INSERT INTO [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary]
      SELECT DB_ID()
            ,@object_id
            ,@object_name
            ,@stats_target_name
            ,@index_ID
            ,@column_id
            ,e.min_rows_per_value
            ,e.max_rows_per_value
            ,e.null_rows
            ,param_sniff = IIF(e.min_rows_per_value > 0,e.max_rows_per_value / e.min_rows_per_value,NULL)
        FROM (-- compute MIN & MAX rows per range, MAX null rows per range
              SELECT min_rows_per_value = MIN(e.arr)
                    ,max_rows_per_value = MAX(e.arr)
                    ,null_rows          = MAX(e.Nrr)
                FROM (-- compute average rows per range, null rows per range
                      SELECT arr = IIF(range_hi_key IS NOT NULL
                                      ,(eq_rows + Range_Rows) / (Distinct_Range_Rows + 1)
                                      ,EQ_Rows)
                            ,nrr = IIF(range_hi_key IS NULL
                                      ,EQ_Rows
                                      ,0)
                        FROM #XL_IDX_sys_ShowStatistics_Histogram
                     ) e
             ) e;

   END TRY
   BEGIN CATCH
      IF @ssms_ads > 0
      AND CHARINDEX(N''.[#'',@object_name) = 0
      AND CHARINDEX(N''.[ifts'',@object_name) = 0 -- full text indexes before processing
         SELECT WARNING         = N''DBCC SHOW_STATISTICS HISTOGRAM NOT FOUND''
               ,OBJECT          = @database_name + N''.'' + @object_name
               ,INDEX_ID        = @index_ID
               ,COLUMN_ID       = @column_id
               ,STATISTICS_NAME = @stats_target_name;
      IF @@TRANCOUNT > 0 ROLLBACK
   END CATCH

   -- Reset temp table for next batch of statistics
   TRUNCATE TABLE #XL_IDX_sys_ShowStatistics_DensityVector;
   TRUNCATE TABLE #XL_IDX_sys_ShowStatistics_StatHeader;
   TRUNCATE TABLE #XL_IDX_sys_ShowStatistics_Histogram;

END

CLOSE stats_crsr;
DEALLOCATE stats_crsr;'

   EXECUTE [sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; SELECT @sql; END

   SET @i = @i + 1;

   IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
      SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
                + N'    ... ' + @database_name_quoted + N' DBCC SHOW_STATISTICS - DensityVector,StatHeader,Histogram'
      RAISERROR(@msg,0,0) WITH NOWAIT;
      SET @exec_dttm = GETDATE();
   END

END -- database cursor

/******************************************************************************************************************************************\
-- END of database cursor
\******************************************************************************************************************************************/
CLOSE db_crsr;
DEALLOCATE db_crsr;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
             + N' Closed Database cursor'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
DECLARE @sql         NVARCHAR(MAX)
       ,@run_value   NVARCHAR(4000);
       ,@ssms_ads    TINYINT = 1
       ,@msg         NVARCHAR(1000)
       ,@exec_dttm   DATETIME      = GETDATE();

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Compilation]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Compilation];
--*/

/******************************************************************************************************************************************\
*** INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX BUILDS  INDEX  ***
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'',0,0) WITH NOWAIT;
   RAISERROR(N'--------- Index builds on tempdb SQLXL_Index tables ------------------------------',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
Notes on Indexing collected temp tables:

-- Clustered Index created in above data collection steps for: (in order of appearance)
-----------------------------------------------------------------------
[tempdb].[dbo].[SQLXL_Index_sys_databases]
[tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_columns]
[tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors]

[tempdb].[dbo].[SQLXL_Index_sys_schemas]
[tempdb].[dbo].[SQLXL_Index_sys_objects]
[tempdb].[dbo].[SQLXL_Index_sys_indexes]
[tempdb].[dbo].[SQLXL_Index_sys_index_columns]
[tempdb].[dbo].[SQLXL_Index_sys_partitions]


-- "SMALL"ish tables NOT INDEXED
-----------------------------------------------------------------------
[tempdb].[dbo].[SQLXL_Index_sys_availability_replicas]
[tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states]
[tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]
[tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]
[tempdb].[dbo].[SQLXL_Index_sys_edge_constraint_clauses]
[tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]
[tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters]

\******************************************************************************************************************************************/
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_stats'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_stats
    ON [tempdb].[dbo].[SQLXL_Index_sys_stats]
      (database_id
      ,object_id
      ,stats_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_database_scoped_configurations'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_database_scoped_configurations
    ON [tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations]
      (database_id
      ,name
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_database_scoped_configurations'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_database_automatic_tuning_options]'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_database_automatic_tuning_options
    ON [tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]
      (database_id
      ,name
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_database_automatic_tuning_options'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_database_query_store_options'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_database_query_store_options
    ON [tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]
      (database_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_database_query_store_options'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_cdc_change_tables__object_id'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_cdc_change_tables__object_id
    ON [tempdb].[dbo].[SQLXL_Index_cdc_change_tables]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_cdc_change_tables__object_id]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_cdc_change_tables__source_object_id'
              )
CREATE UNIQUE NONCLUSTERED
 INDEX ixuc_SQLXL_Index_cdc_change_tables__source_object_id
    ON [tempdb].[dbo].[SQLXL_Index_cdc_change_tables]
      (database_id
      ,source_object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_cdc_change_tables__source_object_id]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_tables'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_tables
    ON [tempdb].[dbo].[SQLXL_Index_sys_tables]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_tables]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_data_spaces'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_data_spaces
    ON [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
      (database_id
      ,data_space_id
      ,file_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_data_spaces]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_default_constraints'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_default_constraints
    ON [tempdb].[dbo].[SQLXL_Index_sys_default_constraints]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_default_constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_types'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_types
    ON [tempdb].[dbo].[SQLXL_Index_sys_types]
      (database_id
      ,user_type_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_types]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_columns'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_columns
    ON [tempdb].[dbo].[SQLXL_Index_sys_columns]
      (database_id
      ,object_id
      ,column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_column_type_usages'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_column_type_usages
    ON [tempdb].[dbo].[SQLXL_Index_sys_column_type_usages]
      (database_id
      ,object_id
      ,column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_column_type_usages]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_check_constraints'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_check_constraints
    ON [tempdb].[dbo].[SQLXL_Index_sys_check_constraints]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_check_constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_key_constraints'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_key_constraints
    ON [tempdb].[dbo].[SQLXL_Index_sys_key_constraints]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_key_constraints]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_fulltext_indexes'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_fulltext_indexes
    ON [tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_fulltext_indexes]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_foreign_keys'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_foreign_keys
    ON [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]
      (database_id
      ,object_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_foreign_keys]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_foreign_key_columns'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_foreign_key_columns
    ON [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]
      (database_id
      ,constraint_object_id
      ,constraint_column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_foreign_key_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ix_SQLXL_Index_sys_foreign_key_columns_parent'
              )
CREATE
 INDEX ix_SQLXL_Index_sys_foreign_key_columns_parent
    ON [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]
      (database_id
      ,parent_object_id
      ,parent_column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ix_SQLXL_Index_sys_foreign_key_columns_parent]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ix_SQLXL_Index_sys_foreign_key_columns_refer'
              )
CREATE
 INDEX ix_SQLXL_Index_sys_foreign_key_columns_refer
    ON [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]
      (database_id
      ,referenced_object_id
      ,referenced_column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ix_SQLXL_Index_sys_foreign_key_columns_refer]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_extended_properties'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_extended_properties
    ON [tempdb].[dbo].[SQLXL_Index_sys_extended_properties]
      (database_id
      ,class
      ,major_id
      ,minor_id
      ,name
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_extended_properties]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   RAISERROR(N'    Start Index [ixuc_SQLXL_Index_sys_stats_columns]',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_stats_columns'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_stats_columns
    ON [tempdb].[dbo].[SQLXL_Index_sys_stats_columns]
      (database_id
      ,object_id
      ,stats_id
      ,stats_column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_stats_columns]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_partition_stats'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_dm_db_partition_stats
    ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats]
      (database_id
      ,object_id
      ,index_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_dm_db_partition_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_stats_properties'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_dm_db_stats_properties
    ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties]
      (database_id
      ,object_id
      ,stats_id
      ,partition_number
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_dm_db_stats_properties]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_xtp_index_stats'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_dm_db_xtp_index_stats
    ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]
      (database_id
      ,object_id
      ,index_id
      ,type
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_dm_db_xtp_index_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_os_buffer_descriptors_EXT'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_dm_os_buffer_descriptors_EXT
    ON [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]
      (database_id
      ,object_id
      ,index_id
      ,type
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_dm_os_buffer_descriptors_EXT]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats'
              )
CREATE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats
    ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]
       (database_id
       ,object_id
       ,index_id
       )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats
    ON [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]
      (database_id
      ,object_id
      ,index_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_index_resumable_operations'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_index_resumable_operations
    ON [tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations]
      (database_id
      ,object_id
      ,index_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_index_resumable_operations]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   RAISERROR(N'    Start Index [ix_SQLXL_Index_sys_sql_expression_dependencies]',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ix_SQLXL_Index_sys_sql_expression_dependencies'
              )
CREATE CLUSTERED
 INDEX ix_SQLXL_Index_sys_sql_expression_dependencies
    ON [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies]
      (database_id
      ,referenced_id
      ,referenced_minor_id
      ,referencing_id
      ,referencing_minor_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ix_SQLXL_Index_sys_sql_expression_dependencies]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_ShowStatistics_StatHeader'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_ShowStatistics_StatHeader
    ON [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]
      (database_id
      ,object_id
      ,index_ID
      ,column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_ShowStatistics_StatHeader]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_ShowStatistics_DensityVector'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_ShowStatistics_DensityVector
    ON [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
      (database_id
      ,object_id
      ,index_ID
      ,column_id
      ,Row_ID
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_ShowStatistics_DensityVector]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_ShowStatistics_Histogram_summary'
              )
CREATE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_ShowStatistics_Histogram_summary
    ON [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary]
      (database_id
      ,object_id
      ,index_ID
      ,column_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_ShowStatistics_Histogram_summary]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (-- check if index already exists for this table. Create if not found
               SELECT NULL
                 FROM [tempdb].[sys].[indexes] WITH (READUNCOMMITTED)
                WHERE name = N'ixuc_SQLXL_Index_sys_internal_partitions'
              )
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_sys_internal_partitions
    ON [tempdb].[dbo].[SQLXL_Index_sys_internal_partitions]
      (database_id
      ,object_id
      ,index_ID
      ,partition_id
      )
  WITH (DATA_COMPRESSION = PAGE,MAXDOP = 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [ixuc_SQLXL_Index_sys_internal_partitions]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
Completed index builds on collected tables
\******************************************************************************************************************************************/
 IF @ssms_ads > 0 BEGIN -- display status to SSMS Messages tab
   SET @msg = [tempdb].[dbo].SQLXL_DTTM_HMSM(DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Completed Index builds on tempdb SQLXL_IDX tables'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END;
/*#########################################################################################################################################\
*** Organize Organize Organize Organize Organize Organize Organize Organize Organize Organize Organize Organize Organize Organize Organ ****
\#########################################################################################################################################*/
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql  NVARCHAR(MAX)
       ,@name SYSNAME
       ,@ssms_ads  TINYINT = (SELECT (1)
                                FROM [msdb].[sys].[dm_exec_sessions]
                               WHERE session_id = @@spid
                                 AND (   program_name LIKE N'Microsoft SQL Server Management Studio%'
                                      OR program_name like N'azdata%' --azure data studio
                                     )
                             )
       ,@msg       NVARCHAR(1000)
       ,@exec_dttm DATETIME      = GETDATE()
SET NOCOUNT OFF
--*/

/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'',0,0) WITH NOWAIT;
   RAISERROR(N'--------- Start SQLXL Index Data Organization ----------------------------------',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END
/******************************************************************************************************************************************/

IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Compilation]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Compilation];

/******************************************************************************************************************************************/
-- CREATE - TABLE [SQLXL_Index_Compilation]
/******************************************************************************************************************************************/
CREATE TABLE [tempdb].[dbo].[SQLXL_Index_Compilation]
(collection_DTTM                            DATETIME                                    NULL -- FUTURE KEY from task start time
,product_major_version                      INT                                         NULL
,product_minor_version                      INT                                         NULL
--------------------------------------------------------------------------------------------------------------------------------------------
-- MASTER RECORD KEYS
-- rec_type is level in the collected data
-- 'A' = All or instance level
-- 'D' = is database
-- 'P' is for parent
-- 'H' for History
-- 'S' for System Internal Table
-- 'I' for "Index"
-- Object_ID is same as parent except for Foreign Key Constraints, History (CDC, SVN, LDG) tables, and System Internal Tables
-- Index Sub_Type sourced from [sys].[xml_indexes].[xml_index_type], [sys].[spatial_indexes].[spatial_index_type]
--------------------------------------------------------------------------------------------------------------------------------------------
,rec_type                                   NCHAR(1)       COLLATE DATABASE_DEFAULT NOT NULL
,database_ID                                SMALLINT                                    NULL -- KEY from [sys].[databases]
,parent_object_ID                           BIGINT                                  NOT NULL -- KEY from [sys].[objects] - Parent level
,object_ID                                  BIGINT                                  NOT NULL -- KEY from [sys].[objects] - Object level
,index_ID                                   BIGINT                                  NOT NULL -- KEY from [sys].[indexes] etc.
,type                                       NVARCHAR(2)    COLLATE DATABASE_DEFAULT NOT NULL
,sub_type                                   TINYINT                                 NOT NULL
--------------------------------------------------------------------------------------------------------------------------------------------
-- Element Names & Descriptions
--------------------------------------------------------------------------------------------------------------------------------------------
,Database_Name                              SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,collation_name                             SYSNAME        COLLATE DATABASE_DEFAULT     NULL

--------------------------------------------------------------------------------------------------------------------------------------------
-- COMPUTED Diagnostics & Actions to take by Index & Table
--------------------------------------------------------------------------------------------------------------------------------------------
,diagnostics                                NVARCHAR(MAX)  COLLATE DATABASE_DEFAULT     NULL
,prescription                               NVARCHAR(MAX)  COLLATE DATABASE_DEFAULT     NULL

---------------------------------------------------------------------------------------------
-- History source tables - source records for Change Data Capture & System-Version tables
---------------------------------------------------------------------------------------------
,history_source_schema_id                   INT                                         NULL
,history_source_schema_name                 SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,history_source_object_id                   INT                                         NULL
,history_source_object_name                 SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,history_source_object_type                 NVARCHAR(2)    COLLATE DATABASE_DEFAULT     NULL
,history_source_object_type_desc            SYSNAME        COLLATE DATABASE_DEFAULT     NULL

---------------------------------------------------------------------------------------------
-- Parent object values - from [sys].[objects] - Only different from object for INTERNAL TABLES & HISTORY TABLES
-- INTERNAL TABLES roll up to their OBJECT table, HISTORY rollup to their OBJECT table
---------------------------------------------------------------------------------------------
,parent_schema_id                           INT                                         NULL
,parent_schema_name                         SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,parent_object_name                         SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,parent_object_type                         NVARCHAR(2)    COLLATE DATABASE_DEFAULT     NULL
,parent_object_type_desc                    SYSNAME        COLLATE DATABASE_DEFAULT     NULL

-----------------------------------------------------------
-- [sys].[objects] - Object columns
-----------------------------------------------------------
,obj_name                                   SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,obj_type                                   NVARCHAR(2)    COLLATE DATABASE_DEFAULT     NULL
,obj_type_desc                              SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,obj_create_date                            DATETIME                                    NULL
,obj_modify_date                            DATETIME                                    NULL
,obj_is_published                           BIT                                     NOT NULL DEFAULT(0)
,obj_is_schema_published                    BIT                                     NOT NULL DEFAULT(0)
,obj_definition                             NVARCHAR(MAX)                               NULL

-----------------------------------------------------------
-- Object schema - [sys].[schemas]
-----------------------------------------------------------
,SCHEMA_ID                                  BIGINT                                  NOT NULL DEFAULT(0)
,SCHEMA_NAME                                SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,schema_principal_ID                        BIGINT                                      NULL

-----------------------------------------------------------
-- Object Computed values
-----------------------------------------------------------
,obj_type_hdr                               SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,obj_type_dtl                               SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,obj_type_label                             SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,obj_type_short_label                       SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,obj_principal_ID                           BIGINT                                      NULL

--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[tables], [sys].[views], [sys].[triggers] - useful to know across indexes, MIX, FKC, etc.
--------------------------------------------------------------------------------------------------------------------------------------------
,tbl_history_table_ID                       BIGINT                                      NULL
,tbl_history_table_schema                   SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,tbl_history_table_name                     SYSNAME        COLLATE DATABASE_DEFAULT     NULL

,tbl_is_replicated                          BIT                                     NOT NULL DEFAULT(0) -- used in multiple places
,tbl_lock_escalation                        TINYINT                                     NULL
,tbl_lock_escalation_desc                   SYSNAME        COLLATE DATABASE_DEFAULT     NULL

,tbl_is_memory_optimized                    BIT                                     NOT NULL DEFAULT(0)
,tbl_max_column_used_ID                     BIGINT                                      NULL
,tbl_has_unchecked_assembly_data            BIT                                     NOT NULL DEFAULT(0)
,tbl_is_filetable                           BIT                                     NOT NULL DEFAULT(0)
-----------------------------------------------------------
,tbl_row_size_byte_AVG                      FLOAT                                       NULL
-----------------------------------------------------------
,clr_trigger_CNT                            BIGINT                                  NOT NULL DEFAULT(0)
,sql_trigger_CNT                            BIGINT                                  NOT NULL DEFAULT(0)
,is_instead_of_trigger_CNT                  BIGINT                                  NOT NULL DEFAULT(0)

-----------------------------------------------------------
-- Table computed properties
-----------------------------------------------------------
,tbl_is_clustered_columnstore               BIT                                     NOT NULL DEFAULT(0)
,tbl_column_CNT                             BIGINT                                  NOT NULL DEFAULT(0)
,tbl_is_heap                                BIT                                     NOT NULL DEFAULT(0)
,tbl_is_empty                               BIT                                     NOT NULL DEFAULT(0)
,tbl_priority_metric                        FLOAT                                       NULL
,tbl_cx_uniq_ordered_column_TYP             SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,tbl_cx_uniq_ordered_column_ID              BIGINT                                      NULL
,tbl_possible_uniq_column_ID                BIGINT                                      NULL
,tbl_smallest_uniq_Nonclustered_idx         BIGINT                                      NULL

-----------------------------------------------------------
-- [cdc].[change_tables]
-----------------------------------------------------------
,cdc_capture_instance                       SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,cdc_supports_net_changes                   BIT                                         NULL
,cdc_role_name                              SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,cdc_index_name                             SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,cdc_filegroup_name                         SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,cdc_create_date                            DATETIME                                    NULL
,cdc_partition_switch                       BIT                                         NULL
,cdc_is_history_table                       BIT                                         NULL

-----------------------------------------------------------
-- [sys].[sql_modules]
-----------------------------------------------------------
,obj_uses_ansi_nulls                        BIT                                         NULL
,obj_uses_quoted_identifier                 BIT                                         NULL
,obj_is_schema_bound                        BIT                                         NULL
,obj_uses_database_collation                BIT                                         NULL
,obj_is_recompiled                          BIT                                         NULL
,obj_null_on_null_input                     BIT                                         NULL
,obj_execute_as_principal_ID                BIGINT                                      NULL
,obj_uses_native_compilation                BIT                                         NULL
,obj_is_inlineable                          BIT                                         NULL
,obj_inline_type                            BIT                                         NULL

--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[indexes] - NOTE: other elements below in Shared Elements
--------------------------------------------------------------------------------------------------------------------------------------------
,type_desc                                  SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,sub_type_desc                              SYSNAME        COLLATE DATABASE_DEFAULT     NULL
                                            -- Sources: [sys].[xml_indexes xml_index_type_description
                                            --          [sys].[spatial_indexes spatial_index_type_desc
,is_unique                                  BIT                                     NOT NULL DEFAULT(0)  -- 1 = unique
,IGNORE_DUP_KEY                             BIT                                     NOT NULL DEFAULT(0)  -- 1 = ON
,suppress_dup_key_messages                  BIT                                     NOT NULL DEFAULT(0)  -- 1 = ON
,is_primary_key                             BIT                                     NOT NULL DEFAULT(0)  -- 1 = PRIMARY KEY
,is_unique_constraint                       BIT                                     NOT NULL DEFAULT(0)  -- 1 = UNIQUE constraint
,fill_factor                                TINYINT                                     NULL             -- for creation or rebuilding
,is_padded                                  BIT                                     NOT NULL DEFAULT(0)  -- 1 = ON
,is_hypothetical                            BIT                                     NOT NULL DEFAULT(0)  -- 1 = is hypothetical
,is_ignored_in_optimization                 BIT                                     NOT NULL DEFAULT(0)  -- NOTE: not found in BOL
,ALLOW_ROW_LOCKS                            BIT                                         NULL             -- 1 = allows row locks
,ALLOW_PAGE_LOCKS                           BIT                                         NULL             -- 1 = allows page locks
,has_filter                                 BIT                                     NOT NULL DEFAULT(0)  -- 1 = has a filter
,compression_delay_mm                       BIGINT                                      NULL             -- NOTE: not found in BOL
,auto_created                               BIT                                     NOT NULL DEFAULT(0)  -- 1 = created by auto tuning
,OPTIMIZE_FOR_SEQUENTIAL_KEY                BIT                                     NOT NULL DEFAULT(0)  -- 1 = last-page insert opt enabled

--------------------------------------------------------------------------------------------------------------------------------------------
-- Shared elements index & parent
-- parent_id INT excluded because same as [sys].[objects] columns [history_source_object_id] for SVN & [parent_object_id]
-- Sources: [sys].[internal_tables], [sys].[triggers]
--------------------------------------------------------------------------------------------------------------------------------------------
,NAME                                       SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,type_short_desc                            SYSNAME        COLLATE DATABASE_DEFAULT     NULL
                                            -- Sources: [sys].[indexes]
                                            --          [sys].[xml_indexes] xml_index_type_description
,is_disabled                                BIT                                     NOT NULL DEFAULT(0)
                                            -- Sources: [sys].[indexes],[sys].foreign_keys
                                            --          [sys].[fulltext_indexes] is_enabled (note value IS flipped)
,is_not_trusted                             BIT                                     NOT NULL DEFAULT(0)
                                            -- Sources: [sys].[edge_constraints], [sys].[foreign_keys], [sys].[check_constraints]
,is_system_named                            BIT                                     NOT NULL DEFAULT(0)
                                            -- Sources: [sys].[edge_constraints], [sys].[foreign_keys], [sys].[check_constraints]
                                            --          [sys].[default_constraints], [sys].[key_constraints]
,filter_definition                          NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
                                            -- Sources: [sys].[indexes], [sys].[xml_indexes].[filter_definition]

-----------------------------------------------------------
-- [sys].[internal_tables] & ms_shipped objects
-----------------------------------------------------------
,is_ms_shipped                              BIT                                         NULL
,internal_type                              TINYINT                                     NULL
,internal_type_DESC                         SYSNAME                                     NULL
,parent_minor_ID                            BIGINT                                      NULL

-----------------------------------------------------------
-- [sys].[xml_indexes]
-----------------------------------------------------------
,xml_index_type                             TINYINT                                     NULL
,xml_index_type_description                 SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,xml_using_xml_index_ID                     BIGINT                                      NULL
,xml_secondary_type                         CHAR(1)                                     NULL
,xml_secondary_type_desc                    SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,xml_path_ID                                BIGINT                                      NULL

-----------------------------------------------------------
-- [sys].[spatial_indexes]
-----------------------------------------------------------
,si_tessellation_scheme                     SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,si_bounding_box_xmin                       FLOAT                                       NULL
,si_bounding_box_ymin                       FLOAT                                       NULL
,si_bounding_box_xmax                       FLOAT                                       NULL
,si_bounding_box_ymax                       FLOAT                                       NULL
,si_level_1_grid_desc                       NVARCHAR(120)  COLLATE DATABASE_DEFAULT     NULL
,si_level_2_grid_desc                       NVARCHAR(120)  COLLATE DATABASE_DEFAULT     NULL
,si_level_3_grid_desc                       NVARCHAR(120)  COLLATE DATABASE_DEFAULT     NULL
,si_level_4_grid_desc                       NVARCHAR(120)  COLLATE DATABASE_DEFAULT     NULL
,si_cells_per_object                        BIGINT                                      NULL

-----------------------------------------------------------
-- [sys].[hash_indexes]
-----------------------------------------------------------
,hi_bucket_CNT                              BIGINT                                  NOT NULL DEFAULT(0)

-----------------------------------------------------------
-- [sys].[fulltext_indexes]
-----------------------------------------------------------
,ftx_unique_index_ID                        BIGINT                                      NULL
,ftx_fulltext_catalog_ID                    BIGINT                                      NULL
,ftx_fulltext_catalog_name                  SYSNAME                                     NULL
,ftx_change_tracking_state                  CHAR(1)        COLLATE DATABASE_DEFAULT     NULL
,ftx_change_tracking_state_desc             SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,ftx_has_crawl_completed                    BIT                                         NULL
,ftx_crawl_type                             CHAR(1)        COLLATE DATABASE_DEFAULT     NULL
,ftx_crawl_type_desc                        SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,ftx_crawl_start_date                       DATETIME                                    NULL
,ftx_crawl_end_date                         DATETIME                                    NULL
--,ftx_incremental_timestamp                DATETIME                                    NULL -- OMITTED. binary data type, which represents a rowversion
,ftx_stoplist_ID                            BIGINT                                      NULL
,ftx_property_list_ID                       BIGINT                                      NULL

--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[foreign_keys]
--------------------------------------------------------------------------------------------------------------------------------------------
,fkc_referenced_object_ID                   BIGINT                                      NULL
,fkc_referenced_index_ID                    BIGINT                                      NULL -- ID of key index supporting referenced object
,fkc_reference                              NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
,fkc_is_not_for_replication                 BIT                                         NULL
,fkc_delete_referential_action              TINYINT                                     NULL
,fkc_delete_referential_action_desc         SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,fkc_update_referential_action              TINYINT                                     NULL
,fkc_update_referential_action_desc         SYSNAME        COLLATE DATABASE_DEFAULT     NULL
-----------------------------------------------------------
-- derived values for Foreign Key Constraints - index(es) covering Foreign Key Constraint, non-filtered, in order of enabled, shortest
-----------------------------------------------------------
,fkc_covering_primary_idx_name              SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,fkc_covering_primary_idx_ID                BIGINT                                      NULL
,fkc_covering_primary_idx_Type              NVARCHAR(2)    COLLATE DATABASE_DEFAULT     NULL
,fkc_covered_by_idx_IDS                     NVARCHAR(1000) COLLATE DATABASE_DEFAULT     NULL -- list of all covering indexes
--------------------------------------------
,fkc_candidate_covering_MIX_CNT             BIGINT                                  NOT NULL DEFAULT(0)
,fkc_candidate_covering_MIX_ID              BIGINT                                      NULL
--------------------------------------------
-- Referenced Key information
--------------------------------------------
,rk_referencing_fkc_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_disabled_CNT            BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_not_replicated_CNT      BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_not_trusted_CNT         BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_action_none_CNT         BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_action_cascade_CNT      BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_action_null_CNT         BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_action_default_CNT      BIGINT                                  NOT NULL DEFAULT(0)
,rk_referencing_fkc_system_named_CNT        BIGINT                                  NOT NULL DEFAULT(0)

--------------------------------------------------------------------------------------------------------------------------------------------
-- Missing index details. See index_Usage_Stats (IUS_*) for remainder of Missing Index columns
--------------------------------------------------------------------------------------------------------------------------------------------
,mix_avg_total_user_cost_AMT                FLOAT                                       NULL
,mix_avg_total_system_cost_AMT              FLOAT                                       NULL
,mix_avg_user_impact_AMT                    FLOAT                                       NULL
,mix_avg_system_impact_AMT                  FLOAT                                       NULL
,mix_unique_compiles_CNT                    BIGINT                                      NULL
,mix_Advantage_AMT                          FLOAT                                       NULL
,mix_Advantage_weighted_AMT                 FLOAT                                       NULL
                                            -- computed  (((i.user_seeks  + i.user_scans) * i.avg_total_user_cost * i.avg_user_impact  )
                                            --         + ((i.system_seeks + i.system_scans) * i.avg_total_system_cost * i.avg_system_impact))
-----------------------------------------------------------
-- missing_index_group_stats_query
-- NOTE: since this should total to the existing MISSING index values omitting for this version of XLNSQL_Index
-----------------------------------------------------------
--,mqy_user_seeks_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
--,mqy_user_scans_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
--,mqy_last_user_seek_DTTM                    DATETIME                                    NULL
--,mqy_last_user_scan_DTTM                    DATETIME                                    NULL
--,mqy_system_seeks_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
--,mqy_system_scans_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
--,mqy_last_system_seek_DTTM                  DATETIME                                    NULL
--,mqy_last_system_scan_DTTM                  DATETIME                                    NULL
--,mqy_Advantage_AMT                          FLOAT                                   NOT NULL DEFAULT(0)
--,mqy_query_hash                             BINARY(8)                               NOT NULL DEFAULT(0)
--,mqy_query_plan_hash                        BINARY(8)                               NOT NULL DEFAULT(0)
--,mqy_last_sql_handle                        VARBINARY(64)                           NOT NULL DEFAULT(0)
--,mqy_last_statement_start_offset            BIGINT                                  NOT NULL DEFAULT(0)
--,mqy_last_statement_end_offset              BIGINT                                  NOT NULL DEFAULT(0)
--,mqy_last_statement_sql_handle              VARBINARY(64)                           NOT NULL DEFAULT(0)
,mqy_query_text                             NVARCHAR(MAX)  COLLATE DATABASE_DEFAULT     NULL
,mqy_query_plan                             XML                                         NULL

--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[stats]
--------------------------------------------------------------------------------------------------------------------------------------------
,stats_ID                                   BIGINT                                      NULL
,stats_Name                                 NVARCHAR(132) COLLATE DATABASE_DEFAULT      NULL 
                                            -- FUTURE - accomodate multiple statistic names for index key & included columns too
,stats_auto_created                         BIT                                         NULL
,stats_user_created                         BIT                                         NULL
,stats_no_recompute                         BIT                                         NULL
,stats_has_filter                           BIT                                         NULL
,stats_filter_definition                    NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
,stats_is_temporary                         BIT                                         NULL
,stats_is_incremental                       BIT                                         NULL
,stats_has_persisted_sample                 BIT                                         NULL
,stats_generation_method                    BIGINT                                      NULL
,stats_generation_method_desc               SYSNAME        COLLATE DATABASE_DEFAULT     NULL
-----------------------------------------------------------
-- ShowStatistics.StatHeader
-----------------------------------------------------------
,stathdr_Updated                            DATETIME                                    NULL
,stathdr_Rows_CNT                           BIGINT                                  NOT NULL DEFAULT(0)
,stathdr_Rows_Sampled_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
,stathdr_Steps                              BIGINT                                  NOT NULL DEFAULT(0)
,stathdr_Density                            FLOAT                                   NOT NULL DEFAULT(0)
,stathdr_Average_Key_Length                 BIGINT                                  NOT NULL DEFAULT(0)
,stathdr_String_index                       NVARCHAR(3)    COLLATE DATABASE_DEFAULT     NULL
,stathdr_Filter_Expression                  NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
,stathdr_Unfiltered_Rows                    BIGINT                                  NOT NULL DEFAULT(0)
,stathdr_Persisted_Sample_Percent           TINYINT                                 NOT NULL DEFAULT(0)
,stathdr_Statistics_age_days                BIGINT                                      NULL
-----------------------------------------------------------
-- ShowStatistics.StatHistogram
-----------------------------------------------------------
,stathist_range_rows_LO                     FLOAT                                   NOT NULL DEFAULT(0)
,stathist_range_rows_HI                     FLOAT                                   NOT NULL DEFAULT(0)
,stathist_null_rows                         BIGINT                                  NOT NULL DEFAULT(0)
,stathist_param_sniff                       FLOAT                                   NOT NULL DEFAULT(0)
-----------------------------------------------------------
-- [sys].[dm_db_stats_properties] -- Note: [sys].[dm_db_stats_properties] only used for modification_counter
-----------------------------------------------------------
,Stats_Prop_modification_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,Stats_Prop_last_updated                    DATETIME                                    NULL
,Stats_Prop_updated_days_ago                BIGINT                                      NULL

----------------------------------------------------------------------------------------------------------
-- Aggregate Operational Metrics Values
-- [sys].[dm_db_index_operational_stats] + [sys].[dm_db_xtp_index_stats] + [sys].[dm_db_xtp_Nonclustered_index_stats]
----------------------------------------------------------------------------------------------------------
,ops_total_contacts_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
   -- includes XTP scans_started,row_insert_attempts,row_update_attempts,row_delete_attempts,delta_pages,page_update_count
   -- includes columnstore - scan_CNT, delete_buffer_scan_CNT,row_group_lock_CNT
,ops_total_read_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP scans_started
   -- Includes columnstore - scan_CNT, delete_buffer_scan_CNT
,ops_total_write_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
   -- Include XTP - row_insert_attempts, row_update_attempts, row_delete_attempts, delta_pages, page_update_count
   -- included columnstore row_group_lock_CNT
,ops_total_insert_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP row_insert_attempts
,ops_total_update_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP -row_update_attempts,p age_update_count
,ops_total_delete_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP row_delete_attempts
,ops_total_scan_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP -scans_started, columnstore scan_CNT
,ops_total_scan_retries_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP -scans_started, columnstore scan_CNT
,ops_total_page_split_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
   -- Includes XTP - page_split_count, key_split_count
,ops_total_page_merge_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes XTP - page_merge_count, key_merge_count & page_consolidation_count
,ops_total_wait_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes
,ops_total_wait_MS_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes
,ops_total_wait_MS_AVG                      FLOAT                                       NULL
 -- Includes
,ops_no_read_total_write_CNT                BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes
,ops_total_lock_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
   -- includes columnstore row_group_lock_CNT
,ops_total_lock_wait_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
   -- includes [dm_db_column_store_row_group_operational_stats].row_group_lock_wait_CNT
,ops_total_lock_wait_MS_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
   -- includes [dm_db_column_store_row_group_operational_stats].row_group_lock_wait_MS_CNT
,ops_total_lock_wait_MS_AVG                 FLOAT                                       NULL
   -- includes [dm_db_column_store_row_group_operational_stats].row_group_lock_wait_CNT
   --         ,dm_db_column_store_row_group_operational_stats.row_group_lock_wait_MS_CNT

--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[dm_db_index_operational_stats] + [sys].[dm_db_xtp_index_stats] + [sys].[dm_db_xtp_Nonclustered_index_stats]
--------------------------------------------------------------------------------------------------------------------------------------------
,ios_total_Column_value_off_row_CNT         BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_partition_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_leaf_insert_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
,ios_leaf_update_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
,ios_leaf_delete_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
,ios_leaf_ghost_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,ios_total_leaf_Contacts_CNT                BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_nonleaf_insert_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,ios_nonleaf_delete_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,ios_nonleaf_update_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,ios_total_nonleaf_Contacts_CNT             BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_leaf_allocation_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,ios_nonleaf_allocation_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_leaf_page_merge_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,ios_nonleaf_page_merge_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_range_scan_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,ios_singleton_lookup_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
,ios_forwarded_fetch_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_lob_fetch_pages_CNT                    BIGINT                                  NOT NULL DEFAULT(0) -- Cumulative count of large object (LOB) pages retrieved from the LOB_DATA allocation unit
,ios_lob_fetch_bytes_CNT                    BIGINT                                  NOT NULL DEFAULT(0) -- Cumulative count of LOB data bytes retrieved
,ios_lob_orphan_create_CNT                  BIGINT                                  NOT NULL DEFAULT(0) -- Cumulative count of orphan LOB values created for bulk operations
,ios_lob_orphan_insert_CNT                  BIGINT                                  NOT NULL DEFAULT(0) -- Cumulative count of orphan LOB values inserted during bulk operations.
,ios_row_overflow_fetch_in_pages_CNT        BIGINT                                  NOT NULL DEFAULT(0)
,ios_row_overflow_fetch_in_bytes_CNT        BIGINT                                  NOT NULL DEFAULT(0)
,ios_column_value_push_off_row_CNT          BIGINT                                  NOT NULL DEFAULT(0)
,ios_column_value_pull_in_row_CNT           BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_row_lock_CNT                           BIGINT                                  NOT NULL DEFAULT(0)
,ios_row_lock_wait_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,ios_row_lock_wait_MS_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
,ios_row_lock_wait_MS_AVG                   FLOAT                                       NULL
-------------------------------------
,ios_page_lock_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_lock_wait_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_lock_wait_MS_CNT                  BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_lock_wait_MS_AVG                  FLOAT                                       NULL
-------------------------------------
,ios_lock_promotion_attempt_CNT             BIGINT                                  NOT NULL DEFAULT(0)
,ios_lock_promotion_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,ios_lock_promotion_fail_CNT                BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
,ios_page_latch_wait_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_latch_wait_MS_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_latch_wait_MS_AVG                 FLOAT                                       NULL
-------------------------------------
,ios_page_io_latch_wait_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_io_latch_wait_MS_CNT              BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_io_latch_wait_MS_AVG              FLOAT                                       NULL
-------------------------------------
,ios_tree_page_latch_wait_CNT               BIGINT                                  NOT NULL DEFAULT(0) -- Subset of ios_page_latch_wait_CNT
,ios_tree_page_latch_wait_MS_CNT            BIGINT                                  NOT NULL DEFAULT(0) -- Subset of ios_page_latch_wait_MS_CNT
,ios_tree_page_latch_wait_MS_AVG            FLOAT                                       NULL            -- Subset of ios_page_latch_wait_MS_AVG
-------------------------------------
,ios_tree_page_io_latch_wait_CNT            BIGINT                                  NOT NULL DEFAULT(0) -- Subset of ios_page_io_latch_wait_CNT
,ios_tree_page_io_latch_wait_MS_CNT         BIGINT                                  NOT NULL DEFAULT(0) -- Subset of ios_page_io_latch_wait_MS_CNT
,ios_tree_page_io_latch_wait_MS_AVG         FLOAT                                       NULL            -- Subset of ios_page_io_latch_wait_MS_AVG
-------------------------------------
,ios_page_compression_attempt_CNT           BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_compression_success_CNT           BIGINT                                  NOT NULL DEFAULT(0)
,ios_page_compression_fail_CNT              BIGINT                                  NOT NULL DEFAULT(0)
-------------------------------------
-- New for 2019
-------------------------------------
,ios_version_generated_inrow_CNT            BIGINT                                  NOT NULL DEFAULT(0) -- In-row version records retained by Snapshot isolation
,ios_version_generated_off_row_CNT          BIGINT                                  NOT NULL DEFAULT(0) -- off_row version records retained by Snapshot isolation
,ios_ghost_version_inrow_CNT                BIGINT                                  NOT NULL DEFAULT(0) -- Ghost in-row version records retained by Snapshot isolation
,ios_ghost_version_off_row_CNT              BIGINT                                  NOT NULL DEFAULT(0) -- Ghost off_row version records retained by Snapshot isolation
,ios_insert_over_ghost_version_inrow_CNT    BIGINT                                  NOT NULL DEFAULT(0) -- Inserts over Ghost in-row version records retained by Snapshot isolation
,ios_insert_over_ghost_version_off_row_CNT  BIGINT                                  NOT NULL DEFAULT(0) -- Inserts over Ghost off_row version records retained by Snapshot isolation

--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[dm_db_index_usage_stats] + [sys].[dm_db_missing_index_group_stats] for missing indexes
--------------------------------------------------------------------------------------------------------------------------------------------
,ius_user_total_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,ius_user_read_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
,ius_user_seeks_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
                                            -- includes: [sys].[dm_db_missing_index_group_stats] user_seeks
,ius_user_scans_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
                                            -- includes: [sys].[dm_db_missing_index_group_stats] user_scans
,ius_user_lookups_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
,ius_user_updates_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
,ius_system_seeks_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
                                            -- includes: [sys].[dm_db_missing_index_group_stats] system_seeks
,ius_system_scans_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
                                            -- includes: [sys].[dm_db_missing_index_group_stats] system_scans
,ius_system_lookups_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,ius_system_updates_CNT                     BIGINT                                  NOT NULL DEFAULT(0)

,ius_last_user_seek_DTTM                    DATETIME                                    NULL
                                            -- includes: [sys].[dm_db_missing_index_group_stats] last_user_seek
,ius_last_user_scan_DTTM                    DATETIME                                    NULL
                                            -- includes: [sys].[dm_db_missing_index_group_stats] last_user_scan
,ius_last_user_lookup_DTTM                  DATETIME                                    NULL
,ius_last_user_update_DTTM                  DATETIME                                    NULL

,ius_last_system_seek_DTTM                  DATETIME                                    NULL
                                            -- includes: [sys].[dm_db_missing_index_group_stats] last_system_seek
,ius_last_system_scan_DTTM                  DATETIME                                    NULL
                                            -- includes: [sys].[dm_db_missing_index_group_stats] last_system_scan
,ius_last_system_lookup_DTTM                DATETIME                                    NULL
,ius_last_system_update_DTTM                DATETIME                                    NULL
----------------------------
,ius_no_read_user_updates_CNT               BIGINT                                  NOT NULL DEFAULT(0)
,ius_last_read_days_ago                     BIGINT                                      NULL
,ius_last_write_days_ago                    BIGINT                                      NULL

--------------------------------------------------------------------------------------------------------------------------------------------
-- Column Store - [sys].[dm_db_column_store_row_group_operational_stats]
--------------------------------------------------------------------------------------------------------------------------------------------
,cs_partition_CNT                           BIGINT                                  NOT NULL DEFAULT(0)
,cs_row_group_CNT                           BIGINT                                  NOT NULL DEFAULT(0)
,cs_index_scan_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
,cs_scan_CNT                                BIGINT                                  NOT NULL DEFAULT(0)
,cs_delete_buffer_scan_CNT                  BIGINT                                  NOT NULL DEFAULT(0)
,cs_row_group_lock_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,cs_row_group_lock_wait_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
,cs_row_group_lock_wait_MS_CNT              BIGINT                                  NOT NULL DEFAULT(0)
,cs_row_group_lock_wait_MS_AVG              FLOAT                                       NULL
,cs_returned_row_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
,cs_returned_aggregate_CNT                  BIGINT                                  NOT NULL DEFAULT(0)
,cs_returned_group_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,cs_input_groupby_row_CNT                   BIGINT                                  NOT NULL DEFAULT(0)

--------------------------------------------------------------------------------------------------------------------------------------------
-- XTP In-Memory tables & indexes - [sys].[dm_db_xtp_index_stats],[sys].[dm_db_xtp_Nonclustered_index_stats],[sys].[dm_db_xtp_memory_consumers]
--------------------------------------------------------------------------------------------------------------------------------------------
-- [sys].[dm_db_xtp_object_stats] -------------
,xtp_row_insert_attempts_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,xtp_row_update_attempts_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,xtp_row_delete_attempts_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,xtp_write_conflicts_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,xtp_unique_constraint_violations_CNT       BIGINT                                  NOT NULL DEFAULT(0)
-- [sys].[dm_db_xtp_index_stats] --------------
,xtp_object_ID                              INT                                         NULL
,xtp_scans_started_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,xtp_scans_retries_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,xtp_rows_returned_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,xtp_rows_touched_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
-- [sys].[dm_db_xtp_Nonclustered_index_stats] -
,xtp_delta_pages_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
,xtp_leaf_pages_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_update_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_update_retry_CNT                  BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_consolidation_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_consolidation_retry_CNT           BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_split_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_split_retry_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
,xtp_key_split_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
,xtp_key_split_retry_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_merge_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,xtp_page_merge_retry_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
,xtp_key_merge_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
,xtp_key_merge_retry_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,xtp_uses_key_normalization                 BIT                                     NOT NULL DEFAULT(0)
-- [sys].[dm_db_xtp_memory_consumers] ---------
,xtp_allocated_bytes_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,xtp_used_bytes_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,xtp_allocation_CNT                         BIGINT                                  NOT NULL DEFAULT(0)

-------------------------------------------------------------------------------------------------------------
-- Shared - [sys].[dm_db_partition_stats], [sys].[dm_db_xtp_memory_consumers]
-------------------------------------------------------------------------------------------------------------
,row_CNT                                    BIGINT                                  NOT NULL DEFAULT(0)
,reserved_page_PG_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes XTP allocated_bytes/8192.0
,used_page_PG_CNT                           BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes XTP CEILING(used_bytes/8192.0)
,in_row_data_page_PG_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,in_row_used_page_PG_CNT                    BIGINT                                  NOT NULL DEFAULT(0)
,in_row_reserved_page_PG_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,lob_used_page_PG_CNT                       BIGINT                                  NOT NULL DEFAULT(0)
,lob_reserved_page_PG_CNT                   BIGINT                                  NOT NULL DEFAULT(0)
,row_overflow_used_page_PG_CNT              BIGINT                                  NOT NULL DEFAULT(0)
,row_overflow_reserved_page_PG_CNT          BIGINT                                  NOT NULL DEFAULT(0)

-----------------------------------------------------------
-- Index Data Space, filegroup
-----------------------------------------------------------
,data_space_ID                              BIGINT                                      NULL
                                            -- ID of the data space for this index. Data space is either a filegroup or partition scheme
                                            -- 0 = object_ID is a table-valued function or in-memory index
                                            -- Also sys,fulltext_indexes.data_space_ID
,data_space_name                            SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,data_space_logical_filename                SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,data_space_type                            NVARCHAR(2)    COLLATE DATABASE_DEFAULT     NULL
,data_space_type_desc                       SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,data_space_is_default                      BIT                                     NOT NULL DEFAULT(0)
,data_space_is_system                       BIT                                     NOT NULL DEFAULT(0)
,filegroup_guid                             UNIQUEIDENTIFIER                            NULL
,filegroup_is_read_only                     BIT                                     NOT NULL DEFAULT(0)
,filegroup_is_autogrow_all_files            BIT                                     NOT NULL DEFAULT(0)

-----------------------------------------------------------
-- Index Partition Info
-----------------------------------------------------------
,partition_CNT                              BIGINT                                  NOT NULL DEFAULT(0)
,partition_Column_ID                        BIGINT                                      NULL
,partition_Column_Name                      SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,partition_schemes_function_ID              BIGINT                                      NULL
,partition_schemes_name                     SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,partition_function_ID                      BIGINT                                      NULL
,partition_function_name                    SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,partition_function_type                    NVARCHAR(2)    COLLATE DATABASE_DEFAULT     NULL
,partition_function_type_desc               SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,partition_function_fanout                  BIGINT                                      NULL
,partition_function_boundary_value          NVARCHAR(5)    COLLATE DATABASE_DEFAULT     NULL
,partition_function_is_system               BIT                                         NULL
,partition_function_create_DTTM             DATETIME                                    NULL
,partition_function_modify_DTTM             DATETIME                                    NULL

-----------------------------------------------------------
-- Index Partition Compression
-----------------------------------------------------------
,Partition_none_compress_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,Partition_row_compress_CNT                 BIGINT                                  NOT NULL DEFAULT(0)
,Partition_page_compress_CNT                BIGINT                                  NOT NULL DEFAULT(0)
,Partition_columnstore_compress_CNT         BIGINT                                  NOT NULL DEFAULT(0)
,Partition_columnstore_archive_compress_CNT BIGINT                                  NOT NULL DEFAULT(0)
,Partition_xml_compress_CNT                 BIGINT                                  NOT NULL DEFAULT(0)

-----------------------------------------------------------
-- [sys].[dm_os_buffer_descriptors]
-----------------------------------------------------------
,buffer_total_KB_CNT                        BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes XTP allocated_bytes/1024.0
,buffer_free_KB_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
 -- Includes (allocated_bytes - used_bytes)/1024.0

-----------------------------------------------------------
-- Computed/derived Values
-----------------------------------------------------------
,key_column_IDs                             NVARCHAR(1000) COLLATE DATABASE_DEFAULT     NULL -- concatenated key ordered list of column IDs
,covered_fkc_IDs                            NVARCHAR(1000) COLLATE DATABASE_DEFAULT     NULL -- list of FKs covered by this index
--------------------------------------------
,index_CNT                                  BIGINT                                  NOT NULL DEFAULT(0)
,heap_index_CNT                             BIGINT                                  NOT NULL DEFAULT(0)
,Clustered_index_CNT                        BIGINT                                  NOT NULL DEFAULT(0) -- no _CNT only 1 per table
,Nonclustered_index_CNT                     BIGINT                                  NOT NULL DEFAULT(0)
,XML_index_CNT                              BIGINT                                  NOT NULL DEFAULT(0)
,Spatial_index_CNT                          BIGINT                                  NOT NULL DEFAULT(0)
,Clustered_ColumnStore_CNT                  BIGINT                                  NOT NULL DEFAULT(0)
,Nonclustered_ColumnStore_CNT               BIGINT                                  NOT NULL DEFAULT(0)
,Nonclustered_Hash_CNT                      BIGINT                                  NOT NULL DEFAULT(0)
,Fulltext_index_CNT                         BIGINT                                  NOT NULL DEFAULT(0)
,Missing_index_CNT                          BIGINT                                  NOT NULL DEFAULT(0) -- used for TABLES
,fkc_missing_index_CNT                      BIGINT                                  NOT NULL DEFAULT(0) -- used for FKC
,Foreign_Key_CNT                            BIGINT                                  NOT NULL DEFAULT(0)
,Relates_Fulltext_index_ID                  BIGINT                                      NULL
--------------------------------------------
,key_total_datatype_length_bytes            BIGINT                                      NULL
,inc_total_datatype_length_bytes            BIGINT                                      NULL
,idx_total_datatype_length_bytes            BIGINT                                      NULL
,Key_Columns_CNT                            BIGINT                                  NOT NULL DEFAULT(0)
,Included_Columns_CNT                       BIGINT                                  NOT NULL DEFAULT(0)

,Stats_CNT                                  BIGINT                                  NOT NULL DEFAULT(0)
,is_activity_for_period                     TINYINT                                     NULL
,low_selectivity_additional_keys            NVARCHAR(200)  COLLATE DATABASE_DEFAULT     NULL

-----------------------------------------------------------
--
-----------------------------------------------------------
,Element_Uniqueness                         NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
,Density                                    FLOAT                                   NOT NULL DEFAULT(0)

-----------------------------------------------------------
--
-----------------------------------------------------------
,key_column_info                            NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
,Included_column_info                       NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL

,key_element_length                         NVARCHAR(1000) COLLATE DATABASE_DEFAULT     NULL -- shows increasing length of each key element
                                                                                             -- 249 max columns in index

,Lead_Element_Column_ID                     SMALLINT                                    NULL
,Lead_Element_Uniqueness                    FLOAT                                       NULL
,Lead_Element_Max_Len                       SMALLINT                                    NULL
,Lead_Element_Data_Type                     SYSNAME        COLLATE DATABASE_DEFAULT     NULL
,Lead_Element_is_Identity                   BIT                                     NOT NULL DEFAULT(0)
,Lead_Element_is_Sequence                   BIT                                     NOT NULL DEFAULT(0)
,Lead_Element_is_newsequentialid            BIT                                     NOT NULL DEFAULT(0)
,Lead_Element_is_newid                      BIT                                     NOT NULL DEFAULT(0)
,Lead_Element_is_Nullable                   BIT                                     NOT NULL DEFAULT(0)

-----------------------------------------------------------
-- Computed Ratios
-----------------------------------------------------------
,ius_read_to_write_RAT                      FLOAT                                       NULL
,ops_read_to_write_RAT                      FLOAT                                       NULL
,page_lock_to_row_lock_RAT                  FLOAT                                       NULL

,ius_scans_to_read_PCT                      FLOAT                                       NULL
,ius_lookups_to_read_PCT                    FLOAT                                       NULL
,ius_seeks_to_read_PCT                      FLOAT                                       NULL
,ius_read_to_parent_PCT                     FLOAT                                       NULL
,ius_write_to_parent_PCT                    FLOAT                                       NULL
,ius_write_to_instance_PCT                  FLOAT                                       NULL

,ops_scans_to_read_PCT                      FLOAT                                       NULL
,ios_singleton_lookup_to_read_PCT           FLOAT                                       NULL
,ios_forwarded_fetch_to_read_PCT            FLOAT                                       NULL
,ops_read_to_parent_PCT                     FLOAT                                       NULL
,ops_write_to_parent_PCT                    FLOAT                                       NULL
,ops_write_to_instance_PCT                  FLOAT                                       NULL
,page_splits_to_write_PCT                   FLOAT                                       NULL
,page_merge_to_write_PCT                    FLOAT                                       NULL
,ios_page_compression_fail_PCT              FLOAT                                       NULL

,used_pages_in_buffer_PCT                   FLOAT                                       NULL
,free_pages_in_buffer_PCT                   FLOAT                                       NULL

,xtp_page_update_retry_PCT                  FLOAT                                       NULL
,xtp_page_consolidation_retry_PCT           FLOAT                                       NULL
,xtp_page_split_retry_PCT                   FLOAT                                       NULL
,xtp_key_split_retry_PCT                    FLOAT                                       NULL
,xtp_page_merge_retry_PCT                   FLOAT                                       NULL
,xtp_key_merge_retry_PCT                    FLOAT                                       NULL

-----------------------------------------------------------
-- Overlappers
-----------------------------------------------------------
,Overlap_Code                               NVARCHAR(800)  COLLATE DATABASE_DEFAULT     NULL -- keys common across "indexes", w/o includes
,constraints                                NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
,extended_properties                        NVARCHAR(4000) COLLATE DATABASE_DEFAULT     NULL
) WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Created Creating table of consolidated index properties and attributes '
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Insert - [SQLXL_Index_Compilation] - indexes, Internal indexes, Table-valued ftns, Foreign Key Constraints, Views indexes (heap if none)
/******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type
      ,database_id
      ---------------------
      ,history_source_object_id
      ,parent_object_id
      ---------------------
      ,object_id
      ,obj_name
      ,obj_principal_ID
      ,obj_type
      ,obj_type_desc
      ,obj_create_date
      ,obj_modify_date
      ,obj_is_published
      ,obj_is_schema_published
      ---------------------
      ,collection_DTTM
      ----------------------------------------------------------------------------------------------------
      ,index_id
      ,name
      ,type
      ,type_desc
      ,type_short_desc
      ,is_unique
      ,data_space_id
      ,ignore_dup_key
      ,is_primary_key
      ,is_unique_constraint
      ,fill_factor
      ,is_padded
      ,is_disabled
      ,is_hypothetical
      ,allow_row_locks
      ,allow_page_locks
      ,has_filter
      ,filter_definition
      ---------------------
      ,Partition_Column_ID
      ,Partition_Column_Name
      ---------------------
      ,compression_delay_mm
      ,is_ignored_in_optimization
      ,suppress_dup_key_messages
      ,auto_created
      ,optimize_for_sequential_key
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables & objects - [sys].[internal_tables]
      ----------------------------------------------------------------------------------------------------
      ,is_ms_shipped
      ,internal_type
      ,internal_type_desc
      ,parent_minor_id
      -------------------------
      ,sub_type
      ,sub_type_desc
      ----------------------------------------------------------------------------------------------------
      -- [sys].[xml_indexes]
      ----------------------------------------------------------------------------------------------------
      ,xml_index_type
      ,xml_index_type_description
      ,xml_using_xml_index_id
      ,xml_secondary_type
      ,xml_secondary_type_desc
      ,xml_path_id
      ----------------------------------------------------------------------------------------------------
      -- [sys].[spatial_indexes]
      ----------------------------------------------------------------------------------------------------
      ,si_tessellation_scheme
      ,si_bounding_box_xmin
      ,si_bounding_box_ymin
      ,si_bounding_box_xmax
      ,si_bounding_box_ymax
      ,si_level_1_grid_desc
      ,si_level_2_grid_desc
      ,si_level_3_grid_desc
      ,si_level_4_grid_desc
      ,si_cells_per_object
      ----------------------------------------------------------------------------------------------------
      -- [sys].[hash_indexes]
      ----------------------------------------------------------------------------------------------------
      ,hi_bucket_CNT
      ----------------------------------------------------------------------------------------------------
      -- [sys].[foreign_keys]
      ----------------------------------------------------------------------------------------------------
      ,fkc_referenced_object_ID
      ,fkc_referenced_index_ID
      ,fkc_is_not_for_replication
      ,fkc_delete_referential_action
      ,fkc_delete_referential_action_desc
      ,fkc_update_referential_action
      ,fkc_update_referential_action_desc
      ----------------------------------------------------------------------------------------------------
      -- [sys].[dm_os_buffer_descriptors]
      ----------------------------------------------------------------------------------------------------
      ,buffer_total_KB_CNT
      ,buffer_free_KB_CNT
      ----------------------------------------------------------------------------------------------------
      -- Object Computed/derived Values
      ----------------------------------------------------------------------------------------------------
      ,is_system_named
      ,index_CNT
      ,heap_index_CNT
      ,Clustered_index_CNT
      ,Nonclustered_index_CNT
      ,XML_index_CNT
      ,Spatial_index_CNT
      ,Clustered_ColumnStore_CNT
      ,Nonclustered_ColumnStore_CNT
      ,Nonclustered_Hash_CNT
      ,Fulltext_index_CNT
      ,Missing_index_CNT
      ,Foreign_Key_CNT
)
SELECT rec_type                          = N'I'
      ,database_id                       = o.database_id
      ---------------------
      ,history_source_object_id          = o.history_source_object_id
      ,parent_object_id                  = COALESCE(o.history_source_object_id,o.parent_object_id)
      ---------------------
      ,object_id                         = o.object_id
      ,obj_name                          = o.name
      ,obj_principal_ID                  = o.principal_ID
      ,obj_type                          = o.type
      ,obj_type_desc                     = o.type_desc
      ,obj_create_date                   = o.create_date
      ,obj_modify_date                   = o.modify_date
      ,obj_is_published                  = o.is_published
      ,obj_is_schema_published           = o.is_schema_published
      ---------------------
      ,collection_DTTM                   = p.collection_DTTM
      -----------------------------------------------------------------------------------------------------
      -- Index info consolidated
      -- NOTE: SQL_INLINE_TABLE_VALUED_FUNCTION have no index records
      -----------------------------------------------------------------------------------------------------
      ,index_id                          = CASE -- Missing indexes handled in INSERT MISSING INDEX code below
                                                WHEN o.type IN (N'F')                  THEN o.object_id
                                                                                            -- Foreign KEY "index" ID is same as OBJECT ID
                                                WHEN o.type IN (N'IT',N'TF',N'U',N'V') THEN COALESCE(i.index_id,0)
                                                                                            -- if no index defaults to a HEAP
                                                WHEN o.type IN (N'FT',N'IF')           THEN COALESCE(i.index_id,o.object_id)
                                                                                            -- non-SQL TVF
                                                ELSE NULL
                                           END
      ,name                              = COALESCE(i.name,i.type_desc,o.name)
      ,type                              = COALESCE(i.type,CASE o.type
                                                                WHEN N'V'  THEN N'V' -- unindexed view type
                                                                WHEN N'IF' THEN N'0' -- undeclared table valued function
                                                                ELSE o.type
                                                           END)
      ,type_desc                         = COALESCE(i.type_desc,o.type_desc,N'HEAP')
      ,type_short_desc                   = CASE COALESCE(i.type,o.type,N'0')
                                                WHEN N'0'  THEN N'HP'
                                                WHEN N'1'  THEN N'CX'
                                                WHEN N'2'  THEN N'NCX'
                                                WHEN N'3'  THEN N'XML'
                                                WHEN N'4'  THEN N'SPT'
                                                WHEN N'5'  THEN N'CCS'
                                                WHEN N'6'  THEN N'NCS'
                                                WHEN N'7'  THEN N'NHX'
                                                WHEN N'90' THEN N'FTX' --<<< See Insert FULL TEXT indexes below
                                                ----------------------
                                                WHEN N'F'  THEN N'FKC'
                                                WHEN N'FT' THEN N'HP'
                                                WHEN N'IF' THEN N'HP'
                                                WHEN N'IT' THEN N'IT'
                                                WHEN N'M'  THEN N'MIX' --<<< See Insert MISSING indexes below
                                                WHEN N'TF' THEN N'HP'  -- SQL table-valued-function
                                                WHEN N'U'  THEN N'TBL'
                                                WHEN N'V'  THEN N'UIV' -- unindexed view type
                                                ELSE            COALESCE(i.type,o.type,N'??')
                                           END
      ,is_unique                         = COALESCE(i.is_unique,0)
      ,data_space_id                     = COALESCE(i.data_space_id,0)
      ,ignore_dup_key                    = COALESCE(i.ignore_dup_key,0)
      ,is_primary_key                    = COALESCE(i.is_primary_key,0)
      ,is_unique_constraint              = COALESCE(i.is_unique_constraint,0)
      ,fill_factor                       = IIF(i.fill_factor = 0,100,i.fill_factor)
      ,is_padded                         = COALESCE(i.is_padded,0)
      ,is_disabled                       = COALESCE(i.is_disabled,0)
      ,is_hypothetical                   = COALESCE(i.is_hypothetical,0)
      ,allow_row_locks                   = i.allow_row_locks
      ,allow_page_locks                  = i.allow_page_locks
      ,has_filter                        = COALESCE(i.has_filter,0)
      ,filter_definition                 = i.filter_definition
      ---------------------
      ,Partition_Column_ID               = idx_partition.Partition_Column_ID
      ,Partition_Column_Name             = idx_partition.Partition_Column_Name
      ---------------------
      ,compression_delay_mm              = i.compression_delay
      ,is_ignored_in_optimization        = COALESCE(i.is_ignored_in_optimization,0)
      ,suppress_dup_key_messages         = COALESCE(i.suppress_dup_key_messages,0)
      ,auto_created                      = COALESCE(i.auto_created,0)
      ,optimize_for_sequential_key       = COALESCE(i.optimize_for_sequential_key,0)
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables & objects - [sys].[internal_tables
      ----------------------------------------------------------------------------------------------------
      ,is_ms_shipped                     = o.is_ms_shipped
      ,internal_type                     = o.internal_type
      ,internal_type_desc                = o.internal_type_desc
      ,parent_minor_id                   = o.parent_minor_id
      ----------------------------------------------------------------------------------------------------
      --
      ----------------------------------------------------------------------------------------------------
      ,sub_type                          = COALESCE(i.sub_type,0) -- spatial_index_type     ,xml_index_type
      ,sub_type_desc                     = i.sub_type_desc        -- spatial_index_type_desc,xml_index_type_description
      ----------------------------------------------------------------------------------------------------
      -- XML indexes
      ----------------------------------------------------------------------------------------------------
      ,xml_index_type                    = i.xml_index_type
      ,xml_index_type_description        = i.xml_index_type_description
      ,xml_using_xml_index_id            = i.xml_using_xml_index_id
      ,xml_secondary_type                = i.xml_secondary_type
      ,xml_secondary_type_desc           = i.xml_secondary_type_desc
      ,xml_path_id                       = i.xml_path_id
      ----------------------------------------------------------------------------------------------------
      -- Spatial indexes
      ----------------------------------------------------------------------------------------------------
      ,si_tessellation_scheme            = i.si_tessellation_scheme
      ,si_bounding_box_xmin              = i.si_bounding_box_xmin
      ,si_bounding_box_ymin              = i.si_bounding_box_ymin
      ,si_bounding_box_xmax              = i.si_bounding_box_xmax
      ,si_bounding_box_ymax              = i.si_bounding_box_ymax
      ,si_level_1_grid_desc              = i.si_level_1_grid_desc
      ,si_level_2_grid_desc              = i.si_level_2_grid_desc
      ,si_level_3_grid_desc              = i.si_level_3_grid_desc
      ,si_level_4_grid_desc              = i.si_level_4_grid_desc
      ,si_cells_per_object               = i.si_cells_per_object
      ----------------------------------------------------------------------------------------------------
      -- Hash indexes
      ----------------------------------------------------------------------------------------------------
      ,hi_bucket_CNT                     = COALESCE(i.hi_bucket_CNT,0)
      ----------------------------------------------------------------------------------------------------
      -- [sys].[foreign_keys
      ----------------------------------------------------------------------------------------------------
      ,fkc_referenced_object_ID           = fk.referenced_object_ID
      ,fkc_referenced_index_ID            = fk.key_index_id
      ,fkc_is_not_for_replication         = fk.is_not_for_replication
      ,fkc_delete_referential_action      = fk.delete_referential_action
      ,fkc_delete_referential_action_desc = fk.delete_referential_action_desc
      ,fkc_update_referential_action      = fk.update_referential_action
      ,fkc_update_referential_action_desc = fk.update_referential_action_desc
      ----------------------------------------------------------------------------------------------------
      -- [sys].[dm_os_buffer_descriptors]
      ----------------------------------------------------------------------------------------------------
      ,buffer_total_KB_CNT               = COALESCE(bd.buffer_total_KB,0)
      ,buffer_free_KB_CNT                = COALESCE(bd.buffer_free_KB ,0)
      ----------------------------------------------------------------------------------------------------
      -- Object Computed/derived Values
      ----------------------------------------------------------------------------------------------------
      ,is_system_named                   = COALESCE(fk.is_system_named,0)
      ,index_CNT                         = IIF(TRY_CAST(i.type AS INT) > 0,1,0) -- OMIT HEAPS! includes full text ('90')
      ,heap_index_CNT                    = IIF(i.type = N'0'              ,1,0)
      ,Clustered_index_CNT               = IIF(i.type = N'1'              ,1,0)
      ,Nonclustered_index_CNT            = IIF(i.type = N'2'              ,1,0)
      ,XML_index_CNT                     = IIF(i.type = N'3'              ,1,0)
      ,Spatial_index_CNT                 = IIF(i.type = N'4'              ,1,0)
      ,Clustered_ColumnStore_CNT         = IIF(i.type = N'5'              ,1,0)
      ,Nonclustered_ColumnStore_CNT      = IIF(i.type = N'6'              ,1,0)
      ,Nonclustered_Hash_CNT             = IIF(i.type = N'7'              ,1,0)
      ,Fulltext_index_CNT                = IIF(i.type = N'90'             ,1,0)
      ,Missing_index_CNT                 = 0
      ,Foreign_Key_CNT                   = IIF(fk.object_id IS NOT NULL   ,1,0)

/*** LOCAL TESTING ***
SELECT o.history_source_object_id,o.parent_object_id,op.name,o.object_id,o.name,o.type
      ,op.object_id
      ,i.index_id
      ,i.type
      ,fk.is_not_for_replication
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS p
 CROSS
  JOIN (-- Candidate objects
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,name
              ,history_source_object_id
              ,principal_id
              ,type
              ,type_desc
              ,create_date
              ,modify_date
              ,is_published
              ,is_schema_published
              --------------------------------------------------------
              ,is_ms_shipped
              ,internal_type
              ,internal_type_desc
              ,parent_id
              ,parent_minor_id
              --------------------------------------------------------
           -- ,lob_data_space_id, filestream_data_space_id, all TR trigger columns excluded, all SQL MODULES columns excluded
          FROM [tempdb].[dbo].[SQLXL_Index_sys_objects]
         WHERE type IN (N'F'  -- Foreign Key Constraint
                       ,N'FT' -- Assembly (CLR) table-valued function
                       ,N'IF' -- SQL inline table-valued function
                       ,N'IT' -- internal table
                       ,N'TF' -- SQL table valued function            SQL 2012 +
                       ,N'U'  -- Table (user-defined)
                       ,N'V'  -- View
                       )
       ) AS o

------------------------------------------------------------------------------------------------------
-- match up objects to their indexes
------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes] AS i  -- includes [sys].[indexes, 'FT' Assembly (CLR) table-valued function
    ON o.database_id = i.database_id
   AND o.object_id   = i.object_id

------------------------------------------------------------------------------------------------------
-- match up Foreign Key Constraints to their records
------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys] AS fk
    ON o.database_id = fk.database_id
   AND o.object_id   = fk.object_id

------------------------------------------------------------------------------------------------------
-- add buffer cache summary usage
------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_os_buffer_descriptors_EXT] AS bd
    ON o.database_id = bd.database_id
   AND o.object_id   = bd.object_id
   AND i.index_id    = bd.index_id

------------------------------------------------------------------------------------------------------
-- Index Partition information
------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN (-- Index Column Partition information
        SELECT ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,Partition_Column_ID   = ic.column_id
              ,Partition_Column_Name = c.name
              ,rn                    = ROW_NUMBER() OVER (PARTITION BY ic.database_id
                                                                      ,ic.object_id
                                                                      ,ic.index_id
                                                              ORDER BY ic.column_id
                                                         )
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]       AS c
            ON ic.database_id = c.database_id
           AND ic.object_id   = c.object_id
           AND ic.column_id   = c.column_id
         WHERE ic.partition_ordinal = 1
       ) AS idx_partition
       ---------------------------------------------------------------------------------
    ON i.database_id = idx_partition.database_id
   AND i.object_id   = idx_partition.object_id
   AND i.index_id    = idx_partition.index_id
   AND (   1         = idx_partition.rn
        OR idx_partition.rn IS NULL
       )
OPTION (FORCE ORDER,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert heaps, indexes, FKC, TVF, Views'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Insert - [SQLXL_Index_Compilation] - Full Text indexes
/******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type
      ,database_id
      ---------------------
      ,history_source_object_id
      ,parent_object_id
      ,object_id
      ,obj_name
      ,obj_principal_ID
      ,obj_type
      ,obj_type_desc
      ,obj_create_date
      ,obj_modify_date
      ,obj_is_published
      ,obj_is_schema_published
      ---------------------
      ,collection_DTTM
      ---------------------
      ,index_id
      ,name
      ,type
      ,type_desc
      ,sub_type
      ,type_short_desc
      ,data_space_id
      ,is_disabled
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables & objects - [sys].[internal_tables
      ----------------------------------------------------------------------------------------------------
      ,is_ms_shipped
      ,internal_type
      ,internal_type_desc
      ,parent_minor_id
      --------------------
      ,key_column_info
      --------------------
      ,ftx_unique_index_id
      ,ftx_fulltext_catalog_id
      ,ftx_fulltext_catalog_name
      ,ftx_change_tracking_state
      ,ftx_change_tracking_state_desc
      ,ftx_has_crawl_completed
      ,ftx_crawl_type
      ,ftx_crawl_type_desc
      ,ftx_crawl_start_date
      ,ftx_crawl_end_date
--    ,ftx_incremental_timestamp -- OMITTED. binary data type, which represents a rowversion
      ,ftx_stoplist_id
      ,ftx_property_list_id
      ----------------------------------------------------------------------------------------------------
      -- [sys].[dm_os_buffer_descriptors]
      ----------------------------------------------------------------------------------------------------
      ,buffer_total_KB_CNT
      ,buffer_free_KB_CNT
      ----------------------------------------------------------------------------------------------------
      -- Object Computed/derived Values
      ----------------------------------------------------------------------------------------------------
      ,index_CNT
      ,heap_index_CNT
      ,Clustered_index_CNT
      ,Nonclustered_index_CNT
      ,XML_index_CNT
      ,Spatial_index_CNT
      ,Clustered_ColumnStore_CNT
      ,Nonclustered_ColumnStore_CNT
      ,Nonclustered_Hash_CNT
      ,Fulltext_index_CNT
      ,Missing_index_CNT
      ,Foreign_Key_CNT
       )
SELECT rec_type                          = N'I'
      ---------------------
      ,database_id                       = o.database_id
      ---------------------
      ,history_source_object_id          = o.history_source_object_id
      ,parent_object_id                  = COALESCE(o.history_source_object_id,o.parent_object_id)
      ---------------------
      ,object_id                         = o.object_id
      ,obj_name                          = o.name
      ,obj_principal_ID                  = o.principal_ID
      ,obj_type                          = o.type
      ,obj_type_desc                     = o.type_desc
      ,obj_create_date                   = o.create_date
      ,obj_modify_date                   = o.modify_date
      ,obj_is_published                  = o.is_published
      ,obj_is_schema_published           = o.is_schema_published
      ---------------------
      ,collection_DTTM                   = p.collection_DTTM
      ---------------------
      ,index_id                          = i.object_id
      ,name                              = N'FULL TEXT'              -- HARD CODED
      ,type                              = N'90'                     -- used to maintain sort order on XL sheet by index TYPE
      ,type_desc                         = N'FULL TEXT'              -- HARD CODED
      ,sub_type                          = 0
      ,type_short_desc                   = N'FTX'                    -- HARD CODED
      ,data_space_id                     = i.data_space_id
      ,is_disabled                       = IIF(i.is_enabled = 1,0,1) -- NOTE: opposite of [sys].[indexES]
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables & objects - [sys].[internal_tables
      ----------------------------------------------------------------------------------------------------
      ,is_ms_shipped                     = o.is_ms_shipped
      ,internal_type                     = o.internal_type
      ,internal_type_desc                = o.internal_type_desc
      ,parent_minor_id                   = o.parent_minor_id
      --------------------
      ,key_column_info                   = NULL
      --------------------
      ,ftx_unique_index_id               = i.unique_index_id         -- unique index used to uniquely relate the full-text index to the rows
      ,ftx_fulltext_catalog_id           = i.fulltext_catalog_id
      ,ftx_fulltext_catalog_name         = i.name
      ,ftx_change_tracking_state         = i.change_tracking_state
      ,ftx_change_tracking_state_desc    = i.change_tracking_state_desc
      ,ftx_has_crawl_completed           = i.has_crawl_completed
      ,ftx_crawl_type                    = i.crawl_type
      ,ftx_crawl_type_desc               = i.crawl_type_desc
      ,ftx_crawl_start_date              = i.crawl_start_date
      ,ftx_crawl_end_date                = i.crawl_end_date
--    ,ftx_incremental_timestamp         = i.incremental_timestamp   -- OMITTED. binary data type, which represents a rowversion
      ,ftx_stoplist_id                   = i.stoplist_id
      ,ftx_property_list_id              = i.property_list_id
      ---------------------------------------------------------------------------------------------------------
      -- [sys].[dm_os_buffer_descriptors] - no links between buffer cache and FUllText indexes found as of yet
      ---------------------------------------------------------------------------------------------------------
      ,buffer_total_KB_CNT               = 0 -- bd.buffer_total_KB_CNT
      ,buffer_free_KB_CNT                = 0 -- bd.buffer_free_KB_CNT
      ----------------------------------------------------------------------------------------------------
      -- Object Computed/derived Values
      ----------------------------------------------------------------------------------------------------
      ,index_CNT                         = 1
      ,heap_index_CNT                    = 0
      ,Clustered_index_CNT               = 0
      ,Nonclustered_index_CNT            = 0
      ,XML_index_CNT                     = 0
      ,Spatial_index_CNT                 = 0
      ,Clustered_ColumnStore_CNT         = 0
      ,Nonclustered_ColumnStore_CNT      = 0
      ,Nonclustered_Hash_CNT             = 0
      ,Fulltext_index_CNT                = 1
      ,Missing_index_CNT                 = 0
      ,Foreign_Key_CNT                   = 0

  FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS p
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_fulltext_indexes]   AS i
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]            AS o
    ON i.database_id = o.database_id
   AND i.object_id   = o.object_id
------------------------------------------------------------------------------------------------------
-- NOTE: Not sure how buffer cache links to Fulltext index
------------------------------------------------------------------------------------------------------
OPTION (FORCE ORDER, MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert Full Text indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Insert - [SQLXL_Index_Compilation] - Missing indexes
/******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type
      ,database_id
      ---------------------
      ,history_source_object_id
      ,parent_object_id
      ,object_id
      ,obj_name
      ,obj_principal_ID
      ,obj_type
      ,obj_type_desc
      ,obj_create_date
      ,obj_modify_date
      ,obj_is_published
      ,obj_is_schema_published
      ---------------------
      ,collection_DTTM
      ---------------------
      ,index_id
      ,name
      ,type
      ,type_desc
      ,sub_type
      ,type_short_desc
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables & objects - [sys].[internal_tables
      ----------------------------------------------------------------------------------------------------
      ,is_ms_shipped
      ,internal_type
      ,internal_type_desc
      ,parent_minor_id
      ---------------------
      ,mix_avg_total_user_cost_AMT
      ,mix_avg_total_system_cost_AMT
      ,mix_avg_user_impact_AMT
      ,mix_avg_system_impact_AMT
      ,mix_unique_compiles_CNT
      ,mix_Advantage_AMT
      -------------------------------------------------------------------------------------------------------------------------------
      -- missing_index_group_stats_query - multiple queries may exist per missing index, only get the query with the biggest benefit
      -- Logic contained in the instance/database data capture queries
      -------------------------------------------------------------------------------------------------------------------------------
      ,mqy_query_text
      ,mqy_query_plan
      ----------------------------------------------------------------------------------------------------
      -- Object Computed/derived Values
      ----------------------------------------------------------------------------------------------------
      ,index_CNT
      ,heap_index_CNT
      ,Clustered_index_CNT
      ,Nonclustered_index_CNT
      ,XML_index_CNT
      ,Spatial_index_CNT
      ,Clustered_ColumnStore_CNT
      ,Nonclustered_ColumnStore_CNT
      ,Nonclustered_Hash_CNT
      ,Fulltext_index_CNT
      ,Missing_index_CNT
      ,Foreign_Key_CNT
      )
SELECT rec_type                          = N'I'
      ,database_id                       = i.database_id
      ---------------------
      ,history_source_object_id          = o.history_source_object_id
      ,parent_object_id                  = COALESCE(o.history_source_object_id,o.parent_object_id)
      ,object_id                         = o.object_id
      ,obj_name                          = o.name
      ,obj_principal_ID                  = o.principal_ID
      ,obj_type                          = o.type
      ,obj_type_desc                     = o.type_desc
      ,obj_create_date                   = o.create_date
      ,obj_modify_date                   = o.modify_date
      ,obj_is_published                  = o.is_published
      ,obj_is_schema_published           = o.is_schema_published
      ---------------------
      ,collection_DTTM                   = p.collection_DTTM
      ---------------------
      ,index_id                          = i.index_handle
      ,name                              = N'MISSING'
      ,type                              = N'M'
      ,type_desc                         = N'MISSING'
      ,sub_type                          = 0
      ,type_short_desc                   = N'MIX'
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables & objects - [sys].[internal_tables
      ----------------------------------------------------------------------------------------------------
      ,is_ms_shipped                     = o.is_ms_shipped
      ,internal_type                     = o.internal_type
      ,internal_type_desc                = o.internal_type_desc
      ,parent_minor_id                   = o.parent_minor_id
      ---------------------
      ,mix_avg_total_user_cost_AMT       = i.avg_total_user_cost
      ,mix_avg_total_system_cost_AMT     = i.avg_total_system_cost
      ,mix_avg_user_impact_AMT           = i.avg_user_impact
      ,mix_avg_system_impact_AMT         = i.avg_system_impact
      ,mix_unique_compiles_CNT           = i.unique_compiles
      ,mix_Advantage_AMT                 = i.mix_Advantage_AMT
      ----------------------------------------
      -- missing_index_group_stats_query
      ----------------------------------------
      ,mqy_query_text                    = mqy.query_text
      ,mqy_query_plan                    = mqy.query_plan
      ----------------------------------------------------------------------------------------------------
      -- Object Computed/derived Values
      ----------------------------------------------------------------------------------------------------
      ,index_CNT                         = 0
      ,heap_index_CNT                    = 0
      ,Clustered_index_CNT               = 0
      ,Nonclustered_index_CNT            = 0
      ,XML_index_CNT                     = 0
      ,Spatial_index_CNT                 = 0
      ,Clustered_ColumnStore_CNT         = 0
      ,Nonclustered_ColumnStore_CNT      = 0
      ,Nonclustered_Hash_CNT             = 0
      ,Fulltext_index_CNT                = 0
      ,Missing_index_CNT                 = 1
      ,Foreign_Key_CNT                   = 0

/*** LOCAL TESTING ***
SELECT COUNT(1)
--*/

  FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters]          AS p
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details] AS i
    -- NOTE: includes [sys].[dm_db_missing_index_details],[sys].[dm_db_missing_index_groups],[sys].[dm_db_missing_index_group_stats]
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]                     AS o
    ON i.database_id = o.database_id
   AND i.object_id   = o.object_id
  LEFT OUTER
  JOIN (
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_group_stats_query]
       ) AS mqy
    ON i.group_handle = mqy.group_handle
OPTION (FORCE ORDER,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert Missing indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Index Compilation Table
/******************************************************************************************************************************************/
CREATE UNIQUE CLUSTERED INDEX ixuc_SQLXL_Index_Compilation
    ON [tempdb].[dbo].[SQLXL_Index_Compilation]
      (database_id
      ,object_ID
      ,index_ID
      ,type
      ,sub_type
      )
  WITH (DATA_COMPRESSION = PAGE);

CREATE NONCLUSTERED INDEX ix_SQLXL_Index_Compilation__rec_type
    ON [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type)
  WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed Compilation Table [tempdb].[dbo].[SQLXL_Index_Compilation]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - source table unique index used by FullText index
/******************************************************************************************************************************************/
;WITH ftx AS (--
SELECT database_id
      ,parent_object_id
      ,object_id
      ,ftx_unique_index_id
      ,index_id
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND type     = N'90' -- full text
)
UPDATE tgt
   SET tgt.Relates_Fulltext_index_ID = ftx.index_id
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN ftx                                      AS ftx
    ON tgt.database_id      = ftx.database_id
   AND tgt.parent_object_id = ftx.parent_object_id
   AND tgt.object_ID        = ftx.object_ID
   AND tgt.index_ID         = ftx.ftx_unique_index_ID
 WHERE tgt.rec_type         = N'I'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update source unique index used by FullText index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Concatenate list of index key column IDs in corrected sequence order "key_column_sequence"
-- computed previously to account for clustered index key order not matching [index_column_id] order
/******************************************************************************************************************************************/
SET ANSI_WARNINGS ON;
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.database_id,tgt.object_id,tgt.index_id,tgt.type,tgt.name,
--*/

        key_column_IDs = N',' +key_columns.col_id
   FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 CROSS
 APPLY (--
        SELECT (-- get comma-separated list of all KEY column ID's. Include leading comma so IDs are stand out from one another
                -- includes ALL "indexes" except HEAP & Columnstore. Foreign Key Constraints added below
                SELECT TRY_CAST(ic.column_id AS NVARCHAR(MAX)) + N','
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] ic
                 WHERE tgt.database_id = ic.database_id
                   AND tgt.object_id   = ic.object_id
                   AND tgt.index_id    = ic.index_id
                   AND tgt.type        = ic.type
                   AND 0               = ic.is_included_column
                 ORDER BY
                       ic.key_column_sequence
                   FOR XML PATH(N''), TYPE
               ).value('(./text())[1]','NVARCHAR(4000)')
       ) key_columns(col_id)
 WHERE tgt.rec_type  = N'I'
   AND tgt.type NOT IN (N'0',N'5',N'6',N'F',N'M')
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Concatenated list of index key column IDs in corrected sequence order'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Concatenate Foreign Key Constraint column IDs in [constraint_column_id] order
/******************************************************************************************************************************************/
SET ANSI_WARNINGS ON;
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.database_id,tgt.object_id,tgt.index_id,tgt.type,tgt.name,
--*/

        key_column_IDs = N',' +key_columns.col_id
   FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 CROSS
 APPLY (-- DOuble select needed FOR XML .VALUE
        SELECT (-- get comma-separated list of all KEY column ID's, include leading column so IDs stand out from one another
                -- includes ALL "indexes" except HEAP & Columnstore
                SELECT TRY_CAST(fkc.parent_column_id AS NVARCHAR(MAX)) + N','
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns] AS fkc
                 WHERE tgt.database_id = fkc.database_id
                   AND tgt.object_id   = fkc.constraint_object_id
                 ORDER BY
                       fkc.constraint_column_id
                   FOR XML PATH(N''), TYPE
               ).value('(./text())[1]','NVARCHAR(4000)')
       ) key_columns(col_id)
 WHERE tgt.rec_type = N'I'
   AND tgt.type     = N'F'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Concatenated Foreign Key Constraint column IDs in [constraint_column_id] order'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Insert - [SQLXL_Index_Compilation] - Object records - Base "P" (Table, View, TVF), HISTORY TABLE "H", and INTERNAL TABLE "S" records
-- Top-level "Parent" "P" tables include:
--    object type "U" "Base" tables - Rowstore HEAP, Rowstore Clustered, and Clustered Columnstore
--    object type "U" "History" tables created by Change Data Capture and System Versioning
-- Internal tables roll up to their respective parent BASE or HISTORY table
-- Other top-level objects include Table Valued Functions and Views
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Insert Object records - Base "P" (Table, View, TVF), HISTORY TABLE "H", and INTERNAL TABLE "S" records',0,0)
            WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type
      --------------------------------------------
      -- [sys].[databases]
      --------------------------------------------
      ,database_id
      ---------------------
      ,collection_DTTM
      --------------------------------------------
      -- [sys].[objects]
      --------------------------------------------
      ,history_source_object_id
      ,parent_object_id
      --------------------------------------------
      ,object_id
      ,obj_name
      ,obj_principal_ID
      ,obj_type
      ,obj_type_desc
      ,obj_create_date
      ,obj_modify_date
      ,obj_is_published
      ,obj_is_schema_published
      --------------------------------------------
      ,obj_definition
      ,obj_uses_ansi_nulls
      ,obj_uses_quoted_identifier
      ,obj_is_schema_bound
      ,obj_uses_database_collation
      ,obj_is_recompiled
      ,obj_null_on_null_input
      ,obj_execute_as_principal_id
      ,obj_uses_native_compilation
      ,obj_is_inlineable
      ,obj_inline_type
      --------------------------------------------
      ,index_id
      ,name
      ,type
      ,type_desc
      ,sub_type
      --------------------------------------------
      -- [sys].[internal_tables
      --------------------------------------------
      ,internal_type
      ,internal_type_desc
      ,parent_minor_id
      --------------------------------------------
      -- [sys].[stats]
      --------------------------------------------
      ,Stats_CNT
      --------------------------------------------
      -- [sys].[partitions]
      --------------------------------------------
      ,Partition_none_compress_CNT                
      ,Partition_row_compress_CNT                 
      ,Partition_page_compress_CNT                
      ,Partition_columnstore_compress_CNT         
      ,Partition_columnstore_archive_compress_CNT 
      ,Partition_xml_compress_CNT 
      ,row_CNT                                    
      )
SELECT rec_type = IIF(o.type = N'IT'
                     ,N'S'  -- Internal Table
                     ,N'P') -- default value, updated below
      ----------------------------
      -- [sys].[databases]
      ----------------------------
      ,database_id                 = o.database_id
      ,collection_DTTM             = p.collection_DTTM
      ----------------------------
      -- [sys].[objects]
      ----------------------------
      ,history_source_object_id    = o.history_source_object_id
      ,parent_object_id            = COALESCE(o.history_source_object_id,o.parent_object_id)
      ----------------------------
      ,object_id                   = o.object_id
      ,obj_name                    = o.name
      ,obj_principal_ID            = o.principal_id
      ,obj_type                    = o.type
      ,obj_type_desc               = o.type_desc
      ,obj_create_date             = o.create_date
      ,obj_modify_date             = o.modify_date
      ,obj_is_published            = o.is_published
      ,obj_is_schema_published     = o.is_schema_published
      -- SQL_MODULES --------------------------
      ,obj_definition              = o.definition
      ,obj_uses_ansi_nulls         = o.uses_ansi_nulls
      ,obj_uses_quoted_identifier  = o.uses_quoted_identifier
      ,obj_is_schema_bound         = o.is_schema_bound
      ,obj_uses_database_collation = o.uses_database_collation
      ,obj_is_recompiled           = o.is_recompiled
      ,obj_null_on_null_input      = o.null_on_null_input
      ,obj_execute_as_principal_id = o.execute_as_principal_id
      ,obj_uses_native_compilation = o.uses_native_compilation
      ,obj_is_inlineable           = o.is_inlineable
      ,obj_inline_type             = o.inline_type
      ----------------------------
      ,index_id                    = o.object_id
      ,name                        = o.name
      ,type                        = o.type
      ,type_desc                   = o.type_desc
      ,sub_type                    = 0
      ----------------------------------------------------------------------------------------------------
      -- Internal Tables
      ----------------------------------------------------------------------------------------------------
      ,internal_type               = o.internal_type
      ,internal_type_desc          = o.internal_type_desc
      ,parent_minor_id             = o.parent_minor_id
      ----------------------------------------------------------------------------------------------------
      -- [sys].[stats]
      ----------------------------------------------------------------------------------------------------
      ,Stats_CNT                   = COALESCE(stats.Statistics_CNT,0)
      --------------------------------------------
      -- [sys].[partitions]
      --------------------------------------------
      ,row_CNT                                    = ISNULL(part.rows         ,0)
      ,Partition_none_compress_CNT                = ISNULL(part.none_comp    ,0)
      ,Partition_row_compress_CNT                 = ISNULL(part.row_comp     ,0)
      ,Partition_page_compress_CNT                = ISNULL(part.page_comp    ,0)
      ,Partition_columnstore_compress_CNT         = ISNULL(part.colstore_comp,0)
      ,Partition_columnstore_archive_compress_CNT = ISNULL(part.colstore_arch,0)
      ,Partition_xml_compress_CNT                 = ISNULL(part.xml_comp     ,0)
  FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS p
 CROSS
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_sys_objects]
         WHERE type
            IN (N'FT' -- Assembly (CLR) table-valued function
               ,N'IF' -- SQL inline table-valued function
               ,N'IT' -- Internal Table
               ,N'TF' -- SQL table valued function            SQL 2012 +
               ,N'U'  -- Table
               ,N'V'  -- View
               )
       ) AS o

  LEFT OUTER
  JOIN (-- Get count of rows, compressed and archived partitions - OBJECT LEVEL ONLY
        SELECT p.database_id
              ,p.object_id
              ,rows                = SUM(p.rows)
              ,none_comp           = SUM(p.none_comp    )
              ,row_comp            = SUM(p.row_comp     )
              ,page_comp           = SUM(p.page_comp    )
              ,colstore_comp       = SUM(p.colstore_comp)
              ,colstore_arch       = SUM(p.colstore_arch)
              ,xml_comp            = SUM(p.xml_comp     )
          FROM [tempdb].[dbo].[SQLXL_Index_sys_partitions] AS p
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes]    AS i
            ON p.database_id = i.database_id
           AND p.object_id   = i.object_id
           AND p.index_id    = i.index_id
         WHERE i.type IN (N'0',N'1',N'5')
         GROUP BY
               p.database_id
              ,p.object_id
       ) AS part
    ON o.database_id        = part.database_id
   AND o.object_id          = part.object_id

------------------------------------------------------------------------------------------------------
-- Stats Counts - OBJECT LEVEL ONLY
------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN (-- count of statistics for each table & indexed view
        SELECT s.database_id
              ,s.object_id
              ,Statistics_CNT          = COUNT(1)
              ,Statistics_Filtered_CNT = SUM(IIF(has_filter = 1,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_stats]   AS s
         GROUP BY
               s.database_id
              ,s.object_id
       ) stats
    ON o.database_id = stats.database_id
   AND o.object_id   = stats.object_id
OPTION (FORCE ORDER,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert Object records - Base "P" (Table, View, TVF), HISTORY TABLE "H", and INTERNAL TABLE "S" records'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Insert - [SQLXL_Index_Compilation] - DATABASE records
/******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type
      ,database_id
      ,database_name
      ,collation_name
      ---------------------
      ,collection_DTTM
      ,parent_object_id
      ,parent_object_name
      ,object_id
      ,obj_name
      ,obj_type
      ,obj_type_desc
      ,index_id
      ,name
      ,type
      ,type_desc
      ,sub_type
      ,CLR_trigger_CNT
      ,SQL_trigger_CNT
      ,is_instead_of_trigger_CNT
      )
SELECT rec_type           = N'D'
      ,database_id        = d.database_id
      ,database_name      = d.name
      ,collation_name     = d.collation_name
      ---------------------
      ,collection_DTTM    = p.collection_DTTM
      ,parent_object_id   = d.database_id
      ,parent_object_name = d.name
      ,object_id          = d.database_id
      ,obj_name           = d.name
      ,obj_type           = N'DB'
      ,obj_type_desc      = N'Database'
      ,index_id           = d.database_id
      ,name               = d.name
      ,type               = N'DB'
      ,type_desc          = N'Database'
      ,sub_type           = 0
      ------------------------------------------------------------------------------------------------
      ,CLR_trigger_CNT    = COALESCE(tr.CLR_trigger_CNT             ,0)
      ,SQL_trigger_CNT    = COALESCE(tr.SQL_trigger_CNT             ,0)
      ,is_instead_of_trigger_CNT = COALESCE(tr.is_instead_of_trigger_CNT   ,0)
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
  LEFT OUTER
  JOIN (-- Summarize DML triggers
        SELECT database_id
              ,CLR_trigger_CNT           = SUM(IIF(type = N'TA',1,0))                 -- Assembly (CLR) DML trigger
              ,SQL_trigger_CNT           = SUM(IIF(type = N'TR',1,0))                 -- SQL DML trigger
              ,is_instead_of_trigger_CNT = SUM(IIF(tr_is_instead_of_trigger = 1,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_objects]
         WHERE tr_parent_class  = 0 -- Database, for the DDL triggers.
           AND tr_is_ms_shipped = 0 -- Trigger NOT created on behalf of the user by an internal SQL Server component
         GROUP BY
               database_id
       ) AS tr
    ON d.database_id = tr.database_id
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS p
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert DATABASE records'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Insert - [SQLXL_Index_Compilation] - INSTANCE record
/******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Compilation]
      (rec_type
      ,database_id
      ,database_name
      ,collation_name
      ---------------------
      ,collection_DTTM
      ,parent_object_id
      ,parent_object_name
      ,object_id
      ,obj_name
      ,obj_type
      ,obj_type_desc
      ,index_id
      ,name
      ,type
      ,type_desc
      ,sub_type
      )
SELECT rec_type                = N'A'
      ,database_id             = 0
      ,database_name           = N'Instance'
      ,collation_name          = CONVERT(nvarchar(128), SERVERPROPERTY('collation'))
      ---------------------
      ,collection_DTTM         = p.collection_DTTM
      ,parent_object_id        = 0
      ,parent_object_name      = N'Instance'
      ,object_id               = 0
      ,obj_name                = N'Instance'
      ,obj_type                = N'A'
      ,obj_type_desc           = N'Instance'
      ,index_id                = 0
      ,name                    = N'Instance'
      ,type                    = N'A'
      ,type_desc               = N'Instance'
      ,sub_type                = 0
  FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS p
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert INSTANCE record'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - SQL Server version onfo
/******************************************************************************************************************************************/
UPDATE tgt
   SET product_Major_Version = mv.product_Major_Version 
      ,product_minor_version   = pv.product_minor_version
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 CROSS
  JOIN (-- Get SQL version from source server
        SELECT product_Major_Version = TRY_CAST(run_value AS INT)
          FROM [tempdb].[dbo].[SQLXL_Instance_info]
         WHERE source = N'SERVERPROPERTY'
           AND name   = N'ProductMajorVersion'
       ) AS mv
 CROSS 
 JOIN (-- Get SQL minor version from source server
       SELECT product_minor_version = TRY_CAST(PARSENAME(text_value,2) AS INT)
         FROM [tempdb].[dbo].[SQLXL_Instance_info]
        WHERE source = N'SERVERPROPERTY'
          AND name   = N'ProductVersion'
      ) AS pv

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update SQL Sevrer version info'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - "Parent"-level fields across records
-- Assign HISTORY TABLES their own rec_type = N'H'
-- NOTE: columns named "tbl_%" are not to be aggregated since they are at the parent level already
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Update "Parent"-level fields across records',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.rec_type
      ,tgt.database_id
      ,tgt.object_id
      ,tgt.index_id
      ,tgt.type,
--*/
       rec_type = IIF(tgt.rec_type = N'P'
                     ,CASE WHEN tbl.temporal_type        = 1 THEN N'H' -- History table
                           WHEN tbl.cdc_is_history_table = 1 THEN N'H' -- History table
                           WHEN his.ledger_type          > 0 THEN N'H' -- History table
                           ELSE tgt.rec_type
                      END
                     ,tgt.rec_type)
----------------------------------------------------------------------------------------------------
-- [sys].[databases]
----------------------------------------------------------------------------------------------------
      ,database_name                     = d.name
      ,collation_name                    = d.collation_name
----------------------------------------------------------------------------------------------------
-- [sys].[schemas] - object level
----------------------------------------------------------------------------------------------------
      ,schema_id                         = o.schema_id
      ,schema_name                       = s.name
      ,schema_principal_ID               = s.principal_id
----------------------------------------------------------------------------------------------------
-- [sys].[objects]
----------------------------------------------------------------------------------------------------
      ,obj_name                           = o.name
      ,obj_type                           = o.type
      ,obj_type_desc                      = o.type_desc
      ,obj_create_date                    = o.create_date
      ,obj_modify_date                    = o.modify_date
      ,obj_is_published                   = o.is_published
      ,obj_is_schema_published            = o.is_schema_published
----------------------------------------------------------------------------------------------------
-- Parent Objects - mostly for Internal Tables - [sys].[tables]
----------------------------------------------------------------------------------------------------
      ,parent_schema_id                  = op.schema_id
      ,parent_schema_name                = sp.name
      ,parent_object_name                = op.name
      ,parent_object_type                = op.type
      ,parent_object_type_desc           = op.type_desc
----------------------------------------------------------------------------------------------------
-- History Table sources - [sys].[schemas], [sys].[tables]
----------------------------------------------------------------------------------------------------
      ,history_source_schema_id          = oh.schema_id
      ,history_source_schema_name        = sh.name
      ,history_source_object_name        = oh.name
      ,history_source_object_type        = oh.type
      ,history_source_object_type_desc   = oh.type_desc
----------------------------------------------------------------------------------------------------
-- [sys].[tables]
----------------------------------------------------------------------------------------------------
      ,tbl_max_column_used_ID          = tbl.max_column_id_used
      ,tbl_is_replicated               = COALESCE(tbl.is_replicated,0)
      ,tbl_has_unchecked_assembly_data = COALESCE(tbl.has_unchecked_assembly_data,0)
      ,tbl_lock_escalation             = tbl.lock_escalation
      ,tbl_lock_escalation_desc        = tbl.lock_escalation_desc
      ,tbl_is_filetable                = COALESCE(tbl.is_filetable,0)
      ,tbl_is_memory_optimized         = COALESCE(tbl.is_memory_optimized
                                                 ,itt.is_memory_optimized -- internal table parent is optimized
                                                 ,0)
      ,tbl_is_clustered_columnstore    = COALESCE(ccs.is_clustered_columnstore,0)
      ,tbl_history_table_id            = tbl.history_table_id
      ,tbl_history_table_schema        = sch.name
      ,tbl_history_table_name          = his.name
      ------------------------------------------------------------------------------------------------
      ,CLR_trigger_CNT                 = COALESCE(tr.CLR_trigger_CNT             ,0)
      ,SQL_trigger_CNT                 = COALESCE(tr.SQL_trigger_CNT             ,0)
      ,is_instead_of_trigger_CNT       = COALESCE(tr.is_instead_of_trigger_CNT   ,0)
--------------------------------------------------------------
-- Physical Table computed properties
--------------------------------------------------------------
      ,tbl_is_heap                     = COALESCE(IIF(ccs.is_heap = 1 AND tbl.is_memory_optimized = 0,1,0),0)
      ,tbl_column_CNT                  = COALESCE(tc.column_CNT,0)

--------------------------------------------------------------
-- SQLXL Object labels
--------------------------------------------------------------
      ,obj_type_hdr              = COALESCE(otl.obj_type_hdr,N'')
      ,obj_type_dtl              = COALESCE(otl.obj_type_dtl,N'')
      ,obj_type_label            = COALESCE(otl.obj_type_hdr,N'')
                                 + IIF(LTRIM(otl.obj_type_dtl) > N''
                                      ,N' ' + otl.obj_type_dtl
                                      ,N'')
      ,obj_type_short_label      = COALESCE(RTRIM(LEFT(otl.obj_type_hdr,3)),N'')

----------------------------------------------------------------------------------------------------
-- [cdc] Change Data Capture tables
----------------------------------------------------------------------------------------------------
      ,cdc_capture_instance      = tbl.cdc_capture_instance
      ,cdc_supports_net_changes  = tbl.cdc_supports_net_changes
      ,cdc_role_name             = tbl.cdc_role_name
      ,cdc_index_name            = tbl.cdc_index_name
      ,cdc_filegroup_name        = tbl.cdc_filegroup_name
      ,cdc_create_date           = tbl.cdc_create_date
      ,cdc_partition_switch      = tbl.cdc_partition_switch
      ,cdc_is_history_table      = tbl.cdc_is_history_table

/*** LOCAL TESTING ***
SELECT *
--*/

  FROM (-- all non-Instance and Database records
        SELECT TOP (100) PERCENT
               *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type NOT IN (N'A',N'D')
         ORDER BY
               database_id
              ,object_ID
              ,index_ID
              ,type
       ) AS tgt

  JOIN [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
    ON tgt.database_id = d.database_id
  -----------------------------------------------------------
  -- schemas
  -----------------------------------------------------------
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]   AS oh -- history source object
    ON tgt.database_ID              = oh.database_id
   AND tgt.history_source_object_id = oh.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas]   AS sh
    ON oh.database_ID       = sh.database_id
   AND oh.SCHEMA_ID         = sh.schema_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]   AS op -- parent objects
    ON tgt.database_ID      = op.database_id
   AND tgt.parent_object_ID = op.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas]   AS sp
    ON op.database_ID       = sp.database_id
   AND op.SCHEMA_ID         = sp.schema_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]   AS o -- objects
    ON tgt.database_ID = o.database_id
   AND tgt.object_ID   = o.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas]   AS s
    ON o.database_ID   = s.database_id
   AND o.SCHEMA_ID     = s.schema_id

  -----------------------------------------------------------
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]   AS tbl -- all records get TABLE level information
    ON tgt.database_ID = tbl.database_id
   AND (   (    tgt.TYPE             = N'F'
            AND tgt.parent_object_ID = tbl.object_id
           )
        OR (    tgt.TYPE            <> N'F'
            AND tgt.object_id        = tbl.object_id
           )
       )

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]   AS his -- system versioned history table
    ON tbl.database_id      = his.database_id
   AND tbl.history_table_id = his.object_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]   AS itt -- internal table parent
    ON tbl.database_id        = itt.database_id
   AND tbl.internal_parent_id = itt.object_id

  LEFT OUTER
  JOIN (-- list of data spaces for Large Objects (LOB)
        SELECT database_id
              ,data_space_id
              ,data_space_name
          FROM [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
         GROUP BY
               database_id
              ,data_space_id
              ,data_space_name
       ) AS lob_ds
    ON tbl.database_id       = lob_ds.database_id
   AND tbl.lob_data_space_id = lob_ds.data_space_id

  LEFT OUTER
  JOIN (-- list of data spaces for Filestream objects
        SELECT database_id
              ,data_space_id
              ,data_space_name
          FROM [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
         GROUP BY
               database_id
              ,data_space_id
              ,data_space_name
       ) AS fst_ds
    ON tbl.database_id              = fst_ds.database_id
   AND tbl.filestream_data_space_id = fst_ds.data_space_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas] AS sch
    ON his.database_id = sch.database_id
   AND his.SCHEMA_ID   = sch.SCHEMA_ID

  LEFT OUTER
  JOIN (-- Is table a Heap or Clustered Columnstore?
        SELECT database_id
              ,object_id
              ,is_clustered_columnstore = SUM(IIF(type = N'5',1,0))
              ,is_heap                  = SUM(IIF(type = N'0',1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_indexes]
         GROUP BY
               database_id
              ,object_id
        HAVING SUM(IIF(type = N'5',1,0)) + SUM(IIF(type = N'0',1,0)) > 0
       ) AS ccs
    ON tgt.database_id                                = ccs.database_id
   AND (   (tgt.type  = N'F' AND tgt.parent_object_id = ccs.object_id)
        OR (tgt.type <> N'F' AND tgt.object_id        = ccs.object_id)
       )

  LEFT OUTER
  JOIN (-- Size of of rows by table. Row count computed above from [sys].[partitions]
        SELECT p.database_id
              ,p.object_id
              ,used_page_CNT = SUM(p.used_page_CNT)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats] AS p
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes]               AS i
            ON p.database_id = i.database_id
           AND p.object_id   = i.object_id
           AND p.index_id    = i.index_id
           AND i.type IN (N'0',N'1',N'5') -- HEAP, Clustered Rowstore, Nonclustered Rowstore
         GROUP BY
               p.database_id
              ,p.object_id
       ) AS rc
    ON tgt.database_id = rc.database_id
   AND tgt.object_id   = rc.object_id

  LEFT OUTER
  JOIN (-- count of columns in:
        -- Table-valued assembly functions (FT)
        -- Inline table-valued SQL functions (IF)
        -- Internal tables (IT)
        -- Table-valued SQL functions (TF)
        -- User tables (U)
        -- Views (V)
        SELECT database_id
              ,object_id
              ,column_CNT = COUNT(1)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]
         GROUP BY
               database_id
              ,object_id
       ) AS tc
    ON tgt.database_id  = tc.database_id
   AND (   (tgt.type  = N'F' AND tgt.parent_object_id = tc.object_id)
        OR (tgt.type <> N'F' AND tgt.object_id        = tc.object_id)
       )

  LEFT OUTER
  JOIN (-- Summarize DML triggers
        SELECT database_id
              ,parent_object_id
              ,CLR_trigger_CNT           = SUM(IIF(type = N'TA',1,0)) -- Assembly (CLR) DML trigger
              ,SQL_trigger_CNT           = SUM(IIF(type = N'TR',1,0)) -- SQL DML trigger
              ,is_instead_of_trigger_CNT = SUM(IIF(tr_is_instead_of_trigger = 1,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_objects]
         WHERE tr_parent_class  = 1 -- Object or column for the DML triggers
           AND tr_is_ms_shipped = 0 -- Trigger NOT created on behalf of the user by an internal SQL Server component
         GROUP BY
               database_id
              ,parent_object_id
       ) AS tr
    ON tgt.database_id = tr.database_id
   AND tgt.object_id   = tr.parent_object_id

 OUTER
 APPLY (-- Standardized object type labels
        SELECT obj_type_hdr = CASE tgt.obj_type
                                   WHEN N'U'  THEN CASE WHEN ccs.is_clustered_columnstore = 1 THEN N'CCS'
                                                        WHEN tbl.temporal_type            = 1 THEN N'HST'
                                                        WHEN tbl.ledger_type              = 1 THEN N'HST'
                                                        WHEN tbl.cdc_is_history_table     = 1 THEN N'HST'
                                                        ELSE                                       N'TBL'
                                                   END
                                   WHEN N'F'  THEN CASE WHEN ccs.is_clustered_columnstore = 1 THEN N'CCS'
                                                        WHEN tbl.temporal_type            = 1 THEN N'HST'
                                                        WHEN tbl.ledger_type              = 1 THEN N'HST'
                                                        WHEN tbl.cdc_is_history_table     = 1 THEN N'HST'
                                                        ELSE                                       N'TBL'
                                                   END
                                   WHEN N'FT' THEN N'TVF CLR'
                                   WHEN N'IF' THEN N'TVF INL'
                                   WHEN N'IT' THEN N'IT'
                                   WHEN N'TF' THEN N'TVF SQL'
                                   WHEN N'V'  THEN IIF(tgt.is_ms_shipped = 1,N'I',N'') + N'VW'
                                   ELSE            tgt.obj_type
                              END
                            + IIF(tbl.is_memory_optimized                        = 1,N' XTP',N'')
                            + CASE WHEN tgt.obj_type IN (N'F',N'IT',N'U')
                                   THEN  IIF(tbl.cdc_is_history_table            = 1,N' CDC'    ,N'')
                                       + IIF(tbl.ctt_is_track_columns_updated_on = 1,N' CTT'    ,N'')
                                       + IIF(tbl.is_external                     = 1,N' EXT'    ,N'')
                                       + IIF(tbl.is_filetable                    = 1,N' FIL'    ,N'')
                                       + IIF(tbl.is_node                         = 1,N' GPH NOD',N'')
                                       + IIF(tbl.is_edge                         = 1,N' GPH EDG',N'')
                                       + IIF(tbl.is_dropped_ledger_table         = 1,N' LDG DRP',N'') -- is_dropped_ledger_table
                                       + IIF(tbl.ledger_type                     = 1,N' LDG HST',N'') -- HISTORY_TABLE
                                       + IIF(tbl.ledger_type                     = 2,N' LDG UPD',N'') -- UPDATABLE_LEDGER_TABLE
                                       + IIF(tbl.ledger_type                     = 3,N' LDG APP',N'') -- APPEND_ONLY_LEDGER_TABLE
                                       + IIF(tbl.is_merge_published              = 1,N' MRG'    ,N'')
                                       + IIF(tbl.is_remote_data_archive_enabled  = 1,N' RDA'    ,N'')
                                       + IIF(    tbl.is_replicated               = 1
                                             AND tbl.is_tracked_by_cdc           = 0,N' REP'    ,N'')
                                       + IIF(tbl.is_sync_tran_subscribed         = 1,N' SYN'    ,N'')
                                       + IIF(tbl.temporal_type                   = 1,N' SVN'    ,N'') -- SYSTEM_VERSIONED_TEMPORAL_TABLE
                                       + IIF(tbl.temporal_type                   = 2,N' SVN'    ,N'') -- SYSTEM_VERSIONED_TEMPORAL_TABLE
                                       ------------------------------------------------------------
                                       + IIF(tgt.obj_type                    = N'F',N' FKC'    ,N'')
                                       ------------------------------------------------------------
                                   ELSE N''
                              END

/* <FUTURE> internal type detail labels. removed for simplicity. May be useful later
                            + CASE tgt.internal_type
                                   WHEN   3 THEN N' QDS HNT' -- QUERY_DISK_STORE_QUERY_HINTS
                                   WHEN   4 THEN N' QDS PRM' -- QUERY_DISK_STORE_QUERY_TEMPLATE_PARAMETERIZATION
                                   WHEN   6 THEN N' QDS WTS' -- QUERY_DISK_STORE_WAIT_STATS
                                   WHEN   8 THEN N' QDS QVT' -- PLAN_PERSIST_QUERY_VARIANT_TABLE
                                   WHEN   9 THEN N' QDS REP' -- QUERY_DISK_STORE_REPLICAS
                                   WHEN  10 THEN N' QDS PFL' -- QUERY_DISK_STORE_PLAN_FORCING_LOCATIONS
                                   WHEN  11 THEN N' QDS RTS' -- QUERY_DISK_STORE_RUNTIME_STATS_V2
                                   WHEN  12 THEN N' QDS WT2' -- QUERY_DISK_STORE_WAIT_STATS_V2
                                   -----------------------------------------------------------------
                                   WHEN 201 THEN N' QUE QMS' -- QUEUE_MESSAGES
                                   WHEN 202 THEN N' XML IXN' -- XML_INDEX_NODES
                                   WHEN 203 THEN N' FTX CFL' -- FULLTEXT_CATALOG_FREELIST
                                   WHEN 204 THEN N' FTX MAP' -- FULLTEXT_CATALOG_MAP (BOL)/FULLTEXT_INDEX_MAP (REALITY)
                                   WHEN 205 THEN N' QRY NOT' -- QUERY_NOTIFICATION
                                   WHEN 206 THEN N' SVC BMP' -- SERVICE_BROKER_MAP
                                   WHEN 207 THEN N' EXT IND' -- EXTENDED_INDEXES (such as a spatial index)
                                   WHEN 208 THEN N' FST TMB' -- FILESTREAM_TOMBSTONE
                                   WHEN 209 THEN N' CHG TRK' -- CHANGE_TRACKING
                                   WHEN 210 THEN N' TRK TXN' -- TRACKED_COMMITTED_TRANSACTIONS
                                   WHEN 211 THEN N' FTX AVD' -- FULLTEXT_AVDL
                                   WHEN 212 THEN N' FTX CFR' -- FULLTEXT_COMP_FRAGMENT
                                   WHEN 213 THEN N' FTX DST' -- FULLTEXT_DOCID_STATUS
                                   WHEN 214 THEN N' FTX IDI' -- FULLTEXT_INDEXED_DOCID
                                   WHEN 215 THEN N' FTX DFL' -- FULLTEXT_DOCID_FILTER
                                   WHEN 216 THEN N' FTX DMP' -- FULLTEXT_DOCID_MAP
                                   WHEN 217 THEN N' FTX TMT' -- FULLTEXT_THESAURUS_METADATA_TABLE
                                   WHEN 218 THEN N' FTX TST' -- FULLTEXT_THESAURUS_STATE_TABLE
                                   WHEN 219 THEN N' FTX TPT' -- FULLTEXT_THESAURUS_PHRASE_TABLE
                                   WHEN 220 THEN N' CON FTR' -- CONTAINED_FEATURES
                                   WHEN 221 THEN N' SMP DOC' -- SEMPLAT_DOCUMENT_INDEX_TABLE
                                   WHEN 222 THEN N' SMP TIT' -- SEMPLAT_TAG_INDEX_TABLE
                                   WHEN 223 THEN N' SMP MMT' -- SEMPLAT_MODEL_MAPPING_TABLE
                                   WHEN 224 THEN N' SMP LMT' -- SEMPLAT_LANGUAGE_MODEL_TABLE
                                   WHEN 225 THEN N' FTB UPF' -- FILETABLE_UPDATES
                                   -----------------------------------------------------------------
                                   WHEN 236 THEN N' XML SND' -- SELECTIVE_XML_INDEX_NODE_TABLE
                                   WHEN 237 THEN N' IT* 237' -- UNKNOWN INTERNAL TABLE TYPE 237
                                   WHEN 238 THEN N' IT* 238' -- UNKNOWN INTERNAL TABLE TYPE 238
                                   WHEN 239 THEN N' IT* 239' -- UNKNOWN INTERNAL TABLE TYPE 239
                                   -----------------------------------------------------------------
                                   WHEN 240 THEN N' QDS TXT' -- QUERY_DISK_STORE_QUERY_TEXT
                                   WHEN 241 THEN N' QDS QDQ' -- QUERY_DISK_STORE_QUERY
                                   WHEN 242 THEN N' QDS PLN' -- QUERY_DISK_STORE_PLAN
                                   WHEN 243 THEN N' QDS RST' -- QUERY_DISK_STORE_RUNTIME_STATS
                                   WHEN 244 THEN N' QDS RSI' -- QUERY_DISK_STORE_RUNTIME_STATS_INTERVAL
                                   WHEN 245 THEN N' QRY CNS' -- QUERY_CONTEXT_SETTINGS
                                   WHEN 246 THEN N' IT* 246' -- UNKNOWN INTERNAL TABLE TYPE 246
                                   WHEN 247 THEN N' IT* 247' -- UNKNOWN INTERNAL TABLE TYPE 247
                                   WHEN 248 THEN N' IT* 248' -- UNKNOWN INTERNAL TABLE TYPE 248
                                   WHEN 249 THEN N' IT* 249' -- UNKNOWN INTERNAL TABLE TYPE 249
                                   WHEN 250 THEN N' QDS PFB' -- QUERY_DISK_STORE_PLAN_FEEDBACK
                                   WHEN 251 THEN N' IT* 251' -- UNKNOWN INTERNAL TABLE TYPE 251
                                   WHEN 252 THEN N' HST SVN' -- INTERNAL_TEMPORAL_HISTORY_TABLE
                                   ELSE IIF(tgt.internal_type > 0
                                           ,COALESCE(N' IT* ' + RIGHT(N'00' + TRY_CAST(tgt.internal_type AS NVARCHAR(3)),3)
                                                    ,N' MSG ITT')
                                           ,N'')
                              END
*/
              ,obj_type_dtl = CASE WHEN tgt.rec_type = N'I' AND tgt.type = N'V'
                                   THEN N'UIV' -- unindexed view
                                   WHEN tgt.tbl_is_heap = 1 AND tbl.is_memory_optimized = 0
                                   THEN N'HP'
                                   ELSE CASE tgt.type
                                             WHEN N'0'  THEN N'HP'
                                             WHEN N'1'  THEN N'CX'
                                             WHEN N'2'  THEN N'NCX'
                                             WHEN N'3'  THEN  N'XML'
                                                            + CASE tgt.sub_type           -- XML
                                                                   WHEN 0 THEN N' PRI'    -- 0 = Primary XML index
                                                                   WHEN 1 THEN N' SEC'    -- 1 = Secondary XML index
                                                                   WHEN 2 THEN N' SEL'    -- 2 = Selective XML index
                                                                   WHEN 3 THEN N' SSEL'   -- 3 = Secondary selective XML index
                                                                   ELSE  N' <'
                                                                       + IIF(tgt.sub_type IS NULL
                                                                            ,N'subtype?'
                                                                            ,tempdb.[dbo].[SQLXL_3SD](tgt.sub_type,N'I'))
                                                                       + N'>'
                                                              END
                                             WHEN N'4'  THEN  N'SPT'
                                                            + CASE tgt.sub_type          -- spatial
                                                                   WHEN 1 THEN N' GEM'   -- 1 = Geometry
                                                                   WHEN 2 THEN N' GEG'   -- 2 = Geographic
                                                                   WHEN 4 THEN N' GEG'   -- 4 = Geographic
                                                                   ELSE  N' <'
                                                                       + IIF(tgt.sub_type IS NULL
                                                                            ,N'subtype?'
                                                                            ,tempdb.[dbo].[SQLXL_3SD](tgt.sub_type,N'I'))
                                                                       + N'>'
                                                              END
                                             WHEN N'5'  THEN N'CCS'
                                             WHEN N'6'  THEN N'NCS'
                                             WHEN N'7'  THEN N'NHX'
                                             WHEN N'90' THEN N'FTX' --<<< See Insert FULL TEXT indexes below
                                             WHEN N'M'  THEN N'MIX'
                                             ELSE N''
                                        END
                              END
       ) otl
OPTION (FORCE ORDER
       ,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update "Parent"-level fields across records'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Flag index columns that are filtered using [sys].[sql_expression_dependencies]
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Flag index columns that are filtered using [sys].[sql_expression_dependencies]',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET is_index_column_filtered = 1
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]               AS tgt
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies] AS ed
    ON ed.database_id          = tgt.database_id
   AND ed.referencing_id       = tgt.object_id
   AND ed.referencing_minor_id = tgt.index_id
   AND ed.referenced_minor_id  = tgt.column_id
 WHERE ed.referencing_class    = 7
   AND ed.referenced_class     = 1
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Flag index columns that are filtered using [sys].[sql_expression_dependencies]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Create - [SQLXL_Index_column] - table of all used and referenced columns
-- list of all columns at the "parent" level for:
-- Index columns - key & included. also Views
-- missing indexes - key & included
-- foreign key referenced columns
-- Foreign Key Constraint columns
-- table valued function columns
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Create table of all used and referenced columns',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

SELECT qry.*
  INTO [tempdb].[dbo].[SQLXL_Index_column]
/*** LOCAL TESTING ***
IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_column]') IS NOT NULL)
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_column];
SELECT qry.*
--*/
  FROM (--
SELECT database_id       = ic.database_id
      ,object_id         = ic.object_id
      ,Column_ID         = ic.column_id
      ,obj_name          = o.name
      ,name              = ic.name
      ,stats_target_name = QUOTENAME(ic.name,1)
      --------------------------------------------------------------------------------------------------------------------------------------
      ,All_Density       = col_stats.All_Density
      ,Average_Length    = IIF(ic.user_type_name = N'decimal'
                              ,ic.max_length
                              ,col_stats.Average_Length)
      ,Uniqueness        = COALESCE(1.0 * col_stats.Rows * col_stats.All_Density -- if computed separately for this column
                                   ,iles.uniqueness                              -- from index lead element
                                   ,IIF(ic.is_identity = 1                    ,1.0,NULL)
                                   ,IIF(ic.seq_object_id IS NOT NULL          ,1.0,NULL)
                                   ,IIF(dc.definition = N'(newsequentialid())',1.0,NULL)
                                   ,IIF(dc.definition = N'(newid())'          ,1.0,NULL)
                                   ,NULL
                                   )
      ,histogram_steps   = COALESCE(col_stats.steps,iles.steps)
      ,candidate_filtering_steps = IIF(COALESCE(col_stats.steps,iles.steps) BETWEEN 2 AND 19,COALESCE(col_stats.steps,iles.steps),NULL)
      ,param_sniff       = col_stats.param_sniff
      --------------------------------------------------------------------------------------------------------------------------------------
      ,max_length             = CASE WHEN ic.user_type_id IN (N'99',N'231',N'239')
                                      AND ic.max_length <> -1  -- adjust for double-byte character string
                                     THEN ic.max_length * 2
                                     ELSE ic.max_length
                                END
      ,Precision              = ic.Precision
      ,Scale                  = ic.Scale
      ,user_type_id           = ic.user_type_id
      ,data_type              = typ.name
      ,is_nullable            = COALESCE(ic.is_nullable,0)
      ,Seed_Value             = ic.Seed_Value
      ,Increment_Value        = ic.Increment_Value
      ,Last_Value             = ic.Last_Value
      ,is_not_for_replication = COALESCE(ic.is_not_for_replication,0)
      ,is_persisted           = COALESCE(ic.is_persisted,0)
      ,is_identity            = COALESCE(ic.is_identity,0)
      ,is_sequence            = TRY_CAST(IIF(ic.seq_object_id > 0,1,0) AS BIT)
      ,is_newsequentialid     = TRY_CAST(IIF(dc.definition = N'(newsequentialid())',1,0) AS BIT)
      ,is_sparse              = COALESCE(ic.is_sparse,0)
      --------------------------------------------------------------------------------------------------------------------------------------
      -- Long Descriptors
      --------------------------------------------------------------------------------------------------------------------------------------
      ,default_constraint         = dc.definition
      ,check_constraints          = STUFF(chk.check_constraints,1,1,N'')    -- includes constraint attributes
      ,computed_column_definition = IIF(ic.uses_sql_proc = 1,N'*PROC* ',N'')
                                  + IIF(ic.uses_sql_ftn  = 1,N'*FTN* ' ,N'')
                                  + IIF(ic.uses_sql_mthd = 1,N'*MTHD* ',N'')
                                  + ic.definition
                                  + IIF(ic.is_persisted = 1,N'',NCHAR(92) + N'NOT PERSISTED')
                                  + IIF(ic.uses_database_collation = 1,N'',NCHAR(92) + N'NOT DB COLLATED')
      -------------------------------------------
      ,cc_uses_database_collation = COALESCE(ic.uses_database_collation,0)
      ,is_columnstore_eligible    = CASE WHEN (   ic.system_type_id IN (  34 -- image
                                                                        , 35 -- text
                                                                        , 98 -- sqlvariant
                                                                        , 99 -- ntext
                                                                        ,189 -- timestamp/rowversion
                                                                        ,240 -- geography,geometry,hierarchyid
                                                                        ,241 -- XML
                                                                       )
                                              )
                                           OR (   ic.system_type_id IN (231 -- nvarchar
                                                                       ,167 -- varchar
                                                                       ,165 -- varbinary
                                                                       )
                                               AND ic.max_length      = -1   -- MAX length
                                              )
                                           OR (    ic.is_sparse       =  1
                                               OR  ic.is_filestream   =  1
                                               OR  ic.is_computed     =  1
                                              )
                                         THEN 0
                                         ELSE 1
                                    END
      --------------------------------------------------------------------------------------------------------------------------------------
      -- Column name and attributes for display
      --------------------------------------------------------------------------------------------------------------------------------------
      ,[Column Descriptors] =
        QUOTENAME(COALESCE(ic.name,'###c.name NOT FOUND###')) + N' '
      --------------------------------------------------------------------------------------------------------------------------------------
      + CASE typ.name
             WHEN NULL                THEN N''
             -------------------------------------
             WHEN N'tinyint'          THEN N'ti'
             WHEN N'smallint'         THEN N'si'
             WHEN N'int'              THEN N'i'
             WHEN N'bigint'           THEN N'bi'
             -------------------------------------
             WHEN N'char'             THEN N'c'
             WHEN N'nchar'            THEN N'nc'
             WHEN N'varchar'          THEN N'vc'
             WHEN N'nvarchar'         THEN N'nv'
             WHEN N'text'             THEN N'tx'
             WHEN N'ntext'            THEN N'nt'
             -------------------------------------
             WHEN N'date'             THEN N'd'
             WHEN N'smalldatetime'    THEN N'sdt'
             WHEN N'datetime'         THEN N'dt'
             WHEN N'datetime2'        THEN N'dtt'
             WHEN N'datetimeoffset'   THEN N'dto'
             -------------------------------------
             WHEN N'time'             THEN N'tm'
             WHEN N'timestamp'        THEN N'ts'
             -------------------------------------
             WHEN N'money'            THEN N'm'
             WHEN N'smallmoney'       THEN N'sm'
             -------------------------------------
             WHEN N'geography'        THEN N'gg'
             WHEN N'geometry'         THEN N'gm'
             WHEN N'hierarchyid'      THEN N'h'
             -------------------------------------
             WHEN N'decimal'          THEN N'de'
             WHEN N'binary'           THEN N'bn'
             WHEN N'float'            THEN N'f'
             WHEN N'numeric'          THEN N'num'
             WHEN N'real'             THEN N'r'
             -------------------------------------
             WHEN N'image'            THEN N'im'
             WHEN N'sql_variant'      THEN N'v'
             WHEN N'SYSNAME'          THEN N's'
             WHEN N'uniqueidentifier' THEN CASE WHEN dc.definition   = N'(newsequentialid())' THEN N'SUID'
                                                WHEN dc.definition   = N'(newid())'           THEN N'NUID'
                                                ELSE N'uid'
                                           END
             WHEN N'varbinary'        THEN N'vb'
             WHEN N'xml'              THEN N'xml'
             ELSE COALESCE(typ.name,'###typ.name NOT FOUND###')
        END
      + CASE WHEN typ.name = N'BIT' THEN N''
             ELSE IIF(ic.max_length = -1
                     ,N'MAX'
                     ,COALESCE(TRY_CAST(ic.max_length * IIF(typ.name IN (N'nchar',N'nvarchar',N'ntext') -- double-byte data types
                                                           ,2
                                                           ,1)
                                        AS NVARCHAR(MAX))
                              ,N'<??>'))
        END
      --------------------------------------------------------------------------------------------------------------------------------------
      + IIF(ic.is_identity   = 1                     ,N' IDN(' + CAST(COALESCE(ic.increment_value,1) AS NVARCHAR(20)) + N')',N'')
      + IIF(ic.seq_object_id IS NOT NULL             ,N' SEQ(' + CAST(COALESCE(ic.seq_increment  ,1) AS NVARCHAR(20)) + N')',N'')
      + IIF(dc.definition    = N'(newsequentialid())',N' SUID',N'')
      + IIF(dc.definition    = N'(newid())'          ,N' NUID',N'')
      + IIF(ic.is_nullable   = 1                     ,N' NULL',N'')
      --------------------------------------------------------------------------------------------------------------------------------------
       -- Per BOL "ANSI_PADDING should always be set to ON. SET ANSI_PADDING setting does not affect the nchar, nvarchar, ntext, text
       --         ,image, varbinary(max), varchar(max), and nvarchar(max) data types.
       --         They always display the SET ANSI_PADDING ON behavior. This means trailing spaces and zeros are not trimmed."
      + IIF(ic.is_ansi_padded = 0 AND typ.name IN ('CHAR',N'NCHAR',N'BINARY',N'VARBINARY'),N' ' + N'PADOFF',N'')
      --------------------------------------------------------------------------------------------------------------------------------------
      + IIF(o.is_replicated          = 1 AND ic.is_replicated      = 0,N' ' + N'NOTREPL',N'')
      + IIF(o.is_merge_published     = 1 AND ic.is_merge_published = 0,N' ' + N'NOTMRG' ,N'')
      + IIF(ic.xml_collection_id     > 0,N' ' + N'XMLCID ' + QUOTENAME(ic.xml_collection_id   ),N'')
      + IIF(ic.rule_object_id        > 0,N' ' + N'RULEID ' + QUOTENAME(ic.rule_object_id      ),N'')
      + IIF(ic.encryption_type       > 0,N' ' + N'ENCTYPE' + QUOTENAME(ic.encryption_type_desc),N'')
      + IIF(ic.is_rowguidcol         = 1,N' ' + N'ROWUID'   ,N'')
      + IIF(ic.is_filestream         = 1,N' ' + N'FLSTRM'   ,N'')
      + IIF(ic.is_non_sql_subscribed = 1,N' ' + N'NonSQLSub',N'')
      + IIF(ic.is_dts_replicated     = 1,N' ' + N'DTSREPL'  ,N'')
      + IIF(ic.is_xml_document       = 1,N' ' + N'XMLDOC'   ,N'')
      + IIF(ic.is_hidden             = 1,N' ' + N'HIDN'     ,N'')
      + IIF(ic.is_masked             = 1,N' ' + N'MSKD'     ,N'')
      + IIF(ic.is_sparse             = 1,N' ' + N'SPARSE'   ,N'')
      + IIF(ic.is_column_set         = 1,N' ' + N'COLSET'   ,N'')
       ----------------------------------------------------------------------
      + IIF(ic.generated_always_type > 0,N' ' + N'GenAlwaysType(' +ic.generated_always_type_desc+ N')',N'')
      + IIF(ic.graph_type            > 0,N' ' + N'GrphTyp ' +ic.graph_type_desc                       ,N'')
       -- Encryption --------------------------------------------------------
      + IIF(ic.column_encryption_key_id > 0,N' ' + N'ENCKEYID' + QUOTENAME(ic.column_encryption_key_id)  ,N'')
      + IIF(ic.column_encryption_key_database_name IS NOT NULL,N' ' + N'ENCKEYDB' + QUOTENAME(ic.column_encryption_key_database_name),N'')

      -- Density & incremental uniqueness
      + CASE WHEN 1.0 * col_stats.Rows * col_stats.All_Density > 0.0
             THEN N' (' + [tempdb].[dbo].[SQLXL_3SD](1.0 * col_stats.Rows * col_stats.All_Density,N'N') + N')'
             WHEN iles.uniqueness    > 0.0      THEN N' (' + [tempdb].[dbo].[SQLXL_3SD](iles.uniqueness,N'N') + N')'
             WHEN ic.is_identity     = 1        THEN N''               -- identity column alreadu flagged above
             WHEN ic.seq_object_id  IS NOT NULL THEN N''               -- sequence column alreadu flagged above
             WHEN dc.definition      = N'(newsequentialid())' THEN N'' -- newsequentialid column alreadu flagged above
             WHEN o.type             = N'FT'    THEN N''               -- Assembly (CLR) table-valued function
             WHEN o.type             = N'IF'    THEN N''               -- SQL inline table-valued function
             WHEN o.type             = N'TF'    THEN N''               -- SQL table-valued-function
             WHEN o.type             = N'V'     THEN N''               -- view
             ELSE N' (N/A)'
        END

      -- Empty tables
      + IIF(mt_ps.object_id IS NOT NULL AND mt_pt.object_id IS NOT NULL
           ,N' (MT)'          -- table is empty
           ,N'')

      +IIF(COALESCE(col_stats.Steps,iles.steps) BETWEEN 1 AND 19
          ,N' STP(' + CAST(COALESCE(col_stats.Steps,iles.steps) AS NVARCHAR(20)) + N')'
          ,N'')
      -----------------------------------------------------------------------
      +IIF(    dc.definition    IS NOT NULL
           AND ic.seq_object_id IS NULL
           AND dc.definition    <> N'(newsequentialid())'
          ,IIF(LEN(dc.definition) > 21
              ,N' DFLT_CONS'
              ,N' DFLT:' + dc.definition)
          ,N'')
      +IIF(ic.is_computed = 1
          ,N' CCOL:' + IIF(ic.is_persisted = 1,N'Prst',N'NotPrst')
          ,N'')
      +IIF(chk.check_constraints IS NOT NULL,N' CHK',N'')

      -- Full Text ---------------------------------------------------------
      +IIF(ftic.column_id IS NOT NULL
          ,IIF(ftic.language_id           > 0,N' LCID ' + QUOTENAME(ftic.language_id),N'')
          + N' Semantics ' + IIF(ftic.statistical_semantics = 1,N'ON',N'OFF')
          ,N'')

  FROM (-- Get SQL version from source server
        SELECT version = TRY_CAST(run_value AS TINYINT)
          FROM [tempdb].[dbo].[SQLXL_Instance_info]
         WHERE name   = N'ProductMajorVersion'
           AND source = N'SERVERPROPERTY'
       ) AS v

 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS sp

 --------------------------------------------------------------------------------------------------------------------------------------
 -- get all columns, since we want to get columns:
 -- not included in NonClustered Columnstores
 -- candidates for clustered indexes on HEAPS
 -- candidates for "better" clustering index keys
 -- foreign key referenced columns
 -- columns not replicated
 -- columns with non-default properties
 --------------------------------------------------------------------------------------------------------------------------------------
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]            AS ic

  LEFT OUTER
  JOIN (--
        SELECT o.database_id
              ,o.object_id
              ,o.name
              ,o.type
              ,t.is_replicated
              ,t.is_merge_published
          FROM [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]  AS t
            ON o.database_id = t.database_id
           AND o.object_id   = t.object_id
       ) AS o
    ON ic.database_id = o.database_id
   AND ic.object_id   = o.object_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_types] AS typ
    ON ic.database_id  = typ.database_id
   AND ic.user_type_id = typ.user_type_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ftic                  -- info for full text columns
    ON ic.database_id = ftic.database_id
   AND ic.object_id   = ftic.object_id
   AND ic.column_id   = ftic.column_id
   AND N'90'          = ftic.type

  ------------------------------------------------------------------------------------------------------------------------------------------
  -- Column Statistics
  ------------------------------------------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN (-- Column Statistics
        SELECT sssh.database_id
              ,sssh.object_id
              ,sssh.column_id
              ,sssh.Rows
              ,sssh.steps
              ,ssdv.All_Density
              ,ssdv.Average_Length
              ,sshs.param_sniff
          FROM [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]    AS sssh
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS ssdv
            ON sssh.database_id = ssdv.database_id
           AND sssh.object_id   = ssdv.object_id
           AND sssh.column_id   = ssdv.column_id         -- column statistics. index computed separately
           AND 1                = ssdv.Row_ID            -- some column_IDs have more than one row. looks like broken references from days of future past
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary] AS sshs
            ON sssh.database_id = sshs.database_id
           AND sssh.object_id   = sshs.object_id
           AND sssh.column_id   = sshs.column_id
         WHERE sssh.Filter_Expression IS NULL -- only unfiltered statistics for now
      ) col_stats
    ON ic.database_id = col_stats.database_id
   AND ic.object_id   = col_stats.object_id
   AND ic.column_id   = col_stats.column_id

  LEFT OUTER
  JOIN (-- identify objects that are empty - no rows in any partitions
        SELECT database_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats]
         GROUP BY
               database_id
              ,object_id
        HAVING SUM(row_CNT) = 0
       ) AS mt_ps
    ON ic.database_id = mt_ps.database_id
   AND ic.object_id   = mt_ps.object_id

  LEFT OUTER
  JOIN (-- identify objects that are empty - no rows in any partitions
        SELECT database_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_partitions]
         GROUP BY
               database_id
              ,object_id
        HAVING SUM(rows) = 0
       ) AS mt_pt
    ON ic.database_id = mt_pt.database_id
   AND ic.object_id   = mt_pt.object_id

  ------------------------------------------------------------------------------------------------------------------------------------------
  LEFT OUTER -- Column DEFAULT constraints
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_default_constraints] AS dc
    ON ic.database_id       = dc.database_id
   AND ic.default_object_id = dc.object_id

  ------------------------------------------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN ( -- Column-level Check Constraints
        SELECT cc.database_id
              ,cc.parent_object_id
              ,cc.parent_column_id
              ,(-- check constraints for this column - full definitions.
                -- FOR XML PATH used since there can be multiple constraints on a column. STUFF applied above
                SELECT  NCHAR(92) + QUOTENAME(LTRIM(RTRIM(cx.name)))
                      + COALESCE( IIF(cx.uses_sql_ftn            = 1,N' ,*FTN*'       ,N'')
                                + IIF(cx.uses_sql_proc           = 1,N' ,*PROC*'      ,N'')
                                + IIF(cx.uses_sql_mthd           = 1,N' ,*MTHD*'      ,N'')
                                + IIF(cx.is_disabled             = 1,N' ,DSBLD'       ,N'')
                                + IIF(cx.is_not_for_replication  = 1,N' ,NOT_REPL'    ,N'')
                                + IIF(cx.is_not_trusted          = 1,N' ,NOT_TRUSTED' ,N'')
                                + IIF(cx.is_system_named         = 1,N' ,SYS_NM'      ,N'')
                                + IIF(cx.uses_database_collation = 0,N' ,NON-DB_COLL' ,N'')
                                + IIF(cxo.is_published           = 1,N' ,PBLSHD'      ,N'')
                                + IIF(cxo.is_schema_published    = 1,N' ,SCH_PBLSHD'  ,N'')
                               ,N'')
                      + N' ' + LTRIM(RTRIM(cx.definition))
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cx
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]           AS c
                    ON cc.database_id      = c.database_id
                   AND cc.parent_object_id = c.object_id
                   AND cc.parent_column_id = c.column_id
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]           AS cxo
                    ON cx.database_id = cxo.database_id
                   AND cx.object_id   = cxo.object_id
                 WHERE cc.database_id      = cx.database_id
                   AND cc.parent_object_id = cx.parent_object_id
                   AND cc.parent_column_id = cx.parent_column_id
                   FOR XML PATH (N''), TYPE
               ).value('(./text())[1]','NVARCHAR(4000)') AS check_constraints
          FROM (-- list of columns with check constraints - get one record per column in case of multiple constraints
                SELECT cc.database_id
                      ,cc.parent_object_id
                      ,cc.parent_column_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cc
                 WHERE cc.parent_column_id > 0 -- not a table constraint
                 GROUP BY
                       cc.database_id
                      ,cc.parent_object_id
                      ,cc.parent_column_id
               ) cc
       ) AS chk
    ON ic.database_id = chk.database_id
   AND ic.object_id   = chk.parent_object_id -- chk.object_id is the check constraint ID
   AND ic.column_id   = chk.parent_column_id

  ------------------------------------------------------------------------------------------------------------------------------------------
  LEFT OUTER
  JOIN (-- If statistics have not been computed individually for a column try the lead element from index statistics
        -- if more than 1 found take the averages
        SELECT ssdv.database_id
              ,ssdv.object_id
              ,ssdv.columns
              ,steps            = AVG(sssh.steps)
              ,uniqueness       = AVG(1.0 * sssh.rows * ssdv.All_Density)
          FROM (--
                SELECT database_id
                      ,object_id
                      ,index_ID
                      ,All_Density
                      ,Columns
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector]
                 WHERE index_id > 0
                   AND Row_ID   = 1
               ) AS ssdv
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader] AS sssh
            ON ssdv.database_id = sssh.database_id
           AND ssdv.object_id   = sssh.object_id
           AND ssdv.index_id    = sssh.index_id
         GROUP BY
               ssdv.database_id
              ,ssdv.object_id
              ,ssdv.Columns
       ) iles -- Index lead element statistics
    ON ic.database_id = iles.database_id
   AND ic.object_id   = iles.object_id
   AND ic.name        = iles.columns
) AS qry
OPTION (MAXDOP 1,FAST 1); -- NOTE: FORCE ORDER may slow things down

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Create table of all used and referenced columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- add index
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_column
    ON [tempdb].[dbo].[SQLXL_Index_column]
      (database_id
      ,object_id
      ,column_id
      )
  WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed [tempdb].[dbo].[SQLXL_Index_column]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Column Descriptors for Full Text indexes
/******************************************************************************************************************************************/
UPDATE tgt
   SET 
/*** LOCAL TESTING ***
SELECT tgt.database_id,tgt.parent_object_id,
--*/
       key_column_info = COALESCE(--
                                  STUFF(-- Strip off leading unnecessary characters
                                        (--
                                         SELECT NCHAR(92) + eix.[Column Descriptors]
                                            FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ftic
                                            JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS eix
                                              ON ftic.database_id = eix.database_id
                                             AND ftic.object_id   = eix.object_id
                                             -- No Object_ID column in XL_IDX_column
                                             AND ftic.column_id   = eix.column_id
                                           WHERE tgt.Database_ID  = ftic.Database_ID
                                             AND tgt.object_id    = ftic.object_id
                                             AND N'90'            = ftic.type
                                             FOR XML PATH(N''), TYPE
                                        ).value('(./text())[1]','NVARCHAR(4000)')
                                       ,1,1,N'')
                                 ,N'<Column Description not found>')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 WHERE tgt.type = N'90'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update Column Descriptors for Full Text indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Columns for Objects
/******************************************************************************************************************************************/
UPDATE tgt
   SET key_column_info = STUFF(
                               (SELECT  NCHAR(92)
                                      + COALESCE(icol.[Column Descriptors],N'')
                                  FROM [tempdb].[dbo].[SQLXL_Index_column] AS icol
                                 WHERE tgt.database_id = icol.database_id
                                   AND tgt.object_id   = icol.object_id
                                 ORDER BY
                                       icol.column_id
                                   FOR XML PATH(N''), TYPE
                               ).value('(./text())[1]','NVARCHAR(4000)')
                              ,1,1,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 WHERE tgt.rec_type = N'P'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update Column Descriptors for Objects'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END
/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_sys_index_columns] - index columns to identify those also included from CLUSTERED index
/******************************************************************************************************************************************/
UPDATE tgt
   SET in_clustered_index = 1
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS tgt
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ci
    ON tgt.database_id = ci.database_id
   AND tgt.object_id   = ci.object_id
   AND tgt.column_id   = ci.column_id
   AND N'1'            = ci.type
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update index columns to identify those also included in CLUSTERED index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_sys_index_columns] - Missing index column key sequence based on uniqueness
-- Sort by EQUALITY before INEQUALITY, followed by increasing uniqueness
/******************************************************************************************************************************************/
UPDATE tgt
   SET tgt.key_column_sequence = mic.rn
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS tgt
  JOIN (-- get key column "order" for missing indexes tied to increasing uniqueness
        SELECT ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
              ,ic.column_id
              ,rn = ROW_NUMBER() OVER (PARTITION BY ic.database_id
                                                   ,ic.object_id
                                                   ,ic.index_id
                                                   ,ic.type
                                           ORDER BY ic.column_usage -- EQUALITY before INEQUALITY
                                                   ,c.Uniqueness    -- most unique-est
                                                   ,c.max_length    -- shortest
                                                   ,c.Precision     -- bits before tinyints
                                                   ,c.is_nullable   -- NULLable last
                                      )
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS c
            ON ic.database_id                       = c.database_id
           AND ic.object_id                         = c.object_id
           AND ic.column_id                         = c.column_id
         WHERE ic.type                              = N'M'
           AND ic.column_usage                     <> N'INCLUDE'
      ) mic
    ON tgt.database_id = mic.database_id
   AND tgt.object_id   = mic.object_id
   AND tgt.index_id    = mic.index_id
   AND tgt.type        = mic.type
   AND tgt.column_id   = mic.column_id
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update Missing index key sequence based on column uniqueness'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Create - [SQLXL_Index_uniqueness] - Build table of index column uniqueness & display values
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Build table of column uniqueness & display values',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

SELECT icol.database_id
      ,object_id               = COALESCE(FK.object_id,icol.object_id)
      ,icol.index_id
      ,icol.type
      ,icol.key_column_sequence
      ,icol.is_included_column
      ,icol.rn
      ,icol.srt
      ,icol.column_id
      ,icol.uniqueness_flag
      ,icol.col_prefix
      ,icol.[Column Descriptors]
      ,icol.col_suffix
      ,uniqueness         = COALESCE(1.0 * icol.index_row_CNT * ssdv.All_Density,icol.col_uniqueness)
      ,idx_uniqueness_3sd = [tempdb].[dbo].[SQLXL_3SD](COALESCE(1.0 * icol.index_row_CNT * ssdv.All_Density,icol.col_uniqueness),N'N')
      ,col_uniqueness     = TRY_CAST(icol.col_uniqueness AS FLOAT)
      ,stat_uniqueness    = 1.0 * icol.index_row_CNT * ssdv.All_Density
      ,icol.index_row_CNT
      ,ssdv.All_Density
  INTO [tempdb].[dbo].[SQLXL_Index_uniqueness]
/*** LOCAL TESTING ***
IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_uniqueness]') IS NOT NULL)
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_uniqueness];
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT icol.database_id
      ,FK.object_id
      ,icol.object_id
      ,icol.index_id
      ,icol.type
      ,icol.key_column_sequence
      ,icol.is_included_column
      ,icol.rn
      ,icol.srt
      ,icol.column_id
      ,icol.col_prefix
      ,icol.[Column Descriptors]
      ,icol.col_suffix
      ,uniqueness         = COALESCE(1.0 * icol.index_row_CNT * ssdv.All_Density,icol.col_uniqueness)
      ,idx_uniqueness_3sd = [tempdb].[dbo].[SQLXL_3SD](COALESCE(1.0 * icol.index_row_CNT * ssdv.All_Density,icol.col_uniqueness),N'N')
      ,col_uniqueness     = TRY_CAST(icol.col_uniqueness AS FLOAT)
      ,stat_uniqueness    = 1.0 * icol.index_row_CNT * ssdv.All_Density
      ,icol.index_row_CNT
      ,ssdv.All_Density
--*/
  FROM (--
        SELECT icol.database_id
              ,icol.object_id
              ,icol.index_id
              ,icol.type
              ,ic.key_column_sequence
              ,icol.is_included_column
              ,icol.srt
              ,icol.column_id
              ,rn = ROW_NUMBER()
                    OVER (PARTITION BY icol.database_id
                                      ,icol.object_id
                                      ,icol.index_id
                                      ,icol.type
                                      ,icol.is_included_column
                              ORDER BY icol.srt           -- Index KEY columns first, then elements from clustered index
                                                          -- not in Missing index or Foreign Key
                                      ------------------------------------------------------------------------------------------------------
                                      ,CASE WHEN icol.srt = 1
                                            THEN CASE WHEN icol.type = N'M' OR icol.is_included_column = 1
                                                           -- missing index EQUALITY first.
                                                           -- Note: inequality predicate column and columns to the left of it can be used
                                                           -- for index seeks. Columns to the right of the inequality are not seek eligible
                                                      THEN CASE ic.column_usage
                                                                WHEN N'EQUALITY'   THEN 1
                                                                WHEN N'INEQUALITY' THEN 2
                                                                ELSE 3
                                                           END
                                                      ELSE ic.key_column_sequence
                                                 END
                                            ELSE 0
                                       END
                                      ------------------------------------------------------------------------------------------------------
                                      ,CASE WHEN icol.srt = 1
                                            THEN CASE WHEN icol.type = N'M' OR icol.is_included_column = 1
                                                      THEN c.[Uniqueness] -- default behavior - SQL Server sorts missing columns
                                                                          -- by ordinal position in the table itself.
                                                                          -- Instead start with column_usage (equality, inequality)
                                                                          -- then greatest uniqueness
                                                      ELSE 0
                                                 END
                                            WHEN icol.srt = 2
                                            THEN cix.key_column_sequence
                                            ELSE 0
                                       END
                         )
              -------------------------------------
              ,uniqueness_flag = CASE WHEN icol.srt = 0      THEN N'>'
                                      WHEN icol.srt = 1
                                       AND icol.type <> N'M' THEN N'>'
                                      WHEN icol.srt = 2      THEN N'&'
                                      WHEN icol.srt = 3      THEN N'#'
                                      WHEN icol.srt = 4      THEN N'#'
                                      ELSE N''
                                 END
              -------------------------------------
              ,col_prefix = CASE WHEN icol.type IN (N'2')
                                  AND icol.srt = 2
                                 THEN  -- CLUSTERED index elements added to index for unique reference to table
                                       N'CX('
                                     + CAST(cix.key_column_sequence AS NVARCHAR(20))
                                     + N')>'
                                 ELSE N''
                            END
              ,[Column Descriptors] = CASE icol.srt
                                           WHEN 3 THEN N'UNIQUIFIER i4 (1.00)'
                                           WHEN 4 THEN N'ROW LOCATOR i4 (1.00)'
                                           ELSE c.[Column Descriptors]
                                      END
                                     +IIF(ic.is_index_column_filtered = 1,N' FLT',N'')
              ,col_suffix = IIF(ic.partition_ordinal  = 1,N' PART',N'')
                           +IIF(ic.is_descending_key  = 1,N' DESC',N'')
                           +IIF(ic.column_usage       = N'INEQUALITY',N' {' + NCHAR(60) + NCHAR(62) + N'}',N'')
                           +IIF(    icol.srt = 1 AND icol.type IN (N'2',N'M')
                                AND (ic.in_clustered_index > 0 OR cix.column_id > 0)
                               ,N' =CX(' + CAST(cix.key_column_sequence AS NVARCHAR(20)) + N')' -- Index elements that are keys in
                                                                                                -- the CLUSTERED index
                               ,N'')
                           +IIF(icol.srt = 2 AND icol.type = N'M'
                               ,N' <CX(' + CAST(cix.key_column_sequence AS NVARCHAR(20)) + N')' -- CLUSTERED index elements added to index
                                                                                                -- for unique reference to table)
                               ,N'')
              ,col_uniqueness = IIF(-- Candidates for Clustered indexes
                                       1                      = c.is_identity
                                    OR 1                      = c.is_sequence
                                    OR c.default_constraint = N'(newsequentialid())'
                                    OR c.default_constraint = N'(newid())'
                                    OR icol.srt            IN (3,4)
                                   ,1.00
                                   ,c.uniqueness
                                   )
              ,index_row_CNT = sssh.Rows
          FROM (-- Get all candidate columns from across collected data
                ----------------------------------------------------------------------------------------------------------------------------
                -- Index columns - includes all [sys].[index_columns], [sys].[function_order_columns], [sys].[dm_db_missing_index_columns]
                --                             ,[sys].[fulltext_index_columns]
                ----------------------------------------------------------------------------------------------------------------------------
                SELECT database_id
                      ,object_id
                      ,index_id
                      ,type
                      ,is_included_column
                      ,srt                = 1
                      ,column_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]
                 WHERE is_included_column = 0
                ----------------------------------------------------------------------------------------------------------------------------
                UNION ALL -- Foreign Key Constraint columns
                ----------------------------------------------------------------------------------------------------------------------------
                SELECT database_id
                      ,object_id          = parent_object_id
                      ,index_id           = constraint_object_id
                      ,type               = N'F'
                      ,is_included_column = 0
                      ,srt                = 0
                      ,column_id          = parent_column_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]
                ----------------------------------------------------------------------------------------------------------------------------
                UNION ALL -- elements of the CLUSTERED index to add to the KEY display that are not in the current index, missing index
                ----------------------------------------------------------------------------------------------------------------------------
                SELECT i.database_id
                      ,i.object_id
                      ,i.index_id
                      ,i.type
                      ,is_included_column = TRY_CAST(0 AS BIT)
                      ,srt                = 2
                      ,cli.column_id
                  FROM (--
                        SELECT database_id
                              ,object_id
                              ,index_id
                              ,type
                          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                         WHERE rec_type  = N'I'
                           AND type NOT IN (N'F',N'1')
                       ) AS i
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS cli
                    ON i.database_id = cli.database_id
                   AND i.object_id   = cli.object_id
                   AND N'1'          = cli.type
                   AND 0             = cli.is_included_column
                ----------------------------------------------------------------------------------------------------------------------------
                EXCEPT -- KEY elements of the current index if they are also already in the Clustered index
                ----------------------------------------------------------------------------------------------------------------------------
                SELECT database_id
                      ,object_id
                      ,index_id
                      ,type
                      ,is_included_column = TRY_CAST(0 AS BIT)
                      ,srt                = 2
                      ,column_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]
                 WHERE is_included_column = 0
                ----------------------------------------------------------------------------------------------------------------------------
                UNION ALL -- Add [UNIQUIFIER]  if table is rowstore and a HEAP or non-Unique CLUSTERED
                          -- Add [ROW LOCATOR] if table is columnstore
                ----------------------------------------------------------------------------------------------------------------------------
                SELECT i.database_id
                      ,i.object_id
                      ,i.index_id
                      ,i.type
                      ,is_included_column = TRY_CAST(0 AS BIT)
                      ,srt                = IIF(u.type = N'5',4,3) -- 4 is ROW LOCATOR, 3 is UNIQUIFIER
                      ,column_id          = 0
                  FROM (--
                        SELECT database_id
                              ,object_id
                              ,index_id
                              ,type
                          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                         WHERE rec_type = N'I'
                           AND type    IN (N'1',N'2',N'7') -- include '7' Hash on In-Memory Clustered Columnstore
                       ) AS i
                  JOIN (--
                        SELECT database_id
                              ,object_id
                              ,type
                          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                         WHERE N'I'             = rec_type
                           AND type            IN (N'0',N'1',N'5')
                           AND is_unique        = 0
                       ) AS u
                    ON i.database_id = u.database_id
                   AND i.object_ID   = u.object_ID
               ) icol
          LEFT OUTER HASH
          JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS c                -- object all columns
            ON icol.database_id = c.database_id
           AND icol.object_id   = c.object_id
           AND icol.column_id   = c.column_id
          LEFT OUTER HASH
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic               -- column by index, FKC, MIX
            ON icol.database_id = ic.database_id
           AND icol.object_id   = ic.object_id
           AND icol.index_id    = ic.index_id
           AND icol.type        = ic.type
           AND icol.column_id   = ic.column_id
          LEFT OUTER HASH
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS cix              -- clustered index if available
            ON icol.database_id = cix.database_id
           AND icol.object_id   = cix.object_id
           AND N'1'             = cix.type
           AND icol.column_id   = cix.column_id
          LEFT OUTER HASH
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader] AS sssh -- 1 row per index/column
            ON icol.database_id = sssh.database_id
           AND icol.object_id   = sssh.object_id
           AND icol.index_id    = sssh.index_ID
                                -- No sssh.type
       ) icol

  LEFT OUTER HASH
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS ssdv
    ON icol.database_id = ssdv.database_id
   AND icol.object_id   = ssdv.object_id
   AND icol.index_id    = ssdv.index_ID
                        -- No ssdv.type column
   AND icol.rn          = ssdv.Row_ID

  LEFT OUTER HASH
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys] AS fk
    ON icol.database_id = fk.database_id
   AND icol.object_id   = fk.parent_object_id
   AND icol.index_id    = fk.object_id
OPTION (FORCE ORDER  -- suppresses "Warning: The join order has been enforced because a local join hint is used"
       ,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Build table of column uniqueness & display values'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- add index
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_uniqueness
    ON [tempdb].[dbo].[SQLXL_Index_uniqueness]
      (database_id
      ,object_id
      ,index_id
      ,type
      ,is_included_column
      ,rn
      )
  WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed [tempdb].[dbo].[SQLXL_Index_uniqueness]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - index statistics
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Update index statistics',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

SET ANSI_WARNINGS OFF
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/
      -- [sys].[stats] ----------------------------------------------------------
       stats_id                         = src.stats_id
      ,stats_Name                       = QUOTENAME(tgt.type_short_desc) + IIF(src.name IS NOT NULL,N' ' +src.NAME,N' N/A')
      ,stats_user_created               = src.user_created
      ,stats_auto_created               = src.auto_created
      ,stats_no_recompute               = src.no_recompute
      ,stats_has_filter                 = src.has_filter
      ,stats_filter_definition          = src.filter_definition
      ,stats_is_temporary               = COALESCE(src.is_temporary        ,0)
      ,stats_is_incremental             = COALESCE(src.is_incremental      ,0)
      ,stats_has_persisted_sample       = COALESCE(src.has_persisted_sample,0)
      ,stats_generation_method          = src.stats_generation_method
      ,stats_generation_method_desc     = src.stats_generation_method_desc
      -- [sys].[ShowStatistics_StatHeader] --------------------------------------
      ,stathdr_Updated                  = iss.Updated
      ,stathdr_Rows_CNT                 = COALESCE(iss.Rows              ,0)
      ,stathdr_Rows_sampled_CNT         = COALESCE(iss.Rows_sampled      ,0)
      ,stathdr_Steps                    = COALESCE(iss.Steps             ,0)
      ,stathdr_Density                  = COALESCE(iss.Density           ,0)
      ,stathdr_Average_key_Length       = COALESCE(iss.Average_Key_Length,0)
      ,stathdr_String_index             = iss.String_index
      ,stathdr_Filter_Expression        = iss.Filter_Expression
      ,stathdr_Unfiltered_Rows          = COALESCE(iss.Unfiltered_Rows         ,0)
      ,stathdr_Persisted_Sample_Percent = COALESCE(iss.Persisted_Sample_Percent,0)
      ,stathdr_Statistics_age_days      = COALESCE(iss.Statistics_age_days     ,0)
      -- [sys].[ShowStatistics_Histogram_summary] -------------------------------
      ,stathist_range_rows_LO           = COALESCE(ssh.min_rows_per_value,0)
      ,stathist_range_rows_HI           = COALESCE(ssh.max_rows_per_value,0)
      ,stathist_null_rows               = COALESCE(ssh.null_rows         ,0)
      ,stathist_param_sniff             = COALESCE(ssh.param_sniff       ,0)
      -- [sys].[dm_db_stats_properties], [sys].[dm_db_incremental_stats_properties] --
      ,Stats_Prop_modification_CNT      = COALESCE(dsp.modification_counter,dip.modification_counter,0)
      ,Stats_Prop_last_updated          = COALESCE(dsp.last_updated,dip.last_updated)
      ,Stats_Prop_updated_days_ago      = COALESCE(dsp.updated_days_ago,dip.updated_days_ago)
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]                    AS tgt
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_stats]                      AS src
    ON tgt.database_id = src.database_id
   AND tgt.object_id   = src.object_id
   AND tgt.index_id    = src.stats_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader]  AS iss
    ON tgt.database_id = iss.database_id
   AND tgt.object_id   = iss.object_id
   AND tgt.index_id    = iss.index_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary] AS ssh
    ON tgt.database_id = ssh.database_id
   AND tgt.object_id   = ssh.object_id
   AND tgt.index_id    = ssh.index_id
  LEFT OUTER
  JOIN (-- sum up all of the modifications to this index
        SELECT database_id
              ,object_id
              ,stats_id
              ,modification_counter = SUM(COALESCE(modification_counter,0))
              ,last_updated         = MAX(last_updated)
              ,updated_days_ago     = MIN(updated_days_ago)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_stats_properties]
         GROUP BY
               database_id
              ,object_id
              ,stats_id
       ) AS dsp
    ON tgt.database_id = dsp.database_id
   AND tgt.object_id   = dsp.object_id
   AND tgt.index_id    = dsp.stats_id
  LEFT OUTER
  JOIN (-- SUm up incremental statistics across partitions for this index
        -- introduced in 2014 (12.x) SP2 and 2016 (13.x) SP1
        SELECT database_id
              ,object_id
              ,stats_id
              ,modification_counter = SUM(COALESCE(modification_counter,0))
              ,last_updated         = MAX(last_updated)
              ,updated_days_ago     = MIN(updated_days_ago)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_incremental_stats_properties]
         GROUP BY
               database_id
              ,object_id
              ,stats_id
       ) AS dip
    ON tgt.database_id = dip.database_id
   AND tgt.object_id   = dip.object_id
   AND tgt.index_id    = dip.stats_id
 WHERE tgt.rec_type = N'I'
   AND TRY_CAST(tgt.type AS INT) IS NOT NULL
OPTION (MAXDOP 1);
SET ANSI_WARNINGS ON

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update index statistics'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - index size & count attributes
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/

       Key_Columns_CNT                 = COALESCE(fkc.key_columns_CNT      ,lng.key_columns_CNT      ,0)
      ,Included_Columns_CNT            = COALESCE(fkc.Included_Columns_CNT ,lng.Included_Columns_CNT ,0)
      ------------------------------------------------------------------------------------------------------
      ,key_total_datatype_length_bytes = COALESCE(fkc.key_column_width     ,lng.key_column_width     ,0)
      ,inc_total_datatype_length_bytes = COALESCE(fkc.included_column_width,lng.included_column_width,0)
      ,idx_total_datatype_length_bytes = COALESCE(fkc.total_width          ,lng.total_width          ,0)
      -----------------------------------------------------------------------------------------------------
      -- row_cnt is not maintained in sys.dm_db_partition_stats for XTP objects
      -----------------------------------------------------------------------------------------------------
      ,row_CNT                           = CASE WHEN ISNULL(ps.row_CNT,0) = 0 THEN tgt.row_CNT ELSE ps.row_CNT END
      -----------------------------------------------------------------------------------------------------
      ,Partition_CNT                     = COALESCE(ps.Partition_CNT             ,0)
      ,used_page_PG_CNT                  = COALESCE(ps.used_page_CNT             ,0)
      ,in_row_data_page_PG_CNT           = COALESCE(ps.in_row_data_page          ,0)
      ,in_row_used_page_PG_CNT           = COALESCE(ps.in_row_used_page          ,0)
      ,in_row_reserved_page_PG_CNT       = COALESCE(ps.in_row_reserved_page      ,0)
      ,lob_used_page_PG_CNT              = COALESCE(ps.lob_used_page             ,0)
      ,lob_reserved_page_PG_CNT          = COALESCE(ps.lob_reserved_page         ,0)
      ,row_overflow_used_page_PG_CNT     = COALESCE(ps.row_overflow_used_page    ,0)
      ,row_overflow_reserved_page_PG_CNT = COALESCE(ps.row_overflow_reserved_page,0)
      ,reserved_page_PG_CNT              = COALESCE(ps.reserved_page             ,0)

  FROM (-- all index-level records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND TRY_CAST(type AS INT) IS NOT NULL -- only real physical indexes get partition info
       ) AS tgt

  LEFT OUTER -- LEFT OUTER required since HEAPS have no columns and get excluded from subquery
  JOIN (-- Index sizes and counts
        SELECT ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
              ,key_column_width      = SUM(IIF(ic.is_included_column = 0 AND ic.type NOT IN (N'5',N'6')
                                              ,IIF(ac.Average_Length > 0,ac.Average_Length,ac.max_length)
                                              ,0))
              ,included_column_width = SUM(IIF(ic.is_included_column = 1 AND ic.type NOT IN (N'5',N'6')
                                              ,IIF(ac.Average_Length > 0,ac.Average_Length,ac.max_length)
                                              ,0))
              ,total_width           = SUM(IIF(ac.Average_Length > 0 AND ic.type NOT IN (N'5',N'6')
                                              ,ac.Average_Length
                                              ,ac.max_length))
              ,key_columns_CNT       = SUM(IIF(ic.is_included_column = 0,1,0))
              ,Included_Columns_CNT  = SUM(IIF(ic.is_included_column = 1,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS ac
            ON ic.database_id = ac.database_id
           AND ic.object_id   = ac.object_id
           -- No parent_object_id column in XL_IDX_column
           AND ic.column_id   = ac.column_id
         GROUP BY
               ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
       ) AS lng
    ON tgt.database_id = lng.database_id
   AND tgt.object_id   = lng.object_id
   AND tgt.index_id    = lng.index_id
   AND tgt.type        = lng.type

  LEFT OUTER -- LEFT OUTER required since HEAPS have no columns and get excluded from subquery
  JOIN (-- Index sizes and counts
        SELECT database_id                 = fkc.database_id
              ,object_id                   = fkc.constraint_object_id
              ,key_column_width            = SUM(IIF(ac.Average_Length > 0,ac.Average_Length,ac.max_length))
              ,included_column_width       = 0
              ,total_width                 = SUM(IIF(ac.Average_Length > 0,ac.Average_Length,ac.max_length))
              ,key_columns_CNT             = COUNT(1)
              ,Included_columns_CNT        = 0
          FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns] AS fkc
          JOIN [tempdb].[dbo].[SQLXL_Index_column]                  AS ac
            ON fkc.database_id      = ac.database_id
           AND fkc.parent_object_id = ac.object_id
           AND fkc.parent_column_id = ac.column_id
         GROUP BY
               fkc.database_id
              ,fkc.constraint_object_id
       ) AS fkc
    ON tgt.database_id = fkc.database_id
   AND tgt.object_id   = fkc.object_id
   AND tgt.index_id    = fkc.object_id
   AND tgt.type        = N'F'

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_partition_stats] AS ps
    ON tgt.database_id = ps.database_id
   AND tgt.object_id   = ps.object_id
   AND tgt.index_id    = ps.index_id

OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update index size & count attributes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - table columns with attributes Unique, Ordered IDs
-- Table Unique Ordered IDs - Identity, Sequence, GUID, Sequence GUID
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.database_id,tgt.parent_object_id,tgt.index_id,tgt.type,c.UNQ,c.column_id,ncx.index_id,
--*/
       tbl_cx_uniq_ordered_column_TYP       = c.UNQ
      ,tbl_cx_uniq_ordered_column_ID        = c.column_id
      ,tbl_smallest_uniq_Nonclustered_idx   = ncx.index_id
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  LEFT OUTER
  JOIN (-- find all tables with columns that are unique/incrementing
        SELECT c.database_id
              ,c.object_id
              ,c.Column_ID
              ,UNQ = CASE WHEN c.is_identity   = 1                      THEN N'IDN'
                          WHEN c.seq_object_id > 0                      THEN N'SEQ'
                          WHEN dc.definition   = N'(newsequentialid())' THEN N'SUID'
                          WHEN dc.definition   = N'(newid())'           THEN N'NUID'
                          ELSE N''
                     END
              ,rn = ROW_NUMBER() OVER (PARTITION BY c.database_id
                                                   ,c.object_id
                                           ORDER BY c.max_length          -- smallest one first if more than one
                                                   ,c.is_identity   DESC
                                                   ,c.seq_object_id DESC
                                                   ,dc.definition
                                      )
          FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]             AS c
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_default_constraints] AS dc
            ON c.database_id       = dc.database_id
           AND c.default_object_id = dc.object_id
         WHERE (   c.is_identity   = 1
                OR c.seq_object_id > 0
                OR dc.definition   = N'(newsequentialid())'
                OR dc.definition   = N'(newid())'
               )
       ) AS c
    ON tgt.database_id = c.database_id
   AND tgt.object_id   = c.object_id
   AND 1               = c.rn
  LEFT OUTER
  JOIN (-- find smallest unique index to replace heap
        SELECT i.database_id
              ,i.parent_object_id
              ,i.index_id
              ,rn = ROW_NUMBER() OVER (PARTITION BY i.database_id
                                                   ,i.parent_object_id
                                           ORDER BY i.stathdr_Average_Key_Length  -- smallest one first if more than one
                                                   ,i.Lead_Element_Uniqueness     -- most uniquest first key element next
                                                   ,i.Key_Columns_CNT             -- fewest key columns
                                                   ,ius.user_total_CNT  DESC    -- most used
                                      )
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_usage_stats] AS ius
            ON i.database_ID      = ius.database_id
           AND i.parent_object_ID = ius.object_id
           AND i.index_ID         = ius.index_id
         WHERE i.rec_type                 = N'I'
           AND i.type                     = N'2'
           AND (   i.is_primary_key       = 1
                OR i.is_unique_constraint = 1
                OR i.is_unique            = 1
               )
       ) AS ncx
    ON tgt.database_id      = ncx.database_id
   AND tgt.parent_object_id = ncx.parent_object_id
   AND 1                    = ncx.rn
 WHERE TRY_CAST(tgt.type AS INT) < 2
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update table columns with attributes Unique, Ordered,IDs'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - index column, statistics, uniqueness, compression
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Update index column statistics and attributes',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/

       element_uniqueness      = CASE WHEN tgt.type = N'0'
                                      THEN N'HEAP' + IIF(tgt.parent_object_type IN (N'IF',N'FT',N'TF',N'V')
                                                        ,NCHAR(92) + tgt.obj_type_short_label
                                                        ,N'')
                                      WHEN tgt.type = N'5'
                                      THEN N'CCS'
                                      WHEN tgt.type = N'6'
                                      THEN N'NCS'
                                      WHEN tgt.type = N'90'
                                      THEN N'FTX'
                                      WHEN LEN(REPLACE(un.uniq,NCHAR(92),N'')) > 0
                                      THEN STUFF(un.uniq,1,1,N'')
                                      ELSE COALESCE((--
                                                     SELECT TOP (1) -- And there is a candidate CLUSTERING index column
                                                            NCHAR(92) + [tempdb].[dbo].[SQLXL_3SD](xic.uniqueness,'N')
                                                       FROM [tempdb].[dbo].[SQLXL_Index_column] AS xic
                                                      WHERE tgt.tbl_is_clustered_columnstore = 0 -- not a CLUSTERED COLUMNSTORE
                                                        AND tgt.database_id = xic.database_id
                                                        AND tgt.object_id   = xic.object_id
                                                        AND (   1                      = xic.is_identity
                                                             OR 1                      = xic.is_sequence
                                                             OR xic.default_constraint = N'(newsequentialid())'
                                                             OR xic.default_constraint = N'(newid())'
                                                             OR 1.05                   > xic.Uniqueness
                                                            )
                                                      ORDER BY
                                                            xic.is_identity        DESC
                                                           ,xic.is_sequence        DESC
                                                           ,xic.default_constraint DESC
                                                           ,xic.Uniqueness         ASC
                                                    )
                                                   ,N''
                                                 )
                                 END
      ,Lead_Element_Uniqueness = (--
                                  SELECT TOP 1
                                         COALESCE(icol.stat_uniqueness,icol.col_uniqueness)
                                    FROM [tempdb].[dbo].[SQLXL_Index_uniqueness] AS icol
                                   WHERE tgt.database_id = icol.database_id
                                     AND tgt.object_id   = icol.object_id
                                     AND tgt.index_id    = icol.index_id
                                     AND tgt.type        = icol.type
                                     AND 0               = icol.is_included_column
                                     AND 1               = icol.srt
                                   ORDER BY
                                         icol.rn
                                 )
      ,key_element_length      = STUFF(-- Strip off leading unnecessary characters
                                       (--
                                        SELECT NCHAR(92) + TRY_CAST(ssdv.Average_Length AS NVARCHAR(20))
                                          FROM [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] ssdv
                                         WHERE tgt.database_id  = ssdv.database_id
                                           AND tgt.object_id    = ssdv.object_id
                                           --- No object_id in SSDV
                                           AND tgt.index_id     = ssdv.index_id
                                         ORDER BY ssdv.Row_ID
                                           FOR XML PATH (N''), TYPE
                                       ).value('(./text())[1]','NVARCHAR(4000)')
                                       ,1,1,N'')

     ----------------------------------------------------------------------------------------------------------------------------------
      ,key_column_info =
STUFF(-- Strip off leading unnecessary characters
      CASE WHEN N'CDC' = tgt.schema_name
            AND tgt.name LIKE N'fn_cdc_get_%'  -- Exclude Change Data Capture (CDC) functions
           THEN NCHAR(92) + N'<CDC>'
           ----------------------------------
           WHEN tgt.type = N'0'                -- HEAP found
           THEN  NCHAR(92)
               + CASE WHEN tgt.tbl_is_memory_optimized = 1
                      THEN N'<XTP HEAP>'
                      WHEN tgt.obj_type = N'U'
                      THEN COALESCE( N'<HEAP> Candidate Clustered Unique ordered column:'
                                   + NCHAR(92)
                                   + (-- If unique ordered column found show it here
                                      SELECT xic.[column descriptors]
                                        FROM [tempdb].[dbo].[SQLXL_Index_column] AS xic
                                       WHERE tgt.database_id                   = xic.database_id
                                         AND tgt.object_id                     = xic.object_id
                                         AND tgt.tbl_cx_uniq_ordered_column_ID = xic.column_id
                                     )
                                   ,N'<HEAP> Candidate clustering column:'
                                   + NCHAR(92)
                                   + (-- If no Unique Ordered column found, look for next best candidate
                                      SELECT TOP 1
                                             xic.[column descriptors]
                                        FROM [tempdb].[dbo].[SQLXL_Index_column]  AS xic
                                       WHERE tgt.database_id = xic.database_id
                                         AND tgt.object_id   = xic.object_id
                                         AND xic.Uniqueness  < 1.1
                                         AND xic.data_type NOT LIKE N'%DATE%'
                                       ORDER BY
                                             xic.uniqueness * COALESCE(xic.average_length,xic.max_length)
                                     )
                                   ,N'<HEAP> No candidate clustering column')
                     WHEN tgt.obj_type = N'V'
                     THEN N'<Unindexed View>'
                     ELSE N'<Unordered table-valued function>'
                 END
           ----------------------------------
           WHEN tgt.type = N'5'
           THEN  NCHAR(92) + N'<Clustered Columnstore>'
               + COALESCE( NCHAR(92)
                         + (--
                            SELECT TOP (1)
                                    COALESCE(ip.col_prefix + N' ',N'')
                                  + COALESCE(ip.[column descriptors],N'')
                                  + COALESCE(N' ' +ip.col_suffix,N'')
                             FROM [tempdb].[dbo].[SQLXL_Index_uniqueness] AS ip
                            WHERE tgt.database_id = ip.database_id
                              AND tgt.object_id   = ip.object_id
                              AND tgt.index_id    = ip.index_id
                              AND tgt.type        = ip.type
                              AND ip.col_suffix LIKE N'PART%'
                           )
                         ,N'')
           WHEN tgt.type = N'6'
           THEN NCHAR(92) + N'<Nonclustered Columnstore>'
               + COALESCE((--
                           SELECT TOP (1)
                                   NCHAR(92)
                                 + COALESCE(ip.col_prefix + N' ',N'')
                                 + COALESCE(ip.[column descriptors],N'')
                                 + COALESCE(N' ' + ip.col_suffix,N'')
                            FROM [tempdb].[dbo].[SQLXL_Index_uniqueness] AS ip
                           WHERE tgt.database_id = ip.database_id
                             AND tgt.object_id   = ip.object_id
                             AND tgt.index_id    = ip.index_id
                             AND tgt.type        = ip.type
                             AND ip.col_suffix LIKE N'PART%'
                          )
                         ,N'')
           ----------------------------------
           ELSE (--
                 SELECT  NCHAR(92)
                       + IIF(LEN(icol.col_prefix) > 0,icol.col_prefix,N'')
                             -- clustered index, don't include Stats Steps  since it's not useful
                       + CASE WHEN tgt.type = N'1'
                               AND CHARINDEX(N'STP(',icol.[Column Descriptors]) > 0
                              THEN LEFT(icol.[Column Descriptors],CHARINDEX(N'STP(',icol.[Column Descriptors]) - 2)
                              WHEN tgt.type = N'0' AND icol.srt = 3      -- don't show uniquifier for HEAPS
                              THEN N''
                              ELSE COALESCE(icol.[Column Descriptors],N'')
                         END
                       + IIF(LEN(icol.col_suffix) > 0,icol.col_suffix,N'')
                   FROM [tempdb].[dbo].[SQLXL_Index_uniqueness] AS icol
                  WHERE tgt.database_id = icol.database_id
                    AND tgt.object_id = icol.object_id
                    AND tgt.index_id  = icol.index_id
                    AND tgt.type      = icol.type
                    AND 0             = icol.is_included_column
                  ORDER BY
                        icol.rn
                    FOR XML PATH(N''), TYPE
                ).value('(./text())[1]','NVARCHAR(4000)')
      END
     ,1,1,N'')
     ----------------------------------------------------------------------------------------------------------------------------------

      ,Included_column_info = CASE tgt.type
                                   WHEN N'5'             -- Clustered Column Store
                                   THEN N'<All Columns>' -- NCHAR(92) included with concatenation of KEY & INCLUDED in PRESENT.SQL
                                   WHEN N'6'
                                   THEN (-- Nonclustered Column Store
                                         SELECT COALESCE( N'-- Excluded Eligible Table Columns -----------'
                                                        + (--
                                                           SELECT NCHAR(92)
                                                                 +ac.[Column Descriptors]
                                                                 +IIF(ic.column_id IS NOT NULL,N' <IDXKEY>',N'')
                                                            FROM (-- table columns not found in the Nonclustered Column Store
                                                                  SELECT c.column_id
                                                                    FROM [tempdb].[dbo].[SQLXL_Index_column] AS c
                                                                   WHERE tgt.database_id = c.database_id
                                                                     AND tgt.object_id   = c.object_id
                                                                     AND 1               = c.is_columnstore_eligible
                                                                  EXCEPT
                                                                  SELECT ic.column_id
                                                                    FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
                                                                   WHERE tgt.database_id = ic.database_id
                                                                     AND tgt.object_id   = ic.object_id
                                                                     AND tgt.index_id    = ic.index_id
                                                                     AND tgt.type        = ic.type
                                                                 ) AS c
                                                            JOIN [tempdb].[dbo].[SQLXL_Index_column] AS ac
                                                              ON tgt.database_id = ac.database_id
                                                             AND tgt.object_id   = ac.object_id
                                                             AND c.column_id     = ac.column_id
                                                            LEFT OUTER
                                                            JOIN (--
                                                                  SELECT ic.column_id
                                                                    FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
                                                                   WHERE tgt.database_id = ic.database_id
                                                                     AND tgt.object_id   = ic.object_id
                                                                     AND 0               = ic.is_included_column
                                                                   GROUP BY
                                                                         ic.column_id
                                                                 ) AS ic
                                                              ON c.column_id = ic.column_id
                                                           ORDER BY
                                                                 ac.name
                                                             FOR XML PATH(N''), TYPE
                                                          ).value('(./text())[1]','NVARCHAR(4000)')
                                                        ,N'<All Columns>')
                                        )
                                   WHEN N'F' THEN N'' -- No included columns for Foreign Key Constraints
                                   ELSE STUFF(-- Strip off leading unnecessary characters
                                              (--
                                               SELECT NCHAR(92)
                                                     +IIF(LEN(icol.col_prefix) > 0,icol.col_prefix,N'')
                                                      -- clustered index, don't include Stats Steps since it's not typically useful
                                                     + CASE WHEN tgt.type = N'1'
                                                             AND CHARINDEX(N'STP(',icol.[Column Descriptors]) > 0
                                                           THEN LEFT(icol.[Column Descriptors]
                                                                    ,CHARINDEX(N'STP(',icol.[Column Descriptors])-2)
                                                           ELSE COALESCE(icol.[Column Descriptors],N'')
                                                      END
                                                     +IIF(LEN(icol.col_suffix) > 0,icol.col_suffix,N'')
                                                 FROM [tempdb].[dbo].[SQLXL_Index_uniqueness] AS icol
                                                WHERE tgt.database_id = icol.database_id
                                                  AND tgt.object_id   = icol.object_id
                                                  AND tgt.index_id    = icol.index_id
                                                  AND tgt.type        = icol.type
                                                  AND 1               = icol.is_included_column
                                                ORDER BY
                                                      icol.rn
                                                  FOR XML PATH(N''), TYPE
                                              ).value('(./text())[1]','NVARCHAR(4000)')
                                             ,1,1,N'')
                              END
      ----------------------------------------------
      ,row_CNT                                    = COALESCE(p.rows         ,0)
      ,Partition_none_compress_CNT                = COALESCE(p.none_comp    ,0)
      ,Partition_row_compress_CNT                 = COALESCE(p.row_comp     ,0)
      ,Partition_page_compress_CNT                = COALESCE(p.page_comp    ,0)
      ,Partition_columnstore_compress_CNT         = COALESCE(p.colstore_comp,0)
      ,Partition_columnstore_archive_compress_CNT = COALESCE(p.colstore_arch,0)
      ,Partition_xml_compress_CNT                 = COALESCE(p.xml_comp     ,0)

  FROM (-- Index records except unindexed views - may have IDENTITY or SEQUENCE columns
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type           = N'I'
           AND NOT obj_type_label = N'VW UIV' -- <BS> exclude unindexed views - may have IDENTITY or SEQUENCE columns
       ) AS tgt
  LEFT OUTER
  JOIN (-- Get Index lead column type and nullable property
        SELECT ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
              ,sc.is_nullable
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]     AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]           AS o
            ON ic.database_id = o.database_id
           AND ic.object_id   = o.object_id
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]           AS sc
            ON ic.database_id = sc.database_id
           AND (   (    ic.type            = N'F'
                    AND o.parent_object_id = sc.object_id
                   )
                OR (    ic.type      <> N'F'
                    AND ic.object_id = sc.object_id
                   )
               )
           AND ic.column_id = sc.column_id
         WHERE 1            = ic.key_column_sequence
       ) AS nc
    ON tgt.database_id = nc.database_id
   AND tgt.object_id   = nc.object_id
   AND tgt.index_id    = nc.index_id
   AND tgt.type        = nc.type
  LEFT OUTER
  JOIN (-- Get count of compressed and archived partitions
        SELECT p.database_id
              ,p.object_id
              ,p.index_id
              ,rows          = SUM(p.rows)
              ,none_comp     = SUM(p.none_comp    )
              ,row_comp      = SUM(p.row_comp     )
              ,page_comp     = SUM(p.page_comp    )
              ,colstore_comp = SUM(p.colstore_comp)
              ,colstore_arch = SUM(p.colstore_arch)
              ,xml_comp      = SUM(p.xml_comp     )
          FROM [tempdb].[dbo].[SQLXL_Index_sys_partitions] AS p
         GROUP BY
               p.database_id
              ,p.object_id
              ,p.index_id
       ) AS p
    ON tgt.database_id = p.database_id
   AND tgt.object_id   = p.object_id
   AND tgt.index_id    = p.index_id
 OUTER
 APPLY (-- Assemble index statistics in uniqueness descending "corrected key" order
        SELECT(-- double select to accomodate .value('(./text())[1]','NVARCHAR(4000)') below
               SELECT  NCHAR(92)
                     + IIF(CHARINDEX(N' gg22 ',ucol.[Column Descriptors]) > 0,N'Geog',N'')
                     + IIF(CHARINDEX(N' gm22 ',ucol.[Column Descriptors]) > 0,N'Geom',N'')
                     + IIF(CHARINDEX(N'] xml' ,ucol.[Column Descriptors]) > 0,N'XML' ,N'')
                     --------------------------------------------------------------------
                      -- add indicator showing cumulative statistics as columns are added
                     + IIF(tgt.stathdr_Rows_CNT    > 0  ,ucol.uniqueness_flag   ,N'')
                     + IIF(ucol.idx_uniqueness_3sd > N'',ucol.idx_uniqueness_3sd,N'(N/A)')
                     + CASE WHEN ucol.stat_uniqueness > 0 -- use index stat uniqueness
                             AND i.row_CNT            > 0
                            THEN CASE WHEN ROUND(100.0 * ucol.stat_uniqueness / i.row_CNT,0) >= 1.0
                                           -- lead element is >= 1% of all table rows
                                      THEN N' (' + [tempdb].[dbo].[SQLXL_3SD](ucol.stat_uniqueness / i.row_CNT,N'%') + N')'
                                      ELSE N''
                                 END
                            WHEN ucol.col_uniqueness > 0 -- use column level uniqueness
                             AND i.row_CNT           > 0
                            THEN CASE WHEN ROUND(100.0 * ucol.col_uniqueness / i.row_CNT,0) > 1.0
                                        -- lead element is >= 1% of all index rows
                                      THEN N' (' + [tempdb].[dbo].[SQLXL_3SD](ucol.col_uniqueness / i.row_CNT,N'%') + N')'
                                      ELSE N''
                                 END
                            ELSE N''
                       END
                     + IIF(tgt.has_filter = 1, N' F',N'')      -- add indicator showing uniqueness values are on filtered index
                 FROM [tempdb].[dbo].[SQLXL_Index_uniqueness]  AS ucol
                 LEFT OUTER
                 JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
                   ON i.rec_type = N'I'
                  AND i.type    IN (N'0',N'1',N'5') -- get parent row count from HEAP, CLUSTERED, or Columnstore record
                  AND ucol.database_id = i.database_id
                  AND ucol.object_id   = i.object_id
                WHERE tgt.database_id  = ucol.database_id
                  AND tgt.object_id    = ucol.object_id
                  AND tgt.index_id     = ucol.index_id
                  AND tgt.type         = ucol.type
                  AND 0                = ucol.is_included_column
                ORDER BY
                      ucol.rn
                  FOR XML PATH(N''), TYPE
              ).value('(./text())[1]','NVARCHAR(4000)')
       ) AS un(uniq)
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update index column statistics and attributes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - index lead element. all but CCS, NCS, Missing indexes, TVFs
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/
       Lead_Element_Column_ID           = src.Lead_Element_Column_ID
--    ,Lead_Element_Uniqueness          = src.Lead_Element_Uniqueness -- computed above
      ,Lead_Element_Max_Len             = COALESCE(src.Lead_Element_Max_Len,0)
      ,Lead_Element_Data_Type           = src.Lead_Element_Data_Type
      ,Lead_Element_is_Identity         = src.Lead_Element_is_Identity
      ,Lead_Element_is_Sequence         = src.Lead_Element_is_Sequence
      ,Lead_Element_is_newsequentialid  = src.Lead_Element_is_newsequentialid
      ,Lead_Element_is_newid            = src.Lead_Element_is_newid
      ,Lead_Element_is_Nullable         = src.Lead_Element_is_Nullable

  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN (--
        SELECT database_id                     = ic.database_id
              ,object_id                       = ic.object_id
              ,index_ID                        = ic.index_id
              ,type                            = ic.type
              ,Lead_Element_Max_Len            = sc.max_length
              ,Lead_Element_Data_Type          = t.name
              ,Lead_Element_Column_ID          = ic.column_id
              ,Lead_Element_is_Identity        = sc.is_identity
              ,Lead_Element_is_Sequence        = sc.is_sequence
              ,Lead_Element_is_newsequentialid = IIF(sc.default_constraint = N'(newsequentialid())',1,0)
              ,Lead_Element_is_newid           = IIF(sc.default_constraint = N'(newid())'          ,1,0)
              ,Lead_Element_is_Nullable        = sc.is_nullable
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS sc
            ON ic.database_id  = sc.database_id
           AND ic.object_id    = sc.object_id
           -- No object_id column in XL_IDX_column
           AND ic.column_id    = sc.column_id
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_types]         AS t
            ON ic.database_id  = t.database_id
           AND sc.user_type_id = t.user_type_id
         WHERE TRY_CAST(ic.type AS INT) BETWEEN 1 AND 4
           AND ic.key_column_sequence = 1
       ) AS src
    ON tgt.database_id = src.database_id
   AND tgt.object_id   = src.object_id
   AND tgt.index_id    = src.index_id
   AND tgt.type        = src.type
 WHERE tgt.rec_type = N'I'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update index lead key element'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Partitions & Partition Functions
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/

       data_space_name                   = ds.data_space_name
      ,data_space_type                   = ds.data_space_type
--    ,data_space_logical_filename       = ds.file_logical_filename              -- can be many per object,omitting for now
      ,data_space_type_desc              = ds.data_space_type_desc
      ,data_space_is_default             = COALESCE(ds.data_space_is_default,0)
      ,data_space_is_system              = COALESCE(ds.data_space_is_system,0)
--    ,filegroup_guid                    = ds.filegroup_guid                     -- can be many per object,omitting for now
--    ,filegroup_is_read_only            = ds.filegroup_is_read_only             -- can be many per object,omitting for now
--    ,filegroup_is_autogrow_all_files   = ds.filegroup_is_autogrow_all_files    -- can be many per object,omitting for now
      ,partition_function_id             = ds.partition_function_id
      ,partition_function_name           = ds.partition_function_name
      ,partition_function_type           = ds.partition_function_type
      ,partition_function_type_desc      = ds.partition_function_type_desc
      ,partition_function_fanout         = ds.partition_function_fanout
      ,partition_function_boundary_value = ds.partition_function_boundary_value
      ,partition_function_is_system      = COALESCE(ds.partition_function_is_system,0)
      ,partition_function_create_DTTM    = ds.partition_function_create_date
      ,partition_function_modify_DTTM    = ds.partition_function_modify_date
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]       AS tgt
  LEFT OUTER
  JOIN (-- list of data spaces for Filestream objects
        SELECT database_id
              ,data_space_id
              ,data_space_name
              ,data_space_type
              ,data_space_type_desc
              ,data_space_is_default
              ,data_space_is_system
              ,filegroup_guid
              ,filegroup_is_read_only
              ,filegroup_is_autogrow_all_files
              ,partition_function_id
              ,partition_function_name
              ,partition_function_type
              ,partition_function_type_desc
              ,partition_function_fanout
              ,partition_function_boundary_value
              ,partition_function_is_system
              ,partition_function_create_date
              ,partition_function_modify_date
          FROM [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
         GROUP BY
               database_id
              ,data_space_id
              ,data_space_name
              ,data_space_type
              ,data_space_type_desc
              ,data_space_is_default
              ,data_space_is_system
              ,filegroup_guid
              ,filegroup_is_read_only
              ,filegroup_is_autogrow_all_files
              ,partition_function_id
              ,partition_function_name
              ,partition_function_type
              ,partition_function_type_desc
              ,partition_function_fanout
              ,partition_function_boundary_value
              ,partition_function_is_system
              ,partition_function_create_date
              ,partition_function_modify_date
       ) AS ds
    ON tgt.database_id   = ds.database_id
   AND tgt.data_space_id = ds.data_space_id
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update Partitions & Functions'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - metrics - Usage, Operational, missing index, row group operations, InMemory, ColumnStore
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
       ios.*,
--*/
      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_index_usage_stats], [sys].[dm_db_missing_index_details]
      -------------------------------------------------------------------------------------------------------------------------------------
       ius_user_total_CNT          = IIF(tgt.type = N'M'
                                        , COALESCE(mix.user_seeks  ,0)
                                        + COALESCE(mix.user_scans  ,0)
                                        , COALESCE(ius.user_total_CNT,0))
      ,ius_user_read_CNT           = COALESCE(mix.user_seeks     ,0)
                                   + COALESCE(mix.user_scans     ,0)
                                   + COALESCE(ius.user_read_CNT  ,0)
                                   + COALESCE(rgos.index_scan_CNT,0)
      ,ius_user_seeks_CNT          = COALESCE(mix.user_seeks     ,0)
                                   + COALESCE(ius.user_seeks     ,0)
      ,ius_user_scans_CNT          = COALESCE(mix.user_scans     ,0)
                                   + COALESCE(ius.user_scans     ,0)
                                   + IIF(tgt.type <> N'5',COALESCE(rgos.index_scan_CNT,0),0)
                                   + COALESCE(rgos.delete_buffer_scan_CNT,0)
      ,ius_user_lookups_CNT        = IIF(tgt.type = N'M',0,COALESCE(ius.user_lookups,0))
      ,ius_user_updates_CNT        = IIF(tgt.type = N'M',0,COALESCE(ius.user_updates,0))
      ,ius_system_seeks_CNT        = IIF(tgt.type = N'M',COALESCE(mix.system_seeks,0),COALESCE(ius.system_seeks,0))
      ,ius_system_scans_CNT        = IIF(tgt.type = N'M',COALESCE(mix.system_scans,0),COALESCE(ius.system_scans,0))
      ,ius_system_lookups_CNT      = IIF(tgt.type = N'M',0,COALESCE(ius.system_lookups,0))
      ,ius_system_updates_CNT      = IIF(tgt.type = N'M',0,COALESCE(ius.system_updates,0))
      ,ius_last_user_seek_DTTM     = IIF(tgt.type = N'M',mix.last_user_seek  ,ius.last_user_seek    ) -- NULL values OK for Dates
      ,ius_last_user_scan_DTTM     = IIF(tgt.type = N'M',mix.last_user_scan  ,ius.last_user_scan    ) -- NULL values OK for Dates
      ,ius_last_user_lookup_DTTM   = IIF(tgt.type = N'M',NULL                ,ius.last_user_lookup  ) -- NULL values OK for Dates
      ,ius_last_user_update_DTTM   = IIF(tgt.type = N'M',NULL                ,ius.last_user_update  ) -- NULL values OK for Dates
      ,ius_last_system_seek_DTTM   = IIF(tgt.type = N'M',mix.last_system_seek,ius.last_system_seek  ) -- NULL values OK for Dates
      ,ius_last_system_scan_DTTM   = IIF(tgt.type = N'M',mix.last_system_scan,ius.last_system_scan  ) -- NULL values OK for Dates
      ,ius_last_system_lookup_DTTM = IIF(tgt.type = N'M',NULL                ,ius.last_system_lookup) -- NULL values OK for Dates
      ,ius_last_system_update_DTTM = IIF(tgt.type = N'M',NULL                ,ius.last_system_update) -- NULL values OK for Dates
      -------------------------------------------------------             buffe
      ,ius_last_read_days_ago   = DATEDIFF(DAY,(SELECT TOP (1) dt
                                                  FROM (VALUES (mix.last_user_seek)
                                                              ,(mix.last_user_scan)
                                                              ,(ius.last_user_seek)
                                                              ,(ius.last_user_scan)
                                                              ,(ius.last_user_lookup)
                                                              ,(ius.last_user_update)
                                                       ) AS v(dt)
                                                 ORDER BY
                                                       v.dt DESC
                                               )
                                              ,sp.collection_DTTM
                                          )
      ,ius_last_write_days_ago  = DATEDIFF(DAY
                                          ,ius.last_user_update
                                          ,sp.collection_DTTM
                                          )

      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_index_operational_stats]
      -------------------------------------------------------------------------------------------------------------------------------------
      ,ios_partition_CNT                         = COALESCE(ios.partition_CNT                ,0)
      -----------------------------------------
      --Index Leaf/Key writes -----------------
      ,ios_leaf_insert_CNT                       = COALESCE(ios.leaf_insert_CNT              ,0)
      ,ios_leaf_update_CNT                       = COALESCE(ios.leaf_update_CNT              ,0)
      ,ios_leaf_delete_CNT                       = COALESCE(ios.leaf_delete_CNT              ,0)
      ,ios_leaf_ghost_CNT                        = COALESCE(ios.leaf_ghost_CNT               ,0)
      ,ios_total_leaf_Contacts_CNT               = COALESCE(ios.leaf_insert_CNT              ,0)
                                                 + COALESCE(ios.leaf_update_CNT              ,0)
                                                 + COALESCE(ios.leaf_delete_CNT              ,0)
                                                 + COALESCE(ios.leaf_ghost_CNT               ,0)
      --Index NonLeaf/Key writes --------------
      ,ios_nonleaf_insert_CNT                    = COALESCE(ios.nonleaf_insert_CNT           ,0)
      ,ios_nonleaf_delete_CNT                    = COALESCE(ios.nonleaf_delete_CNT           ,0)
      ,ios_nonleaf_update_CNT                    = COALESCE(ios.nonleaf_update_CNT           ,0)
      ,ios_total_nonleaf_Contacts_CNT            = COALESCE(ios.nonleaf_insert_CNT           ,0)
                                                 + COALESCE(ios.nonleaf_update_CNT           ,0)
                                                 + COALESCE(ios.nonleaf_delete_CNT           ,0)
      -----------------------------------------
      ,ios_leaf_allocation_CNT                   = COALESCE(ios.leaf_allocation_CNT          ,0)
                                                 + COALESCE(xis.page_split_CNT               ,0)
      ,ios_nonleaf_allocation_CNT                = COALESCE(ios.nonleaf_allocation_CNT       ,0)
                                                 + COALESCE(xis.key_split_CNT                ,0)
      -----------------------------------------
      ,ios_leaf_page_merge_CNT                   = COALESCE(ios.leaf_page_merge_CNT          ,0)
                                                 + COALESCE(xis.page_merge_CNT               ,0)
                                                 + COALESCE(xis.page_consolidation_CNT       ,0)
      ,ios_nonleaf_page_merge_CNT                = COALESCE(ios.nonleaf_page_merge_CNT       ,0)
                                                 + COALESCE(xis.key_merge_CNT                ,0)
      -----------------------------------------
      ,ios_range_scan_CNT                        = COALESCE(ios.range_scan_CNT               ,0) -- rolls up to TOTAL SCAN
      ,ios_singleton_lookup_CNT                  = COALESCE(ios.singleton_lookup_CNT         ,0)
      ,ios_forwarded_fetch_CNT                   = COALESCE(ios.forwarded_fetch_CNT          ,0)
      -----------------------------------------
      ,ios_lob_fetch_pages_CNT                   = COALESCE(ios.lob_fetch_in_pages           ,0)
      ,ios_lob_fetch_bytes_CNT                   = COALESCE(ios.lob_fetch_in_bytes           ,0)
      ,ios_lob_orphan_create_CNT                 = COALESCE(ios.lob_orphan_create_CNT        ,0)
      ,ios_lob_orphan_insert_CNT                 = COALESCE(ios.lob_orphan_insert_CNT        ,0)
      ,ios_row_overflow_fetch_in_pages_CNT       = COALESCE(ios.row_overflow_fetch_in_pages  ,0)
      ,ios_row_overflow_fetch_in_bytes_CNT       = COALESCE(ios.row_overflow_fetch_in_bytes  ,0)
      ,ios_column_value_push_off_row_CNT         = COALESCE(ios.column_value_push_off_row_CNT,0)
      ,ios_column_value_pull_in_row_CNT          = COALESCE(ios.column_value_pull_in_row_CNT ,0)
      -----------------------------------------
      ,ios_page_compression_attempt_CNT          = COALESCE(ios.page_compression_attempt_CNT,0)
      ,ios_page_compression_success_CNT          = COALESCE(ios.page_compression_success_CNT,0)
      ,ios_page_compression_fail_CNT             = COALESCE(ios.page_compression_attempt_CNT,0)
                                                 - COALESCE(ios.page_compression_success_CNT,0)
      -----------------------------------------
      ,ios_version_generated_off_row_CNT         = COALESCE(ios.version_generated_off_row_CNT        ,0)
      ,ios_ghost_version_inrow_CNT               = COALESCE(ios.ghost_version_inrow_CNT              ,0)
      ,ios_ghost_version_off_row_CNT             = COALESCE(ios.ghost_version_off_row_CNT            ,0)
      ,ios_insert_over_ghost_version_inrow_CNT   = COALESCE(ios.insert_over_ghost_version_inrow_CNT  ,0)
      ,ios_insert_over_ghost_version_off_row_CNT = COALESCE(ios.insert_over_ghost_version_off_row_CNT,0)

      -----------------------------------------
      ,ios_row_lock_CNT                          = COALESCE(ios.row_lock_CNT                 ,0)
      ,ios_row_lock_wait_CNT                     = COALESCE(ios.row_lock_wait_CNT            ,0)
      ,ios_row_lock_wait_MS_CNT                  = COALESCE(ios.row_lock_wait_MS             ,0)
--NOTE:ios_row_lock_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -----------------------------------------
      ,ios_page_lock_CNT                         = COALESCE(ios.page_lock_CNT     ,0)
      ,ios_page_lock_wait_CNT                    = COALESCE(ios.page_lock_wait_CNT,0)
      ,ios_page_lock_wait_MS_CNT                 = COALESCE(ios.page_lock_wait_MS ,0)
--NOTE:ios_page_lock_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -----------------------------------------
      ,ios_lock_promotion_attempt_CNT            = COALESCE(ios.lock_promotion_attempt_CNT,0)
      ,ios_lock_promotion_CNT                    = COALESCE(ios.lock_promotion_CNT        ,0)
      ,ios_lock_promotion_fail_CNT               = COALESCE(ios.lock_promotion_attempt_CNT,0)
                                                 - COALESCE(ios.lock_promotion_CNT        ,0)
      -----------------------------------------
      ,ios_page_latch_wait_CNT                   = COALESCE(ios.page_latch_wait_CNT,0)
      ,ios_page_latch_wait_MS_CNT                = COALESCE(ios.page_latch_wait_MS ,0)
--NOTE:ios_page_latch_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -----------------------------------------
      ,ios_page_io_latch_wait_CNT                = COALESCE(ios.page_io_latch_wait_CNT,0)
      ,ios_page_io_latch_wait_MS_CNT             = COALESCE(ios.page_io_latch_wait_MS ,0)
--NOTE:ios_page_io_latch_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -----------------------------------------
      ,ios_tree_page_latch_wait_CNT              = COALESCE(ios.tree_page_latch_wait_CNT,0)
      ,ios_tree_page_latch_wait_MS_CNT           = COALESCE(ios.tree_page_latch_wait_MS ,0)
--NOTE:ios_tree_page_latch_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -----------------------------------------
      ,ios_tree_page_io_latch_wait_CNT           = COALESCE(ios.tree_page_io_latch_wait_CNT,0)
      ,ios_tree_page_io_latch_wait_MS_CNT        = COALESCE(ios.tree_page_io_latch_wait_MS ,0)
--NOTE:ios_tree_page_io_latch_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      --------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_index_operational_stats] Lock & Wait Aggregates - includes ColumnStore & InMemory if found
      --------------------------------------------------------------------------------------------------------
      ,ops_total_lock_CNT                        = COALESCE(ios.row_lock_CNT       ,0)
                                                 + COALESCE(ios.page_lock_CNT      ,0)
                                                 + COALESCE(rgos.row_group_lock_CNT,0)
      -----------------------------------------
      ,ops_total_lock_wait_CNT                   = COALESCE(ios.row_lock_wait_CNT       ,0)
                                                 + COALESCE(ios.page_lock_wait_CNT      ,0)
                                                 + COALESCE(rgos.row_group_lock_wait_CNT,0)
      -----------------------------------------
      ,ops_total_lock_wait_MS_CNT                = COALESCE(ios.row_lock_wait_ms       ,0)
                                                 + COALESCE(ios.page_lock_wait_ms      ,0)
                                                 + COALESCE(rgos.row_group_lock_wait_MS,0)
      -----------------------------------------
--NOTE:ops_total_lock_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -----------------------------------------
      ,ops_total_wait_CNT                      = (  COALESCE(ios.row_lock_wait_CNT             ,0)
                                                  + COALESCE(ios.page_lock_wait_CNT            ,0)
                                                  + COALESCE(ios.page_latch_wait_CNT           ,0)
                                                  + COALESCE(ios.page_io_latch_wait_CNT        ,0)
                                                  + COALESCE(rgos.row_group_lock_wait_CNT      ,0)
                                                  -- ios.tree_page_latch_wait_CNT, ios.tree_page_io_latch_wait_CNT are subsets
                                                 )
      --------------------------------------
      ,ops_total_wait_MS_CNT                   = (  COALESCE(ios.row_lock_wait_MS          ,0)
                                                  + COALESCE(ios.page_lock_wait_MS         ,0)
                                                  + COALESCE(ios.page_latch_wait_MS        ,0)
                                                  + COALESCE(ios.page_io_latch_wait_MS     ,0)
                                                  + COALESCE(rgos.row_group_lock_wait_MS   ,0)
                                                  -- ios.tree_page_latch_wait_MS, ios.tree_page_io_latch_wait_MS are subsets
                                                 )
      --------------------------------------
--NOTE:ops_total_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_xtp_object_stats]
      -------------------------------------------------------------------------------------------------------------------------------------
      ,xtp_row_insert_attempts_CNT          = COALESCE(xis.row_insert_attempts         ,0)
      ,xtp_row_update_attempts_CNT          = COALESCE(xis.row_update_attempts         ,0)
      ,xtp_row_delete_attempts_CNT          = COALESCE(xis.row_delete_attempts         ,0)
      ,xtp_write_conflicts_CNT              = COALESCE(xis.write_conflicts             ,0)
      ,xtp_unique_constraint_violations_CNT = COALESCE(xis.unique_constraint_violations,0)
      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_xtp_index_stats]
      -------------------------------------------------------------------------------------------------------------------------------------
      ,xtp_scans_started_CNT                = COALESCE(xis.scans_started,0)
      ,xtp_scans_retries_CNT                = COALESCE(xis.scans_retries,0)                 -- rolled up to TOTAL
      ,xtp_rows_returned_CNT                = COALESCE(xis.rows_returned,0)
      ,xtp_rows_touched_CNT                 = COALESCE(xis.rows_touched ,0)
      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_xtp_Nonclustered_index_stats]
      -------------------------------------------------------------------------------------------------------------------------------------
      ,xtp_delta_pages_CNT                  = COALESCE(xis.delta_pages                   ,0)
      ,xtp_leaf_pages_CNT                   = COALESCE(xis.leaf_pages                    ,0)
      ,xtp_page_update_CNT                  = COALESCE(xis.page_update_CNT               ,0)
      ,xtp_page_update_retry_CNT            = COALESCE(xis.page_update_retry_CNT         ,0)
      ,xtp_page_consolidation_CNT           = COALESCE(xis.page_consolidation_CNT        ,0)
      ,xtp_page_consolidation_retry_CNT     = COALESCE(xis.page_consolidation_retry_CNT  ,0)
      ,xtp_page_split_CNT                   = COALESCE(xis.page_split_CNT                ,0)
      ,xtp_page_split_retry_CNT             = COALESCE(xis.page_split_retry_CNT          ,0)
      ,xtp_key_split_CNT                    = COALESCE(xis.key_split_CNT                 ,0)
      ,xtp_key_split_retry_CNT              = COALESCE(xis.key_split_retry_CNT           ,0)
      ,xtp_page_merge_CNT                   = COALESCE(xis.page_merge_CNT                ,0)
      ,xtp_page_merge_retry_CNT             = COALESCE(xis.page_merge_retry_CNT          ,0)
      ,xtp_key_merge_CNT                    = COALESCE(xis.key_merge_CNT                 ,0)
      ,xtp_key_merge_retry_CNT              = COALESCE(xis.key_merge_retry_CNT           ,0)
      ,xtp_uses_key_normalization           = COALESCE(xis.uses_key_normalization        ,0)
      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_xtp_memory_consumers]
      -------------------------------------------------------------------------------------------------------------------------------------
      ,xtp_allocated_bytes_CNT              = COALESCE(xis.allocated_bytes ,0)
      ,xtp_used_bytes_CNT                   = COALESCE(xis.used_bytes      ,0)
      ,xtp_allocation_CNT                   = COALESCE(xis.allocation_CNT  ,0)
      -------------------------------------------------------------------------------------------------------------------------------------
      -- [sys].[dm_db_column_store_row_group_operational_stats]
      -------------------------------------------------------------------------------------------------------------------------------------
      ,cs_partition_CNT                     = COALESCE(rgos.partition_CNT          ,0) --<FUTURE> move to appropriate OPS_ value
      ,cs_row_group_CNT                     = COALESCE(rgos.row_group_CNT          ,0)
      ,cs_index_scan_CNT                    = COALESCE(rgos.index_scan_CNT         ,0)
      ,cs_scan_CNT                          = COALESCE(rgos.scan_CNT               ,0)
      ,cs_delete_buffer_scan_CNT            = COALESCE(rgos.delete_buffer_scan_CNT ,0) --<FUTURE> move to appropriate OPS_ value
      ,cs_row_group_lock_CNT                = COALESCE(rgos.row_group_lock_CNT     ,0) --<FUTURE> eliminate in favor of ops_total values
      ,cs_row_group_lock_wait_CNT           = COALESCE(rgos.row_group_lock_wait_CNT,0) --<FUTURE> eliminate in favor of ops_total values
      ,cs_row_group_lock_wait_MS_CNT        = COALESCE(rgos.row_group_lock_wait_MS ,0) --<FUTURE> eliminate in favor of ops_total values
--NOTE:cs_row_group_lock_wait_MS_AVG computed in "All millisecond (_MS) average (_AVG) computed values" below
      ,cs_returned_row_CNT                  = COALESCE(rgos.returned_row_CNT       ,0)
      ,cs_returned_aggregate_CNT            = COALESCE(rgos.returned_aggregate_CNT ,0)
      ,cs_returned_group_CNT                = COALESCE(rgos.returned_group_CNT     ,0)
      ,cs_input_groupby_row_CNT             = COALESCE(rgos.input_groupby_row_CNT  ,0)

      /************************************************************************************************************************************/
      -- Operational Metrics Aggregates
      ---------------------------------------------------------------------------------------
      ,ops_total_contacts_CNT         = -----------------------------------------------
                                        -- WRITES
                                        -----------------------------------------------
                                          COALESCE(ios.leaf_insert_CNT              ,0)
                                        + COALESCE(ios.leaf_update_CNT              ,0)
                                        + COALESCE(ios.leaf_delete_CNT              ,0)
                                        + COALESCE(ios.leaf_ghost_CNT               ,0)
                                        + COALESCE(ios.nonleaf_insert_CNT           ,0)
                                        + COALESCE(ios.nonleaf_delete_CNT           ,0)
                                        + COALESCE(ios.nonleaf_update_CNT           ,0)
                                        + COALESCE(ios.lob_orphan_create_CNT        ,0)
                                        + COALESCE(ios.column_value_push_off_row_CNT,0)
                                        + COALESCE(ios.column_value_pull_in_row_CNT ,0)
                                        + COALESCE(ios.page_compression_success_CNT ,0)
                                        ---------------------------------
                                        + COALESCE(xis.row_insert_attempts          ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        + COALESCE(xis.row_update_attempts          ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        + COALESCE(xis.row_delete_attempts          ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        ---------------------------------
                                        + COALESCE(xis.page_update_CNT              ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.page_consolidation_CNT       ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.page_split_CNT               ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.key_split_CNT                ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.page_merge_CNT               ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.key_merge_CNT                ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        -----------------------------------------------
                                        -- READS
                                        -----------------------------------------------
                                        + COALESCE(ios.range_scan_CNT               ,0)
                                        + COALESCE(ios.singleton_lookup_CNT         ,0)
                                        + COALESCE(ios.forwarded_fetch_CNT          ,0)
                                        + COALESCE(ios.lob_fetch_in_pages           ,0)
                                        + COALESCE(ios.page_compression_attempt_CNT ,0)
                                        ---------------------------------
                                        + COALESCE(xis.scans_started                ,0) -- InMemory [sys].[dm_db_xtp_index_stats]
--                                      + COALESCE(xis.rows_touched                 ,0) -- InMemory [sys].[dm_db_xtp_index_stats]
                                        ---------------------------------
                                        + COALESCE(rgos.scan_CNT                    ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.delete_buffer_scan_CNT      ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.index_scan_CNT              ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.row_group_lock_CNT          ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
      /********************************************************************************/
      ,ops_total_read_CNT             =   COALESCE(ios.range_scan_CNT               ,0)
                                        + COALESCE(ios.singleton_lookup_CNT         ,0)
                                        + COALESCE(ios.forwarded_fetch_CNT          ,0)
                                        + COALESCE(ios.lob_fetch_in_pages           ,0)
                                        + COALESCE(ios.page_compression_attempt_CNT ,0)
                                        + COALESCE(xis.scans_started                ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        + COALESCE(rgos.index_scan_CNT              ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.scan_CNT                    ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.delete_buffer_scan_CNT      ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
      --------------------------------
      ,ops_total_scan_CNT             =   COALESCE(ios.range_scan_CNT               ,0)
                                        + COALESCE(xis.scans_started                ,0) -- InMemory [sys].[dm_db_xtp_index_stats]
                                        + COALESCE(rgos.index_scan_CNT              ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.scan_CNT                    ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
                                        + COALESCE(rgos.delete_buffer_scan_CNT      ,0) -- Columnstore [dm_db_column_store_row_group_operational_stats]
      --------------------------------
      ,ops_total_scan_retries_CNT     =   COALESCE(xis.scans_retries                ,0)
      /********************************************************************************/
      ,ops_total_write_CNT            =   COALESCE(ios.leaf_insert_CNT              ,0)
                                        + COALESCE(ios.leaf_update_CNT              ,0)
                                        + COALESCE(ios.leaf_delete_CNT              ,0) 
                                        + COALESCE(ios.leaf_ghost_CNT               ,0)
                                        + COALESCE(ios.nonleaf_insert_CNT           ,0)
                                        + COALESCE(ios.nonleaf_update_CNT           ,0)
                                        + COALESCE(ios.nonleaf_delete_CNT           ,0)
                                        -----------------------------------------------
                                        + COALESCE(ios.leaf_allocation_CNT          ,0)
                                        + COALESCE(ios.leaf_page_merge_CNT          ,0)
                                        + COALESCE(ios.nonleaf_allocation_CNT       ,0)
                                        + COALESCE(ios.nonleaf_page_merge_CNT       ,0)
                                        -----------------------------------------------
                                        + COALESCE(ios.lob_orphan_create_CNT        ,0)
                                        + COALESCE(ios.lob_orphan_insert_CNT        ,0)
                                        + COALESCE(ios.column_value_push_off_row_CNT,0)
                                        + COALESCE(ios.column_value_pull_in_row_CNT ,0)
--                                      + COALESCE(ios.page_compression_success_CNT ,0) -- excluded since is a system process
                                        + COALESCE(rgos.row_group_lock_CNT          ,0) -- Columnstore
                                        -----------------------------------------------
                                        + COALESCE(xis.row_insert_attempts          ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        + COALESCE(xis.row_update_attempts          ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        + COALESCE(xis.row_delete_attempts          ,0) -- InMemory [sys].[dm_db_xtp_object_stats]
                                        + COALESCE(xis.page_update_CNT              ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        -----------------------------------------------
                                        + COALESCE(xis.page_consolidation_CNT       ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.page_split_CNT               ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.key_split_CNT                ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.page_merge_CNT               ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.key_merge_CNT                ,0) -- InMemory [sys].[dm_db_xtp_Nonclustered_index_stats]
                                        + COALESCE(xis.write_conflicts              ,0)
                                        + COALESCE(xis.unique_constraint_violations ,0)
      --------------------------------
      ,ops_total_insert_CNT           =   COALESCE(ios.leaf_insert_CNT              ,0)
                                        + COALESCE(ios.nonleaf_insert_CNT           ,0)
                                        + COALESCE(ios.lob_orphan_insert_CNT        ,0) -- bulk operations
                                        ---------------------------------
                                        + COALESCE(xis.row_insert_attempts          ,0) -- InMemory
      --------------------------------
      ,ops_total_update_CNT           =   COALESCE(ios.leaf_update_CNT              ,0)
                                        + COALESCE(ios.nonleaf_update_CNT           ,0)
                                        ---------------------------------
                                        + COALESCE(xis.row_update_attempts          ,0) -- InMemory
                                        + COALESCE(xis.page_update_CNT              ,0) -- InMemory
      --------------------------------
      ,ops_total_delete_CNT           =   COALESCE(ios.leaf_delete_CNT              ,0)
                                        + COALESCE(ios.nonleaf_delete_CNT           ,0)
                                        + COALESCE(ios.leaf_ghost_CNT               ,0)
                                        ---------------------------------
                                        + COALESCE(xis.row_delete_attempts          ,0) -- InMemory
      --------------------------------
      ,ops_total_page_split_CNT       =   COALESCE(ios.leaf_allocation_CNT    ,0)
                                        + COALESCE(ios.nonleaf_allocation_CNT ,0)
                                        + COALESCE(ios.column_value_push_off_row_CNT,0)
                                        + COALESCE(xis.page_split_CNT               ,0) -- InMemory
                                        + COALESCE(xis.key_split_CNT                ,0) -- InMemory
      --------------------------------
      ,ops_total_page_merge_CNT       =   COALESCE(ios.leaf_page_merge_CNT          ,0)
                                        + COALESCE(ios.nonleaf_page_merge_CNT       ,0)
                                        + COALESCE(ios.column_value_pull_in_row_CNT ,0)
                                        + COALESCE(xis.page_merge_CNT               ,0) -- InMemory
                                        + COALESCE(xis.key_merge_CNT                ,0) -- InMemory
                                        + COALESCE(xis.page_consolidation_CNT       ,0) -- InMemory
      /********************************************************************************/
      ,reserved_page_PG_CNT           = IIF(  COALESCE(xis.allocated_bytes,0) / 8192.0    -- InMemory
                                            > COALESCE(tgt.reserved_page_PG_CNT,0)
                                           ,COALESCE(xis.allocated_bytes,0) / 8192.0      -- InMemory
                                           ,COALESCE(tgt.reserved_page_PG_CNT,0))
      --------------------------------
      ,used_page_PG_CNT               = IIF(  CEILING(COALESCE(xis.used_bytes,0) / 8192.0) -- InMemory
                                            > COALESCE(tgt.used_page_PG_CNT,0)
                                           ,CEILING(COALESCE(xis.used_bytes,0) / 8192.0)  -- InMemory
                                           ,COALESCE(tgt.used_page_PG_CNT,0))
      /********************************************************************************/
      ,buffer_total_KB_CNT            = IIF(  COALESCE(xis.allocated_bytes,0) / 1024.0    -- InMemory
                                            > COALESCE(tgt.buffer_total_KB_CNT,0)
                                           ,COALESCE(xis.allocated_bytes,0) / 1024.0      -- InMemory
                                           ,COALESCE(tgt.buffer_total_KB_CNT,0))
      --------------------------------
      ,buffer_free_KB_CNT             = IIF(  (COALESCE(xis.allocated_bytes,0) - COALESCE(xis.used_bytes,0)) / 1024.0 -- InMemory
                                            > COALESCE(tgt.buffer_free_KB_CNT,0)
                                           ,(COALESCE(xis.allocated_bytes,0) - COALESCE(xis.used_bytes,0)) / 1024.0   -- InMemory
                                           ,COALESCE(tgt.buffer_free_KB_CNT,0))
/*** LOCAL TESTING ***
SELECT COUNT(1)
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters]            AS sp
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation]                       AS tgt
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_operational_stats] AS ios
    ON tgt.database_id = ios.database_id
   AND tgt.object_id   = ios.object_id
   AND tgt.index_id    = ios.index_id
   AND TRY_CAST(tgt.type AS INT) IS NOT NULL
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_index_usage_stats]       AS ius
    ON tgt.database_id = ius.database_id
   AND tgt.object_id   = ius.object_id
   AND tgt.index_id    = ius.index_id
   AND TRY_CAST(tgt.type AS INT) IS NOT NULL -- avoids overlapping index IDs for FKC, MIX
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_missing_index_details]   AS mix
    ON tgt.database_id = mix.database_id
   AND tgt.object_id   = mix.object_id
   AND tgt.index_id    = mix.index_handle
   AND tgt.type        = N'M'              -- avoids overlapping index IDs for FKC, IDX
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_xtp_index_stats]         AS xis
    ON tgt.database_id = xis.database_id
   AND tgt.object_id   = xis.object_id
   AND tgt.index_id    = xis.index_id
   AND tgt.type        = xis.type
   AND TRY_CAST(tgt.type AS INT) IS NOT NULL -- avoids overlapping index IDs for FKC, MIX
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_operational_stats] AS rgos
    ON tgt.database_id = rgos.database_id
   AND tgt.object_id   = rgos.object_id
   AND tgt.index_id    = rgos.index_id
   AND tgt.type       IN (N'5',N'6')       -- avoids overlapping index IDs for FKC, IDX
 WHERE tgt.rec_type = N'I'
OPTION (FORCE ORDER,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update metrics - Usage, Operational, missing index, row group operational'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - indexes with WRITEs and Zero READs. Final partition count update
/******************************************************************************************************************************************/
UPDATE [tempdb].[dbo].[SQLXL_Index_Compilation]
   SET
       ius_no_read_user_updates_CNT = IIF(ius_user_updates_CNT > 0 AND ius_user_read_CNT  = 0,ius_user_updates_CNT,0)
      ,ops_no_read_total_write_CNT  = IIF(ops_total_write_CNT  > 0 AND ops_total_read_CNT = 0,ops_total_write_CNT ,0)
      ,partition_CNT                = CASE WHEN ios_partition_CNT > 0 THEN ios_partition_CNT
                                           WHEN partition_CNT     > 0 THEN partition_CNT
                                           WHEN cs_partition_CNT  > 0 THEN cs_partition_CNT
                                           ELSE 0
                                      END
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update indexes with WRITEs and Zero READs, partition counts'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Parent partition information, using HEAP or CLUSTERED values
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/

       partition_CNT                     = CASE WHEN hoc.cs_partition_CNT  > 0 THEN hoc.cs_partition_CNT
                                                WHEN hoc.ios_partition_CNT > 0 THEN hoc.ios_partition_CNT
                                                WHEN hoc.partition_CNT     > 0 THEN hoc.partition_CNT
                                                ELSE 0
                                           END
      ,partition_Column_ID               = hoc.partition_Column_ID
      ,partition_Column_Name             = hoc.partition_Column_Name
      ,partition_schemes_function_id     = hoc.partition_schemes_function_id
      ,partition_schemes_name            = hoc.partition_schemes_name
      ,partition_function_id             = hoc.partition_function_id
      ,partition_function_name           = hoc.partition_function_name
      ,partition_function_type           = hoc.partition_function_type
      ,partition_function_type_desc      = hoc.partition_function_type_desc
      ,partition_function_fanout         = hoc.partition_function_fanout
      ,partition_function_boundary_value = hoc.partition_function_boundary_value
      ,partition_function_is_system      = hoc.partition_function_is_system
      ,partition_function_create_DTTM    = hoc.partition_function_create_DTTM
      ,partition_function_modify_DTTM    = hoc.partition_function_modify_DTTM
      --------------------------------------------------------------------------------------------------------------------------------------
      -- average table rows size - computed here in order to make sure all reserved sizes are captured, especially in memory
      --------------------------------------------------------------------------------------------------------------------------------------
      ,tbl_row_size_byte_AVG            = IIF(hoc.row_CNT > 0
                                             ,(8192.0 * hoc.reserved_page_PG_CNT) / hoc.row_CNT
                                             ,NULL)
      ,tbl_is_empty                     = IIF(ISNULL(hoc.row_CNT,0) = 0,1,0)

  FROM (-- Parent objects only
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type NOT IN (N'A'  -- all/instance
                               ,N'D'  -- database
                               ,N'I') -- Index
       ) AS tgt
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation]  AS hoc
    ON tgt.database_id = hoc.database_id
   AND tgt.object_id   = hoc.object_id
   AND hoc.type       IN (N'0'  -- rowstore heap
                         ,N'1'  -- rowstore clustered index
                         ,N'5') -- CLUSTERED COLUMNSTORE
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update Parent partition information, using HEAP or CLUSTERED values'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - additional keys don't improve selectivity much (1 out of 3 ain't bad). No activity
/******************************************************************************************************************************************/
IF object_id(N'[tempdb].[dbo].[SQLXL_Index_additional_key_selectivity]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_additional_key_selectivity];

SELECT dv1.database_id
      ,dv1.object_id
      ,dv1.index_ID
      ,dlt    = TRY_CAST(dv1.Row_ID AS NVARCHAR(20)) + N'('
              + CAST(TRY_CAST(100.0 * dv1.All_Density / dv0.All_Density AS TINYINT) AS NVARCHAR(20)) -- /zero handled by JOIN clause below
              + N'%)'
      ,row_id = ROW_NUMBER() OVER (PARTITION BY dv1.database_id
                                            ,dv1.object_id
                                            ,dv1.index_ID
                                    ORDER BY dv1.Row_ID
                               )
  INTO [tempdb].[dbo].[SQLXL_Index_additional_key_selectivity]
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT dv1.database_id
      ,dv1.object_id
      ,dv1.index_ID
      ,dlt    = TRY_CAST(dv1.Row_ID AS NVARCHAR(20)) + N'('
              + CAST(TRY_CAST(100.0 * dv1.All_Density / dv0.All_Density AS TINYINT) AS NVARCHAR(20))
              + N'%)'
      ,row_id = ROW_NUMBER() OVER (PARTITION BY dv1.database_id
                                            ,dv1.object_id
                                            ,dv1.index_ID
                                    ORDER BY dv1.Row_ID
                               )
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS dv1
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns]                AS ic
    ON dv1.database_id  = ic.database_id
   AND dv1.object_id    = ic.object_id
   AND dv1.index_ID     = ic.index_ID
   AND dv1.Row_ID       = ic.key_column_sequence
   AND 0                = ic.is_included_column      -- only KEY index elements are to be compared
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS dv0
    ON dv1.database_id  = dv0.database_id
   AND dv1.object_id    = dv0.object_id
   AND dv1.index_ID     = dv0.index_ID
   AND (dv1.Row_ID - 1) = dv0.row_id
   AND 0.0              < dv0.All_Density            -- avoide divide by zero below
 WHERE 1 = 1
   AND dv1.All_Density / dv0.All_Density > 1.0 / 3.0 -- if more then 1/3 of previous keys records returned
OPTION (MAXDOP 1)

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update index records - additional keys don''t improve selectivity - support'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_additional_key_selectivity
    ON [tempdb].[dbo].[SQLXL_Index_additional_key_selectivity]
      (database_id
      ,object_id
      ,index_ID
      ,row_id
      ) WITH (DATA_COMPRESSION = PAGE)

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed [tempdb].[dbo].[SQLXL_Index_additional_key_selectivity]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - indexes without activity and low key additional selectivity
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.rec_type,tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,
--*/
       is_activity_for_period = IIF(   COALESCE(tgt.ius_user_total_CNT    ,0) > 0
                                    OR COALESCE(tgt.ops_total_contacts_CNT,0) > 0
                                   ,1
                                   ,0)
      ,low_selectivity_additional_keys
       = (-- List of keys not making the index that much more selective
          SELECT  CASE WHEN d.row_id      = 1 THEN             N'Key Selectivity LO > '
                       WHEN d.row_id % 13 = 0 THEN NCHAR(92) + N'> ' -- add line feed after every 12 key values to wrap in cell
                       ELSE N' '
                  END
                + d.dlt
             FROM [tempdb].[dbo].[SQLXL_Index_additional_key_selectivity] AS d
            WHERE tgt.database_id = d.database_id
              AND tgt.object_id   = d.object_id
              AND tgt.index_ID    = d.index_ID
            ORDER BY
                  d.row_id
              FOR XML PATH(N''), TYPE
           ).value('(./text())[1]','NVARCHAR(4000)')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 WHERE tgt.rec_type                  = N'I'
   AND tgt.type                     IN (N'1',N'2')
   AND tgt.obj_type_short_label NOT IN (N'HST', N'IT') --<BS>
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update indexes without activity and low key additional selectivity'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Identify indexes, Primary Keys, Foreign Keys that are "system named"
/******************************************************************************************************************************************/
UPDATE tgt
   SET is_system_named = 1

/*** LOCAL TESTING ***
SELECT tgt.database_name
      ,tgt.obj_name
      ,tgt.obj_name
      ,name
      ,object_id
      ,is_system_named
--*/

  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 WHERE rec_type = N'I'
   AND (   (   (    LEFT(name,2) = N'PK'
                AND CHARINDEX(N'__',name, 3) = 3
                AND (   CHARINDEX(N'__',REVERSE(name),1) = 9
                     OR CHARINDEX(N'__',REVERSE(name),1) = 17
                    )
               )
            OR (    LEFT(name,2) = N'FK'
                AND CHARINDEX(N'__',name, 3) = 3
                AND CHARINDEX(N'__',name,14) = 14
                AND CHARINDEX(N'__',name,21) = 21
               )
            OR (    LEFT(name,3) = N'UQ_'
                AND CHARINDEX(N'__',name, 3) = 3
                AND CHARINDEX(N'__',name,13) = 13
                AND LEN(name)                = 30
               )
           )
        OR is_system_named = 1
       )
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Identified "system named" indexes, Primary Keys, Foreign Keys'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Check if Table has Check Constraints using SQL procedures, functions, or methods
/******************************************************************************************************************************************/
UPDATE tgt
   SET constraints = COALESCE(tgt.constraints + NCHAR(92),N'') + chk.check_constraints
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type NOT IN (N'A',N'D',N'I')
       ) AS tgt
  JOIN (-- Column-level Check Constraints
        SELECT cc.database_id
              ,cc.object_id
              ,(-- check constraints for this column - full definitions.
                -- FOR XML PATH used since there can be multiple constraints on a column. STUFF applied above
                SELECT NCHAR(92) + QUOTENAME(LTRIM(RTRIM(cx.name)))
                      + COALESCE( IIF(cx.uses_sql_ftn            = 1,N' ,*FTN*'       ,N'')
                                + IIF(cx.uses_sql_proc           = 1,N' ,*PROC*'      ,N'')
                                + IIF(cx.uses_sql_mthd           = 1,N' ,*MTHD*'      ,N'')
                                + IIF(cx.is_disabled             = 1,N' ,DSBLD'       ,N'')
                                + IIF(cx.is_not_for_replication  = 1,N' ,NOT_REPL'    ,N'')
                                + IIF(cx.is_not_trusted          = 1,N' ,NOT_TRUSTED' ,N'')
                                + IIF(cx.is_system_named         = 1,N' ,SYS_NM'      ,N'')
                                + IIF(cx.uses_database_collation = 0,N' ,NON-DB_COLL' ,N'')
                                + IIF(cxo.is_published           = 1,N' ,PBLSHD'      ,N'')
                                + IIF(cxo.is_schema_published    = 1,N' ,SCH_PBLSHD'  ,N'')
                                ,N'')
                      + N' ' + LTRIM(RTRIM(cx.definition))
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cx
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]           AS cxo
                    ON cx.database_id                           = cxo.database_id
                   AND cx.object_id                             = cxo.object_id
                 WHERE cc.database_id                           = cx.database_id
                   AND cc.object_id                             = cx.object_id
                   FOR XML PATH (N''), TYPE
               ).value('(./text())[1]','NVARCHAR(4000)') AS check_constraints
          FROM (-- list of columns with check constraints - get one record per column in case of multiple constraints
                SELECT cc.database_id
                      ,cc.object_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cc
                 WHERE uses_sql_proc = 1
                    OR uses_sql_ftn  = 1
                    OR uses_sql_mthd = 1
                 GROUP BY
                       cc.database_id
                      ,cc.object_id
               ) cc
       ) AS chk
    ON tgt.database_id = chk.database_id
   AND tgt.object_id   = chk.object_id
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Check if Table has Check Constraints using SQL procedures, functions, or methods'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Check if Table has Computed Columns using SQL procedures, functions, or methods
/******************************************************************************************************************************************/
UPDATE tgt
   SET constraints = COALESCE(tgt.constraints + NCHAR(92),N'') + chk.computed_column
  FROM (-- Parent objects only
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type NOT IN (N'A',N'D',N'I')
       ) AS tgt
  JOIN (-- Computed columns
        SELECT cc.database_id
              ,cc.object_id
              ,(-- check constraints for this column - full definitions.
                -- FOR XML PATH used since there can be multiple constraints on a column. STUFF applied above
                SELECT  NCHAR(92)
                      + QUOTENAME(cx.name) + N' CCOL:'
                      + IIF(cx.uses_sql_proc = 1,N' *PROCEDURE*' ,N'')
                      + IIF(cx.uses_sql_ftn  = 1,N' *FUNCTION*'  ,N'')
                      + IIF(cx.uses_sql_mthd = 1,N' *SQL METHOD*',N'')
                      + N' ' + cx.definition
                      + IIF(cx.is_persisted = 0 OR cx.uses_database_collation = 0
                           , NCHAR(92)
                           + STUFF(-- Strip off leading unnecessary characters
                                    IIF(cx.is_persisted = 0           ,N' NOT PERSISTED'  ,N'')
                                  + IIF(cx.uses_database_collation = 0,N' NOT DB COLLATED',N'')
                                  ,1,1,N'')
                          ,N'')
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_columns] AS cx
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS cxo
                    ON cx.database_id = cxo.database_id
                   AND cx.object_id   = cxo.object_id
                 WHERE cc.database_id = cx.database_id
                   AND cc.object_id   = cx.object_id
                   FOR XML PATH (N''), TYPE
               ).value('(./text())[1]','NVARCHAR(4000)') AS computed_column
          FROM (-- list of columns with check constraints - get one record per column in case of multiple constraints
                SELECT cc.database_id
                      ,cc.object_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_columns] AS cc
                 WHERE cc.definition IS NOT NULL
                   AND (   uses_sql_proc = 1
                        OR uses_sql_ftn  = 1
                        OR uses_sql_mthd = 1
                       )
                 GROUP BY
                       cc.database_id
                      ,cc.object_id
               ) cc
       ) AS chk
    ON tgt.database_id = chk.database_id
   AND tgt.object_id   = chk.object_id
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Check if Table has Computed Columns using SQL procedures, functions, or methods'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Consolidate Key Constraints
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT
--*/
       constraints = STUFF(-- Strip off leading unnecessary characters
                           (--
                            SELECT  NCHAR(92) + QUOTENAME(kx.type)
                                  + IIF(kx.is_enforced = 0,N' *NOT ENFORCED* ',N'')
                                  + N' ' + kx.name
                              FROM [tempdb].[dbo].[SQLXL_Index_sys_key_constraints] AS kx
                             WHERE tgt.database_id = kx.database_id
                               AND tgt.object_id   = kx.parent_object_id
                               AND tgt.index_id    = kx.unique_index_id
                               FOR XML PATH(N''), TYPE
                           ).value('(./text())[1]','NVARCHAR(4000)')
                          ,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS tgt
  JOIN (--
        SELECT database_id
              ,parent_object_id                         -- target table object id
              ,unique_index_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_key_constraints]
         GROUP BY
               database_id
              ,parent_object_id
              ,unique_index_id
       ) AS kc
    ON tgt.database_id = kc.database_id
   AND tgt.object_id   = kc.parent_object_id
   AND tgt.index_id    = kc.unique_index_id
   AND TRY_CAST(tgt.type AS INT) > 0
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Consolidated Key Constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Incorporate Column Constraints
/******************************************************************************************************************************************/
UPDATE tgt
   SET
       -- NOTE: after "*/" this must be a new line, else syntax error
       constraints = COALESCE(constraints + NCHAR(92),N'') + STUFF(c.txt,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS tgt
  JOIN (--
        SELECT ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS c
            ON ic.database_id = c.database_id
           AND ic.object_id   = c.object_id
           AND ic.Column_ID   = c.column_id
         WHERE c.default_constraint         IS NOT NULL
            OR c.check_constraints          IS NOT NULL
            OR c.computed_column_definition IS NOT NULL
         GROUP BY
               ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
       ) ic
     ON ic.database_id = tgt.database_id
    AND ic.object_id   = tgt.object_id
    AND ic.index_id    = tgt.index_id
    AND ic.type        = tgt.type
 CROSS
 APPLY (-- double select to accomodate .value('(./text())[1]','NVARCHAR(4000)') below
        SELECT(--
               SELECT  COALESCE(NCHAR(92) + QUOTENAME(c2.name) + N' DEF: ' + c2.default_constraint,N'')
                     + COALESCE(NCHAR(92) + QUOTENAME(c2.name) + N' CHK: ' + c2.check_constraints ,N'')
                     + COALESCE(NCHAR(92) + QUOTENAME(c2.name) + N' CCOL: ' + c2.computed_column_definition,N'')
                 FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic2
                 JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS c2
                   ON ic2.database_id = c2.database_id
                  AND ic2.object_id   = c2.object_id
                  AND ic2.Column_ID   = c2.column_id
                WHERE ic.database_id  = ic2.database_id
                  AND ic.object_id    = ic2.object_id
                  AND ic.index_id     = ic2.index_id
                  AND ic.type         = ic2.type
                  FOR XML PATH(N''), TYPE
              ).value('(./text())[1]','NVARCHAR(4000)')
       ) AS c(txt)
 WHERE tgt.rec_type = N'I'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Incorporate Column Constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Incorporate Parent Constraints
/******************************************************************************************************************************************/
UPDATE tgt
   SET
       constraints = COALESCE(constraints + NCHAR(92),N'') 
                   + STUFF(chk.chkcon,1,1,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN (-- table-level Check Constraints

/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
--*/
        SELECT cc.database_id
              ,cc.parent_object_id
              ,(-- get check constraint names for this table. [STUFF] function applied above
                SELECT  NCHAR(92) +cx.typ + N':'
                      + NCHAR(32) + QUOTENAME(LTRIM(RTRIM(cx.name)))
                      + COALESCE(IIF(cx.definition LIKE '%~].~[%' ESCAPE '~',N' ,*FTN*',N'')
                                +IIF(cx.is_disabled             = 1,N' ,DISABLED'    ,N'')
                                +IIF(cx.is_not_for_replication  = 1,N' ,NOT_REPL'    ,N'')
                                +IIF(cx.is_not_trusted          = 1,N' ,NOT TRUSTED' ,N'')
                                +IIF(cx.is_system_named         = 1,N' ,SYSTEM_NAMED',N'')
                                +IIF(cx.uses_database_collation = 0,N' ,NON-DB_COLL' ,N'')
                                +IIF(cx.delete_referential_action_desc IS NOT NULL
                                                                   ,N' ,DEL_REF ' +cx.delete_referential_action_desc,N'')
                                +IIF(cxo.is_published           = 1,N' ,PBLSHD'      ,N'')
                                +IIF(cxo.is_schema_published    = 1,N' ,SCH_PBLSHD'  ,N'')
                                ,N'')
                      + N' ' + LTRIM(RTRIM(cx.definition))
                  FROM (--
                        SELECT typ = N'CHK'
                              ,database_id
                              ,parent_object_id
                              ,object_id
                              ,type
                              ,type_desc
                              ,name
                              ,parent_column_id
                              ,definition
                              ,is_disabled
                              ,is_not_for_replication
                              ,is_not_trusted
                              ,delete_referential_action      = CONVERT(TINYINT,NULL)
                              ,delete_referential_action_desc = CONVERT(SYSNAME,NULL)
                              ,uses_database_collation
                              ,is_system_named
                          FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cx
                         WHERE cc.database_id      = cx.database_id
                           AND cc.parent_object_id = cx.parent_object_id
                           AND 0                   = cx.parent_column_id
                         UNION ALL
                        SELECT typ = N'EDG'
                              ,database_id
                              ,parent_object_id
                              ,object_id
                              ,type
                              ,type_desc
                              ,name
                              ,parent_column_id        = NULL
                              ,definition              = NULL
                              ,is_disabled
                              ,is_not_for_replication  = NULL
                              ,is_not_trusted
                              ,delete_referential_action
                              ,delete_referential_action_desc
                              ,uses_database_collation = NULL
                              ,is_system_named
                          FROM [tempdb].[dbo].[SQLXL_Index_sys_edge_constraints]  AS cx
                         WHERE cc.database_id      = cx.database_id
                           AND cc.parent_object_id = cx.parent_object_id
                       ) AS cx
                  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS cxo
                    ON cx.database_id = cxo.database_id
                   AND cx.object_id   = cxo.object_id
                 ORDER BY
                       cx.object_id
                   FOR XML PATH (N''), TYPE
               ).value('(./text())[1]','NVARCHAR(4000)')
          FROM (-- list of tables (parent objects) with check constraints
                SELECT cc.database_id
                      ,cc.parent_object_id
                  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] cc
                 WHERE cc.parent_column_id = 0 -- not a table constraint
                 GROUP BY
                       cc.database_id
                      ,cc.parent_object_id
               ) cc
       ) chk (database_id
             ,parent_object_id
             ,chkcon
             )
    ON tgt.database_id = chk.database_id
   AND tgt.object_id   = chk.parent_object_id
   AND tgt.index_id    = chk.parent_object_id
 WHERE rec_type NOT IN (N'A',N'D',N'I')
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Incorporate Parent Constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************\
Update - [SQLXL_Index_Compilation] - Incorporate Extended Properties for all objects
Class:  0 = Database
        1 = Object or column
        2 = Parameter
        3 = Schema
        4 = Database principal
        5 = Assembly
        6 = Type
        7 = index
        8 = User defined table type column
       10 = XML schema collection
       15 = Message type
       16 = Service contract
       17 = Service
       18 = Remote service binding
       19 = Route
       20 = Dataspace (filegroup or partition scheme)
       21 = Partition function --<BS> Add in future
       22 = Database file
       27 = Plan guide
\******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Add Extended Properties',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT
--*/
       extended_properties = STUFF(-- Strip off leading unnecessary characters
                                     COALESCE((-- Database
                                              SELECT NCHAR(10) + N'Database: ' + ep.name + N': ' + TRY_CAST(ep.value AS NVARCHAR(4000))
                                                FROM [tempdb].[dbo].[SQLXL_Index_sys_extended_properties] AS ep
                                               WHERE tgt.database_id = ep.database_id
                                                 AND 0               = ep.class
                                                 AND 0               = ep.major_id
                                                 AND 0               = ep.minor_id
                                                 AND tgt.rec_type    = N'D'
                                               ORDER BY
                                                     ep.name
                                                    ,ep.value
                                                 FOR XML PATH(N''), TYPE
                                             ).value('(./text())[1]','NVARCHAR(4000)')
                                            ,N'')

                                  + COALESCE((-- Parent schema
                                              SELECT NCHAR(10) + N'Schema: ' + ep.name + N': ' + TRY_CAST(ep.value AS NVARCHAR(4000))
                                                FROM [tempdb].[dbo].[SQLXL_Index_sys_extended_properties] AS ep
                                               WHERE tgt.database_id = ep.database_id
                                                 AND 3               = ep.class
                                                 AND tgt.schema_id   = ep.major_id
                                                 AND 0               = ep.minor_id
                                                 AND tgt.rec_type NOT IN (N'A',N'D',N'I')
                                               ORDER BY
                                                     ep.name
                                                    ,ep.value
                                                 FOR XML PATH(N''), TYPE
                                             ).value('(./text())[1]','NVARCHAR(4000)')
                                             ,N'')

                                  + COALESCE((-- Parent object
                                              SELECT NCHAR(10) + ep.name + N': ' + TRY_CAST(ep.value AS NVARCHAR(4000))
                                                FROM [tempdb].[dbo].[SQLXL_Index_sys_extended_properties] AS ep
                                               WHERE tgt.database_id      = ep.database_id
                                                 AND 1                    = ep.class
                                                 AND tgt.parent_object_id = ep.major_id
                                                 AND 0                    = ep.minor_id
                                                 AND tgt.rec_type NOT IN (N'A',N'D',N'I')
                                               ORDER BY
                                                     ep.name
                                                    ,ep.value
                                                 FOR XML PATH(N''), TYPE
                                             ).value('(./text())[1]','NVARCHAR(4000)')
                                             ,N'')

                                  + COALESCE((-- Foreign Key Constraints
                                              SELECT NCHAR(10) + ep.name + N': ' + TRY_CAST(ep.value AS NVARCHAR(4000))
                                                FROM [tempdb].[dbo].[SQLXL_Index_sys_extended_properties] AS ep
                                               WHERE tgt.database_id = ep.database_id
                                                 AND 1               = ep.class
                                                 AND tgt.object_id   = ep.major_id
                                                 AND 0               = ep.minor_id
                                                 AND tgt.rec_type    = N'I'
                                                 AND tgt.type       IN (N'F')
                                               ORDER BY
                                                     ep.name
                                                    ,ep.value
                                                 FOR XML PATH(N''), TYPE
                                             ).value('(./text())[1]','NVARCHAR(4000)')
                                             ,N'')

                                  + COALESCE((-- Indexes
                                              SELECT NCHAR(10) + ep.name + N': ' + TRY_CAST(ep.value AS NVARCHAR(4000))
                                                FROM [tempdb].[dbo].[SQLXL_Index_sys_extended_properties] AS ep
                                               WHERE tgt.database_id      = ep.database_id
                                                 AND 7                    = ep.class
                                                 AND tgt.parent_object_id = ep.major_id
                                                 AND tgt.index_id         = ep.minor_id
                                                 AND tgt.rec_type         = N'I'
                                               ORDER BY
                                                     ep.name
                                                    ,ep.value
                                                 FOR XML PATH(N''), TYPE
                                             ).value('(./text())[1]','NVARCHAR(4000)')
                                             ,N'')

                                  + COALESCE((-- Index Key & Included Columns
                                              SELECT  NCHAR(10) + QUOTENAME(c.name) + N' '
                                                    + ep.name + N': ' + TRY_CAST(ep.value AS NVARCHAR(4000))
                                                FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]       AS ic
                                                JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]             AS c
                                                  ON ic.database_id = c.database_id
                                                 AND ic.object_id   = c.object_id
                                                 AND ic.column_id   = c.column_id
                                                JOIN [tempdb].[dbo].[SQLXL_Index_sys_extended_properties] AS ep
                                                  ON ic.database_id  = ep.database_id
                                                 AND ic.object_id    = ep.major_id
                                                 AND ic.column_id    = ep.minor_id
                                                 AND 1               = ep.class
                                               WHERE tgt.database_id = ic.database_id
                                                 AND tgt.object_id   = ic.object_id
                                                 AND tgt.index_id    = ic.index_id
                                                 AND tgt.type        = ic.type
                                               ORDER BY
                                                     ic.key_column_sequence
                                                    ,c.name
                                                 FOR XML PATH(N''), TYPE
                                             ).value('(./text())[1]','NVARCHAR(4000)')
                                             ,N'')
                                  ,1,1,N'') COLLATE DATABASE_DEFAULT
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Add Extended Properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Referenced Foreign Keys, Referred Foreign Key Constraints, & Index Covers
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.database_id
      ,tgt.object_id
      ,tgt.index_id
      ,tgt.type,
--*/
       ---------------------------------------------------------------------------------------------
       -- Foreign Key Constraint reference
       ---------------------------------------------------------------------------------------------
       fkc_reference = (-- get Foreign Key Constraint referenced schema + table + column(s)
                        SELECT  N'SCH '
                              + QUOTENAME(s.name)
                              + NCHAR(92)
                              + N'TBL '
                              + QUOTENAME(ref_obj.name)
                              + NCHAR(92)
                              + N'COL '
                              + STUFF(-- Strip off leading unnecessary characters
                                      (-- loop through columns in foreign key since can have more than one
                                       SELECT  NCHAR(92) 
                                             + N'        ,'         -- extra space added for multi-column display in spreadsheet
                                             + QUOTENAME(eix.name)
                                         FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns] AS fkc
                                         JOIN [tempdb].[dbo].[SQLXL_Index_column]                  AS eix
                                           ON fkc.database_id          = eix.database_id
                                          AND fkc.referenced_object_id = eix.object_id
                                          AND fkc.referenced_column_id = eix.column_id
                                        WHERE tgt.database_id = fkc.database_id
                                          AND tgt.object_id   = fkc.constraint_object_id
                                        ORDER BY
                                              fkc.constraint_column_id
                                          FOR XML PATH(N''), TYPE -- can be more than 1 column in foreign key
                                      ).value('(./text())[1]','NVARCHAR(4000)')
                                     ,1,10,N'')
                         WHERE tgt.type = N'F'
                       )
      -----------------------------------------------------------------------------------------------------
      -- For referenced indexes, count the number of referred/parent Foreign Key Constraints referring to it
      -----------------------------------------------------------------------------------------------------
      ,rk_referencing_fkc_CNT                = COALESCE(fkc_ref.rk_referencing_fkc_CNT               ,0)
      ,rk_referencing_fkc_disabled_CNT       = COALESCE(fkc_ref.rk_referencing_fkc_disabled_CNT      ,0)
      ,rk_referencing_fkc_not_replicated_CNT = COALESCE(fkc_ref.rk_referencing_fkc_not_replicated_CNT,0)
      ,rk_referencing_fkc_not_trusted_CNT    = COALESCE(fkc_ref.rk_referencing_fkc_not_trusted_CNT   ,0)
      ,rk_referencing_fkc_action_none_CNT    = COALESCE(fkc_ref.rk_referencing_fkc_action_none_CNT   ,0)
      ,rk_referencing_fkc_action_cascade_CNT = COALESCE(fkc_ref.rk_referencing_fkc_action_cascade_CNT,0)
      ,rk_referencing_fkc_action_null_CNT    = COALESCE(fkc_ref.rk_referencing_fkc_action_null_CNT   ,0)
      ,rk_referencing_fkc_action_default_CNT = COALESCE(fkc_ref.rk_referencing_fkc_action_default_CNT,0)
      ,rk_referencing_fkc_system_named_CNT   = COALESCE(fkc_ref.rk_referencing_fkc_system_named_CNT  ,0)
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS tgt
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys] AS fkc_par
    ON tgt.database_id = fkc_par.database_id
   AND tgt.object_id   = fkc_par.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects]      AS ref_obj                    -- cross reference to get referenced object properties
    ON fkc_par.database_id          = ref_obj.database_id
   AND fkc_par.referenced_object_id = ref_obj.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_schemas]      AS s                    -- cross reference to get referenced object schema
    ON ref_obj.database_id = s.database_id
   AND ref_obj.schema_id   = s.schema_id
  LEFT OUTER
  JOIN (-- get count of Foreign Key Constraints ("Parent" or referring) to each referenced table and unique index
        SELECT database_id
              ,referenced_object_id
              ,referenced_index_id                  = key_index_id
              ------------------------------------------------------------------------------------
              ,rk_referencing_fkc_CNT                = COUNT(1)
              ,rk_referencing_fkc_disabled_CNT       = SUM(IIF(is_disabled               = 1,1,0))
              ,rk_referencing_fkc_not_replicated_CNT = SUM(IIF(is_not_for_replication    = 1,1,0))
              ,rk_referencing_fkc_not_trusted_CNT    = SUM(IIF(is_not_trusted            = 1,1,0))
              ,rk_referencing_fkc_action_none_CNT    = SUM(IIF(delete_referential_action = 0,1,0))
              ,rk_referencing_fkc_action_cascade_CNT = SUM(IIF(delete_referential_action = 1,1,0))
              ,rk_referencing_fkc_action_null_CNT    = SUM(IIF(delete_referential_action = 2,1,0))
              ,rk_referencing_fkc_action_default_CNT = SUM(IIF(delete_referential_action = 3,1,0))
              ,rk_referencing_fkc_system_named_CNT   = SUM(IIF(is_system_named           = 1,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]
         GROUP BY
               database_id
              ,referenced_object_id
              ,key_index_id
       ) AS fkc_ref
    ON tgt.database_id      = fkc_ref.database_id
   AND tgt.parent_object_id = fkc_ref.referenced_object_id
   AND tgt.object_id        = fkc_ref.referenced_object_id
   AND tgt.index_id         = fkc_ref.referenced_index_id
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Referenced Foreign Keys, Referred Foreign Key Constraints, & Index Covers'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Parent "Referred" Foreign Key Constraints "covered" by indexes and vice-versa
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Parent "Referred" Foreign Key Constraints "covered" by indexes and vice-versa',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.database_id,tgt.parent_object_id,tgt.object_id,tgt.index_id,tgt.type,tgt.name,
--*/
       ---------------------------------------------------------------------------------------------
       -- All indexes covering this Foreign Key
       ---------------------------------------------------------------------------------------------
       fkc_covered_by_idx_IDS        = STUFF(covering_indexes.idx_id,1,1,N'') -- list of all indexes covering this Foreign Key
       ---------------------------------------------------------------------------------------------
       -- Primary index covering this Foreign Key
       ---------------------------------------------------------------------------------------------
      ,fkc_covering_primary_idx_name = covering_index.name     -- name of the "primary" (smallest) index covering the foreign key
      ,fkc_covering_primary_idx_ID   = covering_index.index_id -- id of the "primary" (smallest)index covering the foreign key
      ,fkc_covering_primary_idx_Type = covering_index.type     -- type of the "primary" (smallest)index covering the foreign key
       ---------------------------------------------------------------------------------------------
       -- All Foreign Key Constraints covered by this index
       ---------------------------------------------------------------------------------------------
      ,covered_fkc_IDs               = STUFF(covering_fk.idx_id,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type IN (N'1',N'2',N'F')
       ) AS tgt
 OUTER APPLY
       (-- Find "best" index covering ALL the Foreign Key Constraint column(s) - not filtered
        -- clustered over Nonclustered, most readest, most narrowest, fewest key columns, and narrowest included columns
        SELECT TOP (1)
               i.index_id
              ,i.type
              ,i.name
              ,i.Key_Columns_CNT
              ,i.ius_user_read_CNT
              ,i.stathdr_Average_Key_Length
              ,i.key_total_datatype_length_bytes
              ,i.inc_total_datatype_length_bytes
          FROM (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type = N'I'
                ) AS i
         WHERE tgt.type             = N'F'
           AND tgt.database_id      = i.database_id
           AND tgt.parent_object_id = i.parent_object_id
           AND i.type              IN (N'1',N'2') -- clustered, Nonclustered only. Nonclustered columnstores can't be used for FKC!
           AND i.has_filter         = 0           -- can't be filtered since won't cover the whole key
           AND CHARINDEX(tgt.key_column_IDs,i.key_column_IDs) = 1 -- comma separated list of column_ids in the index or foreign key
         ORDER BY
               i.type                             -- use clustered if found
              ,i.is_primary_key              DESC -- Primary Key
              ,i.is_unique_constraint        DESC -- is a CONSTRAINT
              ,i.is_unique                   DESC -- is UNIQUE
              ,i.ius_user_read_CNT           DESC -- most read
              ,i.stathdr_Average_Key_Length  DESC -- biggest
              ,i.Key_Columns_CNT             DESC -- most key elements
              ,i.key_total_datatype_length_bytes          DESC -- widest key
              ,i.inc_total_datatype_length_bytes      -- fewest included columns
              ,i.index_id
       ) covering_index

 OUTER APPLY
       (-- Find all indexes covering all Foreign Key Constraint column(s)
        -- Where:   not filtered
        -- Ordered: clustered over Nonclustered, most readest, most narrowest, fewest key columns,
        --          and narrowest included columns
        SELECT(--
               SELECT TOP (100) PERCENT
                      N',' + QUOTENAME(i.index_id)
                 FROM (--
                       SELECT *
                         FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                        WHERE rec_type = N'I'
                      ) AS i
                WHERE tgt.type                 = N'F'
                  AND tgt.database_id          = i.database_id
                  AND tgt.parent_object_id     = i.parent_object_id
                  AND i.type                  IN (N'1',N'2') -- clustered, Nonclustered only. NOTE - Nonclust colstores can't be used for FK!
                  AND i.has_filter             = 0           -- can't be filtered since won't cover the whole key
                  AND CHARINDEX(tgt.key_column_IDs,i.key_column_IDs) = 1 -- comma separated list of column_ids in the index or foreign key
               ORDER BY
                     i.type                             -- use clustered if found
                    ,i.is_primary_key              DESC -- Primary Key
                    ,i.is_unique_constraint        DESC -- is a CONSTRAINT
                    ,i.is_unique                   DESC -- is UNIQUE
                    ,i.ius_user_read_CNT           DESC -- most read
                    ,i.stathdr_Average_Key_Length  DESC -- biggest
                    ,i.Key_Columns_CNT             DESC -- most key elements
                    ,i.key_total_datatype_length_bytes          DESC -- widest key
                    ,i.inc_total_datatype_length_bytes      -- fewest included columns
                    ,i.index_id
                  FOR XML PATH(N''), TYPE
              ).value('(./text())[1]','NVARCHAR(4000)')
       ) covering_indexes(idx_id)

 OUTER APPLY
       (-- get list of Foreign Key Constraints covered by the index
        SELECT(--
               SELECT TOP 100 PERCENT
                      N',' + QUOTENAME(i.object_id)
                 FROM (--
                       SELECT *
                         FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                        WHERE rec_type = N'I'
                       ) AS i
                WHERE i.type                   = N'F'
                  AND tgt.type                IN (N'1',N'2') -- clustered, Nonclustered only. NOTE - Nonclustered colstores can't be used for FK!
                  AND tgt.has_filter           = 0           -- can't be filtered since won't cover the whole key
                  AND tgt.database_id          = i.database_id
                  AND tgt.parent_object_id     = i.parent_object_id
                  AND CHARINDEX(i.key_column_IDs,tgt.key_column_IDs) = 1 -- comma separated list of column_ids in the index or foreign key
                ORDER BY
                      i.object_id
                  FOR XML PATH(N''), TYPE
              ).value('(./text())[1]','NVARCHAR(4000)')
       ) covering_fk(idx_id)
 WHERE covering_index.index_id IS NOT NULL
    OR covering_indexes.idx_id IS NOT NULL
    OR covering_fk.idx_id      IS NOT NULL
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Parent "Referred" Foreign Key Constraints "covered" by indexes and vice-versa'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Create - [SQLXL_Index_Synergies] - table of Synergies between indexes, foreign key constraints, and missing indexes
-- Compare indexes within a table for synergies, run through candidates looking for match type.
-- match indexes on the "Left" side with columns in indexes in the same table on the "right" side
-- Look for the least "key" columns in both compared records - limits the iterations through SEQUENCE and OVERLAP matches below
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Create table of Synergies between indexes, foreign key constraints, and missing indexes',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Synergies]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Synergies];
--*/

;WITH ico AS (--
SELECT ic.database_id
      ,parent_object_id = ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
      ,ic.column_id
      ,ic.key_column_sequence
      ,ic.partition_ordinal
      ,ic.is_included_column
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic  -- includes missing indexes
UNION ALL
SELECT database_id         = database_id
      ,parent_object_id    = parent_object_id
      ,object_id           = constraint_object_id
      ,index_id            = constraint_object_id
      ,type                = N'F'
      ,column_id           = parent_column_id
      ,key_column_sequence = constraint_column_id
      ,partition_ordinal   = 0
      ,is_included_column  = 0
  FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]
)
SELECT idx_com.database_id
      ,idx_com.parent_object_id
      --------------------------------------------------------
      ,idx_com.l_object_id
      ,idx_com.l_index_id
      ,idx_com.l_type
      ,lc_key_CNT = idx_com.lc_idx_index_Key_Columns
      --------------------------------------------------------
      ,idx_com.r_object_id
      ,idx_com.r_index_id
      ,idx_com.r_type
      ,rc_key_CNT = idx_com.rc_idx_index_Key_Columns
      --------------------------------------------------------
      ,seq.matching_sequence_CNT
      ,seq.matching_sequence_all_density
      ,matching_sequence_COL      = IIF(idx_com.l_type = N'F' OR idx_com.r_type = N'F',N'F.',N'S.') + seq.matching_sequence_COL
      ,ovl.matching_overlap_CNT
      ,matching_overlap_COL       = N'O.' +ovl.matching_overlap_COL
      ,con.matching_contained_CNT
      ,matching_contained_COL     = N'C.' +con.matching_contained_COL
  INTO [tempdb].[dbo].[SQLXL_Index_Synergies]
  FROM (-- find all "indexes" within a table with one or more common "key" columns
        SELECT idx_com.database_id
              ,idx_com.parent_object_id
              ----------------------------------------------------------------
              ,idx_com.l_object_id
              ,idx_com.l_index_id
              ,idx_com.l_type
              ----------------------------------------------------------------
              ,idx_com.r_object_id
              ,idx_com.r_index_id
              ,idx_com.r_type
              ----------------------------------------------------------------
              ,lc_idx_index_Key_Columns = il.Key_Columns_CNT
              ,lc_filter_definition     = il.filter_definition
              ----------------------------------------------------------------
              ,rc_idx_index_Key_Columns = ir.Key_Columns_CNT
              ,rc_filter_definition     = ir.filter_definition
              ------------------------------------------------------------------------------------------------------------------------------
              -- for each common key pair get the least number of key columns to reduce loop execution below
              ------------------------------------------------------------------------------------------------------------------------------
              ,least_col_CNT = (SELECT cnt = MIN(m.cnt) FROM (VALUES (il.Key_Columns_CNT),(ir.Key_Columns_CNT)) m(cnt))
              ----------------------------------------------------------------
              ,il_xml_using_xml_index_id = il.xml_using_xml_index_id
              ,ir_xml_using_xml_index_id = ir.xml_using_xml_index_id
              ,il_xml_secondary_type     = il.xml_secondary_type
              ,ir_xml_secondary_type     = ir.xml_secondary_type
          FROM (-- matching index candidates - only look for synergy if indexes have at least one key column in common
                SELECT DISTINCT -- if multiple columns matching only want 1 reference here
                       l.database_id
                      ,l.parent_object_id
                      -------------------------------------------
                      ,l_object_id            = l.object_id
                      ,l_index_id             = l.index_id
                      ,l_type                 = l.type
                      ,l_partition_ordinal    = l.partition_ordinal
                      -------------------------------------------
                      ,r_object_id            = r.object_id
                      ,r_index_id             = r.index_id
                      ,r_type                 = r.type
                      ,r_partition_ordinal    = r.partition_ordinal
                  FROM ico AS l
                  JOIN ico AS r
                    ON l.database_id                        = r.database_id
                   AND l.parent_object_id                   = r.parent_object_id
                   -- No self referencing
                   AND (    l.index_id                     <> r.index_id      -- no self referencing
                        OR (    l.index_id                  = r.index_id      -- no self referencing
                            AND l.type                     <> r.type          -- no self referencing
                           )
                       )
                   AND l.column_id                          = r.column_id    -- synergy candidates must have at least 1 column matching
                 WHERE 1 = 1
                   ---------------------------------------------
                   AND l.type NOT IN (N'R',N'FT',N'IF',N'TF')   -- exclude referenced Foreign Key ('R') columns, table functions
                   AND r.type NOT IN (N'R',N'FT',N'IF',N'TF')   -- exclude referenced Foreign Key ('R') columns, table functions
                   ---------------------------------------------
                   AND (   l.partition_ordinal = 0              -- exclude left-side partitioning column(s) to avoid false synergies
                        OR r.type              = N'F'           -- special case for Foreign Key Constraints which are unpartitioned
                       )
                   AND l.type NOT IN (N'0'                      -- exclude left-side heaps
                                     ,N'5'                      -- exclude left-side clustered columnstore
                                     ,N'6'                      -- exclude left-side Nonclustered columnstore
                                     )
                   AND l.is_included_column = 0                 -- exclude left side included columns, only looking for key matches
                   ---------------------------------------------
                   AND (   r.partition_ordinal = 0              -- exclude right-side partitioning column(s) to avoid false synergies
                        OR l.type              = N'F'           -- special case for Foreign Key Constraints which are unpartitioned
                       )
                   AND r.type NOT IN (N'0'                      -- exclude right-side heaps
                                     ,N'5'                      -- exclude right-side clustered columnstore
                                     ,N'6'                      -- exclude right-side Nonclustered columnstore
                                     )
                   AND r.is_included_column = 0                 -- exclude right side included columns, only looking for key matches
               ) idx_com
          JOIN (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type       = N'I'
                   AND obj_type      <> N'IT' -- Internal tables don't get compared
                   AND internal_type IS NULL
               ) AS il
            ON idx_com.database_id = il.database_id
           AND idx_com.l_object_id = il.object_id
           AND idx_com.l_index_id  = il.index_id
           AND idx_com.l_type      = il.type
          JOIN (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type       = N'I'
                   AND obj_type      <> N'IT' -- Internal tables don't get compared
                   AND internal_type IS NULL
               ) AS ir
            ON idx_com.database_id = ir.database_id
           AND idx_com.r_object_id = ir.object_id
           AND idx_com.r_index_id  = ir.index_id
           AND idx_com.r_type      = ir.type
         WHERE 1 = 1
               -- for a Foreign Key Constraint to match it's gotta reference the same referenced object_id & referenced_column_id(s)
           AND NOT (    il.type          = N'F'
                    AND ir.type          = N'F'
                    AND CHARINDEX(il.fkc_reference,ir.fkc_reference) = 0
                    AND CHARINDEX(ir.fkc_reference,il.fkc_reference) = 0
                   )
               -- XML Secondary indexes - 3 different "secondary" types and the "primary" should not match each other
           AND NOT (    il.type = N'3'
                    AND ir.type = N'3'
                    AND (   COALESCE(il.xml_using_xml_index_id,0 )  = COALESCE(ir.xml_using_xml_index_id,0 )
                         OR COALESCE(il.xml_using_xml_index_id,0)   = COALESCE(ir.index_id              ,0) -- match to the primary XML
                         OR COALESCE(il.index_id              ,0)   = COALESCE(ir.xml_using_xml_index_id,0) -- match to the primary XML
                        )
                   )
       ) idx_com

 OUTER APPLY
       (-- SAME COLUMNS IN SAME ORDER - SEQUENCE
        -- "indexes" with 1 or more matching key columns in the same index key sequence
        -- Missing indexes have no key order, so look for matches in equality keys ordered by uniqueness
        -- get the largest count of matches within an "index" match pair, not counting included columns
        SELECT TOP (1)
               matching_sequence_CNT = c.cnt
              ,matching_sequence_COL = TRY_CAST((-- list intersecting column_ids, in corrected index key column order (key_column_sequence)
                                                 SELECT TOP (c.cnt)
                                                        TRY_CAST(ix.column_id AS NVARCHAR(20)) + N'.'
                                                   FROM ico AS ix
                                                  WHERE idx_com.database_id = ix.database_id
                                                    AND idx_com.l_object_id = ix.object_id
                                                    AND idx_com.l_index_id  = ix.index_id
                                                    AND idx_com.l_type      = ix.type
                                                    AND 0                   = ix.is_included_column
                                                  ORDER BY
                                                        ix.key_column_sequence -- Note: Missing index key assigned by uniqueness ASC!
                                                    FOR XML PATH(''), TYPE
                                                ).value('(./text())[1]','NVARCHAR(4000)')
                                               AS NVARCHAR(1000))
              ,matching_sequence_all_density = COALESCE(dvl.All_Density,dvr.All_Density)
          FROM -- loop through all potential matching columns in sequence looking for highest count
               [tempdb].[dbo].SQLXL_Numbers(1,idx_com.least_col_CNT) loop_sequence
         CROSS
         APPLY (-- instances where the same columns appear in the same sequence in the "index". Get the highest count of matches
                SELECT cnt = TRY_CAST(COUNT(1) AS TINYINT)
                  FROM ico AS l
                  JOIN ico AS r
                    ON l.column_id           = r.column_id            -- columns must match
                   AND l.key_column_sequence = r.key_column_sequence  -- in the same sequence
                   ---------------------------------------------------------------------------------
                 WHERE 1 = 1
                   ---------------------------------------------------------------------------------
                   AND idx_com.database_id   = l.database_id
                   AND idx_com.l_object_id   = l.object_id
                   AND idx_com.l_index_id    = l.index_id
                   AND idx_com.l_type        = l.type
                   AND 0                     = l.is_included_column
                   AND loop_sequence.n       = l.key_column_sequence  -- key columns up to loop count
                                                                      -- Note: Missing index key assigned by uniqueness ASC
                   ---------------------------------------------------------------------------------
                   AND idx_com.database_id   = r.database_id
                   AND idx_com.r_object_id   = r.object_id
                   AND idx_com.r_index_id    = r.index_id
                   AND idx_com.r_type        = r.type
                   AND 0                     = r.is_included_column
                   AND loop_sequence.n       = r.key_column_sequence  -- key columns up to count
                                                                          -- Note: Missing index key assigned by uniqueness ASC
                   -------------------------------------------------------------------------------------------------------------------------
                   -- filtered indexes only match if filtered definition is the same
                   -- or there's an unfiltered version to roll up to - on the LEFT side of the sequence match
                   -------------------------------------------------------------------------------------------------------------------------
                   AND (   COALESCE(idx_com.lc_filter_definition,N'') = COALESCE(idx_com.rc_filter_definition,N'')
                        OR (idx_com.lc_filter_definition IS     NULL AND idx_com.rc_filter_definition IS NOT NULL)
                       )
                HAVING COUNT(1) = loop_sequence.n
               ) c
          ----------------------------------------------------------------------------------
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS dvl
            ON idx_com.database_id                                    = dvl.database_id
           AND idx_com.l_object_id                                    = dvl.object_id
           AND idx_com.l_index_id                                     = dvl.index_ID
           AND loop_sequence.n                                        = dvl.Row_ID
          ----------------------------------------------------------------------------------
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS dvr
            ON idx_com.database_id                                    = dvr.database_id
           AND idx_com.r_object_id                                    = dvr.object_id
           AND idx_com.r_index_id                                     = dvr.index_ID
           AND loop_sequence.n                                        = dvr.Row_ID
         ORDER BY
               loop_sequence.n DESC -- get the match with the most columns in it
       ) seq

 OUTER APPLY
       (-- SAME COLUMNS, DIFFERENT ORDER - OVERLAP
        -- Indexes with 2 or more key columns overlapping within the same count of columns.
        -- Note - missing index key order is not known, so to overlap 2 missing indexes the key count must match
        -- Note - single column overlap caught by above
        SELECT TOP (1)
               matching_overlap_CNT = c.cnt
              ,matching_overlap_COL = TRY_CAST((-- list of column_ids for the overlap, table column_id order
                                                SELECT TRY_CAST(ix.column_id AS NVARCHAR(20)) + N'.'
                                                  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ix
                                                 WHERE idx_com.database_id  = ix.database_id
                                                   AND idx_com.l_object_id  = ix.object_id
                                                   AND idx_com.l_index_id   = ix.index_id
                                                   AND idx_com.l_type       = ix.type
                                                   AND 0                    = ix.is_included_column
                                                   AND c.cnt               >= ix.key_column_sequence
                                                 ORDER BY
                                                       ix.column_id -- order of columns in index not used since columns can be in any order
                                                   FOR XML PATH(''), TYPE
                                               ).value('(./text())[1]','NVARCHAR(4000)')
                                              AS NVARCHAR(1000))
          FROM -----------------------------------------------------------------------------------------------------------------------------
               -- loop through all potential matching columns in sequence looking for highest count
               -----------------------------------------------------------------------------------------------------------------------------
               [tempdb].[dbo].SQLXL_Numbers(1,idx_com.least_col_CNT) loop_sequence
         CROSS
         APPLY (-- same columns appear in different order but within the column count
                SELECT cnt = TRY_CAST(COUNT(1) AS TINYINT)
                  FROM ico AS l
                  JOIN ico AS r
                    ON l.column_id               = r.column_id               -- key columns must match
                   ---------------------------------------------------------------------------------
                 WHERE 1 = 1
                   AND loop_sequence.n > COALESCE(seq.matching_sequence_CNT,0) -- matching sequence not found above, or more OVERLAPS
                   ---------------------------------------------------------------------------------
                   AND idx_com.database_id       = l.database_id
                   AND idx_com.l_object_id       = l.object_id
                   AND idx_com.l_index_id        = l.index_id
                   AND idx_com.l_type            = l.type
                   AND 0                         = l.is_included_column
                   AND loop_sequence.n          >= l.key_column_sequence  -- key columns up to count.
                                                                          -- Note: Missing index key assigned by uniqueness ASC!
                   ---------------------------------------------------------------------------------
                   AND idx_com.database_id       = r.database_id
                   AND idx_com.r_object_id       = r.object_id
                   AND idx_com.r_index_id        = r.index_id
                   AND idx_com.r_type            = r.type
                   AND 0                         = r.is_included_column
                   AND loop_sequence.n          >= r.key_column_sequence  -- key columns up to count.
                                                                          -- Note: Missing index key assigned by uniqueness ASC!
                   ---------------------------------------------------------------------------------
                   AND (   -- key columns must overlap within the same synergy count.
                           -- Note: Missing index key assigned by uniqueness ASC, Foreign key sequence cannot be changed
                           (    (   TRY_CAST(l.type AS INT) > 0
                                 OR l.type = N'F'
                                )
                            AND (   TRY_CAST(r.type AS INT) > 0
                                 OR r.type = N'F'
                                )
                           )
                        OR (    l.type                     IN (N'M')
                            AND (   TRY_CAST(r.type AS INT) > 0
                                 OR r.type = N'M'
                                )
                            AND idx_com.lc_idx_index_Key_Columns >= loop_sequence.n
                            AND idx_com.rc_idx_index_Key_Columns >= loop_sequence.n
                           )
                        OR (    r.type                     IN (N'M')
                            AND (   TRY_CAST(l.type AS INT) > 0
                                 OR l.type = N'M'
                                )
                            AND idx_com.lc_idx_index_Key_Columns >= loop_sequence.n
                            AND idx_com.rc_idx_index_Key_Columns >= loop_sequence.n
                           )
                       )
                HAVING COUNT(1) = loop_sequence.n
               ) c
         ORDER BY
               loop_sequence.n DESC
       ) ovl

 OUTER APPLY
       (-- CONTAINED MATCH
        -- "indexes" with all key elements contained in another "indexes" key columns
        SELECT matching_contained_CNT = c.matching_contained_CNT
              ,matching_contained_COL = TRY_CAST((-- list of column_ids contained, in table column_id order
                                                  SELECT TRY_CAST(ix.column_id AS NVARCHAR(20)) + N'.'
                                                    FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ix
                                                   WHERE idx_com.database_id                     = ix.database_id
                                                     AND idx_com.l_object_id                     = ix.object_id
                                                     AND idx_com.l_index_id                      = ix.index_id
                                                     AND idx_com.l_type                          = ix.type
                                                     AND 0                                       = ix.is_included_column
                                                   ORDER BY
                                                         ix.column_id
                                                     FOR XML PATH('')
                                                 ) AS NVARCHAR(1000))
          FROM (-- look for same columns appearing in different key order within the first index elements
                SELECT matching_contained_CNT = TRY_CAST(COUNT(1) AS TINYINT)
                  FROM ico AS l
                  JOIN ico AS r
                    ON l.column_id                          = r.column_id
                 WHERE 1 = 1
                   ------------------------------------------------------------
                   AND l.index_id               > 1                            -- omit clustering column
                   ------------------------------------------------------------
                   AND idx_com.database_id      = l.database_id
                   AND idx_com.l_object_id      = l.object_id
                   AND idx_com.l_index_id       = l.index_id
                   AND idx_com.l_type           = l.type
                   AND 0                        = l.is_included_column         -- ignore included columns
                   ------------------------------------------------------------
                   AND idx_com.database_id      = r.database_id
                   AND idx_com.r_object_id      = r.object_id
                   AND idx_com.r_index_id       = r.index_id
                   AND idx_com.r_type           = r.type
                   AND 0                        = r.is_included_column         -- ignore included columns
                   ------------------------------------------------------------
                   AND idx_com.lc_idx_index_Key_Columns <= idx_com.rc_idx_index_Key_Columns -- left index has <= elements than right
                   ------------------------------------------------------------
                HAVING COUNT(1) = idx_com.lc_idx_index_Key_Columns
                   AND COUNT(1) > COALESCE(seq.matching_sequence_CNT,0)          -- matching sequence not found above
                   AND COUNT(1) > COALESCE(ovl.matching_overlap_CNT ,0)          -- overlapping columns not found above
               ) c
       ) con
 WHERE 1 = 1
   AND ---------------------------------------------------------------------------------------------
       -- filter out indexes without synergies
       ---------------------------------------------------------------------------------------------
       COALESCE(seq.matching_sequence_CNT
               ,ovl.matching_overlap_CNT
               ,con.matching_contained_CNT
               ) > 0
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Create table of Synergies between indexes, foreign key constraints, and missing indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Create - [SQLXL_Index_Synergies_index] - Organize all SYNERGIES by Index - includes MISSING and FOREIGN KEYs
/******************************************************************************************************************************************/
IF OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Synergies_index]') IS NOT NULL
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Synergies_index];

SELECT s.database_id
      ,s.object_id
      ,s.index_id
      ,s.type
      ,synergy_type       = s.synergy_type
      ,synergy_direction  = s.synergy_direction
      ,s.matching_CNT
      ,matching_COL       = s.matching_COL
  INTO [tempdb].[dbo].[SQLXL_Index_Synergies_index]
  FROM (--
        SELECT s.database_id
              ,object_id         = s.l_object_id
              ,index_id          = s.l_index_id
              ,type              = s.l_type
              ,synergy_type      = N'S'
              ,synergy_direction = N''
              ,matching_CNT      = s.matching_sequence_CNT
              ,matching_COL      = s.matching_sequence_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_sequence_CNT         > 0
           AND LEFT(s.matching_sequence_COL,1) = N'S'
        UNION
        SELECT s.database_id
              ,object_id         = s.r_object_id
              ,index_id          = s.r_index_id
              ,type              = s.r_type
              ,synergy_type      = N'S'
              ,synergy_direction = N''
              ,s.matching_sequence_CNT
              ,s.matching_sequence_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_sequence_CNT         > 0
           AND LEFT(s.matching_sequence_COL,1) = N'S'
        UNION
        SELECT s.database_id
              ,object_id         = s.l_object_id
              ,index_id          = s.l_index_id
              ,type              = s.l_type
              ,synergy_type      = N'F'
              ,synergy_direction = N''
              ,matching_CNT      = s.matching_sequence_CNT
              ,matching_COL      = s.matching_sequence_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_sequence_CNT         > 0
           AND LEFT(s.matching_sequence_COL,1) = N'F'
        UNION
        SELECT s.database_id
              ,object_id         = s.r_object_id
              ,index_id          = s.r_index_id
              ,type              = s.r_type
              ,synergy_type      = N'F'
              ,synergy_direction = N''
              ,s.matching_sequence_CNT
              ,s.matching_sequence_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_sequence_CNT         > 0
           AND LEFT(s.matching_sequence_COL,1) = N'F'
        UNION
        SELECT s.database_id
              ,object_id         = s.l_object_id
              ,index_id          = s.l_index_id
              ,type              = s.l_type
              ,synergy_type      = N'O'
              ,synergy_direction = N''
              ,s.matching_overlap_CNT
              ,s.matching_overlap_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_overlap_CNT > 0
        UNION
        SELECT s.database_id
              ,object_id         = s.r_object_id
              ,index_id          = s.r_index_id
              ,type              = s.r_type
              ,synergy_type      = N'O'
              ,synergy_direction = N''
              ,s.matching_overlap_CNT
              ,s.matching_overlap_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_overlap_CNT > 0
        UNION
        SELECT s.database_id
              ,object_id         = s.l_object_id
              ,index_id          = s.l_index_id
              ,type              = s.l_type
              ,synergy_type      = N'C'
              ,synergy_direction = N'<'
              ,s.matching_contained_CNT
              ,s.matching_contained_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_contained_CNT > 0
        UNION
        SELECT s.database_id
              ,object_id         = s.r_object_id
              ,index_id          = s.r_index_id
              ,type              = s.r_type
              ,synergy_type      = N'C'
              ,synergy_direction = N'>'
              ,s.matching_contained_CNT
              ,s.matching_contained_COL
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.matching_contained_CNT > 0
       ) s
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Organize all SYNERGIES by Index - includes MISSING and FOREIGN KEYs'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- index table
CREATE CLUSTERED
 INDEX ixc_SQLXL_Index_Synergies_index
    ON [tempdb].[dbo].[SQLXL_Index_Synergies_index](database_id,object_id,index_id,type,synergy_type)
  WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index [tempdb].[dbo].[SQLXL_Index_Synergies_index]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - main table with SYNERGIES
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
SELECT tgt.database_id,tgt.object_id,tgt.index_id,tgt.type,
--*/
       overlap_code = TRY_CAST(STUFF(-- Strip off leading unnecessary characters
                                     (--
                                      SELECT  NCHAR(92)
                                            + IIF(src.synergy_direction = N'>',src.synergy_direction,N'')
                                            + src.matching_COL
                                            + IIF(src.synergy_direction = N'<',src.synergy_direction,N'')
                                        FROM [tempdb].[dbo].[SQLXL_Index_Synergies_index] AS src
                                       WHERE tgt.database_id                       = src.database_id
                                         AND tgt.object_id                         = src.object_id
                                         AND tgt.index_id                          = src.index_id
                                         AND tgt.type                              = src.type
                                       ORDER BY
                                             CASE src.synergy_type
                                                  WHEN 'S' THEN 1 -- sequence
                                                  WHEN 'O' THEN 2 -- overlap
                                                  WHEN 'C' THEN 3 -- contained
                                                  WHEN 'F' THEN 4 -- foreign key
                                             END
                                            ,src.matching_COL
                                         FOR XML PATH(''), TYPE
                                     ).value('(./text())[1]','NVARCHAR(886)')
                                    ,1,1,N'')
                              AS NVARCHAR(886))
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS tgt
  JOIN (-- only need to update indexes with one or more shared elements
        SELECT database_id
              ,object_id
              ,index_id
              ,type
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies_index]
         GROUP BY
               database_id
              ,object_id
              ,index_id
              ,type
       ) AS src
    ON tgt.database_id  = src.database_id
   AND tgt.object_id    = src.object_id
   AND tgt.index_id     = src.index_id
   AND tgt.type         = src.type
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update SQLXL_Index_Compilation with SYNERGIES'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Weight the Missing Index Advantage with percent of table reads factor
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.database_id,tgt.object_id,tgt.index_id,tgt.type,tgt.mix_Advantage_AMT,tgt.ius_user_read_CNT,usg.reads,
--*/
       mix_advantage_weighted_AMT = IIF(usg.reads > 0
                                       ,tgt.mix_Advantage_AMT * (1.0 * tgt.ius_user_read_CNT / usg.reads) -- /zero handled by HAVING
                                       ,NULL)
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE type = N'M'
       ) AS tgt
  JOIN (--
        SELECT database_id
              ,parent_object_id
              ,reads = SUM(ius_user_read_CNT)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type    <> N'M'
         GROUP BY
               database_id
              ,parent_object_id
        HAVING SUM(ius_user_read_CNT) > 0
       ) usg
    ON tgt.database_id      = usg.database_id
   AND tgt.parent_object_ID = usg.parent_object_ID;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update Missing Index Advantage with percent of table reads factor'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Add Missing index values to Uncovered Foreign Key Constraints
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT r.database_id,r.object_id,r.index_id,r.type,
--*/
       fkc_missing_index_CNT          = r.fkc_missing_index_CNT
      ---------------------
      ,mix_avg_total_user_cost_AMT    = r.mix_avg_total_user_cost_AMT
      ,mix_avg_total_system_cost_AMT  = r.mix_avg_total_system_cost_AMT
      ,mix_avg_user_impact_AMT        = r.mix_avg_user_impact_AMT
      ,mix_avg_system_impact_AMT      = r.mix_avg_system_impact_AMT
      ,mix_unique_compiles_CNT        = r.mix_unique_compiles_CNT
      ,mix_Advantage_AMT              = r.mix_Advantage_AMT
      ,mix_Advantage_weighted_AMT     = r.mix_Advantage_weighted_AMT
      ---------------------
      ,ius_user_total_CNT             = r.ius_user_total_CNT
      ,ius_user_read_CNT              = r.ius_user_read_CNT
      ,ius_user_seeks_CNT             = r.ius_user_seeks_CNT
      ,ius_user_scans_CNT             = r.ius_user_scans_CNT
      ,ius_system_seeks_CNT           = r.ius_system_seeks_CNT
      ,ius_system_scans_CNT           = r.ius_system_scans_CNT
      ---------------------
      ,ius_last_user_seek_DTTM        = r.ius_last_user_seek_DTTM
      ,ius_last_user_scan_DTTM        = r.ius_last_user_scan_DTTM
      ,ius_last_system_seek_DTTM      = r.ius_last_system_seek_DTTM
      ,ius_last_system_scan_DTTM      = r.ius_last_system_scan_DTTM
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'F'
       ) AS tgt
  JOIN (-- total up impact of missing indexes on uncovered Foreign Key Constraints
        SELECT o.database_id
              ,o.parent_object_id
              ,object_id = o.fkc_object_id
              ,index_id  = o.fkc_object_id
              ,type      = o.fkc_type
              ---------------------
              ,fkc_missing_index_CNT         = COUNT(1)
              ---------------------
              ,mix_avg_total_user_cost_AMT   = AVG(COALESCE(mx.mix_avg_total_user_cost_AMT  ,0))
              ,mix_avg_total_system_cost_AMT = AVG(COALESCE(mx.mix_avg_total_system_cost_AMT,0))
              ,mix_avg_user_impact_AMT       = AVG(COALESCE(mx.mix_avg_user_impact_AMT      ,0))
              ,mix_avg_system_impact_AMT     = AVG(COALESCE(mx.mix_avg_system_impact_AMT    ,0))
              ,mix_unique_compiles_CNT       = SUM(COALESCE(mx.mix_unique_compiles_CNT      ,0))
              ,mix_Advantage_AMT             = SUM(COALESCE(mx.mix_Advantage_AMT            ,0))
              ,mix_Advantage_weighted_AMT    = SUM(COALESCE(mx.mix_Advantage_weighted_AMT   ,0))
              ---------------------
              ,ius_user_total_CNT            = SUM(COALESCE(mx.ius_user_total_CNT           ,0))
              ,ius_user_read_CNT             = SUM(COALESCE(mx.ius_user_read_CNT            ,0))
              ,ius_user_seeks_CNT            = SUM(COALESCE(mx.ius_user_seeks_CNT           ,0))
              ,ius_user_scans_CNT            = SUM(COALESCE(mx.ius_user_scans_CNT           ,0))
              ,ius_system_seeks_CNT          = SUM(COALESCE(mx.ius_system_seeks_CNT         ,0))
              ,ius_system_scans_CNT          = SUM(COALESCE(mx.ius_system_scans_CNT         ,0))
              ---------------------
              ,ius_last_user_seek_DTTM       = MAX(COALESCE(mx.ius_last_user_seek_DTTM      ,0))
              ,ius_last_user_scan_DTTM       = MAX(COALESCE(mx.ius_last_user_scan_DTTM      ,0))
              ,ius_last_system_seek_DTTM     = MAX(COALESCE(mx.ius_last_system_seek_DTTM    ,0))
              ,ius_last_system_scan_DTTM     = MAX(COALESCE(mx.ius_last_system_scan_DTTM    ,0))
          FROM (--
                SELECT database_id
                      ,parent_object_id
                      ,fkc_object_id = r_object_id
                      ,fkc_type      = r_type
                      ,mix_object_id = l_object_id
                      ,mix_id        = l_index_id
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] WITH (READUNCOMMITTED)
                 WHERE l_type        = N'M'
                   AND r_type        = N'F'
                UNION
                SELECT database_id
                      ,parent_object_id
                      ,fkc_object_id = l_object_id
                      ,fkc_type      = l_type
                      ,mix_object_id = r_object_id
                      ,mix_id        = r_index_id
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] WITH (READUNCOMMITTED)
                 WHERE l_type        = N'F'
                   AND r_type        = N'M'
               ) AS o
         OUTER
         APPLY (SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS mx WITH (READUNCOMMITTED)
                 WHERE rec_type = N'I'
                   AND o.database_id         = mx.database_id
                   AND o.mix_object_id       = mx.object_id
                   AND o.mix_id              = mx.index_ID
                   AND N'M'                  = mx.type
               ) AS mx
         GROUP BY
               o.database_id
              ,o.parent_object_id
              ,o.fkc_object_id
              ,o.fkc_object_id
              ,o.fkc_type
       ) r
    ON tgt.database_id      = r.database_id
   AND tgt.parent_object_id = r.parent_object_id
   AND tgt.object_id        = r.object_id
   AND tgt.index_id         = r.index_id
   AND tgt.type             = r.type
 WHERE tgt.fkc_covered_by_idx_IDS IS NULL -- already covered, don't add missing indexes providing coverage
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Add Missing index values to Uncovered Foreign Key Constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Find best missing index to cover a foreign key
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.database_id,tgt.object_id,tgt.index_id,tgt.type,mix.*,
--*/
       fkc_candidate_covering_MIX_ID = mix.mix_index_ID
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS tgt
  JOIN (-- total up impact of missing indexes on uncovered Foreign Key Constraints
        SELECT fkc.database_id
              ,fkc.object_id
              ,fkc.index_id
              ,fkc.type
              ,syn.matching_sequence_CNT
              ,mix.mix_Advantage_AMT
              ,mix.ius_user_read_CNT
              ---------------------
              ,mix_index_id = mix.index_id
              ,rn = ROW_NUMBER() OVER (PARTITION BY fkc.database_id
                                                   ,fkc.object_id
                                                   ,fkc.index_id
                                                   ,fkc.type
                                           ORDER BY -- try to find the most "significant" missing index to use to cover Foreign Key
                                                    syn.matching_sequence_CNT  DESC
                                                   ,syn.matching_overlap_CNT   DESC
                                                   ,syn.matching_contained_CNT DESC
                                                   ,mix.Key_Columns_CNT
                                                   ,mix.Included_Columns_CNT
                                                   ,mix.ius_user_read_CNT      DESC
                                      )
          FROM (--
                SELECT database_id
                      ,fkc_object_id              = r_object_id
                      ,mix_object_id              = l_object_id
                      ,mix_id                     = l_index_id
                      ,matching_sequence_CNT
                      ,matching_overlap_CNT
                      ,matching_contained_CNT
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies]
                 WHERE l_type     = N'M'
                   AND r_type     = N'F'
                   AND (   matching_sequence_CNT  > 0
                        OR matching_overlap_CNT   > 0
                        OR matching_contained_CNT > 0
                       )
                 UNION
                SELECT database_id
                      ,fkc_object_id              = l_object_id
                      ,mix_object_id              = l_object_id
                      ,mix_id                     = r_index_id
                      ,matching_sequence_CNT
                      ,matching_overlap_CNT
                      ,matching_contained_CNT
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies]
                 WHERE l_type     = N'F'
                   AND r_type     = N'M'
                   AND (   matching_sequence_CNT  > 0
                        OR matching_overlap_CNT   > 0
                        OR matching_contained_CNT > 0
                       )
               ) AS syn
          JOIN (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type = N'I'
                   AND N'F'     = type
               ) AS fkc
            ON syn.database_id    = fkc.database_id
           AND syn.fkc_object_id  = fkc.object_id
           AND syn.fkc_object_id  = fkc.index_id
          JOIN (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type = N'I'
                   AND N'M'     = type
               ) AS mix
            ON syn.database_id    = mix.database_id
           AND syn.mix_object_id  = mix.object_id
           AND syn.mix_id         = mix.index_ID
       ) AS mix
    ON tgt.database_id    = mix.database_id
   AND tgt.object_id      = mix.object_id
   AND tgt.index_id       = mix.index_id
   AND tgt.type           = mix.type
   AND 1                  = mix.rn
 WHERE tgt.type           = N'F'
   AND tgt.fkc_covered_by_idx_IDS IS NULL
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Find best missing index to cover a foreign key'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Compute Aggregate Counts & Amounts for Parents, Databases, Instance
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'',0,0) WITH NOWAIT;
   RAISERROR(N'--------- Start numeric metrics computations -----------------------------------',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Rollup totals to PARENT level - Base (includes Internal Tables) & History tables
-- USE dynamic SQL to create list of columns
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql       NVARCHAR(MAX)
       ,@name      NVARCHAR(MAX)
       ,@msg       NVARCHAR(1000)
       ,@exec_dttm DATETIME = GETDATE()
SET ANSI_WARNINGS ON; -- FOR XML PATH used below
--*/

SET @sql = N'
UPDATE tgt
   SET ' + STUFF(-- Strip off leading unnecessary characters
                 (--
                  SELECT NCHAR(13) + NCHAR(10) + N'      ,' + c.name + N' = src.' + c.name
                   FROM [tempdb].[sys].[columns] c
                   JOIN [tempdb].[sys].[types]   t
                     ON c.system_type_id = t.system_type_id
                  WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                    AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
                         OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
                        )
                    AND c.name NOT LIKE N'Partition_%'
                    AND c.name NOT IN (N'tbl_column_CNT'
                                      ,N'Key_Columns_CNT'
                                      ,N'row_CNT'
                                      ,N'CLR_trigger_CNT'
                                      ,N'SQL_trigger_CNT'
                                      ,N'is_instead_of_trigger_CNT'
                                      )
                    FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
                ,1,9,N'') -- includes the first CR + LF too!
+ N'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN (--
        SELECT database_id
              ,parent_object_id'
              +  (--
                  SELECT NCHAR(13) + NCHAR(10)
                        + N'              ,' -- list of columns in table
                        + c.name + N' = SUM(COALESCE(' + CASE WHEN c.name LIKE N'ius_%'
                                                              THEN N'CASE WHEN type = N''M'' THEN 0 ELSE ' + c.name + N' END'
                                                              ELSE c.name
                                                         END
                                                + N',0))'
                   FROM [tempdb].[sys].[columns] c
                   JOIN [tempdb].[sys].[types]   t
                     ON c.system_type_id = t.system_type_id
                  WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                    AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
                         OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
                        )
                    AND c.name NOT LIKE N'Partition_%'
                    AND c.name NOT IN (N'tbl_column_CNT'
                                      ,N'Key_Columns_CNT'
                                      ,N'row_CNT'
                                      ,N'CLR_trigger_CNT'
                                      ,N'SQL_trigger_CNT'
                                      ,N'is_instead_of_trigger_CNT'
                                      )
                    FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
+ N'
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE N''I''  = rec_type
         GROUP BY
               database_id
              ,parent_object_id
       ) AS src
    ON tgt.database_id      = src.database_id
   AND tgt.parent_object_id = src.parent_object_id
   AND tgt.rec_type         = N''P'''

EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Rollup totals to PARENT level - Base (includes Internal Tables) & History tables'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent MAX Values - Latest DTTM, last read/write days ago, row count
-- USE dynamic SQL to create list of columns
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql       NVARCHAR(MAX)
--*/

SET @sql = N'
SET ANSI_WARNINGS OFF;
UPDATE tgt
   SET ' + STUFF(-- Strip off leading unnecessary characters
                 (
                  SELECT NCHAR(13) + NCHAR(10) + N'      ,' + c.name + N' = src.' + c.name -- No COALESCE since no date is NULL
                    FROM [tempdb].[sys].[columns] c
                    JOIN [tempdb].[sys].[types]   t
                      ON c.system_type_id = t.system_type_id
                   WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                     AND (   (t.name    = 'DATETIME' AND c.name LIKE N'%_DTTM')
                          OR (t.name LIKE N'%INT'    AND c.name LIKE N'%_days_ago%')
                          OR c.name    IN (N'row_CNT',N'is_activity_for_period')
                         )
                     FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
                ,1,9,N'') -- includes the first CR + LF too!
+ N'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN (SELECT database_id
              ,parent_object_id'
              + (--
                 SELECT NCHAR(13) + NCHAR(10) + N'              ,'
                       + c.name + N' = ' 
                       + IIF(c.name LIKE N'%days_ago%',N'MIN',N'MAX')
                       + N'(COALESCE(' + c.name + N',' 
                       + IIF(c.name LIKE N'%days_ago%',N'NULL',N'0') + N'))'
                   FROM [tempdb].[sys].[columns] c
                   JOIN [tempdb].[sys].[types]   t
                     ON c.system_type_id = t.system_type_id
                  WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                    AND (   (t.name    = 'DATETIME' AND c.name LIKE N'%_DTTM')
                         OR (t.name LIKE N'%INT'    AND c.name LIKE N'%_days_ago%')
                         OR c.name    IN (N'row_CNT',N'is_activity_for_period')
                        )
                    FOR XML PATH(N''), TYPE
                ).value('(./text())[1]','NVARCHAR(MAX)')
+ N'
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE N''I''  = rec_type
         GROUP BY
               database_id
              ,parent_object_id
       ) AS src
    ON tgt.database_id      = src.database_id
   AND tgt.parent_object_id = src.parent_object_id
   AND tgt.rec_type         = N''P'';'

EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Parent MAX Values - Latest DTTM, last read/write days ago, row count'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-----------------------------------------------------------------------------------------------------------------------------------------
-- Rollup totals to Database level
-----------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql       NVARCHAR(MAX)
       ,@msg       NVARCHAR(1000)
       ,@exec_dttm DATETIME      = GETDATE()
--*/

SET @sql = N'
UPDATE tgt
   SET ' + STUFF(-- Strip off leading unnecessary characters
                 (--
                  SELECT NCHAR(13) + NCHAR(10) + N'      ,'       + c.name + N' = COALESCE(src.' + c.name + N',0)'
                    FROM [tempdb].[sys].[columns] c
                    JOIN [tempdb].[sys].[types]   t
                      ON c.system_type_id = t.system_type_id
                   WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                     AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
                          OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
                         )
                     AND c.name NOT LIKE N'Partition_%'
                     AND c.name NOT IN (N'tbl_column_CNT'
                                       ,N'Key_Columns_CNT'
                                       ,N'row_CNT'
                                       ,N'CLR_trigger_CNT'
                                       ,N'SQL_trigger_CNT'
                                       ,N'is_instead_of_trigger_CNT'
                                       )
                     FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
                ,1,9,N'')
+ N'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN (SELECT database_id'
              + (SELECT NCHAR(13) + NCHAR(10)
                       + N'              ,'
                       + c.name + N' = SUM(' + c.name + N')'
                   FROM [tempdb].[sys].[columns] c
                   JOIN [tempdb].[sys].[types]   t
                     ON c.system_type_id = t.system_type_id
                  WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                    AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
                         OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
                        )
                    AND c.name NOT LIKE N'Partition_%'
                    AND c.name NOT IN (N'tbl_column_CNT'
                                      ,N'Key_Columns_CNT'
                                      ,N'row_CNT'
                                      ,N'CLR_trigger_CNT'
                                      ,N'SQL_trigger_CNT'
                                      ,N'is_instead_of_trigger_CNT'
                                      )
                    FOR XML PATH(N''), TYPE
                ).value('(./text())[1]','NVARCHAR(MAX)')
+ N'
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N''P''
         GROUP BY
               database_id
       ) AS src
    ON tgt.database_id      = src.database_id
   AND tgt.rec_type         = N''D'';'


EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database AMT & CNT Totals'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Rollup totals to Instance level
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql       NVARCHAR(MAX)
--*/

SET @sql = N'
UPDATE tgt
   SET ' + STUFF(-- Strip off leading unnecessary characters
                 (--
                  SELECT NCHAR(13) + NCHAR(10) + N'      ,' + c.name + N' = COALESCE(src.' + c.name + N',0)'
                    FROM [tempdb].[sys].[columns] c
                    JOIN [tempdb].[sys].[types]   t
                      ON c.system_type_id = t.system_type_id
                   WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                     AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
                          OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
                         )
                     AND c.name NOT LIKE N'Partition_%'
                     AND c.name NOT IN (N'tbl_column_CNT'
                                       ,N'Key_Columns_CNT'
                                       ,N'row_CNT'
                                       ,N'CLR_trigger_CNT'
                                       ,N'SQL_trigger_CNT'
                                       ,N'is_instead_of_trigger_CNT'
                                       )
                     FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
                ,1,9,N'')
+ N'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
CROSS JOIN (SELECT na = 0' -- starter line
               + (SELECT NCHAR(13) + NCHAR(10)
                        + N'              ,'
                        + c.name + N' = SUM(' + c.name + N')'
                    FROM [tempdb].[sys].[columns] c
                    JOIN [tempdb].[sys].[types]   t
                      ON c.system_type_id = t.system_type_id
                   WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                     AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
                          OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
                         )
                     AND c.name NOT LIKE N'Partition_%'
                     AND c.name NOT IN (N'tbl_column_CNT'
                                       ,N'Key_Columns_CNT'
                                       ,N'row_CNT'
                                       ,N'CLR_trigger_CNT'
                                       ,N'SQL_trigger_CNT'
                                       ,N'is_instead_of_trigger_CNT'
                                       )
                   FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
+ N'
              FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
             WHERE rec_type = N''P''
           ) AS src
 WHERE tgt.rec_type         = N''A'';'


EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Instance AMT & CNT Totals'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- All millisecond (_MS) average (_AVG) computed values
-- Requires all other values computed. Calculates for all levels (Index->Parent->Database->Instance)
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql       NVARCHAR(MAX)
--*/

SET @sql = N'
UPDATE tgt
   SET ' + STUFF(-- Strip off leading unnecessary characters
                 (--
                  SELECT NCHAR(13) + NCHAR(10)
                        + N'      ,'
                        + c.name + N' = IIF(' + REPLACE(c.name,N'_MS_AVG',N'_CNT') + N' ' + NCHAR(62) + N' 0' -- NCHAR(62) is ">"
                                       + N',1.0 * COALESCE(' + REPLACE(c.name,N'_MS_AVG',N'_MS_CNT')
                                                             + N',0) / '
                                                             + REPLACE(c.name,N'_MS_AVG',N'_CNT')
                                                      + N',NULL)'
                    FROM [tempdb].[sys].[columns] c
                    JOIN [tempdb].[sys].[types]   t
                      ON c.system_type_id = t.system_type_id
                   WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
                     AND t.name      = 'float'
                     AND c.name LIKE N'%_MS_AVG'
                     FOR XML PATH(N''), TYPE
                 ).value('(./text())[1]','NVARCHAR(MAX)')
                ,1,9,N'')
+ N'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt';


EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Calculated all Averages'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Index Computed values and ratios
/******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT tgt.object_id,tgt.index_id,p.rec_type,
--*/
 ius_read_to_write_RAT     = IIF(tgt.ius_user_updates_CNT > 0,1.0 * COALESCE(tgt.ius_user_read_CNT ,0) / tgt.ius_user_updates_CNT,NULL)
,ops_read_to_write_RAT     = IIF(tgt.ops_total_write_CNT  > 0,1.0 * COALESCE(tgt.ops_total_read_CNT,0) / tgt.ops_total_write_CNT ,NULL)
,page_lock_to_row_lock_RAT = IIF(tgt.ios_row_lock_CNT     > 0,1.0 * COALESCE(tgt.ios_page_lock_CNT ,0) / tgt.ios_row_lock_CNT    ,NULL)
-------------------------------------------------
,ius_scans_to_read_PCT     = IIF(tgt.ius_user_read_CNT    > 0,100.0 * tgt.ius_user_scans_CNT   / tgt.ius_user_read_CNT ,NULL)
,ius_lookups_to_read_PCT   = IIF(tgt.ius_user_read_CNT    > 0,100.0 * tgt.ius_user_lookups_CNT / tgt.ius_user_read_CNT ,NULL)
,ius_seeks_to_read_PCT     = IIF(tgt.ius_user_read_CNT    > 0,100.0 * tgt.ius_user_seeks_CNT   / tgt.ius_user_read_CNT ,NULL)
,ius_read_to_parent_PCT    = IIF(p.ius_user_read_CNT      > 0,100.0 * tgt.ius_user_read_CNT    / p.ius_user_read_CNT   ,NULL)
,ius_write_to_parent_PCT   = IIF(p.ius_user_updates_CNT   > 0,100.0 * tgt.ius_user_updates_CNT / p.ius_user_updates_CNT,NULL)
,ius_write_to_instance_PCT = IIF(a.ius_user_updates_CNT   > 0,100.0 * tgt.ius_user_updates_CNT / a.ius_user_updates_CNT,NULL)
-------------------------------------------------
,ops_scans_to_read_PCT            = IIF(tgt.ops_total_read_CNT > 0,100.0 * tgt.ops_total_scan_CNT       / tgt.ops_total_read_CNT,NULL)
                                    -- NOTE: COLUMNSTORE excluded from above since ALL reads are SCANS
,ios_singleton_lookup_to_read_PCT = IIF(tgt.ops_total_read_CNT > 0,100.0 * tgt.ios_singleton_lookup_CNT / tgt.ops_total_read_CNT,NULL)
,ios_forwarded_fetch_to_read_PCT  = IIF(tgt.ops_total_read_CNT > 0,100.0 * tgt.ios_forwarded_fetch_CNT  / tgt.ops_total_read_CNT,NULL)
,ops_read_to_parent_PCT           = IIF(p.ops_total_read_CNT   > 0,100.0 * tgt.ops_total_read_CNT       / p.ops_total_read_CNT  ,NULL)
,ops_write_to_parent_PCT          = IIF(p.ops_total_write_CNT  > 0,100.0 * tgt.ops_total_write_CNT      / p.ops_total_write_CNT ,NULL)
,ops_write_to_instance_PCT        = IIF(a.ops_total_write_CNT  > 0,100.0 * tgt.ops_total_write_CNT      / a.ops_total_write_CNT ,NULL)
,page_splits_to_write_PCT         = IIF((COALESCE(tgt.ops_total_insert_CNT,0) + COALESCE(tgt.ops_total_update_CNT,0)) > 0
                                       ,100.0 *  tgt.ops_total_page_split_CNT / (tgt.ops_total_insert_CNT + tgt.ops_total_update_CNT)
                                       ,NULL)
,page_merge_to_write_PCT          = IIF(tgt.ops_total_write_CNT > 0
                                       ,100.0 * COALESCE(tgt.ops_total_page_merge_CNT,0) / tgt.ops_total_write_CNT
                                       ,NULL)
,ios_page_compression_fail_PCT    = IIF(tgt.ios_page_compression_attempt_CNT > 0
                                       ,100.0 * tgt.ios_page_compression_fail_CNT / tgt.ios_page_compression_attempt_CNT
                                       ,NULL)
-------------------------------------------------
,used_pages_in_buffer_PCT         = IIF(tgt.reserved_page_PG_CNT > 0
                                       ,100.0 * tgt.buffer_total_KB_CNT / (tgt.reserved_page_PG_CNT * 8.0)
                                       ,NULL)
  FROM (-- Index level records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS tgt
  JOIN (-- Parent level records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
    ON tgt.database_id           = p.database_id
   AND tgt.parent_object_id      = p.parent_object_id
 CROSS
  JOIN (-- Instance/Sample total
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Calculated percents and ratios - Index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Table/Parent
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT database_id,parent_object_id,object_id,index_id,type,
--*/
 ius_read_to_write_RAT     = IIF(tgt.ius_user_updates_CNT > 0,1.0 * COALESCE(tgt.ius_user_read_CNT ,0) / tgt.ius_user_updates_CNT,NULL)
,ops_read_to_write_RAT     = IIF(tgt.ops_total_write_CNT  > 0,1.0 * COALESCE(tgt.ops_total_read_CNT,0) / tgt.ops_total_write_CNT ,NULL)
,page_lock_to_row_lock_RAT = IIF(tgt.ios_row_lock_CNT     > 0,1.0 * COALESCE(tgt.ios_page_lock_CNT ,0) / tgt.ios_row_lock_CNT    ,NULL)
-------------------------------------------------
,ius_scans_to_read_PCT     = IIF(tgt.ius_user_read_CNT  > 0,100.0 * tgt.ius_user_scans_CNT   / tgt.ius_user_read_CNT,NULL)
,ius_lookups_to_read_PCT   = IIF(tgt.ius_user_read_CNT  > 0,100.0 * tgt.ius_user_lookups_CNT / tgt.ius_user_read_CNT,NULL)
,ius_seeks_to_read_PCT     = IIF(tgt.ius_user_read_CNT  > 0,100.0 * tgt.ius_user_seeks_CNT   / tgt.ius_user_read_CNT,NULL)
,ius_read_to_parent_PCT    = IIF(a.ius_user_read_CNT    > 0,100.0 * tgt.ius_user_read_CNT    / a.ius_user_read_CNT,NULL)
,ius_write_to_parent_PCT   = IIF(a.ius_user_updates_CNT > 0,100.0 * tgt.ius_user_updates_CNT / a.ius_user_updates_CNT,NULL)
,ius_write_to_instance_PCT = IIF(a.ius_user_updates_CNT > 0,100.0 * tgt.ius_user_updates_CNT / a.ius_user_updates_CNT,NULL)
-------------------------------------------------
,ops_scans_to_read_PCT            = IIF(tgt.ops_total_read_CNT > 0,100.0 * tgt.ops_total_scan_CNT       / tgt.ops_total_read_CNT,NULL)
                                    -- NOTE: COLUMNSTORE excluded FROM above since ALL reads are SCANS
,ios_singleton_lookup_to_read_PCT = IIF(tgt.ops_total_read_CNT > 0,100.0 * tgt.ios_singleton_lookup_CNT / tgt.ops_total_read_CNT,NULL)
,ios_forwarded_fetch_to_read_PCT  = IIF(tgt.ops_total_read_CNT > 0,100.0 * tgt.ios_forwarded_fetch_CNT  / tgt.ops_total_read_CNT,NULL)
,ops_read_to_parent_PCT           = IIF(a.ops_total_read_CNT   > 0,100.0 * tgt.ops_total_read_CNT       / a.ops_total_read_CNT,NULL)
,ops_write_to_parent_PCT          = IIF(a.ops_total_write_CNT  > 0,100.0 * tgt.ops_total_write_CNT      / a.ops_total_write_CNT,NULL)
,ops_write_to_instance_PCT        = IIF(a.ops_total_write_CNT  > 0,100.0 * tgt.ops_total_write_CNT      / a.ops_total_write_CNT,NULL)
,page_splits_to_write_PCT         = IIF((COALESCE(tgt.ops_total_insert_CNT,0) + COALESCE(tgt.ops_total_update_CNT,0)) > 0
                                       ,100.0 *  tgt.ops_total_page_split_CNT / (tgt.ops_total_insert_CNT + tgt.ops_total_update_CNT)
                                       ,NULL)
,page_merge_to_write_PCT          = IIF(tgt.ops_total_write_CNT > 0
                                       ,100.0 * COALESCE(tgt.ops_total_page_merge_CNT,0) / tgt.ops_total_write_CNT
                                       ,NULL)
,ios_page_compression_fail_PCT    = IIF(tgt.ios_page_compression_attempt_CNT > 0
                                       ,100.0 * tgt.ios_page_compression_fail_CNT / tgt.ios_page_compression_attempt_CNT
                                       ,NULL)
-------------------------------------------------
,used_pages_in_buffer_PCT         = IIF(tgt.reserved_page_PG_CNT > 0,100.0 * tgt.buffer_total_KB_CNT / (tgt.reserved_page_PG_CNT * 8.0),NULL)
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
 CROSS
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a
 WHERE tgt.rec_type = N'P'
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Calculates percents and ratios - Table/Parent'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Compilation] - Compute metrics as percent of Parent or Instance
/******************************************************************************************************************************************/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Compute index metrics as percent of Parent or Instance',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql        NVARCHAR(MAX)
       ,@ssms_ads       TINYINT = 1
       ,@msg       N(1000)
       ,@exec_dttm  DATETIME      = GETDATE()
--*/

DECLARE @column_name SYSNAME;

IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Metrics]') IS NULL)
BEGIN
   CREATE TABLE [tempdb].[dbo].[SQLXL_Index_Metrics]
   (rec_type         NCHAR(1)       COLLATE DATABASE_DEFAULT NOT NULL  -- D-Database,P-Parent,I-index
   ,database_id      SMALLINT                                NOT NULL
   ,parent_object_id INT                                     NOT NULL
   ,object_id        INT                                     NOT NULL
   ,index_id         INT                                     NOT NULL
   ,type             NVARCHAR(2)    COLLATE DATABASE_DEFAULT NOT NULL
   ,metric           SYSNAME        COLLATE DATABASE_DEFAULT NOT NULL
   ,metric_AMT       FLOAT                                       NULL
   ,metric_FMT       NVARCHAR(7)    COLLATE DATABASE_DEFAULT     NULL
   ,diagnostic_PCT   FLOAT                                       NULL
   -----------------------------
   ,diagnostic       NVARCHAR(1000) COLLATE DATABASE_DEFAULT     NULL
   ,diagnostic_RANK  INT                                         NULL
   ,previous_sum_PCT FLOAT                                       NULL
   );
END

ELSE
BEGIN -- if run interactively
   TRUNCATE TABLE [tempdb].[dbo].[SQLXL_Index_Metrics];

   DROP INDEX ixuc_SQLXL_Index_Metrics
     ON [tempdb].[dbo].[SQLXL_Index_Metrics];
END;

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cursor through all Parent & index Metrics - AMT & CNT
-- Excludes N'%_AVG',N'%_PCT',N'%_RAT' handled below
--------------------------------------------------------------------------------------------------------------------------------------------
DECLARE agg_crsr CURSOR LOCAL STATIC FOR
SELECT -- TOP 1 -- *** LOCAL TESTING
       c.name COLLATE DATABASE_DEFAULT
  FROM [tempdb].[sys].[columns] c
  JOIN [tempdb].[sys].[types]   t
    ON c.system_type_id = t.system_type_id
 WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
   AND (   (t.name    = 'float' AND c.name LIKE N'%_AMT')
        OR (t.name LIKE N'%INT' AND c.name LIKE N'%_CNT%')
       )
   AND c.name NOT LIKE N'Partition_%'
   AND c.name NOT IN (N'tbl_column_CNT'
                     ,N'Key_Columns_CNT'
                     ,N'row_CNT'
                     ,N'CLR_trigger_CNT'
                     ,N'SQL_trigger_CNT'
                     ,N'is_instead_of_trigger_CNT'
                     );

--------------------------------------------------------------------------------------------------------------------------------------------
-- Loop through cursor of columns to calculate INDEX level as percent of PARENT
--------------------------------------------------------------------------------------------------------------------------------------------
OPEN agg_crsr;

WHILE 1 = 1
BEGIN
   FETCH NEXT
    FROM agg_crsr
    INTO @column_name;

   IF @@fetch_status <> 0 BREAK

   SET @sql = N'
--------------------------------------------------------------------------------------------------------------------------------------------
-- Compute Percent of Parent ' + @column_name + N' for Indexes
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Metrics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,metric
      ,metric_AMT
      ,metric_FMT
      ,diagnostic_PCT
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,metric     = ''' + @column_name + N'''
      ,metric_AMT = i.' + @column_name + N'
      ,metric_FMT = [tempdb].[dbo].[SQLXL_3SD](i.' + @column_name + N'
                                               -- Assign the numeric significance data type
                                              ,CASE WHEN CHARINDEX(N''_KB_'',''' + @column_name + N''') > 0 THEN N''KB''
                                                    WHEN CHARINDEX(N''_MS_'',''' + @column_name + N''') > 0 THEN N''MS''
                                                    WHEN CHARINDEX(N''_PG_'',''' + @column_name + N''') > 0 THEN N''P''
                                                    WHEN ''' + @column_name + N''' LIKE N''%_CNT''          THEN N''I''
                                                    ELSE N''N''
                                               END
                                              )
                   + CASE WHEN ''' + @column_name + N''' LIKE N''%_PCT'' THEN N''%''
                          WHEN ''' + @column_name + N''' LIKE N''%_RAT'' THEN N''x''
                          ELSE N''''
                     END
      ,diagnostic_PCT  = CASE WHEN COALESCE(a.' + @column_name + N',0) = 0
                              THEN 0.0
                              ELSE 100.0 * i.' + @column_name + N' / a.' + @column_name + N'
                         END
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 INNER HASH
  JOIN (-- Sum up values for each
        SELECT database_id
              ,parent_object_id
              ,' + @column_name + N' = SUM(COALESCE(' + @column_name + N',0))
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type IN (N''I'')
           AND NOT (    type IN (N''M'') -- Omit missing index values from where they''ve been rolled up into another source column
                    AND N''' + @column_name + N''' NOT LIKE N''MIX_%''
                   )
         GROUP BY
               database_id
              ,parent_object_id
       ) a
    ON i.database_id        = a.database_id
   AND i.parent_object_id   = a.parent_object_id
 WHERE i.rec_type           = N''I''
   AND i.' + @column_name + N' > 0.0
OPTION (FORCE ORDER,MAXDOP 1);'

   EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

   SET @sql = N'
--------------------------------------------------------------------------------------------------------------------------------------------
-- Compute Percent of Total ' + @column_name + N' for Parent
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Metrics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,metric
      ,metric_AMT
      ,metric_FMT
      ,diagnostic_PCT
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,metric          = ''' + @column_name + N'''
      ,metric_AMT      = i.' + @column_name + N'
      ,metric_FMT = [tempdb].[dbo].[SQLXL_3SD](i.' + @column_name + N'
                                        ,CASE WHEN CHARINDEX(N''_KB_'',''' + @column_name + N''') > 0 THEN N''KB''
                                              WHEN CHARINDEX(N''_MS_'',''' + @column_name + N''') > 0 THEN N''MS''
                                              WHEN CHARINDEX(N''_PG_'',''' + @column_name + N''') > 0 THEN N''P''
                                              WHEN ''' + @column_name + N''' LIKE N''%_CNT''          THEN N''I''
                                              ELSE N''N''
                                         END
                                        )
                   + CASE WHEN ''' + @column_name + N''' LIKE N''%_PCT'' THEN N''%''
                          WHEN ''' + @column_name + N''' LIKE N''%_RAT'' THEN N''x''
                          ELSE N''''
                     END
      ,diagnostic_PCT  = CASE WHEN COALESCE(a.' + @column_name + N',0) = 0
                              THEN 0.0
                              ELSE 100.0 * i.' + @column_name + N' / a.' + @column_name + N'
                         END
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 CROSS
  JOIN (-- Database or Instance totals
        SELECT ' + @column_name + N'
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE database_id      = 0
           AND parent_object_id = 0
           AND object_id        = 0
           AND index_id         = 0
           AND type             = N''A''
           AND sub_type         = 0
           AND rec_type         = N''A''
       ) AS a
 WHERE i.rec_type = N''P''
   AND i.' + @column_name + N' > 0.0
OPTION (MAXDOP 1);'

   EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

CLOSE agg_crsr;
DEALLOCATE agg_crsr;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Compute index metrics as percent of Parent or Instance'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Create Loop through Average, Percent, and Ratio columns
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @sql         NVARCHAR(MAX)
       ,@column_name SYSNAME
       ,@ssms_ads    TINYINT = 1
--*/
DECLARE agg_crsr CURSOR LOCAL FAST_FORWARD FOR
SELECT -- TOP 1 -- *** LOCAL TESTING
       c.name COLLATE DATABASE_DEFAULT
  FROM [tempdb].[sys].[columns] c
  JOIN [tempdb].[sys].[types]   t
    ON c.system_type_id = t.system_type_id
 WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
    AND t.name     = N'float'
    AND (   c.name LIKE N'%_PCT'
         OR c.name LIKE N'%_RAT'
        )
 ORDER BY c.name DESC;

--------------------------------------------------------------------------------------------------------------------------------------------
-- Loop through cursor of columns to save off Average, Ratio, Percent computations for use below
--------------------------------------------------------------------------------------------------------------------------------------------
OPEN agg_crsr;

WHILE 1 = 1
BEGIN
   FETCH NEXT
    FROM agg_crsr
    INTO @column_name;

   IF @@fetch_status <> 0 BREAK

   SET @sql = N'
--------------------------------------------------------------------------------------------------------------------------------------------
-- Add metrics records for ' + @column_name + N' for Indexes
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Metrics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,metric
      ,metric_AMT
      ,metric_FMT
      ,diagnostic_PCT
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,metric     = ''' + @column_name + N'''
      ,metric_AMT = i.' + @column_name + N'
      ,metric_FMT = CASE WHEN i.' + @column_name + N' IS NULL THEN N''n/a''
                         ELSE [tempdb].[dbo].[SQLXL_3SD](i.' + @column_name + N'
                                                  ,CASE WHEN CHARINDEX(N''_KB_'',''' + @column_name + N''') > 0 THEN N''KB''
                                                        WHEN CHARINDEX(N''_MS_'',''' + @column_name + N''') > 0 THEN N''MS''
                                                        WHEN CHARINDEX(N''_PG_'',''' + @column_name + N''') > 0 THEN N''P''
                                                        WHEN ''' + @column_name + N''' LIKE N''%_CNT''          THEN N''I''
                                                        ELSE N''N''
                                                   END
                                                  )
                             + CASE WHEN ''' + @column_name + N''' LIKE N''%_PCT'' THEN N''%''
                                    WHEN ''' + @column_name + N''' LIKE N''%_RAT'' THEN N''x''
                                    ELSE N''''
                               END
                    END
      ,diagnostic_PCT  = i.' + @column_name + N' --NULL
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type IN (N''I'',N''P'')
   AND i.' + @column_name + N' > 0.0';

   EXECUTE [msdb].[sys].[sp_executesql] @sql; IF @@Error > 0 BEGIN SELECT @sql;RAISERROR('### BLAMMO ! ###',0,0) WITH NOWAIT; END

END

CLOSE agg_crsr;
DEALLOCATE agg_crsr;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Completed adding Ratio and Percent metrics to [tempdb].[dbo].[SQLXL_Index_Metrics]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Create index on SQLXL_Index_Metrics
--------------------------------------------------------------------------------------------------------------------------------------------
CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_Metrics
    ON [tempdb].[dbo].[SQLXL_Index_Metrics]
       (rec_type
       ,database_id
       ,parent_object_id
       ,object_id
       ,index_id
       ,type
       ,metric
       )
  WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed table [tempdb].[dbo].[SQLXL_Index_Metrics]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

/******************************************************************************************************************************************/
-- Update - [SQLXL_Index_Metrics] - Rank percent of parent within instance & index within Parent
/******************************************************************************************************************************************/
--------------------------------------------------------------------------------------------------------------------------------------------
-- Update column rankings - PARENT within TOTAL
--------------------------------------------------------------------------------------------------------------------------------------------
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Update column rankings - PARENT within TOTAL & INDEX within PARENT',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT c.*,
--*/
       diagnostic = CASE WHEN RIGHT(c.metric,4) IN (N'_AVG',N'_PCT',N'_RAT')
                         THEN N'(#' + TRY_CAST(c.diagnostic_rank AS NVARCHAR(20)) + N')'
                         ELSE COALESCE(N'('
                                      + [tempdb].[dbo].[SQLXL_3SD](tgt.diagnostic_PCT,N'N') + N'%'
                                      + COALESCE(N' #' + TRY_CAST(c.diagnostic_rank AS NVARCHAR(20)),N'')
                                      + N')'
                                      ,N'')
                    END
      ,diagnostic_rank  = c.diagnostic_rank
      ,previous_sum_PCT = COALESCE(c.previous_sum_PCT,0.0)
  FROM [tempdb].[dbo].[SQLXL_Index_Metrics] AS tgt
  JOIN (--
        SELECT c.rec_type
              ,c.database_id
              ,c.parent_object_id
              ,c.object_id
              ,c.index_id
              ,c.type
              ,c.metric
              ,c.diagnostic_PCT
              ,c.diagnostic_rank
              ,previous_sum_PCT = LAG(c.running_sum) OVER (PARTITION BY c.metric
                                                               ORDER BY c.running_sum
                                                                       ,c.parent_object_id
                                                          )
          FROM (--
                SELECT rec_type
                      ,database_id
                      ,parent_object_id
                      ,object_id
                      ,index_id
                      ,type
                      ,metric
                      ,diagnostic_PCT
                      ,diagnostic_rank = CASE WHEN metric IN (N'ops_read_to_write_RAT'
                                                             ,N'ius_read_to_write_RAT'
                                                             )
                                              THEN NULL
                                              WHEN diagnostic_PCT > 1.0
                                              THEN RANK() OVER (PARTITION BY metric
                                                                    ORDER BY diagnostic_PCT DESC
                                                               )
                                              ELSE NULL
                                         END
                      ,running_sum  = IIF(RIGHT(metric,4) NOT IN (N'_AVG',N'_RAT')
                                         ,SUM(diagnostic_PCT) OVER (PARTITION BY metric
                                                                        ORDER BY diagnostic_PCT DESC
                                                                   )
                                         ,NULL)
                  FROM [tempdb].[dbo].[SQLXL_Index_Metrics]
                 WHERE rec_type = N'P'
                   AND (   (metric = N'page_lock_to_row_lock_RAT' AND metric_AMT >  0.0)
                        OR (metric = N'ops_read_to_write_RAT'     AND metric_AMT <  4.0)
                        OR (metric = N'ius_read_to_write_RAT'     AND metric_AMT <  4.0)
                        OR (metric = N'used_pages_in_buffer_PCT'  AND metric_AMT > 20.0)
                        OR (    metric NOT IN (N'page_lock_to_row_lock_RAT'
                                              ,N'ops_read_to_write_RAT'
                                              ,N'ius_read_to_write_RAT'
                                              ,N'used_pages_in_buffer_PCT'
                                              )
                            AND diagnostic_PCT >= 1.00
                           )
                       )
               ) AS c
       ) AS c
    ON tgt.rec_type         = c.rec_type
   AND tgt.database_id      = c.database_id
   AND tgt.parent_object_id = c.parent_object_id
   AND tgt.object_id        = c.object_id
   AND tgt.index_id         = c.index_id
   AND tgt.type             = c.type
   AND tgt.metric           = c.metric
 WHERE tgt.metric_AMT      <> 0
   AND (   c.previous_sum_PCT <= 80.0
        OR c.previous_sum_PCT IS NULL
        OR RIGHT(c.metric,4) IN (N'_AVG',N'_PCT',N'_RAT')
       )
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update column rankings - PARENT within TOTAL & INDEX within PARENT'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Update - [SQLXL_Index_Metrics] - column rankings - INDEX within PARENT
--------------------------------------------------------------------------------------------------------------------------------------------
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Update column rankings - INDEX within PARENT',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT c.*,
--*/
       diagnostic = CASE WHEN RIGHT(c.metric,4) IN (N'_AVG',N'_PCT',N'_RAT')
                         THEN N'(#' + TRY_CAST(c.diagnostic_rank AS NVARCHAR(20)) + N')'
                         ELSE COALESCE(N'('
                                      + [tempdb].[dbo].[SQLXL_3SD](c.diagnostic_PCT,N'N') + N'%'
                                      + COALESCE(N' #' + TRY_CAST(c.diagnostic_rank AS NVARCHAR(20)),N'')
                                      + N')'
                                      ,N'')
                    END
      ,diagnostic_rank  = c.diagnostic_rank
      ,previous_sum_PCT = COALESCE(c.previous_sum_PCT,0.0)
  FROM [tempdb].[dbo].[SQLXL_Index_Metrics] AS tgt
  JOIN (--
        SELECT c.rec_type
              ,c.database_id
              ,c.parent_object_id
              ,c.object_id
              ,c.index_id
              ,c.type
              ,c.metric
              ,c.diagnostic_PCT
              ,c.diagnostic_rank
              ,previous_sum_PCT = LAG(c.running_sum) OVER (PARTITION BY c.metric
                                                                       ,c.parent_object_id
                                                               ORDER BY c.running_sum
                                                          )
          FROM (--
                SELECT rec_type
                      ,database_id
                      ,parent_object_id
                      ,object_id
                      ,index_id
                      ,type
                      ,metric
                      ,diagnostic_PCT
                      ,diagnostic_rank = CASE WHEN metric IN (N'ops_read_to_write_RAT'
                                                             ,N'ius_read_to_write_RAT'
                                                             )
                                              THEN NULL
                                              WHEN diagnostic_PCT > 1.0
                                              THEN RANK() OVER (PARTITION BY parent_object_id
                                                                            ,metric
                                                                    ORDER BY diagnostic_PCT DESC
                                                               )
                                              ELSE NULL
                                         END
                      ,running_sum  = IIF(RIGHT(metric,4) NOT IN (N'_AVG',N'_RAT')
                                         ,SUM(diagnostic_PCT) OVER (PARTITION BY parent_object_id
                                                                                ,metric
                                                                        ORDER BY diagnostic_PCT DESC
                                                                   )
                                         ,NULL)
                  FROM [tempdb].[dbo].[SQLXL_Index_Metrics]
                 WHERE rec_type = N'I'
                   AND (   (metric = N'page_lock_to_row_lock_RAT' AND metric_AMT >  0.0)
                        OR (metric = N'ops_read_to_write_RAT'     AND metric_AMT <  4.0)
                        OR (metric = N'ius_read_to_write_RAT'     AND metric_AMT <  4.0)
                        OR (metric = N'used_pages_in_buffer_PCT'  AND metric_AMT > 20.0)
                        OR (    metric NOT IN (N'page_lock_to_row_lock_RAT'
                                              ,N'ops_read_to_write_RAT'
                                              ,N'ius_read_to_write_RAT'
                                              ,N'used_pages_in_buffer_PCT'
                                              )
                            AND diagnostic_PCT >= 1.00
                           )
                       )
               ) AS c
       ) AS c
    ON tgt.rec_type         = c.rec_type
   AND tgt.database_id      = c.database_id
   AND tgt.parent_object_id = c.parent_object_id
   AND tgt.object_id        = c.object_id
   AND tgt.index_id         = c.index_id
   AND tgt.type             = c.type
   AND tgt.metric           = c.metric
 WHERE tgt.metric_AMT          >  0.0
   AND (   c.previous_sum_PCT <= 80.0
        OR c.previous_sum_PCT IS NULL
        OR RIGHT(c.metric,4) IN (N'_AVG',N'_PCT',N'_RAT')
       )
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Update column rankings - INDEX within PARENT'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END


--------------------------------------------------------------------------------------------------------------------------------------------
-- Create - [SQLXL_Index_Diagnostics] - Diagnostics Table
--------------------------------------------------------------------------------------------------------------------------------------------
IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Diagnostics]') IS NOT NULL)
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Diagnostics];

CREATE TABLE [tempdb].[dbo].[SQLXL_Index_Diagnostics]
(diagnostic_ID                              INT                                     IDENTITY(1,1)
-------------------------------------------------------
,rec_type                                   CHAR(1)        COLLATE DATABASE_DEFAULT NOT NULL   -- D-Database,P-Parent,I-index
,database_id                                SMALLINT                                NOT NULL
,parent_object_id                           INT                                     NOT NULL
,object_id                                  INT                                     NOT NULL
,index_id                                   INT                                     NOT NULL
,type                                       CHAR(2)        COLLATE DATABASE_DEFAULT NOT NULL
-------------------------------------------------------
,diagnostic                                 NVARCHAR(4000) COLLATE DATABASE_DEFAULT NULL
);

IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Metrics_Summary]') IS NOT NULL)
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Metrics_Summary];

CREATE TABLE [tempdb].[dbo].[SQLXL_Index_Metrics_Summary]
(Diagnostic_ID                              INT                                     IDENTITY(1,1)
-------------------------------------------------------
,rec_type                                   CHAR(1)        COLLATE DATABASE_DEFAULT NOT NULL   -- D-Database,P-Parent,I-index
,database_id                                SMALLINT                                NOT NULL
,parent_object_id                           INT                                     NOT NULL
,object_id                                  INT                                     NOT NULL
,index_id                                   INT                                     NOT NULL
,type                                       CHAR(2)        COLLATE DATABASE_DEFAULT NOT NULL
-------------------------------------------------------
,diagnostic                                 NVARCHAR(4000) COLLATE DATABASE_DEFAULT NULL
);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Created Diagnostics Tables [tempdb].[dbo].[SQLXL_Index_Diagnostics] & Metrics'
   RAISERROR(@msg,0,0) WITH NOWAIT;
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Create Metric Control tables
--------------------------------------------------------------------------------------------------------------------------------------------
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'    Start Insert consolidated metrics into diagnostic table',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*** LOCAL TESTING ***
IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Metric_Rollup]') IS NOT NULL)
   DROP TABLE [tempdb].[dbo].[SQLXL_Index_Metric_Rollup];
--*/

CREATE TABLE [tempdb].[dbo].[SQLXL_Index_Metric_Rollup]
      (metric_rollup_nbr INT     IDENTITY(1,1)
      ,min_value_1       FLOAT NULL
      ,Level_1           SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,abbr_1            SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,min_value_2       FLOAT NULL
      ,Level_2           SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,abbr_2            SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,min_value_3       FLOAT NULL
      ,Level_3           SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,abbr_3            SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,min_value_4       FLOAT NULL
      ,Level_4           SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,abbr_4            SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,min_value_5       FLOAT NULL
      ,Level_5           SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,abbr_5            SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,min_value_6       FLOAT NULL
      ,Level_6           SYSNAME COLLATE DATABASE_DEFAULT NULL
      ,abbr_6            SYSNAME COLLATE DATABASE_DEFAULT NULL
      );

--------------------------------------------------------------------------------------------------------------------------------------------
-- Populate Metric Control tables - adds friendlier names and chooses which totals to compute and concatenate together for display
-- ,(NULL,NULL  -- level 1
--  ,NULL,NULL,NULL  -- level 2
--  ,NULL,NULL,NULL  -- level 3
--  ,NULL,NULL,NULL  -- level 4
--  ,NULL,NULL,NULL  -- level 5
--  ,NULL,NULL,NULL) -- level 6
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Metric_Rollup]
      (min_value_1,Level_1,abbr_1
      ,min_value_2,Level_2,abbr_2
      ,min_value_3,Level_3,abbr_3
      ,min_value_4,Level_4,abbr_4
      ,min_value_5,Level_5,abbr_5
      ,min_value_6,Level_6,abbr_6)
VALUES
-- OPS RD/WRT Ratio
-- USG RD/WRT Ratio
-- OPS Reads
-- OPS Scans
-- OPS Lookups
-- OPS FWD Fetch
-- USG Reads
-- USG Scans
-- USG Lookups
-- LOB ACTVY
-- Last Read Days

/*------------------------------------------------------------------------------------------------------------------------------------------
Priority Metrics
------------------------------------------------------------------------------------------------------------------------------------------*/
-- Diagnostic - Index - Wait Time (BI11&12) & percent of next level up
-- Diagnostic - Index - Wait Counts (BI11&12) & percent of next level up
-- Diagnostic - Index - Wait Average time (BI11&12)
 ( 0.0,N'ops_total_wait_MS_CNT',N'*Waits: Time'
  ,NULL,N'ops_total_wait_CNT',N'Count'
  ,NULL,N'ops_total_wait_MS_AVG',N'Average (BI11)'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Total Locks & percent of next level up
-- Diagnostic - Index - Lock Promotion Attempts & percent of next level up
-- Diagnostic - Index - Lock Promotion Success & percent of next level up
-- Diagnostic - Index - Lock Promotion Fail & percent of next level up
,( 0.0,N'ops_total_lock_CNT',N'*Locks: Count'
  ,0.0,N'ios_lock_promotion_attempt_CNT',N'Promo Attempts'
  ,0.0,N'ios_lock_promotion_CNT',N'Success'
  ,0.0,N'ios_lock_promotion_fail_CNT',N'Fail'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Operations Page Splits - Total. Includes InMemory
-- Diagnostic - Index - Operations Page Splits - Leaf. Includes InMemory
-- Diagnostic - Index - Operations Page Splits - NonLeaf. Includes InMemory
,( 0.0,N'ops_total_page_split_CNT',N'*Splits: Count'
  ,NULL,N'page_splits_to_write_PCT',N'%WRT'
  ,NULL,N'ios_leaf_allocation_CNT',N'Leaf'
  ,NULL,N'ios_nonleaf_allocation_CNT',N'Nonleaf'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Operations Merges - Total. Includes InMemory
-- Diagnostic - Index - Operations Merges - Leaf. Includes InMemory
-- Diagnostic - Index - Operations Merges - Nonleaf. Includes InMemory
,( 0.0,N'ops_total_page_merge_CNT',N'*Merges: Count'
  ,NULL,N'page_merge_to_write_PCT',N'%WRT'
  ,NULL,N'ios_leaf_page_merge_CNT',N'Leaf'
  ,NULL,N'ios_nonleaf_page_merge_CNT',N'Nonleaf'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Missing index advantage Weighted (BI50)
-- Diagnostic - Index - Missing index advantage unweighted (BI50)
-- Diagnostic - Index - Missing index Compiles (BI50)
-- Diagnostic - Index - Missing index Cost (BI50)
-- Diagnostic - Index - Missing index Impact (BI50)
,( 0.0,N'mix_Advantage_weighted_AMT',N'*MIX(BI50) Weighted'
  ,0.0,N'mix_Advantage_AMT',N'UnWeighted'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Missing index Compiles (BI50)
-- Diagnostic - Index - Missing index Cost (BI50)
-- Diagnostic - Index - Missing index Impact (BI50)
,( 0.0,N'mix_unique_compiles_CNT',N'*MIX(BI50) Compiles'
  ,0.0,N'mix_avg_total_user_cost_AMT',N'Cost'
  ,0.0,N'mix_avg_user_impact_AMT',N'Impact'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Operations Writes  - Includes InMemory & Columnstore
-- Diagnostic - Index - Operations Inserts - Includes InMemory & Columnstore
-- Diagnostic - Index - Operations Updates - Includes InMemory & Columnstore
-- Diagnostic - Index - Operations Deletes - Includes InMemory & Columnstore
,( 0.0,N'ops_total_write_CNT',N'*Writes: OPS Total'
  ,NULL,N'ops_total_insert_CNT',N'Ins'
  ,NULL,N'ops_total_update_CNT',N'Upd'
  ,NULL,N'ops_total_delete_CNT',N'Del'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Usage Updates
,( 0.0,N'ius_user_updates_CNT',N'*Writes: USG Upd'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - % reserved data pages in memory buffer
-- Diagnostic - Index - Memory Buffer % Used
,( 8.0,N'buffer_total_KB_CNT',N'*Buffer: Used'
  ,NULL,N'reserved_page_PG_CNT',N'Reserved'
  ,NULL,N'used_pages_in_buffer_PCT',N'%Buffered'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Operations Touches and % next level
-- Diagnostic - Index - Operations Reads % next level
-- Diagnostic - Index - Operations Writes % next level
-- Diagnostic - Index - Operations Read/Write ratio
,( 0.0,N'ops_total_contacts_CNT',N'*OPS: Total (BI81)'
  ,NULL,N'ops_total_read_CNT',N'RDS'
  ,NULL,N'ops_total_write_CNT',N'WRT'
  ,NULL,N'ops_read_to_write_RAT',N'R/W'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Usage Touches and % next level
-- Diagnostic - Index - Usage Reads and % next level
-- Diagnostic - Index - Usage Writes and % next level
-- Diagnostic - Index - Usage Read/Write ratio
,( 0.0,N'ius_user_total_CNT',N'*USG: Total (BI81)'
  ,NULL,N'ius_user_read_CNT',N'RDS'
  ,NULL,N'ius_user_updates_CNT',N'WRT'
  ,NULL,N'ius_read_to_write_RAT',N'R/W'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Operations Read Scan Detail % Parent
-- Diagnostic - Index - Operations Read Lookup Detail % Parent
-- Diagnostic - Index - Operations Read Forwarded Fetch Detail % Parent
,( 0.0,N'ops_total_scan_CNT',N'*Reads: OPS Scans'
  ,NULL,N'ops_scans_to_read_PCT',N'%RDS'
  ,0.0,N'ios_singleton_lookup_CNT',N'Lookups'
  ,NULL,N'ios_singleton_lookup_to_read_PCT',N'%RDS'
  ,0.0,N'ios_forwarded_fetch_CNT',N'FWD Fetch'
  ,NULL,N'ios_forwarded_fetch_to_read_PCT',N'%RDS')

-- Diagnostic - Index - Usage Read Seek Detail % Parent
-- Diagnostic - Index - Usage Read Scan Detail % Parent
,( 0.0,N'ius_user_seeks_CNT',N'*Reads: USG Seeks'
  ,NULL,N'ius_seeks_to_read_PCT',N'%RDS'
  ,0.0,N'ius_user_scans_CNT',N'Scans'
  ,NULL,N'ius_scans_to_read_PCT',N'%RDS'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - Usage Read Lookup Detail % Parent
,( 0.0,N'ius_user_lookups_CNT',N'*Reads: USG Lookups'
  ,NULL,N'ius_lookups_to_read_PCT',N'%RDS'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL)

-- Diagnostic - Index - LOB Fetches
-- Diagnostic - Index - LOB Overflow Fetches
-- Diagnostic - Index - LOB Push off row
-- Diagnostic - Index - LOB Pull in row
,( 0.0,N'ios_lob_fetch_pages_CNT',N'*LOB: Fetch PGs'
  ,0.0,N'ios_row_overflow_fetch_in_pages_CNT',N'Overflow'
  ,0.0,N'ios_column_value_push_off_row_CNT',N'Push off row'
  ,0.0,N'ios_column_value_pull_in_row_CNT',N'Pull in row'
  ,NULL,NULL,NULL
  ,NULL,NULL,NULL);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert consolidated metrics into diagnostic table'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Insert - [SQLXL_Index_Metrics_Summary] - consolidated metrics into diagnostic table
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
TRUNCATE TABLE [tempdb].[dbo].[SQLXL_Index_Metrics_Summary]
--*/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Metrics_Summary]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT f.rec_type
      ,f.database_id
      ,f.parent_object_id
      ,f.object_id
      ,f.index_id
      ,f.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
                           IIF(    r.abbr_1 IS NOT NULL                                    -- label exists in Rollup table 
                              ,N' ' + r.abbr_1 + N': ' + COALESCE(f1.metric_FMT,N'0') 
                              + IIF(f1.metric_FMT IS NOT NULL
                                   ,N' '  + COALESCE(f1.diagnostic,N'('+[tempdb].[dbo].[SQLXL_3SD](f1.diagnostic_PCT,N'N') + N'%)')
                                   ,N'')
                              ,N'')
                         + IIF(    r.abbr_2 IS NOT NULL                                    -- label exists in Rollup table 
                               AND NOT (LEFT(r.abbr_2,1) = N'%' AND f1.metric_FMT IS NULL) -- suppress %(value) if previous is ZERO
                              ,N' ' + r.abbr_2 + N': ' + COALESCE(f2.metric_FMT,N'0') 
                              + IIF(f2.metric_FMT IS NOT NULL
                                   ,N' '  + COALESCE(f2.diagnostic,N'('+[tempdb].[dbo].[SQLXL_3SD](f2.diagnostic_PCT,N'N') + N'%)')
                                   ,N'')
                              ,N'')
                         + IIF(    r.abbr_3 IS NOT NULL                                    -- label exists in Rollup table 
                               AND NOT (LEFT(r.abbr_3,1) = N'%' AND f2.metric_FMT IS NULL) -- suppress %(value) if previous is ZERO
                              ,N' ' + r.abbr_3 + N': ' + COALESCE(f3.metric_FMT,N'0') 
                              + IIF(f3.metric_FMT IS NOT NULL
                                   ,N' '  + COALESCE(f3.diagnostic,N'('+[tempdb].[dbo].[SQLXL_3SD](f3.diagnostic_PCT,N'N') + N'%)')
                                   ,N'')
                              ,N'')
                         + IIF(    r.abbr_4 IS NOT NULL                                    -- label exists in Rollup table 
                               AND NOT (LEFT(r.abbr_4,1) = N'%' AND f3.metric_FMT IS NULL) -- suppress %(value) if previous is ZERO
                              ,N' ' + r.abbr_4 + N': ' + COALESCE(f4.metric_FMT,N'0') 
                              + IIF(f4.metric_FMT IS NOT NULL
                                   ,N' '  + COALESCE(f4.diagnostic,N'('+[tempdb].[dbo].[SQLXL_3SD](f4.diagnostic_PCT,N'N') + N'%)')
                                   ,N'')
                              ,N'')
                         + IIF(    r.abbr_5 IS NOT NULL                                    -- label exists in Rollup table 
                               AND NOT (LEFT(r.abbr_5,1) = N'%' AND f4.metric_FMT IS NULL) -- suppress %(value) if previous is ZERO
                              ,N' ' + r.abbr_5 + N': ' + COALESCE(f5.metric_FMT,N'0') 
                              + IIF(f5.metric_FMT IS NOT NULL
                                   ,N' '  + COALESCE(f5.diagnostic,N'('+[tempdb].[dbo].[SQLXL_3SD](f5.diagnostic_PCT,N'N') + N'%)')
                                   ,N'')
                              ,N'')
                         + IIF(    r.abbr_6 IS NOT NULL                                    -- label exists in Rollup table 
                               AND NOT (LEFT(r.abbr_6,1) = N'%' AND f5.metric_FMT IS NULL) -- suppress %(value) if previous is ZERO
                              ,N' ' + r.abbr_6 + N': ' + COALESCE(f6.metric_FMT,N'0') 
                              + IIF(f6.metric_FMT > N''
                                   ,N' '  + COALESCE(f6.diagnostic,N'('+[tempdb].[dbo].[SQLXL_3SD](f6.diagnostic_PCT,N'N') + N'%)')
                                   ,N'')
                              ,N'')
                         ,1,1,N'')
/*** LOCAL TESTING ***
SELECT r.level_1
      ,tempdb.[dbo].[SQLXL_3SD](COALESCE(f1.metric_AMT,0)
                           ,CASE WHEN CHARINDEX(N'_KB_',r.level_1) > 0 THEN N'KB'
                                 WHEN CHARINDEX(N'_MS_',r.level_1) > 0 THEN N'MS'
                                 ELSE N'N'
                            END)
      ,r.level_2
      ,r.level_3
      ,r.level_4
      ,r.level_5
      ,r.level_6
--*/
  FROM (--
        SELECT f.rec_type
              ,f.database_id
              ,f.parent_object_id
              ,f.object_id
              ,f.index_id
              ,f.type
              ,r.metric_rollup_nbr
          FROM [tempdb].[dbo].[SQLXL_Index_Metrics]       AS f
          JOIN [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] AS r
            ON f.metric = r.level_1
            OR f.metric = r.level_2
            OR f.metric = r.level_3
            OR f.metric = r.level_4
            OR f.metric = r.level_5
            OR f.metric = r.level_6
         WHERE 1 = 1
           AND f.rec_type   IN (N'I',N'P')
           AND f.metric NOT IN (N'used_pages_in_buffer_PCT')
           AND (   (f.metric = N'page_lock_to_row_lock_RAT' AND f.metric_AMT > 0.80)
                OR (f.metric = N'ops_read_to_write_RAT'     AND f.metric_AMT > 4.00)
                OR (f.metric = N'ius_read_to_write_RAT'     AND f.metric_AMT > 4.00)
                OR (    f.metric NOT IN (N'page_lock_to_row_lock_RAT'
                                        ,N'ops_read_to_write_RAT'
                                        ,N'ius_read_to_write_RAT'
                                        ,N'used_pages_in_buffer_PCT'
                                        )
                     AND f.diagnostic_RANK > 0
                    )
             )
         GROUP BY
               f.rec_type
              ,f.database_id
              ,f.parent_object_id
              ,f.object_id
              ,f.index_id
              ,f.type
              ,r.metric_rollup_nbr
       ) f
  JOIN [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] AS r
    ON f.metric_rollup_nbr = r.metric_rollup_nbr
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Metrics] AS f1
    ON r.level_1          = f1.metric
   AND f.rec_type         = f1.rec_type
   AND f.database_id      = f1.database_id
   AND f.parent_object_id = f1.parent_object_id
   AND f.object_id        = f1.object_id
   AND f.index_id         = f1.index_id
   AND f.type             = f1.type
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Metrics] AS f2
    ON r.level_2          = f2.metric
   AND f.rec_type         = f2.rec_type
   AND f.database_id      = f2.database_id
   AND f.parent_object_id = f2.parent_object_id
   AND f.object_id        = f2.object_id
   AND f.index_id         = f2.index_id
   AND f.type             = f2.type
   AND 0.0                < f2.metric_AMT
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Metrics] AS f3
    ON r.level_3          = f3.metric
   AND f.rec_type         = f3.rec_type
   AND f.database_id      = f3.database_id
   AND f.parent_object_id = f3.parent_object_id
   AND f.object_id        = f3.object_id
   AND f.index_id         = f3.index_id
   AND f.type             = f3.type
   AND 0.0                < f3.metric_AMT
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Metrics] AS f4
    ON r.level_4          = f4.metric
   AND f.rec_type         = f4.rec_type
   AND f.database_id      = f4.database_id
   AND f.parent_object_id = f4.parent_object_id
   AND f.object_id        = f4.object_id
   AND f.index_id         = f4.index_id
   AND f.type             = f4.type
   AND 0.0                < f4.metric_AMT
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Metrics] AS f5
    ON r.level_5          = f5.metric
   AND f.rec_type         = f5.rec_type
   AND f.database_id      = f5.database_id
   AND f.parent_object_id = f5.parent_object_id
   AND f.object_id        = f5.object_id
   AND f.index_id         = f5.index_id
   AND f.type             = f5.type
   AND 0.0                < f5.metric_AMT
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Metrics] AS f6
    ON r.level_6          = f6.metric
   AND f.rec_type         = f6.rec_type
   AND f.database_id      = f6.database_id
   AND f.parent_object_id = f6.parent_object_id
   AND f.object_id        = f6.object_id
   AND f.index_id         = f6.index_id
   AND f.type             = f6.type
   AND 0.0                < f6.metric_AMT
 WHERE f1.metric_AMT > r.min_value_1
    OR f2.metric_amt > r.min_value_2
    OR f3.metric_amt > r.min_value_3
    OR f4.metric_amt > r.min_value_4
    OR f5.metric_amt > r.min_value_5
    OR f6.metric_amt > r.min_value_6
 ORDER BY
       f.database_id
      ,f.parent_object_id
      ,f.object_id
      ,f.index_id
      ,f.type
      ,r.metric_rollup_nbr
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Insert records into [tempdb].[dbo].[SQLXL_Index_Metrics_Summary]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_IDX_Diagnostics
    ON [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (database_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic_ID
     )
WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed [tempdb].[dbo].[SQLXL_Index_Diagnostics]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

CREATE UNIQUE CLUSTERED
 INDEX ixuc_SQLXL_Index_Metrics_Summary
    ON [tempdb].[dbo].[SQLXL_Index_Metrics_Summary]
      (database_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic_ID
     )
WITH (DATA_COMPRESSION = PAGE);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Indexed [tempdb].[dbo].[SQLXL_Index_Metrics_Summary]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************/
-- Find metric columns not included in consolidated metrics groupings
/******************************************************************************************************************************************/
/*
SELECT c.name
  FROM [tempdb].[sys].[columns] c
  JOIN [tempdb].[sys].[types]   t
    ON c.system_type_id = t.system_type_id
 WHERE c.object_id = OBJECT_ID('[tempdb].[dbo].[SQLXL_Index_Compilation]')
    AND (   (t.name    = 'float'    AND RIGHT(c.name,4) = N'_AMT')
         OR (t.name LIKE N'%INT'    AND c.name LIKE N'%CNT%')
         OR (t.name    = 'DATETIME' AND c.name LIKE N'%_DTTM')
         OR (t.name LIKE N'%INT'    AND c.name LIKE N'%_days_ago%')
         OR (t.name    = 'float'       AND c.name LIKE N'%_AVG')
         OR (t.name    = 'float'       AND c.name LIKE N'%_RAT')
         OR c.name    IN (N'row_CNT',N'is_activity_for_period')
        )
EXCEPT
SELECT Level_1 FROM (--
SELECT Level_1 FROM [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] UNION
SELECT Level_2 FROM [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] UNION
SELECT Level_3 FROM [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] UNION
SELECT Level_4 FROM [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] UNION
SELECT Level_5 FROM [tempdb].[dbo].[SQLXL_Index_Metric_Rollup] UNION
SELECT Level_6 FROM [tempdb].[dbo].[SQLXL_Index_Metric_Rollup]
) AS c
ORDER BY 1
*/

/*#########################################################################################################################################\
*** Investigate Investigate Investigate Investigate Investigate Investigate Investigate Investigate Investigate Investigate Investigate ****
\#########################################################################################################################################*/
IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   RAISERROR(N'',0,0) WITH NOWAIT;
   RAISERROR(N'--------- Start SQLXL Index Investigate ------------------------------------------',0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Temp table to house prescriptions
----------------------------------------------------------------------------------------------------
IF OBJECT_ID(N'[tempdb]..#prescription',N'U') IS NOT NULL
   DROP TABLE #prescription;

SELECT TOP 0
       database_id
      ,parent_object_id
      ,object_ID
      ,index_ID
      ,type
      ,action_desc  = TRY_CAST(NULL AS NVARCHAR(20))
      ,srt          = TRY_CAST(NULL AS INT)
      ,prescription = TRY_CAST(NULL AS NVARCHAR(1000))
  INTO #prescription
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation];

CREATE CLUSTERED INDEX ixuc_#prescription
    ON #prescription
      (database_id                                                                            
      ,parent_object_id
      ,OBJECT_ID
      ,index_id
      ,TYPE
      ,srt
      )
WITH (DATA_COMPRESSION = PAGE);

DECLARE @srt INT = 0; -- used to control the sequence of Prescriptions within a category

/* Format & Priorities of Diagnostics
(rec_type,database_id,parent_object_id,object_id,index_id,type,diagnostic)
*/

/******************************************************************************************************************************************\
********************************************************************************************************************************************
*** INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTANCE INSTAN ***
********************************************************************************************************************************************
\******************************************************************************************************************************************/
-- Diagnostic - Instance - SQL <2019, Entp Ed, Mem model <> LARGE_PAGES, 8GB+ RAM, TF834 not enabled, NO columnstore, enable Lock/Large Pages?
-- Diagnostic - Instance - SQL 2019+, Entp Ed, Mem model <> LARGE_PAGES, 8GB+ RAM, TF876 (Lock/Lg Pages) not enabled
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_Diagnostics] (diagnostic)
SELECT CASE WHEN 8192 <= (SELECT TRY_CAST(run_value AS BIGINT) -- Large Pages requires minimum 8GB of memory
                            FROM [tempdb].[dbo].[SQLXL_Instance_info]
                           WHERE source    = N'configurations'
                             AND name      = N'max server memory (MB)'
                         )
             AND (-- get SQL Server edition
                  SELECT text_value
                    FROM [tempdb].[dbo].[SQLXL_Instance_info]
                   WHERE source    = N'SERVERPROPERTY'
                     AND name      = N'Edition'
                     AND (   text_value LIKE N'ENTERPRISE%'
                          OR text_value LIKE N'DEVELOPER%'
                         )
                 ) IS NOT NULL
            THEN  N'SQL Memory Model ' + text_value
                + IIF(text_value = N'LOCK_PAGES',N', use "LARGE_PAGES"?',N', use "LOCK_PAGES/LARGE_PAGES"?')
                + CASE WHEN (SELECT version_major 
                               FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters]
                            ) >= 15
                       THEN CASE WHEN 876 NOT IN (SELECT TRY_CAST(name AS BIGINT) FROM [tempdb].[dbo].[SQLXL_Instance_info] WHERE source = N'TRACESTATUS')
                                 THEN ' Req TF876 (SQL 2019+)'
                                 ELSE N''
                            END
                       WHEN (--
                             SELECT COUNT(1)
                               FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                              WHERE type IN (N'5',N'6')
                            ) > 0
                       THEN CASE WHEN 834 IN (SELECT TRY_CAST(name AS BIGINT) FROM [tempdb].[dbo].[SQLXL_Instance_info] WHERE source = N'TRACESTATUS')
                                 THEN N'' -- remove TF834 flagged above
                                 ELSE N' - Columnstore indexes found, do not enable TF834 (SQL <2019)'
                            END
                       ELSE CASE WHEN 834 IN (SELECT TRY_CAST(name AS BIGINT) FROM [tempdb].[dbo].[SQLXL_Instance_info] WHERE source = N'TRACESTATUS')
                                 THEN N''
                                 ELSE N' - Requires TF834 (<SQL 2019)'
                            END
                  END
            ELSE NULL
       END
/*** LOCAL TESTING ***
SELECT *
--*/
  FROM [tempdb].[dbo].[SQLXL_Instance_info]
 WHERE source      = N'dm_os_sys_info'
   AND name        = N'sql_memory_model_desc'
   AND text_value <> N'LARGE_PAGES';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Instance Diagnostics - Enable LARGE PAGES if not Columnstore'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-- Diagnostic - Instance - Columnstore indexes in use and Trace Flag 834 found (BI72)
INSERT
  INTO [tempdb].[dbo].[SQLXL_Instance_Diagnostics] (diagnostic)
SELECT  'Trace Flag 834 (large-page allocations for the buffer pool) in use with Columnstore indexes - not a good thing! See:'
      + NCHAR(92)
      + N'https://docs.microsoft.com/en-US/troubleshoot/sql/admin/performance-issues-using-columstore-indexes-large-pages (BI72)'
  FROM [tempdb].[dbo].[SQLXL_Instance_info] AS a
 WHERE 834 IN (-- list of all server-level trace flags
               SELECT name
                 FROM [tempdb].[dbo].[SQLXL_Instance_info]
                WHERE source = N'TRACESTATUS'
              )
   AND    0 < (-- All columnstore indexes
               SELECT COUNT(1)
                 FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                WHERE type 
                   IN (N'5' -- clustered columnstore
                      ,N'6' -- nonclustered columnstore
                      )
              );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Instance Diagnostics - TF834 enabled & Columnstore indexes used'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Instance-level aggregates
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Instance - Missing index count across instance
SELECT rec_type   = N'A'
      ,a.database_id
      ,a.parent_object_id
      ,a.object_id
      ,a.index_id
      ,a.type
      ,diagnostic = COALESCE( N'Missing indexes: '
                            + TRY_CAST(COALESCE(a.Missing_index_CNT,0) AS NVARCHAR(20))
                            + N' out of 600 possible'
                            ,N'< Missing index count not found>'
                            )
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS a
 WHERE a.rec_type = N'A';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Instance Diagnostics - Missing Indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
***DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE DATABASE***
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = d.database_id
      ,parent_object_id = d.database_id
      ,object_id        = d.database_id
      ,index_id         = d.database_id
      ,type             = 'DB'
      ,diagnostic=
-- Diagnostic - DB - > 5% of indexes with writes and no reads (BI21 & 22)
  N'Nonclustered rowstore indexes with writes & no reads - '
+ TRY_CAST(i.unused_idx_CNT AS NVARCHAR(20)) + N'/' + TRY_CAST(i.idx_CNT AS NVARCHAR(20))
+ IIF(i.idx_CNT > 0,N'(' + [tempdb].[dbo].[SQLXL_3SD](1.0 * I.unused_idx_CNT / i.idx_CNT,N'%') + N')',N'')
+ N' (BI21&22)'
/*** LOCAL TESTING ***
SELECT database_id = d.database_id,i.*
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] d
 CROSS
 APPLY (-- check if > 5% of indexes in each database with writes and no reads (BI21 & 22)
        SELECT unused_idx_CNT = SUM(IIF((COALESCE(i.ops_total_read_CNT,0)
                              + COALESCE(i.ius_User_read_CNT,0)) = 0,1,0))
              ,idx_CNT        = COUNT(1)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
         WHERE i.rec_type    = N'I'
           AND i.obj_type    = N'U'
           AND i.type        = N'2'
           AND d.database_id = i.database_id
           AND (i.ops_total_write_CNT + i.ius_user_updates_CNT) > 0
       ) AS i
 WHERE IIF(i.idx_CNT > 0,100.0 * i.unused_idx_CNT / i.idx_CNT,0.0) > 5.0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - Nonclustered rowstore indexes with writes & no reads'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Diagnostic - DB - < 10% of table & view nonclustered rowstore indexes with Included Columns (BI30 & 31)
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = i.database_id
      ,parent_object_id = i.database_id
      ,object_id        = i.database_id
      ,index_id         = i.database_id
      ,type             = 'DB'
      ,diagnostic = N'Included Columns: <10% Indexes - '
                  + TRY_CAST(i.included_index_CNT AS NVARCHAR(20))
                  + N'/'
                  + TRY_CAST(i.index_CNT AS NVARCHAR(20))
                  + N' (' + [tempdb].[dbo].[SQLXL_3SD](1.0 * i.included_index_CNT / i.index_CNT,N'%') + N')' -- /zero handled by HAVING clause below
                  + N' (BI30&31)'
  FROM (-- All index-level nonclustered rowstores, in tables or views, that are not non-history table
        SELECT database_id
              ,included_index_CNT = SUM(IIF(Included_Columns_CNT > 0,1,0))
              ,index_CNT          = COUNT(1)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type  = N'I'    -- index records
           AND type      = N'2'    -- nonclustered rowstore
           AND obj_type  = N'U'    -- table or view object
           AND obj_type_short_label <> N'HST' -- not a history table
         GROUP BY
               database_id
        HAVING COUNT(1) > 0  -- count of indexes greater than zero
       ) AS i
 WHERE (100.0 * i.included_index_CNT / i.index_CNT) < 10.0; -- /zero handled by HAVING clause above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - < 10% of table & view nonclustered rowstore indexes with Included Columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - DB - Consider Database auto_update_stats_async due to high volumes of data changes (>10% stats rows)
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = i.database_id
      ,parent_object_id = i.database_id
      ,object_id        = i.database_id
      ,index_id         = i.database_id
      ,type             = 'DB'
      ,diagnostic       = TRY_CONVERT(NVARCHAR(20),SUM(1)) + N' high write rowstore indexes (>10% stats rows) - UPDATE_STATS_ASYNC?'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type = N'I'
   AND i.type    IN (N'1',N'2') -- HEAPS handled separately.
   AND i.stats_no_recompute = 0 -- only affects indexes getting recomputed automagically
   AND IIF(i.stathdr_Rows_CNT > 0, 100.0 * i.Stats_Prop_modification_CNT /  i.stathdr_Rows_CNT,0.0) > 10.0
 GROUP BY
       i.database_id;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Diagnostic - DB - Consider Database auto_update_stats_async - lots of data changes (>10pct stats rows)'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Diagnostic - DB - less than 5% of views have indexes (BI32)
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = i.database_id
      ,parent_object_id = i.database_id
      ,object_id        = i.database_id
      ,index_id         = i.database_id
      ,type             = 'DB'
      ,diagnostic = N'Views <5% Indexed - Views: '
                  + TRY_CAST(i.view_CNT AS NVARCHAR(20))
                  + N' CX: '
                  + TRY_CAST(i.clustered_index_CNT AS NVARCHAR(20))
                  + N' ('
                  + [tempdb].[dbo].[SQLXL_3SD](1.0 * i.clustered_index_CNT / i.view_CNT,N'%')  -- /zero handled by HAVING clause below
                  + N') NCX: '
                  + TRY_CAST(i.Nonclustered_index_CNT AS NVARCHAR(20))
                  + N' (BI32)'
  FROM (--  All "index" records in views
        SELECT database_id
              ,clustered_index_CNT    = SUM(Clustered_index_CNT)
              ,Nonclustered_index_CNT = SUM(Nonclustered_index_CNT)
              ,view_CNT               = SUM(IIF(type = N'V',1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
           AND parent_object_type = N'V' -- View parent/object only
         GROUP BY
               database_id
        HAVING SUM(IIF(type = N'V',1,0)) > 0 -- view_CNT
       ) AS i
 WHERE 100.0 * i.clustered_index_CNT / i.view_CNT < 5.0 -- /zero handled by HAVING clause above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - less than 5% of views have indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Diagnostic - DB - less than 5% of indexes with Filters (BI32)
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = i.database_id
      ,parent_object_id = i.database_id
      ,object_id        = i.database_id
      ,index_id         = i.database_id
      ,type             = 'DB'
      ,diagnostic = N'Indexes: <5% Filtered - Index: '
                  + TRY_CAST(i.index_CNT AS NVARCHAR(20))
                  + N' Filtered: '
                  + TRY_CAST(i.filtered_index_CNT AS NVARCHAR(20))
                  + N' ('
                  + [tempdb].[dbo].[SQLXL_3SD](1.0 * i.filtered_index_CNT / i.index_CNT,N'%') -- /zero handled by HAVING clause below
                  + N') (BI32)'
  FROM (--
        SELECT database_id
              ,filtered_index_CNT = SUM(IIF(filter_definition > N'',1,0))
              ,index_CNT          = COUNT(1)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE obj_type IN (N'U',N'V')
           AND obj_type_short_label <> N'HST'
           AND rec_type = N'I'
           AND type     = N'2'
         GROUP BY
               database_id
        HAVING COUNT(1) > 0 -- count of NCX indexes
       ) AS i
 WHERE 100.0 * i.filtered_index_CNT / i.index_CNT < 5.0 -- /zero handled by HAVING clause above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - less than 5% of indexes with Filters'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Change Tracking
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - DB - non-default - Change Tracking Enabled
-- Diagnostic - DB - non-default - Change Tracking Properties
SELECT rec_type         = N'D'
      ,database_id      = 0
      ,parent_object_id = 0
      ,object_id        = 0
      ,index_id         = 0
      ,type             = N'D'
      ,diagnostic       = N'Change Tracking Enabled - Auto Cleanup '
                        + IIF(is_auto_cleanup_on = 1,N'[ON]',N'[OFF]')
                        + N' Retention = [' + TRY_CAST(retention_period AS NVARCHAR(20))
                        + N' ' + retention_period_units_desc + N']'
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
 WHERE d.is_auto_cleanup_on IS NOT NULL;  -- DMV only allows values of 0 = Off, 1 = On

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - Change Tracking'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Database - DDL Triggers - enabled, non-MS
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT p.rec_type
      ,p.database_id
      ,p.database_id
      ,p.database_id
      ,p.database_id
      ,p.type
      ,diagnostic = N'DDL Triggers'
-- Diagnostic - Database - has CLR trigger(s)
                  + N' CLR: ' + IIF(p.CLR_trigger_CNT > 0
                                   ,TRY_CAST(p.CLR_trigger_CNT AS NVARCHAR(20))
                                   ,N'0')
-- Diagnostic - Database - has SQL trigger(s)
                  + N' SQL: ' + IIF(p.SQL_trigger_CNT > 0
                                   ,TRY_CAST(p.SQL_trigger_CNT AS NVARCHAR(20))
                                   ,N'0')
-- Diagnostic - Database - has INSTEAD OF trigger(s)
                  + N' Instead Of: ' + IIF(p.is_instead_of_trigger_CNT > 0
                                          ,TRY_CAST(p.is_instead_of_trigger_CNT AS NVARCHAR(20))
                                          ,N'0')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS p
 WHERE p.rec_type = N'D'
   AND (   p.CLR_trigger_CNT           > 0
        OR p.SQL_trigger_CNT           > 0
        OR p.is_instead_of_trigger_CNT > 0
       );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - DDL Triggers'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- [tempdb].[dbo].[SQLXL_Index_sys_databases] - non default properties
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = d.database_id
      ,parent_object_id = d.database_id
      ,object_id        = d.database_id
      ,index_id         = d.database_id
      ,type             = 'DB'
      ,diagnostic       = STUFF(-- Strip off leading unnecessary characters

-- Diagnostic - DB - non-default - Database State is not not ONLINE
 IIF(d.state <> 0,NCHAR(92) + N'State: ' +d.state_desc,N'')

-- Diagnostic - DB - non-default - Database is Non-Readable Secondary
+IIF(    rs.role_desc = N'SECONDARY'
     AND ar.secondary_role_allow_connections_desc = N'NO'
    ,NCHAR(92) + N'[NON-READABLE SECONDARY]'
    ,N'')

-- Diagnostic - DB - non-default - Auto Close is ON
-- Diagnostic - DB - non-default - Auto shrink is ON
+IIF(   d.is_auto_close_on  > 0
     OR d.is_auto_shrink_on > 0
    , NCHAR(92) + N'Auto '
    + STUFF( IIF(d.is_auto_close_on  > 0,N'   CLOSE' ,N'')
           + IIF(d.is_auto_shrink_on > 0,N' & SHRINK',N'')
           ,1,3,N'')
    + N' [ON] - turn OFF!'
    ,N'')

-- Diagnostic - DB - non-default - Database in [STANDBY] mode - read-only for restore log
+IIF(d.is_in_standby > 0,NCHAR(92) + N'Database in [STANDBY] - read-only for restore log',N'')

-- Diagnostic - DB - non-default - Database NOT cleanly shut down
+IIF(    d.is_cleanly_shutdown = 0
     AND d.is_auto_close_on    = 1
    ,NCHAR(92) + N'[NOT] cleanly shut down'
    ,N'')

-- Diagnostic - DB - non-default - Database in READ ONLY mode
+IIF(d.is_read_only > 0,NCHAR(92) + N'Database in [READ ONLY] mode',N'')

-- Diagnostic - DB - non-default - Recovery model is not FULL
+IIF(d.recovery_model > 1,NCHAR(92) + N'Recovery model ' + QUOTENAME(d.recovery_model_desc),N'')

-- Diagnostic - DB - non-default - Delayed durability ENABLED, ALLOWED or FORCED
+IIF(d.delayed_durability > 0,NCHAR(92) + N'Delayed durability ' + QUOTENAME(d.delayed_durability_desc) + N', default [DISABLED]'
    ,N'')

-- Diagnostic - DB - non-default - DB Mixed page allocations are OFF
+IIF(d.is_mixed_page_allocation_on = 0,NCHAR(92) + N'DB Mixed page allocations [OFF], ON can reduce SGAM contention',N'')

-- Diagnostic - DB - non-default - Target recovery time = 0, using Automatic Checkpoints
-- Diagnostic - DB - non-default - Target recovery time <> 0 (default 60 seconds)
+IIF(COALESCE(d.target_recovery_time_in_seconds,0) = 0
    ,NCHAR(92) + N'Target recovery time [ZERO], using Automatic Checkpoints'
    ,IIF(COALESCE(d.target_recovery_time_in_seconds,0) NOT IN (0,60)
        ,NCHAR(92) + N'Target recovery time '
                   + QUOTENAME(d.target_recovery_time_in_seconds)
                   + N' seconds, affects CHECKPOINT frequency'
        ,N'')
    )

-- Diagnostic - DB - non-default - Database compatibility <> Instance Product Major Version
-- Diagnostic - DB - non-default - Database Collation <> Server Collation
+IIF(   d.compatibility_level <> 10 * partitioned_tbl.product_Major_Version 
     OR d.collation_name      <> i.collation
    , NCHAR(92) + N'DB '
    + STUFF( IIF(d.compatibility_level <> 10 * partitioned_tbl.product_Major_Version 
                 , N', compatibility: ' + QUOTENAME(d.compatibility_level) 
                 + N' <> server ' + QUOTENAME(10 * partitioned_tbl.product_Major_Version )
                 ,N'')
           + IIF(d.collation_name      <> i.collation
                 ,N', collation: ' + d.collation_name + N' <> Server: ' + i.collation
                 ,N'')
           ,1,2,N'')
    ,N'')

-- Diagnostic - DB - non-default - Database is Always On
+IIF(d.replica_id IS NOT NULL OR d.group_database_id IS NOT NULL
    , NCHAR(92) + N'Always On database -'
    + N'Replica ID '    + TRY_CAST(d.replica_id        AS NVARCHAR(36)) 
    + N', Group DB ID ' + TRY_CAST(d.group_database_id AS NVARCHAR(20)) 
    ,N'')

--------------------------------------------------------------------------------------------------------------------------------------------
-- Database Statistics settings
--------------------------------------------------------------------------------------------------------------------------------------------
+IIF(   d.is_auto_create_stats_on             = 0
     OR d.is_auto_update_stats_on             = 0
     OR d.is_auto_update_stats_async_on       = 1
     OR (    PARSENAME(TRY_CONVERT(SYSNAME,SERVERPROPERTY('ProductVersion')),4) >= 12 -- SQL 2014+
         AND (   partitioned_tbl.CNT                   > 0
              OR d.is_auto_create_stats_incremental_on = 1
             )
        )
    ,NCHAR(92) + N'Stats: '
-- Diagnostic - DB - non-default - Statistics are NOT Auto created
               + STUFF( IIF(d.is_auto_create_stats_on = 0,N', auto create [OFF]',N'')

-- Diagnostic - DB - non-default - Statistics Incremental ON (SQL 2014+)
-- Diagnostic - DB - non-default - Statistics Incremental OFF (SQL 2014+) with partitioned tables
                      + IIF(   d.is_auto_create_stats_incremental_on = 1
                            OR partitioned_tbl.CNT                   > 0
                           , N', auto create incremental '
                           + IIF(d.is_auto_create_stats_incremental_on = 1,N'[ON]',N'[OFF]')
                           + N' (' + [tempdb].[dbo].[SQLXL_3SD](partitioned_tbl.CNT,N'I') + N' partitioned tables)'
                          ,N'')

-- Diagnostic - DB - non-default - Statistics Auto update OFF
                      + IIF(d.is_auto_update_stats_on = 0
                           ,N', auto update [OFF]'
                           ,N'')

-- Diagnostic - DB - non-default - Statistics Auto update asynchronous ON
                      + IIF(d.is_auto_update_stats_async_on = 1
                          ,NCHAR(92) + N', auto update stats async [ON]'
                          ,N'')
                      ,1,2,N'')
    ,N'')

------------------------------------------------------------------------------------------------------
--
--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - DB - non-default - additional Memory optimized features (e.g. Hybrid Buffer Pool) are enabled
+IIF(d.is_memory_optimized_ENABLED > 0,NCHAR(92) + N'XTP In-Memory optimized [ENABLED]',N'')

-- Diagnostic - DB - non-default - Query parameterization FORCED
+IIF(d.is_parameterization_forced = 1,NCHAR(92) + N'Query parameterization [FORCED]',N'')

-- Diagnostic - DB - non-default - Date correlation optimization ENABLED
+IIF(d.is_date_correlation_on = 0,NCHAR(92) + N'Date correlation optimization [OFF]',N'')

-- Diagnostic - DB - non-default - Supplemental logging ENABLED
+IIF(d.is_supplemental_logging_enabled > 0,NCHAR(92) + N'Supplemental logging [ENABLED]',N'')

-- Diagnostic - DB - non-default - tempdb spills to remote store ENABLED
+IIF(d.is_tempdb_spill_to_remote_store > 0,NCHAR(92) + N'tempdb spills to [REMOTE STORE]',N'')

-- Diagnostic - DB - non-default - Result set caching - Azure Synapse Analytics Gen2 -  ENABLED
+IIF(d.is_result_set_caching_on > 0,NCHAR(92) + N'Result set caching [ON]',N'') -- Azure Synapse Analytics Gen2

-- Diagnostic - DB - non-default - Read committed snapshot isolation ENABLED
+IIF(d.is_read_committed_snapshot_on > 0,NCHAR(92) + N'Read committed snapshot [ON]',N'')

-- Diagnostic - DB - non-default - Snapshot isolation ENABLED
+IIF(d.snapshot_isolation_state > 0,NCHAR(92) + N'Snapshot isolation ' + QUOTENAME(d.snapshot_isolation_state_desc),N'')

-- Diagnostic - DB - non-default - Change Data Capture ENABLED
+IIF(d.is_cdc_enabled > 0,NCHAR(92) + N'Change Data Capture (CDC) [ENABLED]',N'')

-- Diagnostic - DB - non-default - Change Feed ENABLED
+IIF(d.is_change_feed_enabled > 0,NCHAR(92) + N'Change Feed [ENABLED]',N'')

--------------------------------------------------------------------------------------------------------------------------------------------
-- Query Store
--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - DB - Good to know - Query Store Status & Properties
+IIF(partitioned_tbl.product_Major_Version  >= 13 -- only show if SQL Server version 2016+
    ,NCHAR(92) + N'Query Store ' + QUOTENAME(qso.actual_state_desc)

-- Diagnostic - DB - non-default - Query Store Readonly - Reason
    + IIF(qso.readonly_reason > 0
         , N' Reason: '
         + CASE qso.readonly_reason
                WHEN      1 THEN N'DB READ_ONLY'
                WHEN      2 THEN N'DB SINGLE_USER'
                WHEN      4 THEN N'DB EMERGENCY'
                WHEN      8 THEN N'DB SECONDARY REPLICA'
                WHEN  65536 THEN N'QS SIZE LIMIT'
                WHEN 131072 THEN N'QS STATEMENT MEMORY LIMIT'
                WHEN 262144 THEN N'QS PERSISTENCE LIMIT'
                WHEN 524288 THEN N'DB OUT OF SPACE'
                ELSE N'*NOT FOUND*'
           END
         ,N'') -- IIF(qso.readonly_reason > 0

    + IIF(qso.actual_state > 0
         , NCHAR(92) + N'> Size - Max: ' + [tempdb].[dbo].[SQLXL_3SD](qso.max_storage_size_mb    ,N'MB')
                     + N' Used: '        + [tempdb].[dbo].[SQLXL_3SD](qso.current_storage_size_mb,N'MB')
                     + IIF(qso.max_storage_size_mb > 0
                          ,N' (' + [tempdb].[dbo].[SQLXL_3SD](1.0 * qso.current_storage_size_mb / qso.max_storage_size_mb,N'%') + N')'
                          ,N'')
                     + N' Aggregation interval: ' + [tempdb].[dbo].[SQLXL_3SD](qso.interval_length_minutes,N'I') + N' minutes'
                     + N' Flush interval: '       + [tempdb].[dbo].[SQLXL_3SD](qso.flush_interval_seconds,N'I')  + N' seconds'
                     + N' Max Plans: '            + [tempdb].[dbo].[SQLXL_3SD](qso.max_plans_per_query   ,N'I')

         -----------------------------------------------------
         + NCHAR(92) + N'> Capture mode ' + QUOTENAME(COALESCE(qso.query_capture_mode_desc,N'ALL')) -- default for 2016 is ALL
                     + N' Size cleanup '       + QUOTENAME(qso.size_based_cleanup_mode_desc)
                     + N' Stale threshold: ' + [tempdb].[dbo].[SQLXL_3SD](qso.stale_query_threshold_days,N'I') + N' days'
                     + IIF(partitioned_tbl.product_Major_Version  >= 14  -- 2017+
                          ,N' Wait stats ' + QUOTENAME(qso.wait_stats_capture_mode_desc)
                          ,N'')
                     + IIF(partitioned_tbl.product_Major_Version  >= 15  -- 2019+
                          , IIF(qso.capture_policy_execution_count >= 0,N', Exec CNT: ' + QUOTENAME(qso.capture_policy_execution_count),N'')
                          + IIF(qso.capture_policy_total_compile_cpu_time_ms   >= 0
                               ,N', Compile Time: ' + [tempdb].[dbo].[SQLXL_3SD](qso.capture_policy_total_compile_cpu_time_ms,N'ms')
                               ,N'')
                          + IIF(qso.capture_policy_total_execution_cpu_time_ms >= 0
                               ,N', Execution Time: ' + [tempdb].[dbo].[SQLXL_3SD](qso.capture_policy_total_execution_cpu_time_ms,N'ms')
                               ,N'')
                          + IIF(qso.capture_policy_stale_threshold_hours       >= 0
                               ,N', Stale: ' + TRY_CAST(qso.capture_policy_stale_threshold_hours AS NVARCHAR(20)) + N'hrs'
                               ,N'')
                          ,N'')
         ,N'') -- IIF(qso.actual_state > 0

-- Diagnostic - DB - Query Store settings and properties, actual_state_additional_info
    + IIF(qso.actual_state_additional_info > N''
         ,NCHAR(92) + N'> State Info: ' +qso.actual_state_additional_info
         ,N'')

    + IIF(partitioned_tbl.product_Major_Version  >= 14
-- Diagnostic - DB - non-default - Query Store Auto Tune states
         ,IIF(ato.name IS NOT NULL
             ,NCHAR(92) + N'Auto Tune: ' + ato.name + N' is ' + ato.actual_state_desc
                        + IIF(ato.desired_state <> ato.actual_state
                             ,N', Reason: ' + ato.reason_desc
                             ,N'') -- IIF(ato.desired_state <> ato.actual_state
             ,N'')                 -- IIF(ato.name IS NOT NULL
         ,N'')                     -- IIF(partitioned_tbl.product_Major_Version  >= 14
    ,N'')                          -- IIF(partitioned_tbl.product_Major_Version  >= 13

--------------------------------------------------------------------------------------------------------------------------------------------
-- ANSI Settings
--------------------------------------------------------------------------------------------------------------------------------------------
+IIF(   d.is_ansi_null_default_on       = 0
     OR d.is_ansi_nulls_on              = 0
     OR d.is_ansi_padding_on            = 0
     OR d.is_ansi_warnings_on           = 0
     OR d.is_cursor_close_on_commit_on  = 0
     OR d.is_arithabort_on              = 0
     OR d.is_concat_null_yields_null_on = 0
    , NCHAR(92)
    + N'ANSI DEFAULTS OFF: '
    + STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - DB - ANSI DEFAULT is ON: ansi_null_default
           + IIF(d.is_ansi_null_default_on       = 0,N', NULL DEFAULT',N'')
-- Diagnostic - DB - ANSI DEFAULT is ON: ansi_nulls
           + IIF(d.is_ansi_nulls_on              = 0,N', NULLS'  ,N'')
-- Diagnostic - DB - ANSI DEFAULT is ON: ansi_padding
           + IIF(d.is_ansi_padding_on            = 0,N', PADDING',N'')
-- Diagnostic - DB - ANSI DEFAULT is ON: ansi_warnings
           + IIF(d.is_ansi_warnings_on           = 0,N', WARNNGS',N'')
-- Diagnostic - DB - ANSI DEFAULT is ON: concat_null_yields_null
           + IIF(d.is_cursor_close_on_commit_on  = 0,N', CURSOR CLOSE ON COMMIT' ,N'')
-- Diagnostic - DB - ANSI DEFAULT is ON: cursor_close_on_commit
           + IIF(d.is_arithabort_on              = 0,N', ARITHABORT'             ,N'')
-- Diagnostic - DB - ANSI DEFAULT is ON: arithabort
           + IIF(d.is_concat_null_yields_null_on = 0,N', CONCAT NULL YIELDS NULL',N'')
           ,1,2,N'')
    ,N'')

-- Diagnostic - DB - non-default - ANSI Quoted identifier ON
+IIF(d.is_quoted_identifier_on > 0,NCHAR(92) + N'ANSI Quoted identifier [ON]',N'')

-- Diagnostic - DB - non-default - ANSI Numeric roundabort ON
+IIF(d.is_numeric_roundabort_on > 0,NCHAR(92) + N'Numeric roundabort [ON]',N'')

-- Diagnostic - DB - non-default - Recursive triggers ON
+IIF(d.is_recursive_triggers_on > 0,NCHAR(92) + N'Recursive triggers [ON]',N'')

-- Diagnostic - DB - non-default - Local cursor default ON
+IIF(d.is_local_cursor_default > 0,NCHAR(92) + N'Local cursor default [ON]',N'')

-- Diagnostic - DB - non-default - Fulltext ENABLED
+IIF(d.is_fulltext_enabled > 0,NCHAR(92) + N'Fulltext [ENABLED]',N'')

-- Diagnostic - DB - non-default - Database marked NOT Trustworthy
+IIF(d.is_trustworthy_on = 0,NCHAR(92) + N'Database marked [NOT TRUSTWORTHY]',N'')

-- Diagnostic - DB - non-default - Database chaining ON
+IIF(d.is_db_chaining_on > 0,NCHAR(92) + N'Database chaining [ON]',N'')

-- Diagnostic - DB - non-default - Encrypted
+IIF(d.is_encrypted > 0,NCHAR(92) + N'Encrypted' + IIF(d.is_master_key_encrypted_by_server > 0,N', Master key encrypted by server',N''),N'')

-- NOTE - DB - column [is_subscribed] - BOL: "This column isn't used. It will always return 0"

-- Diagnostic - DB - non-default - Publication database in  replication
+IIF(d.is_merge_published > 0,NCHAR(92) + N'Publication database in  replication',N'')

-- Diagnostic - DB - non-default - Distribution Database for replication
+IIF(d.is_distributor > 0,NCHAR(92) + N'Distribution Database for replication',N'')

-- Diagnostic - DB - non-default - Database in Sync with backup
+IIF(d.is_sync_with_backup > 0,NCHAR(92) + N'Database Replication synchronization with backup',N'')

-- Diagnostic - DB - non-default - Database is Published
+IIF(d.is_published > 0,NCHAR(92) + N'Published',N'')

-- Diagnostic - DB - non-default - Database Broker DISABLED
-- Diagnostic - DB - non-default - Honor broker priority is OFF
+IIF(   d.is_broker_enabled = 0
     OR d.is_honor_broker_priority_on = 0
    , NCHAR(92)
    + STUFF( IIF(d.is_broker_enabled = 0,N', Broker [DISABLED]',N'')
           + IIF(d.is_honor_broker_priority_on = 0,N', Honor broker priority [OFF]',N'')
           ,1,2,N'')
    ,N'')

-- Diagnostic - DB - non-default - Reuse of Log space is waiting on
+IIF(d.log_reuse_wait > 0,NCHAR(92) + N'Log reuse wait ' + QUOTENAME(d.log_reuse_wait_desc),N'')

-- Diagnostic - DB - non-default - User Access is not MULTI_USER
+IIF(d.user_access > 0,NCHAR(92) + N'User Access ' + QUOTENAME(d.user_access_desc),N'')

-- Diagnostic - DB - non-default - Accelerated database recovery ON
+IIF(d.is_accelerated_database_recovery_on > 0,NCHAR(92) + N'Accelerated database recovery [ON], default [OFF]',N'')

-- Diagnostic - DB - non-default - Federation member
+IIF(d.is_federation_member > 0,NCHAR(92) + N'Database is Federation member',N'')

-- Diagnostic - DB - non-default - Ledger Database Enabled
+IIF(d.is_ledger_on > 0,NCHAR(92) + N'Ledger Database [ENABLED]',N'')

-- Diagnostic - DB - non-default - Remote data archive ENABLED - deprecated SQL 2022+
+IIF(d.is_remote_data_archive_enabled > 0,NCHAR(92) + N'Remote data archive [ENABLED] - deprecated SQL 2022+',N'')

-- Diagnostic - DB - non-default - Temporal history retention Enabled
+IIF(d.is_temporal_history_retention_enabled > 0,NCHAR(92) + N'Temporal history retention [ENABLED]',N'')

-- Diagnostic - DB - non-default - Data retention Enabled - automatic deletion of obsolete records
+IIF(d.is_data_retention_enabled > 0,NCHAR(92) + N'Data retention [ENABLED] - automatic deletion of obsolete records',N'')

-- Diagnostic - DB - non-default - Stale page detection Enabled - Azure Synapse Analytics Gen2.
+IIF(d.is_stale_page_detection_on > 0,NCHAR(92) + N'Stale page detection [ON]',N'')

-- Diagnostic - DB - non-default - Memory optimized tables elevate to SNAPSHOT is OFF
+IIF(d.is_memory_optimized_elevate_to_snapshot_on = 0,NCHAR(92) + N'XTP Memory optimized elevate to SNAPSHOT [OFF]',N'')

-- Diagnostic - DB - non-default - Snapshot source database
+IIF(d.source_database_id > 0
    ,NCHAR(92) + N'Snapshot source DB '
               + QUOTENAME((--
                            SELECT name
                              FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] x
                             WHERE d.source_database_id = x.database_id
                           ))
    ,N'')

-- Diagnostic - DB - non-default - Physical database name <> DB name
+IIF(d.physical_database_name <> d.name
    ,NCHAR(92) + N'Physical database name ' + QUOTENAME(d.physical_database_name)
    ,N'')

-- Diagnostic - DB - non-default - Contained database status PARTIAL
+IIF(d.containment > 0
    , NCHAR(92) + N'Contained database status ' + d.containment_desc + N', default [NONE]'
-- Diagnostic - DB - non-default - Contained database default language
    + IIF(d.default_language_lcid > 0,NCHAR(92) + N'> Default language ' + QUOTENAME(d.default_language_name),N'')
-- Diagnostic - DB - non-default - Contained database fulltext language
    + IIF(d.default_fulltext_language_lcid > 0,NCHAR(92) + N'> Fulltext language ' + QUOTENAME(d.default_fulltext_language_name),N'')
-- Diagnostic - DB - non-default - Contained database 2 digit year cutoff
    + IIF(d.two_digit_year_cutoff > 0,NCHAR(92) + N'> 2 digit year cutoff ' + QUOTENAME(d.two_digit_year_cutoff),N'')
-- Diagnostic - DB - non-default - Contained DB nested triggers ON
    + IIF(d.is_nested_triggers_on > 0,NCHAR(92) + N'> Nested triggers [ON]',N'')
-- Diagnostic - DB - non-default - Contained DB transform noise words ON
    + IIF(d.is_transform_noise_words_on > 0,NCHAR(92) + N'> Transform noise words [ON]',N'')
    ,N'')

-- Diagnostic - DB - non-default - Page verify option not CHECKSUM
+IIF(d.page_verify_option <> 2,NCHAR(92) + N'Page verify option ' +d.page_verify_option_desc,N'')

-- Diagnostic - DB - non-default - Memory Optimized resource pool ID
+IIF(d.resource_pool_id > 0,NCHAR(92) + N'XTP Memory optimized resource pool ID ' + TRY_CAST(d.resource_pool_id AS NVARCHAR(100)),N'')

-- Diagnostic - DB - non-default - Catalog Collation type not DATABASE DEFAULT - Azure SQL Database
+IIF(d.catalog_collation_type > 0
    ,NCHAR(92) + N'Catalog Collation type ' + d.catalog_collation_type_desc + N', default [DATABASE_DEFAULT]'
    ,N'')

-- Diagnostic - DB - Recently created or attached (< 90 days)
+IIF(DATEDIFF(DAY,d.create_date,sp.Collection_DTTM) < 90
    ,NCHAR(92) + N'Created/Attached on ' + CONVERT(NVARCHAR(11),d.create_date,2)
               + N' - ' + TRY_CAST(DATEDIFF(DAY,d.create_date,sp.Collection_DTTM) AS NVARCHAR(20)) + N' Days'
    ,N'')

--End of STUFF from ~140 lines ago
,1,1,N'')

/*** LOCAL TESTING ***
SELECT d.name,ar.replica_id,rs.replica_id,ato.database_id,qso.database_id
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases]                           AS d
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_availability_replicas]               AS ar
    ON d.replica_id = ar.replica_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states] AS rs
    ON d.replica_id = rs.replica_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_database_automatic_tuning_options]   AS ato
    ON d.database_id = ato.database_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_database_query_store_options]        AS qso
    ON d.database_id = qso.database_id
  LEFT OUTER
  JOIN (-- count partitioned tables across databases
        SELECT database_id
              ,CNT = COUNT(1)
              ,product_major_version = MAX(product_major_version)
              ,product_minor_version = MAX(product_minor_version)
          FROM [tempdb].[dbo].SQLXL_Index_Compilation
         WHERE N'P' = rec_type
           AND 1    < partition_CNT
         GROUP BY
               database_id
       ) AS partitioned_tbl
    ON d.database_id = partitioned_tbl.database_id
 CROSS
  JOIN (-- Get instance-level collation
        SELECT collation = text_value
         FROM [tempdb].[dbo].[SQLXL_Instance_info]
        WHERE source = N'SERVERPROPERTY'
          AND name   = N'COLLATION'
      ) AS i
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS sp;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - settings non-default & good to know'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Database scoped configurations
----------------------------------------------------------------------------------------------------
-- For SQL 2016, create reference table of all DATABASE SCOPED CONFIGURATIONS and their DEFAULT VALUES to compare against actual settings
-- SQL 2017 introduced new column [is_value_default] to simplify matters going forwardS
-- SQL 2019 changed some of the names as reflected below

IF (OBJECT_ID(N'[tempdb]..#database_scoped_configurations') IS NOT NULL)
   DROP TABLE #database_scoped_configurations;

SELECT TOP (0)
       name          = TRY_CAST(NULL AS NVARCHAR(60))  COLLATE DATABASE_DEFAULT
      ,default_value = TRY_CAST(NULL AS NVARCHAR(100)) COLLATE DATABASE_DEFAULT
      ,default_label = TRY_CAST(NULL AS NVARCHAR(100)) COLLATE DATABASE_DEFAULT
  INTO #database_scoped_configurations;

INSERT
  INTO #database_scoped_configurations WITH (TABLOCKX)
      (name
      ,default_value
      ,default_label
      )
VALUES -- default values for database scoped configurations
 (N'ACCELERATED_PLAN_FORCING',N'1',N'ON')
,(N'ASYNC_STATS_UPDATE_WAIT_AT_LOW_PRIORITY',N'0',N'OFF')
,(N'BATCH_MODE_ADAPTIVE_JOINS',N'1',N'ON')                 -- 2019+
,(N'BATCH_MODE_MEMORY_GRANT_FEEDBACK',N'1',N'ON')          -- 2019+
,(N'BATCH_MODE_ON_ROWSTORE',N'1',N'ON')                    
,(N'CE_FEEDBACK',N'1',N'ON')                               
,(N'DEFERRED_COMPILATION_TV',N'1',N'ON')                   
,(N'DISABLE_BATCH_MODE_ADAPTIVE_JOINS',N'0',N'OFF')        -- 2017
,(N'DISABLE_BATCH_MODE_MEMORY_GRANT_FEEDBACK',N'0',N'OFF') -- 2017
,(N'DISABLE_INTERLEAVED_EXECUTION_TVF',N'1',N'ON')         -- 2017
,(N'DOP_FEEDBACK',N'0',N'OFF')                             
,(N'DW_COMPATIBILITY_LEVEL',N'0',N'AUTO')                  -- Azure Synapse Analytics only
,(N'ELEVATE_ONLINE',N'OFF',N'OFF')
,(N'ELEVATE_RESUMABLE',N'OFF',N'OFF')
,(N'EXEC_QUERY_STATS_FOR_SCALAR_FUNCTIONS',N'1',N'ON')
,(N'FORCE_SHOWPLAN_RUNTIME_PARAMETER_COLLECTION',N'0',N'OFF')
,(N'GLOBAL_TEMPORARY_TABLE_AUTO_DROP',N'1',N'ON')
,(N'IDENTITY_CACHE',N'1',N'ON')
,(N'INTERLEAVED_EXECUTION_TVF',N'1',N'ON')                 -- 2019+
,(N'ISOLATE_SECURITY_POLICY_CARDINALITY',N'0',N'OFF')
,(N'LAST_QUERY_PLAN_STATS',N'0',N'OFF')
,(N'LEDGER_DIGEST_STORAGE_ENDPOINT',N'OFF',N'OFF')
,(N'LEGACY_CARDINALITY_ESTIMATION',N'0',N'OFF')
,(N'LIGHTWEIGHT_QUERY_PROFILING',N'1',N'ON')
,(N'MAXDOP',N'0',N'PRIMARY')
,(N'MEMORY_GRANT_FEEDBACK_PERCENTILE_GRANT',N'1',N'ON')
,(N'MEMORY_GRANT_FEEDBACK_PERSISTENCE',N'1',N'ON')
,(N'OPTIMIZE_FOR_AD_HOC_WORKLOADS',N'0',N'OFF')
,(N'OPTIMIZED_PLAN_FORCING',N'1',N'ON')
,(N'PARAMETER_SENSITIVE_PLAN_OPTIMIZATION',N'1',N'ON')
,(N'PARAMETER_SNIFFING',N'1',N'ON')
,(N'PAUSED_RESUMABLE_INDEX_ABORT_DURATION_MINUTES',N'1440',N'1440 Minutes')
,(N'QUERY_OPTIMIZER_HOTFIXES',N'0',N'OFF')
,(N'ROW_MODE_MEMORY_GRANT_FEEDBACK',N'1',N'ON')
,(N'TSQL_SCALAR_UDF_INLINING',N'1',N'ON')
,(N'VERBOSE_TRUNCATION_WARNINGS',N'1',N'ON')
,(N'XTP_PROCEDURE_EXECUTION_STATISTICS',N'0',N'OFF')
,(N'XTP_QUERY_EXECUTION_STATISTICS',N'0',N'OFF');

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - created database scoped configuration default values'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type         = N'D'
      ,database_id      = d.database_id
      ,parent_object_id = d.database_id
      ,object_id        = d.database_id
      ,index_id         = d.database_id
      ,type             = 'DB'
      ,STUFF(IIF(sc.diagnostic IS NOT NULL,sc.diagnostic,N''),1,1,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] d
 OUTER
 APPLY (SELECT -- double SELECT to accomodate the ").value('(./text())[1]',N'NVARCHAR(4000)')" below
-- Diagnostic - DB - Configuration non-default - ACCELERATED_PLAN_FORCING is OFF
-- Diagnostic - DB - Configuration non-default - ASYNC_STATS_UPDATE_WAIT_AT_LOW_PRIORITY is ON
-- Diagnostic - DB - Configuration non-default - CE_FEEDBACK is OFF
-- Diagnostic - DB - Configuration non-default - DISABLE_BATCH_MODE_ADAPTIVE_JOINS is ON
-- Diagnostic - DB - Configuration non-default - BATCH_MODE_ADAPTIVE_JOINS is OFF
-- Diagnostic - DB - Configuration non-default - DISABLE_BATCH_MODE_MEMORY_GRANT_FEEDBACK is ON
-- Diagnostic - DB - Configuration non-default - BATCH_MODE_MEMORY_GRANT_FEEDBACK is OFF
-- Diagnostic - DB - Configuration non-default - BATCH_MODE_ON_ROWSTORE is OFF
-- Diagnostic - DB - Configuration non-default - DEFERRED_COMPILATION_TV is OFF
-- Diagnostic - DB - Configuration non-default - DOP_FEEDBACK is ON
-- Diagnostic - DB - Configuration non-default - DW_COMPATIBILITY_LEVEL is not AUTO
-- Diagnostic - DB - Configuration non-default - ELEVATE_ONLINE is not OFF
-- Diagnostic - DB - Configuration non-default - ELEVATE_RESUMABLE is not OFF
-- Diagnostic - DB - Configuration non-default - EXEC_QUERY_STATS_FOR_SCALAR_FUNCTIONS is OFF
-- Diagnostic - DB - Configuration non-default - FORCE_SHOWPLAN_RUNTIME_PARAMETER_COLLECTION is ON
-- Diagnostic - DB - Configuration non-default - GLOBAL_TEMPORARY_TABLE_AUTO_DROP is OFF
-- Diagnostic - DB - Configuration non-default - IDENTITY_CACHE is OFF
-- Diagnostic - DB - Configuration non-default - INTERLEAVED_EXECUTION_TVF is OFF
-- Diagnostic - DB - Configuration non-default - DISABLE_INTERLEAVED_EXECUTION_TVF is OFF
-- Diagnostic - DB - Configuration non-default - ISOLATE_SECURITY_POLICY_CARDINALITY is ON
-- Diagnostic - DB - Configuration non-default - LAST_QUERY_PLAN_STATS is ON
-- Diagnostic - DB - Configuration non-default - LEDGER_DIGEST_STORAGE_ENDPOINT is ON
-- Diagnostic - DB - Configuration non-default - LEGACY_CARDINALITY_ESTIMATION is not OFF
-- Diagnostic - DB - Configuration non-default - LIGHTWEIGHT_QUERY_PROFILING is OFF
-- Diagnostic - DB - Configuration non-default - MAXDOP is not 0 - does not use instance setting
-- Diagnostic - DB - Configuration non-default - MEMORY_GRANT_FEEDBACK_PERCENTILE_GRANT is OFF
-- Diagnostic - DB - Configuration non-default - MEMORY_GRANT_FEEDBACK_PERSISTENCE is OFF
-- Diagnostic - DB - Configuration non-default - OPTIMIZE_FOR_AD_HOC_WORKLOADS is ON
-- Diagnostic - DB - Configuration non-default - OPTIMIZED_PLAN_FORCING is OFF
-- Diagnostic - DB - Configuration non-default - PARAMETER_SENSITIVE_PLAN_OPTIMIZATION is OFF
-- Diagnostic - DB - Configuration non-default - PARAMETER_SNIFFING is OFF
-- Diagnostic - DB - Configuration non-default - PAUSED_RESUMABLE_INDEX_ABORT_DURATION_MINUTES is not 1 day
-- Diagnostic - DB - Configuration non-default - QUERY_OPTIMIZER_HOTFIXES is not OFF
-- Diagnostic - DB - Configuration non-default - ROW_MODE_MEMORY_GRANT_FEEDBACK is OFF
-- Diagnostic - DB - Configuration non-default - TSQL_SCALAR_UDF_INLINING is OFF
-- Diagnostic - DB - Configuration non-default - VERBOSE_TRUNCATION_WARNINGS is OFF
-- Diagnostic - DB - Configuration non-default - XTP_PROCEDURE_EXECUTION_STATISTICS is ON
-- Diagnostic - DB - Configuration non-default - XTP_QUERY_EXECUTION_STATISTICS is ON
        (--
         SELECT  NCHAR(92)
               + N'Scoped config '
               + dbsc.name
               + N' value '
               + QUOTENAME(CASE dbsc.value WHEN N'0' THEN N'OFF' WHEN N'1' THEN N'ON' ELSE dbsc.value END)
               + N' is not DEFAULT '
               + QUOTENAME(COALESCE(src.default_label,N'not found'))
           FROM [tempdb].[dbo].[SQLXL_Index_sys_database_scoped_configurations] AS dbsc
           LEFT OUTER
           JOIN #database_scoped_configurations                           AS src
             ON dbsc.name COLLATE DATABASE_DEFAULT = src.name COLLATE DATABASE_DEFAULT
          WHERE d.database_id             = dbsc.database_id
            AND (   src.default_value    <> TRY_CAST(dbsc.value AS NVARCHAR(100))
                 OR dbsc.is_value_default = 0
                )
            FOR XML PATH(N''), TYPE
        ).value('(./text())[1]',N'NVARCHAR(4000)')
       ) sc(diagnostic);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Database Diagnostics - database scoped configuration non-default values'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Cleanup temp table created for database scoped configurations
----------------------------------------------------------------------------------------------------
IF (OBJECT_ID(N'#database_scoped_configurations') IS NOT NULL) DROP TABLE #database_scoped_configurations;

/******************************************************************************************************************************************\
############################################################################################################################################
*** PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT PARENT ***
############################################################################################################################################
\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
*** Parent & Index Major Types - structure:
InMemory > Clustered > Internal Table > History Table |                   > Index
           ColStore                   > TVF           |                   > Index
                                      > View          |                   > Index
                                                       > Versioned        > Index
                                                       > (Plain rowstore) > Index

\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Parent - is History - Change Data Captured
-- Diagnostic - Parent - is History - System Versioned
-- Diagnostic - Parent - is History - System Versioned - source table
-- Diagnostic - Parent - is History - Ledger
-- Diagnostic - Parent - is DROPPED LEDGER TABLE
-- Diagnostic - Parent - is Change Data Capture
-- Diagnostic - Parent - is Change Data Capture, Net changes enabled/disabled
-- Diagnostic - Parent - is System Versioned Temporal
-- Diagnostic - Parent - is System Versioned Temporal, history table name & retention
-- Diagnostic - Parent - is Updatable Ledger
-- Diagnostic - Parent - Updatable Ledger View Name, SQL2022+ & Azure SQL Database
-- Diagnostic - Parent - is Append Only Ledger
-- Diagnostic - Parent - is Memory Optimized (BI73) (XTP)
-- Diagnostic - Parent - is Memory Optimized (BI73) (XTP) Durability description
-- Diagnostic - Parent - is Memory Optimized (BI73) (XTP) Durability NOT PERSISTED (SCHEMA_ONLY)
-- Diagnostic - Parent - is SQL Table Valued Function
-- Diagnostic - Table - is Clustered Columnstore
-- Diagnostic - Table - is Internal (System) Table
-- Diagnostic - Table - Internal (System) Table - internal type description
-- Diagnostic - Index - is HEAP
-- Diagnostic - Index - is Clustered Rowstore
-- Diagnostic - Index - Clustered Rowstore is Primary Key
-- Diagnostic - Index - Clustered Rowstore is Unique Constraint
-- Diagnostic - Index - Clustered Rowstore is Unique
-- Diagnostic - Index - is NonClustered Rowstore
-- Diagnostic - Index - NonClustered Rowstore is Primary Key
-- Diagnostic - Index - NonClustered Rowstore is Unique Constraint
-- Diagnostic - Index - NonClustered Rowstore is Unique
-- Diagnostic - Index - is XML (BI60)
-- Diagnostic - Index - XML index - index type description
-- Diagnostic - Index - XML index - PATH ID
-- Diagnostic - Index - is Spatial (BI62)
-- Diagnostic - Index - Spatial index - tesellation scheme
-- Diagnostic - Index - Spatial index - bounding box x & y min & max
-- Diagnostic - Index - Spatial index - level grid 1 - 4 description
-- Diagnostic - Index - Spatial index - cells per object
-- Diagnostic - index - is Clustered Columnstore (BI61)
-- Diagnostic - Index - is Nonclustered Columnstore (BI61)
-- Diagnostic - Index - is Nonclustered Hash on in-memory table (BI61)
-- Diagnostic - index - is Full-Text
SELECT *
  FROM (--
        SELECT i.rec_type
              ,i.database_id
              ,i.parent_object_id
              ,i.object_id
              ,i.index_id
              ,i.type
              ,diagnostic = 
STUFF(
  -- in memory objects - persist label across indexes
+ IIF(t.is_memory_optimized = 1 
     , NCHAR(92)
     + N'<MEMORY OPTIMIZED> (BI73)' + IIF(i.type = N'U'
                                          , N' Durability: ' + t.durability_desc
                                          + IIF(t.durability = 1,N' *data NOT PERSISTED*',N'')
                                          ,N'')
     ,N'')

  -- Columnstore tables - persist label across indexes
+ IIF(i.tbl_is_clustered_columnstore = 1
     , NCHAR(92)
     + N'<COLUMNSTORE TABLE> (BI61)'
     ,N'')

  -- Internal Tables - persist across indexes
+ IIF(i.obj_type = N'IT'
     , NCHAR(92)
     + N'<' + i.obj_type_desc + N'>' + IIF(i.internal_type_desc IS NOT NULL,N' ' + QUOTENAME(i.internal_type_desc),N'')
     ,N'')

  -- History tables, TVF, Views - persist label across indexes
+ CASE WHEN t.temporal_type = 1 -- HISTORY_TABLE (associated with a temporal table)
       THEN  NCHAR(92)
           + N'<SYSTEM_VERSIONED ' + t.temporal_type_desc + N'> (BI110)' 

       WHEN t.ledger_type   = 1 -- LEDGER HISTORY_TABLE (associated with an updatable ledger table)
       THEN  NCHAR(92)
           + N'<LEDGER ' + t.ledger_type_desc + N'> (BI110)'
           + IIF(i.type = N'U'
                ,NCHAR(92) + N'> Versioned: ' + COALESCE(QUOTENAME(i.history_source_schema_name)
                                                        + N'.'
                                                        + QUOTENAME(i.history_source_object_name)
                                                        ,N'<Missing Parent table>')
                ,N'')
            
       WHEN i.cdc_is_history_table = 1 -- Change Data Capture history table
       THEN  NCHAR(92)
           + N'<CDC HISTORY TABLE> (BI110)'
           + IIF(i.type = N'U' AND i.cdc_supports_net_changes = 1
                ,N' - NET CHANGES [ENABLED]'
                ,N' - NET CHANGES [DISABLED]')

       WHEN t.is_dropped_ledger_table = 1 
       THEN  NCHAR(92)
           + N'<DROPPED_LEDGER_TABLE> (BI110)' 

       WHEN i.obj_type IN (N'FT',N'IF',N'TF')
       THEN  NCHAR(92)
           + N'<' + i.obj_type_desc + N'>' 

       WHEN i.obj_type = N'V'
       THEN  NCHAR(92)
           + N'<' + i.obj_type_desc + N'>' 
           + IIF(i.type = N'V'
                , IIF(v.vw_is_dropped_ledger_view = 1,N' <DROPPED>',N'')
                + IIF(v.vw_ledger_view_type > 0,N' <' + v.vw_ledger_view_type_desc + N'>',N'')
                  COLLATE DATABASE_DEFAULT
                ,N'')

       ELSE N'' 
  END

  -- Versioned tables
+ CASE WHEN i.type = N'U' -- table level only, no need for line feed
       THEN CASE WHEN t.temporal_type = 2 
                 THEN  NCHAR(92)
                     + N'<' + t.temporal_type_desc + N'> (BI110)' -- SYSTEM_VERSIONED_TEMPORAL_TABLE
                     + NCHAR(92) 
                     + N'> Retention ' 
                     + IIF(t.history_retention_period_unit_desc = N'INFINITE'
                          ,N'INFINITE'
                          , CAST(t.history_retention_period AS NVARCHAR(20)) 
                          + t.history_retention_period_unit_desc)
                     + NCHAR(92) 
                     + N'> Versions: ' 
                     + COALESCE(QUOTENAME(i.tbl_history_table_schema) 
                               + N'.' 
                               + QUOTENAME(i.tbl_history_table_name)
                               ,N'<Missing History table>'
                               )
                 WHEN t.ledger_type   = 2 
                 THEN  NCHAR(92)
                     + N'<' + t.ledger_type_desc + N'>'         -- UPDATABLE_LEDGER_TABLE
                     + IIF(t.ledger_view_id > 0
                          , NCHAR(92) + N'> Ledger View '
                          + IIF(lv.vw_is_dropped_ledger_view = 1,N'*DROPPED* ',N'')
                          + COALESCE(QUOTENAME(lv.name),N'')
                          ,N'')
                 WHEN t.ledger_type   = 3 
                 THEN N'<' + t.ledger_type_desc   + N'>'         -- APPEND_ONLY_LEDGER_TABLE
                 ELSE N''
            END
       ELSE N''
  END

  -- Index types
+ CASE WHEN i.type = N'0'  THEN NCHAR(92) + N'<' + i.type_desc + N'>'              -- heap
       WHEN i.type = N'1'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX>'        -- clustered rowstore
       WHEN i.type = N'2'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX>'        -- nonclustered rowstore
       WHEN i.type = N'3'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX> (BI60)' -- XML
       WHEN i.type = N'4'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX> (BI62)' -- SPATIAL
       WHEN i.type = N'5'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX> (BI61)' -- clustered columnstore
       WHEN i.type = N'6'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX> (BI61)' -- nonclustered columnstore
       WHEN i.type = N'7'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX>'        -- hash
       WHEN i.type = N'90' THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX>'        -- fulltext
       WHEN i.type = N'F'  THEN NCHAR(92) + N'<' + i.type_desc + N'>'              -- foreign key constraint
       WHEN i.type = N'M'  THEN NCHAR(92) + N'<' + i.type_desc + N' INDEX>'        -- missing index
       ELSE N''
  END
+ IIF(i.sub_type_desc IS NOT NULL,N' ' + QUOTENAME(i.sub_type_desc),N'') 
+ IIF(i.xml_secondary_type_desc IS NOT NULL,N' ' + QUOTENAME(i.xml_secondary_type_desc),N'') 

  -- Uniqueness
+ CASE WHEN i.is_primary_key       = 1 THEN N' <PRIMARY KEY>'
       WHEN i.is_unique_constraint = 1 THEN N' <UNIQUE CONSTRAINT>'
       WHEN i.is_unique            = 1 THEN N' <UNIQUE>'
       ELSE N''
  END

  -- Spatial index additional information
+ CASE WHEN i.type = N'4'  
       THEN  IIF(   i.si_bounding_box_xmin IS NOT NULL
                 OR i.si_bounding_box_ymin IS NOT NULL
                 OR i.si_bounding_box_xmax IS NOT NULL
                 OR i.si_bounding_box_ymax IS NOT NULL
                ,NCHAR(92)
                + N'> '
                + STUFF( IIF(i.si_bounding_box_xmin IS NOT NULL,N', box_xmin:' + TRY_CAST(i.si_bounding_box_xmin AS NVARCHAR(20)),N'')
                       + IIF(i.si_bounding_box_ymin IS NOT NULL,N', box_ymin:' + TRY_CAST(i.si_bounding_box_ymin AS NVARCHAR(20)),N'')
                       + IIF(i.si_bounding_box_xmax IS NOT NULL,N', box_xmax:' + TRY_CAST(i.si_bounding_box_xmax AS NVARCHAR(20)),N'')
                       + IIF(i.si_bounding_box_ymax IS NOT NULL,N', box_ymax:' + TRY_CAST(i.si_bounding_box_ymax AS NVARCHAR(20)),N'')
                       ,1,2,N'')
                ,N'')
           + NCHAR(92)
           + N'> Grid1:' + COALESCE(i.si_level_1_grid_desc,N'AUTO')
           + N' Grid2:'  + COALESCE(i.si_level_2_grid_desc,N'AUTO')
           + N' Grid3:'  + COALESCE(i.si_level_3_grid_desc,N'AUTO')
           + N' Grid4:'  + COALESCE(i.si_level_4_grid_desc,N'AUTO')
           + N' Cells per object: ' + TRY_CAST(i.si_cells_per_object AS NVARCHAR(20))
       ELSE N''
  END
,1,1,N'') -- STUFF
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]  AS t
            ON i.database_ID = t.database_id
           AND i.object_ID   = t.object_id
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS v
            ON i.database_ID = v.database_id
           AND i.object_ID   = v.object_id
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS lv
            ON t.database_id    = lv.database_id
           AND t.ledger_view_id = lv.object_id
         WHERE i.rec_type NOT IN (N'A',N'D')
        ) AS i
 WHERE i.diagnostic > N'';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Add principal parent and index types'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
*** Table Diagnostics - Non-default properties
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
---------------------------------------------------------------------------------------------------
-- Diagnostic - Table - COLUMN CHANGE TRACKING ENABLED
+IIF(tbl.ctt_is_track_columns_updated_on = 1
    , NCHAR(92) 
    + N'COLUMN CHANGE TRACKING ENABLED - Auto Cleanup '
    + IIF(d.is_auto_cleanup_on = 1,N'[ON]',N'[OFF]')
    + N' Retention = ' + TRY_CAST(retention_period AS NVARCHAR(20))
    + N' ' + retention_period_units_desc
    ,N'')
-- Diagnostic - Table - EXTERNAL TABLE
+IIF(tbl.is_external                     = 1,NCHAR(92) + QUOTENAME(N'EXTERNAL TABLE'),N'')
-- Diagnostic - Table - FILETABLE
+IIF(tbl.is_filetable                    = 1,NCHAR(92) + QUOTENAME(N'FILETABLE'),N'')
-- Diagnostic - Table - GRAPH NODE
+IIF(tbl.is_node                         = 1,NCHAR(92) + QUOTENAME(N'GRAPH NODE'),N'')
-- Diagnostic - Table - GRAPH EDGE
+IIF(tbl.is_edge                         = 1,NCHAR(92) + QUOTENAME(N'GRAPH EDGE'),N'')
-- Diagnostic - Table - REMOTE DATA ARCHIVE ENABLED
+IIF(tbl.is_remote_data_archive_enabled  = 1,NCHAR(92) + QUOTENAME(N'REMOTE DATA ARCHIVE ENABLE - DEPRECATED 2022+D'),N'')
-- Diagnostic - Table - is SUBSCRIBED SYNCHRONOUS
+IIF(tbl.is_sync_tran_subscribed         = 1,NCHAR(92) + QUOTENAME(N'SUBSCRIBED SYNCHRONOUS'),N'')
---------------------------------------------------------------------------------------------------
+IIF(   tbl.is_published           > 0
     OR tbl.is_schema_published    > 0
     OR tbl.is_replicated          > 0
     OR tbl.is_merge_published     > 0
     OR tbl.has_replication_filter > 0
-- Diagnostic - Table - is PUBLISHED
    ,NCHAR(92) + QUOTENAME(N'PUBLISHED'

-- Diagnostic - Table - is SCHEMA PUBLISHED
               + STUFF( IIF(tbl.is_schema_published    > 0,N', SCHEMA'  ,N'')

-- Diagnostic - Table - is MERGE PUBLISHED
                      + IIF(tbl.is_merge_published     > 0,N', '   ,N'')
-- Diagnostic - Table - is PUBLISHED WITH FILTER
                      + IIF(tbl.has_replication_filter > 0,N', FILTERED',N'')
                      ,1,1,N''))
    ,N'')
---------------------------------------------------------------------------------------------------
-- Diagnostic - Table - Is empty
+IIF(i.tbl_is_empty = 1,NCHAR(92) + QUOTENAME(N'EMPTY'),N'')
-- Diagnostic - Table - Locked for BULK LOAD
+IIF(tbl.lock_on_bulk_load > 0,NCHAR(92) + QUOTENAME(N'Locked for BULK LOAD'),N'') -- Locked for BULK LOAD
---------------------------------------------------------------------------------------------------
,1,1,N'') -- End of STUFF from ~110 lines ago
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]  AS tbl
    ON i.database_id = tbl.database_id
   AND i.object_id   = tbl.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS olv
    ON i.database_id      = olv.database_id
   AND tbl.ledger_view_id = olv.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
    ON i.database_id    = d.database_id
) f
 WHERE f.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Non-default properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Parent - ANSI values & Unchecked assempbly
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT p.rec_type
      ,p.database_id
      ,p.parent_object_id
      ,p.object_id
      ,p.index_id
      ,p.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Table - Created without "ANSI NULLS ON"
 IIF(tbl.uses_ansi_nulls = 0
    ,NCHAR(92) + N'Created without "ANSI NULLS ON"'
    ,N'')

-- Diagnostic - Table - Assembly definition changed by ALTER ASSEMBLY
+IIF(p.tbl_has_unchecked_assembly_data > 0
    ,NCHAR(92) + N'Assembly definition changed by ALTER ASSEMBLY'
    ,N'')
----------------------------------------------------------------------------------------------------
,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS tbl
    ON p.database_ID = tbl.database_id
   AND p.object_ID   = tbl.object_id
) AS p
 WHERE p.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - ANSI values & Unchecked assempbly'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Table - Performance related
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT p.rec_type
      ,p.database_id
      ,p.parent_object_id
      ,p.object_id
      ,p.index_id
      ,p.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Table - text stored in row - limit (up to 200 bytes)
 IIF(tbl.text_in_row_limit > 0
    ,NCHAR(92) + N'text stored in row - limit ' + TRY_CAST(tbl.text_in_row_limit AS NVARCHAR(20)) + N' bytes'
    ,N'')

-- Diagnostic - Table - Large types out of row - adds 16 byte pointer
+IIF(tbl.large_value_types_out_of_row > 0,NCHAR(92) + N'Large types out of row - adds 16 byte pointer',N'')

-- Diagnostic - Table - Lock Escalation DISABLED
+IIF(p.tbl_lock_escalation = 1
    ,NCHAR(92) + N'Lock Escalation ' + QUOTENAME(tbl.lock_escalation_desc) + N' Consider Enabling Table or Auto (for partitions)'
    ,N'')

-- Diagnostic - Table - is Partitioned & partitioning column name (BI64)
+IIF(   raw.partition_CNT         > 1
     OR raw.partition_Column_Name > N''
    ,NCHAR(92) + N'Partitioned on ' + QUOTENAME(raw.partition_column_name) + N' - '
               + TRY_CAST(raw.partition_CNT AS NVARCHAR(20)) + N' partitions (BI64)'
    ,N'')

-- Diagnostic - Table - Lock Escalation TABLE with Partitions
+IIF(    p.tbl_lock_escalation = 0
     AND p.partition_Column_ID > 0
    ,NCHAR(92) + N'Lock Escalation ' + QUOTENAME(p.tbl_lock_escalation_desc) + N' Use AUTO for Partitioned tables'
    ,N'')

-- Diagnostic - Table - indexes are more than 2X the size of the physical table (index types 0,1,5)
+IIF(    raw.reserved_page_PG_CNT > 0
     AND (1.0 * (p.reserved_page_PG_CNT - raw.reserved_page_PG_CNT) / raw.reserved_page_PG_CNT) > 1.0
    ,NCHAR(92) + N'Indexes' 
               + IIF(hs.parent_object_id IS NOT NULL
                    ,N' & HST/IT'
                    ,N'')
               + N' are '
               + [tempdb].[dbo].[SQLXL_3SD](1.0 * (p.reserved_page_PG_CNT - raw.reserved_page_PG_CNT) / raw.reserved_page_PG_CNT,N'N')
               + N'X Table size'
    ,N'')
----------------------------------------------------------------------------------------------------
,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p

  LEFT OUTER
  JOIN (-- parent objects with HISTORY or INTERNAL TABLES
        SELECT database_id,parent_object_id
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type IN (N'H',N'S')
         GROUP BY
               database_ID
              ,parent_object_ID
       ) AS hs
    ON p.database_ID      = hs.database_id
   AND p.parent_object_ID = hs.parent_object_id

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS tbl
    ON p.database_ID = tbl.database_id
   AND p.object_ID   = tbl.object_id
  LEFT OUTER
  JOIN (-- get the "physical" respresentation of the underlying data
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE type  -- physical table structure
            IN (N'0' -- heap
               ,N'1' -- clustered rowstore
               ,N'5' -- clustered columnstore
               )
       ) AS raw
    ON p.database_id = raw.database_id
   AND p.object_id   = raw.object_id
) AS p
 WHERE p.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Performance related'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - Information from [msdb].[sys].[TABLES]
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT p.rec_type
      ,p.database_id
      ,p.parent_object_id
      ,p.object_id
      ,p.index_id
      ,p.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
----------------------------------------------------------------------------------------------------
-- Table outliers
----------------------------------------------------------------------------------------------------
-- Diagnostic - Table - Many Nonclustered indexes on table (BI20)
-- Diagnostic - Table - has mmany lightly used Nonclustered indexes, no existing nonclustered Columnstore
+IIF(    p.tbl_is_clustered_columnstore <> 1
     AND (   p.Nonclustered_index_CNT >= 4
          OR idx_rd.idx_cnt           > 2
         )
    , NCHAR(92)
    + N'Nonclustered indexes: '
    + TRY_CAST(p.Nonclustered_index_CNT AS NVARCHAR(20))
    + IIF(idx_rd.idx_cnt > 0
         ,N', ' + TRY_CONVERT(NVARCHAR(20),idx_rd.idx_cnt) + N' lo read (<2%)'
         ,N'')
    + IIF(    sp.version_major >= 13
          AND (--
               SELECT text_value
                 FROM [tempdb].[dbo].[SQLXL_Instance_info]
                WHERE source    = N'SERVERPROPERTY'
                  AND name      = N'Edition'
                  AND (   text_value LIKE N'ENTERPRISE%'
                       OR text_value LIKE N'DEVELOPER%'
                      )
              )  IS NOT NULL
         ,IIF(p.Nonclustered_ColumnStore_CNT = 0,N' - consider creating NCS?',N' - consider existing NCS?')
         ,N'')
    + N' (BI20)'
    ,N'') -- 2016+

----------------------------------------------------------------------------------------------------
-- Objects with Code Definitions (functions, views)
----------------------------------------------------------------------------------------------------
-- Diagnostic - Code Object - Does not use ANSI NULLS
+IIF(p.obj_uses_ansi_nulls = 0,NCHAR(92) + N'Does not use ANSI NULLS',N'')

-- Diagnostic - Code Object - Uses Quoted Identifier
+IIF(p.obj_uses_quoted_identifier = 1,NCHAR(92) + N'Uses Quoted Identifier',N'')

-- Diagnostic - Code Object - Is NOT Schema Bound
+IIF(p.obj_is_schema_bound = 0 ,NCHAR(92) + N'Is NOT Schema Bound',N'')

-- Diagnostic - Code Object - Does NOT use Database Collation
+IIF(p.obj_uses_database_collation = 0,NCHAR(92) + N'Does NOT Use Database Collation',N'')

-- Diagnostic - Code Object - Contains WITH RECOMPILE
+IIF(p.obj_is_recompiled =  1,NCHAR(92) + N'Contains WITH RECOMPILE',N'')

-- Diagnostic - Code Object - Does NOT return NULL on NULL input
+IIF(p.obj_null_on_null_input =  0 AND p.obj_type <> N'V',NCHAR(92) + N'Does NOT return NULL on NULL input',N'')

-- Diagnostic - Code Object - Executes AS OWNER
+IIF(p.obj_execute_as_principal_id = -2,NCHAR(92) + N'Executes AS OWNER',N'')

-- Diagnostic - Code Object - Executes AS PRINCIPAL ID
+IIF(p.obj_execute_as_principal_id >  0
    ,NCHAR(92) + N'Executes AS PRINCIPAL ID ' + TRY_CAST(p.obj_execute_as_principal_id AS NVARCHAR(20))
    ,N'')

-- Diagnostic - Code Object - Is natively compiled
+IIF(p.obj_uses_native_compilation =  1,NCHAR(92) + N'Is natively compiled',N'')

------------------------------------------------------------
-- Diagnostic - Table Valued Function - is INLINEABLE, inlining OFF or ON
+IIF(p.obj_is_inlineable =  1
    ,NCHAR(92) + N'Is inlineable' + IIF(p.obj_inline_type = 1,N', inlining [ON]',N', Inlining *OFF*')
    ,N'')

------------------------------------------------------------
,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS sp
  LEFT OUTER
  JOIN (
        SELECT i.database_ID
              ,i.parent_object_ID
              ,i.object_id
              ,idx_cnt = SUM(1)
          FROM (-- All "index" records
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type                       = N'I'
                   AND tbl_is_clustered_columnstore = 0
                   AND type                         = N'2'
               ) AS i
          JOIN (-- All "Parent" records
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type = N'P'
               ) AS p
            ON i.database_id      = p.database_id
           AND i.parent_object_id = p.parent_object_id
           AND i.object_ID        = p.object_ID
         WHERE IIF(p.ops_total_read_CNT > 0
                  ,100.0 * COALESCE(i.ops_total_read_CNT,0) / p.ops_total_read_CNT
                  ,0.0) < 2.0 -- 2 percent
         GROUP BY
               i.database_ID
              ,i.parent_object_ID
              ,i.object_ID
       ) AS idx_rd
    ON p.database_ID      = idx_rd.database_ID
   AND p.parent_object_ID = idx_rd.parent_object_ID
   AND p.object_ID        = idx_rd.object_ID
) AS p
 WHERE p.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Information from [msdb].[sys].[TABLES]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
--
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT p.rec_type
      ,p.database_id
      ,p.parent_object_id
      ,p.object_id
      ,p.index_id
      ,p.type
-- Diagnostic - Table - LOB data space name and description
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
                           CASE WHEN tbl.lob_data_space_id > 0
                                THEN  NCHAR(92)
                                    + N'LOB data space ' + QUOTENAME(lob_ds.data_space_name)
                                    + N' type ' + QUOTENAME(lob_ds.data_space_type_desc)
                                ELSE N''
                           END COLLATE DATABASE_DEFAULT
-- Diagnostic - Table - Filestream data space name and description
                         + CASE WHEN tbl.filestream_data_space_id > 0
                                THEN  NCHAR(92)
                                    + N'Filestream data spc ' + QUOTENAME(fs_ds.data_space_name)
                                    + N' type ' + QUOTENAME(fs_ds.data_space_type_desc)
                                ELSE N''
                           END COLLATE DATABASE_DEFAULT
                         ,1,1,N'')
  FROM (-- ALl "Parent" objects
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                               AS p
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS tbl
    ON p.database_id = tbl.database_id
   AND p.object_ID   = tbl.object_id
  LEFT OUTER HASH
  JOIN (-- Data Spaces
        SELECT database_id
              ,data_space_id
              ,data_space_name
              ,data_space_type_desc
          FROM [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
         GROUP BY
               database_id
              ,data_space_id
              ,data_space_name
              ,data_space_type_desc
       )                    AS lob_ds
    ON p.database_id         = lob_ds.database_id
   AND tbl.lob_data_space_id = lob_ds.data_space_id
  LEFT OUTER HASH
  JOIN (-- Filestream Data Spaces
        SELECT database_id
              ,data_space_id
              ,data_space_name
              ,data_space_type_desc
          FROM [tempdb].[dbo].[SQLXL_Index_sys_data_spaces]
         GROUP BY
               database_id
              ,data_space_id
              ,data_space_name
              ,data_space_type_desc
       )                           AS fs_ds
    ON p.database_id                = fs_ds.database_id
   AND tbl.filestream_data_space_id = fs_ds.data_space_id
) AS p
 WHERE p.diagnostic IS NOT NULL
OPTION (FORCE ORDER); -- Suppresses message "Warning: The join order has been enforced because a local join hint is used."

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - LOB & Filestream'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Parent - tables with big or deprecated column data types
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Table - Has large data types
SELECT rec_type         = N'P'
      ,p.database_id
      ,parent_object_id = p.object_id
      ,p.object_ID
      ,index_id   = p.object_id
      ,type       = N'U'
      ,diagnostic = N'Large datatypes: '
                  + STUFF(-- Strip off leading unnecessary characters
                           (--
                            SELECT DISTINCT
                                   N',' +user_type_name + IIF(max_length = -1,N'(MAX)',N'')
                              FROM [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
                             WHERE p.database_id      = c.database_id
                               AND p.object_id        = c.object_id
                               AND (   c.max_length = -1
                                    OR c.user_type_name IN (N'HIERARCHYID')
                                   )
                               FOR XML PATH(N''), TYPE                     -- can be more than 1 column in foreign key
                           ).value('(./text())[1]',N'NVARCHAR(4000)')
                          ,1,1,N'')
  FROM (-- tables with deprecated data types
        SELECT database_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]
         WHERE max_length = -1
            OR user_type_name IN (N'HIERARCHYID')
         GROUP BY
               database_id
              ,object_id
       ) AS p;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - tables with large data types'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Table - Has Deprecated data types
SELECT rec_type         = N'P'
      ,p.database_id
      ,parent_object_id = p.object_id
      ,p.object_ID
      ,index_id   = p.object_id
      ,type       = N'U'
      ,diagnostic = N'Deprecated datatypes: '
                  + STUFF(-- Strip off leading unnecessary characters
                          (--
                           SELECT DISTINCT
                                  N',' +user_type_name + IIF(max_length = -1,N'(MAX)',N'')
                             FROM [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
                            WHERE p.database_id     = c.database_id
                              AND p.object_id       = c.object_id
                              AND c.user_type_name IN (N'IMAGE',N'TEXT',N'NTEXT')
                              FOR XML PATH(N''), TYPE -- can be more than one datataype
                          ).value('(./text())[1]',N'NVARCHAR(4000)')
                         ,1,1,N'')
  FROM (-- tables with deprecated data types
        SELECT database_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]
         WHERE user_type_name IN (N'IMAGE',N'TEXT',N'NTEXT')
         GROUP BY
               database_id
              ,object_id
       ) AS p;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - tables with deprecated data types'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Parent - Information - Other
----------------------------------------------------------------------------------------------------
-- Diagnostic - Table - No PRIMARY KEY
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,p.database_id
      ,p.parent_object_id
      ,p.object_id
      ,index_id   = p.object_id
      ,type       = N'U'
      ,diagnostic = 'No Primary Key'
                  + IIF(i.index_id > 0
                       ,N', has ' + IIF(i.is_unique = 1,N'Unique',N'NonUnique') + N' CX'
                       ,N'')
  FROM (-- Tables without primary keys
        SELECT database_id
              ,parent_object_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type             = N'P'
           AND obj_type             = N'U'
           AND obj_type_short_label = N'TBL' -- omits History & Internal tables, Clustered columnstores cannot have PK constraints
       EXCEPT -- indexes that are primary keys
        SELECT database_id
              ,parent_object_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type       = N'I'
           AND is_primary_key = 1
       ) AS p
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
    ON N'I'               = i.rec_type
   AND p.database_id      = i.database_id
   AND p.parent_object_id = i.parent_object_id
   AND p.object_id        = i.object_ID
   AND i.type            IN (N'0' -- Rowstore HEAP
                            ,N'1' -- Rowstore Clustered
                            );    -- Clustered columnstores cannot have PK constraints

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - tables without primary keys'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Operations Writes but no/low reads - Table. See same for Index below
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Table - Operations - No reads, High % writes (BI22)
-- Diagnostic - Table - Operations - No reads, Low % writes (BI29)
-- Diagnostic - Table - Operations - High writes to Read ratio - High % writes (BI48)
-- Diagnostic - Table - Operations - High writes to Read ratio - Low % writes (BI48)
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = IIF(i.ops_total_read_CNT = 0
                       , N'OPS:  No RDS and '
                       + IIF((1.0 * i.ops_total_write_CNT / a.ops_total_write_CNT) < IIF(i.rec_type = N'I',0.000001,0.00001)
                            ,N'Lo WRT (BI29) - '
                             ,N'Hi WRT (BI22) - ')
                       + N' WRT: ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_write_CNT,N'I')
                       , N'OPS:  Lo RDS/WRT & '
                       + IIF(1.0 * i.ops_total_write_CNT / a.ops_total_write_CNT < IIF(i.rec_type = N'I',0.000001,0.00001)
                            ,N'Lo WRT (BI48)'
                            ,N'Hi WRT (BI48)')
                       + N' RDS ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_read_CNT,N'I')
                       + N' WRT ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_write_CNT,N'I')
                       + N' ('  + [tempdb].[dbo].[SQLXL_3SD](i.ops_read_to_write_RAT,N'N') + N'x)'
                       )
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 CROSS
  JOIN (-- Instance-level information
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a
 WHERE i.rec_type IN (N'P')
   AND i.ops_total_write_CNT > 0
   AND COALESCE(i.ops_total_read_CNT,0) / i.ops_total_write_CNT <= 4.0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - writes with no/low reads'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Usage Writes but no/low reads - not useful since looking at query-level use not operations
----------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------
-- Wide tables (35+ cols or > 2000 non-LOB bytes) - BI check_id 26
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,c.database_id
      ,c.object_id
      ,c.object_id
      ,c.object_id
      ,type       = N'U'
-- Diagnostic - Table - has 35 or more columns (BI26)
-- Diagnostic - Table - has a non-LOB width greater than 2000 bytes (BI26)
      ,diagnostic = N'Wide table - ' + TRY_CAST(c.column_lng AS NVARCHAR(20))
                  + N' bytes in '    + TRY_CAST(c.column_CNT AS NVARCHAR(20))
                  + N' non-LOB columns (BI26)'
  FROM (--
        SELECT c.database_id
              ,c.object_id
              ,column_CNT = SUM(IIF(c.max_length = -1,0,1))
              ,column_lng = SUM(IIF(c.max_length = -1,0,c.max_length))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_tables]  AS t
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
            ON t.database_id                     = c.database_id
           AND t.object_id                       = c.object_id
         GROUP BY
               c.database_id
              ,c.object_id
        HAVING SUM(IIF(c.max_length = -1,0,1))            >= 35
            OR SUM(IIF(c.max_length = -1,0,c.max_length)) >  2000
       ) c;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Many columns and/or wide'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - String column with non-database collation
--<BS> Add column names to diags
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,c.database_id
      ,c.object_id
      ,c.object_id
      ,c.object_id
      ,type       = N'U'
-- Diagnostic - Table - has columns with Collation not matching database collation (BI69)
      ,diagnostic = N'Column ' + QUOTENAME(c.name) + N' collation not match DB (BI69)' 
  FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]   AS c
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
    ON c.database_id = d.database_id
 WHERE c.collation_name <> d.collation_name

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - String column with non-database collation'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Table/column check constraint has non-standard property or references a procedure, function, or CLR - (BI94)
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,cx.database_id
      ,cx.parent_object_id
      ,cx.parent_object_id
      ,cx.parent_object_id
      ,type       = N'U'
-- Diagnostic - Table - has constraint(s) - see details
      ,diagnostic = IIF(cx.parent_column_id = 0,N'Table',N'Column')
                  + N' Constraint:' + NCHAR(92) + N'> ' + QUOTENAME(cx.name)
                  + IIF(cx.parent_column_id > 0,NCHAR(92) + N'> On column ' + QUOTENAME(c.name),N'')

                  + IIF(   cx.is_disabled     = 1
                        OR cx.is_not_trusted  = 1
                        OR cx.is_system_named = 1
                       , NCHAR(92) + N'>'
                       + STUFF(-- trim off unneeded leading characters
-- Diagnostic - Constraint - is DISABLED
                                IIF(cx.is_disabled     = 1,NCHAR(92) + N', Disabled',N'')
-- Diagnostic - Constraint - is NOT TRUSTED
                              + IIF(cx.is_not_trusted  = 1,NCHAR(92) + N', Not Trusted',N'')
-- Diagnostic - Constraint - is SYSTEM NAMED
                              + IIF(cx.is_system_named = 1,NCHAR(92) + N', System Named',N'')
                              ,1,1,N'')
                       ,N'')

-- Diagnostic - Constraint - table is Replicated, column has REPLICATION enabled
                  + IIF(    t.is_replicated           = 1
                        AND cx.is_not_for_replication = 0
                       ,NCHAR(92) + N'> Replicated - consider "NOT FOR REPLICATION"'
                       ,N'')

-- Diagnostic - Constraint - does not use database collation
                  + IIF(cx.uses_database_collation = 0,NCHAR(92) + N'> Does not use DATABASE COLLATION',N'')

-- Diagnostic - Constraint - uses a SQL procedure - can force serialization (BI94)
                  + IIF(cx.uses_sql_proc          = 1,NCHAR(92) + N'> references a procedure - can force serialization (BI94)' ,N'')

-- Diagnostic - Constraint - uses a SQL function - can force serialization (BI94)
                  + IIF(cx.uses_sql_ftn           = 1,NCHAR(92) + N'> references a function - can force serialization (BI94)' ,N'')

-- Diagnostic - Constraint - uses a SQL method - can force serialization (BI94)
                  + IIF(cx.uses_sql_mthd          = 1,NCHAR(92) + N'> references a SQL method - can force serialization (BI94)',N'')

/*** LOCAL TESTING ***
SELECT *
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cx
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]            AS t
    ON cx.database_id      = t.database_id
   AND cx.parent_object_id = t.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]           AS c
    ON cx.database_id      = c.database_id
   AND cx.parent_object_id = c.object_id
   AND cx.parent_column_id = c.column_id;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Check constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - Computed columns - can force serialization
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,c.database_id
      ,c.object_id
      ,c.object_id
      ,c.object_id
      ,type       = N'U'
-- Diagnostic - Table - Has Computed Column
-- Diagnostic - Table - Computed Column is non-persisted (BI100)
      ,diagnostic = IIF(c.is_persisted = 0,N'Non-persisted ',N'') + N'Computed Column '
                  + NCHAR(92) + N'> ' + QUOTENAME(c.name)

-- Diagnostic - Table - Computed Column - uses a SQL procedure - can force serialization (BI99)
                 + IIF(c.uses_sql_proc = 1,NCHAR(92) + N'> references a procedure - can force serialization (BI99)' ,N'')

-- Diagnostic - Table - Computed Column - uses a SQL function - can force serialization (BI99)
                 + IIF(c.uses_sql_ftn  = 1,NCHAR(92) + N'> references a function - can force serialization (BI99)' ,N'')

-- Diagnostic - Table - Computed Column - uses a SQL method - can force serialization (BI99)
                 + IIF(c.uses_sql_mthd = 1,NCHAR(92) + N'> references a SQL method - can force serialization (BI94)',N'')

-- Diagnostic - Table - has non-persisted Computed Columns as index key column
-- Diagnostic - Table - has non-persisted Computed Columns as index included column
                 + COALESCE( NCHAR(92)
                           + N'> In Index(s): '
                           + STUFF(-- Strip off leading unnecessary characters
                                   (-- List of indexes with included column in key or includes
                                    SELECT  N', ' + IIF(ic.type = N'90',N'FTX',TRY_CAST(index_id AS NVARCHAR(20)))
                                          + N' (' + IIF(ic.is_included_column = 0,N'Key',N'Inc')+ N')'
                                      FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
                                     WHERE c.database_id                           = ic.database_id
                                       AND c.object_id                             = ic.object_id
                                       AND c.column_id                             = ic.column_id
                                     ORDER BY
                                           ic.index_id
                                       FOR XML PATH (N''), TYPE
                                   ).value('(./text())[1]','NVARCHAR(4000)')
                                  ,1,2,N'')
                          ,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
 WHERE c.is_computed  = 1;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Computed columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - Replicated columns - (BI70)
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,c.database_id
      ,c.object_id
      ,c.object_id
      ,c.object_id
      ,type       = N'U'
-- Diagnostic - Table - has replicated columns & count (not change data capture) (BI70)
      ,diagnostic = N'Replicated columns: '
                  + IIF(c.replicated_columns <> c.all_columns
                       ,CAST(c.replicated_columns AS NVARCHAR(20)) + N' of ' + TRY_CAST(c.all_columns AS NVARCHAR(20))
                       ,N'All'
                       ) + N' (BI70)'
/*** LOCAL TESTING ***
SELECT c.*
--*/
  FROM (--
        SELECT database_id
              ,object_id
              ,replicated_columns = SUM(IIF(is_replicated = 1,1,0))
              ,all_columns        = SUM(1)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_columns]
         GROUP BY
               database_id
              ,object_id
        HAVING SUM(IIF(is_replicated = 1,1,0)) > 0
       ) AS c
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS t
    ON c.database_id                    = t.database_id
   AND c.object_id                      = t.OBJECT_ID
   AND 0                                = t.is_tracked_by_cdc;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Replicated columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - Tables with filtered statistics
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,s.database_id
      ,s.object_id
      ,s.object_id
      ,s.object_id
      ,type       = N'U'
-- Diagnostic - Table - has non-indexed statistics - may indicate more indexes needed
      ,diagnostic = N'Table has ' + TRY_CAST(SUM(IIF(s.has_filter = 1,1,0)) AS NVARCHAR(20)) + N' non-index filtered statistics'
  FROM [tempdb].[dbo].[SQLXL_Index_sys_stats]   AS s
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes] AS i
    ON s.database_id                  = i.database_id
   AND s.object_id                    = i.object_id
   AND s.stats_id                     = i.index_id
 WHERE i.index_id IS NULL
 GROUP BY
       s.database_id
      ,s.OBJECT_ID
HAVING SUM(IIF(s.has_filter = 1,1,0)) > 0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - filtered statistics'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - CDC - History File group
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,p.database_id
      ,p.parent_object_id
      ,p.parent_object_id
      ,p.parent_object_id
      ,type       = N'U'
-- Diagnostic - Table - Change data capture filegroup name
      ,diagnostic = NCHAR(92)
                  + IIF(p.cdc_filegroup_name IS NOT NULL
                       ,N'Filegroup Name ' + QUOTENAME(p.cdc_filegroup_name)
                       ,N'Uses default Filegroup')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                        AS p
 WHERE p.cdc_is_history_table = 1;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - History File group'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Parent - DML Triggers - enabled, non-MS
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT p.rec_type
      ,p.database_id
      ,p.object_id
      ,p.object_id
      ,p.object_id
      ,p.type
      ,diagnostic = N'DML Triggers'
-- Diagnostic - Table - has CLR trigger(s)
                  + N' CLR: ' + IIF(p.CLR_trigger_CNT > 0,TRY_CAST(p.CLR_trigger_CNT AS NVARCHAR(20)),N'0')
-- Diagnostic - Table - has SQL trigger(s)
                  + N' SQL: ' + IIF(p.SQL_trigger_CNT > 0,TRY_CAST(p.SQL_trigger_CNT AS NVARCHAR(20)),N'0')
-- Diagnostic - Table - has INSTEAD OF trigger(s)
                  + N' Instead Of: ' + IIF(p.is_instead_of_trigger_CNT > 0
                                          ,TRY_CAST(p.is_instead_of_trigger_CNT AS NVARCHAR(20))
                                          ,N'0')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS p
 WHERE rec_type = N'P'
   AND type     = N'U'
   AND (   p.CLR_trigger_CNT           > 0
        OR p.SQL_trigger_CNT           > 0
        OR p.is_instead_of_trigger_CNT > 0
       );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - DML Triggers'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Table - Identity and Sequence value usage
-- Diagnostic - Table - Identity and Sequence values - flag if nearing their limits at 50% (BI68)
-- Diagnostic - Table - Sequence Columns - not using 1 as increment (BI74)
-- Diagnostic - Table - Sequence Columns - with negative or zero start value (BI74)
-- Diagnostic - Table - Identity Columns not using 1 as increment (BI74)
-- Diagnostic - Table - Identity Columns with negative or zero seed (BI74)
-- Diagnostic - Table - column with NEWID or NEWSEQUENTIALID
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH cte AS (--
SELECT data_type = N'tinyint'
      ,min_value = TRY_CAST(0 AS BIGINT)
      ,max_value = TRY_CAST(255 AS BIGINT)
      ,max_fmt   = [tempdb].[dbo].[SQLXL_3SD](255,N'I')

UNION ALL
SELECT data_type = N'smallint'
      ,min_value = -32768
      ,max_value =  32767
      ,max_fmt   = [tempdb].[dbo].[SQLXL_3SD](32767,N'I')

UNION ALL
SELECT data_type = N'int'
      ,min_value = -2147483648
      ,max_value =  2147483647
      ,max_fmt   = [tempdb].[dbo].[SQLXL_3SD](2147483647,N'I')

UNION ALL
SELECT data_type = N'bigint'
      ,min_value = -9223372036854775808
      ,max_value =  9223372036854775807
      ,max_fmt   = N'9.22E'
)
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'P'
      ,c.database_id
      ,c.object_id
      ,c.object_id
      ,c.object_id
      ,type       = N'U'
      ,diagnostic =
  IIF(100.0 * COALESCE(TRY_CAST(c.Last_Value AS BIGINT),CAST(c.seq_current_value AS BIGINT),0) / cte.max_value > 50.0
     ,N'*NOTE* (BI68) ' -- no check for zero, always > 0 from cte
     ,N'')
+ CASE WHEN c.increment_value IS NOT NULL THEN N'Identity'
       WHEN c.seq_increment   IS NOT NULL THEN N'Sequence'
       WHEN sc.default_constraint = N'(newsequentialid())' THEN N'Sequence GUID'
       WHEN sc.default_constraint = N'(newid())'           THEN N'NewID'
  END
+ N' column ' + QUOTENAME(c.name)
+ IIF(c.increment_value IS NOT NULL OR c.seq_increment IS NOT NULL
     , IIF(LEN(c.name) > 57,NCHAR(92) + N'> ',N' ')
     + N'at ' + CONVERT(NVARCHAR(6),CAST(100.0 * TRY_CAST(COALESCE(c.Last_Value,c.seq_current_value,0) AS BIGINT)
                                   / cte.max_value AS MONEY)) -- no check for zero, always > 0 from cte
      + N'% Used: ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(TRY_CAST(c.Last_Value AS BIGINT)
                                                       ,CAST(c.seq_current_value AS BIGINT)
                                                       ,0
                                                       ),N'I')
                   + N'/' + cte.max_fmt
      + IIF(   c.increment_value <> 1
            OR c.seed_value      <  1
            OR c.seq_increment   <> 1
            OR c.seq_start_value <  1
           , IIF(c.increment_value <> 1,N' Increment ' + TRY_CAST(c.increment_value AS NVARCHAR(20)),N'')
           + IIF(c.seed_value      <  1,N' Seed '      + TRY_CAST(c.seed_value      AS NVARCHAR(20)),N'')
           + IIF(c.seq_increment   <> 1,N' Increment ' + TRY_CAST(c.seq_increment   AS NVARCHAR(20)),N'')
           + IIF(c.seq_start_value <  1,N' Seed '      + TRY_CAST(c.seq_start_value AS NVARCHAR(20)),N'')
           + N' (BI74)'
           ,N''
           )
     ,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
  JOIN [tempdb].[dbo].[SQLXL_Index_column]      AS sc
    ON c.database_id  = sc.database_id
   AND c.object_id    = sc.object_id
   AND c.column_id    = sc.Column_ID
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_types]   AS t
    ON c.database_id  = t.database_id
   AND c.user_type_id = t.user_type_id
  JOIN cte
    ON t.name         = cte.data_type
 WHERE c.increment_value IS NOT NULL
    OR c.seq_increment   IS NOT NULL
    OR sc.default_constraint = N'(newsequentialid())'
    OR sc.default_constraint = N'(newid())';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Table Diagnostics - Identities/Sequence'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
############################################################################################################################################
*** INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX INDEX ***
############################################################################################################################################
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
----------------------------------------------------------------------------------------------------
-- Index All Types
----------------------------------------------------------------------------------------------------
-- HEAPS flagged later on
+IIF(   i.is_disabled                = 1
     OR i.is_not_trusted             = 1
     OR i.is_ignored_in_optimization = 1
    ,NCHAR(92)
-- Diagnostic - Index - is DISABLED (BI42)
   + LTRIM( IIF(i.is_disabled = 1,N' *Disabled* (BI42)',N'')

-- Diagnostic - Index - is NOT TRUSTED
          + IIF(i.is_not_trusted = 1,N' *Not trusted*',N'')

-- Diagnostic - Index - is IGNORED IN OPTIMIZATION
          + IIF(i.is_ignored_in_optimization = 1,N' *Ignored in optimization*',N'')
          )
    ,N'')

-- Diagnostic - Index - Duplicate keys ignored
+IIF(i.ignore_dup_key = 1
    ,NCHAR(92) + N'Duplicate keys ignored, inserted rows can be discarded'
    ,N'')

-- Diagnostic - Index - Duplicate key warning suppressed on index Refresh
+IIF(i.suppress_dup_key_messages = 1
    ,NCHAR(92) + N'Duplicate key messages are suppressed on index Rebuild'
    ,N'')

-- Diagnostic - Index - is Hypothetical (BI41)
+IIF(i.is_hypothetical = 1
    ,NCHAR(92) + N'Hypothetical, can''t be used, holds stats (BI41)'
    ,N'')
------------------------------------------------------------
,1,1,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
) AS i
 WHERE i.diagnostic > N'';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Special types'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Operations Writes but no/low reads - Index
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Index - Operations - No reads, High % writes (BI22)
-- Diagnostic - Index - Operations - No reads, Low % writes (BI29)
-- Diagnostic - Index - Operations - High Writes to Read ratio - High % writes (BI48)
-- Diagnostic - Index - Operations - High Writes to Read ratio - Low % writes (BI48)
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = IIF(i.ops_total_read_CNT = 0
                       , N'OPS:  No RDS and '
                       + IIF((1.0 * i.ops_total_write_CNT / a.ops_total_write_CNT) < IIF(i.rec_type = N'I',0.000001,0.00001)
                            ,N'Lo WRT (BI29) - '
                            ,N'Hi WRT (BI22) - ')
                       + N' WRT: ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_write_CNT,N'I')
                       , N'Operations:  Lo RDS/WRT & '
                       + IIF((1.0 * i.ops_total_write_CNT / a.ops_total_write_CNT) < IIF(i.rec_type = N'I',0.000001,0.00001)
                            ,N'Lo WRT (BI48)'
                            ,N'Hi WRT (BI48)')
                       + N' RDS '  + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_read_CNT,N'I')
                       + N' WRT ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_write_CNT,N'I')
                       + N' (' + [tempdb].[dbo].[SQLXL_3SD](i.ops_read_to_write_RAT,N'N') + N'x)'
                       )
  FROM (SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
         WHERE i.rec_type           IN (N'I')
           AND i.ops_total_write_CNT > 0
           AND (COALESCE(i.ops_total_read_CNT,0) / i.ops_total_write_CNT) <= 4.0
       ) AS i
 CROSS
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Operations Reads to Writes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index -
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Index - row locks not allowed
-- Diagnostic - Index - page locks not allowed
 CASE WHEN (   (    i.allow_row_locks = 0 -- locks not allowed. value for non-indexes is NULL
                AND i.type       NOT IN (N'5',N'6') -- row locks not supported on columnstore indexes
               )
            OR i.allow_page_locks    = 0 -- locks not allowed. value for non-indexes is NULL
           )
       AND i.tbl_is_memory_optimized = 0 -- memory optimized uses Row Versions
       AND i.type                   <> N'5'      -- clustered columnstore
       AND i.obj_type_short_label  NOT IN (N'HST' -- Not a history table
                                          ,N'IT') -- Not an internal table
      THEN  NCHAR(92) + N'Locks not allowed - '
          + STUFF( IIF(i.allow_page_locks = 0,N', Page',N'')
                 + IIF(    i.allow_row_locks = 0 -- locks not allowed. value for non-indexes is NULL
                       AND i.type       NOT IN (N'5',N'6') -- row locks not supported on columnstore indexes
                      ,N', Row' ,N'')
                 ,1,1,N'')
      ELSE N''
 END

-- Diagnostic - Index - Columnstore compression delay > 0
     + IIF(i.compression_delay_mm > 0
          ,NCHAR(92) + N'Columnstore compression delay '
                     + TRY_CAST(i.compression_delay_mm AS NVARCHAR(20)) + N' minutes'
          ,N'')

-- Diagnostic - Index - Created by Auto Tuning
     + IIF(i.auto_created = 1,N'Index created by auto tuning',N'')

-- Diagnostic - Index - partition not match table partition (BI65)
-- Diagnostic - Index - table partitioned, index isn't
+IIF(COALESCE(i.partition_function_name,N'NONE') <> COALESCE(p.partition_function_name,N'NONE')
    ,IIF(i.partition_function_name IS NULL
        , NCHAR(92) + N'Index not partitioned, table is - '
                    + QUOTENAME(COALESCE(p.partition_function_name,N'NOT PARTITIONED'))
                    + N' (BI65)'
        , NCHAR(92) + N'Index Partition function does not match Table (BI65)'
        + NCHAR(92) + N'> IDX ' + QUOTENAME(COALESCE(i.partition_function_name,N'NOT PARTITIONED'))
                    + N' TBL '  + QUOTENAME(COALESCE(p.partition_function_name,N'NOT PARTITIONED'))
        )
    ,N'')

------------------------------------------------------------
,1,1,N'')
  FROM (--  All non-internal "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND TRY_CAST(type AS INT) > 0
           AND obj_type_short_label <> N'IT' -- Internal Table
       ) AS i
  JOIN (-- all parent records
        SELECT *
         FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
        WHERE rec_type = N'P'
       ) AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
) AS i
 WHERE i.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Constraints on index NOT ENFORCED
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type = N'I'
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = N'Constraint ' + QUOTENAME(kc.name) + N' NOT ENFORCED'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_key_constraints] AS kc
    ON i.database_id               = kc.database_id
   AND i.parent_object_id          = kc.parent_object_id
   AND i.object_id                 = kc.object_id
   AND TRY_CAST(i.index_id AS INT) = kc.unique_index_id
   AND 0                           = kc.is_enforced;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Constraints NOT ENFORCED'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- NOTE: Filtered indexes - included in Information 8 below
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
/*** LOCAL TESTING ***
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
--*/

-- Diagnostic - Index - fill factor - for all non-100% factors (BI40)
+IIF(   i.fill_factor         NOT IN (0,100)
     OR i.page_splits_to_write_PCT > 1.0
     OR i.page_merge_to_write_PCT  > 1.0
    ,NCHAR(92) + N'Fill ' + [tempdb].[dbo].[SQLXL_3SD](i.fill_factor,N'I') + N'%'
               + IIF(i.fill_factor NOT IN (0,100),N' (BI40)',N''),N'')

-- Diagnostic - Index - Padding - Fill_Factor < 100% and PADDING not enabled
    + IIF(i.fill_factor < 100 AND i.is_padded = 0
         ,N', Pad DISBLD'
         ,N'') -- Fill factor < 100, PADDING not enabled

-- Diagnostic - Index - Page Splits
    + IIF(i.ops_total_page_split_CNT > 0.0
         , N' Splits ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_page_split_CNT,N'I')
         + N' (' + [tempdb].[dbo].[SQLXL_3SD](i.page_splits_to_write_PCT,N'N') + N'% INS+UPD)'
         , N'')

-- Diagnostic - Index - Page merges
    + IIF(i.ops_total_page_merge_CNT > 0.0
         , N' Merges ' + [tempdb].[dbo].[SQLXL_3SD](i.ops_total_page_merge_CNT,N'I')
         + N' (' + [tempdb].[dbo].[SQLXL_3SD](i.page_merge_to_write_PCT,N'N') + N'% UPD+DEL)'
         , N'')
----------------------------------------
,1,1,N'')
  FROM (-- all index records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
) AS i
 WHERE i.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Fill Factor, Splits, Merges'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Index column (key & include) constraints
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,ic.database_id
      ,ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
      ,diagnostic = N'Constraint on column'
                  + NCHAR(92) + N'> ' + QUOTENAME(c.name)

                  + IIF(   cx.is_disabled     = 1
                        OR cx.is_not_trusted  = 1
                        OR cx.is_system_named = 1
                       , NCHAR(92) + N'>'
                       + STUFF(-- trim off unneeded leading characters
-- Diagnostic - Index - Column Constraint - is DISABLED
                                IIF(cx.is_disabled     = 1,NCHAR(92) + N', Disabled',N'')
-- Diagnostic - Index - Column Constraint - is NOT TRUSTED
                              + IIF(cx.is_not_trusted  = 1,NCHAR(92) + N', Not Trusted',N'')
-- Diagnostic - Index - Column Constraint - is SYSTEM NAMED
                              + IIF(cx.is_system_named = 1,NCHAR(92) + N', System Named',N'')
                              ,1,1,N'')
                       ,N'')

-- Diagnostic - Index - table is Replicated, column has REPLICATION enabled
                  + IIF(    t.is_replicated           = 1
                        AND cx.is_not_for_replication = 0
                       ,NCHAR(92) + N'> Replicated - consider "NOT FOR REPLICATION"'
                       ,N'')

-- Diagnostic - Index - column constraint uses non-database collation
                  + IIF(cx.uses_database_collation = 0,NCHAR(92) + N'> uses non-Database Collation',N'')

-- Diagnostic - Index - column constraint references a procedure - can force serialization (BI94)
                  + IIF(cx.uses_sql_proc           = 1,NCHAR(92) + N'> references a procedure - can force serialization (BI94)' ,N'')

-- Diagnostic - Index - column constraint references a function - can force serialization (BI94)
                  + IIF(cx.uses_sql_ftn            = 1,NCHAR(92) + N'> references a function - can force serialization (BI94)'  ,N'')

-- Diagnostic - Index - column constraint references a SQL method - can force serialization (BI94)
                  + IIF(cx.uses_sql_mthd           = 1,NCHAR(92) + N'> references a SQL method - can force serialization (BI94)',N'')

  FROM [tempdb].[dbo].[SQLXL_Index_sys_check_constraints] AS cx
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables]            AS t
    ON cx.database_id      = t.database_id
   AND cx.parent_object_id = t.object_id
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns]     AS ic
    ON cx.database_id      = ic.database_id
   AND cx.parent_object_id = ic.object_id
   AND cx.parent_column_id = ic.column_id
  JOIN [tempdb].[dbo].[SQLXL_Index_column]                AS c
    ON cx.database_id      = c.database_id
   AND cx.parent_object_id = c.object_id
   AND cx.parent_column_id = c.column_id;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Constraints'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Diagnostic - Index - computed column references a procedure - can force serialization (BI99)
-- Diagnostic - Index - computed column references a function - can force serialization (BI99)
-- Diagnostic - Index - computed column references a SQL method - can force serialization (BI99)
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,ic.database_id
      ,ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
      ,diagnostic = N'Computed Column '
                  + NCHAR(92) + N'> ' + QUOTENAME(c.name)
                  + IIF(c.uses_sql_proc = 1,NCHAR(92) + N'> references a procedure - can force serialization (BI99)' ,N'')
                  + IIF(c.uses_sql_ftn  = 1,NCHAR(92) + N'> references a function - can force serialization (BI99)' ,N'')
                  + IIF(c.uses_sql_mthd = 1,NCHAR(92) + N'> references a SQL method - can force serialization (BI99)',N'')
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]     AS ic
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]           AS c
    ON ic.database_id                              = c.database_id
   AND ic.object_id                                = c.object_id
   AND ic.column_id                                = c.column_id
 WHERE c.uses_sql_proc    = 1
    OR c.uses_sql_ftn     = 1
    OR c.uses_sql_mthd    = 1;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Computed columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

------------------------------------------------------------------------------------------
-- DATES - last Read, last IUD (INSERT UPDATE DELETE), object change
------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic =
-- Diagnostic - Table - Days since Last Read
-- Diagnostic - Table - Days since Last Write
-- Diagnostic - Table - Not used since last usage data reset
-- Diagnostic - FKC - no usage history for Foreign Key Constraints
-- Diagnostic - TVF - no usage history for table valued functions
-- Diagnostic - View - no usage history for views
+ CASE WHEN i.ius_last_read_days_ago  IS NULL
        AND i.ius_last_write_days_ago IS NULL
       THEN  N'Usage dates N/A'
           + CASE WHEN i.tbl_is_memory_optimized = 1  THEN N' - In Memory'      ELSE N'' END
           + CASE WHEN i.type = N'S'                  THEN N' - Internal Table' ELSE N'' END
           + CASE WHEN i.type NOT IN (N'0',N'1',N'2',N'U') THEN N' ' + i.type_desc ELSE N'' END
-- Diagnostic - Index - Usage Last Read Days Ago
       ELSE  N'Last Usage Read: '
           + CASE WHEN i.ius_last_read_days_ago BETWEEN 0 AND 999998
                  THEN TRY_CONVERT(NVARCHAR(20),i.ius_last_read_days_ago) + N' days ago'
                  ELSE N'NONE'
             END
-- Diagnostic - Index - Usage Last Write days Ago
           + N' Write: '
           + CASE WHEN i.ius_last_write_days_ago BETWEEN 0 AND 999998
                  THEN TRY_CONVERT(NVARCHAR(20),i.ius_last_write_days_ago) + N' days ago'
                  ELSE N'NONE'
             END
-- Diagnostic - Object - Changed within last 90 days
           + CASE WHEN i.rec_type NOT IN (N'A',N'D',N'I')
                   AND DATEDIFF(DAY,o.modify_date,sp.collection_DTTM) <= 90
                  THEN  N' Modified ' + CONVERT(NVARCHAR(11),o.modify_date,2) + N' (BI67)'
                  ELSE N''
             END
-- Diagnostic - Object - Creation Date
           + CASE WHEN i.rec_type NOT IN (N'A',N'D',N'I')
                   AND DATEDIFF(DAY,o.create_date,o.modify_date) > 0
                  THEN N' Created ' + CONVERT(NVARCHAR(11),o.create_date,2) + N' (BI66)'
                  ELSE N''
             END
  END

-- Diagnostic - Index - High ratio of page locks to row locks
+IIF(    i.page_lock_to_row_lock_RAT < 1.0 
     AND i.type NOT IN (N'5'  -- clustered columnstore
                       ,N'6') -- nonclustered columnstore
    ,NCHAR(92) + N'High ratio PAGE to ROW locks - '
               + [tempdb].[dbo].[SQLXL_3SD](100.0 * i.page_lock_to_row_lock_RAT,N'N') + N'x'
    ,N'')
/*** LOCAL TESTING ***
SELECT COUNT(1)
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 CROSS JOIN
       [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS sp
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
    ON i.database_id                     = o.database_id
   AND i.OBJECT_ID                       = o.OBJECT_ID
 WHERE i.rec_type NOT IN (N'A',N'D')
   AND i.type     NOT IN (N'F',N'V')
) AS i
 WHERE i.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Last used, lock ratio'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index - Columnstores needing possible REFRESH
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,i.database_id
      ,parent_object_id = i.object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic =
-- Diagnostic - Index - Columnstore has more than 1 partition
-- Diagnostic - Index - Columnstore has OPEN rowgroups
-- Diagnostic - Index - Columnstore has RESIDUAL_ROW_GROUP
-- Diagnostic - Index - Columnstore has DICTIONARY_SIZE constrained rowgroups
-- Diagnostic - Index - Columnstore has deleted rows
-- Diagnostic - Index - Review need to REORGANIZE/REBUILD
        N'Index has'
      + N' '    + [tempdb].[dbo].[SQLXL_3SD](c.partition_CNT,N'I') + N' Partition(s)'
      + N' in ' + [tempdb].[dbo].[SQLXL_3SD](c.rowgroup_CNT,N'I') + N' Rowgroup(s)'
      + IIF(c.open_rows_CNT > 0
           ,NCHAR(92) + N'> '
           + IIF(c.open_rowgroup_CNT > 0
                , [tempdb].[dbo].[SQLXL_3SD](1.0 * c.open_rows_CNT / c.open_rowgroup_CNT,N'I')
                + N' Average rows in '
                + [tempdb].[dbo].[SQLXL_3SD](c.open_rowgroup_CNT,N'I') + N' Open Rowgroup(s)'
                ,[tempdb].[dbo].[SQLXL_3SD](c.open_rows_CNT,N'I') + N' Open rows')
           ,N'')
      -------------------------------------------------------------------------------------------
      + IIF(c.deleted_rows_CNT > 0
           ,NCHAR(92) + N'> '
           + IIF(c.deleted_rowgroup_CNT > 0
                , [tempdb].[dbo].[SQLXL_3SD](1.0 * c.deleted_rows_CNT / c.deleted_rowgroup_CNT,N'I')
                + N' Average rows in '
                + [tempdb].[dbo].[SQLXL_3SD](c.deleted_rowgroup_CNT,N'I') + N' Deleted Rowgroup(s)'
                ,[tempdb].[dbo].[SQLXL_3SD](c.deleted_rows_CNT,N'I') + N' Deleted rows')
           ,N'')
      -------------------------------------------------------------------------------------------
      + IIF(c.compressed_residual_rows_CNT > 0
           ,NCHAR(92) + N'> '
           + IIF(c.compressed_residual_CNT > 0
                , [tempdb].[dbo].[SQLXL_3SD](1.0 * c.compressed_residual_rows_CNT / c.compressed_residual_CNT,N'I')
                + N' Average rows in '
                + [tempdb].[dbo].[SQLXL_3SD](c.compressed_residual_CNT,N'I') + N' Residual Rowgroup(s)'
                ,[tempdb].[dbo].[SQLXL_3SD](c.compressed_residual_rows_CNT,N'I') + N' Deleted rows')
           ,N'')
      -------------------------------------------------------------------------------------------
      + IIF(c.compressed_dictionary_rows_CNT > 0
           ,NCHAR(92) + N'> '
           + IIF(c.compressed_dictionary_CNT > 0
                , [tempdb].[dbo].[SQLXL_3SD](1.0 * c.compressed_dictionary_rows_CNT / c.compressed_dictionary_CNT,N'I')
                + N' Average rows in '
                + [tempdb].[dbo].[SQLXL_3SD](c.compressed_dictionary_CNT,N'I') + N' Compressed Dictionary Rowgroup(s)'
                ,[tempdb].[dbo].[SQLXL_3SD](c.compressed_dictionary_rows_CNT,N'I') + N' Compressed Dictionary rows')
           ,N'')
      -------------------------------------------------------------------------------------------
      + IIF(c.open_rows_CNT + c.deleted_rows_CNT > 0
           ,NCHAR(92) + N'> REORGANIZE' + IIF(mv.product_major_version >= 15,N'/REBUILD (2019+ Online)',N'') + N'?'
           ,N'')
  FROM (--
        SELECT database_id
              ,object_id
              ,index_id
              ,rowgroup_CNT                   = COUNT(1)
              ,partition_CNT                  = COUNT(DISTINCT(partition_number))
              ,open_rowgroup_CNT              = SUM(IIF(state_desc = N'OPEN',1,0))
              ,open_rows_CNT                  = SUM(IIF(state_desc = N'OPEN',total_rows,0))
              ,deleted_rowgroup_CNT           = SUM(IIF(deleted_rows > 0,1,0))
              ,deleted_rows_CNT               = SUM(IIF(deleted_rows > 0,deleted_rows,0))
              ,compressed_residual_CNT        = SUM(IIF(    state_desc       = N'COMPRESSED'
                                                        AND trim_reason_desc = N'RESIDUAL_ROW_GROUP'
                                                       ,1,0))
              ,compressed_residual_rows_CNT   = SUM(IIF(    state_desc       = N'COMPRESSED'
                                                        AND trim_reason_desc = N'RESIDUAL_ROW_GROUP'
                                                       ,total_rows,0))
              ,compressed_dictionary_CNT      = SUM(IIF(    state_desc       = N'COMPRESSED'
                                                        AND trim_reason_desc = N'DICTIONARY_SIZE'
                                                       ,1,0))
              ,compressed_dictionary_rows_CNT = SUM(IIF(    state_desc       = N'COMPRESSED'
                                                        AND trim_reason_desc = N'DICTIONARY_SIZE'
                                                       ,total_rows,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]
         GROUP BY
               database_id
              ,object_id
              ,index_id
       ) c
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes] AS i
    ON c.database_id = i.database_id
   AND c.object_id   = i.object_id
   AND c.index_id    = i.index_id
   AND i.type       IN (N'5' -- clustered columnstore
                       ,N'6' -- nonclustered columnstore
                       )
 CROSS
  JOIN (-- Get SQL ProductMajorVersion
        SELECT product_Major_Version = TRY_CAST(run_value AS INT)
          FROM [tempdb].[dbo].[SQLXL_Instance_info]
         WHERE source = N'SERVERPROPERTY'
           AND name   = N'ProductMajorVersion'
      ) AS mv

 WHERE c.open_rowgroup_CNT              > 0
    OR c.open_rows_CNT                  > 0
    OR c.deleted_rowgroup_CNT           > 0
    OR c.deleted_rows_CNT               > 0
    OR c.compressed_residual_CNT        > 0
    OR c.compressed_residual_rows_CNT   > 0
    OR c.compressed_dictionary_CNT      > 0
    OR c.compressed_dictionary_rows_CNT > 0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Columnstore reorg'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END
----------------------------------------------------------------------------------------------------
-- Index Performance - Additional key DENSITY VECTOR
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
-- Diagnostic - Index - adding another key element doesn't make index much more selective
      ,diagnostic  = low_selectivity_additional_keys
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE low_selectivity_additional_keys IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - key density vector'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index Performance - Stats Properties
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic  = 
-- Diagnostic - Index Stats - No statistics found on index / index type
-- Diagnostic - Index Stats - No Statistics - is InMemory table
  N'Stats: '
+ IIF(i.stathdr_Updated IS NULL
     , N'None found'
     + IIF(tbl_is_memory_optimized = 1,N' - In Memory (BI73)',N'')
     + N' - Type ' 
     + QUOTENAME(i.type_desc + CASE i.type_desc
                                    WHEN N'0' THEN N' ROWSTORE'
                                    WHEN N'1' THEN N' ROWSTORE'
                                    WHEN N'2' THEN N' ROWSTORE'
                                    ELSE N''
                               END)
     + CASE i.type
            WHEN N'3'  THEN N' (BI60)' -- XML
            WHEN N'4'  THEN N' (BI62)' -- Spatial
            WHEN N'5'  THEN N' (BI61)' -- Clustered columnstore
            WHEN N'6'  THEN N' (BI61)' -- NonClustered columnstore
            WHEN N'7'  THEN N''        -- Hash
            WHEN N'90' THEN N' (BI61)' -- FullText
            ELSE N''
       END
-- Diagnostic - Index Stats - Percent of table sampled
     ,COALESCE( [tempdb].[dbo].[SQLXL_3SD](i.stathdr_Statistics_age_days,N'I') + N' days old (BI90)'
              + IIF(i.stathdr_Rows_CNT > 0
                   ,N' on ' + [tempdb].[dbo].[SQLXL_3SD](1.0 * i.stathdr_Rows_sampled_CNT / i.stathdr_Rows_CNT,N'%')
                   ,N'NO '
                   )
              + N' rows (BI91)'
              ,N'')
-- Diagnostic - Index Stats - Default statistics sampling rate
-- Diagnostic - Index Stats - Persisted statistics sampling rate >= 2016 SP1 CU4 and SQL Server 2017 CU1
     + N', Persisted sample ' 
     + IIF(i.stats_has_persisted_sample = 0
          ,N'DEFAULT' + IIF(   i.product_major_version    >= 14   -- SQL 2017+
                            -----------------------------------------------------------------------------
                            OR (    i.product_major_version= 13   -- SQL 2016 SP1
                                AND i.product_minor_version >= 4446 -- SQL 2016 SP1 CU4+
                               )
                           ,N' - Persisting Allowed 2016SP1+'
                           ,N'')
          ,TRY_CAST(i.stathdr_Persisted_Sample_Percent AS NVARCHAR(20))+ N'%'
          )
    )

+ IIF(i.stathdr_Updated IS NULL
     ,N''
-- Diagnostic - Index Stats - Index Histogram Buckets count
     , NCHAR(92) 
     + N'> Histogram Steps ' -- extra space added to make 2nd column in cell align
     + IIF(i.stathdr_steps IS NULL,N'N/A',tempdb.[dbo].[SQLXL_3SD](i.stathdr_steps,N'I'))
     ------------------------------------------------------------------------------
-- Diagnostic - Index Stats - Index Parameter Sniffing Ratio > 1
     + N', Parameter sniffing '
     + IIF(ROUND(i.stathist_param_sniff,2) <= 1.00
          ,N'NONE'
          ,[tempdb].[dbo].[SQLXL_3SD](i.stathist_param_sniff,N'N') + N'x')
     + CASE WHEN i.Lead_Element_is_Identity = 1
            THEN N' - IDENTITY'
            WHEN i.Lead_Element_is_Sequence = 1
            THEN N' - SEQUENCE'
            WHEN i.Lead_Element_is_newsequentialid = 1
            THEN N' - SEQUID'
            WHEN i.Lead_Element_is_newid = 1
            THEN N' - GUID'
            ELSE N''
       END
     ------------------------------------------------------------------------------
-- Diagnostic - Index Stats - Index first element Nullable & NULL row count
     + IIF(i.Lead_Element_is_Nullable = 1 OR i.stathist_null_rows > 0
          , N', Null Rows '
          + [tempdb].[dbo].[SQLXL_3SD](i.stathist_null_rows,N'I')
          + N' (' + IIF(i.stathdr_Rows_CNT > 0
                       ,[tempdb].[dbo].[SQLXL_3SD](1.0 * i.stathist_null_rows / i.stathdr_Rows_CNT,N'%')
                       ,IIF(i.stathist_null_rows = 0,N'0.00%',N'N/A')
                       )
          + N')'
          ,N', Not nullable')
     )

+ IIF(i.stathdr_Updated IS NULL
     ,N''
-- Diagnostic - Index Stats - statistics rowcount delta from index record count
     , NCHAR(92) 
     + N'> Row Delta '
     + CASE WHEN i.row_CNT = i.stathdr_Rows_CNT
            THEN N'[none]'
            WHEN i.row_CNT          > 0
             AND i.stathdr_Rows_CNT > 0
            THEN  [tempdb].[dbo].[SQLXL_3SD](1.0 * ABS(i.row_CNT - i.stathdr_Rows_CNT) / i.row_CNT,N'%')
                + N' ('
                + [tempdb].[dbo].[SQLXL_3SD](i.row_CNT,N'I') + N'/' + [tempdb].[dbo].[SQLXL_3SD](i.stathdr_Rows_CNT,N'I')
                + N')'
            ELSE STUFF( IIF(i.row_CNT = 0         ,N' [table empty]',N'')
                      + IIF(i.stathdr_Rows_CNT = 0,N' [stats empty]',N'')
                      ,1,1,N'')
       END
-- Diagnostic - Index Stats - stats modifications
     + N' Mod Pct '
     + IIF(i.Stats_Prop_modification_CNT = 0
          ,N'[none]'
          ,IIF(i.stathdr_Rows_CNT > 0
              , [tempdb].[dbo].[SQLXL_3SD](COALESCE(100.0 * i.Stats_Prop_modification_CNT / i.stathdr_Rows_CNT,0),N'N') + N'%'
              + N' ('
              + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.Stats_Prop_modification_CNT,0),N'I') 
              + N'/' 
              + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.stathdr_Rows_CNT,0),N'I')
              + N')'
              ,N''
              )
          )
     + IIF(i.stats_no_recompute = 1
-- Diagnostic - Index Stats - Stats NoRecompute enabled
          ,N', NoRecompute [ENABLED] (BI92)'
-- Diagnostic - Index Stats - consider enabling Stats NoRecompute
          ,IIF(100.0 * i.Stats_Prop_modification_CNT / i.stathdr_Rows_CNT > 10.0 
              ,N', Consider enabling NoRecompute'
              ,N''
              )
          )
      )

+ IIF(   i.stats_auto_created      = 1
      OR i.stats_has_filter        = 1
      OR i.stats_is_temporary      = 1
      OR i.stats_is_incremental    = 1
      OR i.stats_generation_method > 0
      OR i.lead_element_data_type LIKE N'%CHAR%'
      OR i.lead_element_data_type LIKE N'%TEXT%'
      -- NOTE: stats_no_recompute handled above
     , NCHAR(92) 
     + N'> '
     + STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Index Stats - Auto Created
              IIF(i.stats_auto_created = 1,N', Auto created',N'')
-- Diagnostic - Index Stats - Has filter
            + IIF(i.stats_has_filter   = 1
                 , N', Filtered - ' 
                 + IIF(i.stathdr_Unfiltered_Rows > 0
                      ,[tempdb].[dbo].[SQLXL_3SD](1.0 * i.stathdr_Rows_CNT / i.stathdr_Unfiltered_Rows,N'%') + N' rows'
                      ,N'no stats rows') 
                 ,N'')
-- Diagnostic - Index Stats - temporary - on READ ONLY secondary
            + IIF(i.stats_is_temporary   = 1,N', temporary stats - on READ ONLY secondary',N'')
-- Diagnostic - Index Stats - Incremental statistics update enabled
-- Diagnostic - Index Stats - Partitioned Index & Incremental stats NOT ENABLED
            + IIF(i.stats_is_incremental = 1
                 ,N', Incremental Update [ENABLED]'
                 ,IIF(    i.partition_function_ID > 0
                      AND (        i.product_Major_Version  >= 14   -- 2017+
                           OR (    i.product_major_version= 13   -- 2016 SP1 13.0.4001.0
                               AND i.product_minor_version >= 4001
                              )
                           OR (    i.product_major_version= 12   -- 2014 SP2 12.0.5000.0
                               AND i.product_minor_version >= 5000
                              )
                          )
                     ,N', Partitioned & Incremental update [NOT ENABLED]'
                     ,N'')
                 )
-- Diagnostic - Index Stats - Generated by other than sort-based method
            + IIF(i.stats_generation_method > 0
                 ,N', generated by ' +i.stats_generation_method_desc
                 ,N'')
-- Diagnostic - Index Stats - Lead key STRING, STRING INDEX statistics not created
            + IIF(   i.lead_element_data_type LIKE N'%CHAR%'
                  OR i.lead_element_data_type LIKE N'%TEXT%'
                 ,IIF(i.stathdr_String_Index = N'YES'
                     ,N', String summary statistics created'
                     ,N', NO string summary statistics')
                 ,N'')
            ,1,2,N'') -- STUFF
     ,N'')

  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type              = N'I'  
   AND TRY_CAST(i.type AS INT) > 0
   AND NOT i.obj_type_short_label = N'TVF';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - statistics - properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Diagnostic - Index - no statistics found for Keys & Missing Index columns
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT N'I'
      ,ic.database_id
      ,cp.parent_object_ID
      ,cp.object_id
      ,cp.index_id
      ,cp.type
      ,diagnostics = N'No column stats for ' + QUOTENAME(c.name)
  FROM (-- Index & Missing Index key columns
        SELECT ic.database_id
              ,parent_object_id = ic.object_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
              ,obj_type = N'U'
              ,ic.column_id
              ,ic.key_column_sequence -- note: actual order as captured by SSMS "Index Properties"
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
         WHERE ic.type IN (N'1',N'2',N'M')
           AND ic.is_included_column = 0
        -- Foreign key columns
        UNION ALL
        SELECT fkc.database_id
              ,fk.parent_object_id
              ,object_ID = fkc.constraint_object_id
              ,index_id  = fkc.constraint_object_id
              ,type      = N'F'
              ,obj_type  = N'F'
              ,column_id = fkc.parent_column_id
              ,fkc.constraint_column_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns] AS fkc
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_foreign_keyS]        AS fk
            ON fkc.database_id          = fk.database_id
           AND fkc.constraint_object_id = fk.object_id
       ) AS ic
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_column]      AS c
    ON ic.database_id = c.database_id           
   AND ic.parent_object_id   = c.object_id      
   AND ic.column_id   = c.Column_ID             
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS cp
    ON N'I'           = cp.rec_type             -- only get "index" level records from [SQLXL_Index_Compilation]
   AND N'TBL'         = cp.obj_type_short_label -- only get user table indexes from [SQLXL_Index_Compilation] - no history or internal tables
   AND ic.database_id = cp.database_ID
   AND ic.obj_type    = cp.obj_type
   AND ic.object_id   = cp.object_ID
   AND ic.index_id    = cp.index_ID
   AND ic.type        = cp.type
 WHERE 1 = 1
   AND c.Uniqueness IS NULL
 ORDER BY
       ic.key_column_sequence;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - no statistics found for Keys & Missing Index columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index Information. Skipping is_primary_key,is_unique_constraint since covered later
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters

-- Diagnostic - Index - Covers Foreign Key(s)
 IIF(i.covered_fkc_IDs IS NOT NULL,NCHAR(92) + N'Covers Foreign Key(s) ' +i.covered_fkc_IDs,N'')

-- Diagnostic - Index - is partitioned & partitioning column (BI64)
+IIF(i.ios_partition_CNT > 1 OR i.partition_column_ID > 0
    ,NCHAR(92) + N'Partitioned on ' + QUOTENAME(COALESCE(i.partition_column_name,N'PART COL NOT FOUND')) + N' - '
               + COALESCE(TRY_CAST(i.partition_CNT AS NVARCHAR(20)),N'PART CNT NOT FOUND')
               + N' partitions (BI64)'
    ,N'')

-- Diagnostic - Index - Used by Change Data Capture
+IIF(i.name = i.cdc_index_name,NCHAR(92) + N'Used by Change Data Capture (CDC) on this table',N'')

-- system named objects. some objects (CK,DF,EC,FK,PK,AO,UQ) escape getting flagged
-- Diagnostic - Index - System named
+IIF(i.is_system_named = 1,NCHAR(92) + N'System named',N'')

-- Diagnostic - Index - Created by Database Tuning Advisor (DTA)
+IIF(CHARINDEX(N'_DTA_',i.name) > 0,NCHAR(92) + N'Created through Database Tuning Advisor (DTA)',N'')

-----------------------------------------------------
-- Diagnostic - Index - Clustered Rowstore - More than 3 Key columns or more than 16 bytes (BI24)
-- Diagnostic - Index - Nonclustered Rowstore - More than 4 Key columns or more than 16 bytes (BI23)
+IIF(    i.type IN (N'1',N'2')
     AND i.obj_type_short_label NOT IN (N'HST',N'IT')
     AND (   COALESCE(i.stathdr_Average_Key_Length,i.key_total_datatype_length_bytes) > 16
          OR (   i.type = N'1' AND i.Key_Columns_CNT > 3
              OR i.type = N'2' AND i.Key_Columns_CNT > 4
             )
         )
   ,NCHAR(92) + N'Big key: '
              + IIF(i.stathdr_Average_Key_Length > 0
                   ,CAST(i.stathdr_Average_Key_Length      AS NVARCHAR(20)) + N' Avg Stats Len bytes'
                   ,CAST(i.key_total_datatype_length_bytes AS NVARCHAR(20)) + N' Col Len bytes'
                   ) + N' (BI24)'
              + N' In ' + TRY_CAST(i.Key_Columns_CNT AS NVARCHAR(20)) + N' cols'
              + IIF(i.type <> N'1',N' excl CX',N'')
              + N' (BI23)'
    ,N'')
-----------------------------------------------------
-- Diagnostic - Index - Candidate Clustering key for HEAP
+IIF(    i.type                   IN (N'0')
     AND i.tbl_is_memory_optimized = 0
     AND c.[Column Descriptors]   IS NOT NULL
    ,NCHAR(92) + N'Candidate Clustering key' + NCHAR(92) + N'> ' + c.[Column Descriptors]
    ,N'')

-----------------------------------------------------
,1,1,N'')
  FROM (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_objects] AS o
    ON i.database_id = o.database_id
   AND i.object_id   = o.object_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_StatHeader] AS sssh
    ON i.database_id = sssh.database_id
   AND i.object_id   = sssh.object_id
   AND i.index_id    = sssh.index_id
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_column]      AS c
    ON i.database_id = c.database_id
   AND i.object_id   = c.object_id
   AND COALESCE(i.tbl_cx_uniq_ordered_column_ID
               ,i.tbl_possible_uniq_column_id  ) = c.column_id
) AS i
 WHERE i.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - additional properties 2'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index Synergies - Foreign Key synergies omitted since already represented by "index covers FKC"
-- and "FKC covered by index"
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
-- Diagnostic - Index - Synergies found between indexes, missing indexes, and Foreign Key Constraints (BI1&2)
      ,diagnostic = N'Synergy -'
                  + STUFF( IIF(i.synergy_s > 0,N', Sequence (BI1&2)',N'')
                         + IIF(i.synergy_o > 0,N', Overlap'         ,N'')
                         + IIF(i.synergy_k > 0,N', Contained'       ,N'')
                        ,1,1,N'')
  FROM (--
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
              ,synergy_s = SUM(i.matching_sequence_CNT )
              ,synergy_o = SUM(i.matching_overlap_CNT  )
              ,synergy_k = SUM(i.matching_contained_CNT)
          FROM (--
                SELECT database_id
                      ,parent_object_id
                      ,object_id = l_object_id
                      ,index_id  = l_index_id
                      ,type      = l_type
                      ,matching_sequence_CNT  = IIF(i.matching_sequence_CNT  > 0 AND LEFT(i.matching_sequence_COL,1) = N'S',1,0)
                      ,matching_overlap_CNT   = IIF(i.matching_overlap_CNT   > 0 AND matching_overlap_COL  > N'',1,0)
                      ,matching_contained_CNT = IIF(i.matching_contained_CNT > 0 AND matching_contained_COL> N'',1,0)
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS i
                 WHERE i.l_type <> N'F'
                   AND i.r_type <> N'F' 
                   AND (  COALESCE(i.matching_sequence_CNT ,0)
                        + COALESCE(i.matching_overlap_CNT  ,0)
                        + COALESCE(i.matching_contained_CNT,0)
                       )> 0

                UNION
                SELECT database_id
                      ,parent_object_id
                      ,object_id = r_object_id
                      ,index_id  = r_index_id
                      ,type      = r_type
                      ,matching_sequence_CNT  = IIF(i.matching_sequence_CNT  > 0 AND LEFT(i.matching_sequence_COL,1) = N'S',1,0)
                      ,matching_overlap_CNT   = IIF(i.matching_overlap_CNT   > 0 AND matching_overlap_COL   > N'',1,0)
                      ,matching_contained_CNT = IIF(i.matching_contained_CNT > 0 AND matching_contained_COL > N'',1,0)
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS i
                 WHERE i.l_type <> N'F'
                   AND i.r_type <> N'F' 
                   AND (  COALESCE(i.matching_sequence_CNT ,0)
                        + COALESCE(i.matching_overlap_CNT  ,0)
                        + COALESCE(i.matching_contained_CNT,0)
                       )> 0
               ) AS i
         GROUP BY
               database_id,parent_object_id,object_id,index_id,type
       ) AS i;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - synergies'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Diagnostic - Index - Hi percent Scans to Reads, > 1/1000 "all" reads - NOTE: No InMemory since all non-hash reads are scans
-- <FUTURE> add record size/pages to computation
-- <FUTURE> link with uniqueness/selectivity to suggest adding keys
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic =
        N'Hi Scan %RDS - '
      + LTRIM( N' USG: ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ius_user_scans_CNT,0),N'I')
             + N' ('     + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ius_scans_to_read_PCT,0),N'N') + N'%)'
             + N' OPS: ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ops_total_scan_CNT,0),N'I')
             + N' ('     + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ops_scans_to_read_PCT,0),N'N') + N'%)'
             + N' (BI80)'
             )
-- Diagnostic - Index - Clustered Rowstore index - lots of range scans (> 10%)
      + IIF(    i.obj_type_short_label NOT IN (N'HST',N'IT') -- don't care about history tables, internal tables
            AND i.type = N'1'
           ,N'. CX - add more indexes?'
           ,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 CROSS
  JOIN (--
        SELECT ius_user_read_CNT
              ,ops_total_read_CNT
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a
 WHERE i.rec_type = N'I'
   AND i.type NOT IN (N'5'  -- clustered columnstore
                     ,N'6') -- nonclustered columnstore
   AND NOT (    i.tbl_is_memory_optimized = 1
            AND i.type IN (N'0')
           )
   AND (   i.ius_scans_to_read_PCT  > 5.0
        OR i.ops_scans_to_read_PCT  > 5.0
       )
   AND (   IIF(a.ius_user_read_CNT  > 0,100.0 * i.ius_user_scans_CNT / a.ius_user_read_CNT ,0) > 0.001 -- > 1/1000 of all read activity
        OR IIF(a.ops_total_read_CNT > 0,100.0 * i.ops_total_scan_CNT / a.ops_total_read_CNT,0) > 0.001 -- > 1/1000 of all read activity
       );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - scans to read ratio'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Index - High (> 25X) Ratio histogram bucket count Hi to low - candidate for parameter sniffing
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,ic.database_id
      ,ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
      ,diagnostic =
 N'Parameter sniffing candidate - Range '
+ [tempdb].[dbo].[SQLXL_3SD](ssh.param_sniff,N'N')
+ N'x for Key '
+ TRY_CAST(ic.key_column_sequence AS NVARCHAR(20))
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]                    AS ic
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_Histogram_summary] AS ssh
    ON ic.database_id = ssh.database_id
   AND ic.object_id   = ssh.object_id
   AND ic.index_id    = ssh.index_id
 WHERE ic.key_column_sequence = 1
   AND ssh.param_sniff        > 25;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - parameter sniffing'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Table - Possible UNIQUEIDENTIFIER not stored as UNIQUEIDENTIFIER data type - name or %char data length (16,29,22,32,36,38,68)
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,ic.database_id
      ,ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
-- Diagnostic - Table - has what looks like a GUID stored as something else
      ,diagnostic = IIF(ic.is_included_column = 0,N'Key ',N'')
                  + N'Column ' + QUOTENAME(cx.name)
                  + NCHAR(92)
                  + N'> Possible UNIQUEID, type is ' + UPPER(cx.user_type_name)
                  + N'(' + IIF(cx.max_length = -1,N'MAX',CAST(cx.max_length AS NVARCHAR(4))) + N')'
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]       AS cx
    ON ic.database_id                          = cx.database_id
   AND ic.object_id                            = cx.object_id
   AND ic.column_id                            = cx.column_id
 WHERE cx.system_type_id NOT IN (36,104) -- N'uniqueidentifier',N'BIT'
   AND cx.user_type_name NOT LIKE N'%INT%'
   AND (   cx.name LIKE N'%IDENTIFIER%'
        OR cx.name LIKE N'%GUID%'        -- globally unique identifier
        OR cx.name LIKE N'%UUID%'        -- universally unique identifier
        OR (    cx.name LIKE N'%ID%'
            AND cx.user_type_name LIKE N'%CHAR'
            AND cx.max_length IN (16 -- ASCII256 encoded
                                 ,20 -- ASCII85 encoded
                                 ,22 -- Base64 encoded
                                 ,32 -- Readable, no dashes or braces/parenttheses
                                 ,36 -- Readable, dashes no braces/parenttheses
                                 ,38 -- Readable, dashes and braces/parenttheses
                                 ,68 -- Dot.Net ToString "X" format - Four braced hex values, 4th value is subset of 8 braced hex values
                                 )
           )
       )
   AND cx.name NOT LIKE N'%_IDENTIFIER';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - UNIQUEIDENTIFIER not stored as UNIQUEIDENTIFIER'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Filtered indexes
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,i.database_id
      ,i.object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = N'Index Filtered: '
                  + STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - index - has filter on lead key column
                         + IIF(ed.lead_key > 0,N' Lead Key',N'')

-- Diagnostic - index - has filter on non-lead key column
                         + IIF(ed.non_lead_key > 0
                              ,IIF(ed.lead_key > 0
                                  ,N', '
                                  ,N' ')
                              + TRY_CAST(ed.non_lead_key AS NVARCHAR(20)) + N' non-Lead Key(s)'
                              ,N'')

-- Diagnostic - index - has filter on included column
                         + IIF(ed.non_key > 0
                              ,IIF(ed.lead_key > 0 OR ed.non_lead_key > 0
                                  ,N', '
                                  ,N' ')
                              + TRY_CAST(ed.non_key AS NVARCHAR(20)) + N' Included column(s)'
                              ,N'')

-- Diagnostic - index - filtered on a column not in the index (BI34) - with column name(s)
                         + IIF(ed.non_index > 0
                              ,N', ' + TRY_CAST(ed.non_index    AS NVARCHAR(20)) + N' non-key column(s) (BI34) '
                                     + COALESCE((--
                                                 SELECT NCHAR(92) + N'> ' + QUOTENAME(c.name)
                                                   FROM [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies] AS edc
                                                   LEFT OUTER
                                                   JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]       AS c
                                                     ON edc.database_id         = c.database_id
                                                    AND edc.referencing_id      = c.object_id
                                                    AND edc.referenced_minor_id = c.column_id
                                                   LEFT OUTER
                                                   JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
                                                     ON edc.database_id          = ic.database_id
                                                    AND edc.referencing_id       = ic.object_id
                                                    AND edc.referencing_minor_id = ic.index_id
                                                    AND edc.referenced_minor_id  = ic.column_id
                                                  WHERE ed.non_index             > 0
                                                    AND ed.database_id           = edc.database_id
                                                    AND ed.object_id             = edc.referencing_id
                                                    AND ed.index_id              = edc.referencing_minor_id
                                                    AND 7                        = edc.referencing_class
                                                    AND 1                        = edc.referenced_class
                                                    AND ic.column_id            IS NULL
                                                    FOR XML PATH(N''), TYPE
                                                ).value('(./text())[1]',N'NVARCHAR(4000)')
                                               ,NCHAR(92) + N'> Column not found')
                              ,N'')
                         ,1,1,N'')
  FROM (--
        SELECT database_id      = ed.database_id
              ,object_id        = ed.referencing_id
              ,index_id         = ed.referencing_minor_id
              ,lead_key         = SUM(IIF(ic.key_column_sequence = 1,1,0))
              ,non_lead_key     = SUM(IIF(ic.key_column_sequence > 1,1,0))
              ,non_key          = SUM(IIF(ic.is_included_column  = 1,1,0))
              ,non_index        = SUM(IIF(ic.column_id       IS NULL,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies] AS ed
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns]               AS ic
            ON ed.database_id          = ic.database_id
           AND ed.referencing_id       = ic.object_id
           AND ed.referencing_minor_id = ic.index_id
           AND ed.referenced_minor_id  = ic.column_id
         WHERE ed.referencing_class    = 7
           AND ed.referenced_class     = 1
         GROUP BY
               ed.database_id
              ,ed.referencing_id
              ,ed.referencing_minor_id
       ) ed
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes] AS i
    ON ed.database_id           = i.database_id
   AND ed.object_id             = i.object_id
   AND ed.index_id              = i.index_id
   AND TRY_CAST(i.type AS INT) IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Filtered indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Capture Filtered Statistics on key columns (Index, Missing, FKC) NOT on an Index
--------------------------------------------------------------------------------------------------------------------------------------------
/*** LOCAL TESTING ***
--SET ANSI_WARNINGS ON; -- FOR XML PATH used below
IF (OBJECT_ID(N'[tempdb]..#key_column_filtered_statistics') IS NOT NULL) DROP TABLE #key_column_filtered_statistics;
--*/

SELECT x.database_id
      ,x.parent_object_id
      ,ic.object_id
      ,ic.column_id
      ,ic.index_id
      ,ic.type
      ,ic.key_column_sequence
      ,c.name
      ,cnt                  = COUNT(1)
      ,auto_created         = SUM(IIF(s.auto_created         = 1,1,0))
      ,no_recompute         = SUM(IIF(s.no_recompute         = 1,1,0))
      ,is_temporary         = SUM(IIF(s.is_temporary         = 1,1,0))
      ,is_incremental       = SUM(IIF(s.is_incremental       = 1,1,0))
      ,has_persisted_sample = SUM(IIF(s.has_persisted_sample = 1,1,0))
  INTO #key_column_filtered_statistics
  FROM (--
        SELECT database_id
              ,parent_object_id = object_id
              ,object_id
              ,stats_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_stats]
         WHERE has_filter = 1
        EXCEPT
        SELECT database_id
              ,parent_object_id = object_id
              ,object_id
              ,index_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_indexes]
         WHERE has_filter = 1
       ) AS x
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_stats] AS s
    ON x.database_id            = s.database_id
   AND x.object_id              = s.object_id
   AND x.stats_id               = s.stats_id
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_sql_expression_dependencies] AS sep
    ON s.database_id            = sep.database_id
   AND s.object_id              = sep.referencing_id
   AND s.stats_id               = sep.referencing_minor_id
   AND 9                        = sep.referencing_class
  JOIN (--
        SELECT database_id
              ,parent_object_id = object_id
              ,object_id
              ,index_id
              ,type
              ,column_id
              ,key_column_sequence
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]
         WHERE is_included_column = 0
        UNION ALL
        SELECT database_id
              ,parent_object_id
              ,constraint_object_id
              ,constraint_object_id
              ,type = N'F'
              ,parent_column_id
              ,constraint_column_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_key_columns]
       ) AS ic
    ON x.database_id            = ic.database_id
   AND x.parent_object_id       = ic.parent_object_id
-- AND x.object_id              = ic.object_ID -- Commented out since we're only looking for filters on Table columns
   AND sep.referenced_minor_id  = ic.column_id
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns] AS c
    ON x.database_id            = c.database_id
   AND x.object_id              = c.object_id
   AND sep.referenced_minor_id  = c.column_id
 GROUP BY
       x.database_id
      ,x.parent_object_id
      ,ic.object_id
      ,ic.column_id
      ,ic.index_id
      ,ic.type
      ,ic.key_column_sequence
      ,c.name;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - create #key_column_filtered_statistics'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Statistics - Filtered Statistics on key columns (Index, Missing, FKC) NOT on an Index
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = N'Column Filtered Statistics (BI93)'
                  + COALESCE((SELECT  N' Key '
                                    + TRY_CAST(cfs.key_column_sequence AS NVARCHAR(20))
                                    + N': ' + [tempdb].[dbo].[SQLXL_3SD](cfs.cnt,N'I')
                                FROM #key_column_filtered_statistics AS cfs
                               WHERE i.database_id      = cfs.database_id
                                 AND i.parent_object_id = cfs.parent_object_id
                                 AND i.object_id        = cfs.object_id
                                 AND i.index_id         = cfs.index_id
                                 AND i.type             = cfs.type
                                 FOR XML PATH(N''), TYPE
                             ).value('(./text())[1]',N'NVARCHAR(4000)')
                            ,NCHAR(92) + N'> Column not found')
  FROM (--
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
          FROM #key_column_filtered_statistics
         GROUP BY
               database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
       ) AS i;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Filtered Statistics on other columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Index - Lead key 2-19 steps, hi parameter sniff (>25X), candidate for Filter
-- Diagnostic - Index - non-Lead key 2-19 steps, hi parameter sniff (>25X), candidate for Filter
-- Diagnostic - Index - BIT data type, candidate for Filter
-- Diagnostic - Index - name implies potential for filtering (BI33)
-- Diagnostic - Index - SPARSE column, potential for filtering
-- Diagnostic - Index - Ratio hi histogram bucket to low is HIGH, candidate for parameter sniffing
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,ic.database_id
      ,ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
      ,diagnostic =
  N'Key ' + TRY_CAST(ic.key_column_sequence AS NVARCHAR(20)) + N':'
+ CASE WHEN c.data_type = N'BIT'
       THEN N' BIT, '
       WHEN c.is_sparse = 1
       THEN N' SPARSE, '
       WHEN c.histogram_steps BETWEEN 2 AND 19
        AND (   c.param_sniff          >= 25.0
             OR i.stathist_param_sniff >= 25.0
            )
       THEN N''
       WHEN ic.is_index_column_filtered = 1
       THEN N''
       ELSE N' named like filter, '
  END
+ CASE WHEN c.histogram_steps > 0
         OR i.stathdr_Steps   > 0
       THEN  N' '
           + TRY_CAST(IIF(i.stathdr_Steps > 0,i.stathdr_Steps,c.histogram_steps) AS NVARCHAR(20))
           + N' steps'
           + CASE WHEN i.stathist_param_sniff > 0
                    OR c.param_sniff          > 0
                  THEN  N', sniffs '
                      + [tempdb].[dbo].[SQLXL_3SD](IIF(ISNULL(i.stathist_param_sniff,0) > ISNULL(c.param_sniff,0)
                                                  ,i.stathist_param_sniff
                                                  ,c.param_sniff)
                                                  ,N'N') + N'x'
                  ELSE N', no sniff'
             END
       ELSE CASE WHEN i.tbl_is_empty = 1
                 THEN N' Empty'
                 ELSE N' No stats'
            END
  END
+ IIF(ic.is_index_column_filtered = 1,N', is filtered',N', add filter? (BI33)')

  FROM (-- All KEY index columns, candidates for filtered index
        SELECT database_id
              ,object_id
              ,index_id
              ,type
              ,key_column_sequence
              ,is_index_column_filtered
              ,column_id
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns]
         WHERE is_included_column = 0
           AND partition_ordinal  = 0
           AND type IN (N'2' -- heap
                       ,N'6' -- nonclustered columnstore
                       ,N'M' -- missing index
                       )
       ) ic
  JOIN [tempdb].[dbo].[SQLXL_Index_column] AS c
    ON ic.database_id               = c.database_id
   AND ic.object_id                 = c.object_id
   AND ic.Column_ID                 = c.column_id
  JOIN (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND obj_type_short_label NOT IN (N'HST',N'IT') -- can't modify System internal or history tables
       ) AS i
    ON ic.database_id               = i.database_id
   AND ic.object_id                 = i.parent_object_id
   AND ic.object_id                 = i.object_id
   AND ic.index_id                  = i.index_id
   AND ic.type                      = i.type
   AND 0                            = i.is_primary_key
   AND 0                            = i.is_unique_constraint
 WHERE 1 = 1
   AND (   (    (   c.histogram_steps BETWEEN 2 AND 19          -- only looking for filter opportunities
                 OR i.stathdr_Steps   BETWEEN 2 AND 19          -- only looking for filter opportunities
                )
            AND (   i.stathist_param_sniff >= 25.0
                 OR c.param_sniff          >= 25.0              -- greater than 25 times rowcounts between high and low
                )
            AND c.is_identity               = 0                 -- if IDENTITY ignore Stats Steps
            AND c.is_sequence               = 0                 -- if SEQUENCE ignore Stats Steps
            AND c.is_newsequentialid        = 0                 -- if NEWSEQUENTIALID ignore Stats Steps
            AND c.data_type          NOT LIKE N'%DATE%'         -- omit DATE/DATETIME
           )
        ---------------------------------------------------------
        OR N'bit'                    = c.data_type
        OR  c.is_sparse              = 1
        ---------------------------------------------------------
        OR  c.name LIKE N'is%'
        OR (c.name LIKE N'%archive%' AND c.data_type NOT LIKE N'%DATE%')
        OR  c.name LIKE N'%active%'
        OR  c.name LIKE N'%_band'
        OR  c.name LIKE N'%_band_%'
        OR  c.name LIKE N'%flag%'
        OR  c.name LIKE N'%status%'
        OR  c.name LIKE N'%_open%'
        ---------------------------------------------------------
        OR ic.is_index_column_filtered = 1
      );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - candidate filtered index keys'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Index - Another key column has better lead uniqueness, does not cover foreign key
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,xc.database_id
      ,xc.object_id
      ,xc.object_id
      ,xc.index_id
      ,xc.type
      ,diagnostic = N'Key ' + u.[Column Descriptors] + N' is more unique than key 1'
  FROM (--
        SELECT bc.database_id
              ,bc.object_id
              ,bc.index_id
              ,bc.type
              ,bc.column_id
          FROM (--
                SELECT u.database_id
                      ,u.object_id
                      ,u.index_id
                      ,u.type
                      ,u.key_column_sequence
                      ,u.column_id
                      ,rn = ROW_NUMBER() OVER (PARTITION BY u.database_id
                                                           ,u.object_id
                                                           ,u.index_id
                                                           ,u.type
                                                   ORDER BY u.col_uniqueness ASC
                                              )
                  FROM [tempdb].[dbo].[SQLXL_Index_uniqueness]  AS u
                  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS c
                    ON u.database_id = c.database_id
                   AND u.object_id   = c.object_ID
                   AND N'P'          = c.rec_type              -- parents only
                   AND N'TBL'        = c.obj_type_short_label  -- tables only
                 WHERE TRY_CAST(u.type AS INT)   BETWEEN 1 AND 2
                   AND u.is_included_column            = 0
                   AND u.key_column_sequence           > 0
                   AND CHARINDEX(N'=CX(',u.col_suffix) = 0 -- exclude columns also in from the clustering index
                   AND CHARINDEX(N'>CX(',u.col_prefix) = 0 -- exclude columns added from the clustering index
                   AND u.col_uniqueness                > 0
                   AND c.covered_fkc_IDs              IS NULL
               ) bc
         WHERE bc.rn = 1
        EXCEPT
        SELECT u.database_id
              ,u.object_id
              ,u.index_id
              ,u.type
              ,u.column_id
          FROM [tempdb].[dbo].[SQLXL_Index_uniqueness] AS u
         WHERE TRY_CAST(u.type AS INT) BETWEEN 1 AND 2
           AND u.is_included_column    = 0
           AND u.key_column_sequence   = 1
       ) xc
  JOIN [tempdb].[dbo].[SQLXL_Index_uniqueness] u
    ON xc.database_id = u.database_id
   AND xc.object_id   = u.object_id
   AND xc.index_id    = u.index_id
   AND xc.type        = u.type
   AND xc.column_id   = u.Column_ID
OPTION (MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - better lead index key'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Index - nonclustered rowstore index has more than 5 included columns
-- Diagnostic - Index - nonclustered rowstore index included columns 100 or more bytes
-- Diagnostic - Index - nonclustered rowstore index included column with MAX length
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,ic.database_id
      ,ic.object_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
      ,diagnostic = N'Bulky includes: '
                + STUFF(                N', ' + TRY_CAST(ic.cnt AS NVARCHAR(20)) + N' cols'
                       + IIF(ic.len > 0,N', ' + TRY_CAST(ic.len AS NVARCHAR(20)) + N' bytes',N'')
                       + IIF(ic.big > 0,N', ' + TRY_CAST(ic.big AS NVARCHAR(20)) + N' MAX',N'')
                       ,1,1,N'')
  FROM (-- all candidate indexes with big/many included columns
        SELECT ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
              ,cnt = COUNT(1)
              ,len = SUM(IIF(c.max_length < 0,0,c.max_length))
              ,big = SUM(IIF(c.max_length < 0,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS c
            ON ic.database_id = c.database_id
           AND ic.object_id   = c.object_id
           AND ic.column_id   = c.Column_ID
          LEFT OUTER
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ix                  -- filter out CLUSTERED index columns
            ON ic.database_id = ix.database_id
           AND ic.object_id   = ix.object_id
           AND 1              = ix.index_id
           AND N'1'           = ix.type
           AND ic.column_id   = ix.Column_ID
         WHERE ic.type               = N'2' -- nonclustered rowstore
           AND ic.is_included_column = 1
           AND ix.column_id         IS NULL
         GROUP BY
               ic.database_id
              ,ic.object_id
              ,ic.index_id
              ,ic.type
        HAVING  5 < COUNT(1)                                  -- included column count
            OR 99 < SUM(IIF(c.max_length < 0,0,c.max_length)) -- total included column length
            OR  0 < SUM(IIF(c.max_length < 0,1,0))            -- MAX length columns
       ) AS ic
  JOIN (-- parent objects that are not INTERNAL or HISTORY TABLES 
        SELECT database_id
              ,parent_object_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
           AND obj_type_short_label NOT IN (N'HST',N'IT')
       ) AS p
    ON ic.database_id  = p.database_id
   AND ic.object_id    = p.parent_object_id
   AND ic.object_id    = p.object_id;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - big indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Diagnostic - Index - with resumable operations and metrics
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,i.database_id
      ,i.object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = N'[RESUMABLE OPERATION - ' + r.state_desc + N']'
                  + NCHAR(92) + N'> Started: '
                              + TRY_CAST(DATEDIFF(DAY,r.start_time,GETDATE()) AS NVARCHAR(20))
                              + N' days ago)'
                  + NCHAR(92) + N'> Paused:'
                              + CONVERT(NVARCHAR(11),r.last_pause_time,11)
                              + N'@'
                              + CONVERT(NVARCHAR(8),r.last_pause_time,114)
                              + N' Complete: '
                              + TRY_CAST(r.percent_complete_MAX AS NVARCHAR(2)) + N'%'
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations] AS r
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes]                    AS i
    ON r.database_id                                        = i.database_id
   AND r.object_id                                          = i.object_id
   AND r.index_id                                           = i.index_id
   AND TRY_CAST(i.type AS INT) > 0

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - resumable operations'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- LEAD ROWSTORE INDEX KEY - ALL ELEMENTS
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic =
STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Index - Lead Key - is IDENTITY and index is NOT UNIQUE
-- Diagnostic - Index - Lead Key - is SEQUENCE and index is NOT UNIQUE
-- Diagnostic - Index - Lead Key - is NEWSEQUENTIALID and index is NOT UNIQUE
-- Diagnostic - Index - Lead Key - is SEQUENTIAL UNIQUE and optimize_for_sequential_key not enabled (2019+) (BI121)
-- Diagnostic - Index - Lead Key - is SEQUENTIAL UNIQUE and optimize_for_sequential_key is  enabled (2019+) (BI121)
+IIF(   i.Lead_Element_is_Identity        = 1
     OR i.Lead_Element_is_Sequence        = 1
     OR i.Lead_Element_is_newsequentialid = 1
     OR i.Lead_Element_is_newid           = 1
    ,NCHAR(92) + N'Lead Key is '
               + IIF(i.Lead_Element_is_Identity        = 1,N'IDENTITY'       ,N'')
               + IIF(i.Lead_Element_is_Sequence        = 1,N'SEQUENCE'       ,N'')
               + IIF(i.Lead_Element_is_newsequentialid = 1,N'NEWSEQUENTIALID',N'')
               + IIF(i.is_unique                       = 0,N', index not UNIQUE',N'')
               + IIF(i.product_Major_Version  >= 15 AND i.tbl_is_clustered_columnstore = 0
                    , N'> OPTIMIZE_FOR_SEQUENTIAL_KEY '
                    + IIF(i.optimize_for_sequential_key = 0,N'NOT ',N'')
                    + N'ENABLED (2019+) (BI121)'
                    ,N'')
    ,N'')

-- Diagnostic - Index - Lead Key - optimize_for_sequential_key is enabled & lead key not SEQUENTIAL UNIQUE (2019+) (BI121)
+IIF(    i.optimize_for_sequential_key = 1
     AND NOT (   i.Lead_Element_is_Identity        = 1
              OR i.Lead_Element_is_Sequence        = 1
              OR i.Lead_Element_is_newsequentialid = 1
             )
    ,NCHAR(92) + N'OPTIMIZE_FOR_SEQUENTIAL_KEY ENABLED (2019+), lead key not SEQ UNIQ (BI121)'
    ,N'')

-- Diagnostic - Index - Lead Key - is NEWID and index is not unique
+IIF(i.Lead_Element_is_newid = 1
    , NCHAR(92) + N'Lead Key is ' + N'NEWID'
    + IIF(i.is_unique = 0,N', index not UNIQUE',N'')
    ,N'')

-- Diagnostic - Index - Lead Key - lead element uniqueness is >5% of table row count
-- Lead_Element_Uniqueness is the stats density factor X # of rows when stats last computed
+IIF(i.stathdr_Unfiltered_Rows > 99
    ,IIF(    100.0 * i.Lead_Element_Uniqueness / i.stathdr_Unfiltered_Rows > 5.0
         AND i.Key_Columns_CNT > (1 + IIF(i.partition_function_ID > 0,1,0)) -- if partitioned must have partitioned column
        ,  NCHAR(92) + N'Lead key low uniqueness - ' + [tempdb].[dbo].[SQLXL_3SD](i.Lead_Element_Uniqueness,N'N') + N' rows, '
         + [tempdb].[dbo].[SQLXL_3SD](1.0 * I.Lead_Element_Uniqueness / i.stathdr_Unfiltered_Rows,N'%') + N' of table'
        ,N'')
    ,N'')

-- Diagnostic - Index - Lead Key - clustered index lead is unique & has extraneous key columns
-- Diagnostic - Index - Lead Key - Nonclustered index lead key is unique, extraneous columns can be included
+IIF(    (   i.Lead_Element_is_Identity        = 1
          OR i.Lead_Element_is_Sequence        = 1
          OR i.Lead_Element_is_newsequentialid = 1
          OR i.Lead_Element_is_newid           = 1
         )
     AND i.Key_Columns_CNT > (1 + IIF(i.partition_function_ID > 0,1,0)) -- if partitioned must have partitioned column
    ,NCHAR(92) + IIF(i.type = N'1'
                    ,N'> has '  + TRY_CAST(i.Key_Columns_CNT - 1 AS NVARCHAR(20)) + N' unneeded col(s)'              -- clustered rowstore
                    ,N'> move ' + TRY_CAST(i.Key_Columns_CNT - 1 AS NVARCHAR(20)) + N' unneeded columns to Include') -- nonclustered rowstore
    ,N'')
-- Diagnostic - Index - Lead Key - another column may be a better clustering lead key
+IIF(    i.type                          IN (N'1')
     AND i.tbl_is_memory_optimized        = 0                        -- base mem opt table is always HEAP
     AND i.tbl_cx_uniq_ordered_column_ID <> i.Lead_Element_Column_ID
    ,NCHAR(92) + N'Candidate Rebuilding key ' + NCHAR(92) + N'> ' + c.[Column Descriptors]
    ,N'')
-- Diagnostic - Index - Lead Key - is string/text and summary statistics have not been computed
+IIF(    i.parent_object_type = N'U'
     AND (   i.Lead_Element_Data_Type LIKE N'%CHAR%'
          OR i.Lead_Element_Data_Type LIKE N'%TEXT%'
         )
     AND i.stathdr_String_index IS NULL
     AND i.row_CNT               > 0
    , NCHAR(92) + N'Lead key ' + UPPER(i.Lead_Element_Data_Type) + N', String Summary statistics are '
    + IIF(i.stathdr_String_index = N'YES',N'',N'*NOT* ') + N'computed'
    ,N'')
------------------------------------------------------------
,1,1,N'')
  FROM (-- All rowstore clustered and nonclustered index records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE type IN (N'1'  -- clustered rowstore
                       ,N'2'  -- Nonclustered rowstore
                       )
       ) AS i
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_column] AS c
    ON i.database_id                   = c.database_id
   AND i.object_id                     = c.object_id
   AND i.tbl_cx_uniq_ordered_column_ID = c.column_id
) AS i
WHERE i.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - lead key properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Index key columns Nullable, non-standard type, string or LOB, differnet collation
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = 
-- Diagnostic - Index - non-lead Key element NULLable (BI25). Lead Key handled above under INDEX STATS
-- Diagnostic - Index - non-lead Key Element count of NULL values and percent of table
  N'Key ' + TRY_CONVERT(NVARCHAR(20),ic.key_column_sequence) +   
+ STUFF(IIF(c.is_nullable = 1
            ,N', is NULLable'
            + IIF(i.stathist_null_rows > 0
                 , N' - ' + [tempdb].[dbo].[SQLXL_3SD](i.stathist_null_rows,N'I') + N' NULL values '
                 + N'('
                 + IIF(i.stathdr_Rows_CNT > 0
                      ,[tempdb].[dbo].[SQLXL_3SD](1.0 * i.stathist_null_rows / i.stathdr_Rows_CNT,N'%')
                      ,N'empty ')
                 + N' table)'
                 + N' (BI25)'
                 ,N'')
            ,N'')
-- Diagnostic - Index - Key Element is non-standard data type
       + IIF(typ.name IN (N'binary'
                         ,N'image'
                         ,N'ntext'
                         ,N'real'
                         ,N'sql_variant'
                         ,N'varbinary')
            ,N', type ' + UPPER(typ.name)
            ,N'')
-- Diagnostic - Index - Key Element is string or LOB type (BI27)
       + IIF(   (typ.name = N'VARCHAR'  AND c.max_length > 8)
             OR (typ.name = N'NVARCHAR' AND c.max_length > 4)
             OR (typ.name = N'CHAR'     AND c.max_length > 8)
             OR (typ.name = N'NCHAR'    AND c.max_length > 4)
             OR c.max_length = -1
            ,N', type ' + UPPER(typ.name) + N'(' + IIF(c.max_length = -1,N'MAX',CAST(c.max_length AS NVARCHAR(20)))  + N') (BI27)'
            ,N'')
-- Diagnostic - Index - Key Element collation not match DB (BI69)
       + IIF(c.collation_name <> d.collation_name
            , N', has Collation ' + c.collation_name
            + N' <> DB ' + d.collation_name + N' (BI69)'
            ,N'')
       ,1,1,N'')
/*** LOCAL TESTING ***
SELECT COUNT(1)
--*/
  FROM (-- list of all CX & NCX indexes
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type    IN (N'1',N'2')
       ) AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_databases]     AS d
    ON i.database_id  = d.database_id
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
    ON i.database_id  = ic.database_id
   AND i.object_id    = ic.object_id
   AND i.index_id     = ic.index_id
   AND i.type         = ic.type
   AND 0              = ic.is_included_column
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]       AS c
    ON ic.database_id = c.database_id
   AND ic.object_id   = c.object_id
   AND ic.column_id   = c.column_id
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_types]         AS typ
    ON c.database_id  = typ.database_id
   AND c.user_type_id = typ.user_type_id
 WHERE c.is_nullable = 1
    OR typ.name IN (N'binary'
                   ,N'image'
                   ,N'ntext'
                   ,N'real'
                   ,N'sql_variant'
                   ,N'varbinary'
                   )
    OR (   (typ.name = N'VARCHAR'  AND c.max_length > 8)
        OR (typ.name = N'NVARCHAR' AND c.max_length > 4)
        OR (typ.name = N'CHAR'     AND c.max_length > 8)
        OR (typ.name = N'NCHAR'    AND c.max_length > 4)
        OR c.max_length = -1
       )
    OR c.collation_name <> d.collation_name
 ORDER BY -- to get columns in key sequence order
       i.database_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,ic.key_column_sequence;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - key element properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
** INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES INDEX TYPES IN **
\******************************************************************************************************************************************/
----------------------------------------------------------------------------------------------------
-- Index properties - Memory-optimized table activities
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic =
-----------------------------------------------------------------
-- Diagnostic - Index - Memory table activity. NOTE - base table is a HEAP - index type "0". Add Missing Index counts as needed
  IIF(ius_user_seeks_CNT + ius_user_scans_CNT + xtp_rows_touched_CNT > 0
     ,N'Touch: ' + [tempdb].[dbo].[SQLXL_3SD](ius_user_seeks_CNT + ius_user_scans_CNT + xtp_rows_touched_CNT,N'I')
     ,N'No user activity since capture started')
+ IIF(xtp_rows_returned_CNT > 0
     ,N' Return: ' + [tempdb].[dbo].[SQLXL_3SD](xtp_rows_returned_CNT,N'I')
     ,N'')
+ IIF(ius_user_seeks_CNT + ius_user_scans_CNT + xtp_scans_started_CNT > 0
     ,N' Scan: '   + [tempdb].[dbo].[SQLXL_3SD](ius_user_seeks_CNT + ius_user_scans_CNT + xtp_scans_started_CNT,N'I')
     ,N'')
+ IIF(xtp_scans_started_CNT > 0
     ,N' Retries: '  + [tempdb].[dbo].[SQLXL_3SD](COALESCE(xtp_scans_retries_CNT,0),N'I')
     ,N'')
-- Diagnostic - Index - Memory Optimized - Write Conflicts
+ IIF(xtp_write_conflicts_CNT > 0
     ,N' Write Conflicts:' + [tempdb].[dbo].[SQLXL_3SD](xtp_write_conflicts_CNT,N'I')
     ,N'')
-- Diagnostic - Index - Memory Optimized - Constraint Violations
+ IIF(xtp_unique_constraint_violations_CNT > 0
     ,N' Constraint Violations:' + [tempdb].[dbo].[SQLXL_3SD](xtp_unique_constraint_violations_CNT,N'I')
     ,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND obj_type_short_label NOT IN (N'HST' -- history tables
                                   ,N'IT'  -- internal/system tables
                                   ,N'TVF' -- table valued functions
                                   )
   AND parent_object_type        = N'U'            -- table
   AND tbl_is_memory_optimized   = 1;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - in memory metrics'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index properties - Heaps
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic =
  N'Heap '
+ STUFF(-- Strip off leading unnecessary characters
        IIF(   ip.is_primary_key       = 1
            OR ip.is_unique_constraint = 1
            OR ip.is_unique            = 1
           ,NCHAR(92) + N'- With '
           + STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Index - Heap - with PRIMARY KEY (BI47)
                    IIF(ip.is_primary_key = 1
                       ,N', Primary Key (BI47)'
                       ,N'')
-- Diagnostic - Index - Heap - with UNIQUE CONSTRAINT (BI47)
                  + IIF(    ip.is_primary_key = 0
                        AND ip.is_unique_constraint = 1
                       ,N', Unique Constraint (BI47)'
                       ,N'')
-- Diagnostic - Index - Heap - with unique index (BI47)
                  + IIF(    ip.is_primary_key = 0
                        AND ip.is_unique_constraint = 0
                        AND ip.is_unique = 1
                       ,N', Unique index (BI47)'
                       ,N'')
                  ,1,2,N'')
           ,N'')
       ------------------------------------------------------------
      + IIF(   p.row_CNT            > 0
            OR p.index_CNT          > 0
            OR p.Missing_index_CNT  > 0
            OR p.ius_User_total_CNT > 0

-- Diagnostic - Index - Heap - Number of data rows or empty
           ,NCHAR(92)
           + N'> Rows: ' + IIF(p.row_CNT > 0,tempdb.[dbo].[SQLXL_3SD](p.row_CNT,N'I'),N'0')                           -- number of rows else empty

-- Diagnostic - Index - Heap - with indexes - Count
           + N' Idx: ' + IIF(p.index_CNT > 0,tempdb.[dbo].[SQLXL_3SD](p.index_CNT,N'I'),N'0')                       -- Indexes

-- Diagnostic - Index - Heap - with Missing indexes - Count
           + N' MIX: ' + IIF(p.Missing_index_CNT > 0,tempdb.[dbo].[SQLXL_3SD](p.Missing_index_CNT,N'I'),N'0')       -- missing indexes

-- Diagnostic - Index - Heap - with query Usage (reads, writes)
           + N' USG'
           + N' RDS: ' + IIF(p.ius_user_read_CNT    > 0  -- User (Query) reads
                            ,tempdb.[dbo].[SQLXL_3SD](p.ius_user_read_CNT   ,N'I')
                            ,N'0')
           + N' WRT: ' + IIF(p.ius_user_updates_CNT > 0   -- User (Query) updates
                            ,tempdb.[dbo].[SQLXL_3SD](p.ius_user_updates_CNT,N'I')
                            ,N'0')
       ------------------------------------------------------------
           + NCHAR(92)
           + N'> OPS'
-- Diagnostic - Index - Heap - with query operations - Reads
           + N' RDS: ' + IIF(p.ops_total_read_CNT   > 0,tempdb.[dbo].[SQLXL_3SD](p.ops_total_read_CNT  ,N'I'),N'0')
-- Diagnostic - Index - Heap - with query operations - Writes (BI44-46)
           + N' WRT: ' + IIF(p.ops_total_write_CNT  > 0,tempdb.[dbo].[SQLXL_3SD](p.ops_total_write_CNT ,N'I'),N'0') + N' (BI44-46)'
-- Diagnostic - Index - Heap - with query operations - Deletes (BI49)
           + N' DEL: ' + IIF(p.ops_total_delete_CNT > 0,tempdb.[dbo].[SQLXL_3SD](p.ops_total_delete_CNT,N'I'),N'0') + N' (BI49)'
       ------------------------------------------------------------
           + IIF(p.ops_total_write_CNT > 0 OR p.ius_user_updates_CNT > 0
                , NCHAR(92)
                + N'> Read to Write ratio:'
-- Diagnostic - Index - Heap - Usage read to write ratio
                + N' USG ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ius_read_to_write_RAT,0),N'N') + N'x '
-- Diagnostic - Index - Heap - Operations read to write ratio
                + N' OPS ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ops_read_to_write_RAT,0),N'N') + N'x '
                ,N'')
           ,N'')
       ------------------------------------------------------------
      + IIF(p.ios_forwarded_fetch_CNT > 0
           , NCHAR(92)
           + N'> FWD FETCH:'
-- Diagnostic - Index - Heap - with Forwarded Fetches (BI43)
           + [tempdb].[dbo].[SQLXL_3SD](p.ios_forwarded_fetch_CNT,N'I')
           + IIF(p.row_CNT > 0
                ,N' (' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(1.0 * p.ios_forwarded_fetch_CNT / p.row_CNT,0),N'N') + N'x)'
                ,N' (No rows)')
           + N' (BI43)'
           ,N'')
-- NOTE: Heaps with Waits covered later
       ,1,1,N'')
------------------------------------------------------------
/*** LOCAL TESTING ***
SELECT rec_type   = N'I'
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,p.type
      ,i.type
      ,i.type
--*/
  FROM (-- All index-level records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type                  = N'I'
           AND obj_type_short_label NOT IN (N'HST' -- History table
                                           ,N'IT'  -- Internal/System Table
                                           ,N'TVF' -- Table valued function
                                           )
           AND type                      = N'0'    -- HEAP
           AND parent_object_type        = N'U'    -- table
           AND tbl_is_memory_optimized   = 0       -- not memory optimized
       ) AS i
  LEFT OUTER
  JOIN (-- Tables with Primary Key, Unique Constraint, or Unique index
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,is_primary_key       = SUM(IIF(is_primary_key = 1,1,0))
              ,is_unique_constraint = SUM(IIF(is_unique_constraint = 1,1,0))
              ,is_unique            = SUM(IIF(is_unique = 1,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type           = N'I'
           AND parent_object_type = N'U'
         GROUP BY
               database_id
              ,parent_object_id
              ,object_id
        HAVING 0 < SUM(IIF(is_primary_key       = 1,1,0))
            OR 0 < SUM(IIF(is_unique_constraint = 1,1,0))
            OR 0 < SUM(IIF(is_unique            = 1,1,0))
       ) AS ip
    ON i.database_id      = ip.database_id
   AND i.parent_object_id = ip.parent_object_id
   AND i.object_id        = ip.object_id
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type IN (N'P' -- parent object
                           ,N'S' -- system/internal table
                           )
           AND Clustered_ColumnStore_CNT = 0 -- not a clustered columnstore
       ) AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
) AS i
 WHERE i.diagnostic > N''; -- only get non-null Diagnostics

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - Heap properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index properties - clustered rowstore index
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (-- pairs with "WHERE i.diagnostic IS NOT NULL" below
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters
-- Diagnostic - Index - Clustered Rowstore - index Not Unique (BI28)
       IIF(i.Is_Unique = 0
          , NCHAR(92) + N'CX not UNIQUE (BI28)'
-- Diagnostic - Index - Clustered Rowstore - no statistics found
          + IIF(dv.All_Density IS NULL
               ,N', no statistics found'
               ,N'')
-- Diagnostic - Index - Clustered Rowstore - index not very selective
          + IIF(1.0 * dv.All_Density * i.stathdr_Rows_CNT >  1.10
               , N', not selective '
               + QUOTENAME([tempdb].[dbo].[SQLXL_3SD](1.0 * dv.All_Density * i.stathdr_Rows_CNT,N'N'))
               + N' rows/key'
               ,N'')
-- Diagnostic - Index - Clustered Rowstore - index candidate for Uniqueness
          + IIF(1.0 * dv.All_Density * i.stathdr_Rows_CNT <= 1.10
               , N', UNIQ candidate '
               + QUOTENAME([tempdb].[dbo].[SQLXL_3SD](1.0 * dv.All_Density * i.stathdr_Rows_CNT,N'N'))
               + N' rows/key'
               ,N'')
          ,N'')

-- Diagnostic - Index - Clustered Rowstore - index is unique but statistics are not - out of date?
      + IIF(i.is_unique = 1 AND 1.0 * dv.All_Density * i.stathdr_Rows_CNT > 1.005
           , NCHAR(92) + N'CX unique - '
           + [tempdb].[dbo].[SQLXL_3SD](1.0 * dv.All_Density * i.stathdr_Rows_CNT,N'N')
           + N' records per key, check stats'
           ,N'')
,1,1,N'')
  FROM (-- All index-level records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'1'                     -- clustered rowstore
           AND obj_type_short_label NOT IN (N'HST' -- History table
                                           ,N'IT'  -- Internal/System Table
                                           ,N'TVF' -- Table valued function
                                           ,N'VW'  -- View
                                           )
--         AND reserved_page_PG_CNT   > 32 -- size bigger than 256KB (8KBx32Pages)
       ) AS i
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_ShowStatistics_DensityVector] AS dv -- Get uniqueness from the last indexed key column
    ON i.database_id     = dv.database_id
   AND i.object_id       = dv.object_id
   AND i.index_id        = dv.index_ID
   AND i.Key_Columns_CNT = dv.Row_ID -- skip the clustering index keys in getting uniqueness
) AS i
 WHERE i.diagnostic > N'';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - clustered rowstore'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index Properties - nonclustered rowstore index
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM ( -- pairs with "WHERE i.diagnostic IS NOT NULL" below
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(-- Strip off leading unnecessary characters

       IIF(i.partition_CNT > 1 AND i.tbl_is_heap = 1
-- Diagnostic - Index - Partitioned nonclustered rowstore index found on Heap
          ,NCHAR(92) + N'Heap - Nonclustered index has ' + [tempdb].[dbo].[SQLXL_3SD](i.partition_CNT,N'I') + N' partitions'
          ,N'')

     + IIF(i.is_primary_key = 1 AND i.tbl_is_heap = 1
-- Diagnostic - Index - nonclustered rowstore index primary key found on Heap (BI47)
          ,NCHAR(92) + N'PRIMARY KEY on Heap - (BI47)'
          ,N'')

     + IIF(i.is_primary_key = 0 AND i.is_unique_constraint = 1 AND i.tbl_is_heap = 1
-- Diagnostic - Index - Unique Constraint nonclustered rowstore index found on Heap (BI47)
          ,NCHAR(92) + N'Unique Constraint on Heap - (BI47)'
          ,N'')

     + IIF(i.is_primary_key = 0 AND i.is_unique_constraint = 0 AND i.tbl_is_heap = 1 AND i.is_unique = 1
-- Diagnostic - Index - Unique nonclustered rowstore index found on Heap (BI47)
          ,NCHAR(92) + N'Unique index found on Heap - (BI47)'
          ,N'')

     ,1,1,N'')
  FROM (-- All index-level records, not in History or internal/system tables
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'2'
           AND obj_type_short_label NOT IN (N'HST' -- History table
                                           ,N'IT'  -- internal/system table
                                           )
       ) AS i
) AS i
 WHERE i.diagnostic > N'';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - nonclustered rowstore'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- Index Properties - Fulltext index
----------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
-- Diagnostic - Index - Full Text - properties
     ,diagnostic = N'Change Tracking ' + QUOTENAME(ftx.change_tracking_state_desc)
                 + N' Crawl Type '     + QUOTENAME(ftx.crawl_type_desc)
                 + IIF(ftx.has_crawl_completed = 0
                      ,N' In Progress ' + tempdb.dbo.SQLXL_DTTM_HMSM(i.collection_DTTM - ftx.crawl_start_date)
                      ,N' Completed '   + tempdb.dbo.SQLXL_DTTM_HMSM(i.collection_DTTM - ftx.crawl_end_date) + N' ago')
                 + NCHAR(92) 
                 + N'Catalog ID ' + QUOTENAME(ftx.fulltext_catalog_ID) 
                 + N' Name '      + QUOTENAME(ftx.name) + IIF(ftx.is_default = 1,N' (DEFAULT)',N'')
                 + NCHAR(92)
                 + N'Semantic Search Columns - ' 
                 + N' ON '  + [tempdb].[dbo].[SQLXL_3SD](ic.semantics_ON ,N'I') 
                 + N' OFF ' + [tempdb].[dbo].[SQLXL_3SD](ic.semantics_OFF,N'I') 
                 + NCHAR(92)
                 + N'Uses Unique Index '   + QUOTENAME(ftx.unique_index_ID)
                 + N' Stoplist '           + QUOTENAME(IIF(ftx.stoplist_ID = 0,N'DEFAULT',TRY_CAST(ftx.stoplist_ID AS NVARCHAR(20))))
                 + N' Property List '      + QUOTENAME(IIF(ftx.property_list_id IS NULL,N'NONE',TRY_CAST(ftx.property_list_id AS NVARCHAR(20))))
                 + N' Accent Sensitivity ' + QUOTENAME(IIF(ftx.is_accent_sensitivity_on = 1,N'ON',N'OFF'))
-- Diagnostic - Index - Full Text - Semantic Search ENABLED/DISABLED
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
  JOIN (SELECT *
          FROM tempdb.dbo.SQLXL_Index_sys_fulltext_indexes
       ) AS ftx
    ON i.database_ID      = ftx.database_id
   AND i.object_ID        = ftx.object_id
  JOIN (SELECT database_id,object_id,index_id,type
              ,semantics_ON  = SUM(IIF(statistical_semantics = 1,1,0))
              ,semantics_OFF = SUM(IIF(statistical_semantics = 0,1,0))
          FROM tempdb.dbo.SQLXL_Index_sys_index_columns
         WHERE type = N'90'
         GROUP BY
               database_id
              ,object_id
              ,index_id
              ,type
       ) AS ic
    ON i.database_ID      = ic.database_id
   AND i.parent_object_ID = ic.object_id
   AND i.object_ID        = ic.object_id
   AND i.index_ID         = ic.index_id
   AND i.type             = ic.type
 WHERE i.rec_type = N'I'
   AND i.type     = N'90'; -- fulltext

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - fulltext'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Index Compression
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Index - Compression - count of compressed Partitions (BI63)
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic =
  N'Compression: ' + IIF(i.Partition_row_compress_CNT > 0
                        ,N' ROW(' + [tempdb].[dbo].[SQLXL_3SD](i.Partition_row_compress_CNT,N'I') + N')'
                        ,N'')
                   + IIF(i.Partition_page_compress_CNT > 0
                        ,N' PAGE(' + [tempdb].[dbo].[SQLXL_3SD](i.Partition_page_compress_CNT,N'I') + N')'
                        ,N'')
-- Diagnostic - Index - Compression - Page Compression Failure Rate
                   + IIF(i.Partition_page_compress_CNT > 0 AND i.ios_page_compression_fail_PCT > 0.0
                        ,N' Fails: '+ [tempdb].[dbo].[SQLXL_3SD](i.ios_page_compression_fail_PCT / 100.0,N'%') -- /zero hard code
                        ,N'')
                   + IIF(i.Partition_columnstore_compress_CNT > 0
                        ,N' CS(' + [tempdb].[dbo].[SQLXL_3SD](i.Partition_columnstore_compress_CNT,N'I') + N')'
                        ,N'')
                   + IIF(i.Partition_columnstore_archive_compress_CNT > 0
                        ,N' ARC(' + [tempdb].[dbo].[SQLXL_3SD](i.Partition_columnstore_archive_compress_CNT,N'I') + N')'
                        ,N'')
                   + IIF(i.Partition_xml_compress_CNT > 0
                        ,N' XML(' + [tempdb].[dbo].[SQLXL_3SD](i.Partition_xml_compress_CNT,N'I') + N')'
                        ,N'')
                   + N' (BI63)'

  FROM (--
        SELECT rec_type
              ,database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
              ,partition_row_compress_CNT
              ,partition_page_compress_CNT
              ,ios_page_compression_fail_PCT
              ,partition_columnstore_compress_CNT
              ,partition_columnstore_archive_compress_CNT
              ,partition_xml_compress_CNT
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND (   partition_row_compress_CNT                 > 0
                OR partition_page_compress_CNT                > 0
                OR ios_page_compression_fail_PCT              > 0
                OR partition_columnstore_compress_CNT         > 0
                OR partition_columnstore_archive_compress_CNT > 0
                OR partition_xml_compress_CNT                 > 0
               )
       ) AS i;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Index Diagnostics - compression'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
** FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CON**
\******************************************************************************************************************************************/
-- NOTE: fk.is_not_trusted & fk.is_disabled are covered by index Diagnostics
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
-- Diagnostic - Foreign Key Constraint - Self Referencing
SELECT rec_type   = N'I'
      ,fk.database_id
      ,fk.parent_object_id
      ,fk.object_id
      ,index_id   = fk.object_id
      ,type       = N'F'
      ,diagnostic = QUOTENAME(N'Self referencing FKC')
  FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys] AS fk
 WHERE fk.parent_object_id = fk.referenced_object_id;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - self referencing'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,fk.database_id
      ,fk.parent_object_id
      ,fk.object_id
      ,index_id   = fk.object_id
      ,type       = N'F'
-- Diagnostic - Foreign Key Constraint - *DISABLED*
      ,diagnostic = STUFF( IIF(fk.is_disabled                = 1,N' *DISABLED*',N'')
-- Diagnostic - Foreign Key Constraint - *NOT TRUSTED*
                         + IIF(fk.is_not_trusted             = 1,N' *NOT TRUSTED*',N'')
-- Diagnostic - Foreign Key Constraint - *ENABLED FOR REPLICATION*
                         + IIF(fk.fkc_is_not_for_replication = 1 AND fk.tbl_is_replicated = 1,N' *NOT ENABLED FOR REPLICATION*',N'')
-- Diagnostic - Foreign Key Constraint - *IGNORED IN OPTIMIZATION*
                         + IIF(fk.is_ignored_in_optimization = 1,N' *IGNORED IN OPTIMIZATION*',N'')
                         ,1,1,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS fk
 WHERE type = N'F'
   AND (   (    fkc_is_not_for_replication = 0
            AND tbl_is_replicated          = 1
           )
        OR is_not_trusted             = 1
        OR is_disabled                = 1
        OR is_ignored_in_optimization = 1
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - properties'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT DISTINCT
       rec_type          = N'I'
      ,o.database_id
      ,o.parent_object_id
      ,object_id         = o.l_index_id
      ,index_id          = o.l_index_id
      ,type              = N'F'
-- Diagnostic - Foreign Key Constraint - Duplicate key
      ,diagnostic        = N'*Duplicate Foreign Key Constraint*'
  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
 WHERE o.l_type     = N'F'
   AND o.r_type     = N'F'
   AND o.matching_sequence_CNT = o.lc_key_CNT
   AND o.matching_sequence_CNT = o.rc_key_CNT;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - duplicates'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT DISTINCT
       rec_type          = N'I'
      ,o.database_id
      ,o.parent_object_id
      ,object_id         = o.l_index_id
      ,index_id          = o.l_index_id
      ,type              = N'F'
-- Diagnostic - Foreign Key Constraint - Same FKC key sequence
      ,diagnostic        = N'*Same sequence FKC*'
  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
 WHERE o.l_type     = N'F'
   AND o.r_type     = N'F'
   AND o.lc_key_CNT < o.rc_key_CNT
   AND o.matching_sequence_CNT > 0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - same sequence'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT DISTINCT
       rec_type          = N'I'
      ,o.database_id
      ,o.parent_object_id
      ,object_id         = o.l_index_id
      ,index_id          = o.l_index_id
      ,type              = N'F'
-- Diagnostic - Foreign Key Constraint - Overlap FKC key
      ,diagnostic        = N'*Overlapping FKC*'
  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
 WHERE o.l_type     = N'F'
   AND o.r_type     = N'F'
   AND o.matching_overlap_CNT = o.lc_key_CNT
   AND o.matching_overlap_CNT = o.rc_key_CNT

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - overlapping'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT DISTINCT
       rec_type          = N'I'
      ,o.database_id
      ,o.parent_object_id
      ,object_id         = o.l_index_id
      ,index_id          = o.l_index_id
      ,type              = N'F'
-- Diagnostic - Foreign Key Constraint - contained FKC key
      ,diagnostic        = N'*Contained FKC*'
  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
 WHERE o.l_type     = N'F'
   AND o.r_type     = N'F'
   AND o.matching_contained_CNT > 0
   AND o.lc_key_CNT < o.rc_key_CNT;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - contained'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,fk.database_id
      ,fk.parent_object_id
      ,fk.object_id
      ,index_id   = fk.object_id
      ,type       = N'F'
      ,diagnostic = N'FKC Action:'
-- Diagnostic - Foreign Key Constraint - Referential Actions - Delete
                  + N' Delete ' + QUOTENAME(fk.delete_referential_action_desc)
-- Diagnostic - Foreign Key Constraint - Referential Actions - Update
                  + N' Update ' + QUOTENAME(fk.update_referential_action_desc)
                  + IIF(   fk.delete_referential_action > 0
                        OR fk.update_referential_action > 0
                       ,NCHAR(92) + N'> NOTE: action forces serializable isolation (BI71)'
                       ,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys] AS fk;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - cascading'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Uncovered Foreign Key Constraints, if candidate covering Missing index(es) (sequence,overlap,contained) found show that too.
-- are there missing indexes found? See "Update Foreign Key Constraints" for rules
-- Note: as of Mar 2023 BlitzIndex refers to 2 CHECK_ID 72's - Woo!
--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (--
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,index_id   = i.object_id
      ,type       = N'F'
      ,diagnostic =
-- Diagnostic - Foreign Key Constraint - No covering index lead key element (BI72)
 N'Uncovered FKC (BI72)'
+IIF(i.fkc_Missing_index_CNT > 0 -- candidate missing indexes found
-- Diagnostic - Foreign Key Constraint - elements found in Missing indexes
    ,NCHAR(92) + N'> In '    + TRY_CAST(i.fkc_Missing_index_CNT AS NVARCHAR(20)) + N' MIX Candidate(s) '
               + N' Adv: '   + IIF(a.mix_Advantage_AMT > 0
                                 ,tempdb.[dbo].[SQLXL_3SD](1.0 * COALESCE(i.mix_Advantage_AMT,0) / a.mix_Advantage_AMT,N'%')
                                 ,N'')
               ---------------------------------
               + N' Cost: '  + IIF((a.mix_avg_total_user_cost_AMT + a.mix_avg_total_system_cost_AMT) > 0
                                 ,tempdb.[dbo].[SQLXL_3SD](1.0 * COALESCE((i.mix_avg_total_user_cost_AMT + i.mix_avg_total_system_cost_AMT),0)
                                                           / (a.mix_avg_total_user_cost_AMT + a.mix_avg_total_system_cost_AMT)
                                                      ,N'%')
                                 ,N'')
               ---------------------------------
               + N' Impact: ' + IIF((a.mix_avg_user_impact_AMT + a.mix_avg_system_impact_AMT) > 0
                                   ,tempdb.[dbo].[SQLXL_3SD](1.0 * COALESCE((i.mix_avg_user_impact_AMT + i.mix_avg_system_impact_AMT),0)
                                                            / (a.mix_avg_user_impact_AMT + a.mix_avg_system_impact_AMT)
                                                            ,N'%')
                                   ,N'')
    + NCHAR(92) + N'> MIX Count: ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.Missing_index_CNT      ,0),N'I')
                + N' Compiles: '   + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.mix_unique_compiles_CNT,0),N'I')
                + N' USG: '        + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.ius_User_total_CNT     ,0),N'I')
                                   + IIF(p.ius_User_total_CNT > 0
                                        , N' ('
                                        + [tempdb].[dbo].[SQLXL_3SD](1.0 * COALESCE(i.ius_User_total_CNT,0) / p.ius_User_total_CNT,N'%')
                                        + N')'
                                        ,N'')
                + N' Last: '       + COALESCE(TRY_CONVERT(NVARCHAR(11)
                                                        ,(SELECT MAX(dt)
                                                            FROM (VALUES (i.ius_last_user_seek_DTTM)
                                                                        ,(i.ius_last_user_scan_DTTM)
                                                                        ,(i.ius_last_system_seek_DTTM)
                                                                        ,(i.ius_last_system_scan_DTTM)
                                                                 ) AS value(dt)
                                                         ),2)
                                          ,N'N/A')
    ,N' - no candidate covering MIX')
/*** LOCAL TESTING ***
SELECT COUNT(1)
--*/
  FROM (-- All uncovered foreign key records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'F'
           AND fkc_covered_by_idx_IDS IS NULL -- no covering index
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type IN (N'P',N'S')
           AND type      = N'U'        -- table type
       ) AS p
    ON i.database_id        = p.database_id
   AND i.parent_object_id   = p.parent_object_id
   AND i.parent_object_id   = p.object_id
 CROSS
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a
) AS fk
 WHERE fk.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - uncovered, candidate MIX'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
-- Diagnostic - Foreign Key Constraint - count of referring FKC to this reference
      ,diagnostic = N'FKC References - ' + QUOTENAME(TRY_CAST(i.rk_referencing_fkc_CNT AS NVARCHAR(20)))
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type               = N'I'
   AND i.rk_referencing_fkc_CNT > 0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - references'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END


INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT fk.rec_type
      ,fk.database_id
      ,fk.parent_object_id
      ,fk.object_id
      ,index_id   = fk.object_id
      ,type       = N'F'
-- Diagnostic - Foreign Key Constraint - indexes with lead key(s) covering this FKC, in size order
      ,diagnostic = N'Covered by index ID(s) ' + fk.fkc_covered_by_idx_IDS
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS fk
 WHERE fk.rec_type                = N'I'
   AND fk.type                    = 'F'
   AND fk.fkc_covered_by_idx_IDS IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Diagnostics - covering indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
** MISSING INDEXES MISSING INDEXES MISSING INDEXES MISSING INDEXES MISSING INDEXES MISSING INDEXES MISSING INDEXES MISSING INDEXES MISSING**
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (-- Index level
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = STUFF(
-- Diagnostic - Missing index - candidate to cover foreign key constraint
        IIF(mix.fkc_id IS NOT NULL
           , NCHAR(92)
           + N'> Possible cover for Foreign Key(s) '
           + STUFF(mix.fkc_id,1,1,N'')
           ,N'')
-- Diagnostic - Missing index - Most resource intensive query generating MIX request
      + IIF(LTRIM(RTRIM(i.mqy_query_text)) > N''
           ,NCHAR(92) + N'See column "M" in Metadata for largest resource query generating MIX'
           ,N'')
      ,1,1,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'M'
       ) AS i
 CROSS
 APPLY (-- Double select to accomodate XML.value below
        SELECT(-- uncovered Foreign Key Constraints
               SELECT N',N' + TRY_CAST(syn.l_index_id AS NVARCHAR(20))
                 FROM [tempdb].[dbo].[SQLXL_Index_Synergies]   AS syn
                 JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS fkc
                   ON syn.database_id             = fkc.database_id
                  AND syn.parent_object_id        = fkc.parent_object_id
                  AND syn.l_index_id              = fkc.index_id
                  AND syn.l_type                  = fkc.type
                  AND fkc.fkc_covered_by_idx_IDS IS NULL                  -- no covering index on FKC
                WHERE i.database_id       = syn.database_id
                  AND i.parent_object_id  = syn.parent_object_id
                  AND N'F'                = syn.l_type
                  AND i.index_ID          = syn.r_index_ID
                  AND i.type              = syn.r_type -- Missing index type = 'M'
                  AND N'I'                = fkc.type
                  AND TRY_CAST(syn.l_index_id AS INT) IS NOT NULL
                  FOR XML PATH(N''), TYPE
              ).value('(./text())[1]','NVARCHAR(4000)')
       ) mix(fkc_id)
) AS i
 WHERE diagnostic > N'';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Missing Index Diagnostics - candidate covers'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT rec_type   = N'I'
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = N'> Table '
-- Diagnostic - Missing index - table is Clustered Columnstore
                  + IIF(p.Clustered_ColumnStore_CNT > 0,N'is Clustered Columnstore',N'')
-- Diagnostic - Missing index - table has Nonclustered Columnstore
                  + IIF(p.Nonclustered_ColumnStore_CNT > 0,N'has Nonclustered Columnstore (FK can''t use)',N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]  AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation]  AS p
    ON i.database_id                      = p.database_id
   AND i.parent_object_id                 = p.parent_object_id
   AND p.rec_type                        IN (N'P',N'S')
 WHERE i.type = N'M'
   AND (   p.Clustered_ColumnStore_CNT    > 0
        OR p.Nonclustered_ColumnStore_CNT > 0
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Missing Index Diagnostics - tables has columnstore'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT *
  FROM (-- Table level
SELECT p.rec_type
      ,p.database_id
      ,p.parent_object_id
      ,p.object_id
      ,p.index_id
      ,p.type
-- Diagnostic - Table - candidate for Nonclustered Columnstore due to missing index count
      ,diagnostic = N'Missing index CNT: ' + TRY_CAST(p.Missing_index_CNT AS NVARCHAR(20))
                  + IIF(a.mix_Advantage_AMT > 0
                       ,N' Advantage: ' + [tempdb].[dbo].[SQLXL_3SD](1.0 * p.mix_Advantage_AMT / a.mix_Advantage_AMT,N'%')
                       ,N'')
                  + IIF(    (SELECT version_major FROM [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters]) >= 13 -- SQL 2016+
                        AND (--
                             SELECT run_value
                               FROM [tempdb].[dbo].[SQLXL_Instance_info]
                              WHERE source = N'SERVERPROPERTY'
                                AND name   = N'EngineEdition'
                                AND (   TRY_CAST(run_value AS INT)  = 3 -- Enterprise (For Evaluation, Developer, and Enterprise editions)
                                     OR TRY_CAST(run_value AS INT) >= 5 -- As Of 06/20/2023
                                                                        -- 5 = SQL Database
                                                                        -- 6 = Azure Synapse Analytics
                                                                        -- 8 = Azure SQL Managed Instance
                                                                        -- 9 = Azure SQL Edge (For all editions of Azure SQL Edge)
                                                                        -- 11 = Azure Synapse serverless SQL pool
                                    )
                            ) > 0
                        AND IIF(a.mix_Advantage_AMT > 0.0
                               ,p.mix_Advantage_AMT / a.mix_Advantage_AMT
                               ,0.0) > 0.02
                       ,NCHAR(92) + N'> Consider Nonclustered Columnstore?'
                       ,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
           AND COALESCE(Missing_index_CNT           ,0) >= 3
           AND COALESCE(Nonclustered_ColumnStore_CNT,0)  = 0
       ) AS p
 CROSS
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a
) AS i
 WHERE i.diagnostic IS NOT NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Missing Indexes diagnostics - table candidate for nonclustered columnstore'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
** OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS OTHER ELEMENTS **
\******************************************************************************************************************************************/
-- Diagnostic - Object - possible temporary object based on name
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT DISTINCT -- needed since a name can be flagged multiple times
       c.rec_type
      ,c.database_id
      ,c.parent_object_id
      ,c.object_ID
      ,c.index_ID
      ,c.type
      ,diagnostic         = N'[POTENTIAL TEMPORARY OBJECT]'
  FROM (--
        SELECT c.rec_type
              ,c.database_id
              ,c.parent_object_id
              ,c.object_id
              ,c.index_id
              ,c.type
              ,diagnostic = IIF(    c.name NOT LIKE N'%TEMPLATE%'
                                AND c.name NOT LIKE N'%HOLD'
                                AND c.name NOT LIKE N'%ERRORLOG%'
                                AND (   c.name LIKE N'BAK%'       OR c.name LIKE N'%BAK'
                                     OR c.name LIKE N'BK%'        OR c.name LIKE N'%BK'
                                     OR c.name LIKE N'%BACKUP%'
                                     OR c.name LIKE N'%BCKUP%'
                                     OR c.name LIKE N'%BKP%'
                                     OR c.name LIKE N'%BKUP%'
                                     OR c.name LIKE N'%_BK_%'
                                     OR c.name LIKE N'COPY%'      OR c.name LIKE N'%COPY'
                                     OR c.name LIKE N'%DELETE%'
                                     OR c.name LIKE N'%DEMO%'
                                     OR c.name LIKE N'%DEPRECATE%'
                                     OR c.name LIKE N'_DTA_INDEX%'
                                     OR c.name LIKE N'%ERROR%'    OR c.name LIKE N'%ERR'  OR c.name LIKE N'ERR%'
                                     OR c.name LIKE N'HIDE%'
                                     OR c.name LIKE N'%[_]PERF[_]%'
                                     OR c.name LIKE N'REN_%'
                                     OR c.name LIKE N'%REFRESH%'
                                     OR c.name LIKE N'%ROLLBACK%'
                                     OR c.name LIKE N'%TBD%'
                                     OR c.name LIKE N'%TEMP'      OR c.name LIKE N'TEMP%' OR c.name LIKE N'%TMP'  OR c.name LIKE N'TMP%'
                                     OR c.name LIKE N'%XX%'
                                     OR c.name LIKE N'%ZZ%'
                                     OR c.name LIKE N'%$%'
                                     -----------------------------------------------------------------
                                     OR (c.name LIKE N'%OLD'     AND c.name NOT LIKE N'%THRESHOLD')
                                     -----------------------------------------------------------------
                                     OR c.name LIKE N'%\_TRACE'
                                     OR c.name LIKE N'TRACE%'
                                     -----------------------------------------------------------------
                                     OR ISDATE(LEFT(n.nbr,6))  = 1
                                     OR ISDATE(LEFT(n.nbr,8))  = 1
                                     OR ISDATE(RIGHT(n.nbr,6)) = 1
                                     OR ISDATE(RIGHT(n.nbr,8)) = 1
                                     OR ISDATE(RIGHT(n.nbr,4) + LEFT(n.nbr,4)) = 1
                                     OR TRY_CAST(n.nbr AS INT) BETWEEN YEAR(GETDATE()) - 40 AND YEAR(GETDATE()) + 40
                                    )
                               ,N'[POTENTIAL TEMPORARY OBJECT]',NULL)
              ,c.name
              ,n.nbr
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS c
         OUTER
         APPLY (SELECT string FROM [tempdb].[dbo].SQLXL_Parse_Strings(c.name,N' '))    AS p1
         OUTER
         APPLY (SELECT string FROM [tempdb].[dbo].SQLXL_Parse_Strings(p1.string,N'_')) AS p2
         OUTER
         APPLY (SELECT string FROM [tempdb].[dbo].SQLXL_Parse_Strings(p2.string,N'-')) AS p3
         OUTER -- get the numbers in the name to check if they are a date
         APPLY (SELECT nbr = [tempdb].[dbo].SQLXL_Keep_Strings(p3.string,N'0-9',N''))  AS n
         WHERE c.is_system_named = 0
           AND c.is_ms_shipped   = 0
           AND c.obj_type   NOT IN (N'IT')
       ) c
 WHERE c.diagnostic IS NOT NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Possible temporary object based on name'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/*#########################################################################################################################################\
** Prescriptions Prescriptions Prescriptions Prescriptions Prescriptions Prescriptions Prescriptions Prescriptions Prescriptions Prescrip **
\#########################################################################################################################################*/
/*** LOCAL TESTING ***
SET NOCOUNT ON
DECLARE @cover_foreign_keys TINYINT = 1
--*/

/******************************************************************************************************************************************\
** FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CONSTRAINTS FOREIGN KEY CO **
\******************************************************************************************************************************************/
-- This code stands alone since only 3 choices available for FKCs
-- RETAIN - Foreign Key Constraints that are enabled, trusted, and replicable
-- REVIEW - Foreign Key Constraints that are NOT enabled, trusted, or replicable
-- REMOVE - Foreign Key Constraints that are redundant (same or overlapping key sequence)
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = CASE WHEN sx.index_id <> s.index_id
                           THEN N'Remove FKC' + NCHAR(92) + N' Redundant'
                           WHEN (   sx.index_id = s.index_id
                                 OR s.index_id IS NULL
                                )
                            AND i.is_disabled                = 0
                            AND i.is_not_trusted             = 0
                            AND (   i.fkc_is_not_for_replication = 1
                                 OR i.tbl_is_replicated          = 0
                                )
                            AND COALESCE(s.ovl,0)            = 0
                            AND COALESCE(s.con,0)            = 0
                           THEN N'Retain FKC'
                           ELSE  N'Review FKC'
                               + IIF(   i.is_disabled                = 1
                                     OR i.is_not_trusted             = 1
                                     OR i.fkc_is_not_for_replication = 0
                                    , NCHAR(92)
                                    + STUFF( IIF(is_disabled          = 1,N' & Enable' ,N'')
                                           + IIF(is_not_trusted        = 1,N' & Trust'  ,N'')
                                           + IIF(fkc_is_not_for_replication = 0 AND i.tbl_is_replicated = 1
                                                ,N' & Disable Replication'
                                                ,N'')
                                           ,1,2,N'')
                                    ,N'')
                               + IIF(   COALESCE(s.ovl,0)            = 1
                                     OR COALESCE(s.con,0)            = 1
                                    , NCHAR(92)
                                    + STUFF( IIF(COALESCE(s.ovl,0)    = 1,N', Overlaps' ,N'')
                                           + IIF(COALESCE(s.con,0)     = 1,N', Contained',N'')
                                           ,1,1,N'')
                                    ,N'')
                      END
  FROM (-- All foreign key constraint "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'F'
       ) AS i
  LEFT OUTER
  JOIN (--
        SELECT s.database_id
              ,s.parent_object_id
              ,index_id = s.l_index_id
              ,seq = MAX(IIF(s.matching_sequence_CNT  > 0,1,0))
              ,ovl = MAX(IIF(s.matching_overlap_CNT   > 0,1,0))
              ,con = MAX(IIF(s.matching_contained_CNT > 0 AND s.lc_key_CNT < s.rc_key_CNT,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS s
         WHERE s.l_type = N'F'
           AND s.r_type = N'F'
           AND s.matching_sequence_CNT = s.lc_key_CNT
           AND s.matching_sequence_CNT = s.rc_key_CNT
         GROUP BY
               s.database_id
              ,s.parent_object_id
              ,s.l_index_id
       ) AS s
    ON i.database_id      = s.database_id
   AND i.parent_object_id = s.parent_object_id
   AND i.index_id         = s.index_id
 OUTER
 APPLY (-- If a redundant Foreign Key sequence found, choose one who's heart will live on (in order):
        -- enabled, trusted
        -- replicable
        -- with most columns
        -- not system named
        -- published, schema published
        -- delete action enabled, update action enabled
        -- first built
        SELECT TOP (1)
               index_id = sy.r_index_id
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies]        AS sx
          JOIN [tempdb].[dbo].[SQLXL_Index_Synergies]        AS sy
            ON sx.database_id           = sy.database_id
           AND sx.parent_object_id      = sy.parent_object_id
           AND sx.matching_sequence_col = sy.matching_sequence_col
           AND N'F'                     = sy.l_type
           AND N'F'                     = sy.r_type
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys] AS fk
            ON sy.database_id      = fk.database_id
           AND sy.parent_object_id = fk.parent_object_id
           AND sy.l_index_id       = fk.object_id
         WHERE s.seq              > 0
           AND s.database_id      = sx.database_id
           AND s.parent_object_id = sx.parent_object_id
           AND s.index_id         = sx.l_index_id
           AND N'F'               = sx.l_type
           AND N'F'               = sx.r_type
           AND 0                  < sx.matching_sequence_CNT
         ORDER BY
               fk.is_disabled
              ,fk.is_not_trusted
              ,sx.matching_sequence_CNT  DESC
              ,CASE fk.delete_referential_action
                    WHEN 0 THEN 4
                    ELSE fk.delete_referential_action
               END
              ,CASE fk.update_referential_action
                    WHEN 0 THEN 4
                    ELSE fk.update_referential_action
               END
              ,fk.is_system_named
              ,fk.is_published           DESC
              ,fk.is_schema_published    DESC
              ,fk.is_not_for_replication
              ,fk.object_id
       ) AS sx;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Foreign Key Constraints - Retain, Review, Remove'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END
--------------------------------------------------------------------------------------------------------------------------------------------
-- REMOVE - Nonclustered rowstore with key sequence matching Clustered index
-- Moved here since no good reason for index to exist except full scans on key elements
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription =  N'Remove'
                     + NCHAR(92) + N' Overlaps CX Seq'
                                 + CASE WHEN i.is_primary_key         = 1
                                        THEN NCHAR(92) + N' Add PK to CX'
                                        WHEN i.is_unique_constraint   = 1
                                         AND ncr.is_primary_key       = 0
                                         AND ncr.is_unique_constraint = 0
                                        THEN NCHAR(92) + N' Add UQ to CX'
                                        WHEN i.is_unique              = 1
                                         AND ncr.is_primary_key       = 0
                                         AND ncr.is_unique_constraint = 0
                                         AND ncr.is_unique            = 0
                                        THEN NCHAR(92) + N' Add UNIQ to CX'
                                        ELSE N''
                                   END
                     + NCHAR(92) + N'Review'
                     + NCHAR(92) + N' Check app for key scan'
  FROM (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT s.database_id
              ,s.parent_object_id
              ,s.l_index_id
              ,s.l_type
              ,il.is_primary_key
              ,il.is_unique_constraint
              ,il.is_unique
              ,s.r_index_id
              ,s.r_type
              ,s.rc_key_CNT
              ,s.matching_sequence_CNT
              ,s.matching_sequence_COL
              ,pct_of_table            = 1.0 * s.matching_sequence_all_density * il.row_CNT
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies]   AS s
          JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS il
            ON N'I'                    = il.rec_type
           AND s.database_id           = il.database_id
           AND s.parent_object_id      = il.parent_object_id
           AND s.l_index_id            = il.index_ID
           AND s.l_type                = il.type
         WHERE s.matching_sequence_CNT > 0
           AND s.l_type                = N'1'                    -- Clustered index
           AND s.r_type                = N'2'                    -- Nonclustered index
           -----------------------------------------------------------
           AND (   (    il.is_unique   = 1                       -- Clustered index unique (include PK & UQ) and all keys match
                    AND s.lc_key_CNT   = s.matching_sequence_CNT
                   )
                OR s.rc_key_CNT BETWEEN s.matching_sequence_CNT AND s.lc_key_CNT -- Nonclustered fully contained in clustered
               )
       ) ncr
    ON i.database_id              = ncr.database_id
   AND i.parent_object_id         = ncr.parent_object_id
   AND i.object_id                = ncr.parent_object_id
   AND i.index_id                 = ncr.r_index_id
   AND i.type                     = ncr.r_type
 WHERE i.prescription IS NULL;                                        -- Keep index if flagged previously  ;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Remove - Nonclustered rowstore with key sequence matching Clustered index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/* ORIGINAL DEFAULTS - incorporated into below
      ,tbl_default_action_type
                     = CASE WHEN tgt.obj_type                        = N'IT' THEN N'RETAIN'  -- N'IT'

                            WHEN tbl.is_filetable                    = 1     THEN N'RETAIN'  -- N'TBL FIL'
                            WHEN tbl.is_external                     = 1     THEN N'RETAIN'  -- N'TBL EXT'
                            WHEN tbl.temporal_type                   = 1     THEN N'RETAIN'  -- N'HST SVN'
                            WHEN tbl.temporal_type                   = 2     THEN N'RETAIN'  -- N'TBL SVN'
                            WHEN tbl.cdc_is_history_table            = 1     THEN N'RETAIN'  -- N'HST CDC'
                            WHEN tbl.ctt_is_track_columns_updated_on = 1     THEN NULL

                            WHEN tbl.ledger_type                     = 1     THEN N'RETAIN'  -- N'HST LDG '
                            WHEN tbl.ledger_type                     = 2     THEN N'RETAIN'  -- N'HST LDG UPD'
                            WHEN tbl.ledger_type                     = 3     THEN N'RETAIN'  -- N'HST LDG APP'
                            WHEN tbl.is_dropped_ledger_table         = 1     THEN N'RETAIN'  -- N'HST LDG DRP'

                            WHEN tgt.obj_type                        = N'V'  THEN N'RETAIN'  -- N'VW'
                            WHEN tgt.obj_type                        = N'FT' THEN N'RETAIN'  -- N'TVF CLR'
                            WHEN tgt.obj_type                        = N'IF' THEN N'RETAIN'  -- N'TVF INL'
                            WHEN tgt.obj_type                        = N'TF' THEN N'RETAIN'  -- N'TVF SQL'

                            WHEN tgt.obj_type                        = N'U'  THEN NULL       -- N'TBL'
                            WHEN ccs.is_clustered_columnstore        = 1     THEN NULL       -- N'TBL CCS'
                            WHEN tbl.is_replicated                   = 1     THEN NULL       -- N'TBL REP'
                            WHEN tbl.is_merge_published              = 1     THEN NULL       -- N'TBL MRG'
                            WHEN tbl.is_sync_tran_subscribed         = 1     THEN NULL       -- N'TBL SYN'
                            WHEN tbl.is_tracked_by_cdc               = 1     THEN NULL       -- N'TBL CDC'
                            WHEN tbl.is_memory_optimized             = 1     THEN NULL       -- N'TBL XTP'
                            WHEN itt.is_memory_optimized             = 1     THEN NULL       -- N'TBL XTP', Internal table Parent is optimized
                            WHEN tbl.is_remote_data_archive_enabled  = 1     THEN NULL       -- N'TBL RDA'

                            WHEN tbl.is_node                         = 1     THEN N'RETAIN'  -- N'GPH NOD'
                            WHEN tbl.is_edge                         = 1     THEN N'RETAIN'  -- N'GPH EDG'

                            ELSE                                                  tgt.parent_object_type
                       END
*/

----------------------------------------------------------------------------------------------------
-- RETAIN - System-Maintained History Table - CDC
-- RETAIN - System-Maintained History Table - Temporal
-- RETAIN - System-Maintained History Table - Ledger
-- RETAIN - Internal Tables - Temporal
-- RETAIN - Internal Tables - XML
-- RETAIN - Internal Tables - FullText
-- RETAIN - Internal Tables - Spatial
----------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = i.obj_type_hdr
  FROM (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.obj_type_short_label IN (N'HST',N'IT') -- History table or internal table

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - System Internal & History tables'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- RETAIN - Base Table Objects - Clustered index on Rowstore
-- RETAIN - Base Table Objects - Clustered Columnstore table
-- RETAIN - Base Table Objects - Heaps on Memory Tables
----------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = IIF(    i.type                    = N'0'
                          AND i.tbl_is_memory_optimized = 1
                         ,N'XTP HP'
                         ,i.type_short_desc)
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE rec_type = N'I'
   AND (   i.type IN (N'1'  -- clustered rowstore
                     ,N'5') -- clustered columnstore
        OR (    i.type                    = N'0' -- heaps
            AND i.tbl_is_memory_optimized = 1    -- memory optimized
           )
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - underlying persisted data tables - HP, CX, CCS, XTP'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- RETAIN - index types - XML
-- RETAIN - index types - Spatial
-- RETAIN - index types - Nonclustered Columnstore
-- RETAIN - index types - Full Text
----------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = COALESCE(i.type_short_desc,N'Missing Desc')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE rec_type = N'I'
   AND TRY_CAST(i.type AS INT)
    IN (3   -- XML
       ,4   -- Spatial
       ,6   -- Nonclustered ColumnStore
       ,90) -- FullText

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - specialty indexes - XML, SPT, NCS, FTX'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: Foreign Key Constraint reference
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = N'FKC Reference'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type               = N'I'
   AND i.rk_referencing_fkc_CNT > 0

UNION ALL
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: Change Data Capture (CDC) Table - Primary Key or unique
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = N'Used by CDC'
  FROM (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--  All "parent" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
    ON i.database_id              = p.database_id
   AND i.object_id                = p.object_id
   AND i.name                     = p.cdc_index_name

UNION ALL
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: Temporal (SVN) Table - Primary Key
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = N'Used by SVN'
  FROM (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS tbl
    ON i.database_ID = tbl.database_id
   AND i.object_id   = tbl.object_id
 WHERE 2 = tbl.temporal_type -- SYSTEM_VERSIONED_TEMPORAL_TABLE
   AND 1 = i.is_primary_key

UNION ALL
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: Ledger (LDG) Table (2022+) - Primary Key
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = N'Used by Ledger'
  FROM (-- All "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS tbl
    ON i.database_ID = tbl.database_id
   AND i.object_id   = tbl.object_id
 WHERE (   2 = tbl.ledger_type -- UPDATABLE_LEDGER_TABLE
        OR 3 = tbl.ledger_type -- APPEND_ONLY_LEDGER_TABLE
       )
   AND 1     = i.is_primary_key


UNION ALL -- Indexes used by other objects - XML, Spatial (Clustered Primary Key) ------------------
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: XML Index
-- RETAIN - Required by others: Spatial (SPT) Index - can be multiple spatial indexes using a primary key
SELECT DISTINCT
       i.database_id
       ,i.parent_object_id
       ,i.object_id
       ,i.index_id
       ,i.type
       ,action_desc = N'Retain'
       ,sort        = @srt
      ,prescription = N'Used by ' +x.type_short_desc
  FROM (-- All clustered primary key "index" records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type       = N'I'
           AND is_primary_key = 1
           AND type           = N'1'
       ) AS i
  JOIN (-- All XML or SPATIAL indexes
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND (   N'3' = type -- XML
                OR N'4' = type -- Spatial
               )
       ) AS x
    ON i.database_id      = x.database_id
   AND i.parent_object_id = x.parent_object_id
   AND i.object_ID        = x.object_ID

UNION ALL
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: Full Text (FTX) Index - Primary Key or Unique
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = N'Used by ' + f.type_short_desc
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS f
    ON i.database_id      = f.database_id
   AND i.parent_object_id = f.parent_object_id
   AND i.object_ID        = f.object_ID
   AND i.index_id         = f.ftx_unique_index_ID

-- Indexes used by other objects - Constraints -------------------------
UNION ALL
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
-- RETAIN - Required by others: Constraints - Primary Key - NOTE: does not filter out NOCHECKS
-- RETAIN - Required by others: Constraints - Unique Key - NOTE: does not filter out NOCHECKS
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Retain'
      ,sort         = @srt
      ,prescription = N'Used by ' + kc.type
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_key_constraints] AS kc
    ON i.database_id               = kc.database_id
   AND i.parent_object_id          = kc.parent_object_id
   AND i.object_id                 = kc.object_id
   AND TRY_CAST(i.index_id AS INT) = kc.unique_index_id;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - index required by others - FKC, CDC, SVN, LDG, XML, SPT, FTX, PK, UQ'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

----------------------------------------------------------------------------------------------------
-- RETAIN - "Best" covering index for Active Foreign Key - CX over NCX, no filter, most read, narrowest, fewest keys, narrowest includes
-- REVIEW - "Best" covering index for InActive Foreign Key - CX over NCX, no filter, most read, narrowest, fewest keys, narrowest includes
--          "Best" previously computed in "Foreign Key Analysis". Grouped in case multiple FK covered by same index
-- NOTE: Can't use Nonclustered Columnstore to cover a Foreign Key Parent
-- NOTE: Returns values only if variable @cover_foreign_keys = 1
-- @cover_foreign_keys:
--  0 = no need to continue to cover Foreign Key Constraints, do not create new indexes based on MISSING index recommendations
--  1 = continue to cover keys that are TRUSTED, ENABLED, and REPLICATED & are DELETE or UPDATE referential action enabled
--      Includes creating new indexes based on MISSING index recommendations
--  2 = continue to cover all Foreign Key Constraints that are TRUSTED, ENABLED, and REPLICATED
--      Includes creating new indexes based on MISSING index recommendations
--  3 = continue to cover all Foreign Key Constraints regardless of status
--      Includes creating new indexes based on MISSING index recommendations
----------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0
       ,@cover_foreign_keys TINYINT = 2;
--*/
SELECT DISTINCT -- needed because there can be redundant foreign keys
       fk.database_id
      ,fk.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,IIF(fk.active = 1,N'Retain',N'Review')
      ,@srt
      ,prescription = N'Covers ' + IIF(fk.active = 1,N'',N'NFC ') + N'FKC'
  FROM (-- get Foreign Key Constraints to cover based on passed in parameter

/*** LOCAL TESTING ***
DECLARE @srt INT = 0
       ,@cover_foreign_keys TINYINT = 2;
--*/
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,is_disabled
              ,is_not_for_replication
              ,is_not_trusted
              ,delete_referential_action
              ,update_referential_action
              ,active = IIF(    is_disabled    = 0    -- are enabled
                            AND is_not_trusted = 0    -- and trusted
                           ,1
                           ,0)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_foreign_keys]  AS fk
         WHERE 1 = 1
           AND (   (    @cover_foreign_keys = 1
                    AND (    is_disabled    = 0
                         AND is_not_trusted = 0
                        )
                    AND (   delete_referential_action > 0
                         OR update_referential_action > 0
                        )
                   )
                OR (    @cover_foreign_keys = 2
                    AND (    is_disabled    = 0
                         AND is_not_trusted = 0
                        )
                   )
                OR (    @cover_foreign_keys = 3
                   )
               )
       ) fk
  JOIN (--
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
              ,fkc_covering_primary_idx_ID
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND N'F'     = type
           AND 0        < fkc_covering_primary_idx_ID
       ) AS fx
    ON fk.database_id                 = fx.database_id
   AND fk.parent_object_id            = fx.parent_object_id
   AND fk.object_id                   = fx.object_id
   AND fk.object_id                   = fx.index_id
  JOIN (--
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type    IN (N'1',N'2')
       )    AS i
    ON fk.database_id                  = i.database_id
   AND fk.parent_object_id             = i.parent_object_id
   AND fk.parent_object_id             = i.object_id
   AND fx.fkc_covering_primary_idx_ID  = i.index_id
OPTION (FAST 1,MAXDOP 1);

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - Best existing covering index for FKC'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Update all RETAINed objects up to this point
\******************************************************************************************************************************************/
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Retain'
                     + STUFF(-- Strip off leading unnecessary characters
                             (--
                              SELECT NCHAR(92) + N' ' + rex.prescription
                                FROM #prescription    AS rex
                               WHERE i.database_id                = rex.database_id
                                 AND i.parent_object_id           = rex.parent_object_id
                                 AND i.object_ID                  = rex.object_ID
                                 AND i.index_ID                   = rex.index_ID
                                 AND i.type                       = rex.type
                                 AND N'Retain'                    = rex.action_desc
                               ORDER BY
                                     rex.srt
                                 FOR XML PATH(N''), TYPE
                             ).value('(./text())[1]',N'NVARCHAR(4000)')
                            ,1,1,N'')
  FROM (-- just get list of indexes to update
        SELECT DISTINCT
               database_id,parent_object_id,object_id,index_id,TYPE
          FROM #prescription
         WHERE action_desc   = N'Retain'
           AND prescription IS NOT NULL
       ) ref
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
    ON ref.database_id            = i.database_id
   AND ref.parent_object_id       = i.parent_object_id
   AND ref.object_ID              = i.object_ID
   AND ref.index_ID               = i.index_ID
   AND ref.type                   = i.type
   AND i.prescription IS NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Apply Retain labels to indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cleanup applied prescriptions
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE FROM #prescription WHERE action_desc = N'Retain'; -- already updated appropriate values

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clear out interim results table - Retain'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - Heaps - Create CX on used table's unique auto-generated column - Identity, Sequence, NEWID, SEQUENTIALID
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Request'
      ,sort         = @srt
      ,prescription = N'CX ' +i.tbl_cx_uniq_ordered_column_TYP -- get autogen type
                    + IIF(uniq_idx.index_id IS NOT NULL
                         , IIF(   uniq_idx.is_primary_key       = 1
                               OR uniq_idx.is_unique_constraint = 1
                              , IIF(uniq_idx.is_primary_key       = 1,N' USE IDX PK ' + QUOTENAME(uniq_idx.index_id),N'')
                              + IIF(uniq_idx.is_unique_constraint = 1,N' USE IDX UQ ' + QUOTENAME(uniq_idx.index_id),N'')
                              ,N' USE IDX ' + QUOTENAME(uniq_idx.index_id)
                              )
                         + IIF(uniq_idx.is_primary_key       = 1,NCHAR(92) + N' Make PK',N'')
                         + IIF(uniq_idx.is_unique_constraint = 1,NCHAR(92) + N' Make UNIQUE',N'')
                         ,N' See candidate')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
   AND i.object_id        = p.parent_object_id
 OUTER
 APPLY (--
        SELECT TOP 1
               ic.index_id
              ,ix.is_primary_key
              ,ix.is_unique_constraint
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes]       AS ix
            ON ic.database_id                          = ix.database_id
           AND ic.object_id                            = ix.object_id
           AND ic.index_id                             = ix.index_id
           AND ic.type                                 = ix.type
         WHERE i.database_id                           = ic.database_id
           AND i.object_id                             = ic.object_id
           AND i.tbl_cx_uniq_ordered_column_ID         = ic.column_id
           AND ic.type                                IN (N'2')
           AND 1                                       = ic.key_column_sequence
         ORDER BY
               ix.is_primary_key       DESC
              ,ix.is_unique_constraint DESC
              ,ix.index_id
       ) AS uniq_idx
 WHERE i.parent_object_type         = N'U'
   AND i.type                       = N'0'
   AND i.tbl_is_memory_optimized    = 0    -- Memory-optimized tables don't have CLUSTERED INDEXES, just HEAPS
   AND i.tbl_cx_uniq_ordered_column_TYP IS NOT NULL
   ---------------------------------------------------------
   AND (   p.ius_User_total_CNT     > 0    -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - clustered index on heaps with UNIQUE ORDERED columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REMOVE - Nonclustered indexes on HEAPS replaced by new CLUSTERED index using Sequential Unique key column
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SELECT i.database_id,tgt.parent_object_id,i.object_id,i.index_id,i.type,
--*/
       prescription = N'Remove' + NCHAR(92) + N' Use new CX on ' + tgt.tbl_cx_uniq_ordered_column_TYP
  FROM (--
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,tbl_cx_uniq_ordered_column_ID
              ,tbl_cx_uniq_ordered_column_TYP
              ,prescription
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type                      = N'I'
           AND type                          = N'0'
           AND tbl_cx_uniq_ordered_column_ID > 0
           AND tbl_is_memory_optimized       = 0
       )                                      AS tgt
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS i
    ON tgt.database_id                   = i.database_id
   AND tgt.object_id                     = i.object_id
   AND N'2'                              = i.type
   AND tgt.tbl_cx_uniq_ordered_column_ID = i.column_id
   AND 1                                 = i.key_column_sequence
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation]       AS p
    ON N'P'                              = p.rec_type
   AND i.database_id                     = p.database_id
   AND i.object_id                       = p.object_id
 WHERE (   p.ius_User_total_CNT     > 0    -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Remove - replace nonclustered on former heaps'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - "Best" Missing index for covering uncovered Foreign Key Constraints - key columns only
--------------------------------------------------------------------------------------------------------------------------------------------
IF @cover_foreign_keys > 0
BEGIN
   SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Request'
      ,sort         = @srt
         ,prescription = N'MIX > FKC'
     FROM (--
           SELECT *
             FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
            WHERE rec_type = N'I'
          ) AS i
     JOIN (--
           SELECT *
             FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
            WHERE rec_type = N'I'
          ) AS fk
       ON i.database_id                    = fk.database_id
      AND i.parent_object_id               = fk.parent_object_id
      AND i.index_ID                       = fk.fkc_candidate_covering_MIX_ID
      AND i.Key_Columns_CNT                = fk.Key_Columns_CNT
      AND i.Included_Columns_CNT           = 0
    WHERE i.TYPE                           = N'M'
      AND fk.fkc_candidate_covering_MIX_ID > 0
      AND fk.fkc_covering_primary_idx_ID  IS NULL;
END

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - best missing index to cover FKC'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - Heaps - Create CX using unique NCX (no auto-generated unique Column) - smallest, uniquest, fewest keys, most usedest
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Request'
      ,sort         = @srt
      ,prescription = N'CX from NCX ' + TRY_CAST(i.tbl_smallest_uniq_Nonclustered_idx AS NVARCHAR(20))
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                        AS p
    ON i.database_id             = p.database_id
   AND i.parent_object_id        = p.parent_object_id
   AND i.object_id               = p.parent_object_id
  LEFT OUTER
  JOIN #prescription            AS a
    ON i.database_id             = a.database_id
   AND i.parent_object_id        = a.parent_object_id
   AND i.object_id               = a.object_ID
   AND i.index_ID                = a.index_ID
   AND i.type                    = a.type
 WHERE i.parent_object_type      = N'U'
   AND i.type                    = N'0'
   AND i.tbl_is_memory_optimized = 0       -- Memory-optimized tables don't have CLUSTERED INDEXES
   ---------------------------------------------------------
   AND (   p.ius_User_total_CNT     > 0    -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       )
   ---------------------------------------------------------
   AND i.tbl_smallest_uniq_Nonclustered_idx IS NOT NULL
   AND a.type                     IS NULL; -- not already flagged above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - Promote NCX to CX on HEAP'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - Heaps - Create CX from smallest "unique" column greater than a BIT
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Request'
      ,sort         = @srt
      ,prescription = N'CX Candidate Col'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i

  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                        AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
   AND i.object_id        = p.parent_object_id
  LEFT OUTER
  JOIN #prescription               AS a
    ON i.database_id                = a.database_id
   AND i.parent_object_id           = a.parent_object_id
   AND i.object_id                  = a.object_ID
   AND i.index_ID                   = a.index_ID
   AND i.type                       = a.type
 WHERE i.parent_object_type         = N'U'
   AND i.type                       = N'0'
   AND i.tbl_is_memory_optimized    = 0     -- Memory-optimized tables don't have CLUSTERED INDEXES
   ---------------------------------------------------------
   AND (   p.ius_User_total_CNT     > 0     -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       )
   ---------------------------------------------------------
   AND a.type                     IS NULL  -- not already flagged above
   AND i.key_column_info        LIKE N'<HEAP> Candidate clustering column:%'

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - Unique-est column on HEAP'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - Heaps with Activity - Indicate a clustered index will help
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Request'
      ,sort         = @srt
      ,prescription = N'Create Uniq CX'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i

  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                        AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
   AND i.object_id        = p.parent_object_id

  LEFT OUTER
  JOIN #prescription              AS a
    ON i.database_id               = a.database_id
   AND i.parent_object_id          = a.parent_object_id
   AND i.object_id                 = a.object_ID
   AND i.index_ID                  = a.index_ID
   AND i.type                      = a.type

 WHERE i.parent_object_type           = N'U'
   AND i.type                      = N'0'
   AND i.tbl_is_memory_optimized   = 0     -- Memory-optimized tables don't have CLUSTERED INDEXES
   ---------------------------------------------------------
   AND (   p.ius_User_total_CNT     > 0    -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       )
   ---------------------------------------------------------
   AND a.type                     IS NULL -- not already flagged above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - Heap benefitting from CX'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - SQL Table-Valued Functions without Unique index
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,action_desc  = N'Request'
      ,sort         = @srt
      ,prescription = N' Create Uniq CX'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i

  LEFT OUTER
  JOIN #prescription     AS a
    ON i.database_id      = a.database_id
   AND i.parent_object_id = a.parent_object_id
   AND i.object_id        = a.object_ID
   AND i.index_ID         = a.index_ID
   AND i.type             = a.type
 WHERE i.parent_object_type = N'TF'
   AND i.type               = N'0'
   AND a.type              IS NULL -- not already flagged above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - TVF without unique CX'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

-------------------------------------------------------------------------------------------------------------------------------------------
-- Update REQUEST (CREATE)
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = COALESCE(i.prescription + NCHAR(92),N'')
                     + N'Request'
                     + (--
                        SELECT NCHAR(92) + N' ' + rex.prescription
                          FROM #prescription    AS rex
                         WHERE i.database_id                = rex.database_id
                           AND i.parent_object_id           = rex.parent_object_id
                           AND i.object_ID                  = rex.object_ID
                           AND i.index_ID                   = rex.index_ID
                           AND i.type                       = rex.type
                           AND N'Request'                   = rex.action_desc
                         ORDER BY
                               rex.srt
                           FOR XML PATH(N''), TYPE
                       ).value('(./text())[1]',N'NVARCHAR(4000)')

  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i

  JOIN (--
        SELECT DISTINCT
               database_id,parent_object_id,object_id,index_id,TYPE
          FROM #prescription
         WHERE action_desc              = N'Request'
       ) ref
    ON i.database_id      = ref.database_id
   AND i.parent_object_id = ref.parent_object_id
   AND i.object_ID        = ref.object_ID
   AND i.index_ID         = ref.index_ID
   AND i.type             = ref.type;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Apply Request labels to indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cleanup applied prescriptions
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE FROM #prescription WHERE action_desc = N'Request'; -- already updated appropriate values

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clear out interim results table - Request'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- BEGIN Special Case - Heaps not flagged as candidates for Clustered index
\******************************************************************************************************************************************/
-- RETAIN - Unused Heaps not flagged as candidates for Clustering index
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Retain HP'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type                  = N'I'
   AND i.parent_object_type        = N'U'
   AND i.type                      = N'0'  -- Heaps
   AND i.tbl_is_memory_optimized   = 0     -- Memory-optimized tables don't have CLUSTERED INDEXES
   AND i.prescription             IS NULL; -- not already flagged above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - unused heap'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- END Special Case
\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
-- What about a Nonclustered ColumnStore? Gotta be on 2016+ to be updatable
\******************************************************************************************************************************************/

IF OBJECT_ID('[tempdb]..#index_Key_DataType_Not_Eligible_for_NCS') IS NOT NULL
   DROP TABLE #index_Key_DataType_Not_Eligible_for_NCS;

--------------------------------------------------------------------------------------------------------------------------------------------
-- Find indexes with table options and key column data types that can't be included in Nonclustered Columnstore indexes
-- Create temp table and use this list to exclude them below
-- For further reference see https:/docs.microsoft.com/en-us/sql/t-sql/statements/create-columnstore-index-transact-sql
--------------------------------------------------------------------------------------------------------------------------------------------
SELECT ic.database_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
  INTO #index_Key_DataType_Not_Eligible_for_NCS
/*** LOCAL TESTING ***
SELECT ic.database_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
  JOIN [tempdb].[dbo].[SQLXL_Index_column]            AS c
    ON ic.database_id                          = c.database_id
   AND ic.object_id                            = c.object_id
   -- No Object_ID column in XL_IDX_column table
   AND ic.column_id                            = c.column_id
 WHERE 13 <= (-- Get SQL version from source server. 2016 allows updatable Nonclustered columnstore
              SELECT version = TRY_CAST(run_value AS INT)
                FROM [tempdb].[dbo].[SQLXL_Instance_info]
               WHERE name   = N'ProductMajorVersion'
                 AND source = N'SERVERPROPERTY'
             )
   AND 2  <> (-- Can't run columnstore on STANDARD EDITION (2)
              SELECT EngineEdition = run_value
                FROM [tempdb].[dbo].[SQLXL_Instance_info]
               WHERE name   = N'EngineEdition'
                 AND source = N'SERVERPROPERTY'
             )
   AND ic.type                                IN (N'2',N'M')               -- Nonclustered, missing index
   AND ic.is_included_column                   = 0                         -- only care about KEY columns in new index
   AND 0                                       = c.is_columnstore_eligible -- previously computed
 GROUP BY
       ic.database_id
      ,ic.object_id
      ,ic.index_id
      ,ic.type;

--------------------------------------------------------------------------------------------------------------------------------------------
-- List all Nonclustered and missing indexes that are candidates to be replaced by a Nonclustered Columnstore index
-- For Nonclustered index, must have been read/written to, and is not a "principally" used index
--------------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID('[tempdb]..#Candidate_indexes_for_NCS') IS NOT NULL
   DROP TABLE #Candidate_indexes_for_NCS;

SELECT i.database_id,i.object_id,i.index_id,i.type
      ,excluded = TRY_CAST(CASE WHEN i.is_primary_key  = 1        THEN 1
                            WHEN i.cdc_index_name  = i.name   THEN 1
                            ELSE 0
                       END AS TINYINT)
      ,ius      = i.ius_read_to_parent_PCT
      ,rtw      = i.ius_read_to_write_RAT
      ,ios      = i.ops_read_to_parent_PCT
      ,stw      = i.ops_read_to_write_RAT
  INTO #Candidate_indexes_for_NCS
/*** LOCAL TESTING ***
SELECT i.database_id,i.object_id,i.index_id,i.type
      ,excluded = TRY_CAST(CASE WHEN i.is_primary_key  = 1        THEN 1
                            WHEN i.cdc_index_name  = i.name   THEN 1
                            ELSE 0
                       END AS TINYINT)
      ,ius      = i.ius_read_to_parent_PCT
      ,rtw      = i.ius_read_to_write_RAT
      ,ios      = i.ops_read_to_parent_PCT
      ,stw      = i.ops_read_to_write_RAT
--*/
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  LEFT OUTER
  JOIN #index_Key_DataType_Not_Eligible_for_NCS AS x
    ON i.database_id                             = x.database_id
   AND i.object_ID                               = x.object_id
   AND i.index_ID                                = x.index_id
 WHERE 1 = 1
   AND 13 <= (-- Get SQL version from source server. 2016 allow for updatable Nonclustered columnstore
              SELECT version = TRY_CAST(run_value AS INT)
                FROM [tempdb].[dbo].[SQLXL_Instance_info]
               WHERE name   = N'ProductMajorVersion'
                 AND source = N'SERVERPROPERTY'
             )
   AND 2  <> (-- Can't run columnstore on STANDARD EDITION (2)
              SELECT EngineEdition = run_value
                FROM [tempdb].[dbo].[SQLXL_Instance_info]
               WHERE name   = N'EngineEdition'
                 AND source = N'SERVERPROPERTY'
             )
   --------------------------------------------------------
   AND obj_type_short_label                    NOT IN (N'HST',N'IT') -- Not a system maintained history or internal table
   AND COALESCE(i.Nonclustered_ColumnStore_CNT,0)  = 0    -- Nonclustered columnstore doesn't alreay exist on table
   AND x.index_id                               IS NULL -- all index key columns are eligible to be in Nonclustered columnstore
   --------------------------------------------------------
   AND (   (    i.type                           = N'2' -- Nonclustered indexes
            AND (   i.ops_read_to_parent_PCT     < 2.0  -- Read Usage < 2% of all reads on this table/view
                 OR i.ops_read_to_write_RAT      < 4.0  -- Reads/Writes < 4 Usage stats - writes = 4: memory lock, memory, index, log
                )
           )
        OR (    i.type                           = N'M' -- missing indexes
            AND i.ops_read_to_parent_PCT         < 2.0  -- MIX Usage > 2.0% of all reads on this table/view
           )
       )
   AND COALESCE(i.prescription,N'') NOT LIKE N'Remove%'  -- not flagged above
   AND COALESCE(i.prescription,N'') NOT LIKE N'Retain%'  -- not flagged above
   AND COALESCE(i.prescription,N'') NOT LIKE N'Request%' -- not flagged above as Missing index to create to cover a Foreign Key
                                                                  -- NOTE: Nonclustered Columnstores cannot cover a Foreign Key!

/*** LOCAL TESTING ***
SELECT * FROM #index_Key_DataType_Not_Eligible_for_NCS ORDER BY 1,2,3
SELECT * FROM #Candidate_indexes_for_NCS ORDER BY 1,2,4,3
*/

--------------------------------------------------------------------------------------------------------------------------------------------
-- Total up the unique key columns & identify Nonclustered Columnstore candidates
--------------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID('[tempdb]..#Candidate_for_NCS') IS NOT NULL DROP TABLE #Candidate_for_NCS;

;WITH cte AS (--
SELECT database_id
      ,object_ID
      ,ncx = SUM(IIF(type = N'2',1,0))
      ,mix = SUM(IIF(type = N'M',1,0))
  FROM #Candidate_indexes_for_NCS
 WHERE excluded = 0
 GROUP BY
       database_id
      ,object_ID
)
SELECT database_id
      ,object_ID
  INTO #Candidate_for_NCS
  FROM cte
 WHERE COALESCE(ncx,0) + COALESCE(mix,0) > 3

--------------------------------------------------------------------------------------------------------------------------------------------
-- REPLACE - NEW Nonclustered Columnstore index to replace existing lo-use Nonclustered rowstores and candidate missing indexes
-- DOES NOT NEED a unique index to refer to
-- Omit tables with an already existing Nonclustered Columnstore
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id,i.object_id,i.index_id,i.type,
--*/
       prescription = COALESCE(i.prescription + NCHAR(92),N'') -- should not be anything added before this point
                    + N'Request new NCS'                     -- NOTE: keep in synch with below ACTION codes
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS i
  LEFT OUTER
  JOIN (-- tables that already have a Nonclustered or a Clustered Columnstore
        SELECT database_id
              ,parent_object_id
              ,object_id
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type    IN (N'5'  -- Clustered columnstore - SQL 2016+ allows for Nonclustered rowstore indexes on clustered Columnstore
                          ,N'6'  -- Nonclustered columnstore - updatable with SQL 2016+
                          )
         GROUP BY
               database_id
              ,parent_object_id
              ,object_id
       )                  AS ncs
    ON i.database_id       = ncs.database_id
   AND i.parent_object_id  = ncs.object_ID
   AND i.object_ID         = ncs.object_ID
  JOIN #Candidate_for_NCS AS c
    ON i.database_id       = c.database_id
   AND i.parent_object_id  = c.object_ID
   AND i.object_ID         = c.object_ID
   AND i.index_id          = c.object_ID
   AND i.type              = N'U'
 WHERE 13 <= i.product_Major_Version 
   AND 2  <> (-- Can't run columnstore on STANDARD EDITION (2)
              SELECT EngineEdition = run_value
                FROM [tempdb].[dbo].[SQLXL_Instance_info]
               WHERE name   = N'EngineEdition'
                 AND source = N'SERVERPROPERTY'
             )
  AND ncs.object_ID       IS NULL  -- no existing Nonclustered columnstore on table

--------------------------------------------------------------------------------------------------------------------------------------------
-- REPLACE - Nonclustered rowstore indexes, not Retained, replace with EXISTING Nonclustered Columnstore
-- REPLACE - Nonclustered rowstore indexes, not Retained, replace with NEW Nonclustered Columnstore
-- REJECT - Missing indexes, not Requested, accomodated by EXISTING Nonclustered Columnstore index
-- REJECT - Missing indexes, not Requested, accomodated by NEW Nonclustered Columnstore
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id,i.object_id,i.index_id,i.type,
--*/
       prescription = IIF(i.type = N'M',N'Reject',N'Replace')
                    + NCHAR(92)
                    + N' Use ' + IIF(p.new_ncs = 1,N'new',N'existing') + N' NCS'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE type IN (N'2',N'M')  -- Nonclustered index, Missing index, less than 5% of total reads
       )                                       AS i
  JOIN (--
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,new_ncs          = TRY_CAST(1 AS BIT)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type     = N'P'
           AND prescription = N'Request new NCS'       -- NOTE: keep in synch with above ACTION codes

        UNION
        SELECT database_id
              ,parent_object_id
              ,object_id
              ,new_ncs = TRY_CAST(0 AS BIT)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
           AND type     = N'6'
       )                                       AS p
    ON i.database_id                            = p.database_id
   AND i.parent_object_id                       = p.parent_object_id
   AND i.object_ID                              = p.object_ID
  LEFT OUTER
  JOIN #index_Key_DataType_Not_Eligible_for_NCS AS x              -- Indexes that have columns unusable in Nonclustered columnstore
    ON i.database_id                            = x.database_id
   AND i.object_ID                              = x.object_id
   AND i.index_ID                               = x.index_id
 WHERE 13 <= i.product_Major_Version 
   AND 2  <> (-- Can't run columnstore on STANDARD EDITION (2)
              SELECT EngineEdition = run_value
                FROM [tempdb].[dbo].[SQLXL_Instance_info]
               WHERE name   = N'EngineEdition'
                 AND source = N'SERVERPROPERTY'
             )
   AND x.index_id                              IS NULL -- Index keys data types are allowed in Nonclustered columnstore
   AND (   COALESCE(i.ius_read_to_parent_PCT,0.0) < 1.0  -- not used too much
        OR i.type = N'M'                               -- include all Missing indexes
       )
   -- Index hasn't been called out before for action
   AND COALESCE(i.prescription,N'') NOT LIKE N'Remove%'  -- not flagged above
   AND COALESCE(i.prescription,N'') NOT LIKE N'Retain%'  -- not flagged above
   AND COALESCE(i.prescription,N'') NOT LIKE N'Request%' -- not flagged above as Missing index to create to cover a Foreign Key

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Nonclustered Columnstores - Request, Replace, Reject'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REQUEST - High Value Missing indexes - Large Advantage & significant usage not matching existing rowstore index
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Request' + NCHAR(92) + N' MIX Hi Gain'
                    + IIF(i.Overlap_Code IS NOT NULL,NCHAR(92) + N' MIX Synergies',N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 CROSS
  JOIN (--
        SELECT mix_Advantage_AMT
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type          = N'A'
           AND mix_Advantage_AMT > 0
       ) AS ins
 WHERE i.type                      = N'M'                     -- Missing index
   AND (    1.0 * i.ius_read_to_parent_PCT                    -- percent of READS if this index were created on the table
        + 100.0 * i.mix_Advantage_AMT / ins.mix_Advantage_AMT -- /zero handled by WHERE clause above
                                                              -- percent of total benefit across instance for this missing index
       ) > 4.0                                                -- seems like a good enough number to include all reasonable missings
   AND i.prescription  IS NULL                                -- not already flagged above
   AND NOT EXISTS (--
                   SELECT NULL
                     FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
                    WHERE i.database_id                   = o.database_id
                      AND i.parent_object_id              = o.parent_object_id
                      AND i.index_ID                      = o.l_index_id
                      AND i.type                          = o.l_type
                      AND N'2'                            = o.r_type
                      AND (   o.matching_sequence_CNT    >= o.lc_key_CNT
                           OR o.matching_overlap_CNT     >= o.lc_key_CNT
                          )
                  );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Request - High Value Missing indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REJECT - Low value Missing indexes
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription  = N'Reject' + NCHAR(92) + N' MIX low Gain'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.type             = N'M' -- Missing index
   ------------------------------------------
   AND i.prescription IS NULL  -- haven't been flagged up to this point

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Reject - Low value Missing indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- RETAIN - keep "best" sequence-matching non-filtered Nonclustered rowstore - not previously actioned and has statistics
-- <FUTURE> add: % of reads logic & if NCS available
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Retain' + NCHAR(92) + N' Best Same Sequence'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT rn = ROW_NUMBER() OVER (PARTITION BY seq.database_id
                                                   ,seq.parent_object_id
                                                   ,seq.matching_sequence_COL
                                           ORDER BY ----------------------------------------------------------------------------------------
                                                    -- find the bestest index based on their properties
                                                    ----------------------------------------------------------------------------------------
                                                 -- il.is_primary_key                  DESC -- PRIMARY KEY already retained above
                                                 -- il.is_unique_constraint            DESC -- UNIQUE CONSTRAINT already retained above
                                                    il.is_unique                       DESC -- is UNIQUE
                                                   ,il.ius_read_to_parent_PCT          DESC -- most used
                                                   ,il.stathdr_Average_Key_Length      DESC -- biggest
                                                   ,il.Key_Columns_CNT                 DESC -- most key elements
                                                   ,il.key_total_datatype_length_bytes DESC -- widest key
                                                   ,il.inc_total_datatype_length_bytes      -- fewest included columns
                                                   ,il.index_id
                                      )
               ,seq.database_id
               ,seq.parent_object_id
               ,il.object_ID
               ,il.index_ID
               ,il.type
          FROM (-- Get list of all synergy SEQUENCES shared between Nonclustered rowstores. NOTE: only UNFILTERED indexes appear
                SELECT DISTINCT
                       o.database_id
                      ,o.parent_object_id
                      ,o.matching_sequence_COL
                  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
                 WHERE o.l_type                        = N'2'
                   AND o.r_type                        = N'2'
                   AND LEFT(o.matching_sequence_COL,1) = N'S'
                ----------------------------------------------------------------------------------------------------------------------------
                -- Get list of all synergy SEQUENCES already used by RETAINed Clustered and Nonclustered rowstores
                -- PRIMARY KEY, UNIQUE CONSTRAINT, Clustered index already retained above
                ----------------------------------------------------------------------------------------------------------------------------
                EXCEPT
                SELECT DISTINCT
                       il.database_id
                      ,il.parent_object_id
                      ,o.matching_sequence_COL
                  FROM (--
                        SELECT *
                          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                         WHERE rec_type = N'I'
                       ) AS il
                  JOIN [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
                    ON o.database_id                   = il.database_id
                   AND o.parent_object_id              = il.parent_object_id
                   AND o.l_index_id                    = il.index_ID
                   AND o.l_type                        = il.type
                 WHERE il.prescription              LIKE 'RETAIN%'
                   AND il.type                        IN (N'1',N'2')
                   AND o.l_type                       IN (N'1',N'2')
                   AND o.r_type                       IN (N'1',N'2')
                   AND LEFT(o.matching_sequence_COL,1) = N'S'
               ) seq
          ---------------------------------------------------------------------------------------------------------------------------------
          -- rejoin to Synergies table to get the indexes sharing the synergy sequences found above
          ---------------------------------------------------------------------------------------------------------------------------------
          JOIN [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
            ON seq.database_id                   = o.database_id
           AND seq.parent_object_id              = o.parent_object_id
           AND seq.matching_sequence_COL         = o.matching_sequence_COL
           AND N'2'                              = o.l_type
           AND N'2'                              = o.r_type
          ---------------------------------------------------------------------------------------------------------------------------------
          -- Get properties for candidate sequence indexes
          ---------------------------------------------------------------------------------------------------------------------------------
          JOIN (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type = N'I'
               ) AS il
            ON seq.database_id                   = il.database_id
           AND seq.parent_object_id              = il.parent_object_id
           AND seq.parent_object_id              = il.object_ID
           AND o.l_index_id                      = il.index_ID
           AND o.l_type                          = il.type
       ) ix
    ON i.database_id      = ix.database_id
   AND i.parent_object_id = ix.parent_object_id
   AND i.object_ID        = ix.object_ID
   AND i.index_ID         = ix.index_ID
   AND i.type             = ix.type
 WHERE ix.rn = 1
   AND i.prescription IS NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - keep "best" synergy key SEQUENCE index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REMOVE - previously marked 'Retain' NCX with same key sequence as another Retained index, not flagged as replaced by NCS
-- <FUTURE> review with next for purpose. is previous RETAIN removed by new REMOVE?
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Remove' + NCHAR(92) + N' Use Retained NCX'
  FROM (--
        SELECT DISTINCT
               o.database_id
              ,o.parent_object_id
              ,index_id           = o.r_index_id  -- checking left side of overlap against right side retained index
              ,type               = o.r_type      -- checking left side of overlap against right side retained index
              ,o.matching_sequence_CNT
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies]  AS o
          JOIN (--
                SELECT *
                  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
                 WHERE rec_type = N'I'
               ) AS l
            ON o.database_id                   = l.database_id
           AND o.parent_object_id              = l.parent_object_id
           AND o.l_index_id                    = l.index_ID
           AND o.l_type                        = l.type
         WHERE 1 = 1
           AND o.l_type                        = N'2'
           AND o.r_type                        = N'2'
           AND o.matching_sequence_CNT         > 0
           AND (   o.matching_sequence_all_density < 0.01       -- 1% of all records
                OR (    o.lc_key_CNT >= o.matching_sequence_CNT
                    AND o.rc_key_CNT  = o.matching_sequence_CNT
                   )
               )
           AND l.prescription LIKE N'Retain%' -- hold on if flagged previously to Retain
       ) cte
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
    ON cte.database_id            = i.database_id
   AND cte.parent_object_id       = i.parent_object_id
   AND cte.parent_object_id       = i.object_id
   AND cte.index_id               = i.index_id
   AND cte.type                   = i.type
 WHERE i.prescription IS NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Remove - NCX synergy key SEQUENCE with successor NCX'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REMOVE - un/lighly used Nonclustered rowstore with same key sequence as Nonclustered rowstore not already flagged
--------------------------------------------------------------------------------------------------------------------------------------------
;WITH cte AS (--
SELECT o.database_id
      ,o.parent_object_id
      ,o.matching_sequence_COL
      ,o.matching_sequence_all_density
      ,o.l_index_id
      ,o.l_type
      ,l_reads = (COALESCE(l.ops_total_read_CNT,0) + COALESCE(l.ius_User_read_CNT,0))
      ,o.r_index_id
      ,o.r_type
      ,r_reads = (COALESCE(r.ops_total_read_CNT,0) + COALESCE(r.ius_User_read_CNT,0))
  FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS l
    ON o.database_id               = l.database_id
   AND o.parent_object_id          = l.parent_object_id
   AND o.l_index_id                = l.index_ID
   AND o.l_type                    = l.type
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS r
    ON o.database_id               = r.database_id
   AND o.parent_object_id          = r.parent_object_id
   AND o.r_index_id                = r.index_ID
   AND o.r_type                    = r.type
 WHERE o.l_type                         = N'2'
   AND o.r_type                         = N'2'
   AND o.matching_sequence_CNT          > 0
   AND o.matching_sequence_all_density  < 0.01  -- 1% of all records
   -----------------------------------------------
   AND l.prescription                  IS NULL
   AND r.prescription                  IS NULL
   -----------------------------------------------
   AND (l.ops_total_read_CNT + l.ius_User_read_CNT) < (r.ops_total_read_CNT + r.ius_User_read_CNT)
)
UPDATE i
   SET
       prescription = N'Remove' + NCHAR(92) + N' Overlaps NCX Seq'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN cte
    ON i.database_id              = cte.database_id
   AND i.parent_object_id         = cte.parent_object_id
   AND i.object_id                = cte.parent_object_id
   AND i.index_id                 = cte.l_index_id
   AND i.type                     = cte.l_type
 WHERE i.prescription IS NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Remove - NCX synergy key SEQUENCE with low RDS'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REMOVE - Nonclustered rowstores on used tables with Poor Read/Write ratio (< 4X) & low usage (< 2%)
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Remove' + NCHAR(92) + N' low R/W Ratio'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )  AS p
    ON i.database_id              = p.database_id
   AND i.parent_object_id         = p.parent_object_id
   AND i.object_id                = p.parent_object_id
 WHERE i.prescription              IS NULL
   ---------------------------------------------------------------------------
   AND i.obj_type                   = N'U'
   AND i.type                       = N'2' -- Nonclustered index
   AND i.tbl_is_heap                = 0
   AND (   p.ius_User_total_CNT     > 0    -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       )
   AND i.row_CNT                    > 0
   ---------------------------------------------------------
   AND COALESCE(i.ius_read_to_write_RAT,0.0)  < 4.0
   AND COALESCE(i.ops_read_to_write_RAT,0.0)  < 4.0
   AND COALESCE(i.ius_read_to_parent_PCT,0.0) < 2.0
   AND COALESCE(i.ops_read_to_parent_PCT,0.0) < 2.0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Remove - low read/write ratio & low RDS'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REMOVE - Nonclustered indexes with Poor usage or operational activity
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'Remove' + NCHAR(92) + N' Lo/No Activity'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )  AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
   AND i.object_id        = p.parent_object_id
 WHERE i.prescription    IS NULL
   ---------------------------------------------------------------------------
   AND i.obj_type                   = N'U'
   AND i.type                       = N'2' -- Nonclustered index
   AND i.tbl_is_heap                = 0
   AND (   p.ius_User_total_CNT     > 0    -- gotta hafta be used
        OR p.ops_total_contacts_CNT > 0    -- gotta hafta be used
       )
   AND i.row_CNT                    > 0
   ---------------------------------------------------------
   AND COALESCE(i.ius_read_to_parent_PCT,0) < 0.50
   AND COALESCE(i.ops_read_to_parent_PCT,0) < 0.50;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Remove - low RDS'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cleanup applied prescriptions
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE FROM #prescription WHERE action_desc = N'Remove'; -- already updated appropriate values

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clear out interim results table - Remoove'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- RETAIN - Heaps, Clustered, Nonclustered Leftovers - some Activity OR few waits OR is small
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT database_id,parent_object_id,object_id,index_id,type,
--*/
       prescription = N'Retain ' + type_short_desc
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE (   (    obj_type  = N'U'
            AND type     IN (N'0',N'1',N'2') -- Heap, Clustered, Nonclustered. All other types should have been flagged by now
           )
        OR (    obj_type  = N'V'
            AND type     IN (N'1',N'2') -- Clustered, Nonclustered
           )
       )
   AND prescription IS NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Retain - not flagged above'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Clustered index not created with Identity, Sequence, NEWID, SEQUENTIALID as lead CLUSTERED key.
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Use ' + tbl_cx_uniq_ordered_column_TYP
                    + IIF(fill_factor < 100.0,NCHAR(92) + N' FillFactor 100',N'')
                      -- check if covering Foreign Key Constraint, if do gonna need another index created to provide cover
                    + IIF(CHARINDEX(N'Covers FKC',prescription) > 0
                         ,NCHAR(92) + N' Recreate FKC cover'
                         ,N'')
                    + IIF(partition_Column_ID > 0
                         ,NCHAR(92) + N' Include Partition'
                         ,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE type                           = N'1'
   AND tbl_cx_uniq_ordered_column_ID <> Lead_Element_Column_ID;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - CX not using existing unique ordered column'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Lead Key UNIQUE (or nearly so) & has extra key columns
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Drop Xtra Keys'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.obj_type_short_label NOT IN (N'HST',N'IT')   -- Not a system maintained history or internal table
   AND TRY_CAST(type AS INT)  >= 0
   ---------------------------------------------------------
   AND Lead_Element_Column_ID  = COALESCE(tbl_cx_uniq_ordered_column_ID,tbl_possible_uniq_column_id)
   AND Key_Columns_CNT         > 1
   --------------------------------------
   AND prescription         LIKE N'Retain%' -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - unneeded key columns - lead key UNIQUE'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Lead Key Element is ORDERED UNIQUE and optimize for sequential key not enabled - 2019+
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Optimize Seq Key?'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND product_major_version    >= 15 --2019+
   AND obj_type_short_label NOT IN (N'HST',N'IT') -- Not a system maintained history or internal table
   AND TRY_CAST(type AS INT)    >  0
   ---------------------------------------------------------
   AND (   Lead_Element_is_Identity        = 1
        OR Lead_Element_is_Sequence        = 1
        OR Lead_Element_is_newsequentialid = 1
       )
   AND optimize_for_sequential_key         = 0
   --------------------------------------
   AND prescription LIKE N'Retain%' -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - enable Opt for Seq Key'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Lead Key Element is ORDERED UNIQUE data type and is_unique = 0
-- REFACTOR - Lead Key Element is ORDERED UNIQUE data type and Stat uniqueness <> 1, Not PK or Unique Constraint
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Key '
                    + IIF(Lead_Element_is_Identity        = 1,N'IDN' ,N'')
                    + IIF(Lead_Element_is_Sequence        = 1,N'SEQ' ,N'')
                    + IIF(Lead_Element_is_newsequentialid = 1,N'SUID',N'')
                    + IIF(Lead_Element_is_newid           = 1,N'NUID',N'')
                    + IIF(is_unique                       = 0
                         ,N' NOT UNIQ'
                         ,IIF(i.is_primary_key = 1 OR i.is_unique_constraint = 1,N'',N' BAD STATS')
                         )
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE rec_type = N'I'
   AND COALESCE(tbl_cx_uniq_ordered_column_ID,tbl_possible_uniq_column_id) > 0
   AND TRY_CAST(i.type AS INT) > 0
   AND (   is_unique                  = 0
        OR (    ROUND(i.Lead_Element_Uniqueness,4) > 1.0
            AND i.is_primary_key       = 0
            AND i.is_unique_constraint = 0
            AND i.is_unique            = 0
           )
       )
   --------------------------------------
   AND prescription LIKE N'Retain%' -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - lead key unique index not unique'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - index partition not match table partition
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Use Tbl Partition'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                 AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
   AND i.object_ID        = p.object_ID
   --------------------------------------
 WHERE i.obj_type_short_label    NOT IN (N'HST',N'IT')   -- Not a system maintained history or internal table
   AND COALESCE(i.partition_function_name,N'NONE') <> COALESCE(p.partition_function_name,N'NONE')
   AND i.prescription          NOT LIKE N'Remove%'   -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - match index to table partition'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Non-Empty index with writes and FILL FACTOR < 100% AND low page splits (< 2% since restart / DDL)
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'FillFactor 100%'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE obj_type_short_label   NOT IN (N'HST',N'IT')   -- Not a system maintained history or internal table
   AND fill_factor                          < 100.0
   AND COALESCE(page_splits_to_write_PCT,0.0) BETWEEN 0.0 AND 2.0
   AND reserved_page_PG_CNT                 > 0
   ---------------------------------------------------------
   AND prescription   LIKE N'Retain%'   -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - low splits low fill factor'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - index with FILL FACTOR = 100% AND hi page splits (> 5% since restart / DDL)
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'FillFactor <100%'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE obj_type_short_label NOT IN (N'HST',N'IT')         -- Not a system maintained history or internal table
   AND fill_factor               = 100.0
   AND page_splits_to_write_PCT  >   5.0
   --------------------------------------
   AND prescription     LIKE N'Retain%'          -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - hi splits hi fill factor'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - index with IGNORE_DUP_KEY property ON
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'IGNORE_DUP_KEY [ON]'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.obj_type_short_label NOT IN (N'HST',N'IT')       -- Not a system maintained history or internal table
   AND TRY_CAST(type AS INT)       >= 0
   ---------------------------------------------------------
   AND ignore_dup_key               = 1
   ---------------------------------------------------------
   AND prescription LIKE N'Retain%'              -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - ignore duplicate key ON'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - ROWSTORE indexes with Page/Row Locks OFF. BOL NOTE: An index can't be reorganized when ALLOW_PAGE_LOCKS is set to OFF.
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Enable '
                     + STUFF( IIF(i.allow_page_locks = 0,N',Page',N'')
                            + IIF(i.allow_row_locks  = 0,N',Row' ,N'')
                            ,1,1,N'')
                     + N' Locks'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE TRY_CAST(i.type AS INT) IN (1,2) -- ROWSTORE CLUSTERED & NONCLUSTERED only
   ---------------------------------------------------------
   AND (   i.allow_page_locks = 0 -- non-index value is NULL
        OR i.allow_row_locks  = 0 -- non-index value is NULL
       )
   ---------------------------------------------------------
   AND i.tbl_is_memory_optimized = 0         -- not a memory table
   AND prescription LIKE N'Retain%'; -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - Page/Row locks OFF'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

---------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - index with additional keys not improving record selectivity
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription              = N'Chk Key Selectivity'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.obj_type_short_label   NOT IN (N'HST',N'IT')       -- Not a system maintained history or internal table
   AND i.low_selectivity_additional_keys IS NOT NULL
   AND i.prescription LIKE N'Retain%'            -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - unneeded key columns pt 2'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - index with column collations not matching database collation
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT DISTINCT
       i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Check Collation'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
    ON i.database_id                        = ic.database_id
   AND i.object_id                          = ic.object_id
   AND i.index_id                           = ic.index_id
   AND i.type                               = ic.type
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]       AS c
    ON ic.database_id                       = c.database_id
   AND ic.object_id                         = c.object_id
   AND ic.column_id                         = c.column_id
 WHERE i.obj_type_short_label   NOT IN (N'HST',N'IT')       -- Not a system maintained history or internal table
   AND c.collation_name                    IS NOT NULL
   AND c.uses_database_collation            = 0
   ---------------------------------------------------------
   AND i.prescription         LIKE N'Retain%'    -- NOTE: no leading "%", filters out MISSING indexES

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - match index column collation to database collation'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Big included columns
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Check Incl Len'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.obj_type_short_label   NOT IN (N'HST',N'IT')       -- Not a system maintained history or internal table
   ---------------------------------------------------------
   AND inc_total_datatype_length_bytes >= 128
   ---------------------------------------------------------
   AND prescription   LIKE N'Retain%';           -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - index with BIG included columns'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Nonclustered Columnstores - to replace nonclustered rowstores need to add index key columns
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Add IDX key columns'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type = N'I'
   AND i.type    IN (N'6')
   AND CHARINDEX(N'<IDXKEY>',i.included_column_info) > 0

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - add Replaced NCX KEY columns to existing NCS index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Non-Partitioned Table and LOCK_ESCALATION is DISABLED - should be AUTO or TABLE
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription =  N'Enable Auto Lock Esc'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
 WHERE obj_type_short_label NOT IN (N'HST',N'IT')   -- Not a system maintained history or internal table
   AND partition_Column_ID  IS NULL
   AND tbl_lock_escalation  = 1
   ---------------------------------------------------------
   AND (   prescription LIKE N'Retain%'          -- NOTE: no leading "%"
        OR prescription IS NULL
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - Non-Partitioned Table and LOCK_ESCALATION is DISABLED'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Partitioned Table and LOCK_ESCALATION is TABLE or DISABLE - should be AUTO
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription =  N'Enable Auto Lock Esc'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       ) AS p
 WHERE obj_type_short_label       NOT IN (N'HST',N'IT')   -- Not a system maintained history or internal table
   AND partition_Column_ID            > 0
   AND tbl_lock_escalation            < 2
   ---------------------------------------------------------
   AND (   prescription LIKE N'Retain%'          -- NOTE: no leading "%"
        OR prescription IS NULL
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - Partitioned Table and LOCK_ESCALATION is TABLE or DISABLE'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - SQL Table-Valued Functions with Clustered index that is not UNIQUE
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'TVF Unique IDX'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.parent_object_type        = N'TF'
   AND i.type                     IN (N'1')
   AND i.is_unique                 = 0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refactor - SQL Table-Valued Functions with Clustered index that is not UNIQUE'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Consider Index Stats NoRecompute due to high volumes of data changes
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refactor'
      ,sort         = @srt
      ,prescription = N'Stats NoRecompute?'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type = N'I'
   AND i.type    IN (N'1',N'2') -- HEAPS handled separately.
   AND i.stats_no_recompute = 0
   AND IIF(i.stathdr_Rows_CNT > 0
          ,100.0 * i.Stats_Prop_modification_CNT / i.stathdr_Rows_CNT
          ,IIF(i.row_CNT > 0
              ,100.0 * i.ops_total_write_CNT     / i.row_CNT
              ,0.0)
          ) >= 25.0;

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFACTOR - Consider Database AUTO_UPDATE_STATISTICS_ASYNC due to high volumes of data changes
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id      = i.database_id
      ,parent_object_id = i.database_id
      ,object_id        = i.database_id
      ,index_id         = i.database_id
      ,type             = N'DB'
      ,N'Refactor'
      ,sort             = @srt
      ,prescription = N'Enable UPD_STATS_ASYNC'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
 WHERE i.rec_type = N'I'
   AND i.type    IN (N'1',N'2') -- HEAPS handled separately.
   AND i.stats_no_recompute = 0
   AND IIF(i.stathdr_Rows_CNT > 0
          ,100.0 * i.Stats_Prop_modification_CNT / i.stathdr_Rows_CNT
          ,IIF(i.row_CNT > 0
              ,100.0 * i.ops_total_write_CNT     / i.row_CNT
              ,0.0)
          ) > 25.0
 GROUP BY
       i.database_id;

/******************************************************************************************************************************************\
-- Update REFACTOR
\******************************************************************************************************************************************/
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = COALESCE(i.prescription + NCHAR(92),N'')
                    + N'Refactor'
                    + (--
                       SELECT NCHAR(92) + N' ' + rex.prescription
                         FROM #prescription     AS rex
                        WHERE i.database_id      = rex.database_id
                          AND i.parent_object_id = rex.parent_object_id
                          AND i.object_ID        = rex.object_ID
                          AND i.index_ID         = rex.index_ID
                          AND i.type             = rex.type
                          AND N'Refactor'        = rex.action_desc
                        ORDER BY
                              rex.srt
                          FOR XML PATH(N''), TYPE
                      ).value('(./text())[1]',N'NVARCHAR(4000)')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT DISTINCT
               database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
          FROM #prescription
         WHERE action_desc = N'Refactor'
       )                 AS ref
    ON i.database_id      = ref.database_id
   AND i.parent_object_id = ref.parent_object_id
   AND i.object_ID        = ref.object_ID
   AND i.index_ID         = ref.index_ID
   AND i.type             = ref.type
 WHERE i.prescription LIKE N'Retain%';           -- only want to Refresh indexes marked to RETAIN

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Apply refactor label to indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cleanup applied prescriptions
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE FROM #prescription WHERE action_desc = N'Refactor'; -- already updated appropriate values

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clean up interim results table - Refactor'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - index to remove/replace has Non-Persisted Computed Column in definition
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'IDX has Non Prst Col'

  FROM (-- Computed columns not persisted
        SELECT database_id
              ,object_id
              ,column_id
          FROM [tempdb].[dbo].[SQLXL_Index_column]
         WHERE computed_column_definition IS NOT NULL
           AND is_persisted                = 0
       ) AS cp
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
    ON cp.database_id                          = ic.database_id
   AND cp.object_id                            = ic.object_id
   AND cp.column_id                            = ic.column_id
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
    ON ic.database_id                          = i.database_id
   AND ic.object_id                            = i.object_id
   AND ic.index_id                             = i.index_id
   AND ic.type                                 = i.type
 WHERE i.prescription LIKE N'Remove%'
    OR i.prescription LIKE N'Replace%';

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - index to Remove has Non-Persisted Computed Column'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - indexes with non-default properties - Ignored in optimization ENABLED
-- REVIEW - indexes with non-default properties - Is Hypothetical
-- REVIEW - indexes with non-default properties - Is Disabled
-- REVIEW - indexes with non-default properties - Duplicate keys are ignored
-- REVIEW - indexes with non-default properties - Duplicate key messages are suppressed
-- REVIEW - indexes with non-default properties - Compression delay > 0
-- REVIEW - indexes with non-default properties - index was Auto created
-- REVIEW - indexes with non-default properties - constraint NOT ENFORCED
-- NOTE - indexes with non-default properties. allow_row_locks, allow_page_locks covered in REFRESH
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Review'
      ,sort         = @srt
      ,prescription = STUFF(-- Strip off leading unnecessary characters
                           + IIF(i.is_ignored_in_optimization = 1,NCHAR(92) + N' Ignored in optimization',N'')
                           + IIF(i.is_hypothetical            = 1,NCHAR(92) + N' Hypothetical',N'')
                           + IIF(i.is_disabled                = 1,NCHAR(92) + N' Disabled',N'')
                           + IIF(i.ignore_dup_key             = 1,NCHAR(92) + N' Dupl keys ignored',N'')
                           + IIF(i.suppress_dup_key_messages  = 1,NCHAR(92) + N' Dupl key msg suppressed',N'')
                           + IIF(i.compression_delay_mm       > 0
                                ,NCHAR(92) + N' Compression delay ' + TRY_CAST(i.compression_delay_mm AS NVARCHAR(20))
                                ,N'')
                           + IIF(i.auto_created               = 1,NCHAR(92) + N' Auto created',N'')
                           + IIF(kc.is_enforced               = 0,NCHAR(92) + kc.type + N' Constraint NOT ENFORCED',N'')
                           ,1,2,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_key_constraints] AS kc
    ON i.database_id               = kc.database_id
   AND i.parent_object_id          = kc.parent_object_id
   AND i.object_id                 = kc.object_id
   AND TRY_CAST(i.index_id AS INT) = kc.unique_index_id
 WHERE i.rec_type              = N'I'
   AND TRY_CAST(i.type AS INT) > 0
   AND (   i.prescription LIKE N'Retain%'
        OR i.prescription LIKE N'Remove%'
       )
   AND i.obj_type_short_label        NOT IN (N'HST',N'IT',N'TVF')
   AND (   i.is_ignored_in_optimization = 1
        OR i.is_hypothetical            = 1
        OR i.is_disabled                = 1
        OR i.ignore_dup_key             = 1
        OR i.suppress_dup_key_messages  = 1
        OR i.compression_delay_mm       > 0
        OR i.auto_created               = 1
        OR kc.is_enforced               = 0
       );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - index with non-default properties - ignore, hypo, disabled, dupl keys, comp delay, auto created'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - indexes with resumable operations
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Resumable operation'
  FROM [tempdb].[dbo].[SQLXL_Index_sys_index_resumable_operations] AS r
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_indexes]                    AS i
    ON r.database_id                                        = i.database_id
   AND r.object_id                                          = i.object_id
   AND r.index_id                                           = i.index_id
   AND TRY_CAST(i.type AS INT) > 0;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - index with resumable operations'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Retained Foreign Key Constraints that are uncovered by an index
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Covering IX? No MIX'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.type = N'F'
   AND prescription LIKE N'Retain%'
   AND i.fkc_covered_by_idx_IDS IS NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - uncovered FKC'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Clustered indexes that are not UNIQUE
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription  = N'Make CX Uniq'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE type                           = N'1'                -- clustered index
   AND is_unique                      = 0
   AND i.obj_type_short_label         NOT IN (N'HST',N'IT') -- Not a system maintained history table or internal table

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - CX that are not UNIQUE'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Views that do not have a Clustered index
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription  = N'Add index?'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.obj_type               = N'V' -- View
   AND i.type                   = N'0'

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - Views that do not have a CX'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Lo/No activity or Empty
-- If statistics recently updated show here
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = STUFF( IIF(COALESCE(row_CNT,0) = 0
                                ,N' Empty IDX'
                                ,N'')
                           + IIF(    type NOT IN (N'4',N'F')          -- no Foreign Key or SPATIAL
                                 AND COALESCE(ius_User_total_CNT,0) = 0 -- no Usage activity
                                ,N' No activity'
                                ,N'')
                           ,1,1,N'')
                    + IIF(    stathdr_Rows_CNT             >  0  -- special case of no activity
                          AND stathdr_Statistics_age_days <= 30  -- and recently updated statistics
                         ,NCHAR(92) + N' Has statistics'
                         ,N'')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE 1 = 1
   AND parent_object_type             NOT IN (N'VW',N'TVF')
   AND tbl_is_memory_optimized          = 0
   ---------------------------------------------------------
   AND NOT type                         = N'4'              -- Spatial ain't got index usage metrics
   ---------------------------------------------------------
   AND (  TRY_CAST(type AS INT)        >= 0
        OR type                         = N'M'
       )
   AND (   (    COALESCE(ius_User_total_CNT    ,0) = 0
            AND COALESCE(ops_total_contacts_CNT,0) = 0
           )
        OR COALESCE(row_CNT           ,0) = 0
       )
   ---------------------------------------------------------
   AND prescription   NOT LIKE N'Remove%'
   AND prescription   NOT LIKE N'Reject%'
   ---------------------------------------------------------
   AND obj_type_short_label           NOT IN (N'HST',N'IT',N'TVF');

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - Low or NO activity, or empty'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Missing indexes with Large Advantage and significant Usage, but may have an NCX that they could roll up to
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Similar NCX'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE type                          = N'M'                 -- Missing index
   ------------------------------------------
   AND prescription LIKE N'Request' + NCHAR(92) + N' MIX Hi Gain%' -- Keep ACTION in synch
   AND EXISTS (--
               SELECT NULL
                 FROM [tempdb].[dbo].[SQLXL_Index_Synergies] AS o
                WHERE database_id                     = o.database_id
                  AND parent_object_id                = o.parent_object_id
                  AND index_ID                        = o.l_index_id
                  AND type                            = o.l_type
                  AND N'2'                            = o.r_type
              );

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - MIX that can roll up to existing/new NCS'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Lead Key element is a big STRING
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Lead big ' + i.Lead_Element_Data_Type
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE i.type                     IN (N'1',N'2')
   AND i.obj_type_short_label NOT IN (N'HST',N'IT') -- Not a system maintained history table or internal table
   --------------------------------------------
   AND (   Lead_Element_Max_Len > 16
        OR Lead_Element_Max_Len = -1
       )
   AND (   prescription LIKE N'Retain%'
        OR prescription LIKE N'Request%'
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - Lead Key element is a big STRING'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - index to be replaced by Nonclustered Columnstore has 1 or more non-lead keys that are big STRINGS
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Idx has big keys'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 CROSS
 APPLY (--
        SELECT COUNT(1)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_index_columns] AS ic
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_columns]       AS c
            ON ic.database_id                          = c.database_id
           AND ic.object_id                            = c.object_id
           AND ic.column_id                            = c.column_id
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_types]         AS t
            ON c.database_id                           = t.database_id
           AND c.user_type_id                          = t.user_type_id
         WHERE i.database_id                           = ic.database_id
           AND i.object_id                             = ic.object_id
           AND i.index_id                              = ic.index_id
           AND i.type                                  = ic.type
           AND 0                                       = ic.is_included_column
           AND (   (t.name  = N'NVARCHAR' AND c.max_length > 16)
                OR (t.name <> N'NVARCHAR' AND c.max_length > 32)
                OR c.max_length = -1
               )
       ) AS c(cnt)
 WHERE 1 = 1
   AND i.prescription        LIKE N'Replace%'
   AND i.obj_type_short_label NOT IN (N'HST',N'IT')     -- Not a system maintained history table or internal table
   AND c.cnt                    > 0

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - index to be replaced by NCS has included big STRING'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - index to be Removed or Replaced by Nonclustered Columnstore that are filtered
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription  = N'Filtered IDX'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE (   COALESCE(prescription,N'') LIKE N'Remove%'
        OR COALESCE(prescription,N'') LIKE N'Replace%'
       )
   AND i.has_filter = 1;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - index to be replaced by NCS is filtered'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - index with Page Compression Failures > 40 Percent
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Chk PageCompress'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE ios_page_compression_fail_PCT > 40
   --------------------------------------
   AND prescription LIKE N'Retain%'           -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - index with Page Compression Failures > 40 Percent'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Potential Temporary Parents & indexes
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT DISTINCT
       f.database_id
      ,f.parent_object_id
      ,f.object_id
      ,f.index_id
      ,f.type
      ,N'Review'
      ,sort         = @srt
      ,prescription =  N'Check Temp Object'
  FROM (-- get list of all objects previously flagged as potentially temporary
        SELECT DISTINCT
               database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
          FROM [tempdb].[dbo].[SQLXL_Index_Diagnostics]
         WHERE diagnostic = N'[POTENTIAL TEMPORARY OBJECT]'
       ) f
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
    ON f.database_id                     = i.database_id
   AND f.parent_object_id                = i.parent_object_id
   AND f.object_id                       = i.object_id
   AND f.index_id                        = i.index_id
   AND f.type                            = i.type
 WHERE i.prescription LIKE N'Retain%'                         -- NOTE: no leading "%"
    OR i.rec_type        = N'P'

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - Potential Temporary Parents & indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Potential Filtered Index
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT DISTINCT
       f.database_id
      ,f.parent_object_id
      ,f.object_id
      ,f.index_id
      ,f.type
      ,N'Review'
      ,sort         = @srt
      ,prescription =  N'Possible Filter'
  FROM (-- get list of all objects previously flagged as potentially temporary
        SELECT DISTINCT
               database_id
              ,parent_object_id
              ,object_id
              ,index_id
              ,type
          FROM [tempdb].[dbo].[SQLXL_Index_Diagnostics]
         WHERE diagnostic LIKE N'%add filter?%'
       ) f
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
    ON f.database_id                     = i.database_id
   AND f.parent_object_id                = i.parent_object_id
   AND f.object_id                       = i.object_id
   AND f.index_id                        = i.index_id
   AND f.type                            = i.type
 WHERE (   i.prescription LIKE N'Retain%'        -- NOTE: no leading "%"
        OR i.prescription LIKE N'Request%'       -- NOTE: no leading "%"
       )
    OR i.rec_type                   = N'P'

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - Potential Filtered Index'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Synergies found on RETAIN, REJECT indexes
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Review'
      ,sort         = @srt,
       STUFF(-- Strip off leading unnecessary characters
              IIF(s.seq_CNT > 0,NCHAR(92) + N' Synergy: Sequence' ,N'')
            + IIF(s.ovl_CNT > 0,NCHAR(92) + N' Synergy: Overlap' ,N'')
            + IIF(s.con_CNT > 0,NCHAR(92) + N' Synergy: Contained',N'')
            ,1,2,N'')
  FROM (-- get all index-level records
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
  JOIN (--
        SELECT database_id
              ,parent_object_id
              ,index_id = r_index_id
              ,type     = r_type
              ,seq_CNT = SUM(IIF(matching_sequence_CNT  > 0,1,0))
              ,ovl_CNT = SUM(IIF(matching_overlap_CNT   > 0,1,0))
              ,con_CNT = SUM(IIF(matching_contained_CNT > 0,1,0))
          FROM [tempdb].[dbo].[SQLXL_Index_Synergies]
         WHERE l_type <> N'F' -- foreign key previously reported
           AND r_type <> N'F' -- foreign key previously reported
         GROUP BY
               database_id
              ,parent_object_id
              ,r_index_id
              ,r_type
        HAVING SUM(IIF(matching_sequence_CNT  > 0,1,0)) > 0
            OR SUM(IIF(matching_overlap_CNT   > 0,1,0)) > 0
            OR SUM(IIF(matching_contained_CNT > 0,1,0)) > 0
       )                 AS s
    ON i.database_id      = s.database_id
   AND i.parent_object_id = s.parent_object_id
   AND i.object_id        = s.parent_object_id
   AND i.index_ID         = s.index_id
   AND i.type             = s.type
 WHERE i.obj_type         = N'U'
   AND i.type IN (N'2' -- nonclustered rowstore
                 ,N'F' -- missing
                 ,N'M' -- foreign key
                 )
   AND i.prescription NOT LIKE N'Replace%';        -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - Synergies found on RETAIN, REJECT indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - index - Auto Created
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Auto Created'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type     = N'I'
   AND auto_created = 1
   --------------------------------------
   AND prescription LIKE N'Retain%';           -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - indexes Auto Created'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - Index - STATISTICS NORECOMPUTE enabled and low stats writes
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Stats NoRecompute'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND type    IN (N'1',N'2') -- HEAPS handled separately
   AND IIF(stathdr_Rows_CNT > 0
          ,100.0 * Stats_Prop_modification_CNT / stathdr_Rows_CNT
          ,0.0) < 5.0
   AND stats_no_recompute = 1;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - STATISTICS NORECOMPUTE enabled, low writes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REVIEW - SQL Table Valued Function - Check ORDER BY
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Review'
      ,sort         = @srt
      ,prescription = N'Check ORDER BY'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type  = N'I'
   AND type      = N'0'
   AND obj_type IN (N'FT',N'IF')
   AND prescription IS NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Review - SQL Table Valued Function - Check ORDER BY'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Update REVIEW
\******************************************************************************************************************************************/
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = COALESCE(i.prescription + NCHAR(92),N'')
                    + N'Review'
                    + (--
                       SELECT NCHAR(92) + N' ' + rex.prescription
                         FROM #prescription    AS rex
                        WHERE i.database_id                = rex.database_id
                          AND i.parent_object_id           = rex.parent_object_id
                          AND i.object_ID                  = rex.object_ID
                          AND i.index_ID                   = rex.index_ID
                          AND i.type                       = rex.type
                          AND N'Review'                    = rex.action_desc
                        ORDER BY
                              rex.srt
                          FOR XML PATH(N''), TYPE
                      ).value('(./text())[1]',N'NVARCHAR(4000)')
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type IN (N'I',N'P')
       ) AS i
  JOIN (--
        SELECT DISTINCT
               database_id,parent_object_id,object_id,index_id,TYPE
          FROM #prescription
         WHERE action_desc = N'Review'
       ) ref
    ON i.database_id      = ref.database_id
   AND i.parent_object_id = ref.parent_object_id
   AND i.object_ID        = ref.object_ID
   AND i.index_ID         = ref.index_ID
   AND i.type             = ref.type;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Apply Review label to indexes'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cleanup
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE FROM #prescription WHERE action_desc = N'Review'; -- already updated appropriate values

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clean up interim results table - Review'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
** REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRESH REFRES **
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - Columnstores with > 1024 Deleted rows or > 2048 Open rows
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = STUFF( IIF(cs.deleted_rows_CNT > 8192
                                , NCHAR(92)
                                + IIF(i.type = N'5' -- clustered columnstore
                                     ,N'CCS'
                                     ,N'NCS')
                                + N' Deleted rows'
                                ,N'')
                           + IIF(cs.open_rows_CNT > 8192
                                , NCHAR(92)
                                + IIF(i.type = N'5'  -- clustered columnstore
                                     ,N'CCS'
                                     ,N'NCS')
                                + N' Open delta rows'
                                ,N'')
                            ,1,1,N'')
  FROM (--
        SELECT database_id
              ,object_id
              ,index_id
              ,open_rowgroup_CNT    = SUM(CASE WHEN state_desc   = N'OPEN' THEN 1 ELSE 0 END)
              ,open_rows_CNT        = SUM(CASE WHEN state_desc   = N'OPEN' THEN total_rows ELSE 0 END)
              ,deleted_rowgroup_CNT = SUM(CASE WHEN deleted_rows > 0       THEN 1 ELSE 0 END)
              ,deleted_rows_CNT     = SUM(deleted_rows)
          FROM [tempdb].[dbo].[SQLXL_Index_sys_dm_db_column_store_row_group_physical_stats]
         GROUP BY
               database_id
              ,object_id
              ,index_id
        HAVING SUM(deleted_rows) > 8192
            OR SUM(CASE WHEN state_desc = N'OPEN' 
                        THEN total_rows 
                        ELSE 0 
                   END)          > 8192
       ) AS cs
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
    ON cs.database_id = i.database_id
   AND cs.object_id   = i.object_id
   AND cs.index_id    = i.index_id
   AND i.type        IN (N'5'   -- clustered columnstore
                        ,N'6'); -- nonclustered columnstore

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - Columnstores with > 1024 Deleted rows or > 2048 Open rows'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - index takes up more buffer than reserved size - opportunity for cleanup
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = N'BUF > Rsrvd Size'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE 1 = 1
   AND prescription  LIKE N'Retain%'              -- NOTE: no leading "%", filters out MISSING indexes
   AND i.buffer_total_KB_CNT > (1.1 * i.reserved_page_PG_CNT * 8.0)

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - index takes up more buffer than reserved size'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - Buffer Free > 20%
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt        INT      = 0
       ,@ssms_ads       TINYINT  = 1
       ,@msg      NVARCHAR(1000)
       ,@exec_dttm DATETIME = GETDATE()
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = N'BUF free > 20%'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND tbl_is_memory_optimized = 0 -- exclude memoryoptimized
   AND buffer_total_KB_CNT > 0.0
   AND prescription  LIKE N'Retain%' -- NOTE: no leading "%", filters out MISSING indexes
   AND 100.0 * buffer_free_KB_CNT / buffer_total_KB_CNT > 20.0; -- /zero handled by WHERE clause element above

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - index Buffer Free > 20 percent'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - statistics over 30 days old
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt        INT      = 0
       ,@ssms_ads       TINYINT  = 1
       ,@msg      NVARCHAR(1000)
       ,@exec_dttm DATETIME = GETDATE()
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = N'Old Stats'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE 1 = 1
   AND prescription  LIKE N'Retain%'             -- NOTE: no leading "%", filters out MISSING indexes
   AND obj_type_short_label NOT IN (N'HST',N'IT')           -- Not a system maintained history table -or- Internal table
   AND TRY_CAST(i.type AS INT)     >  0
   AND row_CNT                     >  0
   AND stathdr_Statistics_age_days > 30;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - statistics over 30 days old'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - statistics <= 30 days old and stats row count +/- 0.5% different than index row count
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt        INT      = 0
       ,@ssms_ads       TINYINT  = 1
       ,@msg      NVARCHAR(1000)
       ,@exec_dttm DATETIME = GETDATE()
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = N'Stats Row Delta'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND TRY_CAST(type AS INT)        >  0
   AND stathdr_Statistics_age_days <= 30 -- NOTE: stats over 30 days old handled separately
   AND row_CNT                      >  0
   AND stathdr_Rows_CNT             >  0
   AND (   ABS(100.0 * (row_CNT - stathdr_Rows_CNT) / row_CNT)          > 1.0 -- /zero handled by WHERE clause above
        OR ABS(100.0 * (stathdr_Rows_CNT - row_CNT) / stathdr_Rows_CNT) > 1.0 -- /zero handled by WHERE clause above
       )
   ---------------------------------------------------------
   AND prescription LIKE N'Retain%';     -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - statistics <= 30 days old and stats row count +/- 1pct different than index row count'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - statistics <= 30 days old and stats modification_counter > 0.5% index row count
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = N'Stats Row Delta'
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
 WHERE rec_type = N'I'
   AND TRY_CAST(type AS INT)        >  0
   AND stathdr_Statistics_age_days <= 30 -- NOTE: stats over 30 days old handled separately
   AND row_CNT                      >  0
   AND Stats_Prop_modification_CNT  >  0
   AND ABS(100.0 * Stats_Prop_modification_CNT / row_CNT) > 0.5  -- /zero handled by WHERE clause above
   ---------------------------------------------------------
   AND prescription LIKE N'Retain%';     -- NOTE: no leading "%"

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - statistics <= 30 days old and stats modification_counter > 0.5pct index row count'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- REFRESH - Statistics not computed on Rowstore Clustered and Nonclustered, XML, and Spatial indexes
--------------------------------------------------------------------------------------------------------------------------------------------
SET @srt += 1;
INSERT
  INTO #prescription
/*** LOCAL TESTING ***
DECLARE @srt INT = 0;
--*/
SELECT database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,N'Refresh'
      ,sort         = @srt
      ,prescription = N'No Stats'
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE TRY_CAST(type AS INT)    BETWEEN 1 AND 3             -- no HEAPS, Spatial, Clustered ColStore, NonClustered ColStore, FulltText
   AND obj_type_short_label NOT IN (N'HST',N'IT',N'TVF')    -- Not a system maintained history table or table valued function
   ---------------------------------------------------------
   AND stathdr_Statistics_age_days    IS NULL
   ---------------------------------------------------------
   AND prescription       LIKE N'Retain%'        -- NOTE: no leading "%"
   AND CHARINDEX(N'Refresh',prescription) = 0;   -- don't need if already called out for Refresh

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Refresh - Statistics not computed on CX, NCX, XML, SPT'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Update REFRESH
\******************************************************************************************************************************************/
UPDATE i
   SET
/*** LOCAL TESTING ***
--SET ANSI_WARNINGS ON;
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = COALESCE(i.prescription + NCHAR(92),N'')
                    + N'Refresh'
                    + (--
                       SELECT TOP 1
                              NCHAR(92) + N' ' + rex.prescription
                         FROM #prescription AS rex
                        WHERE i.database_id             = rex.database_id
                          AND i.parent_object_id        = rex.parent_object_id
                          AND i.object_ID               = rex.object_ID
                          AND i.index_ID                = rex.index_ID
                          AND i.type                    = rex.type
                          AND N'Refresh'               = rex.action_desc
                        ORDER BY
                              rex.srt
                          FOR XML PATH(N''), TYPE
                       ).value('(./text())[1]',N'NVARCHAR(4000)')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i -- NOTE: parents can be REFACTORED too
  JOIN (--
        SELECT DISTINCT
               database_id,parent_object_id,object_id,index_id,TYPE
          FROM #prescription
         WHERE action_desc = N'Refresh'
       ) AS ref
    ON i.database_id      = ref.database_id
   AND i.parent_object_id = ref.parent_object_id
   AND i.object_ID        = ref.object_ID
   AND i.index_ID         = ref.index_ID
   AND i.type             = ref.type;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Apply Refresh label to indexes '
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Cleanup
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE FROM #prescription WHERE action_desc = N'Refresh'; -- already updated appropriate values

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clear out interim results table - Refresh'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Flag indexes not ACTIONed
--------------------------------------------------------------------------------------------------------------------------------------------
UPDATE i
   SET
/*** LOCAL TESTING ***
SELECT i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type,
--*/
       prescription = N'TBD ' + obj_type_hdr + NCHAR(92) + type_short_desc
  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'I'
       ) AS i
 WHERE TRY_CAST(type AS INT) >= 0
   AND i.prescription        IS NULL

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Flag indexes without a prescription'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

--------------------------------------------------------------------------------------------------------------------------------------------
-- Delete all empty Diagnostics
--------------------------------------------------------------------------------------------------------------------------------------------
DELETE
  FROM [tempdb].[dbo].[SQLXL_Index_Diagnostics]
 WHERE diagnostic IS NULL;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Clear out empty interim diagnostic records'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
** PRESCRIPTION PRIORITY PRESCRIPTION PRIORITY PRESCRIPTION PRIORITY PRESCRIPTION PRIORITY PRESCRIPTION PRIORITY PRESCRIPTION PRIORITY PR **
\******************************************************************************************************************************************/
/* Priority Elements
Waits

*/
UPDATE p
   SET
/*** LOCAL TESTING ***
DECLARE @Prio_wait_time                   SMALLINT = 100
       ,@Prio_wait_count                  SMALLINT =  50
       ,@Prio_locks                       SMALLINT =  20
       ,@Prio_lock_promotions             SMALLINT =  60
       ,@Prio_lock_promotion_fails        SMALLINT =  80
       ,@Prio_page_splits                 SMALLINT =  30
       ,@Prio_page_merges                 SMALLINT =  30
       ,@Prio_OPS_forwarded_fetches       SMALLINT =  30
       ,@Prio_missing_indexes             SMALLINT =  80
       ,@Prio_OPS_writes                  SMALLINT =  30
       ,@Prio_buffer_cache_used           SMALLINT =  80
       ,@Prio_OPS_read_write_ratio        SMALLINT =  15 -- Note: starts with 4X as the "zero" value and works backwards from there
       ,@Prio_reads                       SMALLINT =  10
       ,@Prio_scans                       SMALLINT =  40
       ,@Prio_lookups                     SMALLINT =  60
       ,@Prio_LOB                         SMALLINT =  80
       ,@xtp_Priority_deflator            SMALLINT =  50 -- since activities in memory much faster than disk

--SELECT p.database_id,p.parent_object_id,p.object_id,p.obj_type,p.obj_name,
UPDATE p
   SET
--*/
       tbl_priority_metric =
-- Waiting (19) -------------------------------------------------
 IIF(a.ops_total_wait_MS_CNT       > 0,1.0 * COALESCE(p.ops_total_wait_MS_CNT      ,0) / a.ops_total_wait_MS_CNT      ,0) * @Prio_wait_time
 --  ios: row_lock_wait_in_ms, page_lock_wait_in_ms, page_latch_wait_in_ms, page_io_latch_wait_in_ms
 --  ios: subsets: tree_page_latch_wait_in_ms, tree_page_io_latch_wait_in_ms
 -- rgos: row_group_lock_wait_in_ms
 --  xtp: (FUTURE <BS>) new_log_wait_time_in_ms, total_wait_time_in_ms, io_wait_time_in_ms

+IIF(a.ops_total_wait_CNT          > 0,1.0 * COALESCE(p.ops_total_wait_CNT         ,0) / a.ops_total_wait_CNT         ,0) * @Prio_wait_count
 --  ios: row_lock_wait_count, page_lock_wait_count, page_latch_wait_count, page_io_latch_wait_count
 --  ios: subsets: tree_page_latch_wait_count, tree_page_io_latch_wait_count
 -- rgos: row_group_lock_wait_count
 --  xtp: (FUTURE <BS>) waits_for_io_count, waits_for_new_log_count

-- Locks (4) -------------------------------------------------
+IIF(a.ops_total_lock_CNT          > 0,1.0 * COALESCE(p.ops_total_lock_CNT         ,0) / a.ops_total_lock_CNT         ,0) * @Prio_locks
 --  ios: row_lock_count, page_lock_count
 -- rgos: row_group_lock_count
+IIF(a.ios_lock_promotion_CNT      > 0,1.0 * COALESCE(p.ios_lock_promotion_CNT     ,0) / a.ios_lock_promotion_CNT     ,0) * @Prio_lock_promotions
 -- ios: index_lock_promotion_attempt_count
+IIF(a.ios_lock_promotion_fail_CNT > 0,1.0 * COALESCE(p.ios_lock_promotion_fail_CNT,0) / a.ios_lock_promotion_fail_CNT,0) * @Prio_lock_promotion_fails
 -- ios: index_lock_promotion_attempt_count - index_lock_promotion_count 

-- Splits (7) ----------------------------------------------------
+IIF(a.ops_total_page_split_CNT > 0,1.0 * COALESCE(p.ios_leaf_allocation_CNT    ,0) / a.ops_total_page_split_CNT,0) * @Prio_page_splits
+IIF(a.ops_total_page_split_CNT > 0,1.0 * COALESCE(p.ios_nonleaf_allocation_CNT ,0) / a.ops_total_page_split_CNT,0) * @Prio_page_splits
+IIF(a.ops_total_page_split_CNT > 0,1.0 * COALESCE(p.ios_column_value_push_off_row_CNT,0) / a.ops_total_page_split_CNT,0) * @Prio_page_splits
 --  ios: nonleaf_allocation_count, leaf_allocation_count, column_value_push_off_row_count
+IIF(a.ops_total_page_split_CNT > 0,1.0 * COALESCE(p.xtp_page_split_CNT ,0) / a.ops_total_page_split_CNT,0) * @Prio_page_splits / @xtp_Priority_deflator
+IIF(a.ops_total_page_split_CNT > 0,1.0 * COALESCE(p.xtp_key_split_CNT  ,0) / a.ops_total_page_split_CNT,0) * @Prio_page_splits / @xtp_Priority_deflator
 --  xtp: page_split_count, page_split_retry_count
 --       key_split_count, key_split_retry_count

-- Merges (7) --------------------------------------------------------
+IIF(a.ops_total_page_merge_CNT > 0,1.0 * COALESCE(p.ios_leaf_page_merge_CNT          ,0) / a.ops_total_page_merge_CNT,0) * @Prio_page_merges
+IIF(a.ops_total_page_merge_CNT > 0,1.0 * COALESCE(p.ios_nonleaf_page_merge_CNT       ,0) / a.ops_total_page_merge_CNT,0) * @Prio_page_merges
+IIF(a.ops_total_page_merge_CNT > 0,1.0 * COALESCE(p.ios_column_value_pull_in_row_CNT ,0) / a.ops_total_page_merge_CNT,0) * @Prio_page_merges
 --  ios: nonleaf_page_merge_count, leaf_page_merge_count, column_value_pull_in_row_count
+IIF(a.ops_total_page_merge_CNT > 0,1.0 * COALESCE(p.xtp_page_merge_CNT ,0) / a.ops_total_page_merge_CNT,0) * @Prio_page_merges / @xtp_Priority_deflator
+IIF(a.ops_total_page_merge_CNT > 0,1.0 * COALESCE(p.xtp_key_merge_CNT  ,0) / a.ops_total_page_merge_CNT,0) * @Prio_page_merges / @xtp_Priority_deflator
+IIF(a.ops_total_page_merge_CNT > 0,1.0 * COALESCE(p.xtp_page_consolidation_CNT ,0) / a.ops_total_page_merge_CNT  ,0) * @Prio_page_merges / @xtp_Priority_deflator -- reduced locking on physical I/O
 --  xtp: page_merge_count, page_merge_retry_count
 --       key_merge_count, key_merge_retry_count
 --       page_consolidation_count, page_consolidation_retry_count

-- Missing index Advantage (8) - total read Weighted -----------------------------------
+IIF(a.mix_Advantage_weighted_AMT  > 0,1.0 * COALESCE(p.mix_Advantage_weighted_AMT ,0) / a.mix_Advantage_weighted_AMT,0) * @Prio_missing_indexes
 -- MIX: avg_total_system_cost, avg_total_user_cost, avg_system_impact, avg_user_impact, system_seeks, system_scans, user_seeks, user_scans

-- Writes (19) Excludes Splits & Merges computed above ------------------------------
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_leaf_insert_CNT              ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_leaf_update_CNT              ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_leaf_delete_CNT              ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_leaf_ghost_CNT               ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_nonleaf_insert_CNT           ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_nonleaf_update_CNT           ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_nonleaf_delete_CNT           ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_lob_orphan_create_CNT        ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_lob_orphan_insert_CNT        ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_column_value_push_off_row_CNT,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.ios_column_value_pull_in_row_CNT ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
 -- ios: leaf_insert_count, leaf_update_count, leaf_delete_count, leaf_ghost_count, 
 --      nonleaf_insert_count, nonleaf_update_count, nonleaf_delete_count, 
 --      lob_orphan_create_count, lob_orphan_insert_count, column_value_pull_in_row_count, column_value_push_off_row_count
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.cs_row_group_lock_CNT ,0) / a.ops_total_write_CNT,0) * @Prio_OPS_writes
 --  cs: row_group_lock_count - surrogate for writes since there is no direct metric

-- [sys].[dm_db_xtp_object_stats]
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_row_insert_attempts_CNT,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_row_update_attempts_CNT,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_row_delete_attempts_CNT,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_write_conflicts_CNT    ,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_unique_constraint_violations_CNT,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
-- [sys].[dm_db_xtp_index_stats]
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_page_update_CNT             ,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
+IIF(a.ops_total_write_CNT > 0,1.0 * COALESCE(p.xtp_page_update_retry_CNT       ,0) / a.ops_total_write_CNT  ,0) * @Prio_OPS_writes / @xtp_Priority_deflator -- reduced locking on physical I/O
 --  xtp: row_insert_attempts, row_update_attempts, row_delete_attempts, write_conflicts, unique_constraint_violations
 --       page_update_count, page_update_retry_count

-- Buffer cache usage (5) - weighted by percent of table+indexes in memory times the log of the reserved size of the table+indexes
-- omit XTP InMemory/Memory Optimized ---------------------------
+COALESCE(b.mem_log,0) * @Prio_buffer_cache_used
 --  prt: reserved_page_count, in_row_reserved_page_count, lob_reserved_page_count, row_overflow_reserved_page_count
 --  buf: buffer_total_KB
-- Read to Write Ratio  ----------------------------------------
+IIF(COALESCE(p.ops_read_to_write_RAT,0) < 4.0
    ,(4.0 - COALESCE(p.ops_read_to_write_RAT,0)) * COALESCE(p.ops_write_to_instance_PCT,0)
    ,0.0)                                                                                * @Prio_OPS_read_write_ratio

-- Scans (7) -------------------------------------------------------
+IIF(a.ops_total_scan_CNT > 0, 1.0 * COALESCE(p.ius_user_scans_CNT          ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans
+IIF(a.ops_total_scan_CNT > 0, 1.0 * COALESCE(p.ius_system_scans_CNT        ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans
+IIF(a.ops_total_read_CNT > 0, 1.0 * COALESCE(p.ios_range_scan_CNT          ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans
+IIF(a.ops_total_read_CNT > 0, 1.0 * COALESCE(p.xtp_scans_started_CNT       ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans / @xtp_Priority_deflator
+IIF(a.ops_total_read_CNT > 0, 1.0 * COALESCE(p.cs_index_scan_CNT           ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans
+IIF(a.ops_total_read_CNT > 0, 1.0 * COALESCE(p.cs_scan_CNT                 ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans
+IIF(a.ops_total_read_CNT > 0, 1.0 * COALESCE(p.cs_delete_buffer_scan_CNT   ,0) / a.ops_total_scan_CNT, 0) * @Prio_scans
 --  ios: range_scan_count ius: user_scans, system_scans
 --  xtp: scans_started
 -- rgos: delete_buffer_scan_count, index_scan_count, scan_count

-- Lookups (3) -------------------------------------------------------
+IIF( COALESCE(a.ios_singleton_lookup_CNT,0) 
    + COALESCE(a.ius_user_lookups_CNT    ,0)
    + COALESCE(a.ius_system_lookups_CNT  ,0) > 0
    ,1.0 * ( COALESCE(p.ios_singleton_lookup_CNT,0) 
           + COALESCE(p.ius_user_lookups_CNT    ,0)
           + COALESCE(p.ius_system_lookups_CNT  ,0)
           ) / ( COALESCE(a.ios_singleton_lookup_CNT,0) 
               + COALESCE(a.ius_user_lookups_CNT    ,0)
               + COALESCE(a.ius_system_lookups_CNT  ,0)
               ) * @Prio_lookups
    ,0.0)
 --  ios: singleton_lookup_count
 --  ius: system_lookups, user_lookups

-- Heap Forwarded Fetches (1) ------------------
+IIF(a.ios_forwarded_fetch_CNT > 0,1.0 * COALESCE(p.ios_forwarded_fetch_CNT,0) / a.ios_forwarded_fetch_CNT ,0) * @Prio_OPS_forwarded_fetches
 --  ios: forwarded_fetch_count

-- LOB data (6) ------------------------------------------------
+IIF(( COALESCE(a.ios_lob_fetch_pages_CNT            ,0)
     + COALESCE(a.ios_lob_orphan_create_CNT          ,0) -- Bulk operations
     + COALESCE(a.ios_lob_orphan_insert_CNT          ,0) -- Bulk operations
     + COALESCE(a.ios_row_overflow_fetch_in_pages_CNT,0)
     + COALESCE(a.ios_column_value_pull_in_row_CNT   ,0)
     + COALESCE(a.ios_column_value_push_off_row_CNT  ,0)
     ) > 0
    ,1.0 * ( COALESCE(p.ios_lob_fetch_pages_CNT            ,0)
           + COALESCE(p.ios_lob_orphan_create_CNT          ,0) -- Bulk operations
           + COALESCE(p.ios_lob_orphan_insert_CNT          ,0) -- Bulk operations
           + COALESCE(p.ios_row_overflow_fetch_in_pages_CNT,0)
           + COALESCE(p.ios_column_value_pull_in_row_CNT   ,0)
           + COALESCE(p.ios_column_value_push_off_row_CNT  ,0)
           )
       /   ( COALESCE(a.ios_lob_fetch_pages_CNT            ,0)
           + COALESCE(a.ios_lob_orphan_create_CNT          ,0) -- Bulk operations
           + COALESCE(a.ios_lob_orphan_insert_CNT          ,0) -- Bulk operations
           + COALESCE(a.ios_row_overflow_fetch_in_pages_CNT,0)
           + COALESCE(a.ios_column_value_pull_in_row_CNT   ,0)
           + COALESCE(a.ios_column_value_push_off_row_CNT  ,0)
           )
     ,0) * @Prio_LOB
 --  ios: column_value_pull_in_row_count, column_value_push_off_row_count, lob_fetch_in_pages, lob_orphan_create_count, lob_orphan_insert_count
 --       row_overflow_fetch_in_pages


-- Flagged to create new NCS -------------------------------
+IIF(CHARINDEX(N'Request new NCS',p.prescription) > 0,50.0,0)  -- NOTE: keep in synch with above prescription codes

  FROM (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
           AND (   index_CNT > 0
                OR (type = N'U')
               )
       ) AS p
  LEFT OUTER
  JOIN (-- Buffer cache usage as a percent of the weighted total
        SELECT rec_type,parent_object_ID,object_id,index_id,type
              ,mem_log = (b.mem_log / SUM(b.mem_log) OVER ())
          FROM (--Buffer cache usage - weighted by percent of table+indexes in memory times the log of the reserved size of the table+indexes
                SELECT rec_type,parent_object_ID,object_id,index_id,type
                      ,mem_log = LOG(c.reserved_page_PG_CNT) * c.buffer_total_KB_CNT / (c.reserved_page_PG_CNT * 8.0)
                  FROM [tempdb].dbo.SQLXL_Index_Compilation AS c
                 WHERE c.rec_type                = N'P'
                   AND c.tbl_is_memory_optimized = 0
                   AND c.reserved_page_PG_CNT    > 0
               ) AS b
       ) AS b
    ON p.rec_type         = b.rec_type
   AND p.rec_type         = b.rec_type
   AND p.parent_object_ID = b.parent_object_ID
   AND p.object_id        = b.object_id
   AND p.index_id         = b.index_id
   AND p.type             = b.type
 CROSS
  JOIN (--
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       ) AS a;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Compute Parent Prescription Priority - Index Percent of Totals'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
 Add Priority Metric computations to Parent & Indexes - Buffer Cache
\******************************************************************************************************************************************/
SET ANSI_WARNINGS OFF;
UPDATE tgt
   SET tbl_priority_metric = CASE rec_type
                                  WHEN N'A' THEN tpma.tbl_priority_metric
                                  WHEN N'P' THEN tpmp.tbl_priority_metric
                             END
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt
  JOIN (-- subtotal table priority metric to database level. Includes record for INSTANCE (database_id = 0)
        SELECT database_id
              ,tbl_priority_metric = SUM(tbl_priority_metric)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         GROUP BY
               database_ID
       ) AS tpmp
    ON tgt.database_ID = tpmp.database_id
  LEFT OUTER
  JOIN (-- subtotal table priority metric to instance level. Includes record for INSTANCE (database_id = 0)
        SELECT database_id         = 0
              ,tbl_priority_metric = SUM(tbl_priority_metric)
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
       ) AS tpma
    ON tgt.database_ID = tpma.database_id
 WHERE tgt.rec_type IN (N'A',N'D');
SET ANSI_WARNINGS ON;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Aggregate Database & Instance Prescription Priority'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Add Priority Metric computations to Parent & Indexes - Buffer Cache
\******************************************************************************************************************************************/
-- Diagnostic - Table - Hi buffer cache usage (> 4MB reserved size, > 20% in buffer cache)
-- Diagnostic - Index - Hi buffer cache usage (> 2MB reserved size, > 20% in buffer cache)
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = N'High buffer cache used ' + [tempdb].[dbo].[SQLXL_3SD](1.0 * i.buffer_total_KB_CNT / (i.reserved_page_PG_CNT * 8.0),N'%')
   FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i
  WHERE i.rec_type           NOT IN (N'A',N'D')
    AND i.tbl_is_memory_optimized = 0
    AND i.reserved_page_PG_CNT    > 0
    AND (   (i.rec_type = N'I' AND i.reserved_page_PG_CNT > 256) -- 2MB
         OR (i.rec_type = N'H' AND i.reserved_page_PG_CNT > 512) -- 4MB
         OR (i.rec_type = N'P' AND i.reserved_page_PG_CNT > 512) -- 4MB
         OR (i.rec_type = N'S' AND i.reserved_page_PG_CNT > 512) -- 4MB
        )
    AND i.buffer_total_KB_CNT > (8.0 * i.reserved_page_PG_CNT * 0.20); -- 8.0 to convert PAGE to KB

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Added Buffer Cache metric diagnostic records to Parent'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- Add Priority Metric computations to Index diagnostics
-- Checking not performed of denominators since any value in any index should mean that the Instance value is also non-zero
\******************************************************************************************************************************************/
INSERT
  INTO [tempdb].[dbo].[SQLXL_Index_Diagnostics]
      (rec_type
      ,database_id
      ,parent_object_id
      ,object_id
      ,index_id
      ,type
      ,diagnostic
      )
SELECT i.rec_type
      ,i.database_id
      ,i.parent_object_id
      ,i.object_id
      ,i.index_id
      ,i.type
      ,diagnostic = i.diagnostic
  FROM [tempdb].[dbo].[SQLXL_Index_Metrics_Summary] AS i
 WHERE rec_type IN (N'I',N'P')
   AND (--
           CHARINDEX(N'*Waits:'  ,i.diagnostic) = 1
        OR CHARINDEX(N'*Locks:'  ,i.diagnostic) = 1
        OR CHARINDEX(N'*Splits:' ,i.diagnostic) = 1
        OR CHARINDEX(N'*Merges:' ,i.diagnostic) = 1
        OR CHARINDEX(N'*MIX'     ,i.diagnostic) = 1
        OR CHARINDEX(N'*Writes:' ,i.diagnostic) = 1
        OR CHARINDEX(N'*Buffer:' ,i.diagnostic) = 1
        OR CHARINDEX(N'*Touches:',i.diagnostic) = 1
        OR CHARINDEX(N'*Reads:'  ,i.diagnostic) = 1
        OR CHARINDEX(N'*LOB:'    ,i.diagnostic) = 1
       )

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Added significant index metrics diagnostic records'
   RAISERROR(@msg,0,0) WITH NOWAIT;
   SET @exec_dttm = GETDATE();
END

/******************************************************************************************************************************************\
-- UPDATE [tempdb].[dbo].[SQLXL_Index_Compilation] table with Diagnostics & Metrics
\******************************************************************************************************************************************/
UPDATE tgt
   SET
/*** LOCAL TESTING ***
SET ANSI_WARNINGS ON;
SELECT parent_object_id,object_id,index_id,
--*/
       Diagnostics = STUFF(-- Strip off leading unnecessary characters
                           (--
                            SELECT NCHAR(92) + f.diagnostic
                              FROM (SELECT i = 0
                                          ,diagnostic_ID
                                          ,rec_type
                                          ,database_id
                                          ,parent_object_id
                                          ,object_id
                                          ,index_id
                                          ,type
                                          ,diagnostic 
                                      FROM [tempdb].[dbo].[SQLXL_Index_Diagnostics]    
                                     WHERE diagnostic IS NOT NULL
                                    UNION ALL
                                    SELECT i = 1
                                          ,diagnostic_ID
                                          ,rec_type
                                          ,database_id
                                          ,parent_object_id
                                          ,object_id
                                          ,index_id
                                          ,type
                                          ,diagnostic
                                      FROM [tempdb].[dbo].[SQLXL_Instance_Diagnostics] 
                                     WHERE diagnostic IS NOT NULL
                                   ) AS f
                             WHERE tgt.database_id      = f.database_id
                               AND tgt.parent_object_id = f.parent_object_id
                               AND tgt.object_id        = f.object_id
                               AND tgt.index_id         = f.index_id
                               AND tgt.type             = f.type                 -- COLLATE DATABASE_DEFAULT
                               AND f.diagnostic        IS NOT NULL
                             ORDER BY f.i
                                     ,f.diagnostic_ID
                                     ,f.diagnostic DESC
                               FOR XML PATH(N''), TYPE
                           ).value('(./text())[1]', 'NVARCHAR(MAX)')
                           ,1,1,N'')
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS tgt;

IF @ssms_ads > 0 BEGIN -- display status to SSMS/ADS Messages tab
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@exec_dttm,GETDATE()),0))
            + N' Added diagnostic records to [SQLXL_Index_Compilation]'
   RAISERROR(@msg,0,0) WITH NOWAIT;
-- End of the procedure - run time
   RAISERROR(N'',0,0) WITH NOWAIT;
   SET @msg = [tempdb].[dbo].[SQLXL_DTTM_HMSM](DATEADD(ms,DATEDIFF(ms,@collection_DTTM,GETDATE()),0))
            + N' End of procedure [tempdb].[dbo].[SQLXL_Index]'
   RAISERROR(@msg,0,0) WITH NOWAIT;

   SET @exec_dttm = GETDATE(); -- unneeded since last step
END

/******************************************************************************************************************************************\
-- Databases OMITTED from this request
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
DROP TABLE #omitted_databases
DECLARE @rowcount BIGINT
       ,@i        BIGINT
       ,@msg      NVARCHAR(1000)
--*/
SELECT database_id = TRY_CAST(db.database_id AS NVARCHAR(20))
      ,db.database_name
      ,db.[Omitted Reason]
      ,rn = ROW_NUMBER() OVER (ORDER BY (SELECT NULL))
  INTO #omitted_databases
  FROM (-- list of requested databases and reason why omitted from procedure
        SELECT d.database_id
              ,database_name    = QUOTENAME(d.name)
              ,[Omitted Reason] = N'Secondary role allow connections desc = "NO"'
          FROM [tempdb].[dbo].[SQLXL_Index_sys_databases] AS d
         WHERE EXISTS (-- do not interrogate replica databases that can't be connected to
                       SELECT 1/0
                         FROM [tempdb].[dbo].[SQLXL_Index_sys_availability_replicas] AS ar
                        WHERE d.replica_id = ar.replica_id
                          AND ar.secondary_role_allow_connections_desc = 'NO'
                      )
        UNION ALL
        SELECT d.database_id
              ,database_name    = QUOTENAME(d.name)
              ,[Omitted Reason] = N'HADR availability replica state is ' + rs.role_desc
          FROM [tempdb].[dbo].[SQLXL_Index_sys_databases]                           AS d
          JOIN [tempdb].[dbo].[SQLXL_Index_sys_dm_hadr_availability_replica_states] AS rs
            ON d.replica_id = rs.replica_id
         WHERE rs.role_desc IN (N'SECONDARY',N'RESOLVING')
       ) AS db;

SET @rowcount = @@ROWCOUNT;

IF @rowcount > 0
BEGIN
   SET @i = 1
   SELECT N'Omitted database ' + database_name + N' ' + [Omitted Reason] FROM #omitted_databases; -- display on RESULTS tab
   RAISERROR(N'',0,0) WITH NOWAIT;
   RAISERROR(N'### OMITTED DATABASES ##################################################################',0,0) WITH NOWAIT;
   WHILE @i <= @rowcount
   BEGIN
      SELECT @msg = database_id + N' ' + database_name + N' ' + [Omitted Reason]
        FROM #omitted_databases
       WHERE rn = @i;
      RAISERROR(@msg,0,0) WITH NOWAIT; 
      SET @i += 1
   END
   RAISERROR(N'########################################################################################',0,0) WITH NOWAIT;
END

GO -- end of stored procedure [SQLXL_Index]

RAISERROR ('Created procedure [tempdb].[dbo].[SQLXL_Index] ...',0,0) WITH NOWAIT;
IF @@TRANCOUNT > 0 ROLLBACK;
GO

/*########################################################################################################################################*\
Copy procedure SQLXL_Index to tempdb
\*########################################################################################################################################*/
IF DB_NAME() <> N'tempdb'
BEGIN
   DECLARE @sql NVARCHAR(MAX)
   SELECT @sql = REPLACE(definition,'''','''''')
     FROM sys.sql_modules 
    WHERE OBJECT_ID IN (SELECT object_id FROM sys.objects WHERE name = N'SQLXL_Index')
   SET @sql = N'USE [tempdb];
   EXEC(''IF OBJECT_ID(''''[dbo].[SQLXL_Index]'''') IS NOT NULL DROP PROCEDURE [dbo].[SQLXL_Index]'');
   EXEC(''' + @sql +''')'
   EXEC(@sql)
   ---------------------------------------------------------------
   -- drop procedure SQLXL_Instance in this database after copy
   ---------------------------------------------------------------
   IF object_id('[dbo].[SQLXL_Index]') IS NOT NULL DROP PROCEDURE [dbo].[SQLXL_Index];
END;


-- VERSION 2024.07.15
/******************************************************************************************************************************************\
All SQLXL tables objects are created in [tempdb] (must be lower case to support case sensitive collation on installation)
Procedures are created in the connected-to database and then copied to [tempdb]. After copy they are deleted from the conencted-to database
Functions are created in tempdb by using the EXEC('USE tempdb;EXEC(''create function code'')') construct
\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
-- Session Environment settings
\******************************************************************************************************************************************/
SET ANSI_NULLS               ON;
SET ANSI_NULL_DFLT_ON        ON;
SET ANSI_PADDING             ON;
SET ANSI_WARNINGS            ON;
SET ARITHABORT               ON;
SET CONCAT_NULL_YIELDS_NULL  ON;
SET CURSOR_CLOSE_ON_COMMIT   ON;
SET NOCOUNT                  ON;
SET QUOTED_IDENTIFIER        ON;
SET XACT_ABORT               ON;

SET ARITHIGNORE             OFF;
SET FMTONLY                 OFF;
SET FORCEPLAN               OFF;
SET IMPLICIT_TRANSACTIONS   OFF;
SET NOEXEC                  OFF;
SET NUMERIC_ROUNDABORT      OFF;
SET STATISTICS IO,PROFILE,TIME,XML OFF;

SET DATEFORMAT              YMD;
SET DEADLOCK_PRIORITY       -10; -- Lowest priority
SET LOCK_TIMEOUT          10000; -- in milliseconds
SET QUERY_GOVERNOR_COST_LIMIT 0; -- 0 (the default) turns off the query governor, queries of any cost are allowed to execute.
SET ROWCOUNT                  0;
SET TEXTSIZE         2147483647;  -- Use 32767 on export to Excel - cell maximum

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

/******************************************************************************************************************************************\
Create table to store computed & formatted metric values. Needed for creation script below
\******************************************************************************************************************************************/
IF (OBJECT_ID(N'[tempdb].[dbo].[SQLXL_Index_Metrics]') IS NULL)
   CREATE TABLE [tempdb].[dbo].[SQLXL_Index_Metrics]
   (rec_type         NCHAR(1)       COLLATE DATABASE_DEFAULT NOT NULL  -- D-Database,P-Parent,I-index
   ,database_id      SMALLINT                                NOT NULL
   ,parent_object_id INT                                     NOT NULL
   ,object_id        INT                                     NOT NULL
   ,index_id         INT                                     NOT NULL
   ,type             NVARCHAR(2)    COLLATE DATABASE_DEFAULT NOT NULL
   ,metric           SYSNAME        COLLATE DATABASE_DEFAULT NOT NULL
   ,metric_AMT       FLOAT                                       NULL
   ,metric_FMT       NVARCHAR(7)    COLLATE DATABASE_DEFAULT     NULL
   ,diagnostic_PCT   FLOAT                                       NULL
   -----------------------------
   ,diagnostic       NVARCHAR(1000) COLLATE DATABASE_DEFAULT     NULL
   ,diagnostic_RANK  INT                                         NULL
   ,previous_sum_PCT FLOAT                                       NULL
   );

/******************************************************************************************************************************************\
Create function in [tempdb] to return computed & formatted SQLXL_Index metric values
\******************************************************************************************************************************************/
EXEC ('USE tempdb;
IF OBJECT_ID(''dbo.SQLXL_Index_Metric_tvf'') IS NULL 
   EXEC (''CREATE FUNCTION dbo.SQLXL_Index_Metric_tvf() RETURNS TABLE AS RETURN (SELECT id = 0)'')');

EXEC(N'USE tempdb; EXEC(''
ALTER FUNCTION [dbo].[SQLXL_Index_Metric_tvf]
     (@rec_type         NCHAR(1)
     ,@database_id      SMALLINT
     ,@parent_object_id INT
     ,@object_id        INT
     ,@index_id         INT
     ,@type             NVARCHAR(2)
     ,@metric           SYSNAME
)
RETURNS TABLE
AS
RETURN
    SELECT metric_val = metric_FMT + COALESCE(N'''' '''' + diagnostic,N'''''''')
      FROM [tempdb].[dbo].[SQLXL_Index_Metrics]
     WHERE @rec_type         = rec_type
       AND @database_id      = database_id
       AND @parent_object_id = parent_object_id
       AND @object_id        = object_id
       AND @index_id         = index_id
       AND @type             = type
       AND @metric           = metric;
'')');

RAISERROR ('Created function tempdb.dbo.SQLXL_Index_Metric_tvf',0,0) WITH NOWAIT;

/*########################################################################################################################################*\
PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRESENT PRES
\*########################################################################################################################################*/
RAISERROR ('Creating procedure [dbo].[SQLXL_Index_Present] ...',0,0) WITH NOWAIT;

IF OBJECT_ID('[dbo].[SQLXL_Index_Present]') IS NULL EXEC ('CREATE PROCEDURE [dbo].[SQLXL_Index_Present] AS RETURN 0;');
GO -- required since 'CREATE/ALTER PROCEDURE' must be the first statement in a query batch.

ALTER PROCEDURE [dbo].[SQLXL_Index_Present]
AS

/******************************************************************************************************************************************\
-- Procedure Environment settings
\******************************************************************************************************************************************/
SET ANSI_NULLS               ON;
SET ANSI_NULL_DFLT_ON        ON;
SET ANSI_PADDING             ON;
SET ANSI_WARNINGS            ON;
SET ARITHABORT               ON;
SET CONCAT_NULL_YIELDS_NULL  ON;
SET CURSOR_CLOSE_ON_COMMIT   ON;
SET NOCOUNT                  ON;
SET QUOTED_IDENTIFIER        ON;
SET XACT_ABORT               ON;

SET ARITHIGNORE             OFF;
SET FMTONLY                 OFF;
SET FORCEPLAN               OFF;
SET IMPLICIT_TRANSACTIONS   OFF;
SET NOEXEC                  OFF;
SET NUMERIC_ROUNDABORT      OFF;
SET STATISTICS IO,PROFILE,TIME,XML OFF;

SET DATEFORMAT              YMD;
SET DEADLOCK_PRIORITY       -10; -- Lowest priority
SET LOCK_TIMEOUT          10000; -- in milliseconds
SET QUERY_GOVERNOR_COST_LIMIT 0; -- 0 (the default) turns off the query governor, queries of any cost are allowed to execute.
SET ROWCOUNT                  0;
SET TEXTSIZE         2147483647;  -- Use 32767 on export to Excel - cell maximum

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

SELECT
/******************************************************************************************************************************************\
Incoming Records Types:
A - All sample/instance level
D - Database(s)
P - Parent object - rowstore table, clustered columnstore, View, SQL Table Valued Function
S - internal table or system object
I - Index, foreign key, missing index,

Column Format Control - Append "|" (pipe) character for number format:
  |D... - Date &/or Time
  |E    - Exponent no decimals (same as E0)
  |E#   - Exponent with # decimals
  |N    - Commas no decimals (same as N0)
  |N#   - Commas with # decimals
  |P    - Percent with no decimals (same as P0)
  |P#   - Percent with # decimals
  |URL  - format cell as LINK
  |HTML - format cell as LINK

column names with "\" (backslash) character code to identify columns to be formatted with a COLOR SCALE:
  \B - a number with LARGEST VALUE BAD - RED
  \G - a number with LARGEST VALUE GOOD - GREEN

Column Label Format
  "!"  (exclamation) character code to identify columns to be formatted BOLD
  "!H" Bold Font and bigger size
  "~" (tilda) character code to identify locations of Line feeds (CHRW(10))

\******************************************************************************************************************************************/

/******************************************************************************************************************************************\
 Weighted sum of hurts
\******************************************************************************************************************************************/
 [Hurt Priority\B|N2] = IIF(i.rec_type IN (N'P') AND a.tbl_priority_metric > 0
                           ,100.0 * i.tbl_priority_metric / a.tbl_priority_metric
                           ,NULL)

/******************************************************************************************************************************************\
 Filtering column used to drill down to table & index level
\******************************************************************************************************************************************/
,[Drill Down Filter|NW]   = -- Top Level
                          + CASE i.rec_type
                                 WHEN N'A' THEN i.rec_type -- All (Instance)
                                 WHEN N'D' THEN i.rec_type -- Database
                                 WHEN N'P' THEN i.rec_type -- "Parent" Table/History Source
                                 ELSE N'T'                 -- Index
                            END
                          + IIF(i.rec_type <> N'A',CAST(i.database_id AS NVARCHAR(11)) ,N'')
                          + IIF(i.rec_type NOT IN (N'A',N'D')
                               ,N'.' + TRY_CAST(COALESCE(i.history_source_object_id,i.parent_object_id) AS NVARCHAR(11))
                               ,N'')
                          -- Parent/History Table source table
                          + IIF(i.rec_type NOT IN (N'A',N'D') -- All (Instance), Database
                               -- Type of "table". Parents/sources first, history seconds, internal third
                               ,N'|'
                               + CASE i.obj_type_short_label
                                      WHEN N'HST'  -- history table
                                      THEN N'3' + RIGHT(N'0000000000' + CAST(i.object_id AS NVARCHAR(20)),10)
                                      WHEN N'IT'   -- system internal table
                                      THEN N'6' + RIGHT(N'0000000000' + CAST(i.object_id AS NVARCHAR(20)),10)
                                      ELSE N'1'   -- Parent (Heap,Clustered,Clustered column store),SQL Table Valued Function (TVF), View
                                 END
                              + N'|'
                              ,N'')
                          + IIF(i.rec_type IN (N'I') -- "Index"
                               ,N'|' -- "Pipe" added to delimit drill down term in Excel filter
                               + CASE RTRIM(i.type)
                                      WHEN N'0'  THEN N'0' -- Heap
                                      WHEN N'1'  THEN N'0' -- clustered rowstore
                                      WHEN N'5'  THEN N'0' -- clustered columnstore
                                      ---------
                                      WHEN N'6'  THEN N'1' -- nonclustered columnstore
                                      WHEN N'3'  THEN N'2' -- XML
                                      WHEN N'4'  THEN N'3' -- Spatial
                                      WHEN N'90' THEN N'4' -- Full Text
                                      ---------
                                      WHEN N'F'  THEN N'6' -- Foreign Key Constraint
                                      WHEN N'M'  THEN N'7' -- Foreign Key Constraint
                                      ---------
                                      ELSE RTRIM(i.type)   -- Anything else
                                 END
                               + N'|'
                               + IIF(TRY_CAST(i.type AS INT) IS NOT NULL
                                    ,RIGHT(N'000000000' + CAST(i.index_id AS NVARCHAR(20)),10)
                                    ,N'')
                               + IIF(i.type = N'F'
                                    , IIF(i.fkc_covered_by_idx_IDS IS NULL,N'U',N'C')
                                    + RIGHT(N'0000000000' + CAST(i.object_id AS NVARCHAR(20)),10)
                                    ,N'') -- Foreign Key index coverage
                               + IIF(i.type = N'M'
                                    ,RIGHT(N'0000000000' + CAST(i.object_id AS NVARCHAR(20)),10)
                                    ,N'') -- Foreign Key index coverage
                               ,N'')

,[Parent Type & Object Type~Object Properties & Index Type] =
--------------------------------------------------------------------------------------------------------------------------------------------
 CASE WHEN i.rec_type = N'A' THEN N'#ALL'
      WHEN i.rec_type = N'D' THEN N'#DB'
      WHEN i.rec_type = N'P' THEN N'*' + i.obj_type_label
      WHEN i.rec_type = N'H' THEN N'*' + i.obj_type_label
      WHEN i.rec_type = N'S' THEN N'>' + i.obj_type_label
      ELSE i.obj_type_label + IIF(i.type = N'F'
                                 ,IIF(i.fkc_covered_by_idx_IDS IS NULL,N' UNC',N' COV')  -- Foreign Key index coverage
                                 ,N'')
 END

/******************************************************************************************************************************************\
 Object & Index Names & system-assigned IDs
\******************************************************************************************************************************************/
,[Names~Database~Schema~Table~Index~FK Name of FK~REF sch.tbl.col~FLT Idx Filter~EP EXT Prop~OID Object IDs]
--------------------------------------------------------------------------------------------------------------------------------------------
-- Line 1 - Instance,Database
--------------------------------------------------------------------------------------------------------------------------------------------
=IIF(i.rec_type = N'A'
    ,N'Instance/Sample'
    ,N'DB ' + COALESCE(QUOTENAME(i.Database_name),N'<Database_name?>')   -- Database
    )
-- Schema -----------------------------------------------------------
+IIF(i.rec_type NOT IN (N'A',N'D')
    ,N' SCH ' + COALESCE(QUOTENAME(i.Schema_Name),N'<Schema_Name?>')
    ,N'')
--------------------------------------------------------------------------------------------------------------------------------------------
-- Line 2 - Parent Object (and Object if History or Internal Table)
--------------------------------------------------------------------------------------------------------------------------------------------
+IIF(i.obj_type_short_label = N'HST'
    ,NCHAR(92) + N'PAR ' + QUOTENAME(hst_src.schema_name) + N'.' + QUOTENAME(hst_src.obj_name)
    ,N'')
+IIF(i.obj_type_short_label = N'IT'
    ,NCHAR(92) + N'PAR ' + QUOTENAME(i.parent_schema_name) + N'.' + QUOTENAME(i.parent_object_name)
    ,N'')
+ CASE WHEN i.rec_type IN (N'A',N'D')
      THEN N''
      WHEN i.type = N'F'
      THEN NCHAR(92) + N'TBL ' + QUOTENAME(i.parent_object_name)
      ELSE NCHAR(92) + i.obj_type_short_label + N' ' + QUOTENAME(i.obj_name)
 END
--------------------------------------------------------------------------------------------------------------------------------------------
-- Line 3 Index
--------------------------------------------------------------------------------------------------------------------------------------------
+IIF(i.rec_type = N'I'
    ,NCHAR(92) + COALESCE(i.type_short_desc,N'<type_short_desc>')
    + N' ' + COALESCE(QUOTENAME(CASE WHEN i.internal_type > 202 THEN i.obj_name
                                 ELSE i.name
                            END),N'<type_name?>')
    ,N'')
--------------------------------------------------------------------------------------------------------------------------------------------
 -- Line 4 - "Index" Special Properties
--------------------------------------------------------------------------------------------------------------------------------------------
+IIF(i.rec_type = N'I'
    ,IIF(   i.is_primary_key = 1
         OR i.is_unique_constraint = 1
         OR i.is_unique = 1
         OR (i.type = N'1' AND i.is_unique = 0)
         OR i.has_filter = 1
         OR i.type IN (N'3',N'4')
         OR i.internal_type IS NOT NULL -- indexes on internal tables
        ,NCHAR(92)
        + STUFF(-- Strip off leading unnecessary characters
                IIF(i.is_primary_key = 1
                 ,N' PRIMARY KEY'
                 ,IIF(i.is_unique_constraint = 1
                     ,N' UNIQUE CONSTRAINT'
                     ,IIF(i.is_unique = 1
                         ,N' UNIQUE'
                         ,IIF(i.TYPE = N'1'
                             ,N' *NOT UNIQUE*'  -- special flag for CLUSTERED ROWSTORE
                             ,N'')
                         )
                     )
                 )
              +IIF(i.internal_type IS NOT NULL
                  ,N' ' + COALESCE(i.internal_type_desc
                                  ,N' Internal Type ' + RIGHT(N'00' + TRY_CAST(i.internal_type AS NVARCHAR(3)),3))
                  ,N'')
              +IIF(i.has_filter = 1,N' FILTERED',N'')                     -- index filter
              +IIF(i.TYPE = N'3'                                          -- XML
                  ,N' ' + COALESCE(i.sub_type_desc,N'<sub_type_desc>')
                  ,N'')
              +IIF(i.TYPE = N'4'                                          -- spatial
                  ,N' '     + COALESCE(i.sub_type_desc,N'<sub_type_desc>')
                  + N' SCH: ' + COALESCE(i.si_tessellation_scheme,N'<i.si_tessellation_scheme?>')
                  ,N'')
              ,1,1,N'')
        ,N'')
    ,N'')
--------------------------------------------------------------------------------------------------------------------------------------------
 -- Line 5 - Object IDs for all objects
--------------------------------------------------------------------------------------------------------------------------------------------
+IIF(i.rec_type IN (N'A')
    ,N''
    ,NCHAR(92))
+IIF(i.rec_type NOT IN (N'A')
    ,N'DB ' + COALESCE(QUOTENAME(i.database_id),N'<database_id?>')
    ,N'')
+IIF(i.rec_type NOT IN (N'A',N'D')
    , IIF(i.parent_object_id <> i.object_id
         , CASE i.obj_type_short_label
                WHEN N'IT'  THEN N' PAR '
                WHEN N'HST' THEN N' PAR'
                ELSE N' ' + i.obj_type_short_label + N' '
           END
         + QUOTENAME(i.parent_object_id)
        ,N'')
    + IIF(i.obj_type NOT IN (N'F')
         ,COALESCE(N' ' + i.obj_type_short_label + N' ',N' <OSTL> ') + COALESCE(QUOTENAME(i.object_id),N'<object_id?>')
         ,N'')
    ,N'')
+IIF(i.rec_type IN (N'I')
    , CASE i.type
           WHEN N'F' THEN N' FKC ' + COALESCE(QUOTENAME(i.Index_ID),N'<index_id?>')
           WHEN N'M' THEN N' MIX ' + COALESCE(QUOTENAME(i.Index_ID),N'<index_id?>')
           WHEN N'V' THEN N''
           ELSE           N' IDX ' + COALESCE(QUOTENAME(i.Index_ID),N'<index_id?>')
      END
    ,N'')

/******************************************************************************************************************************************\
-- Detailed actions for each index and selected other objects
\******************************************************************************************************************************************/
,[Prescriptions] = i.prescription

/******************************************************************************************************************************************\
-- Detailed diagnostic information for each index and objects
\******************************************************************************************************************************************/
,[Diagnostics] = LEFT(i.[diagnostics]
                     + CASE WHEN i.rec_type = N'I'
                             AND i.type     = N'F'
                            THEN  NCHAR(92)
                                + N'-- Foreign Key Reference ---'
                                + NCHAR(92)
                                + COALESCE(i.fkc_reference,N'<fkc_reference?>')             -- Referenced schema + table + column(s)
                                + NCHAR(92)
                                + N'OID DB ' + QUOTENAME(i.database_id)                                                     -- Referenced Database ID
                                + N' TBL '   + COALESCE(QUOTENAME(i.fkc_referenced_object_id),N'fkc_referenced_object_id?') -- Referenced Table ID
                                + N' IDX '   + COALESCE(QUOTENAME(i.fkc_referenced_index_id) ,N'fkc_referenced_index_id?')  -- Referenced Index ID
                            ELSE N''
                       END
                     ,32767) -- to avoid Excel treating as MAX column

/******************************************************************************************************************************************\
-- Index Element Uniqueness, in increasing key order
\******************************************************************************************************************************************/
,[Idx Element Uniqueness~Stats Density X RowCount~F = Filtered~(%) of Table Rows|N2] = i.element_uniqueness

/******************************************************************************************************************************************\
-- Index Key and Included Column Details
\******************************************************************************************************************************************/
,[Columns~CX(#) Clustered Idx&Key~Name~Type+bytes~Identity & attributes~ANSI settings~Partition~(Uniqueness)~Statistics Steps]
                 = i.key_column_info
                  +IIF(i.Included_column_info IS NOT NULL
                      ,IIF(i.TYPE IN (N'2',N'5',N'M')
                          ,NCHAR(92) + N'-- Included --------------------------'
                          ,N'')
                      + NCHAR(92) +i.Included_column_info
                      ,N'')

/******************************************************************************************************************************************\
-- Index Synergies
\******************************************************************************************************************************************/
,[Index Synergies~Sequence,Overlap,Keys] = i.Overlap_Code

/******************************************************************************************************************************************\
-- Physical metrics & buffer usage
\******************************************************************************************************************************************/
,[Index~RSZ Rsrvd size (%Tbl)~BSZ Buffer size (%Rsrv)~Tbl ROW Rows COL cols~LEN Wor Length~FCT Factor & Pad~Idx KEY Cnt & Len] =
STUFF(CASE WHEN i.type     = N'3'  -- XML Index
           THEN NCHAR(92)  + N'XML'

           WHEN i.type     = N'4'   -- Spatial Index
           THEN NCHAR(92)  + N'SPT'

           WHEN i.type     = N'90'  -- FullText Index
           THEN NCHAR(92)  + N'FTX'

           WHEN i.type     = N'F'   -- Foreign Key COnstraint
           THEN  NCHAR(92)
               + N'KEY   ' -- extra space added to make 2nd column in cell align
               + TRY_CAST(COALESCE(i.Key_Columns_CNT,0) AS NVARCHAR(20))
               + N' LEN '
               + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.key_total_datatype_length_bytes,0.0),N'B')

           WHEN i.type     = N'M'  -- Missing index
           THEN  NCHAR(92)
               + N'KEY   ' -- extra space added to make 2nd column in cell align
               + TRY_CAST(COALESCE(i.Key_Columns_CNT,0) AS NVARCHAR(20))
               + N' LEN '
               + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.key_total_datatype_length_bytes,0.0),N'B')
               + NCHAR(92)
               + N'INC    ' -- extra space added to make 2nd column in cell align
               + TRY_CAST(COALESCE(i.Included_Columns_CNT,0) AS NVARCHAR(20))
               + N' LEN ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.inc_total_datatype_length_bytes,0),N'I') + N'B'

           WHEN i.type     = N'V'   -- View
           THEN  NCHAR(92) + N'View'
               + IIF(i.index_id = 0 -- HEAP (no index on view)
                    ,N' Unindexed'
                    ,N'')

           WHEN i.obj_type IN (N'FT' -- Assembly (CLR) table-valued function
                              ,N'IF' -- SQL inline table-valued function (TVF)
                              ,N'TF' -- SQL table-valued-function (TVF)
                              )
           THEN NCHAR(92) + N'TVF' -- table functions w/o indexes have no stats other than PLAN CACHE

           ELSE -------------------------------------------------------------------------------------------------------------
                -- reserved size on disk or InMemory
                -------------------------------------------------------------------------------------------------------------
                 NCHAR(92) + N'RSZ   ' -- extra space added to make 2nd column in cell align
               + COALESCE((-- retrieve & format computed metric value
                           SELECT *
                             FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                 (i.rec_type
                                 ,i.database_ID
                                 ,i.parent_object_ID
                                 ,i.object_id
                                 ,i.index_ID
                                 ,i.type
                                 ,N'reserved_page_PG_CNT')
                          )
                         ,IIF(i.row_cnt = 0
                             ,N'MT'
                             ,[tempdb].[dbo].[SQLXL_3SD](i.reserved_page_PG_CNT,N'P'))
                         )
               --------------------------------------------------------------------------------------------------------------
               -- Buffer cache usage & oercent of reserved space
               --------------------------------------------------------------------------------------------------------------
               + NCHAR(92) + N'BSZ   ' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(i.buffer_total_KB_CNT,0),N'KB')
               + IIF(i.reserved_page_PG_CNT > 0
                    ,N' (' + [tempdb].[dbo].[SQLXL_3SD](COALESCE(1.0 * i.buffer_total_KB_CNT / (i.reserved_page_PG_CNT * 8.0),0),N'%')
                    + N')'
                    ,N'')
               --------------------------------------------------------------------------------------------------------------
               --
               --------------------------------------------------------------------------------------------------------------
               + NCHAR(92) + N'ROW ' + [tempdb].[dbo].[SQLXL_3SD](i.row_CNT,'I') + IIF(i.has_filter = 1,N'(F)',N'')
               + IIF(i.rec_type IN (N'H' -- history table
                                   ,N'P' -- parent table
                                   ,N'S' -- system internal table
                                   )
                    , N' COL ' + [tempdb].[dbo].[SQLXL_3SD](p.tbl_column_CNT,'I')
                    + IIF(i.row_CNT > 0
                         ,NCHAR(92) + N'LEN   ' + [tempdb].[dbo].[SQLXL_3SD](i.tbl_row_size_byte_AVG,'B') + N' AVG'
                         ,N'')
                    ,N'')
               -------------------------------------------------------------------------------------------------------------
               --
               --------------------------------------------------------------------------------------------------------------
               + IIF( i.rec_type = N'I'
                    , NCHAR(92) + N'KEY   ' -- extra space added to make 2nd column in cell align
                    + CASE i.type
                           WHEN N'0' THEN N'HP'
                           WHEN N'5' THEN N'CCS'
                           WHEN N'6' THEN N'NCS'
                           ELSE TRY_CAST(i.Key_Columns_CNT AS NVARCHAR(20))
                      END
                    + CASE WHEN i.key_total_datatype_length_bytes > 0
                           THEN N' LEN ' + [tempdb].[dbo].[SQLXL_3SD](i.key_total_datatype_length_bytes,N'I') + N'B'
                           ELSE N''
                      END
                    ,N'')
               --------------------------------------------------------------------------------------------------------------
               --
               --------------------------------------------------------------------------------------------------------------
               + IIF( i.rec_type = N'I'
                    , NCHAR(92) + N'INC    ' -- extra space added to make 2nd column in cell align
                    + CASE i.type
                           WHEN N'0' THEN N'HP'    -- Heap
                           WHEN N'1' THEN N'<all>' -- Clustered Rowstore
                           WHEN N'5' THEN N'<all>' -- Clustered columnstore
                           ELSE TRY_CAST(i.Included_Columns_CNT AS NVARCHAR(20))
                      END
                    + CASE WHEN i.inc_total_datatype_length_bytes > 0
                           THEN N' LEN ' + [tempdb].[dbo].[SQLXL_3SD](i.inc_total_datatype_length_bytes,N'I') + N'B'
                           ELSE N''
                      END
                    ,N'')
               --------------------------------------------------------------------------------------------------------------
               -- Fill factor & tree padding
               --------------------------------------------------------------------------------------------------------------
               + IIF(    i.rec_type  = N'I'   -- index-level record
                    , NCHAR(92) + N'FCT   ' -- extra space added to make 2nd column in cell align
                    + CASE WHEN i.TYPE = N'0'
                           THEN N'HP'
                           WHEN TRY_CAST(i.TYPE AS INT) > 0
                           THEN  COALESCE([tempdb].[dbo].[SQLXL_3SD](i.fill_factor,N'I') + N'%',N'<??>')
                               + N' PAD '
                               + COALESCE(CASE i.is_padded WHEN 0 THEN N'No' WHEN 1 THEN N'Yes' ELSE N'' END,N'<??>')
                           ELSE N'N/A'
                      END
                    ,N'')
      END -- CASE WHEN i.type     = N'3'
     ,1,1,N'')

/******************************************************************************************************************************************\
-- Operational Metrics
\******************************************************************************************************************************************/
,[Total Use (%Nxt Lvl)~OPS/CMP TOT CNT~USR USG Contact TOT CNT~R/W OPS & USG Read/Write~WTC Wait CNT~WTS Wait SEC~LCK Lock CNT]
= CASE WHEN i.obj_type = N'V' AND i.type = N'0'              -- views without indexes don't record any usage stats other than in PLAN CACHE
       THEN N'View Heap'  + NCHAR(92) + N'No data'
       WHEN i.obj_type = N'F'
       THEN N'Foreign Key' + NCHAR(92) + N'No data'
       WHEN i.type = N'M'
       THEN             -- extra space added to make 2nd column in cell align
                        N'RDS  '  + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ius_user_read_CNT'   ))
                                            ,N'0')
                                  + N' (USG)'
          + NCHAR(92) + N'WRT '   + N'n/a'
          + NCHAR(92) + N'R/W  '  + N'n/a'
          + NCHAR(92) + N'WTS '   + N'n/a'
          + NCHAR(92) + N'WTC '   + N'n/a'
          + NCHAR(92) + N'LCK   ' + N'n/a'
       ELSE             N'RDS  '  + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ops_total_read_CNT'   ))
                                            ,N'0')
          + NCHAR(92) + N'WRT '   + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ops_total_write_CNT'  ))
                                            ,N'0')
          + NCHAR(92) + N'R/W  '  + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ops_read_to_write_RAT'))
                                            ,N'n/a')
          + NCHAR(92) + N'WTS '   + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ops_total_wait_MS_CNT'))
                                            ,N'0')
          + NCHAR(92) + N'WTC '   + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ops_total_wait_CNT'   ))
                                            ,N'0')
          + NCHAR(92) + N'LCK  '  + COALESCE((-- retrieve & format computed metric value
                                              SELECT *
                                                FROM [tempdb].[dbo].[SQLXL_Index_Metric_tvf]
                                                    (i.rec_type
                                                    ,i.database_ID
                                                    ,i.parent_object_ID
                                                    ,i.object_id
                                                    ,i.index_ID
                                                    ,i.type
                                                    ,N'ops_total_lock_CNT'   ))
                                            ,N'0')
  END

/******************************************************************************************************************************************\
-- Foreign Key Constraint reference
\******************************************************************************************************************************************/
,[MIX Biggest Resource Query]
       = REPLACE(i.mqy_query_text,CHAR(13)+CHAR(10),CHAR(92))

/******************************************************************************************************************************************\
-- Constraint reference & Computed Columns
\******************************************************************************************************************************************/
,[Constraints & Computed~CHK-Check, Key, DEF-Default~CCOL-Computed Column~Index Filters]
       = STUFF(-- Strip off leading unnecessary characters
                IIF(i.constraints IS NOT NULL
                   ,NCHAR(92) + i.constraints
                   ,N'')
              + IIF(i.has_filter = 1
                   ,NCHAR(92) + N'FLT:' + i.filter_definition
                   ,N'')
              ,1,1,N'')

/******************************************************************************************************************************************\
-- Filter Definitions
\******************************************************************************************************************************************/
,[Statistics Names~& Filters]
       = STUFF(-- Strip off leading unnecessary characters
                IIF(LTRIM(RTRIM(i.filter_definition)) > N''
                  ,NCHAR(92) + N'FLT:' + i.filter_definition
                  ,N'')
              + IIF(    i.stats_Name  > N''
                    AND i.stats_Name <> i.Name
                   ,NCHAR(92) + N'Stat:' + i.stats_Name
                   ,N'')
              ,1,1,N'')

/******************************************************************************************************************************************\
-- Table Logical & Physical File Info
\******************************************************************************************************************************************/
,[Table File & Partitions] =
 STUFF(-- Strip off leading unnecessary characters
         CASE WHEN i.data_space_id IS NOT NULL
              THEN NCHAR(92) + N'Data Space' + N' ' + QUOTENAME(i.data_space_name)
                  + N' ' + N'(' + CAST(i.data_space_id AS NVARCHAR(20)) + N')'
              ELSE N''
         END
        --
       + CASE WHEN i.data_space_logical_filename IS NOT NULL
              THEN NCHAR(92) + N'Logical file name' + N' ' + QUOTENAME(i.data_space_logical_filename)
              ELSE N''
         END
        --
       + CASE WHEN i.partition_Column_ID > 0
              THEN NCHAR(92) + N'Partition COLUMN' + N' ' + QUOTENAME(i.partition_Column_Name)
                  + N' ' + N'(' + CAST(i.partition_Column_ID AS NVARCHAR(20)) + N')'
              ELSE N''
         END
        --
       + CASE WHEN i.partition_schemes_name IS NOT NULL
              THEN NCHAR(92) + N'Partition scheme'  + N' ' + QUOTENAME(i.partition_schemes_name)
              ELSE N''
         END
        --
       + CASE WHEN i.partition_function_id > 0
              THEN NCHAR(92) + N'Partition function' + N' ' + QUOTENAME(i.partition_function_name)
                  + N' ' + N'(' + CAST(i.partition_function_id  AS NVARCHAR(20)) + N')'
              ELSE N''
         END
       ,1,1,N'')

/******************************************************************************************************************************************\
-- Extended Properties  -- replace CarriageReturn (13) & LineFeed(10) with BackSlash (92)
\******************************************************************************************************************************************/
,[Extended Properties]  = REPLACE(REPLACE(i.extended_properties,NCHAR(13)+NCHAR(10),NCHAR(92)),NCHAR(10),NCHAR(92))

/******************************************************************************************************************************************\
--Table Priority Metrics
\******************************************************************************************************************************************/
,[Table OPS Wait TM!H\B|N1]
                        = IIF(i.rec_type = N'P' AND a.ops_total_wait_MS_CNT > 0 AND i.ops_total_wait_MS_CNT > 0
                             ,100.0 * i.ops_total_wait_MS_CNT / a.ops_total_wait_MS_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Wait CNT!H\B|N1]
                        = IIF(i.rec_type = N'P'  AND a.ops_total_wait_CNT > 0
                             ,100.0 * i.ops_total_wait_CNT / a.ops_total_wait_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table OPS Locks CNT!H\B|N1]
                        = IIF(i.rec_type = N'P'  AND a.ops_total_lock_CNT > 0
                             ,100.0 * i.ops_total_lock_CNT / a.ops_total_lock_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Lock Promo!H\B|N1]
                        = IIF(i.rec_type = N'P'              AND a.ios_lock_promotion_attempt_CNT > 0
                             ,100.0 * i.ios_lock_promotion_attempt_CNT / a.ios_lock_promotion_attempt_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Promo Fail!H\B|N1]
                        = IIF(    i.rec_type = N'P'
                              AND a.ios_lock_promotion_attempt_CNT > 0
                             ,100.0 * (i.ios_lock_promotion_attempt_CNT - i.ios_lock_promotion_CNT)
                                    / A.ios_lock_promotion_attempt_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table OPS Page Split!H\B|N1]
                        = IIF(i.rec_type = N'P'        AND a.ops_total_page_split_CNT > 0
                             ,100.0 * i.ops_total_page_split_CNT / a.ops_total_page_split_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Splits to Write PCT!H\B|N1]
                        = IIF(i.rec_type = N'P' AND i.page_splits_to_write_PCT > 0.0
                             ,i.page_splits_to_write_PCT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Page Merge!H\B|N1]
                        = IIF(i.rec_type = N'P'        AND a.ops_total_page_merge_CNT > 0
                             ,100.0 * i.ops_total_page_merge_CNT / a.ops_total_page_merge_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Merge to Write PCT!H\B|N1]
                        = IIF(i.rec_type = N'P' AND i.page_Merge_to_write_PCT > 0.0
                             ,i.page_Merge_to_write_PCT
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table MIX Advantage Weighted!H\G|N1]
                        = IIF(    i.rec_type = N'P'      AND a.mix_Advantage_weighted_AMT > 0
                              AND i.mix_Advantage_weighted_AMT > 0
                             ,100.0 * i.mix_Advantage_weighted_AMT / a.mix_Advantage_weighted_AMT
                             ,NULL)
,[Table MIX Advantage!H\G|N1]
                        = IIF(    i.rec_type = N'P' AND a.mix_Advantage_AMT > 0
                              AND i.mix_Advantage_AMT > 0
                             ,100.0 * i.mix_Advantage_AMT / a.mix_Advantage_AMT
                             ,NULL)
----------------------------------------------
,[Table OPS Writes!H\B|N1]
                        = IIF(i.rec_type = N'P'   AND a.ops_total_write_CNT > 0
                             ,100.0 * i.ops_total_write_CNT / a.ops_total_write_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table USG Writes!H\B|N1]
                        = IIF(i.rec_type = N'P'    AND a.ius_user_updates_CNT > 0
                             ,100.0 * i.ius_user_updates_CNT / a.ius_user_updates_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table BUF Percent in Buffer!H\B|N1]
                        = IIF(i.rec_type = N'P'
                             ,CASE WHEN tbl.is_memory_optimized = 1 AND i.buffer_total_KB_CNT > 0.0
                                   THEN 100
                                   WHEN i.reserved_page_PG_CNT > 0
                                   THEN 100.0 * i.buffer_total_KB_CNT / (i.reserved_page_PG_CNT * 8.0)
                                   ELSE NULL
                              END
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table OPS R/W Ratio!H\G|N1]
                        = IIF(    i.rec_type = N'P'
                              AND i.ops_total_write_CNT > 0
                             ,IIF(i.ops_total_read_CNT / i.ops_total_write_CNT < 100
                                 ,1.0 * i.ops_total_read_CNT / i.ops_total_write_CNT
                                 ,99)
                             ,NULL) -- show NULL if no writes found
,[Table USG R/W Ratio!H\G|N1]
                        = IIF(    i.rec_type = N'P'
                              AND i.ius_user_updates_CNT > 0
                             ,IIF(i.ius_User_read_CNT / i.ius_user_updates_CNT < 100
                                 ,1.0 * i.ius_User_read_CNT / i.ius_user_updates_CNT
                                 ,99)
                             ,NULL) -- show NULL if no writes found
----------------------------------------------
,[Table OPS Reads PCT!H\B|N1]
                        = IIF(i.rec_type = N'P'  AND a.ops_total_read_CNT > 0
                             ,100.0 * i.ops_total_read_CNT / a.ops_total_read_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Scans PCT!H\B|N1]
                        = IIF(i.rec_type = N'P'  AND a.ops_total_scan_CNT > 0
                             ,100.0 * i.ops_total_scan_CNT / a.ops_total_scan_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Lookups PCT!H\B|N1]
                        = IIF(i.rec_type = N'P'        AND a.ios_singleton_lookup_CNT > 0
                             ,100.0 * i.ios_singleton_lookup_CNT / a.ios_singleton_lookup_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table OPS Forwarded Fetch!H\B|N1]
                        = IIF(i.rec_type = N'P'       AND a.ios_forwarded_fetch_CNT > 0
                             ,100.0 * i.ios_forwarded_fetch_CNT / a.ios_forwarded_fetch_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table USG Reads PCT!H\B|N1]
                        = IIF(i.rec_type = N'P' AND a.ius_user_read_CNT > 0
                             ,100.0 * i.ius_User_read_CNT / a.ius_user_read_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table USG Scans PCT!H\B|N1]
                        = IIF(i.rec_type = N'P'  AND a.ius_user_scans_CNT > 0
                             ,100.0 * i.ius_user_scans_CNT / a.ius_user_scans_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
,[Table USG Lookups PCT!H\B|N1]
                        = IIF(i.rec_type = N'P'    AND a.ius_user_lookups_CNT > 0
                             ,100.0 * i.ius_user_lookups_CNT / a.ius_user_lookups_CNT
                             ,IIF(i.rec_type <> N'P',NULL,0))
----------------------------------------------
,[Table OPS LOB Contacts PCT!H\B|N1]
                        = IIF(    i.rec_type = N'P'
                              AND     ( a.ios_lob_fetch_pages_CNT
                                      + a.ios_lob_orphan_create_CNT
                                      + a.ios_lob_orphan_insert_CNT
                                      + a.ios_row_overflow_fetch_in_pages_CNT
                                      + a.ios_column_value_pull_in_row_CNT
                                      + a.ios_column_value_push_off_row_CNT
                                      ) > 0
                             ,100.0 * ( i.ios_lob_fetch_pages_CNT
                                      + i.ios_lob_orphan_create_CNT
                                      + i.ios_lob_orphan_insert_CNT
                                      + i.ios_row_overflow_fetch_in_pages_CNT
                                      + i.ios_column_value_pull_in_row_CNT
                                      + i.ios_column_value_push_off_row_CNT
                                      )
                                   /  ( a.ios_lob_fetch_pages_CNT
                                      + a.ios_lob_orphan_create_CNT
                                      + a.ios_lob_orphan_insert_CNT
                                      + a.ios_row_overflow_fetch_in_pages_CNT
                                      + a.ios_column_value_pull_in_row_CNT
                                      + a.ios_column_value_push_off_row_CNT
                                      )
                             ,IIF(i.rec_type <> N'P',NULL,0))

/******************************************************************************************************************************************\
--Index Priority Metrics
\******************************************************************************************************************************************/
,[Index OPS Wait TM!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_wait_MS_CNT > 0
                                 ,100.0 * i.ops_total_wait_MS_CNT / p.ops_total_wait_MS_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Wait CNT!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_wait_CNT > 0
                                 ,100.0 * i.ops_total_wait_CNT / p.ops_total_wait_CNT
                                 ,0)
                             ,NULL)
----------------------------------------------
,[Index OPS Locks CNT!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_lock_CNT > 0
                                 ,100.0 * i.ops_total_lock_CNT / p.ops_total_lock_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Lock Promo!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ios_lock_promotion_attempt_CNT > 0
                                 ,100.0 * i.ios_lock_promotion_attempt_CNT / p.ios_lock_promotion_attempt_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Promo Fail!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ios_lock_promotion_attempt_CNT > 0
                                 ,100.0 * (i.ios_lock_promotion_attempt_CNT - i.ios_lock_promotion_CNT) / p.ios_lock_promotion_attempt_CNT
                                 ,0)
                             ,NULL)
----------------------------------------------
,[Index OPS Page Split!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_page_split_CNT > 0
                                 ,100.0 * i.ops_total_page_split_CNT / p.ops_total_page_split_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Splits to Write PCT!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(i.ops_total_write_CNT > 0
                                 ,i.page_splits_to_write_PCT
                                 ,0)
                             ,NULL)
,[Index OPS Page Merge!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_page_merge_CNT > 0
                                 ,100.0 * i.ops_total_page_merge_CNT / p.ops_total_page_merge_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Merges to Write PCT!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(i.ops_total_write_CNT > 0
                                 ,i.page_Merge_to_write_PCT
                                 ,0)
                             ,NULL)
----------------------------------------------
,[Index MIX Advantage Weighted!H\G|N1]
                        = IIF(    i.type = N'M'
                              AND p.mix_Advantage_weighted_AMT > 0
                             ,100.0 * i.mix_Advantage_weighted_AMT / p.mix_Advantage_weighted_AMT
                             ,NULL)
,[Index MIX Advantage!H\G|N1]
                        = IIF(    i.type = N'M'
                              AND p.mix_Advantage_AMT > 0
                             ,100.0 * i.mix_Advantage_AMT / p.mix_Advantage_AMT
                             ,NULL)
----------------------------------------------
,[Index OPS Writes!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_write_CNT > 0
                                 ,100.0 * i.ops_total_write_CNT / p.ops_total_write_CNT
                                 ,0)
                             ,NULL)
,[Index USG Writes!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ius_user_updates_CNT > 0
                                 ,100.0 * i.ius_user_updates_CNT / p.ius_user_updates_CNT
                                 ,0)
                             ,NULL)
----------------------------------------------
,[Index BUF Percent in Buffer!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,CASE WHEN tbl.is_memory_optimized = 1 AND i.buffer_total_KB_CNT > 0.0
                                   THEN 100
                                   WHEN i.reserved_page_PG_CNT > 0
                                   THEN 100.0 * i.buffer_total_KB_CNT / (i.reserved_page_PG_CNT * 8.0)
                                   ELSE NULL
                              END
                             ,NULL)
----------------------------------------------
,[Index OPS R/W Ratio!H\G|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(i.ops_total_write_CNT > 0
                                 ,IIF(i.ops_total_read_CNT / i.ops_total_write_CNT < 100
                                     ,1.0 * i.ops_total_read_CNT / i.ops_total_write_CNT
                                     ,99)
                                 ,NULL)
                             ,NULL)
,[Index USG R/W Ratio!H\G|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(i.ius_user_updates_CNT > 0
                                 ,IIF(i.ius_User_read_CNT / i.ius_user_updates_CNT < 100
                                     ,1.0 * i.ius_User_read_CNT / i.ius_user_updates_CNT
                                     ,99)
                                 ,NULL)
                             ,NULL)
----------------------------------------------
,[Index OPS Reads PCT!H\G|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,i.ops_read_to_parent_PCT
                             ,NULL)
,[Index OPS Scans PCT!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ops_total_scan_CNT > 0
                                 ,100.0 * i.ops_total_scan_CNT / p.ops_total_scan_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Lookups PCT!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ios_singleton_lookup_CNT > 0
                                 ,100.0 * i.ios_singleton_lookup_CNT / p.ios_singleton_lookup_CNT
                                 ,0)
                             ,NULL)
,[Index OPS Forwarded Fetch!H\B|N1]
                        = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                             ,IIF(p.ios_forwarded_fetch_CNT > 0
                                 ,100.0 * i.ios_forwarded_fetch_CNT / p.ios_forwarded_fetch_CNT
                                 ,0)
                             ,NULL)
----------------------------------------------
,[Index USG Reads PCT!H\G|N1]
                        = IIF(   TRY_CAST(i.type AS INT) IS NOT NULL
                              OR i.type = N'M'
                             ,i.ius_read_to_parent_PCT
                             ,NULL)
,[Index USG Scans PCT!H\G|N1]
                        = IIF(   TRY_CAST(i.type AS INT) IS NOT NULL
                              OR i.type = N'M'
                             ,IIF(p.ius_user_scans_CNT > 0
                                 ,100.0 * i.ius_user_scans_CNT / p.ius_user_scans_CNT
                                 ,0)
                             ,NULL)
,[Index USG Lookups PCT!H\G|N1]
                        = IIF(   TRY_CAST(i.type AS INT) IS NOT NULL
                              OR i.type = N'M'
                             ,IIF(p.ius_user_lookups_CNT > 0
                                 ,100.0 * i.ius_user_lookups_CNT / p.ius_user_lookups_CNT
                                 ,0)
                             ,NULL)

----------------------------------------------
,[Index OPS LOB Contacts PCT!H\B|N1]
                        = IIF(    i.rec_type IN (N'I')
                              AND     ( p.ios_lob_fetch_pages_CNT
                                      + p.ios_lob_orphan_create_CNT           -- Bulk operations only
                                      + p.ios_lob_orphan_insert_CNT           -- Bulk operations only
                                      + p.ios_row_overflow_fetch_in_pages_CNT
                                      + p.ios_column_value_pull_in_row_CNT
                                      + p.ios_column_value_push_off_row_CNT
                                      ) > 0
                             ,100.0 * ( i.ios_lob_fetch_pages_CNT
                                      + i.ios_lob_orphan_create_CNT           -- Bulk operations only
                                      + i.ios_lob_orphan_insert_CNT           -- Bulk operations only
                                      + i.ios_row_overflow_fetch_in_pages_CNT
                                      + i.ios_column_value_pull_in_row_CNT
                                      + i.ios_column_value_push_off_row_CNT
                                      )
                                   /  ( p.ios_lob_fetch_pages_CNT
                                      + p.ios_lob_orphan_create_CNT           -- Bulk operations only
                                      + p.ios_lob_orphan_insert_CNT           -- Bulk operations only
                                      + p.ios_row_overflow_fetch_in_pages_CNT
                                      + p.ios_column_value_pull_in_row_CNT
                                      + p.ios_column_value_push_off_row_CNT
                                      )
                             ,NULL)
/******************************************************************************************************************************************\
--Index Priority Metrics FOR SORTING ACROSS INDEXES
\******************************************************************************************************************************************/
,[Index OPS Wait TM!H\B|N0]             = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_wait_MS_CNT         ,NULL)
,[Index OPS Wait CNT!H\B|N0]            = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_wait_CNT            ,NULL)
,[Index OPS Locks CNT!H\B|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_lock_CNT            ,NULL)
,[Index OPS Lock Promo!H\B|N0]          = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ios_lock_promotion_attempt_CNT,NULL)
,[Index OPS Promo Fail!H\B|N0]          = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ios_lock_promotion_attempt_CNT
                                                                                 -i.ios_lock_promotion_CNT        ,NULL)
----------------------------------------------
,[Index OPS Page Split!H\B|N0]          = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_page_split_CNT      ,NULL)
,[Index OPS Splits to Write PCT!H\B|N0] = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.page_splits_to_write_PCT      ,NULL)
,[Index OPS Page Merge!H\B|N0]          = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_page_merge_CNT      ,NULL)
,[Index OPS Merges to Write PCT!H\B|N0] = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.page_Merge_to_write_PCT       ,NULL)
----------------------------------------------
,[Index MIX Advantage Weighted!H\G|N0]  = IIF(          i.type = N'M'            ,i.mix_Advantage_weighted_AMT    ,NULL)
,[Index MIX Advantage!H\G|N0]           = IIF(          i.type = N'M'            ,i.mix_Advantage_AMT             ,NULL)
----------------------------------------------
,[Index OPS Writes!H\B|N0]              = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_write_CNT           ,NULL)
,[Index USG Writes!H\B|N0]              = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ius_user_updates_CNT          ,NULL)
----------------------------------------------
,[Index BUF Percent in Buffer!H\B|N0]   = IIF(TRY_CAST(i.type AS INT) IS NOT NULL
                                             ,CASE WHEN tbl.is_memory_optimized = 1 AND i.buffer_total_KB_CNT > 0.0
                                                   THEN 100
                                                   WHEN i.reserved_page_PG_CNT > 0
                                                   THEN 100.0 * i.buffer_total_KB_CNT / (i.reserved_page_PG_CNT * 8.0)
                                                   ELSE NULL
                                              END
                                             ,NULL)
----------------------------------------------
,[Index OPS R/W Ratio!H\G|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL AND p.obj_type_short_label <> N'TVF'
                                             ,IIF(i.ops_total_write_CNT > 0
                                                 ,IIF(i.ops_total_read_CNT / i.ops_total_write_CNT < 100
                                                     ,1.0 * i.ops_total_read_CNT / i.ops_total_write_CNT
                                                     ,99)
                                                 ,NULL)
                                             ,NULL)
,[Index USG R/W Ratio!H\G|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL
                                             ,IIF(i.ius_user_updates_CNT > 0
                                                 ,IIF(i.ius_User_read_CNT / i.ius_user_updates_CNT < 100
                                                     ,1.0 * i.ius_User_read_CNT / i.ius_user_updates_CNT
                                                     ,99)
                                                 ,NULL)
                                             ,NULL)
----------------------------------------------
,[Index OPS Reads!H\G|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_read_CNT        ,NULL)
,[Index OPS Scans!H\B|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ops_total_scan_CNT        ,NULL)
,[Index OPS Lookups!H\B|N0]         = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ios_singleton_lookup_CNT  ,NULL)
,[Index OPS Forwarded Fetch!H\B|N0] = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ios_forwarded_fetch_CNT   ,NULL)
----------------------------------------------
,[Index USG Reads!H\G|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ius_user_read_CNT        ,NULL)
,[Index USG Scans!H\G|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ius_user_scans_CNT       ,NULL)
,[Index USG Seeks!H\G|N0]           = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ius_user_seeks_CNT       ,NULL)
,[Index USG Lookups!H\G|N0]         = IIF(TRY_CAST(i.type AS INT) IS NOT NULL,i.ius_user_lookups_CNT     ,NULL)
----------------------------------------------
,[Index OPS LOB Contacts PCT!H\B|N0]    = IIF(    TRY_CAST(i.type AS INT) IS NOT NULL
                                             , i.ios_lob_fetch_pages_CNT
                                             + i.ios_lob_orphan_create_CNT           -- Bulk operations only
                                             + i.ios_lob_orphan_insert_CNT           -- Bulk operations only
                                             + i.ios_row_overflow_fetch_in_pages_CNT
                                             + i.ios_column_value_pull_in_row_CNT
                                             + i.ios_column_value_push_off_row_CNT
                                             ,NULL)
/******************************************************************************************************************************************\
-- Sorters/filters
\******************************************************************************************************************************************/
,[Table Busyness!H\B|N0]
                        = IIF(    i.rec_type = N'P'
                              AND  (  (TRY_CAST(COALESCE(a.buffer_total_KB_CNT     ,0.0) AS FLOAT) *  2.0)
                                    + (TRY_CAST(COALESCE(a.ius_user_updates_CNT    ,0.0) AS FLOAT) *  6.0)
                                    + (TRY_CAST(COALESCE(a.ius_User_read_CNT       ,0.0) AS FLOAT) *  1.0)
                                    + (TRY_CAST(COALESCE(a.ops_total_page_split_CNT,0.0) AS FLOAT) * 10.0)
                                   ) > 0
                             ,100.0 * (  (TRY_CAST(COALESCE(i.buffer_total_KB_CNT     ,0.0) AS FLOAT) *  2.0)
                                       + (TRY_CAST(COALESCE(i.ius_user_updates_CNT    ,0.0) AS FLOAT) *  6.0)
                                       + (TRY_CAST(COALESCE(i.ius_User_read_CNT       ,0.0) AS FLOAT) *  1.0)
                                       + (TRY_CAST(COALESCE(i.ops_total_page_split_CNT,0.0) AS FLOAT) * 10.0)
                                      )
                                    / (  (TRY_CAST(COALESCE(a.buffer_total_KB_CNT     ,0.0) AS FLOAT) *  2.0) -- Divide by SAMPLE total
                                       + (TRY_CAST(COALESCE(a.ius_user_updates_CNT    ,0.0) AS FLOAT) *  6.0)
                                       + (TRY_CAST(COALESCE(a.ius_User_read_CNT       ,0.0) AS FLOAT) *  1.0)
                                       + (TRY_CAST(COALESCE(a.ops_total_page_split_CNT,0.0) AS FLOAT) * 10.0)
                                      )
                             ,NULL)
,[Index Busyness!H\B\B|N0]
                        = IIF(    TRY_CAST(i.type AS INT) IS NOT NULL
                              AND  (  (TRY_CAST(COALESCE(p.buffer_total_KB_CNT     ,0.0) AS FLOAT) *  2.0)
                                    + (TRY_CAST(COALESCE(p.ius_user_updates_CNT    ,0.0) AS FLOAT) *  6.0)
                                    + (TRY_CAST(COALESCE(p.ius_User_read_CNT       ,0.0) AS FLOAT) *  1.0)
                                    + (TRY_CAST(COALESCE(p.ops_total_page_split_CNT,0.0) AS FLOAT) * 10.0)
                                   ) > 0
                             ,100.0 * (  (TRY_CAST(COALESCE(i.buffer_total_KB_CNT     ,0.0) AS FLOAT) *  2.0)
                                       + (TRY_CAST(COALESCE(i.ius_user_updates_CNT    ,0.0) AS FLOAT) *  6.0)
                                       + (TRY_CAST(COALESCE(i.ius_User_read_CNT       ,0.0) AS FLOAT) *  1.0)
                                       + (TRY_CAST(COALESCE(i.ops_total_page_split_CNT,0.0) AS FLOAT) * 10.0)
                                      )
                                    / (  (TRY_CAST(COALESCE(p.buffer_total_KB_CNT     ,0.0) AS FLOAT) *  2.0) -- Divide by TABLE total
                                       + (TRY_CAST(COALESCE(p.ius_user_updates_CNT    ,0.0) AS FLOAT) *  6.0)
                                       + (TRY_CAST(COALESCE(p.ius_User_read_CNT       ,0.0) AS FLOAT) *  1.0)
                                       + (TRY_CAST(COALESCE(p.ops_total_page_split_CNT,0.0) AS FLOAT) * 10.0)
                                      )
                             ,NULL)
,[Last Read Days\B|N0]  = DATEDIFF(DAY
                                  ,(SELECT MAX(dt) FROM (VALUES (i.ius_last_user_seek_DTTM)
                                                               ,(i.ius_last_user_scan_DTTM)
                                                               ,(i.ius_last_user_lookup_DTTM)) AS value(dt))
                                  ,sp.collection_DTTM
                                  )

----------------------------------------------------------------------------------------------------
-- Record Key IDs
----------------------------------------------------------------------------------------------------
,i.database_id
,i.parent_object_id
,i.object_id
,i.index_id
,i.type
,i.rec_type

/******************************************************************************************************************************************\
-- Missing Index details
\******************************************************************************************************************************************/
,[mix Advantage AMT\B|N0]             = IIF(i.type = N'M',i.mix_Advantage_AMT            ,NULL)
,[mix Advantage weighted AMT\B|N0]    = IIF(i.type = N'M',i.mix_Advantage_weighted_AMT   ,NULL)
,[mix unique compiles CNT\B|N0]       = IIF(i.type = N'M',i.mix_unique_compiles_CNT      ,NULL)
,[mix user seeks CNT\B|N0]            = IIF(i.type = N'M',i.ius_user_seeks_CNT           ,NULL)
,[mix user scans CNT\B|N0]            = IIF(i.type = N'M',i.ius_user_scans_CNT           ,NULL)
,[mix avg Total user cost AMT\B|N2]   = IIF(i.type = N'M',i.mix_avg_total_user_cost_AMT  ,NULL)
,[mix avg user impact AMT\B|N2]       = IIF(i.type = N'M',i.mix_avg_user_impact_AMT      ,NULL)
,[mix last user seek\G|DT]              = IIF(i.type = N'M',i.ius_last_user_seek_DTTM      ,NULL)
,[mix last user scan\G|DT]              = IIF(i.type = N'M',i.ius_last_user_scan_DTTM      ,NULL)
--------------------------------------
,[Table Total Reads CNT\B|N0]         = IIF(i.type = N'M',p.ius_user_read_CNT            ,NULL)
--------------------------------------
,[mix avg Total system cost AMT\B|N2] = IIF(i.type = N'M',i.mix_avg_total_system_cost_AMT,NULL)
,[mix avg system impact AMT\B|N2]     = IIF(i.type = N'M',i.mix_avg_system_impact_AMT    ,NULL)
,[mix system seeks CNT\B|N0]          = IIF(i.type = N'M',i.ius_system_seeks_CNT         ,NULL)
,[mix system scans CNT\B|N0]          = IIF(i.type = N'M',i.ius_system_scans_CNT         ,NULL)
,[mix last system seek\G|DT]            = IIF(i.type = N'M',i.ius_last_system_seek_DTTM    ,NULL)
,[mix last system scan\G|DT]            = IIF(i.type = N'M',i.ius_last_system_scan_DTTM    ,NULL)

/******************************************************************************************************************************************\
-- TOTAL Operational Stats - for all levels
\******************************************************************************************************************************************/
,[ops_total_contacts_CNT\B|N0]                   = i.ops_total_contacts_CNT
,[ops_total_write_CNT\B|N0]                      = i.ops_total_write_CNT
,[ops_total_insert_CNT\B|N0]                     = i.ops_total_insert_CNT
,[ops_total_update_CNT\B|N0]                     = i.ops_total_update_CNT
,[ops_total_delete_CNT\B|N0]                     = i.ops_total_delete_CNT
,[ops_total_read_CNT\G|N0]                       = i.ops_total_read_CNT
,[ops_total_scan_CNT\B|N0]                       = i.ops_total_scan_CNT
,[ops_total_scan_retries_CNT\B|N0]               = i.ops_total_scan_retries_CNT
-------------------------------------------------
,[ops_total_wait_CNT\B|N0]                       = i.ops_total_wait_CNT
,[ops_total_wait_MS_CNT\B|N0]                    = i.ops_total_wait_MS_CNT
,[ops_total_wait_MS_AVG\B|N2]                    = i.ops_total_wait_MS_AVG

/******************************************************************************************************************************************\
-- Index Operational Stats
\******************************************************************************************************************************************/
,[ios_singleton_lookup_CNT\B|N0]                 = IIF(i.rec_type = N'I',i.ios_singleton_lookup_CNT                 ,NULL)
,[ios_forwarded_fetch_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ios_forwarded_fetch_CNT                  ,NULL)
,[ios_lob_fetch_pages_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ios_lob_fetch_pages_CNT                  ,NULL)
,[ios_partition_CNT\B|N0]                        = IIF(i.rec_type = N'I',i.ios_partition_CNT                        ,NULL)
-------------------------------------------------
,[ios_leaf_insert_CNT\B|N0]                      = IIF(i.rec_type = N'I',i.ios_leaf_insert_CNT                      ,NULL)
,[ios_leaf_update_CNT\B|N0]                      = IIF(i.rec_type = N'I',i.ios_leaf_update_CNT                      ,NULL)
,[ios_leaf_delete_CNT\B|N0]                      = IIF(i.rec_type = N'I',i.ios_leaf_delete_CNT                      ,NULL)
,[ios_leaf_ghost_CNT\B|N0]                       = IIF(i.rec_type = N'I',i.ios_leaf_ghost_CNT                       ,NULL)
,[ios_total_leaf_Contacts_CNT\B|N0]              = IIF(i.rec_type = N'I',i.ios_total_leaf_Contacts_CNT              ,NULL)
-------------------------------------------------
,[ios_nonleaf_insert_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ios_nonleaf_insert_CNT                   ,NULL)
,[ios_nonleaf_delete_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ios_nonleaf_delete_CNT                   ,NULL)
,[ios_nonleaf_update_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ios_nonleaf_update_CNT                   ,NULL)
,[ios_total_nonleaf_Contacts_CNT\B|N0]           = IIF(i.rec_type = N'I',i.ios_total_nonleaf_Contacts_CNT           ,NULL)
-------------------------------------------------
,[ios_leaf_allocation_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ios_leaf_allocation_CNT            ,NULL)
,[ios_nonleaf_allocation_CNT\B|N0]               = IIF(i.rec_type = N'I',i.ios_nonleaf_allocation_CNT         ,NULL)
,[ops_total_page_split_CNT\B|N0]                 = IIF(i.rec_type = N'I',i.ops_total_page_split_CNT                 ,NULL)
-------------------------------------------------
,[ios_leaf_page_merge_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ios_leaf_page_merge_CNT                  ,NULL)
,[ios_nonleaf_page_merge_CNT\B|N0]               = IIF(i.rec_type = N'I',i.ios_nonleaf_page_merge_CNT               ,NULL)
,[ops_total_page_merge_CNT\B|N0]                 = IIF(i.rec_type = N'I',i.ops_total_page_merge_CNT                 ,NULL)
-------------------------------------------------
,[ios_lob_fetch_bytes_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ios_lob_fetch_bytes_CNT                  ,NULL)
,[ios_lob_orphan_create_CNT\B|N0]                = IIF(i.rec_type = N'I',i.ios_lob_orphan_create_CNT                ,NULL)
,[ios_lob_orphan_insert_CNT\B|N0]                = IIF(i.rec_type = N'I',i.ios_lob_orphan_insert_CNT                ,NULL)
,[ios_row_overflow_fetch_in_pages_CNT\B|N0]      = IIF(i.rec_type = N'I',i.ios_row_overflow_fetch_in_pages_CNT      ,NULL)
,[ios_row_overflow_fetch_in_bytes_CNT\B|N0]      = IIF(i.rec_type = N'I',i.ios_row_overflow_fetch_in_bytes_CNT      ,NULL)
,[ios_column_value_push_off_row_CNT\B|N0]        = IIF(i.rec_type = N'I',i.ios_column_value_push_off_row_CNT        ,NULL)
,[ios_column_value_pull_in_row_CNT\B|N0]         = IIF(i.rec_type = N'I',i.ios_column_value_pull_in_row_CNT         ,NULL)
-------------------------------------------------
,[ops_total_lock_CNT\B|N0]                       = IIF(i.rec_type = N'I',i.ops_total_lock_CNT                       ,NULL)
,[ops_total_lock_wait_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ops_total_lock_wait_CNT                  ,NULL)
,[ops_total_lock_wait_MS_CNT\B|N0]               = IIF(i.rec_type = N'I',i.ops_total_lock_wait_MS_CNT               ,NULL)
,[ops_total_lock_wait_MS_AVG\B|N2]               = IIF(i.rec_type = N'I',i.ops_total_lock_wait_MS_AVG               ,NULL)
-------------------------------------------------
,[ios_row_lock_CNT\B|N0]                         = IIF(i.rec_type = N'I',i.ios_row_lock_CNT                         ,NULL)
,[ios_row_lock_wait_CNT\B|N0]                    = IIF(i.rec_type = N'I',i.ios_row_lock_wait_CNT                    ,NULL)
,[ios_row_lock_wait_MS_CNT\B|N0]                 = IIF(i.rec_type = N'I',i.ios_row_lock_wait_MS_CNT                 ,NULL)
,[ios_row_lock_wait_MS_AVG\B|N2]                 = IIF(i.rec_type = N'I',i.ios_row_lock_wait_MS_AVG                 ,NULL)
-------------------------------------------------
,[ios_page_lock_CNT\B|N0]                        = IIF(i.rec_type = N'I',i.ios_page_lock_CNT                        ,NULL)
,[ios_page_lock_wait_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ios_page_lock_wait_CNT                   ,NULL)
,[ios_page_lock_wait_MS_CNT\B|N0]                = IIF(i.rec_type = N'I',i.ios_page_lock_wait_MS_CNT                ,NULL)
,[ios_page_lock_wait_MS_AVG\B|N2]                = IIF(i.rec_type = N'I',i.ios_page_lock_wait_MS_AVG                ,NULL)
-------------------------------------------------
,[ios_lock_promotion_attempt_CNT\B|N0]           = IIF(i.rec_type = N'I',i.ios_lock_promotion_attempt_CNT           ,NULL)
,[ios_lock_promotion_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ios_lock_promotion_CNT                   ,NULL)
,[ios_lock_promotion_fail_CNT\B|N0]              = IIF(i.rec_type = N'I',i.ios_lock_promotion_fail_CNT              ,NULL)
-------------------------------------------------
,[ios_page_latch_wait_CNT\B|N0]                  = IIF(i.rec_type = N'I',i.ios_page_latch_wait_CNT                  ,NULL)
,[ios_page_latch_wait_MS_CNT\B|N0]               = IIF(i.rec_type = N'I',i.ios_page_latch_wait_MS_CNT               ,NULL)
,[ios_page_latch_wait_MS_AVG\B|N2]               = IIF(i.rec_type = N'I',i.ios_page_latch_wait_MS_AVG               ,NULL)
-------------------------------------------------
,[ios_page_io_latch_wait_CNT\B|N0]               = IIF(i.rec_type = N'I',i.ios_page_io_latch_wait_CNT               ,NULL)
,[ios_page_io_latch_wait_MS_CNT\B|N0]            = IIF(i.rec_type = N'I',i.ios_page_io_latch_wait_MS_CNT            ,NULL)
,[ios_page_io_latch_wait_MS_AVG\B|N2]            = IIF(i.rec_type = N'I',i.ios_page_io_latch_wait_MS_AVG            ,NULL)
-------------------------------------------------
,[ios_tree_page_latch_wait_CNT\B|N0]             = IIF(i.rec_type = N'I',i.ios_tree_page_latch_wait_CNT             ,NULL)
,[ios_tree_page_latch_wait_MS_CNT\B|N0]          = IIF(i.rec_type = N'I',i.ios_tree_page_latch_wait_MS_CNT          ,NULL)
,[ios_tree_page_latch_wait_MS_AVG\B|N2]          = IIF(i.rec_type = N'I',i.ios_tree_page_latch_wait_MS_AVG          ,NULL)
-------------------------------------------------
,[ios_tree_page_io_latch_wait_CNT\B|N0]          = IIF(i.rec_type = N'I',i.ios_tree_page_io_latch_wait_CNT          ,NULL)
,[ios_tree_page_io_latch_wait_MS_CNT\B|N0]       = IIF(i.rec_type = N'I',i.ios_tree_page_io_latch_wait_MS_CNT       ,NULL)
,[ios_tree_page_io_latch_wait_MS_AVG\B|N2]       = IIF(i.rec_type = N'I',i.ios_tree_page_io_latch_wait_MS_AVG       ,NULL)
-------------------------------------------------
,[ios_page_compression_attempt_CNT\B|N0]         = IIF(i.rec_type = N'I',i.ios_page_compression_attempt_CNT         ,NULL)
-- Fail PCT                                        IIF(i.rec_type = N'I',                                           ,NULL)
,[ios_page_compression_success_CNT\B|N0]         = IIF(i.rec_type = N'I',i.ios_page_compression_success_CNT         ,NULL)
,[ios_page_compression_fail_CNT\B|N0]            = IIF(i.rec_type = N'I',i.ios_page_compression_fail_CNT            ,NULL)
-------------------------------------------------
,[ios_version_generated_off_row_CNT\B|N0]         = IIF(i.rec_type = N'I',i.ios_version_generated_off_row_CNT        ,NULL)
,[ios_ghost_version_inrow_CNT\B|N0]               = IIF(i.rec_type = N'I',i.ios_ghost_version_inrow_CNT              ,NULL)
,[ios_ghost_version_off_row_CNT\B|N0]             = IIF(i.rec_type = N'I',i.ios_ghost_version_off_row_CNT            ,NULL)
,[ios_insert_over_ghost_version_inrow_CNT\B|N0]   = IIF(i.rec_type = N'I',i.ios_insert_over_ghost_version_inrow_CNT  ,NULL)
,[ios_insert_over_ghost_version_off_row_CNT\B|N0] = IIF(i.rec_type = N'I',i.ios_insert_over_ghost_version_off_row_CNT,NULL)
,[ios_total_Column_value_off_row_CNT\B|N0]        = IIF(i.rec_type = N'I',i.ios_total_Column_value_off_row_CNT       ,NULL)

/******************************************************************************************************************************************\
-- Index Usage Stats
\******************************************************************************************************************************************/
,[ius_User_total_CNT\B|N0]                       = IIF(i.rec_type = N'I',i.ius_User_total_CNT    ,NULL)
,[ius_user_updates_CNT\B|N0]                     = IIF(i.rec_type = N'I',i.ius_user_updates_CNT  ,NULL)
,[ius_User_read_CNT\B|N0]                        = IIF(i.rec_type = N'I',i.ius_User_read_CNT     ,NULL)
,[ius_user_seeks_CNT\B|N0]                       = IIF(i.rec_type = N'I',i.ius_user_seeks_CNT    ,NULL)
,[ius_user_scans_CNT\B|N0]                       = IIF(i.rec_type = N'I',i.ius_user_scans_CNT    ,NULL)
,[ius_user_lookups_CNT\B|N0]                     = IIF(i.rec_type = N'I',i.ius_user_lookups_CNT  ,NULL)
,[ius_system_seeks_CNT\B|N0]                     = IIF(i.rec_type = N'I',i.ius_system_seeks_CNT  ,NULL)
,[ius_system_scans_CNT\B|N0]                     = IIF(i.rec_type = N'I',i.ius_system_scans_CNT  ,NULL)
,[ius_system_lookups_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ius_system_lookups_CNT,NULL)
,[ius_system_updates_CNT\B|N0]                   = IIF(i.rec_type = N'I',i.ius_system_updates_CNT,NULL)
----------------------------------
,[ius_last_user_seek_DAY\B|N]                    = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_user_seek_DTTM    ,i.collection_DTTM),NULL)
,[ius_last_user_scan_DAY\B|N]                    = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_user_scan_DTTM    ,i.collection_DTTM),NULL)
,[ius_last_user_lookup_DAY\B|N]                  = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_user_lookup_DTTM  ,i.collection_DTTM),NULL)
,[ius_last_user_update_DAY\B|N]                  = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_user_update_DTTM  ,i.collection_DTTM),NULL)
,[ius_last_system_seek_DAY\B|N]                  = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_system_seek_DTTM  ,i.collection_DTTM),NULL)
,[ius_last_system_scan_DAY\B|N]                  = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_system_scan_DTTM  ,i.collection_DTTM),NULL)
,[ius_last_system_lookup_DAY\B|N]                = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_system_lookup_DTTM,i.collection_DTTM),NULL)
,[ius_last_system_update_DAY\B|N]                = IIF(i.rec_type = N'I',DATEDIFF(DAY,i.ius_last_system_update_DTTM,i.collection_DTTM),NULL)
----------------------------------
,[ius_no_read_user_updates_CNT\B]                = IIF(i.rec_type = N'I',i.ius_no_read_user_updates_CNT,NULL)
,[ius_last_read_days_ago\B]                      = IIF(i.rec_type = N'I'
                                                      ,IIF(i.ius_last_read_days_ago = 999999,NULL,i.ius_last_read_days_ago)
                                                      ,NULL)
,[ius_last_write_days_ago\B]                     = IIF(i.rec_type = N'I'
                                                      ,IIF(i.ius_last_write_days_ago = 999999,NULL,i.ius_last_write_days_ago)
                                                      ,NULL)

/******************************************************************************************************************************************\
-- InMemory (XTP) Index Stats
\******************************************************************************************************************************************/
,[xtp_scans_started_CNT\B|N0]                    = IIF(tbl.is_memory_optimized = 1,i.xtp_scans_started_CNT               ,NULL)
,[xtp_scans_retries_CNT\B|N0]                    = IIF(tbl.is_memory_optimized = 1,i.xtp_scans_retries_CNT               ,NULL)
--------------------------------------------
,[xtp_unique_constraint_violations_CNT\B|N0]     = IIF(tbl.is_memory_optimized = 1,i.xtp_unique_constraint_violations_CNT,NULL)
,[xtp_write_conflicts_CNT\B|N0]                  = IIF(tbl.is_memory_optimized = 1,i.xtp_write_conflicts_CNT             ,NULL)
,[xtp_page_update_CNT\B|N0]                      = IIF(tbl.is_memory_optimized = 1,i.xtp_page_update_CNT                 ,NULL)
,[xtp_page_update_retry_CNT\B|N0]                = IIF(tbl.is_memory_optimized = 1,i.xtp_page_update_retry_CNT           ,NULL)
,[xtp_row_insert_attempts_CNT\B|N0]              = IIF(tbl.is_memory_optimized = 1,i.xtp_row_insert_attempts_CNT         ,NULL)
--------------------------------------------
,[xtp_row_update_attempts_CNT\B|N0]              = IIF(tbl.is_memory_optimized = 1,i.xtp_row_update_attempts_CNT         ,NULL)
--------------------------------------------
,[xtp_row_delete_attempts_CNT\B|N0]              = IIF(tbl.is_memory_optimized = 1,i.xtp_row_delete_attempts_CNT         ,NULL)
--------------------------------------------
,[xtp_page_split_CNT\B|N0]                       = IIF(tbl.is_memory_optimized = 1,i.xtp_page_split_CNT                  ,NULL)
,[xtp_page_split_retry_CNT\B|N0]                 = IIF(tbl.is_memory_optimized = 1,i.xtp_page_split_retry_CNT            ,NULL)
,[xtp_key_split_CNT\B|N0]                        = IIF(tbl.is_memory_optimized = 1,i.xtp_key_split_CNT                   ,NULL)
,[xtp_key_split_retry_CNT\B|N0]                  = IIF(tbl.is_memory_optimized = 1,i.xtp_key_split_retry_CNT             ,NULL)
--------------------------------------------
,[xtp_page_merge_CNT\B|N0]                       = IIF(tbl.is_memory_optimized = 1,i.xtp_page_merge_CNT                  ,NULL)
,[xtp_page_merge_retry_CNT\B|N0]                 = IIF(tbl.is_memory_optimized = 1,i.xtp_page_merge_retry_CNT            ,NULL)
,[xtp_key_merge_CNT\B|N0]                        = IIF(tbl.is_memory_optimized = 1,i.xtp_key_merge_CNT                   ,NULL)
,[xtp_key_merge_retry_CNT\B|N0]                  = IIF(tbl.is_memory_optimized = 1,i.xtp_key_merge_retry_CNT             ,NULL)
--------------------------------------------
,[xtp_rows_returned_CNT\B|N0]                    = IIF(tbl.is_memory_optimized = 1,i.xtp_rows_returned_CNT               ,NULL)
,[xtp_rows_touched_CNT\B|N0]                     = IIF(tbl.is_memory_optimized = 1,i.xtp_rows_touched_CNT                ,NULL)
,[xtp_delta_pages_CNT\B|N0]                      = IIF(tbl.is_memory_optimized = 1,i.xtp_delta_pages_CNT                 ,NULL)
,[xtp_leaf_pages_CNT\B|N0]                       = IIF(tbl.is_memory_optimized = 1,i.xtp_leaf_pages_CNT                  ,NULL)
,[xtp_page_consolidation_CNT\B|N0]               = IIF(tbl.is_memory_optimized = 1,i.xtp_page_consolidation_CNT          ,NULL)
,[xtp_page_consolidation_retry_CNT\B|N0]         = IIF(tbl.is_memory_optimized = 1,i.xtp_page_consolidation_retry_CNT    ,NULL)
,[xtp_uses_key_normalization\B]                  = IIF(tbl.is_memory_optimized = 1,i.xtp_uses_key_normalization          ,NULL)
,[xtp_allocated_bytes_CNT\B|N0]                  = IIF(tbl.is_memory_optimized = 1,i.xtp_allocated_bytes_CNT             ,NULL)
,[xtp_used_bytes_CNT\B|N0]                       = IIF(tbl.is_memory_optimized = 1,i.xtp_used_bytes_CNT                  ,NULL)
,[xtp_allocation_CNT\B|N0]                       = IIF(tbl.is_memory_optimized = 1,i.xtp_allocation_CNT                  ,NULL)

/******************************************************************************************************************************************\
-- ColumnStore Index Stats
\******************************************************************************************************************************************/
,[cs_partition_CNT\B|N0]                          = IIF(i.type IN (N'5',N'6'),i.cs_partition_CNT             ,NULL)
,[cs_row_group_CNT\B|N0]                          = IIF(i.type IN (N'5',N'6'),i.cs_row_group_CNT             ,NULL)
,[cs_index_scan_CNT\B|N0]                         = IIF(i.type IN (N'5',N'6'),i.cs_index_scan_CNT            ,NULL)
,[cs_scan_CNT\B|N0]                               = IIF(i.type IN (N'5',N'6'),i.cs_scan_CNT                  ,NULL)
,[cs_delete_buffer_scan_CNT\B|N0]                 = IIF(i.type IN (N'5',N'6'),i.cs_delete_buffer_scan_CNT    ,NULL)
--------------------------------------------
,[cs_row_group_lock_CNT\B|N0]                     = IIF(i.type IN (N'5',N'6'),i.cs_row_group_lock_CNT        ,NULL)
,[cs_row_group_lock_wait_CNT\B|N0]                = IIF(i.type IN (N'5',N'6'),i.cs_row_group_lock_wait_CNT   ,NULL)
,[cs_row_group_lock_wait_MS_CNT\B|N2]             = IIF(i.type IN (N'5',N'6'),i.cs_row_group_lock_wait_MS_CNT,NULL)
,[cs_row_group_lock_wait_MS_AVG\B]                = IIF(i.type IN (N'5',N'6'),i.cs_row_group_lock_wait_MS_AVG,NULL)
--------------------------------------------
,[cs_returned_row_CNT\B|N0]                       = IIF(i.type IN (N'5',N'6'),i.cs_returned_row_CNT          ,NULL)
,[cs_returned_aggregate_CNT\B|N0]                 = IIF(i.type IN (N'5',N'6'),i.cs_returned_aggregate_CNT    ,NULL)
,[cs_returned_group_CNT\B|N0]                     = IIF(i.type IN (N'5',N'6'),i.cs_returned_group_CNT        ,NULL)
,[cs_input_groupby_row_CNT\B|N0]                  = IIF(i.type IN (N'5',N'6'),i.cs_input_groupby_row_CNT     ,NULL)

/******************************************************************************************************************************************\
-- FROM
\******************************************************************************************************************************************/
/*** LOCAL TESTING ***
SELECT i.database_id,i.history_source_object_id,i.parent_object_id,i.object_id,i.obj_name,i.index_id,i.type
      ,hst_src.object_id,hst_src.obj_name
--*/
  FROM [tempdb].[dbo].[SQLXL_Index_Compilation] AS i

  LEFT OUTER
  JOIN [tempdb].[dbo].[SQLXL_Index_Compilation] AS hst_src
    ON i.database_id              = hst_src.database_id
   AND i.history_source_object_id = hst_src.parent_object_id
   AND i.history_source_object_id = hst_src.OBJECT_ID
   AND i.history_source_object_id = hst_src.index_id
   AND N'U'                       = hst_src.type
-- WHERE i.object_id = 1653580929
-- WHERE i.obj_name LIKE N'%_archive'
 CROSS
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_Startup_Parameters] AS sp
 CROSS
  JOIN (-- Instance level
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'A'
       )                 AS a
  LEFT OUTER
  JOIN (-- Database level
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'D'
       )                 AS d
    ON i.database_id      = d.database_id
  LEFT OUTER                                                       -- outer needed for ALL row
  JOIN [tempdb].[dbo].[SQLXL_Index_sys_tables] AS tbl
    ON i.database_id = tbl.database_id
   AND i.object_ID   = tbl.object_id
  LEFT OUTER                                                       -- outer needed for ALL row
  JOIN (-- Parent Object level
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'P'
       )                 AS p
    ON i.database_id      = p.database_id
   AND i.parent_object_id = p.parent_object_id
  LEFT OUTER
  JOIN (-- History table level
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE rec_type = N'H'
       )                 AS s
    ON i.database_id      = s.database_id
   AND i.parent_object_id = s.parent_object_id
   AND i.object_id        = s.object_id
  LEFT OUTER
  JOIN (-- physical table metrics. Views included for their clustering index
        SELECT *
          FROM [tempdb].[dbo].[SQLXL_Index_Compilation]
         WHERE type IN (N'0',N'1',N'5')
       )                 AS raw
    ON i.database_id      = raw.database_id
   AND i.parent_object_id = raw.object_id
   AND i.object_id        = raw.object_id
 WHERE 1 = 1
-- Omitting non SQL Table Values Functions for now
   AND i.obj_type NOT IN (N'FT',N'IF')

 ORDER BY
       IIF(i.rec_type = N'A',1,0) -- sort Instance/Sample level to bottom
      ,i.tbl_priority_metric DESC
      ,i.database_ID
      ,i.parent_object_ID
      ,i.index_id
      ,i.type

OPTION (FORCE ORDER)

GO -- end of stored procedure/function/T-SQL script/CREATE VIEW

RAISERROR ('Created procedure [dbo].[SQLXL_Index_Present] ...',0,0) WITH NOWAIT;
IF @@TRANCOUNT > 0 ROLLBACK;
GO

/*########################################################################################################################################*\
Copy procedure SQLXL_Index_Present to tempdb
\*########################################################################################################################################*/
IF DB_NAME() <> N'tempdb'
BEGIN
   DECLARE @sql        NVARCHAR(MAX)
   SELECT @sql = REPLACE(definition,'''','''''')
     FROM sys.sql_modules 
    WHERE OBJECT_ID IN (SELECT object_id FROM sys.objects WHERE name = N'SQLXL_Index_Present')
   SET @sql = N'USE [tempdb];
   EXEC(''IF OBJECT_ID(''''[dbo].[SQLXL_Index_Present]'''') IS NOT NULL DROP PROCEDURE [dbo].[SQLXL_Index_Present]'');
   EXEC(''' + @sql +''')'
   EXEC(@sql)
   ---------------------------------------------------------------
   -- drop procedure SQLXL_Instance in this database after copy
   ---------------------------------------------------------------
   IF object_id('[dbo].[SQLXL_Index_Present]') IS NOT NULL DROP PROCEDURE [dbo].[SQLXL_Index_Present];
END;


/******************************************************************************************************************************************\
All SQLXL tables objects are created in [tempdb] (must be lower case to support case sensitive collation on installation)
Procedures are created in the connected-to database and then copied to [tempdb]. After copy they are deleted from the conencted-to database
Functions are created in tempdb by using the EXEC('USE tempdb;EXEC(''create function code'')') construct
\******************************************************************************************************************************************/

/******************************************************************************************************************************************/
-- Session Environment settings
/******************************************************************************************************************************************/
SET ANSI_NULL_DFLT_ON,ANSI_NULLS,ANSI_PADDING,ARITHABORT,CONCAT_NULL_YIELDS_NULL,CURSOR_CLOSE_ON_COMMIT,NOCOUNT,QUOTED_IDENTIFIER ON;
SET ANSI_WARNINGS,ARITHIGNORE,FMTONLY,FORCEPLAN,IMPLICIT_TRANSACTIONS,NOEXEC,NUMERIC_ROUNDABORT,XACT_ABORT OFF;
SET STATISTICS IO,PROFILE,TIME,XML OFF;
SET DATEFORMAT                  YMD;
SET DEADLOCK_PRIORITY           -10;  -- Lowest priority
SET LOCK_TIMEOUT              10000;  -- in milliseconds
SET QUERY_GOVERNOR_COST_LIMIT     0;  -- 0 (the default) turns off the query governor, queries of any cost are allowed to execute.
SET TEXTSIZE             2147483647;  -- Max length of Excel cell contents is 32767
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

RAISERROR (N'Creating SQLXL_Base_Function',0,0) WITH NOWAIT;

/******************************************************************************************************************************************/
-- function tempdb.dbo.SQLXL_Strip_Strings - remove character elements found in a string
/******************************************************************************************************************************************/
EXEC ('USE tempdb;
IF OBJECT_ID(''tempdb.dbo.SQLXL_Strip_Strings'') IS NULL
   EXEC (''CREATE FUNCTION dbo.SQLXL_Strip_Strings() RETURNS BIT AS BEGIN RETURN 0 END;'')');

EXEC(N'USE tempdb; EXEC(''
ALTER FUNCTION dbo.SQLXL_Strip_Strings (@String NVARCHAR(MAX),@Match NVARCHAR(MAX),@replace NVARCHAR(MAX))
RETURNS NVARCHAR(MAX)
WITH RETURNS NULL ON NULL INPUT
AS
BEGIN
   IF @replace IS NULL SET @replace = N''''''''
   SET @Match =  N''''%[''''+@Match+'''']%''''
   WHILE PATINDEX(@Match, @String) > 0 SET @String = STUFF(@String,PATINDEX(@Match,@String),1,@replace)
   IF @string = N'''''''' SET @string = NULL
   RETURN @String
END'')
');

RAISERROR ('... tempdb.dbo.SQLXL_Strip_Strings',0,0) WITH NOWAIT;

/******************************************************************************************************************************************/
-- function tempdb.dbo.SQLXL_Keep_Strings - keep only character elements found in a string
/******************************************************************************************************************************************/
EXEC ('USE tempdb;
IF OBJECT_ID(''tempdb.dbo.SQLXL_Keep_Strings'') IS NULL
   EXEC (''CREATE FUNCTION dbo.SQLXL_Keep_Strings() RETURNS BIT AS BEGIN RETURN 0 END;'')');

EXEC(N'USE tempdb; EXEC(N''
ALTER FUNCTION dbo.SQLXL_Keep_Strings (@String NVARCHAR(MAX),@Match NVARCHAR(MAX),@replace NVARCHAR(MAX))
RETURNS NVARCHAR(MAX)
WITH RETURNS NULL ON NULL INPUT
AS
BEGIN
   IF @replace IS NULL SET @replace = N''''''''
   SET @Match =  N''''%[^''''+@Match+'''']%''''
   WHILE PATINDEX(@Match, @String) > 0 SET @String = STUFF(@String,PATINDEX(@Match,@String),1,@replace)
   IF @string = N'''''''' SET @string = NULL
   RETURN @String
END'')
');

RAISERROR ('... tempdb.dbo.SQLXL_Keep_Strings',0,0) WITH NOWAIT;

/******************************************************************************************************************************************/
-- function tempdb.dbo.SQLXL_Parse_Strings -  to, unh, parse strings using native functions if available or recursive CTE
/******************************************************************************************************************************************/
EXEC ('USE tempdb;
IF OBJECT_ID(''tempdb.dbo.SQLXL_Parse_Strings'') IS NULL
   EXEC (''CREATE FUNCTION dbo.SQLXL_Parse_Strings() RETURNS @t TABLE (r BIT, s BIT) AS BEGIN RETURN END'')');

-----------------------------------------------------------------------------------------------------------
-- SQL 2022+ - use function STRING_SPLIT if possible, else recursive CTE
-----------------------------------------------------------------------------------------------------------
IF CAST(PARSENAME(CONVERT(VARCHAR(32),SERVERPROPERTY('productversion')),4) AS INT) >= 16 -- SQL 2022+
EXEC(N'USE tempdb;EXEC(N''
ALTER FUNCTION dbo.SQLXL_Parse_Strings (@string [NVARCHAR](MAX), @separator [NVARCHAR](MAX))
RETURNS @parsedString TABLE (RowNbr BIGINT, string [NVARCHAR](MAX) NULL)
WITH EXECUTE AS CALLER
AS
BEGIN

  DECLARE @lensep INT = DATALENGTH(@separator)/2;

  IF     @lensep       = 1    -- STRING_SPLIT function only accepts a single splitting charatcer
     AND LEN(@string) <= 4000 -- STRING_SPLIT function only accepts strings up to 4000 characters
  BEGIN
     INSERT INTO @parsedString
     SELECT ordinal
           ,value
       FROM STRING_SPLIT(@string,@separator,1);
  END
  ELSE
  BEGIN
     SET @string=@string+@separator;

     WITH p
     AS (SELECT CAST(1 AS BIGINT)                              AS StartPos
               ,CHARINDEX(@separator,@string)                  AS EndPos
         UNION ALL                                             
         SELECT EndPos + @lensep                               AS StartPos
               ,CHARINDEX(@separator,@string,EndPos + @lensep) AS EndPos
           FROM p
          WHERE CHARINDEX(@separator,@string,EndPos + @lensep) > 0
        )
     INSERT INTO @parsedString
     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL))
           ,SUBSTRING(@string,StartPos,EndPos-StartPos)
       FROM p
     OPTION (MAXRECURSION 0)
  END

  RETURN
END'')
')

ELSE
BEGIN
-----------------------------------------------------------------------------------------------------------
-- SQL 2016+ - use function STRING_SPLIT if possible, and ROW_NUMBER to order the result
-- else recursive CTE
-- 
-----------------------------------------------------------------------------------------------------------
   IF CAST(PARSENAME(CONVERT(VARCHAR(32),SERVERPROPERTY('productversion')),4) AS INT) >= 13 -- SQL 2016+
   EXEC(N'USE tempdb;EXEC(N''
ALTER FUNCTION dbo.SQLXL_Parse_Strings (@string [NVARCHAR](MAX), @separator [NVARCHAR](MAX))
RETURNS @parsedString TABLE (RowNbr BIGINT, string [NVARCHAR](MAX) NULL)
WITH EXECUTE AS CALLER
AS
BEGIN

  DECLARE @lensep INT = DATALENGTH(@separator)/2;

  IF     @lensep       = 1    -- STRING_SPLIT function only accepts a single splitting character
     AND LEN(@string) <= 4000 -- STRING_SPLIT function only accepts strings up to 4000 characters
  BEGIN
     INSERT INTO @parsedString
     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)),value
       FROM STRING_SPLIT(@string,@separator);
  END
  ELSE
  BEGIN
     SET @string=@string+@separator;

     WITH p
     AS (SELECT CAST(1 AS BIGINT)                        AS StartPos
               ,CHARINDEX(@separator,@string)            AS EndPos
         UNION ALL
         SELECT EndPos + @lensep                         AS StartPos
               ,CHARINDEX(@separator,@string,EndPos + @lensep) AS EndPos
           FROM p
          WHERE CHARINDEX(@separator,@string,EndPos + @lensep) > 0
        )
     INSERT INTO @parsedString
     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL))
           ,SUBSTRING(@string,StartPos,EndPos-StartPos)
       FROM p
     OPTION (MAXRECURSION 0)
  END

  RETURN
END'')
')

   ELSE
-----------------------------------------------------------------------------------------------------------
-- Use only recursive CTE
-----------------------------------------------------------------------------------------------------------
   EXEC(N'USE tempdb;EXEC(N''
ALTER FUNCTION dbo.SQLXL_Parse_Strings (@string [NVARCHAR](MAX), @separator [NVARCHAR](MAX))
RETURNS @parsedString TABLE (RowNbr BIGINT, string [NVARCHAR](MAX) NULL)
WITH EXECUTE AS CALLER
AS
BEGIN

  DECLARE @lensep INT = DATALENGTH(@separator)/2;

  BEGIN
     SET @string=@string+@separator;

     WITH p
     AS (SELECT CAST(1 AS BIGINT)                        AS StartPos
               ,CHARINDEX(@separator,@string)            AS EndPos
         UNION ALL
         SELECT EndPos + @lensep                         AS StartPos
               ,CHARINDEX(@separator,@string,EndPos + @lensep) AS EndPos
           FROM p
          WHERE CHARINDEX(@separator,@string,EndPos + @lensep) > 0
        )
     INSERT INTO @parsedString
     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL))
           ,SUBSTRING(@string,StartPos,EndPos-StartPos)
       FROM p
     OPTION (MAXRECURSION 0)
  END

  RETURN
END'')
');
END

RAISERROR ('... tempdb.dbo.SQLXL_Parse_Strings',0,0) WITH NOWAIT;

/******************************************************************************************************************************************/
-- function tempdb.dbo.SQLXL_Numbers
/******************************************************************************************************************************************/
EXEC ('USE tempdb;
IF OBJECT_ID(''tempdb.dbo.SQLXL_Numbers'') IS NULL
   EXEC (''CREATE FUNCTION dbo.SQLXL_Numbers() RETURNS TABLE AS RETURN (SELECT id = 0);'')');

EXEC(N'USE tempdb;EXEC(N''
ALTER FUNCTION dbo.SQLXL_Numbers
  (@zero_or_one   BIT = 1
  ,@top           BIGINT
  )
RETURNS TABLE AS RETURN
WITH
  P0(n) AS (SELECT NULL FROM (VALUES (1),(2),(3),(4)) n(n)),
  P1(n) AS (SELECT NULL FROM P0 A, P0 B),--        16 rows
  P2(n) AS (SELECT NULL FROM P1 A, P1 B),--       256 rows
  P3(n) AS (SELECT NULL FROM P2 A, P2 B),--     65536 rows
  P4(n) AS (SELECT ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) FROM P3 A, P3 B) -- 4294967296 rows
SELECT 0 n WHERE @zero_or_one = 0
UNION ALL
SELECT TOP(@top - CASE WHEN @zero_or_one = 0 THEN 1 ELSE 0 END) n FROM P4
'')
');

RAISERROR ('... tempdb.dbo.SQLXL_Numbers',0,0) WITH NOWAIT;

/******************************************************************************************************************************************\
-- function tempdb.dbo.SQLXL_3SD - return a number rounded to 3 significant digits
FUTURE: consider using below for straight power of 10 conversions
ALTER function sfround(@number float, @sigdig int) returns float as
BEGIN
return case when @number = 0 THEN 0 ELSE round(@number ,@sigdig -1-floor(log10(abs(@number )))) END
END

\******************************************************************************************************************************************/
DECLARE @collation SYSNAME = (SELECT collation_name FROM sys.databases WHERE name = N'tempdb')

EXEC ('USE tempdb;
IF OBJECT_ID(''tempdb.dbo.SQLXL_3SD'') IS NULL
   EXEC (''CREATE FUNCTION dbo.SQLXL_3SD() RETURNS BIT AS BEGIN RETURN 0 END;'')');

EXEC (N'USE tempdb;EXEC(N''
ALTER FUNCTION dbo.SQLXL_3SD
      (@value FLOAT
      ,@type  VARCHAR(3) = ''''''''
     )
/*
@Type Parameters
"ns" = Nanoseconds   10^-9 -- NOTE: Cannot use DATEADD with these time types
"mcs"= Microseconds  10^-6 -- NOTE: Cannot use DATEADD with these time types
"u"  = Microseconds  10^-6
"us" = Microseconds  10^-6
"U"  = Microseconds  10^-6
"m"  = Milliseconds  10^-3
"ms" = Milliseconds  10^-3
"M"  = Milliseconds  10^-3
"s"  = Seconds       10^ 0
"ss" = Seconds       10^ 0
"S"  = Seconds       10^ 0
"mi" = Minutes
"hh" = Hours
"dd" = Days
"wk" = Weeks
"yy" = Years

"P"  = SQL Server 8KB (8192 2^12 bytes) Pages
"PG" = SQL Server 8KB (8192 2^12 bytes) Pages
"B"  = Bytes       2^ 0
"KB" = Kilobytes   2^10
"MB" = Megabytes   2^20
"GB" = Gigabytes   2^30
"TB" = Terabytes   2^40
"PB" = Petabytes   2^50
"EB" = Exabytes    2^60
"ZB" = Zettabytes  2^70
"YB" = Yottabytes  2^80

""   = Number
"N"  = Number
"I"  = Integer
"%"  = Percent

TO DO;
- handle negative numbers
- handle tiny numbers

NOTE: cannot use NVARCHAR as value input since FLOAT values get converted to exponents
      when converted to VARCHAR in calculating POWER DIVISOR
*/

RETURNS NVARCHAR(7) -- COLLATE does not work here!
AS
BEGIN
   /*************************************************************************************************************************************\
    Special Cases - empty, (MAX) value, less than zero
   \*************************************************************************************************************************************/
   IF @value IS NULL RETURN ''''''''                          -- return empty string on NULL value
   IF @value = -1 AND @type = ''''I'''' RETURN ''''(MAX)''''  -- return (MAX) when -1 entered - for %CHAR data types
   IF @value < 0.0   RETURN ''''(<ZERO)''''                   -- no handling negative numbers, return (<ZERO)

   -- Multiply percents by 100
   IF @type = ''''%'''' SET @value = 100.0 * @value

   -- convert SQL Server Pages to 8KB - makes math easier below
   IF @type IN (''''P'''',''''PG'''') BEGIN SET @value = @value * 8.0 SET @type  = ''''KB'''' END

   /*********************************************************************************\
    *** There is a bug IN the ROUND function when called inside a scalar function ***
    *** introduced some time after SQL 2008 and before 2019                       ***
    *** without the next line "SET @value = @value + 0.0001" below:               ***
    *** SELECT tempdb.dbo.SQLXL_3SD(0.0150,N''''N'''') returns 0.01 NOT 0.02!     ***
    *** SELECT tempdb.dbo.SQLXL_3SD(0.0450,N''''N'''') returns 0.04 NOT 0.05!     ***
    *** SELECT tempdb.dbo.SQLXL_3SD(0.0750,N''''N'''') returns 0.07 NOT 0.08!     ***
    *** Until this gets figured out add an extra 0.0001 to values:                ***
   \*********************************************************************************/
   SET @value = @value + 0.0001

   -- if too small a number (for now) show zero plus the metric type (when not a number or an integer)
   IF ROUND(@value,2) < 0.01
      RETURN CASE WHEN @type = ''''I'''' THEN ''''0'''' ELSE ''''0.00'''' END
            +CASE WHEN @type NOT IN (''''I'''',''''N'''')
                  THEN @type
                  ELSE ''''''''
             END

   IF ROUND(@value,2) < 1.00
      RETURN LEFT(ROUND(@value,2),4)
            +CASE WHEN @type NOT IN (''''I'''',''''N'''')
                  THEN @type
                  ELSE ''''''''
             END

   -- Create a rounded to integer value for range comparisons below
   -- *** NOTE *** rounding the FLOAT(max value of a BIGINT) and converting to BIGINT causes error
   -- *** SELECT CAST(ROUND(CAST(9223372036854775807 AS FLOAT),0) AS BIGINT)
   -- *** fails with "Arithmetic overflow error converting expression to data type bigint"
   DECLARE @value_INT BIGINT  = ROUND(@value,0)

   /*************************************************************************************************************************************\
    Standardize number suffix for datetime & NUMBER types
   \*************************************************************************************************************************************/
   SET @type = CASE @type -- modify inbound datetime data types to the corresponding DATEADD dateparts
                    WHEN ''''N''''   THEN ''''''''    -- Number
                    WHEN ''''NS''''  THEN ''''ns''''
                    WHEN ''''MC''''  THEN ''''mcs''''
                    WHEN ''''MCS'''' THEN ''''mcs''''
                    WHEN ''''U''''   THEN ''''mcs''''
                    WHEN ''''US''''  THEN ''''mcs''''
                    WHEN ''''M''''   THEN ''''ms''''
                    WHEN ''''MS''''  THEN ''''ms''''
                    WHEN ''''S''''   THEN ''''ss''''
                    WHEN ''''SS''''  THEN ''''ss''''
                    WHEN ''''MI''''  THEN ''''mi''''
                    WHEN ''''MM''''  THEN ''''mi''''
                    WHEN ''''HH''''  THEN ''''hh''''
                    WHEN ''''DD''''  THEN ''''dd''''
                    WHEN ''''WK''''  THEN ''''wk''''
                    WHEN ''''YY''''  THEN ''''yy''''
                    ELSE @type
               END

   /*************************************************************************************************************************************\
    Special Cases - Dates & Time
   \*************************************************************************************************************************************/
   IF @type IN (''''ns'''' -- Nanoseconds   10^-9 -- NOTE: Cannot use DATEADD with these time types
               ,''''mcs''''-- Microseconds  10^-6 -- NOTE: Cannot use DATEADD with these time types
               ,''''ms'''' -- Milliseconds  10^-3
               ,''''ss'''' -- Seconds       10^ 0
               ,''''mi'''' -- Minutes
               ,''''hh'''' -- Hours
               ,''''dd'''' -- Days
               ,''''wk'''' -- Weeks
               ,''''yy'''' -- Years
               )
   BEGIN
      IF @type = ''''ns''''  AND @value_INT >= 1000 BEGIN SET @type = ''''mcs'''' SET @value = @value /1000.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''mcs'''' AND @value_INT >= 1000 BEGIN SET @type = ''''ms''''  SET @value = @value /1000.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''ms''''  AND @value_INT >= 1000 BEGIN SET @type = ''''ss''''  SET @value = @value /1000.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''ss''''  AND @value_INT >= 60   BEGIN SET @type = ''''mi''''  SET @value = @value /  60.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''mi''''  AND @value_INT >= 60   BEGIN SET @type = ''''hh''''  SET @value = @value /  60.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''hh''''  AND @value_INT >= 24   BEGIN SET @type = ''''dd''''  SET @value = @value /  24.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''dd''''  AND @value_INT >= 7    BEGIN SET @type = ''''wk''''  SET @value = @value /   7.0 SET @value_INT = ROUND(@value,0) END
      IF @type = ''''wk''''  AND @value_INT >= 52   BEGIN SET @type = ''''yy''''  SET @value = @value /  52.0 SET @value_INT = ROUND(@value,0) END

      IF @value_INT >= 1000 RETURN ''''FUTURE''''
   END

   IF @value_INT < 10   RETURN CASE WHEN @type = ''''I'''' THEN CAST(@value_int AS VARCHAR(3))
                                    ELSE LEFT(ROUND(CONVERT(MONEY,@value,2),2),4)+@type
                               END
   IF @value_INT < 100  RETURN CASE WHEN @type = ''''I'''' THEN CAST(@value_int AS VARCHAR(3))
                                    ELSE LEFT(ROUND(CONVERT(MONEY,@value,2),1),4)+@type
                               END
   IF @value_INT < 1000 RETURN CASE WHEN @type = ''''I'''' THEN CAST(@value_int AS VARCHAR(3))
                                    ELSE LEFT(ROUND(@value,0),4)+@type
                               END

   /*************************************************************************************************************************************\
    Declares - use COLLATE to differentiate between LOWER and UPPER @type
   \*************************************************************************************************************************************/
   DECLARE @power  VARCHAR(3) = CASE WHEN @type IN (''''B'''',''''I'''','''''''',''''%'''')
                                     THEN ''''''''
                                     ELSE UPPER(LEFT(@type,1)) -- which power of 10 or 2 prefix to show
                                END COLLATE SQL_Latin1_General_CP1_CS_AS

          ,@factor FLOAT      = CASE WHEN @type IN (''''I'''','''''''',''''%'''')
                                     THEN 1000.0 -- next major power of 10 prefix
                                     ELSE 1024.0 -- 2^10 Kilobytes
                                END
          ,@suffix VARCHAR(3) = CASE WHEN @type IN (''''%'''')          THEN ''''%''''  -- percent
                                     WHEN @type IN (''''I'''','''''''') THEN ''''''''   -- numbers and integers
                                     ELSE ''''B''''                                     -- bytes
                                END COLLATE SQL_Latin1_General_CP1_CS_AS

  ---------------------------------------------------------------------------------------------------------------------------------------
   -- Calcs - if less than 3 digits to LEFT of decimal, multiply to show next lower power
  ---------------------------------------------------------------------------------------------------------------------------------------
   IF ROUND(@value,0) < 1000 AND @type <> ''''%''''
   BEGIN -- IF ROUND(@value,0) < 1000 AND @type <> ''''%''''
      WHILE ROUND(@value * @factor,0) < 1000
      BEGIN -- WHILE ROUND(@value * @factor,0) < 1000

         SET @value = @value * @factor
         SET @power = CASE @power COLLATE SQL_Latin1_General_CP1_CS_AS -- for each loop adjust the value type to the next lower size
                           WHEN ''''n'''' THEN ''''p'''' -- nano    > pico
                           WHEN ''''u'''' THEN ''''n'''' -- micro   > nano
                           WHEN ''''m'''' THEN ''''u'''' -- milli   > micro
                           WHEN ''''''''  THEN ''''m'''' -- deka    > milli
                           WHEN ''''K'''' THEN ''''''''  -- kilo    > deka
                           WHEN ''''M'''' THEN ''''K'''' -- mega    > kilo

                           WHEN ''''G'''' THEN ''''M'''' -- giga    > mega
                           WHEN ''''B'''' THEN ''''M'''' -- billion > mega
                           WHEN ''''T'''' THEN CASE WHEN RIGHT(@type,1) = ''''B''''
                                                    THEN ''''G'''' -- tera  > giga
                                                    ELSE ''''B'''' -- tera  > billion
                                               END
                           WHEN ''''P'''' THEN ''''T'''' -- peta    > tera
                           WHEN ''''E'''' THEN ''''P'''' -- exa     > peta
                           WHEN ''''Z'''' THEN ''''E'''' -- zetta   > exa
                           WHEN ''''Y'''' THEN ''''Z'''' -- yotta   > zetta
                           ELSE ''''#''''
                      END
      END -- WHILE ROUND(@value,0) < 1000
   END    -- IF ROUND(@value,0) < 1000

  ---------------------------------------------------------------------------------------------------------------------------------------
  -- Calcs - if more than 3 digits to LEFT of decimal, divide to show next larger power
  ---------------------------------------------------------------------------------------------------------------------------------------
   ELSE IF ROUND(@value,0) > 999
   BEGIN -- IF ROUND(@value,0) > 999
      WHILE ROUND(@value,0) > 999
      BEGIN -- WHILE ROUND(@value,0) > 999
         SET @value = @value / @factor
         SET @power = CASE @power COLLATE SQL_Latin1_General_CP1_CS_AS  -- for each loop adjust the value type to the next higher size
                           WHEN ''''p'''' THEN ''''n'''' -- pico    > nano
                           WHEN ''''n'''' THEN ''''u'''' -- nano    > micro
                           WHEN ''''u'''' THEN ''''m'''' -- micro   > milli
                           WHEN ''''m'''' THEN ''''''''  -- milli   > deka
                           WHEN ''''''''  THEN ''''K'''' -- deka    > kilo
                           WHEN ''''K'''' THEN ''''M'''' -- kilo    > mega
                           WHEN ''''M'''' THEN CASE WHEN RIGHT(@type,1) = ''''B''''
                                                    THEN ''''G'''' -- mega  > giga
                                                    ELSE ''''B'''' -- mega  > billion
                                               END
                           WHEN ''''G'''' THEN ''''T'''' -- giga    > tera
                           WHEN ''''B'''' THEN ''''T'''' -- billion > tera

                           WHEN ''''T'''' THEN ''''P'''' -- tera    > peta
                           WHEN ''''P'''' THEN ''''E'''' -- peta    > exa
                           WHEN ''''E'''' THEN ''''Z'''' -- exa     > zetta
                           WHEN ''''Z'''' THEN ''''Y'''' -- zetta   > yotta
                           ELSE ''''#''''
                      END
      END -- WHILE ROUND(@value,0) > 999
   END    -- IF ROUND(@value,0) > 999

  ---------------------------------------------------------------------------------------------------------------------------------------
  -- RETURN formatted value
  ---------------------------------------------------------------------------------------------------------------------------------------
   RETURN LTRIM(CASE WHEN ROUND(@value,0) >= 100 THEN LEFT(ROUND(CAST(@value AS DECIMAL(5,2)),0),3)
                     WHEN ROUND(@value,1) >=  10 THEN LEFT(ROUND(CAST(@value AS DECIMAL(5,2)),1),4)
                     ELSE                             LEFT(ROUND(CAST(@value AS DECIMAL(5,2)),2),4)
                END
               +@power
               +@suffix) COLLATE DATABASE_DEFAULT

END'')
');

RAISERROR ('... tempdb.dbo.SQLXL_3SD',0,0) WITH NOWAIT;

/******************************************************************************************************************************************/
-- function tempdb.dbo.SQLXL_DTTM_HMSM - return a DATETIME type formatted elapsed value
-- If >= 24 hours returns time in days
-- If >= 60 minutes returns time in Hours
-- If <  60 minutes returns time in MI:SS.mmm
/******************************************************************************************************************************************/
EXEC (N'USE tempdb;
IF OBJECT_ID(N''dbo.SQLXL_DTTM_HMSM'') IS NULL
   EXEC(N''CREATE FUNCTION dbo.SQLXL_DTTM_HMSM() RETURNS BIT AS BEGIN RETURN 0 END'')')

EXEC (N'USE tempdb;
EXEC(N''
ALTER FUNCTION dbo.SQLXL_DTTM_HMSM
      (@dt DATETIME
      )
/* Returns absolute date & time value as "#.## Day" -or- "#.## Hour" -or- "MM:SS:mmm" */
RETURNS NVARCHAR(20)
AS
BEGIN
   IF @dt IS NULL RETURN N''''''''

   DECLARE @df FLOAT = CONVERT(FLOAT,@dt,1)

   RETURN RTRIM(

   CASE WHEN @df  =  -1               THEN N''''NO LIMIT''''
        WHEN @df  =   0               THEN N''''00:00:000''''
        WHEN @df >= 365.0             THEN tempdb.dbo.SQLXL_3SD(@df / 365.0      ,N''''N'''') + N''''yy      '''' -- extra space added to make columns line up
        WHEN @df >=   1.0             THEN tempdb.dbo.SQLXL_3SD(@df              ,N''''N'''') + N''''dd      '''' -- extra space added to make columns line up
        WHEN @df >=   1.0/(24.0)      THEN tempdb.dbo.SQLXL_3SD(@df * 24.0       ,N''''N'''') + N''''hh      '''' -- extra space added to make columns line up
        ELSE RIGHT(CONVERT(NVARCHAR(12),@dt,114),9)
   END COLLATE DATABASE_DEFAULT)

END'')
');

RAISERROR ('... tempdb.dbo.SQLXL_DTTM_HMSM',0,0) WITH NOWAIT;

/******************************************************************************************************************************************/
-- function tempdb.dbo.SQLXL_INT_DTTM - Converts BIGINT time count to elapsed DATETIME (e.g. MILLISECONDS -> HOURS)
/******************************************************************************************************************************************/
EXEC (N'USE tempdb;
IF OBJECT_ID(N''dbo.SQLXL_INT_DTTM'') IS NULL
   EXEC(N''CREATE FUNCTION dbo.SQLXL_INT_DTTM() RETURNS BIT AS BEGIN RETURN 0 END'')')

EXEC (N'USE tempdb;
EXEC(N''
ALTER FUNCTION dbo.SQLXL_INT_DTTM
      (@cnt  BIGINT   = NULL
      ,@prt  NCHAR(3) = N''''ms'''' -- datepart, defaults to MILLISECONDS
      )
/* Converts elapsed count to DateTime */
RETURNS DATETIME
AS
BEGIN
   IF @cnt IS NULL RETURN 0

   WHILE @cnt > 2147483647 -- max size INT for DATEADD parameter
   BEGIN
      IF @prt = N''''wk''''  BEGIN SET @prt = N''''yy''''  SET @cnt = @cnt /  52 END
      IF @prt = N''''dd''''  BEGIN SET @prt = N''''wk''''  SET @cnt = @cnt /   7 END
      IF @prt = N''''hh''''  BEGIN SET @prt = N''''dd''''  SET @cnt = @cnt /  24 END
      IF @prt = N''''mi''''  BEGIN SET @prt = N''''hh''''  SET @cnt = @cnt /  60 END
      IF @prt = N''''ss''''  BEGIN SET @prt = N''''mi''''  SET @cnt = @cnt /  60 END
      IF @prt = N''''ms''''  BEGIN SET @prt = N''''ss''''  SET @cnt = @cnt /1000 END
      IF @prt = N''''mcs'''' BEGIN SET @prt = N''''ms''''  SET @cnt = @cnt /1000 END
      IF @prt = N''''ns''''  BEGIN SET @prt = N''''mcs'''' SET @cnt = @cnt /1000 END
   END

   RETURN
      CASE @prt
           WHEN N''''yy''''  THEN DATEADD(yy ,@cnt,0)
           WHEN N''''wk''''  THEN DATEADD(wk ,@cnt,0)
           WHEN N''''dd''''  THEN DATEADD(dd ,@cnt,0)
           WHEN N''''hh''''  THEN DATEADD(hh ,@cnt,0)
           WHEN N''''mi''''  THEN DATEADD(mi ,@cnt,0)
           WHEN N''''ss''''  THEN DATEADD(ss ,@cnt,0)
           WHEN N''''ms''''  THEN DATEADD(ms ,@cnt,0)
           WHEN N''''mcs'''' THEN DATEADD(mcs,@cnt,0)
           WHEN N''''ns''''  THEN DATEADD(ns ,@cnt,0)
           END
END'')
');

RAISERROR ('... tempdb.dbo.SQLXL_INT_DTTM',0,0) WITH NOWAIT;